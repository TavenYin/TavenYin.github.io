<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/book_32px_1233745_easyicon.net.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/book_16px_1233745_easyicon.net.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="RabbitMQ,集群,">










<meta name="description" content="本文记录RabbitMQ集群搭建过程中遇到的问题  环境 vmware12 虚拟机，CentOS7本文以两台CentOS 为例，IP 192.168.32.128，192.168.32.129  磁盘节点和内存节点集群中，每一个RabbitMQ实例都是一个节点，而节点分为磁盘节点和内存节点  内存节点：将Rabbit中的元数据（Queue, Exchange, binding, vhost等">
<meta name="keywords" content="RabbitMQ,集群">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ 集群搭建">
<meta property="og:url" content="https://yintianwen.top/post/4c62e394.html">
<meta property="og:site_name" content="殷天文 - Blog">
<meta property="og:description" content="本文记录RabbitMQ集群搭建过程中遇到的问题  环境 vmware12 虚拟机，CentOS7本文以两台CentOS 为例，IP 192.168.32.128，192.168.32.129  磁盘节点和内存节点集群中，每一个RabbitMQ实例都是一个节点，而节点分为磁盘节点和内存节点  内存节点：将Rabbit中的元数据（Queue, Exchange, binding, vhost等">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/6cb26131-f7e2-4737-9ae8-b1228f73c997">
<meta property="og:image" content="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/7a5572d6-0c57-4474-9f35-c3e41b11b3d1">
<meta property="og:image" content="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/fa43bb88-ee7a-4e70-9bde-c654ccf0dc37">
<meta property="og:image" content="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/027bef03-b0eb-42be-bde4-90413359042a">
<meta property="og:updated_time" content="2021-01-14T13:50:11.089Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RabbitMQ 集群搭建">
<meta name="twitter:description" content="本文记录RabbitMQ集群搭建过程中遇到的问题  环境 vmware12 虚拟机，CentOS7本文以两台CentOS 为例，IP 192.168.32.128，192.168.32.129  磁盘节点和内存节点集群中，每一个RabbitMQ实例都是一个节点，而节点分为磁盘节点和内存节点  内存节点：将Rabbit中的元数据（Queue, Exchange, binding, vhost等">
<meta name="twitter:image" content="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/6cb26131-f7e2-4737-9ae8-b1228f73c997">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yintianwen.top/post/4c62e394.html">





  <title>RabbitMQ 集群搭建 | 殷天文 - Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5a4b68d1eece4df07f27f968d19cb832";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">殷天文 - Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Hello World</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            时间线
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于我
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yintianwen.top/post/4c62e394.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="殷天文">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/7cd06fea-be0c-4c8b-89b8-130e0d60363f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="殷天文 - Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">RabbitMQ 集群搭建</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-22T13:19:00+08:00">
                2019-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <meta name="referrer" content="no-referrer">

<blockquote>
<p>本文记录RabbitMQ集群搭建过程中遇到的问题</p>
</blockquote>
<h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><blockquote>
<p>vmware12 虚拟机，CentOS7<br>本文以两台CentOS 为例，IP 192.168.32.128，192.168.32.129</p>
</blockquote>
<h4 id="磁盘节点和内存节点"><a href="#磁盘节点和内存节点" class="headerlink" title="磁盘节点和内存节点"></a>磁盘节点和内存节点</h4><p>集群中，每一个RabbitMQ实例都是一个节点，而节点分为磁盘节点和内存节点</p>
<ul>
<li><p>内存节点：将Rabbit中的元数据（Queue, Exchange, binding, vhost等）存储在内存中，持久化的 <strong>Message</strong> 依旧保存在磁盘中，内存节点的性能只能体现在资源管理上，消息的发送和接收和磁盘节点没有区别</p>
</li>
<li><p>磁盘节点：元数据存储在磁盘中，一个Rabbit集群要求至少有一个磁盘节点，因为内存节点中不存储元数据，所以每次内存节点启动，都会从其他节点中同步元数据</p>
</li>
</ul>
<p>另外如果唯一磁盘的磁盘节点崩溃了，不能进行如下操作：</p>
<ul>
<li>不能创建队列</li>
<li>不能创建交换器</li>
<li>不能创建绑定</li>
<li>不能添加用户</li>
<li>不能更改权限</li>
<li>不能添加和删除集群几点</li>
</ul>
<h4 id="RabbitMQ集群的几种类型"><a href="#RabbitMQ集群的几种类型" class="headerlink" title="RabbitMQ集群的几种类型"></a>RabbitMQ集群的几种类型</h4><ul>
<li><p>单一模式：仅有一个rabbit实例</p>
</li>
<li><p>普通模式：默认集群模式，每个节点各自维护自己的数据，两个节点仅存有相同的元数据。例如RabbitA 和 RabbitB，A中存在 QueueA，消费者可以从RabbitB实例中，读取QueueA的消息，这时RabbitB会从A中读取消息，返回给消费者。但是如果RabbitA 宕机，这时就无法获取QueueA的数据了</p>
</li>
<li><p>镜像模式：Rabbit 会将数据同步到其他节点中，这固然提高了可用性，但是随之而来的问题是，系统的性能会降低。节点之间消息的传递会占用带宽，而每个节点存储的数据量会变大</p>
</li>
</ul>
<h4 id="普通模式"><a href="#普通模式" class="headerlink" title="普通模式"></a>普通模式</h4><p>我们先来搭建普通模式的集群，在RabbitMQ中，每个节点的名必须是唯一的，默认以 rabbit@hostname为节点name</p>
<p>而每台虚拟机中默认的host是localhost，这就导致了每个节点的name都是 <code>rabbit@localhost</code></p>
<h5 id="1-修改hosts"><a href="#1-修改hosts" class="headerlink" title="1. 修改hosts"></a>1. 修改hosts</h5><p>修改两台主机的hosts文件，以下是129的配置，我们把128定义为F，129定义为G</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/hosts</span><br><span class="line">127.0.0.1 G</span><br><span class="line">::1       G</span><br><span class="line"></span><br><span class="line">192.168.32.129 G</span><br><span class="line">192.168.32.128 F</span><br></pre></td></tr></table></figure>
<p>保证F和G可以ping通</p>
<p><img src="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/6cb26131-f7e2-4737-9ae8-b1228f73c997" alt="image.png"></p>
<h5 id="2-安装RabbitMQ"><a href="#2-安装RabbitMQ" class="headerlink" title="2. 安装RabbitMQ"></a>2. 安装RabbitMQ</h5><p>可以参考 <a href="https://www.linuxprobe.com/install-rabbitmq-on-centos-7.html" target="_blank" rel="noopener">https://www.linuxprobe.com/install-rabbitmq-on-centos-7.html</a></p>
<p>当时安装完一直发现无法访问 Rabbit的web控制台，除了开启插件，和添加一个用户之外，还需要放开防火墙的端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=4369/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=25672/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=5671-5672/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=15672/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=61613-61614/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=1883/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=8883/tcp --permanent</span><br><span class="line">firewall-cmd --reload # 重载配置</span><br></pre></td></tr></table></figure></p>
<h5 id="3-同步Erlang-cookie"><a href="#3-同步Erlang-cookie" class="headerlink" title="3. 同步Erlang cookie"></a>3. 同步Erlang cookie</h5><p>Erlang VM将尝试在RabbitMQ服务器启动时创建一个随机生成的值（Erlang Cookie）。集群环境中，所有节点的Erlang Cookie必须一致。</p>
<p>.erlang.cookie 通常在 $HOME下或者/var/lib/rabbitmq下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 找到其中一台主机的 .erlang.cookie</span><br><span class="line"><span class="meta">#</span> 修改权限</span><br><span class="line">chmod 777 /var/lib/rabbitmq/.erlang.cookie</span><br><span class="line"><span class="meta">#</span> 拷贝到另一台主机</span><br><span class="line">scp /var/lib/rabbitmq/.erlang.cookie G:/var/lib/rabbitmq/</span><br><span class="line"><span class="meta">#</span> 再把权限修改回来</span><br><span class="line">chmod 400 /var/lib/rabbitmq/.erlang.cookie</span><br></pre></td></tr></table></figure></p>
<h5 id="4-检查节点名"><a href="#4-检查节点名" class="headerlink" title="4. 检查节点名"></a>4. 检查节点名</h5><p><img src="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/7a5572d6-0c57-4474-9f35-c3e41b11b3d1" alt="image.png"></p>
<p>如果两个节点都是 rabbit@localhost，这是无法建立集群的</p>
<p>我当时就是遇到了这个问题，需要修改节点name，参考 <a href="https://ubuntuqa.com/article/6619.html" target="_blank" rel="noopener">https://ubuntuqa.com/article/6619.html</a></p>
<p>我采取的方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rabbitmq/rabbitmq-env.conf</span><br><span class="line"></span><br><span class="line"># 添加如下配置</span><br><span class="line">NODENAME=rabbit@G</span><br><span class="line"></span><br><span class="line"># 保存后，重启rabbitmq 生效</span><br><span class="line">service rabbitmq-server restart</span><br></pre></td></tr></table></figure></p>
<h5 id="5-组成集群"><a href="#5-组成集群" class="headerlink" title="5. 组成集群"></a>5. 组成集群</h5><p>上述步骤都成功后，我们可以组成集群了</p>
<p>这个时候我们先启动rabbitmq@F，然后rabbit@G执行以下操作，加入F，组成集群<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app # 停止rabbitmq服务</span><br><span class="line">rabbitmqctl reset # 清空节点状态</span><br><span class="line">rabbitmqctl join_cluster rabbit@F # 加入F，组成集群</span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></table></figure></p>
<p>集群中，任意节点停机后，执行 <code>rabbitmqctl start_app</code> 即可再次加入集群</p>
<p>查看集群状态 <code>rabbitmqctl cluster_status</code><br><img src="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/fa43bb88-ee7a-4e70-9bde-c654ccf0dc37" alt="image.png"></p>
<h4 id="镜像模式"><a href="#镜像模式" class="headerlink" title="镜像模式"></a>镜像模式</h4><p>任意rabbit节点输入命令，将所有队列，同步到所有节点中<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_policy ha-all "^" '&#123;"ha-mode":"all"&#125;'</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_policy [-p Vhost] Name Pattern Definition [Priority]</span><br><span class="line"></span><br><span class="line">-p Vhost： 可选参数，针对指定vhost下的queue进行设置</span><br><span class="line">Name: policy的名称</span><br><span class="line">Pattern: queue的匹配模式(正则表达式)</span><br><span class="line">Definition：镜像定义，包括三个部分ha-mode, ha-params, ha-sync-mode</span><br><span class="line">        ha-mode:指明镜像队列的模式，有效值为 all/exactly/nodes</span><br><span class="line">        all：表示在集群中所有的节点上进行镜像</span><br><span class="line">        exactly：表示在指定个数的节点上进行镜像，节点的个数由ha-params指定</span><br><span class="line">        nodes：表示在指定的节点上进行镜像，节点名称通过ha-params指定</span><br><span class="line">        ha-params：ha-mode模式需要用到的参数</span><br><span class="line">        ha-sync-mode：进行队列中消息的同步方式，有效值为automatic和manual</span><br><span class="line">priority：可选参数，policy的优先级</span><br></pre></td></tr></table></figure>
<p>关于镜像模式策略的更多请参考官方文档：<a href="https://www.rabbitmq.com/ha.html" target="_blank" rel="noopener">https://www.rabbitmq.com/ha.html</a></p>
<h4 id="集群的负载均衡"><a href="#集群的负载均衡" class="headerlink" title="集群的负载均衡"></a>集群的负载均衡</h4><p>为什么有了集群还需要负载均衡？</p>
<p>这里我纠结了好几天，原因是，在我的理解里 集群 == 负载均衡，这样的理解是有问题的。<br>正解：分布式集群保证的是高可用，而并不是负载均衡。</p>
<p>rabbitmq文档中，也建议我们使用TCP负载均衡器，这样也不需要在我们应用程序里管理集群的地址</p>
<blockquote>
<p><strong>Connecting to Clusters from Clients</strong><br>A client can connect as normal to any node within a cluster. If that node should fail, and the rest of the cluster survives, then the client should notice the closed connection, and should be able to reconnect to some surviving member of the cluster. Generally, it’s not advisable to bake in node hostnames or IP addresses into client applications: this introduces inflexibility and will require client applications to be edited, recompiled and redeployed should the configuration of the cluster change or the number of nodes in the cluster change. Instead, we recommend a more abstracted approach: this could be a dynamic DNS service which has a very short TTL configuration, or a plain TCP load balancer, or some sort of mobile IP achieved with pacemaker or similar technologies. In general, this aspect of managing the connection to nodes within a cluster is beyond the scope of RabbitMQ itself, and we recommend the use of other technologies designed specifically to solve these problems.</p>
</blockquote>
<p>网上比较多的方案是使用 HAProxy 作为负载均衡器，这里大家可以参考一下这一篇 <a href="https://www.jianshu.com/p/c9f6d55288c0" target="_blank" rel="noopener">HAProxy从零开始到掌握</a> 具体安装配置的细节本文就不说了</p>
<p>这里我又添加了一台 130 的虚拟机来跑 HAProxy</p>
<p>贴一下我的 haproxy.cfg，仅供参考</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">daemon</span><br><span class="line">pidfile /home/ha/haproxy/conf/haproxy.pid</span><br><span class="line">log 127.0.0.1 local2</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">mode tcp</span><br><span class="line">maxconn 10000</span><br><span class="line">timeout connect 5s</span><br><span class="line">timeout client 100s</span><br><span class="line">timeout server 100s</span><br><span class="line"></span><br><span class="line">frontend http-in</span><br><span class="line">    bind *:5670</span><br><span class="line">    maxconn 30000</span><br><span class="line">    default_backend default_servers</span><br><span class="line"></span><br><span class="line">backend default_servers</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server F 192.168.32.128:5672 check inter 2000 rise 2 fall 3 weight 1</span><br><span class="line">    server G 192.168.32.129:5672 check inter 2000 rise 2 fall 3 weight 1</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    bind *:1936                 </span><br><span class="line">    mode http</span><br><span class="line">    stats refresh 30s             #每30秒更新监控数据</span><br><span class="line">    stats uri /stats              #访问监控页面的uri</span><br><span class="line">    stats realm HAProxy\ Stats    #监控页面的认证提示</span><br><span class="line">    stats auth admin:admin</span><br></pre></td></tr></table></figure>
<p>做完负载均衡之后，可以跑一下程序，查看一下负载均衡的效果，这里我的10个 Connection 按照权重 1:1 分配在了两台 Rabbit 上</p>
<p><img src="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/027bef03-b0eb-42be-bde4-90413359042a" alt="image.png"></p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><blockquote>
<p><a href="https://www.cnblogs.com/knowledgesea/p/6535766.html" target="_blank" rel="noopener">https://www.cnblogs.com/knowledgesea/p/6535766.html</a><br><a href="https://www.rabbitmq.com/clustering.html" target="_blank" rel="noopener">https://www.rabbitmq.com/clustering.html</a></p>
</blockquote>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/RabbitMQ/" rel="tag"># RabbitMQ</a>
          
            <a href="/tags/集群/" rel="tag"># 集群</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/post/ea1358e6.html" rel="next" title="RabbitMQ 理解 Exchange">
                <i class="fa fa-chevron-left"></i> RabbitMQ 理解 Exchange
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/post/bca00fad.html" rel="prev" title="使用 Spring Cloud 分布式配置中心">
                使用 Spring Cloud 分布式配置中心 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://yintianwenblog.oss-cn-beijing.aliyuncs.com/7cd06fea-be0c-4c8b-89b8-130e0d60363f" alt="殷天文">
            
              <p class="site-author-name" itemprop="name">殷天文</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">47</span>
                  <span class="site-state-item-name">博客</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/cd682de00804" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-book"></i>简书</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/TavenYin" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://gitee.com/yintianwen7" target="_blank" title="Gitee">
                      
                        <i class="fa fa-fw fa-git"></i>Gitee</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#环境"><span class="nav-number">1.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#磁盘节点和内存节点"><span class="nav-number">2.</span> <span class="nav-text">磁盘节点和内存节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RabbitMQ集群的几种类型"><span class="nav-number">3.</span> <span class="nav-text">RabbitMQ集群的几种类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#普通模式"><span class="nav-number">4.</span> <span class="nav-text">普通模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-修改hosts"><span class="nav-number">4.1.</span> <span class="nav-text">1. 修改hosts</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-安装RabbitMQ"><span class="nav-number">4.2.</span> <span class="nav-text">2. 安装RabbitMQ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-同步Erlang-cookie"><span class="nav-number">4.3.</span> <span class="nav-text">3. 同步Erlang cookie</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-检查节点名"><span class="nav-number">4.4.</span> <span class="nav-text">4. 检查节点名</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-组成集群"><span class="nav-number">4.5.</span> <span class="nav-text">5. 组成集群</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#镜像模式"><span class="nav-number">5.</span> <span class="nav-text">镜像模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群的负载均衡"><span class="nav-number">6.</span> <span class="nav-text">集群的负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">殷天文</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
