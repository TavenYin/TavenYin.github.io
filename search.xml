<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[æ·±å…¥ç†è§£ Sentinel ä¸­çš„é™æµç®—æ³•]]></title>
    <url>%2Fpost%2F690c857.html</url>
    <content type="text"><![CDATA[æœ€è¿‘åœ¨å­¦ä¹  Sentinelï¼Œæ·±å…¥å­¦ä¹ äº†æºç ä¹‹ååˆ†äº«ä¸€ä¸‹å¿ƒå¾— Sentinel ç‰ˆæœ¬1.8.0 å›ºå®šçª—å£ç®—æ³•å…ˆä»‹ç»ä¸€ä¸‹æœ€ç®€å•çš„é™æµç®—æ³• æ¯ä¸ªçª—å£éƒ½æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼ˆcounterï¼‰ç”¨äºç»Ÿè®¡æµé‡ï¼Œå¦‚æœ counter + æœ¬æ¬¡ç”³è¯·çš„è¯·æ±‚æ•° &gt; é¢„è®¾çš„ QPSï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚ å›ºå®šçª—å£å¾ˆç®€å•ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¾ˆå¤§çš„é—®é¢˜ å‡è®¾æˆ‘ä»¬è§„å®š QPS ä¸èƒ½è¶…è¿‡ 100ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤º r1 å’Œ r2 ä¸¤ä¸ªæ—¶é—´ç‚¹åˆ†åˆ«æ¥äº† 60 ä¸ªè¯·æ±‚ï¼Œ QPS å·²ç»å¤§äº 100 äº†ã€‚æ­¤æ—¶åº”è¯¥è§¦å‘é™æµäº†ï¼Œä½†æ˜¯å›ºå®šçª—å£ç®—æ³•å‚»å‚»çš„åªå…³æ³¨è‡ªå·±çª—å£çš„æµé‡ï¼Œæ„ŸçŸ¥ä¸åˆ° QPS å·²ç»è¶…äº† æ»‘åŠ¨çª—å£ç®—æ³• è¯¥ç®—æ³•å°†å•ä½æ—¶é—´åˆ‡æˆäº†å¤šä¸ªçª—å£ï¼Œæ¯æ¬¡è®¡ç®— QPS æ—¶ï¼Œè®¡ç®— å½“å‰çª—å£ + è¿‡å»å‡ ä¸ªçª—å£ çš„æµé‡æ€»å’Œï¼Œè¿™æ ·å°±é¿å…äº†å›ºå®šçª—å£çš„é—®é¢˜ï¼ˆå…·ä½“ä½¿ç”¨å‡ ä¸ªçª—å£ï¼Œå–å†³äºçª—å£å¤§å°å’Œå•ä½æ—¶é—´å¤§å°ã€‚ä¾‹å¦‚ä¸Šå›¾ï¼Œæ¯ä¸ªçª—å£å¤§å°ä¸º 500 msï¼Œä»¥ 1 s ä¸ºå•ä½æ—¶é—´åšé™æµï¼Œæ¯æ¬¡ä½¿ç”¨ current + last å³å¯ï¼‰ ç®—æ³•å®ç°ç»†èŠ‚æ€è€ƒç†è§£ç®—æ³•æ€è·¯ä¹‹åï¼Œæ¥ä¸‹æ¥è¦æ€è€ƒå¦‚ä½•å®ç°è¿™ä¸ªç®—æ³•äº† é¦–å…ˆæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªä¸Šå›¾ä¸­çš„æ—¶é—´è½´ï¼Œæ¥è®°å½•æ—¶é—´çª—å£ï¼Œå¯ä»¥é€šè¿‡æ•°ç»„æ¥å®ç°è¿™ä¸ªæ—¶é—´è½´ã€‚ æ—¶é—´è½´æœ‰äº†ï¼Œæˆ‘ä»¬å†æ¥è€ƒè™‘ä¸€ä¸‹æ—¶é—´çª—å£ã€‚ æ¯ä¸ªæ—¶é—´çª—å£è‚¯å®šè¦æœ‰ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨ä»¥åŠå½“å‰çª—å£å¯¹åº”çš„æ—¶é—´ 12345678910// æ—¶é—´è½´List&lt;Window&gt; timeline = new ArrayList&lt;&gt;();// æ¯ä¸ªçª—å£çš„å¤§å°int windowTime;// æ—¶é—´çª—å£class Window &#123; Timestamp startTime; AtomicInteger counter;&#125; ä½†æ˜¯å¦‚æœä»”ç»†ä¸€æƒ³ï¼Œè¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜çš„ ç”±äºæ—¶é—´æ˜¯ä¼šä¸€ç›´å¢é•¿çš„ï¼Œé‚£æˆ‘ä»¬çš„æ•°ç»„æ€ä¹ˆåŠï¼Ÿä¹Ÿè¦è·Ÿç€æ—¶é—´æ— é™çš„å¢å¤§å—ï¼Ÿ æ—§çš„æ—¶é—´çª—å£ï¼ˆä¾‹å¦‚å‡ ç§’ä¹‹å‰çš„ï¼‰åœ¨ä¹‹åçš„è®¡ç®—ä¸ä¼šå†ç”¨åˆ°äº†ï¼Œå¦‚ä½•æ¸…ç†è¿™äº›æ— ç”¨çš„çª—å£ï¼Ÿ Sentinel ä¸­æ»‘åŠ¨çª—å£ç®—æ³•å¦‚ä½•å®ç°çš„å¸¦ç€ä¸Šè¿°çš„é—®é¢˜ä¸æ€è€ƒæ¥çœ‹ä¸‹ Sentinel ä¸­æ˜¯å¦‚ä½•å®ç°çš„ LeapArraySentinel ä¸­æ»‘åŠ¨çª—å£ç®—æ³•çš„æ ¸å¿ƒç±»ï¼Œé¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ä»–çš„æ ¸å¿ƒæˆå‘˜å˜é‡ 123456789101112131415161718192021222324public abstract class LeapArray&lt;T&gt; &#123; // è¦ç»Ÿè®¡çš„å•ä½æ—¶é—´å¤§å°ï¼Œä¾‹å¦‚è®¡ç®—QPSæ—¶ï¼Œä¸º1000 protected int intervalInMs; // æ ·æœ¬æ•°é‡ protected int sampleCount; // çª—å£å¤§å° è¯¥å€¼ = intervalInMs / sampleCount protected int windowLengthInMs; // å­˜å‚¨æ—¶é—´çª—å£çš„æ•°ç»„ protected final AtomicReferenceArray&lt;WindowWrap&lt;T&gt;&gt; array; public LeapArray(int sampleCount, int intervalInMs) &#123; AssertUtil.isTrue(sampleCount &gt; 0, "bucket count is invalid: " + sampleCount); AssertUtil.isTrue(intervalInMs &gt; 0, "total time interval of the sliding window should be positive"); AssertUtil.isTrue(intervalInMs % sampleCount == 0, "time span needs to be evenly divided"); this.windowLengthInMs = intervalInMs / sampleCount; this.intervalInMs = intervalInMs; this.sampleCount = sampleCount; this.array = new AtomicReferenceArray&lt;&gt;(sampleCount); &#125; &#125; å•æœºé™æµåœ¨ç»Ÿè®¡ QPS æ—¶ï¼Œé»˜è®¤ sampleCount = 2ï¼ŒintervalInMs = 1000ï¼ŒwindowLengthInMs = 500 LeapArray#calculateTimeIdxå¤§ä½“æ€è·¯ç›¸åŒï¼ŒåŒæ ·æ˜¯åˆ©ç”¨ä¸€ä¸ªæ•°ç»„å®ç°æ—¶é—´è½´ï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ªæ—¶é—´çª—å£ Sentinel ä¸­ æ•°ç»„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œé€šè¿‡æ–¹æ³• LeapArray#calculateTimeIdx æ¥ ç¡®å®šæ—¶é—´æˆ³åœ¨æ•°ç»„ ä¸­çš„ä½ç½® ï¼ˆæ‰¾åˆ°æ—¶é—´æˆ³å¯¹åº”çš„çª—å£ä½ç½®ï¼‰ æ€ä¹ˆç†è§£è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿ æˆ‘ä»¬æŠŠæ•°æ®å¸¦å…¥è¿›å»ï¼Œå‡è®¾ windowLengthInMs = 500 ms ï¼ˆæ¯ä¸ªæ—¶é—´çª—å£å¤§å°æ˜¯ 500 msï¼‰ å¦‚æœ timestamp ä» 0 å¼€å§‹çš„è¯ï¼Œæ¯ä¸ªæ—¶é—´çª—å£ä¸º [0,500) [500,1000) [1000,1500) â€¦ è¿™æ—¶å€™å…ˆä¸è€ƒè™‘ timeId % array.length() ï¼Œä¹Ÿä¸è€ƒè™‘æ•°ç»„é•¿åº¦ã€‚å‡è®¾å½“å‰ timeMillis = 601ï¼Œå°†æ•°å€¼ä»£å…¥åˆ° timeMillis / windowLengthInMs å…¶å®å°±å¯ä»¥ç¡®å®šå‡ºå½“å‰çš„ timestamp å¯¹åº”çš„æ—¶é—´çª—å£åœ¨æ•°ç»„ä¸­çš„ä½ç½®äº† ç”±äºæ•°ç»„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥å†åŠ ä¸Šæ±‚ä½™æ•°å–æ¨¡æ¥ç¡®å®šæ—¶é—´çª—åœ¨æ•°ç»„ä¸­çš„ä½ç½® LeapArray#currentWindowå…ˆæ¥çœ‹ä¸€ä¸‹ Sentinel ä¸­ Window çš„ç»“æ„ï¼ŒåŸºæœ¬å’Œæˆ‘ä»¬ä¸Šé¢æƒ³çš„ä¸€è‡´ï¼Œè®¡æ•°å™¨ä½¿ç”¨äº†æ³›å‹ï¼Œå¯ä»¥æ›´çµæ´»12345678910111213141516171819public class WindowWrap&lt;T&gt; &#123; /** * Time length of a single window bucket in milliseconds. */ private final long windowLengthInMs; /** * Start timestamp of the window in milliseconds. */ private long windowStart; /** * Statistic data. */ private T value; // çœç•¥ã€‚ã€‚ã€‚&#125; ç»§ç»­è¯´ currentWindowï¼Œè¯¥æ–¹æ³•æ ¹æ®ä¼ å…¥çš„ timestamp æ‰¾åˆ° æˆ–è€… åˆ›å»º è¿™ä¸ªæ—¶é—´æˆ³å¯¹åº”çš„ Window è¿™ä¸ªæ–¹æ³•æºç ä¸­æ³¨é‡Šå¾ˆå¤šï¼Œæˆ‘åˆ é™¤äº†éƒ¨åˆ†æ³¨é‡Š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public WindowWrap&lt;T&gt; currentWindow(long timeMillis) &#123; if (timeMillis &lt; 0) &#123; return null; &#125; int idx = calculateTimeIdx(timeMillis); // Calculate current bucket start time. long windowStart = calculateWindowStart(timeMillis); /* * Get bucket item at given time from the array. * * (1) Bucket is absent, then just create a new bucket and CAS update to circular array. * (2) Bucket is up-to-date, then just return the bucket. * (3) Bucket is deprecated, then reset current bucket and clean all deprecated buckets. */ while (true) &#123; WindowWrap&lt;T&gt; old = array.get(idx); if (old == null) &#123; WindowWrap&lt;T&gt; window = new WindowWrap&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis)); if (array.compareAndSet(idx, null, window)) &#123; // Successfully updated, return the created bucket. return window; &#125; else &#123; // Contention failed, the thread will yield its time slice to wait for bucket available. Thread.yield(); &#125; &#125; else if (windowStart == old.windowStart()) &#123; return old; &#125; else if (windowStart &gt; old.windowStart()) &#123; if (updateLock.tryLock()) &#123; try &#123; // Successfully get the update lock, now we reset the bucket. return resetWindowTo(old, windowStart); &#125; finally &#123; updateLock.unlock(); &#125; &#125; else &#123; // Contention failed, the thread will yield its time slice to wait for bucket available. Thread.yield(); &#125; &#125; else if (windowStart &lt; old.windowStart()) &#123; // Should not go through here, as the provided time is already behind. return new WindowWrap&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis)); &#125; &#125;&#125; æ–¹æ³•é€»è¾‘åˆ†æå¦‚ä¸‹ï¼š é¦–å…ˆè¦åšçš„ä¸¤ä»¶äº‹ è®¡ç®— timestamp åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡è¯´çš„ calculateTimeIdx è®¡ç®— timestamp çš„ windowStartï¼ˆçª—å£å¼€å§‹æ—¶é—´ï¼‰ï¼Œé€šè¿‡ timeMillis - timeMillis % windowLengthInMsï¼Œè¿™ä¸ªå€¼åœ¨åè¾¹ä¼šç”¨åˆ° ç„¶åè¿›å…¥ä¸€ä¸ª while(true) å¾ªç¯ï¼Œ é€šè¿‡ WindowWrap&lt;T&gt; old = array.get(idx) æ‰¾å‡ºå¯¹åº”çš„çª—å£ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¸‰ç§æƒ…å†µäº† old == null è¿™ä¸ªæ—¶å€™ä»£è¡¨æ•°ç»„ä¸­è¿˜æ²¡æœ‰è¿™ä¸ª windowï¼Œåˆ›å»ºè¿™ä¸ª window åŠ å…¥åˆ°æ•°ç»„ä¸­ï¼ˆç”±äºæ­¤æ—¶å¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ·»åŠ æ•°ç»„å…ƒç´ ï¼Œæ‰€ä»¥ä¸€å®šè¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„æ•°ç»„ä¸º AtomicReferenceArrayï¼‰ï¼Œæ·»åŠ æˆåŠŸåè¿”å›æ–°å»ºçš„ window windowStart == old.windowStart() window å·²ç»å­˜åœ¨äº†ï¼Œç›´æ¥è¿”å›å³å¯ windowStart &gt; old.windowStart() ä»£è¡¨æ•°ç»„ä¸­çš„å…ƒç´ å·²ç»è‡³å°‘æ˜¯ 25s ä¹‹å‰çš„äº†ï¼Œé‡ç½®å½“å‰çª—å£çš„ windowStart å’Œ è®¡æ•°å™¨ï¼Œè¿™ä¸ªæ“ä½œåŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨äº† updateLock.tryLock()ã€‚ ä»”ç»†çœ‹äº†ä»£ç åï¼Œæˆ‘æå‡ºäº†ä¸€ä¸ªé—®é¢˜ã€‚æˆ‘è§‰å¾—è¿™ä¸ªåœ°æ–¹å¹¶ä¸èƒ½ä¸€å®šä¿è¯èƒ½é”ä½ã€‚ä¼šä¸ä¼šå‡ºç°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åˆ¤æ–­éœ€è¦æ›´æ–°ï¼Œç”±äºä¸€ä¸ªçº¿ç¨‹å¾ˆå¿«æ‰§è¡ŒæˆåŠŸå¹¶é‡Šæ”¾äº†é”ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ä¹ŸæˆåŠŸè·å–åˆ° Lockï¼Œä¼šæ‰§è¡Œå¤šæ¬¡ resetWindowã€‚æˆ‘è®¤ä¸ºéœ€è¦å† tryLock ä¹‹åå†åˆ¤æ–­ä¸€ä¸‹æ‰§è¡Œæ¡ä»¶ï¼Œç›®å‰å·²ç»ç»™ Sentinel æäº¤äº† Issue windowStart &lt; old.windowStart() é€šå¸¸æƒ…å†µä¸‹ä¸ä¼šèµ°åˆ°è¿™ä¸ªé€»è¾‘åˆ†æ”¯ï¼Œä¸Šé¢æºç çš„æ³¨é‡Šä¹Ÿæ˜¯è¿™æ ·è§£é‡Šçš„ LeapArray#valuesä¸Šæ–‡ä¸­æåˆ°è¿‡ï¼Œè®¡ç®—æµé‡æ—¶å…·ä½“ä½¿ç”¨å‡ ä¸ªçª—å£ï¼Œå–å†³äºçª—å£å¤§å°å’Œå•ä½æ—¶é—´å¤§å° è¯¥æ–¹æ³•çš„ä½œç”¨é€šè¿‡ä¼ å…¥ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œæ‰¾å‡ºæœ¬æ¬¡è®¡ç®—æ‰€éœ€çš„æ‰€æœ‰æ—¶é—´çª—å£ 123456789101112131415161718192021 public List&lt;T&gt; values(long timeMillis) &#123; if (timeMillis &lt; 0) &#123; return new ArrayList&lt;T&gt;(); &#125; int size = array.length(); List&lt;T&gt; result = new ArrayList&lt;T&gt;(size); for (int i = 0; i &lt; size; i++) &#123; WindowWrap&lt;T&gt; windowWrap = array.get(i); if (windowWrap == null || isWindowDeprecated(timeMillis, windowWrap)) &#123; continue; &#125; result.add(windowWrap.value()); &#125; return result; &#125; public boolean isWindowDeprecated(long time, WindowWrap&lt;T&gt; windowWrap) &#123;// intervalInMs åœ¨å•æœºé™æµè®¡ç®—QPSæ—¶é»˜è®¤ä¸º 1000(ms) return time - windowWrap.windowStart() &gt; intervalInMs; &#125; values çš„é€»è¾‘æ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œéå†æ•°ç»„å°†æ—¶é—´ç¬¦åˆçš„çª—å£åŠ å…¥åˆ° List ä¸­ é‡ç‚¹çœ‹ä¸€ä¸‹ isWindowDeprecated è¿™ä¸ªæ–¹æ³• è¿˜æ˜¯åƒä¸Šé¢é‚£æ ·æŠŠæ•°å€¼å¸¦è¿›å»ã€‚æ¯ä¸ªçª—å£å¤§å°ä¸º 500 msï¼Œä¾‹å¦‚ timestamp ä¸º 1601ï¼Œè¿™ä¸ª timestamp å¯¹åº”çš„ windowStart ä¸º 1500ï¼Œæ­¤æ—¶ (1601 - 1500 &gt; 1000) = false å³è¿™ä¸ªçª—å£æ˜¯æœ‰æ•ˆçš„ï¼Œå†å¾€å‰æ¨ç®—ï¼Œä¸Šä¸€ä¸ªçª—å£ windowStart ä¸º 1000 ä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚å†å¾€å‰æ¨ç®—ï¼Œæˆ–è€…å‘åæ¨ç®—éƒ½æ˜¯æ— æ•ˆçš„çª—å£ã€‚ intervalInMs æˆ‘æ˜¯è¿™æ ·ç†è§£çš„ï¼Œä»¥å¤šé•¿çš„æ—¶é—´æ®µä½œä¸ºå•ä½æ—¶é—´æ¥é™æµã€‚å³å¯ä»¥ä»¥ 1s ä¸ºä¸€ä¸ªæ—¶é—´æ®µæ¥åšé™æµï¼Œä¹Ÿå¯ä»¥ä»¥ 60s ä¸ºä¸€ä¸ªæ—¶é—´æ®µæ¥é™æµã€‚ Sentinel é™æµæ€è·¯åœ¨ç†è§£äº† LeapArray#currentWindow å’Œ LeapArray#values æ–¹æ³•çš„ç»†èŠ‚ä¹‹åï¼Œå…¶å®æˆ‘ä»¬å°±å¯ä»¥ç¢ç£¨å‡ºé™æµçš„å®ç°æ€è·¯äº† é¦–å…ˆæ ¹æ®å½“å‰æ—¶é—´æˆ³ï¼Œæ‰¾åˆ°å¯¹åº”çš„å‡ ä¸ª windowï¼Œæ ¹æ® æ‰€æœ‰ window ä¸­çš„æµé‡æ€»å’Œ + å½“å‰ç”³è¯·çš„æµé‡æ•° å†³å®šèƒ½å¦é€šè¿‡ å¦‚æœä¸èƒ½é€šè¿‡ï¼ŒæŠ›å‡ºå¼‚å¸¸ å¦‚æœèƒ½é€šè¿‡ï¼Œåˆ™å¯¹åº”çš„çª—å£åŠ ä¸Šæœ¬æ¬¡é€šè¿‡çš„æµé‡æ•° Sentinel é™æµå®ç°Sentinel åŸºæœ¬ä¹Ÿæ˜¯è¿™ä¸ªæ€è·¯ï¼Œåªä¸è¿‡é€»è¾‘å¤æ‚ä¸€äº›ï¼Œè¿™é‡Œè´´å‡ºå‡ å¤„ä»£ç ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·± debug ä¸€ä¸‹ Sentinel é™æµæ£€æŸ¥æ ¹æ® Sentinel æ–‡æ¡£ä¸­çš„è§£é‡Šï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è´Ÿè´£é™æµçš„ç±»ä¸º FlowSlotï¼ŒFlowSlot ä¼šä½¿ç”¨ FlowRuleChecker æ¥æ£€æŸ¥å½“å‰èµ„æºæ˜¯å¦éœ€è¦é™æµ FlowSlot#entry FlowRuleChecker#checkFlow æ ¹æ® FlowRule çš„è®¾å®šæ¥åšé™æµæ£€æŸ¥ï¼Œè¿™ä¸­é—´æˆ‘çœç•¥äº†å‡ æ®µä»£ç ï¼Œé»˜è®¤æƒ…å†µæ²¡æœ‰è®¾ç½® ControlBehavior ä¼šä½¿ç”¨ DefaultController#canPass åšé™æµæ£€æŸ¥ã€‚å¦‚ä¸‹å›¾ï¼Œé€šè¿‡åˆ¤æ–­ å½“å‰æµé‡æ•° + ç”³è¯·çš„æ•°é‡ æ˜¯å¦å¤§äºé¢„è®¾çš„æ•°é‡ï¼Œæ¥å†³å®šæ˜¯å¦é™æµ æ³¨ï¼šå½“ä½¿ç”¨ SphU.entry æ—¶ prioritized = falseï¼Œä½¿ç”¨ SphU.entryWithPriority æ—¶ prioritized = trueã€‚node.tryOccupyNext çš„å«ä¹‰ï¼šå¦‚æœæƒ³å ç”¨æœªæ¥çš„æ—¶é—´çª—å£ä»¤ç‰Œï¼Œéœ€è¦ç­‰å¾…å¤šä¹…ï¼ˆä¸Šå›¾ä¸­çš„waitInMsï¼‰ã€‚å¦‚æœå°äºè§„å®šçš„è¶…æ—¶æ—¶é—´ï¼Œåˆ™è®°å½•æ­£åœ¨ç­‰å¾…çš„è¯·æ±‚æ•°ï¼Œç„¶åæ‰§è¡Œ sleep(waitInMs)ï¼Œå¤–å±‚æ•è·åˆ° PriorityWaitException ä¼šè‡ªå·±å¤„ç†æ‰ï¼Œç„¶åæ‰§è¡Œç”¨æˆ·é€»è¾‘ï¼Œç”¨æˆ·å®Œå…¨æ— æ„ŸçŸ¥ã€‚ é€šè¿‡ä¸Šå›¾ avgUsedTokens å¯ä»¥çœ‹åˆ°ï¼Œå½“ Rule çš„ grade ä¸º FLOW_GRADE_QPS æ—¶ï¼Œä¼šè°ƒç”¨ node.pass()ã€‚è¿™é‡Œè°ƒç”¨çš„å…·ä½“å®ç°ä¸º StatisticNode#passQpsï¼Œå¦‚ä¸‹å›¾ rollingCounterInSecond.getWindowIntervalInSec() è®¡ç®— QPS æ—¶ä¸º 1 ç§’ rollingCounterInSecond.pass() è®¡ç®— QPS æ—¶ï¼Œæœ€å¤šè¿”å›ä¸¤ä¸ªçª—å£çš„é€šè¿‡è¯·æ±‚æ•°ï¼ˆcurrentWindow + lastWindowï¼‰ rollingCounterInSecond#pass é¦–å…ˆå…ˆå°è¯•æ˜¯å¦éœ€è¦åˆ›å»ºå½“å‰çš„æ—¶é—´çª—å£ï¼Œç„¶åæ‰¾åˆ°ç›¸å…³çš„çª—å£ï¼Œè®¡ç®—æµé‡æ€»å’Œã€‚ Sentinel è¯·æ±‚è®°å½•ä»£ç ä½ç½® StatisticSlot#entryï¼ŒfireEntry ä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„è§„åˆ™è¿›è¡Œæ£€æŸ¥ï¼ˆä¾‹å¦‚ä¸Šè¿°çš„é™æµï¼‰ã€‚ å¦‚æœæ£€æŸ¥æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™è®°å½•çº¿ç¨‹æ•°å’Œç”³è¯·çš„è¯·æ±‚æ•°ï¼ˆé™æµæ£€æŸ¥ä¾èµ–çš„æ•°æ®å°±æ˜¯è¿™é‡Œè®°å½•çš„ï¼‰ã€‚ é›†ç¾¤é™æµé›†ç¾¤é™æµæœ‰ä»€ä¹ˆç”¨åœ¨æ²¡æœ‰é›†ç¾¤é™æµä¹‹å‰ï¼Œå¦‚æœæƒ³æŠŠæ•´ä¸ªæœåŠ¡çš„ QPS é™åˆ¶åœ¨æŸä¸ªå€¼ã€‚ä¸¾ä¸ªä¾‹å­ç°åœ¨æŸ Server æœ‰åä¸ªå®ä¾‹ï¼Œæˆ‘ä»¬å¸Œæœ›æ€» QPS ä¸è¶…è¿‡ 100ï¼Œè¿™æ—¶æˆ‘ä»¬çš„åšæ³•æ˜¯æŠŠæ¯ä¸ªå®ä¾‹çš„ QPS è®¾ç½®ä¸º 10ã€‚ åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™æ ·åšå¯ä»¥å°† QPS æ§åˆ¶åœ¨ 100ã€‚ä½†æ˜¯å¦‚æœæ¯å° Server åˆ†é…åˆ°çš„æµé‡ä¸å‡åŒ€ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´æ€»é‡åœ¨æ²¡è¾¾åˆ° 100 çš„æ—¶å€™ï¼ŒæŸäº› Server å°±å¼€å§‹é™æµäº†ã€‚ è¿™ç§æƒ…å†µå°±éœ€è¦ Sentinel çš„é›†ç¾¤é™æµå‡ºåœºäº†ã€‚ é›†ç¾¤é™æµåŸç†ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘ä»¬è¿™é‡Œä¸è®¨è®ºå¦‚ä½•æ­å»ºé›†ç¾¤é™æµï¼Œåªæ˜¯æ¥è¯´è¯´ Sentinel å¦‚ä½•åœ¨è¿™ä¸€åŸºç¡€ä¸Šåšçš„é›†ç¾¤é™æµã€‚ æ€è·¯å¾ˆç®€å•ï¼Œé€‰å‡ºä¸€ä¸ª Token Serverã€‚åœ¨å¼€å¯é›†ç¾¤é™æµåï¼Œæ‰€æœ‰çš„ Client åœ¨éœ€è¦é™æµæ—¶ï¼Œè¯¢é—® Token Serverï¼ŒServer å†³å®šå½“å‰è¯·æ±‚æ˜¯å¦é™æµã€‚å…·ä½“çš„å®ç°ç»†èŠ‚ä¸å•æœºé™æµç•¥æœ‰ä¸åŒï¼Œä½†æ˜¯æ ¸å¿ƒçš„ç®—æ³•è¿˜æ˜¯ä½¿ç”¨çš„ LeapArray è¿™é‡Œä¹Ÿæ˜¯ç»™å‡ºå‡ å¤„æºç ä½ç½®ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è‡ªè¡Œé˜…è¯»ä¸€ä¸‹ Client ç«¯æ ¹æ® Rule å†³å®šæœ¬æ¬¡ä½¿ç”¨æœ¬åœ°é™æµè¿˜æ˜¯é›†ç¾¤é™æµï¼ŒFlowRuleChecker#canPassCheck Server ç«¯ï¼ŒDefaultTokenService#requestToken å¹¶å‘ä¸‹é™æµçš„é—®é¢˜åœ¨å®Œæ•´çš„é˜…è¯»å®Œå•æœºå’Œé›†ç¾¤çš„é™æµä»£ç ä¹‹åï¼Œå‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œé™æµæµç¨‹å¯ä»¥ç®€åŒ–ä¸ºå¦‚ä¸‹1234567891011121314// ä¼ªä»£ç // æœ€å¤§QPSint maxCount;// å½“å‰ç”³è¯·çš„æµé‡æ•°int aquireCount;int passQps = getPassQPS();if (passQps + aquireCount &lt;= maxCount) &#123; addPass(aquireCount);&#125; else &#123; // é™æµå¤„ç†&#125; ç”±äºæ²¡æœ‰å¹¶å‘æ§åˆ¶ï¼Œå¹¶å‘åœºæ™¯ä¸‹ä¼šå‡ºç°ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶æ»¡è¶³ passQps + aquireCount &lt;= maxCountï¼Œç„¶åå¢åŠ æµé‡ç»Ÿè®¡ï¼Œè¿™æ ·çš„è¯ï¼Œæ²¡æ³•ä¿è¯ä¸€å®šå°† QPS æ§åˆ¶åœ¨ maxCountï¼Œå¹¶å‘çš„æƒ…å†µä¸‹ä¼šå‡ºç°å®é™…æµé‡è¶…å‡ºé¢„è®¾ QPS çš„æƒ…å†µã€‚ è¿™è‚¯å®šä¸æ˜¯ä¸ªBugã€‚è¿™é‡Œæ²¡æœ‰å¹¶å‘æ§åˆ¶å¯èƒ½æ˜¯å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œåœ¨æ€§èƒ½å’Œå‡†ç¡®åº¦å¯ä»¥æ¥å—çš„æƒ…å†µä¸‹åšäº†ä¸€ä¸ªæŠ˜ä¸­ æ‰€ä»¥åœ¨ä½¿ç”¨æ—¶ï¼Œå¦‚æœå®é™… QPS é«˜äºé¢„è®¾å€¼ï¼Œå¯èƒ½æ˜¯å¹¶å‘å¯¼è‡´çš„ demo å•æœºé™æµï¼š https://github.com/TavenYin/taven-springcloud-learning/blob/master/sentinel-example/src/main/java/com/github/taven/limit/SentinelExample.java é›†ç¾¤é™æµï¼šhttps://github.com/TavenYin/taven-springcloud-learning/blob/master/sentinel-example/src/main/java/com/github/taven/limit/SentinelClusterEmbedded.java]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>æºç </tag>
        <tag>Sentinel</tag>
        <tag>é™æµ</tag>
        <tag>å¾®æœåŠ¡</tag>
        <tag>åˆ†å¸ƒå¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[èŠèŠ Java GC ç®—æ³•]]></title>
    <url>%2Fpost%2F1e4a5faa.html</url>
    <content type="text"><![CDATA[Java å’Œ C++ ä¹‹é—´æœ‰ä¸€å µç”±å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾å›æ”¶æŠ€æœ¯æ‰€å›´æˆçš„é«˜å¢™ï¼Œå¢™å¤–é¢çš„äººæƒ³è¿›å»ï¼Œå¢™é‡Œé¢çš„äººå´æƒ³å‡ºæ¥ ä»Šå¤©æ¥èŠèŠ Java GCï¼ˆGarbage Collectionï¼Œåƒåœ¾å›æ”¶ï¼‰ä¸­çš„å¸¸è§ç®—æ³• å¼•ç”¨ä¸GCçš„å…³ç³»æ­£é¢˜å¼€å§‹å‰ï¼Œå…ˆæ¥äº†è§£ä¸€ä¸‹ Java ä¸­çš„å¼•ç”¨ã€‚å¯¹è±¡ä½¿ç”¨ä¸åŒçš„å¼•ç”¨ç±»å‹ï¼Œå†³å®š GC å‘ç”Ÿæ—¶æ˜¯å¦ä¼šå›æ”¶å®ƒ å¼•ç”¨ç±»å‹ ç‰¹ç‚¹ å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰ Javaä¸­çš„é»˜è®¤å¼•ç”¨ç±»å‹ã€‚ä¾‹å¦‚Object obj = new Object()ï¼Œåªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡æ°¸è¿œä¸ä¼šè¢«å›æ”¶ è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰ å†…å­˜è¶³å¤Ÿæ—¶ï¼Œè½¯å¼•ç”¨ä¸ä¼šè¢«å›æ”¶ã€‚åªæœ‰å½“ç³»ç»Ÿè¦å‘ç”Ÿå†…å­˜æº¢å‡ºæ—¶ï¼Œæ‰ä¼šè¢«å›æ”¶ã€‚é€‚åˆç”¨äºç¼“å­˜åœºæ™¯ å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰ åªè¦å‘ç”Ÿåƒåœ¾å›æ”¶ï¼Œå¼±å¼•ç”¨çš„å¯¹è±¡å°±ä¼šè¢«å›æ”¶ è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰ ä¸€ä¸ªå¯¹è±¡æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ä¸ä¼šå¯¹ç”Ÿå­˜æ—¶é—´éƒ½æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥è·å–å¯¹ä¸€ä¸ªå¯¹è±¡çš„çœŸå®å¼•ç”¨ã€‚å”¯ä¸€çš„ç”¨å¤„ï¼šèƒ½åœ¨å¯¹è±¡è¢«GCæ—¶æ”¶åˆ°ç³»ç»Ÿé€šçŸ¥ å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›æ”¶ï¼Ÿåœ¨GCå¼€å§‹ä¹‹å‰ï¼Œé¦–å…ˆè¦åšçš„äº‹å°±æ˜¯ç¡®å®šå“ªäº›å¯¹è±¡ã€æ´»ç€ã€ï¼Œå“ªäº›å¯¹è±¡ã€å·²æ­»ã€ å¸¸è§çš„ä¸¤ç§ç®—æ³•ç”¨äºåˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›æ”¶ å¼•ç”¨è®¡æ•°ç®—æ³•ï¼šæ¯ä¸ªå¯¹è±¡ä¸­æ·»åŠ å¼•ç”¨è®¡æ•°å™¨ã€‚æ¯å½“å¯¹è±¡è¢«å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°å™¨å°±ä¼šåŠ  1ï¼›æ¯å½“å¼•ç”¨å¤±æ•ˆï¼Œè®¡æ•°å™¨å°±ä¼šå‡ 1ã€‚å½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨çš„å€¼ä¸º 0 æ—¶ï¼Œå°±è¯´æ˜è¯¥å¯¹è±¡ä¸å†è¢«å¼•ç”¨ï¼Œå¯ä»¥è¢«å›æ”¶äº†ã€‚å¼ºè°ƒä¸€ç‚¹ï¼Œè™½ç„¶å¼•ç”¨è®¡æ•°ç®—æ³•çš„å®ç°ç®€å•ï¼Œåˆ¤æ–­æ•ˆç‡ä¹Ÿå¾ˆé«˜ï¼Œä½†å®ƒå­˜åœ¨ç€å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼ˆæ‰€ä»¥åœ¨åæ¥çš„JVMç‰ˆæœ¬ä¸­å·²ç»ä¸é‡‡ç”¨è¿™ç§ç®—æ³•äº†ï¼‰ã€‚ å¯è¾¾æ€§åˆ†æç®—æ³•ï¼šGC Roots æ˜¯è¯¥ç®—æ³•çš„åŸºç¡€ï¼ŒGC Roots æ˜¯æ‰€æœ‰å¯¹è±¡çš„æ ¹å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡ä½œä¸ºæ­£å¸¸å¯¹è±¡çš„èµ·å§‹ç‚¹ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œä¼šä»è¿™äº› GC Roots å¼€å§‹å‘ä¸‹æœç´¢ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ° GC Roots æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œå°±è¯æ˜æ­¤å¯¹è±¡ä¸å†è¢«å¼•ç”¨ã€‚ç›®å‰ HotSpot è™šæ‹Ÿæœºé‡‡ç”¨çš„å°±æ˜¯è¿™ç§ç®—æ³•ã€‚ å¯ä»¥ä½œä¸º GC Roots çš„å¯¹è±¡ï¼š è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNIï¼ˆNative æ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡ Java è™šæ‹Ÿæœºä¸­å†…éƒ¨çš„å¼•ç”¨ synchronized æŒæœ‰çš„å¯¹è±¡ JMXBeanã€JVMTI ä¸­æ³¨å†Œçš„å›è°ƒã€æœ¬åœ°ä»£ç ç¼“å­˜ é™¤æ­¤ä¹‹å¤–ï¼Œä¸åŒçš„åƒåœ¾å›æ”¶å™¨å¯èƒ½è¿˜ä¼šåŠ å…¥ä¸€äº›ã€ä¸´æ—¶çš„ã€å¯¹è±¡å…±åŒæ„å»º GC Roots åŸºç¡€çš„ GC ç®—æ³•æ ‡è®°-æ¸…é™¤ç®—æ³• ï¼ˆmark-sweepï¼‰å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¯¥ç®—æ³•åˆ†ä¸ºã€æ ‡è®°ã€å’Œã€æ¸…é™¤ã€ä¸¤ä¸ªé˜¶æ®µ ä» GC Roots å‡ºå‘æ ‡è®°å‡ºå­˜æ´»çš„å¯¹è±¡ï¼Œç„¶åéå†å †æ¸…é™¤æœªè¢«æ ‡è®°çš„å¯¹è±¡ æœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•ï¼Œæ ‡è®°-æ¸…é™¤çš„æ•ˆç‡ä¸­ç­‰ï¼Œç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼šä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ å¤åˆ¶ç®—æ³•ï¼ˆcopyingï¼‰å°†å¯ç”¨å†…å­˜æŒ‰å®¹é‡åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚å½“è¿™ä¸€å—å†…å­˜ç”¨å®Œï¼Œéœ€è¦è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå°±å°†å­˜æ´»è€…çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—ä¸Šé¢ï¼Œç„¶åå°†ç¬¬ä¸€å—å†…å­˜å…¨éƒ¨æ¸…é™¤ ç›¸æ¯”è¾ƒã€æ ‡è®°-æ¸…é™¤ã€ä¸ä¼šæœ‰å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œä½†æ¯æ¬¡åªä½¿ç”¨ä¸€åŠçš„å†…å­˜ï¼Œå†…å­˜åˆ©ç”¨ç‡å¾ˆä½ã€‚å½“å†…å­˜ä¸­å­˜æ´»çš„å¯¹è±¡è¾ƒå¤šæ—¶ï¼Œä¼šè¿›è¡Œå¤§é‡çš„å¤åˆ¶æ“ä½œï¼Œæ•ˆç‡ä¼šè¾ƒä½ï¼ˆå¯¹è±¡çš„å¤åˆ¶ä¹Ÿæ˜¯æœ‰æˆæœ¬çš„ï¼Œéœ€è¦å¤åˆ¶çš„å¯¹è±¡è¶Šå¤šã€è¶Šå¤§ï¼Œå¤åˆ¶å¸¦æ¥çš„ä»£ä»·ä¹Ÿå°±è¶Šå¤§ï¼‰ã€‚é€‚ç”¨äºå­˜æ´»ç‡ä½çš„æƒ…å†µ æ ‡è®°-æ•´ç†ç®—æ³•ï¼ˆmark-compactï¼‰å’Œã€æ ‡è®°-æ¸…é™¤ã€ç®—æ³•æœ‰ç‚¹ç±»ä¼¼ï¼Œä» GC Roots å‡ºå‘æ ‡è®°å‡ºå­˜æ´»çš„å¯¹è±¡ï¼Œç„¶åæ˜¯æ•´ç†é˜¶æ®µï¼Œå°†å­˜æ´»ç§»åŠ¨åˆ°ä¸€ç«¯ã€‚æ•´ç†é˜¶æ®µç»“æŸåæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸€ä¸ªä¸´ç•Œç‚¹ï¼Œå¦ä¸€ç«¯çš„å†…å­˜ç©ºé—´å°±å¯ä»¥è¢«é‡æ–°åˆ†é…äº† è¯¥ç®—æ³•çš„ä¼˜ç‚¹ï¼šä¸åƒå¤åˆ¶ç®—æ³•é‚£æ ·ä¼šæµªè´¹å†…å­˜ç©ºé—´ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚ å†™åˆ°è¿™æ—¶ï¼Œæˆ‘å¾ˆæƒ³çŸ¥é“ã€æ ‡è®°-æ•´ç†ã€çš„æ•ˆç‡å¦‚ä½•ã€‚ä¸€ç•ªæœç´¢åï¼Œå‘ç°è¯¥ç®—æ³•æ˜¯è¿™ä¸‰ç§ç®—æ³•ä¸­æ•ˆç‡æœ€ä½çš„ï¼Œå› ä¸ºã€æ•´ç†ã€è¿™ä¸ªè¿‡ç¨‹ä¼šéå†æ•´ä¸ªå †ä¸‰æ¬¡ï¼Œå…·ä½“å®ç°æ€è·¯å¦‚ä¸‹ ã€æ ‡è®°-æ•´ç†ã€ä»¥ lisp2 ç®—æ³•ä¸ºä¾‹ï¼Œå®ç°æ€è·¯å¦‚ä¸‹ æ ‡è®°é˜¶æ®µï¼šé¦–å…ˆä» GC Roots å‡ºå‘ï¼Œæ ‡è®°å‡ºæ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ è®¾ç½® forwarding æŒ‡é’ˆï¼šæ¯ä¸ªå¯¹è±¡å¤´ä¸­éƒ½æœ‰ä¸€ä¸ªforwardingæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥å¯¹è±¡æ•´ç†åçš„ä½ç½®ã€‚éå†æ•´ä¸ªå †è®¡ç®—å­˜æ´»å¯¹è±¡çš„ forwarding æ›´æ–°æŒ‡é’ˆï¼šéå†æ•´ä¸ªå †ï¼Œæ ¹æ® forwarding æ›´æ–° GC Roots æŒ‡é’ˆä»¥åŠæ‰€æœ‰å­˜æ´»å¯¹è±¡çš„å­å¯¹è±¡çš„æŒ‡é’ˆï¼Œå°†æŒ‡é’ˆæŒ‡å‘æ–°çš„ä½ç½® ç§»åŠ¨å¯¹è±¡ï¼šéå†æ•´ä¸ªå †ï¼Œæ ¹æ® forwarding ç§»åŠ¨å¯¹è±¡å¹¶ä¸”æ¸…é™¤å¯¹è±¡ä¸­çš„æ ‡è®° èŠèŠæˆ‘ä¸ªäººçš„ç†è§£ï¼Œä¸ºä»€ä¹ˆ2,3,4ä¸€å®šè¦éå†æ•´ä¸ªå †ï¼Ÿéƒ½æ˜¯é’ˆå¯¹å­˜æ´»å¯¹è±¡çš„æ“ä½œï¼Œç›´æ¥éå† GC Roots ä¸è¡Œå—ï¼Ÿ è®¾ç½® forwarding é˜¶æ®µï¼šä¸€å®šè¦é¡ºåºéå†æ•´ä¸ªå †ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æœä»…æ˜¯éå† GC Roots çš„è¯ï¼Œä½ æ²¡æ³•çŸ¥é“Aè¿™ä¸ªåŒºåŸŸæ˜¯å¦å¯ä»¥è¦†ç›– æ›´æ–°æŒ‡é’ˆé˜¶æ®µï¼šæˆ‘è§‰å¾—è¿™ä¸ªé˜¶æ®µä»…éå† GC Roots çš„è¯ï¼Œç¡®å®å¯è¡Œ ç§»åŠ¨å¯¹è±¡é˜¶æ®µï¼šç”±äº GC Roots æŒ‡é’ˆå·²ç»å…¨éƒ¨æŒ‡å‘æ–°çš„ä½ç½®äº†ï¼Œåªèƒ½éå†æ•´ä¸ªå † å†™åˆ°è¿™ï¼Œæˆ‘åˆæƒ³ä¸ºä»€ä¹ˆä¸€å®šè¦ä¸‰ä¸ªæ­¥éª¤æè¿™ä¹ˆå¤æ‚ï¼Œç›´æ¥ç§»åŠ¨å¯¹è±¡ä¸è¡Œå—ï¼Ÿ æ ¹æ®ä¸Šé¢çš„ç†è§£ï¼Œä¸€å®šè¦éå†æ•´ä¸ªå †æ¥ç¡®å®šå­˜æ´»çš„å¯¹è±¡è¯¥ç§»åŠ¨åˆ°å“ªã€‚å°±ç°æœ‰çš„ç»“æ„æ¥çœ‹ï¼Œå¦‚æœç›´æ¥ç§»åŠ¨ï¼Œå­å¯¹è±¡çš„æŒ‡é’ˆè¿˜å¥½è¯´å¯ä»¥å¤„ç†ï¼ŒGC Roots ä¸­çš„æŒ‡é’ˆå°±æ²¡æ³•æ›´æ–°äº† å…³äºlisp2 å®ç°çš„æ›´å¤šç»†èŠ‚å¯ä»¥å‚è€ƒä¸‹è¿™ç¯‡Blog ã€gc-æ ‡è®°æ•´ç†ç®—æ³•çš„ä¸¤ç§å®ç°ã€ å°ç»“æ€»ç»“ä¸‹ä¸Šè¿°ä¸‰ç§åŸºç¡€GCç®—æ³•çš„ä¼˜ç¼ºç‚¹ ç»´åº¦ æ ‡è®°-æ¸…é™¤ æ ‡è®°-æ•´ç† å¤åˆ¶ç®—æ³• é€Ÿåº¦ ä¸­ç­‰ æœ€æ…¢ æœ€å¿« æ—¶é—´å¼€é”€ marké˜¶æ®µä¸å­˜æ´»å¯¹è±¡çš„æ•°é‡æˆæ­£æ¯”ï¼Œsweepé˜¶æ®µä¸æ•´å †å¤§å°æˆæ­£æ¯” marké˜¶æ®µä¸å­˜æ´»å¯¹è±¡çš„æ•°é‡æˆæ­£æ¯”ï¼Œcompacté˜¶æ®µä¸æ•´å †å¤§å°æˆæ­£æ¯”ï¼Œä¸å­˜æ´»å¯¹è±¡çš„å¤§å°æˆæ­£æ¯” ä¸å­˜æ´»å¯¹è±¡å¤§å°æˆæ­£æ¯” ç©ºé—´å¼€é”€ å°‘ï¼ˆä½†ä¼šå †ç§¯ç¢ç‰‡ï¼‰ å°‘ï¼ˆä¸å †ç§¯ç¢ç‰‡ï¼‰ é€šå¸¸éœ€è¦å­˜æ´»å¯¹è±¡çš„2å€å¤§å°ï¼ˆä¸å †ç§¯ç¢ç‰‡ï¼‰ ç§»åŠ¨å¯¹è±¡ å¦ æ˜¯ æ˜¯ åˆ†ä»£å›æ”¶ç†è®ºåƒåœ¾å›æ”¶å™¨éƒ½ä¸ä¼šåªé€‰æ‹©ä¸€ç§ç®—æ³•ï¼ŒJVMæ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒï¼Œå°†å†…å­˜åˆ’åˆ†ä¸ºå‡ å—ã€‚ä¸€èˆ¬æ˜¯æŠŠå †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œæ ¹æ®å¹´ä»£çš„ç‰¹ç‚¹æ¥é€‰æ‹©æœ€ä½³çš„æ”¶é›†ç®—æ³•ã€‚ HotSpot ä¸­å¤§éƒ¨åˆ†åƒåœ¾å›æ”¶å™¨éƒ½é‡‡ç”¨åˆ†ä»£å›æ”¶çš„æ€æƒ³ æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³• è€å¹´ä»£ï¼šæ ‡è®°-æ¸…é™¤ / æ ‡è®°-æ•´ç† / æˆ–è€…ä¸¤è€…åŒæ—¶ä½¿ç”¨ å †å¤§å°=æ–°ç”Ÿä»£+è€å¹´ä»£ï¼ˆé»˜è®¤åˆ†åˆ«å å †ç©ºé—´ä¸º1/3ã€2/3ï¼‰ï¼Œæ–°ç”Ÿä»£åˆè¢«åˆ†ä¸ºEdenã€from survivor (S0)ã€to survivor (S1)ï¼Œé»˜è®¤åˆ†é…æ¯”ä¾‹ä¸º 8:1:1 å¯¹è±¡çš„åˆ†é…å¯¹è±¡çš„åˆ†é…é€šå¸¸åœ¨ Eden ä¸­ï¼ˆéœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„ Java å¯¹è±¡ï¼Œå¦‚å¾ˆé•¿çš„å­—ç¬¦ä¸²æˆ–æ•°æ®å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œç”± -XX:PretenureSizeThreshold å†³å®šï¼‰ æ–°ç”Ÿä»£çš„å›æ”¶å½“ Eden åŒºæ»¡åï¼Œä¼šè§¦å‘ Young GCï¼ˆæ–°ç”Ÿä»£å›æ”¶ï¼‰ï¼Œå¤åˆ¶ Eden åŒºå’Œ S0 åŒºä¸­å­˜æ´»çš„å¯¹è±¡åˆ° S1 æˆ–è€…è€å¹´ä»£ï¼ˆå…¶ä¸­åˆ°è¾¾å¹´é¾„çš„ä¼šè¢«æ”¾å…¥è€å¹´ä»£ï¼Œæœªåˆ°è¾¾å¹´é¾„çš„æ”¾å…¥ S1 åŒºï¼‰ æ¯ç»å†ä¸€æ¬¡ Young GCï¼Œsurvivor åŒºä¸­å¯¹è±¡å¹´é¾„ +1 ç„¶åæ¸…ç©º Eden åŒºå’Œ S0 åŒºï¼Œäº¤æ¢ S0 ä¸ S1 çš„åå­— è‹¥å­˜æ´»å¯¹è±¡å¤§äº S1 åŒºå®¹é‡ï¼Œåˆ™ä¼šè¢«ç›´æ¥æ”¾å…¥è€å¹´ä»£ã€‚è‹¥æ‰“å¼€äº†è‡ªé€‚åº”ï¼ˆ-XX:+AdaptiveSizePolicyï¼‰ï¼ŒGCä¼šè‡ªåŠ¨é‡æ–°è°ƒæ•´æ–°ç”Ÿä»£å¤§å° è€å¹´ä»£çš„å›æ”¶åœ¨å‘ç”Ÿ Full GC æˆ–è€… Old GC æ—¶ï¼Œä¼šæ ¹æ®ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æˆ–è€…æƒ…å†µé€‰æ‹©ä½¿ç”¨ æ ‡è®°-æ¸…é™¤ / æ ‡è®°-æ•´ç† æ¥è¿›è¡Œå›æ”¶ é™¤äº† Young GC ä¹‹å¤–ï¼Œå¸¸è§çš„è¿˜æœ‰ Full GCï¼ˆæ–°ç”Ÿä»£ã€è€ç”Ÿä»£ã€å…ƒç©ºé—´æˆ–æ°¸ä¹…ä»£çš„å›æ”¶ï¼‰ Old GCï¼ˆåªæœ‰ CMS æœ‰è¿™ä¸ªæ¨¡å¼ï¼‰ Mixed GCï¼ˆåªæœ‰ G1 æœ‰è¿™ä¸ªæ¨¡å¼ï¼‰ é€šå¸¸æƒ…å†µä¸‹ Full GC çš„è§¦å‘æ¡ä»¶ï¼Œå½“å‡†å¤‡è¦è§¦å‘ä¸€æ¬¡ Young GCæ—¶ï¼Œå¦‚æœå‘ç°ç»Ÿè®¡æ•°æ®è¯´ä¹‹å‰ Young GC çš„å¹³å‡æ™‹å‡å¤§å°æ¯”ç›®å‰è€å¹´ä»£å‰©ä½™çš„ç©ºé—´å¤§ï¼Œåˆ™ä¸ä¼šè§¦å‘ Young GC è€Œæ˜¯è½¬ä¸ºè§¦å‘ Full GC å°ç»“ç”±äºæ–°ç”Ÿä»£çš„ç‰¹ç‚¹æ˜¯å¤§å¤šæ•°å¯¹è±¡éƒ½æ˜¯ã€Œæœç”Ÿå¤•æ­»ã€çš„ï¼Œå­˜æ´»ç‡ä½ï¼Œæ‰€ä»¥éå¸¸é€‚åˆå¤åˆ¶ç®—æ³•ã€‚è€Œ survivor åŒºå­˜åœ¨çš„æ„ä¹‰æ˜¯ä¸ºäº†ç¡®ä¿ã€Œæœç”Ÿå¤•æ­»ã€çš„å¯¹è±¡ä¸ä¼šè½»æ˜“è¿›å…¥è€å¹´ä»£ï¼Œå½“å¯¹è±¡çš„å¹´é¾„æ»¡è¶³ï¼ˆç»å†äº†å¤šæ¬¡ Young GCï¼‰æ‰ä¼šè¿›å…¥è€å¹´ä»£ã€‚ åˆåˆ°äº†æé—®ç¯èŠ‚ï¼Œä¸ºä»€ä¹ˆåˆ†ä»£å›æ”¶ä¸­éœ€è¦æœ‰ä¸¤ä¸ª survivor åŒºï¼Œä¸€ä¸ªä¸è¡Œå—ï¼Ÿ ç­”æ¡ˆæ˜¯ä¸è¡Œã€‚å‡è®¾åªæœ‰ä¸€ä¸ª survivorï¼ŒEden å›æ”¶åå­˜æ´»çš„å¯¹è±¡è¿›å…¥äº† survivorã€‚é‚£ä¹ˆ survivor åŒºå¯ä»¥è¢«å›æ”¶çš„å¯¹è±¡è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿéš¾é“è¦ç”¨æ ‡è®°æ¸…é™¤å’Œæ ‡è®°æ•´ç†ï¼Ÿé‚£å¯å¤ªæ²¡æœ‰å¿…è¦äº†ï¼Œæ‰€ä»¥åˆ’åˆ†å‡ºä¸¤ä¸ª survivor åŒºï¼Œå°†æ–°ç”Ÿä»£çš„å¤åˆ¶ç®—æ³•è´¯å½»åˆ°åº• å‚è€ƒã€æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€ ã€æå®¢æ—¶é—´ - Javaæ€§èƒ½è°ƒä¼˜å®æˆ˜ã€ ã€Java-GC åƒåœ¾æ”¶é›†ç®—æ³•ã€ ã€gc-æ ‡è®°æ•´ç†ç®—æ³•çš„ä¸¤ç§å®ç°ã€ ã€Mark-compact algorithm - Wikipediaã€ ã€ä¸ºä»€ä¹ˆæ–°ç”Ÿä»£å†…å­˜éœ€è¦æœ‰ä¸¤ä¸ªSurvivoråŒºã€ ã€Major GCå’ŒFull GCçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿè§¦å‘æ¡ä»¶å‘¢ï¼Ÿ - RednaxelaFXçš„å›ç­” - çŸ¥ä¹ã€ ã€å…³äºJVMåƒåœ¾æœé›†ç®—æ³•ï¼ˆæ ‡è®°-æ•´ç†ç®—æ³•ä¸å¤åˆ¶ç®—æ³•ï¼‰çš„æ•ˆç‡ï¼Ÿ - RednaxelaFXçš„å›ç­” - çŸ¥ä¹ã€]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>JVM</tag>
        <tag>GC</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Oracle LogMiner æ•°æ®è¿ç§»å®æˆ˜]]></title>
    <url>%2Fpost%2F82cb4508.html</url>
    <content type="text"><![CDATA[LogMiner æ˜¯ä»€ä¹ˆLogMiner æ˜¯Oracleå®˜æ–¹æä¾›çš„å·¥å…·ï¼Œå¯ä»¥è§£æ Redo log å’Œ Archived Redo log LogMiner å¯ä»¥åšä»€ä¹ˆï¼Ÿå®˜æ–¹æ–‡æ¡£ä¸­åˆ—ä¸¾äº†å¾ˆå¤šï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å»çœ‹ä¸‹ã€‚ æˆ‘ä»¬ç›®å‰çš„é¡¹ç›®åœ¨ä½¿ç”¨åŸºäºLogMiner çš„ Debezium Oracle Connector åšæ•°æ®è¿ç§» Oracle LogMiner æ•°æ®è¿ç§»çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿé¦–å…ˆéœ€è¦äº†è§£å‡ ä¸ªæ¦‚å¿µï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹ Redo logï¼šRedoä¸­è®°å½•äº†æ‰€æœ‰å¯¹æ•°æ®å—çš„æ›´æ”¹ï¼ŒOralce è¦æ±‚è‡³å°‘æœ‰ä¸¤ä¸ªä»¥ä¸Šçš„Redo Log Group Archived Redo logï¼šå½“ä¸€ä¸ªRedo Log å†™æ»¡ä¹‹åï¼Œä¼šå‘ç”Ÿæ—¥å¿—åˆ‡æ¢ï¼Œæ•°æ®çš„æ›´æ”¹ä¼šè®°å½•åˆ°ä¸‹ä¸€ä¸ªRedo Logä¸­ï¼ˆæ‰€ä»¥ä¸€å®šè¦æœ‰ä¸¤ä¸ªä»¥ä¸Šçš„Redoï¼‰ã€‚å¦‚æœå¼€å¯äº†å½’æ¡£æ¨¡å¼ï¼ŒOracle ä¼šå°†å†™æ»¡çš„Redo Log å½’æ¡£ã€‚ SCN (System Change Number)ï¼šOracle å†…éƒ¨é€»è¾‘æ—¶é—´æˆ³ Flashbackï¼šé€šè¿‡é—ªå›æŸ¥è¯¢ SELECT ... AS OF SCN å¯ä»¥æŸ¥è¯¢OracleæŸä¸ªæ—¶é—´ç‚¹çš„å…¨é‡æ•°æ® æ€è·¯å¦‚ä¸‹ï¼š é¦–å…ˆæŸ¥è¯¢å‡ºä¸€ä¸‹å½“å‰çš„SCN æ ¹æ®SCN æŸ¥è¯¢å‡ºè¿™ä¸€æ—¶åˆ»çš„å…¨é‡æ•°æ® é€šè¿‡Logminer æŒ‡å®šStart_SCNï¼Œè·å–å¢é‡æ•°æ® å®‰è£…ä¸é…ç½®æƒ³å°è¯•å´ä¸å¤ªç†Ÿæ‚‰Oracleçš„åŒå­¦ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹æˆ‘æ•´ç†çš„æ–‡æ¡£ Oralce Install (docker)ï¼š https://github.com/TavenYin/database-cdc/blob/master/doc/oracle/oracle-install.md Logminerï¼šhttps://github.com/TavenYin/database-cdc/blob/master/doc/oracle/oracle12c-logminer.md å°è¯•ç‰›åˆ€åœ¨å‡†å¤‡å¥½äº†ç¯å¢ƒä¹‹åï¼Œæˆ‘ä»¬æ¥å¼€ç®±ä½“éªŒä¸€ä¸‹Logminer logminer ç”¨æˆ·ç™»å½• conn c##logminer/password 1. æ„å»ºæ•°æ®å­—å…¸LogMinerä½¿ç”¨æ•°æ®å­—å…¸å°†å†…éƒ¨å¯¹è±¡æ ‡è¯†ç¬¦å’Œæ•°æ®ç±»å‹è½¬æ¢ä¸ºæ­£å¸¸å­—æ®µå’Œæ•°æ®æ ¼å¼ 12345# è¿™æ˜¯ä¸€æ¡å¸¸è§„çš„SQL INSERT INTO HR.JOBS(JOB_ID, JOB_TITLE, MIN_SALARY, MAX_SALARY) VALUES(&apos;IT_WT&apos;,&apos;Technical Writer&apos;, 4000, 11000);# å¦‚æœæ²¡æœ‰æ•°æ®å­—å…¸ï¼Œæ•°æ®ä¼šæ˜¯è¿™æ ·çš„insert into &quot;UNKNOWN&quot;.&quot;OBJ# 45522&quot;(&quot;COL 1&quot;,&quot;COL 2&quot;,&quot;COL 3&quot;,&quot;COL 4&quot;) values (HEXTORAW(&apos;45465f4748&apos;),HEXTORAW(&apos;546563686e6963616c20577269746572&apos;),HEXTORAW(&apos;c229&apos;),HEXTORAW(&apos;c3020b&apos;)); å®˜æ–¹æ–‡æ¡£ä¸­æåˆ°ä¸‰ç§æ–¹å¼ï¼š åœ¨çº¿æ•°æ®å­—å…¸ï¼šå½“ä½ å¯ä»¥è®¿é—®åˆ›å»ºRedoçš„æºæ•°æ®åº“å¹¶ä¸”è¡¨ç»“æ„ä¸ä¼šå‘ç”Ÿä»»ä½•å˜åŠ¨æ—¶ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨åœ¨çº¿æ•°æ®å­—å…¸ã€‚è¿™æ˜¯æœ€ç®€å•æœ‰æ•ˆçš„ï¼Œä¹Ÿæ˜¯Oracleçš„æ¨èé€‰é¡¹ç”±äºåœ¨çº¿æ•°æ®å­—å…¸æ°¸è¿œå­˜å‚¨çš„æ˜¯æœ€æ–°çš„ç»“æ„ã€‚å¦‚æœå‘ç”Ÿäº†è¡¨ç»“æ„å˜åŠ¨ï¼ŒLogminer æ•è·åˆ°æ—§ç‰ˆæœ¬çš„æ•°æ®ï¼ŒSQLå°†ä¼šå¦‚ä¸Šè¿°ä»£ç å—ä¸­é‚£æ · æå–æ•°æ®å­—å…¸åˆ°redoä¸­ï¼šéœ€è¦æ‰§è¡Œå‘½ä»¤BEGIN DBMS_LOGMNR_D.BUILD (options =&gt; DBMS_LOGMNR_D.STORE_IN_REDO_LOGS); END;è¯¥æ“ä½œä¼šå ç”¨ä¸€å®šæ•°æ®åº“èµ„æº æå–æ•°æ®å­—å…¸åˆ°Flat Fileï¼šOracleç»´æŠ¤è¯¥é€‰é¡¹æ˜¯ä¸ºäº†å…¼å®¹å†å²ç‰ˆæœ¬ï¼Œæœ¬æ–‡å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°è¯¥æ–¹å¼ï¼Œä¸å¤šåšä»‹ç» LogMiner åœ¨å¯åŠ¨æ—¶ä¼šé€šè¿‡æŒ‡å®šçš„æ•°æ®å­—å…¸é€‰é¡¹ç»´æŠ¤ä¸€ä¸ªå†…éƒ¨æ•°æ®å­—å…¸ï¼Œå½“å¯åŠ¨LogMineræ—¶æŒ‡å®š DBMS_LOGMNR.DDL_DICT_TRACKINGï¼ŒLogMinerä¼šè‡ªåŠ¨æ•è·DDLæ¥æ›´æ–°å†…éƒ¨å­—å…¸ï¼Œè¿™æ ·å³ä½¿å‘ç”Ÿäº†è¡¨ç»“æ„å˜åŠ¨æ—¶ï¼Œä¹Ÿå¯ä»¥æ­£ç¡®çš„è§£æDDLã€‚æ³¨æ„ï¼šè¯¥é€‰é¡¹ä¸èƒ½å’Œåœ¨çº¿æ•°æ®å­—å…¸åŒæ—¶ä½¿ç”¨æ›´å¤šè§£é‡Šå‚è€ƒOracleæ–‡æ¡£ï¼šhttps://docs.oracle.com/en/database/oracle/oracle-database/12.2/sutil/oracle-logminer-utility.html#GUID-56743517-A0C0-4CCD-9D20-2883AFB5683B è¿™ä¸€æ­¥æˆ‘é€‰æ‹©åœ¨çº¿æ•°æ®å­—å…¸ï¼Œä»€ä¹ˆéƒ½ä¸ç”¨åšï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥ 2. æ·»åŠ æ—¥å¿—æ–‡ä»¶12345678910111213141516171819# æŸ¥è¯¢ç›®å‰çš„redol ogSQL&gt; select member from v$logfile;MEMBER--------------------------------------------------------------------------------/opt/oracle/oradata/ORCLCDB/redo03.log/opt/oracle/oradata/ORCLCDB/redo02.log/opt/oracle/oradata/ORCLCDB/redo01.log# æ·»åŠ redo logSQL&gt; EXECUTE DBMS_LOGMNR.ADD_LOGFILE( - LOGFILENAME =&gt; &apos;/opt/oracle/oradata/ORCLCDB/redo03.log&apos;, - OPTIONS =&gt; DBMS_LOGMNR.NEW);EXECUTE DBMS_LOGMNR.ADD_LOGFILE( - LOGFILENAME =&gt; &apos;/opt/oracle/oradata/ORCLCDB/redo02.log&apos;, - OPTIONS =&gt; DBMS_LOGMNR.ADDFILE);EXECUTE DBMS_LOGMNR.ADD_LOGFILE( - LOGFILENAME =&gt; &apos;/opt/oracle/oradata/ORCLCDB/redo01.log&apos;, - OPTIONS =&gt; DBMS_LOGMNR.ADDFILE); 3. START_LOGMNR123# ä½¿ç”¨åœ¨çº¿æ•°æ®å­—å…¸è¿›è¡Œlogè§£æSQL&gt; EXECUTE DBMS_LOGMNR.START_LOGMNR(-OPTIONS =&gt; DBMS_LOGMNR.DICT_FROM_ONLINE_CATALOG); ç„¶åæ‰§è¡Œä¸€æ¡INSERT 4. æŸ¥è¯¢ç»“æœé€šè¿‡æŸ¥è¯¢V$LOGMNR_CONTENTS è·å–LogMineræ•è·çš„ç»“æœã€‚å½“æ‰§è¡Œè¯¥è§†å›¾æŸ¥è¯¢æ—¶ï¼ŒLogMinerä¼šæŒ‰ç…§é¡ºåºè§£æRedoå’ŒArchived Logï¼Œæ‰€æœ‰æ‰§è¡Œæ—¶é—´ä¼šæœ‰ä¸€ç‚¹æ…¢123SELECT OPERATION, SQL_REDO, SQL_UNDOFROM V$LOGMNR_CONTENTSWHERE table_name='TEST_TAB'; ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšåˆšINSERTçš„SQL å®æˆ˜æˆ‘ä»¬å·²ç»çŸ¥é“äº†è¿ç§»çš„æ€è·¯å’ŒLogminerå¦‚ä½•ä½¿ç”¨ï¼Œç°åœ¨å¯ä»¥åŠ¨æ‰‹æä¸€ä¸ªdemoäº†ã€‚ ç”±äºç¯‡å¹…é—®é¢˜ï¼Œè¿™é‡Œæˆ‘åªè®¨è®ºæ€è·¯å’Œæˆ‘çš„ä¸€äº›æƒ³æ³•ã€‚ å®Œæ•´ä»£ç å‚è€ƒğŸ‘‰ https://github.com/TavenYin/database-cdc/tree/master/oracle-logminer 1. æ•´ä½“æ€è·¯ç›¸å…³å®ç°æ€è·¯å‚è€ƒè‡ªDebezium éœ€è¦è§£é‡Šä¸€ä¸‹ç¬¬å››æ­¥ä¸ºä»€ä¹ˆï¼Œå‘ç”ŸRedoå‘ç”Ÿåˆ‡æ¢æ—¶ï¼Œéœ€è¦é‡å¯Logmineræµç¨‹ï¼Œä¸¤ç‚¹åŸå›  Redo Log åˆ‡æ¢åï¼Œä¼šç”Ÿæˆæ–°çš„å½’æ¡£ï¼Œæˆ‘ä»¬éœ€è¦Addæ–°çš„å½’æ¡£æ—¥å¿— é•¿æ—¶é—´å¼€å¯LogMinerä¼šè¯ï¼Œä¼šå¯¼è‡´PGAä½¿ç”¨é‡ä¸€ç›´ä¸Šå‡æ— æ³•é‡Šæ”¾ï¼ŒEnd LogMiner å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ‰€ä»¥ä»£ç é€»è¾‘ä¸­éœ€è¦æ‰¾ä¸€ä¸ªæ—¶æœºå»é‡å¯LogMinerï¼Œè€ŒRedo åˆ‡æ¢è¿™ä¸ªæ—¶é—´ç‚¹ç¡®å®ä¹ŸæŒºåˆé€‚çš„ã€‚ å†™åˆ°è¿™çš„æ—¶å€™ï¼Œæˆ‘çªç„¶æœ‰äº†ä¸€ä¸ªç–‘é—® æˆ‘ä»¬åˆšåˆšå·²ç»è¯´è¿‡äº†ï¼Œåªæœ‰åœ¨æŸ¥è¯¢ V$LOGMNR_CONTENTS æ—¶ï¼ŒLogMineræ‰ä¼šå»è§£æRedo Logï¼Œç„¶ååŠ¨æ€çš„ç”Ÿæˆè§†å›¾ã€‚ å‚è€ƒä¸Šå›¾ã€‚å¦‚æœåœ¨ç¬¬å››æ­¥å’Œç¬¬å…­æ­¥ä¹‹é—´ï¼Œç¨‹åºæ£€æŸ¥åˆ°æ²¡æœ‰RedoLogåˆ‡æ¢å‡†å¤‡ç»§ç»­æ‰§è¡Œã€‚çªç„¶æ’å…¥äº†å¤§é‡æ•°æ®å¯¼è‡´Current Redo Log è¢«è¦†ç›–ï¼ˆæ³¨æ„å¿…é¡»æ˜¯å·²ç»è¢«è¦†ç›–è€Œä¸æ˜¯åˆ‡æ¢ï¼‰äº†ï¼Œæ­¤æ—¶æ˜¯ä¸æ˜¯æˆ‘ä»¬å†æŸ¥è¯¢ V$LOGMNR_CONTENTS å²‚ä¸æ˜¯ä¼šä¸¢å¤±ä¸€éƒ¨åˆ†æ•°æ®ï¼Ÿ ç”±äºstart_logmineræ—¶ä¼šæŒ‡å®šï¼Œèµ·å§‹å’Œç»“æŸSCNï¼Œæ‰€ä»¥å³ä½¿ä¸‹æ¬¡æ‰§è¡Œæ—¶æ·»åŠ äº†æ–°çš„Archived Logï¼Œç”±äºSCNå·²ç»è¢«è·¨è¿‡å»äº†ï¼Œæ‰€ä»¥ä¸€å®šä¸ä¼šè¯»è¿™éƒ¨åˆ†æ•°æ® åœ¨æˆ‘åšäº†æµ‹è¯•ä¹‹åå‘ç°ï¼Œå¦‚æœæƒ…å†µçœŸçš„å¦‚æ­¤æç«¯ï¼Œç¡®å®ä¼šè¿™æ ·ã€‚ é‚£ä¹ˆDebeziumä¸ºä»€ä¹ˆæ²¡æœ‰è€ƒè™‘è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ ä¸ªäººç†è§£ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒé€šå¸¸Redo Log ä¸ä¼šé¢‘ç¹åˆ‡æ¢ï¼Œå¹¶ä¸”ä¸€å®šä¼šæœ‰å¤šä¸ªRedo Groupã€‚è¿™ä¹ˆçŸ­æ—¶é—´å†…è¢«è¦†ç›–çš„æƒ…å†µå‡ ä¹ä¸å¯èƒ½å‘ç”Ÿã€‚ 2. å¤„ç† V$LOGMNR_CONTENTS ç»“æœé›†æœ€å¼€å§‹åœ¨çœ‹Debeziumæºç çš„æ—¶å€™ï¼Œæ²¡ä»”ç»†æ³¨æ„è¿™ä¸ªåœ°æ–¹ï¼Œåœ¨è‡ªå·±åŠ¨æ‰‹æä¸€éä¹‹åï¼Œå‘ç°è¿™ä¸ªåœ°æ–¹çš„é€»è¾‘æœ‰ç‚¹éº»çƒ¦ V$LOGMNR_CONTENTS æ¯ä¸€è¡Œå¯èƒ½æ˜¯äº‹åŠ¡çš„æäº¤ã€å›æ»šï¼ŒDDLï¼ŒDML ä¸Šé¢æåˆ°äº†ä¸€ä¸ª TransactionalBufferæ˜¯ä»€ä¹ˆï¼Ÿ æˆ‘ä»¬åœ¨è¯»å– V$LOGMNR_CONTENTS ä¼šå‘ç”Ÿå¦‚ä¸‹å›¾çš„æƒ…å†µï¼Œå› ä¸ºæ¯æ¬¡åªä»startScn è¯»å–åˆ° å½“å‰Scnã€‚è€Œè¿™ä¸­é—´å¯èƒ½å‘ç”Ÿçš„æƒ…å†µæ˜¯ï¼Œäº‹åŠ¡å¹¶æ²¡æœ‰Commitï¼Œä½†æ˜¯æˆ‘ä»¬æ‹¿åˆ°äº†å…¶ä¸­ä¸€éƒ¨åˆ†çš„DMLï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç¡®å®šè¿™äº›DMLæ˜¯ä¸æ˜¯è¦Commitï¼Œæ‰€ä»¥éœ€è¦å°†è¿™äº›â€œä¸€åŠâ€çš„äº‹åŠ¡æš‚æ—¶ç¼“å­˜åœ¨å†…å­˜ä¸­ å…¶å®åœ¨è°ƒç”¨ DBMS_LOGMNR.START_LOGMNR æ—¶ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªé€‰é¡¹ COMMITTED_DATA_ONLYï¼Œä»…è¯»å‡ºå·²æäº¤çš„äº‹åŠ¡ã€‚è¿™æ ·å°±ä¸å¿…è¦è¿™ä¹ˆéº»çƒ¦çš„å¤„ç†ç»“æœé›†äº†ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆä¸é€‰æ‹© COMMITTED_DATA_ONLYï¼Ÿä½¿ç”¨è¯¥ç­–ç•¥ä¼šä¸€ç›´ç­‰å¾…äº‹åŠ¡æäº¤æ‰ä¼šå“åº”å®¢æˆ·ç«¯ï¼Œè¿™å¾ˆå®¹æ˜“é€ æˆ â€œOut of Memoryâ€ï¼Œæ‰€ä»¥è¿™ä¸ªç­–ç•¥ä¸é€‚åˆæˆ‘ä»¬çš„ç¨‹åºã€‚ 3. è¿ç§»è¿›ç¨‹å®•æœºå¤„ç†æ•°æ®è¿ç§»å¿…å®šæ˜¯ä¸€ä¸ªæ¼«é•¿çš„è¿‡ç¨‹ï¼Œå¦‚æœåœ¨æ‰§è¡Œä¸­é‡åˆ°ä»€ä¹ˆæ„å¤–ï¼Œå¯¼è‡´Javaè¿›ç¨‹æŒ‚äº†ï¼Œé‚£ä¹ˆä¸€åˆ‡éƒ½è¦ä»å¤´å¼€å§‹å—ï¼Ÿ å¦‚æœæˆ‘ä»¬èƒ½ç¡®å®šæŸä¸ªSCNä¹‹å‰çš„æ‰€æœ‰è®°å½•éƒ½å·²ç»è¢«å¤„ç†äº†ï¼Œé‚£ä¹ˆä¸‹æ¬¡é‡å¯æ—¶ä»è¿™ä¸ªSCNå¼€å§‹å¤„ç†å³å¯ ä¸¤å¤„å¯ä»¥ç¡®å®šä¹‹å‰SCNå·²ç»è¢«å…¨éƒ¨å¤„ç†çš„åœ°æ–¹ï¼Œä»£ç å¦‚ä¸‹ï¼š a. å½“å‰TransactionalBufferä¸­æ²¡æœ‰æ•°æ®ï¼Œä»£è¡¨END_SCNä¹‹å‰æ‰€æœ‰çš„äº‹åŠ¡éƒ½å·²ç»è¢«æäº¤äº† b. æäº¤äº‹åŠ¡æ—¶ï¼Œå¦‚æœå½“å‰è¦æäº¤çš„äº‹åŠ¡çš„Start_SCN æ—©äºTransactionalBufferä¸­çš„æ‰€æœ‰äº‹åŠ¡ 4. SQLè§£æå¦‚æœä½ æƒ³å°†Oracleçš„æ•°æ®åŒæ­¥åˆ°å…¶ä»–æ•°æ®åº“ï¼ˆåŒ…å«NoSQLï¼‰çš„è¯ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å°†SQLè§£ææˆç»“æ„åŒ–çš„å¯¹è±¡ï¼Œè®©ä¸‹æ¸¸æœåŠ¡å»æ¶ˆè´¹è¿™äº›å¯¹è±¡ã€‚ Debeziumçš„åšæ³•ï¼Œæˆ‘è¿˜æ²¡æŠ½å‡ºç©ºç ”ç©¶ã€‚ç›®å‰çš„è§£å†³æ–¹æ³•æ˜¯ç”¨com.alibaba.druid.sql.SQLUtilsï¼Œè¿™ä¸ªç±»å¯ä»¥å°†SQLè§£ææˆç»“æ„åŒ–å¯¹è±¡ï¼Œæˆ‘ä»¬å†å¯¹è¿™äº›å¯¹è±¡è¿›è¡Œä¸€äº›å¤„ç†ï¼Œå³å¯è®©ä¸‹æ¸¸æœåŠ¡æ¶ˆè´¹äº†ã€‚ DEMOè¿è¡Œæ•ˆæœå¦‚ä¸‹ GitHub ğŸ‘‰ https://github.com/TavenYin/database-cdc/tree/master/oracle-logminer å‚è€ƒ Oracle Redo : https://docs.oracle.com/cd/B28359_01/server.111/b28310/onlineredo001.htm Oracle Archived : https://docs.oracle.com/cd/B28359_01/server.111/b28310/archredo001.htm Oracle Flashback : https://docs.oracle.com/cd/E11882_01/appdev.112/e41502/adfns_flashback.htm LogMiner : https://docs.oracle.com/en/database/oracle/oracle-database/12.2/sutil/oracle-logminer-utility.html Debezium Oracle Connector : https://debezium.io/documentation/reference/connectors/oracle.html]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>LogMiner</tag>
        <tag>æ•°æ®åº“è¿ç§»æŠ€æœ¯</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Kafka Connect-å…¥é—¨]]></title>
    <url>%2Fpost%2F7ec53704.html</url>
    <content type="text"><![CDATA[å‰æé¦–å…ˆä½ éœ€è¦äº†è§£MQ / Kafkaç›¸å…³çš„çŸ¥è¯† æœ¬æ–‡ç›®æ ‡äº†è§£ Kafka Connect åŸºæœ¬æ¦‚å¿µä¸åŠŸèƒ½ ä»€ä¹ˆæ˜¯Kafka Connect Kafka Connect æ˜¯ä¸€æ¬¾å¯æ‰©å±•å¹¶ä¸”å¯é åœ°åœ¨ Apache Kafka å’Œå…¶ä»–ç³»ç»Ÿä¹‹é—´è¿›è¡Œæ•°æ®ä¼ è¾“çš„å·¥å…·ã€‚ å¯ä»¥å¾ˆç®€å•çš„å®šä¹‰ connectorsï¼ˆè¿æ¥å™¨ï¼‰ å°†å¤§é‡æ•°æ®è¿å…¥ã€è¿å‡ºKafkaã€‚ ä¾‹å¦‚æˆ‘ç°åœ¨æƒ³è¦æŠŠæ•°æ®ä»MySQLè¿ç§»åˆ°ElasticSearchï¼Œä¸ºäº†ä¿è¯é«˜æ•ˆå’Œæ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œæˆ‘ä»¬é€‰æ‹©MQä½œä¸ºä¸­é—´ä»¶ä¿å­˜æ•°æ®ã€‚è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹ï¼Œä¸æ–­çš„ä»MySQLä¸­è¯»å–æ•°æ®å¹¶å‘é€åˆ°MQï¼Œè¿˜éœ€è¦ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹æ¶ˆè´¹MQçš„æ•°æ®å†™åˆ°ElasticSearchï¼Œè¿™ä»¶äº‹æƒ…ä¼¼ä¹å¾ˆç®€å•ï¼Œä¸éœ€è¦ä»»ä½•æ¡†æ¶ã€‚ ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³è¦ä¿è¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æœåŠ¡çš„é«˜å¯ç”¨æ€§ï¼Œä¾‹å¦‚é‡å¯åç”Ÿäº§è€…æ¢å¤åˆ°ä¹‹å‰è¯»å–çš„ä½ç½®ï¼Œåˆ†å¸ƒå¼éƒ¨ç½²å¹¶ä¸”èŠ‚ç‚¹å®•æœºåå°†ä»»åŠ¡è½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚å¦‚æœè¦åŠ ä¸Šè¿™äº›çš„è¯ï¼Œè¿™ä»¶äº‹å°±å˜å¾—å¤æ‚èµ·æ¥äº†ï¼Œè€ŒKafka Connect å·²ç»ä¸ºæˆ‘ä»¬é€ å¥½è¿™äº›è½®å­ã€‚ Kafka Connect å¦‚ä½•å·¥ä½œï¼Ÿ Kafka Connect ç‰¹æ€§å¦‚ä¸‹ï¼š Kafka è¿æ¥å™¨çš„é€šç”¨æ¡†æ¶ï¼šKafka Connect æ ‡å‡†åŒ–äº†å…¶ä»–æ•°æ®ç³»ç»Ÿä¸Kafkaçš„é›†æˆï¼Œä»è€Œç®€åŒ–äº†è¿æ¥å™¨çš„å¼€å‘ï¼Œéƒ¨ç½²å’Œç®¡ç† æ”¯æŒåˆ†å¸ƒå¼æ¨¡å¼å’Œå•æœºæ¨¡å¼éƒ¨ç½² Rest APIï¼šé€šè¿‡ç®€å•çš„Rest APIç®¡ç†è¿æ¥å™¨ åç§»é‡ç®¡ç†ï¼šé’ˆå¯¹Sourceå’ŒSinkéƒ½æœ‰ç›¸åº”çš„åç§»é‡ï¼ˆOffsetï¼‰ç®¡ç†æ–¹æ¡ˆï¼Œç¨‹åºå‘˜æ— é¡»å…³å¿ƒOffset çš„æäº¤ åˆ†å¸ƒå¼æ¨¡å¼å¯æ‰©å±•çš„ï¼Œæ”¯æŒæ•…éšœè½¬ç§» Kafka Connect Conceptsè¿™é‡Œç®€å•ä»‹ç»ä¸‹Kafka Connect çš„æ¦‚å¿µä¸ç»„æˆæ›´å¤šç»†èŠ‚è¯·å‚è€ƒ ğŸ‘‰ https://docs.confluent.io/platform/current/connect/concepts.html Connectorsè¿æ¥å™¨ï¼Œåˆ†ä¸ºä¸¤ç§ Sourceï¼ˆä»æºæ•°æ®åº“æ‹‰å–æ•°æ®å†™å…¥Kafkaï¼‰ï¼ŒSinkï¼ˆä»Kafkaæ¶ˆè´¹æ•°æ®å†™å…¥ç›®æ ‡æ•°æ®ï¼‰ è¿æ¥å™¨å…¶å®å¹¶ä¸å‚ä¸å®é™…çš„æ•°æ®copyï¼Œè¿æ¥å™¨è´Ÿè´£ç®¡ç†Taskã€‚è¿æ¥å™¨ä¸­å®šä¹‰äº†å¯¹åº”Taskçš„ç±»å‹ï¼Œå¯¹å¤–æä¾›é…ç½®é€‰é¡¹ï¼ˆç”¨æˆ·åˆ›å»ºè¿æ¥å™¨æ—¶éœ€è¦æä¾›å¯¹åº”çš„é…ç½®ä¿¡æ¯ï¼‰ã€‚å¹¶ä¸”è¿æ¥å™¨è¿˜å¯ä»¥å†³å®šå¯åŠ¨å¤šå°‘ä¸ªTaskçº¿ç¨‹ã€‚ ç”¨æˆ·å¯ä»¥é€šè¿‡Rest API å¯åœè¿æ¥å™¨ï¼ŒæŸ¥çœ‹è¿æ¥å™¨çŠ¶æ€ Confluent å·²ç»æä¾›äº†è®¸å¤šæˆç†Ÿçš„è¿æ¥å™¨ï¼Œä¼ é€é—¨ğŸ‘‰ https://www.confluent.io/product/connectors/ Taskå®é™…è¿›è¡Œæ•°æ®ä¼ è¾“çš„å•å…ƒï¼Œå’Œè¿æ¥å™¨ä¸€æ ·åŒæ ·åˆ†ä¸º Sourceå’ŒSink Taskçš„é…ç½®å’ŒçŠ¶æ€å­˜å‚¨åœ¨Kafkaçš„Topicä¸­ï¼Œconfig.storage.topicå’Œstatus.storage.topicã€‚æˆ‘ä»¬å¯ä»¥éšæ—¶å¯åŠ¨ï¼Œåœæ­¢ä»»åŠ¡ï¼Œä»¥æä¾›å¼¹æ€§ã€å¯æ‰©å±•çš„æ•°æ®ç®¡é“ Workeråˆšåˆšæˆ‘ä»¬è®²çš„Connectors å’ŒTask å±äºé€»è¾‘å•å…ƒï¼Œè€ŒWorker æ˜¯å®é™…è¿è¡Œé€»è¾‘å•å…ƒçš„è¿›ç¨‹ï¼ŒWorker åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼Œå•æœºæ¨¡å¼å’Œåˆ†å¸ƒå¼æ¨¡å¼ å•æœºæ¨¡å¼ï¼šæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯åŠŸèƒ½ä¹Ÿå—é™ï¼Œåªæœ‰ä¸€äº›ç‰¹æ®Šçš„åœºæ™¯ä¼šä½¿ç”¨åˆ°ï¼Œä¾‹å¦‚æ”¶é›†ä¸»æœºçš„æ—¥å¿—ï¼Œé€šå¸¸æ¥è¯´æ›´å¤šçš„æ˜¯ä½¿ç”¨åˆ†å¸ƒå¼æ¨¡å¼ åˆ†å¸ƒå¼æ¨¡å¼ï¼šä¸ºKafka Connectæä¾›äº†å¯æ‰©å±•å’Œæ•…éšœè½¬ç§»ã€‚ç›¸åŒgroup.idçš„Workerï¼Œä¼šè‡ªåŠ¨ç»„æˆé›†ç¾¤ã€‚å½“æ–°å¢Workerï¼Œæˆ–è€…æœ‰WorkeræŒ‚æ‰æ—¶ï¼Œé›†ç¾¤ä¼šè‡ªåŠ¨åè°ƒåˆ†é…æ‰€æœ‰çš„Connector å’Œ Taskï¼ˆè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºRebalanceï¼‰ å½“ä½¿ç”¨Workeré›†ç¾¤æ—¶ï¼Œåˆ›å»ºè¿æ¥å™¨ï¼Œæˆ–è€…è¿æ¥å™¨Taskæ•°é‡å˜åŠ¨æ—¶ï¼Œéƒ½ä¼šè§¦å‘Rebalance ä»¥ä¿è¯é›†ç¾¤å„ä¸ªWorkerèŠ‚ç‚¹è´Ÿè½½å‡è¡¡ã€‚ä½†æ˜¯å½“Task è¿›å…¥FailçŠ¶æ€çš„æ—¶å€™å¹¶ä¸ä¼šè§¦å‘ Rebalanceï¼Œåªèƒ½é€šè¿‡Rest Api å¯¹Taskè¿›è¡Œé‡å¯ ConvertersKafka Connect é€šè¿‡ Converter å°†æ•°æ®åœ¨Kafkaï¼ˆå­—èŠ‚æ•°ç»„ï¼‰ä¸Taskï¼ˆObjectï¼‰ä¹‹é—´è¿›è¡Œè½¬æ¢ é»˜è®¤æ”¯æŒä»¥ä¸‹Converter AvroConverter io.confluent.connect.avro.AvroConverter: éœ€è¦ä½¿ç”¨ Schema Registry ProtobufConverter io.confluent.connect.protobuf.ProtobufConverter: éœ€è¦ä½¿ç”¨ Schema Registry JsonSchemaConverter io.confluent.connect.json.JsonSchemaConverter: éœ€è¦ä½¿ç”¨ Schema Registry JsonConverter org.apache.kafka.connect.json.JsonConverter (æ— éœ€ Schema Registry): è½¬æ¢ä¸ºjsonç»“æ„ StringConverter org.apache.kafka.connect.storage.StringConverter: ç®€å•çš„å­—ç¬¦ä¸²æ ¼å¼ ByteArrayConverter org.apache.kafka.connect.converters.ByteArrayConverter: ä¸åšä»»ä½•è½¬æ¢ Converters ä¸ Connector æ˜¯è§£è€¦çš„ï¼Œä¸‹å›¾å±•ç¤ºäº†åœ¨Kafka Connectä¸­ï¼ŒConverter åœ¨ä½•æ—¶è¿›è¡Œæ•°æ®è½¬æ¢ Transformsè¿æ¥å™¨å¯ä»¥é€šè¿‡é…ç½®Transform å®ç°å¯¹å•ä¸ªæ¶ˆæ¯ï¼ˆå¯¹åº”ä»£ç ä¸­çš„Recordï¼‰çš„è½¬æ¢å’Œä¿®æ”¹ï¼Œå¯ä»¥é…ç½®å¤šä¸ªTransform ç»„æˆä¸€ä¸ªé“¾ã€‚ä¾‹å¦‚è®©æ‰€æœ‰æ¶ˆæ¯çš„topicåŠ ä¸€ä¸ªå‰ç¼€ã€sinkæ— æ³•æ¶ˆè´¹source å†™å…¥çš„æ•°æ®æ ¼å¼ï¼Œè¿™äº›åœºæ™¯éƒ½å¯ä»¥ä½¿ç”¨Transform è§£å†³ Transform å¦‚æœé…ç½®åœ¨Source åˆ™åœ¨Taskä¹‹åæ‰§è¡Œï¼Œå¦‚æœé…ç½®åœ¨Sink åˆ™åœ¨Taskä¹‹å‰æ‰§è¡Œ Dead Letter Queueä¸å…¶ä»–MQä¸åŒï¼ŒKafka å¹¶æ²¡æœ‰æ­»ä¿¡é˜Ÿåˆ—è¿™ä¸ªåŠŸèƒ½ã€‚ä½†æ˜¯Kafka Connectæä¾›äº†è¿™ä¸€åŠŸèƒ½ã€‚ å½“Sink Taské‡åˆ°æ— æ³•å¤„ç†çš„æ¶ˆæ¯ï¼Œä¼šæ ¹æ®errors.toleranceé…ç½®é¡¹å†³å®šå¦‚ä½•å¤„ç†ï¼Œé»˜è®¤æƒ…å†µä¸‹(errors.tolerance=none) Sink é‡åˆ°æ— æ³•å¤„ç†çš„è®°å½•ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼ŒTaskè¿›å…¥Fail çŠ¶æ€ã€‚å¼€å‘äººå‘˜éœ€è¦æ ¹æ®Workerçš„é”™è¯¯æ—¥å¿—è§£å†³é—®é¢˜ï¼Œç„¶åé‡å¯Taskï¼Œæ‰èƒ½ç»§ç»­æ¶ˆè´¹æ•°æ® è®¾ç½® errors.tolerance=allï¼ŒSink Task ä¼šå¿½ç•¥æ‰€æœ‰çš„é”™è¯¯ï¼Œç»§ç»­å¤„ç†ã€‚Workerä¸­ä¸ä¼šæœ‰ä»»ä½•é”™è¯¯æ—¥å¿—ã€‚å¯ä»¥é€šè¿‡é…ç½®errors.deadletterqueue.topic.name = &lt;dead-letter-topic-name&gt; è®©æ— æ³•å¤„ç†çš„æ¶ˆæ¯è·¯ç”±åˆ° Dead Letter Topic å¿«é€Ÿä¸Šæ‰‹ä¸‹é¢æˆ‘æ¥å®æˆ˜ä¸€ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨Kafka Connectï¼Œæˆ‘ä»¬å…ˆå®šä¸€ä¸ªå°ç›®æ ‡ å°†MySQLä¸­çš„å…¨é‡æ•°æ®åŒæ­¥åˆ°Redis æ–°å»ºæ–‡ä»¶ docker-compose.yaml123456789101112131415161718192021version: &apos;3.7&apos;services: zookeeper: image: wurstmeister/zookeeper container_name: zk ports: - 2182:2181 kafka: image: wurstmeister/kafka:2.13-2.7.0 container_name: kafka ports: - 9092:9092 environment: KAFKA_BROKER_ID: 0 # å®¿ä¸»æœºip KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://192.168.3.21:9092 KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092 depends_on: - zookeeper åœ¨ç»ˆç«¯ä¸Šæ‰§è¡Œ docker-compose -f docker-compose.yaml up -d å¯åŠ¨dockerå®¹å™¨ å‡†å¤‡è¿æ¥å™¨ï¼Œè¿™é‡Œæˆ‘æ˜¯è‡ªå·±å†™äº†ä¸€ä¸ªç®€å•çš„è¿æ¥å™¨ğŸ˜„ã€‚ä¸‹è½½åœ°å€ï¼šhttps://github.com/TavenYin/kafka-connect-example/blob/master/release/kafka-connector-example-bin.jar 12# å°†è¿æ¥å™¨ä¸Šä¼ åˆ°kafka å®¹å™¨ä¸­docker cp kafka-connector-example-bin.jar kafka:/opt/connectors ä¿®æ”¹é…ç½®å¹¶å¯åŠ¨Worker 12345#åœ¨é…ç½®æ–‡ä»¶æœ«å°¾è¿½åŠ  plugin.path=/opt/connectorsvi /opt/kafka/config/connect-distributed.properties# å¯åŠ¨Workerbin/connect-distributed.sh -daemon config/connect-distributed.properties å‡†å¤‡MySQL ç”±äºæˆ‘å®¿ä¸»æœºé‡Œå·²ç»å®‰è£…äº†MySQLï¼Œæˆ‘å°±ç›´æ¥ä½¿ç”¨äº†ï¼Œä½¿ç”¨å¦‚ä¸‹Sqlåˆ›å»ºè¡¨ã€‚åˆ›å»ºä¹‹åéšä¾¿é€ å‡ æ¡æ•°æ®12345CREATE TABLE `test_user` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `name` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`)) ; åˆ›å»ºè¿æ¥å™¨ æ–°å»º source.json1234567891011&#123; &quot;name&quot; : &quot;example-source&quot;, &quot;config&quot; : &#123; &quot;connector.class&quot; : &quot;com.github.taven.source.ExampleSourceConnector&quot;, &quot;tasks.max&quot; : &quot;1&quot;, &quot;database.url&quot; : &quot;jdbc:mysql://192.168.3.21:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;useSSL=false&amp;zeroDateTimeBehavior=convertToNull&amp;serverTimezone=UTC&amp;rewriteBatchedStatements=true&quot;, &quot;database.username&quot; : &quot;root&quot;, &quot;database.password&quot; : &quot;root&quot;, &quot;database.tables&quot; : &quot;test_user&quot; &#125;&#125; å‘Worker å‘é€è¯·æ±‚ï¼Œåˆ›å»ºè¿æ¥å™¨curl -i -X POST -H &quot;Accept:application/json&quot; -H &quot;Content-Type:application/json&quot; http://localhost:8083/connectors/ -d @source.json source.json ä¸­ï¼Œæœ‰ä¸€äº›å±æ€§æ˜¯Kafka Connect æä¾›çš„ï¼Œä¾‹å¦‚ä¸Šè¿°æ–‡ä»¶ä¸­ name, connector.class, tasks.maxï¼Œå‰©ä¸‹çš„å±æ€§å¯ä»¥åœ¨å¼€å‘Connector æ—¶è‡ªå®šä¹‰ã€‚å…³äºKafka Connect Configuration ç›¸å…³è¯·é˜…è¯»è¿™é‡Œ ğŸ‘‰ https://docs.confluent.io/platform/current/installation/configuration/connect/index.html ç¡®è®¤æ•°æ®æ˜¯å¦å†™å…¥Kafka é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹Workerä¸­çš„è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœTaskçš„state = RUNNINGï¼Œä»£è¡¨Taskæ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼Œå¹³ç¨³è¿è¡Œ123bash-4.4# curl -X GET localhost:8083/connectors/example-source/status&#123;&quot;name&quot;:&quot;example-source&quot;,&quot;connector&quot;:&#123;&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;,&quot;tasks&quot;:[&#123;&quot;id&quot;:0,&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;],&quot;type&quot;:&quot;source&quot;&#125; æŸ¥çœ‹kafka ä¸­Topic æ˜¯å¦åˆ›å»º123456bash-4.4# bin/kafka-topics.sh --list --zookeeper zookeeper:2181__consumer_offsetsconnect-configsconnect-offsetsconnect-statustest_user è¿™äº›Topic éƒ½å­˜å‚¨äº†ä»€ä¹ˆï¼Ÿ __consumer_offsets: è®°å½•æ‰€æœ‰Kafka Consumer Groupçš„Offset connect-configs: å­˜å‚¨è¿æ¥å™¨çš„é…ç½®ï¼Œå¯¹åº”Connect é…ç½®æ–‡ä»¶ä¸­config.storage.topic connect-offsets: å­˜å‚¨Source çš„Offsetï¼Œå¯¹åº”Connect é…ç½®æ–‡ä»¶ä¸­offset.storage.topic connect-status: è¿æ¥å™¨ä¸Taskçš„çŠ¶æ€ï¼Œå¯¹åº”Connect é…ç½®æ–‡ä»¶ä¸­status.storage.topic æŸ¥çœ‹topicä¸­æ•°æ®ï¼Œæ­¤æ—¶è¯´æ˜MySQLæ•°æ®å·²ç»æˆåŠŸå†™å…¥Kafka1234bash-4.4# bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test_user --from-beginning&#123;&quot;schema&quot;:&#123;&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[&#123;&quot;type&quot;:&quot;int64&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;id&quot;&#125;,&#123;&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;name&quot;&#125;],&quot;optional&quot;:false,&quot;name&quot;:&quot;test_user&quot;&#125;,&quot;payload&quot;:&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;yyyyyy&quot;&#125;&#125;&#123;&quot;schema&quot;:&#123;&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[&#123;&quot;type&quot;:&quot;int64&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;id&quot;&#125;,&#123;&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;name&quot;&#125;],&quot;optional&quot;:false,&quot;name&quot;:&quot;test_user&quot;&#125;,&quot;payload&quot;:&#123;&quot;id&quot;:2,&quot;name&quot;:&quot;qqqq&quot;&#125;&#125;&#123;&quot;schema&quot;:&#123;&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[&#123;&quot;type&quot;:&quot;int64&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;id&quot;&#125;,&#123;&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;name&quot;&#125;],&quot;optional&quot;:false,&quot;name&quot;:&quot;test_user&quot;&#125;,&quot;payload&quot;:&#123;&quot;id&quot;:3,&quot;name&quot;:&quot;eeee&quot;&#125;&#125; æ•°æ®ç»“æ„ä¸ºJsonï¼Œå¯ä»¥å›é¡¾ä¸€ä¸‹ä¸Šé¢æˆ‘ä»¬ä¿®æ”¹çš„connect-distributed.propertiesï¼Œé»˜è®¤æä¾›çš„Converter ä¸ºJsonConverterï¼Œæ‰€æœ‰çš„æ•°æ®åŒ…å«schema å’Œ payload ä¸¤é¡¹æ˜¯å› ä¸ºé…ç½®æ–‡ä»¶ä¸­é»˜è®¤å¯åŠ¨äº†key.converter.schemas.enable=trueå’Œvalue.converter.schemas.enable=trueä¸¤ä¸ªé€‰é¡¹ å¯åŠ¨ Sink æ–°å»ºsink.json123456789101112&#123; &quot;name&quot; : &quot;example-sink&quot;, &quot;config&quot; : &#123; &quot;connector.class&quot; : &quot;com.github.taven.sink.ExampleSinkConnector&quot;, &quot;topics&quot; : &quot;test_user, test_order&quot;, &quot;tasks.max&quot; : &quot;1&quot;, &quot;redis.host&quot; : &quot;192.168.3.21&quot;, &quot;redis.port&quot; : &quot;6379&quot;, &quot;redis.password&quot; : &quot;&quot;, &quot;redis.database&quot; : &quot;0&quot; &#125;&#125; åˆ›å»ºSink Connectorcurl -i -X POST -H &quot;Accept:application/json&quot; -H &quot;Content-Type:application/json&quot; http://localhost:8083/connectors/ -d @sink.json ç„¶åæŸ¥çœ‹Sink Connector Statusï¼Œè¿™é‡Œæˆ‘å‘ç°ç”±äºæˆ‘çš„Redisç«¯å£åªå¯¹localhostå¼€å‘ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘çš„Task Failäº†ï¼Œä¿®æ”¹äº†Redisé…ç½®ä¹‹åï¼Œé‡å¯Task curl -X POST localhost:8083/connectors/example-sink/tasks/0/restart åœ¨ç¡®è®¤äº†Sink Status ä¸ºRUNNING åï¼Œå¯ä»¥ç¡®è®¤ä¸‹Redisä¸­æ˜¯å¦æœ‰æ•°æ® å…³äºKafka Connect Rest api æ–‡æ¡£ï¼Œè¯·å‚è€ƒğŸ‘‰https://docs.confluent.io/platform/current/connect/references/restapi.html å¦‚ä½•æŸ¥çœ‹Sink Offsetæ¶ˆè´¹æƒ…å†µ ä½¿ç”¨å‘½ä»¤bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group connect-example-sink ä¸‹å›¾ä»£è¡¨ test_user topic ä¸‰æ¡æ•°æ®å·²ç»å…¨éƒ¨æ¶ˆè´¹ Kafka Connect é«˜çº§åŠŸèƒ½æˆ‘ä»¬çš„å°ç›®æ ‡å·²ç»è¾¾æˆäº†ã€‚ç°åœ¨ä¸¤ä¸ªTaskæ— äº‹å¯åšï¼Œæ­£å¥½å€Ÿæ­¤æœºä¼šæˆ‘ä»¬æ¥ä½“éªŒä¸€ä¸‹å¯æ‰©å±•å’Œæ•…éšœè½¬ç§» é›†ç¾¤æ‰©å±•æˆ‘å¯åŠ¨äº†å¼€å‘ç¯å¢ƒä¸­çš„Kafka Connect Workerï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£æ‰€ç¤ºé€šè¿‡æ³¨å†ŒåŒä¸€ä¸ªKafka å¹¶ä¸”ä½¿ç”¨ç›¸åŒçš„ group.id=connect-cluster å¯ä»¥è‡ªåŠ¨ç»„æˆé›†ç¾¤ å¯åŠ¨æˆ‘å¼€å‘ç¯å¢ƒä¸­çš„Kafka Connectï¼Œä¹‹åæ£€æŸ¥ä¸¤ä¸ªè¿æ¥å™¨çŠ¶æ€ 12345bash-4.4# curl -X GET localhost:8083/connectors/example-source/status&#123;&quot;name&quot;:&quot;example-source&quot;,&quot;connector&quot;:&#123;&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.23.176.1:8083&quot;&#125;,&quot;tasks&quot;:[&#123;&quot;id&quot;:0,&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.23.176.1:8083&quot;&#125;],&quot;type&quot;:&quot;source&quot;&#125;bash-4.4#bash-4.4# curl -X GET localhost:8083/connectors/example-sink/status&#123;&quot;name&quot;:&quot;example-sink&quot;,&quot;connector&quot;:&#123;&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;,&quot;tasks&quot;:[&#123;&quot;id&quot;:0,&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;],&quot;type&quot;:&quot;sink&quot;&#125; è§‚å¯Ÿworker_id å¯ä»¥å‘ç°ï¼Œä¸¤ä¸ªConnectors å·²ç»åˆ†åˆ«è¿è¡Œåœ¨ä¸¤ä¸ªWorkerä¸Šäº† æ•…éšœè½¬ç§»æ­¤æ—¶æˆ‘ä»¬é€šè¿‡kill pidç»“æŸdockerä¸­çš„Workerè¿›ç¨‹è§‚å¯Ÿæ˜¯å¦å®•æœºä¹‹åè‡ªåŠ¨è½¬ç§»ï¼Œä½†æ˜¯å‘ç°Taskå¹¶æ²¡æœ‰è½¬ç§»åˆ°ä»…å­˜çš„Workerä¸­ï¼ŒTask çŠ¶æ€å˜ä¸ºUNASSIGNEDï¼Œè¿™æ˜¯ä¸ºå•¥å‘¢ï¼Ÿéš¾é“æ˜¯æœ‰ä»€ä¹ˆæ“ä½œé”™äº†ï¼Ÿ åœ¨ç½‘ä¸ŠæŸ¥é˜…äº†ä¸€ç•ªå¾—çŸ¥ï¼ŒKafka Connect çš„é›†ç¾¤æ‰©å±•ä¸æ•…éšœè½¬ç§»æœºåˆ¶æ˜¯é€šè¿‡Kafka Rebalance åè®®å®ç°çš„ï¼ˆConsumerä¹Ÿæ˜¯è¯¥åè®®ï¼‰ï¼Œå½“WorkerèŠ‚ç‚¹å®•æœºæ—¶é—´è¶…è¿‡ scheduled.rebalance.max.delay.ms æ—¶ï¼ŒKafkaæ‰ä¼šå°†å…¶è¸¢å‡ºé›†ç¾¤ã€‚è¸¢å‡ºåå°†è¯¥èŠ‚ç‚¹çš„è¿æ¥å™¨å’Œä»»åŠ¡åˆ†é…ç»™å…¶ä»–Workerï¼Œscheduled.rebalance.max.delay.msé»˜è®¤å€¼ä¸ºäº”åˆ†é’Ÿã€‚ åæ¥ç»æµ‹è¯•å‘ç°ï¼Œäº”åˆ†é’Ÿä¹‹åæŸ¥çœ‹è¿æ¥å™¨ä¿¡æ¯ï¼Œå·²ç»è½¬ç§»åˆ°å­˜æ´»çš„WorkerèŠ‚ç‚¹äº† æœ¬æ¥è¿˜è®¡åˆ’å†™ä¸€ä¸‹å¦‚ä½•å¼€å‘è¿æ¥å™¨å’ŒKafka Rebalanceï¼Œä½†æ˜¯è¿™ç¯‡å·²ç»å¤Ÿé•¿äº†ï¼Œæ‰€ä»¥è®¡åˆ’åç»­æ›´æ–°è¿™ä¸¤ç¯‡æ–‡ç« ]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
        <tag>Kafka Connect</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é—®é¢˜åˆ†æï¼šKafka Connect å¼•å…¥äº†Fastjsonåï¼ŒRest APIå“åº”ä¸º{}]]></title>
    <url>%2Fpost%2F11f7961b.html</url>
    <content type="text"><![CDATA[å‰è¨€æœ€è¿‘åœ¨å­¦ä¹ Kafka Connectï¼Œå†™äº†ä¸ªè¿æ¥å™¨çš„demoã€‚åœ¨demoæäº¤äº†å‡ ä¸ªç‰ˆæœ¬ä¹‹åï¼Œçªç„¶å‘ç°Kafka Connect Rest API æ— æ³•æ­£å¸¸å“åº”äº†ï¼Œæ˜æ˜æœ‰æ­£åœ¨è¿è¡Œçš„è¿æ¥å™¨ï¼ŒæŸ¥è¯¢statusï¼Œå±…ç„¶è¿”å›{} é—®é¢˜åˆ†æå¯¹ Rest API è¿›è¡Œdebugåï¼Œç¡®è®¤æ˜¯æœ‰æ•°æ®çš„ï¼Œä½†æ˜¯æ•°æ®è¿”å›ä¸åˆ°å®¢æˆ·ç«¯ï¼Œå¾ˆå¥‡æ€ªã€‚å› ä¸ºæˆ‘è®°å¾—ä¹‹å‰æ˜¯å¥½ç”¨çš„ï¼Œæ‰€ä»¥æˆ‘å›æ»šäº†ä»£ç ç‰ˆæœ¬ï¼Œé€ä¸€æ’æŸ¥ä¹‹åå‘ç°å½“å¼•å…¥Fastjson ä¾èµ–ä¹‹åï¼Œä¼šå¯¼è‡´Connect Rest API ä¸å¯ç”¨ å¦‚æœæ‡’ä¸€ç‚¹çš„è¯ï¼Œåˆ°è¿™é‡Œå°±å·²ç»ç»“æŸäº†ï¼Œç›´æ¥åˆ é™¤Fastjsonä¾èµ–ï¼Œä½¿ç”¨å…¶ä»–JsonåŒ…ã€‚ä½†æ˜¯æˆ‘å¾ˆå¥½å¥‡ï¼Œåœ¨æˆ‘çš„ç†è§£é‡Œï¼ŒFastjson è¿™ç§åº“å°±æ˜¯ä¸ªå·¥å…·åŒ…ï¼Œå¦‚æœæˆ‘ä»¬ç¨‹åºæ²¡æœ‰ä¸»åŠ¨è°ƒç”¨çš„æ—¶å€™ï¼Œæ˜¯ä¸ä¼šå¯¹æˆ‘ä»¬äº§ç”Ÿä»»ä½•å½±å“çš„ã€‚ ç™¾åº¦è°·æ­Œä¸€é€šä¹‹åï¼Œä¸€ç­¹è«å±•ä¹‹é™…ï¼Œç‚¹å¼€äº†Fastjsonçš„æºç åŒ…ï¼Œåœ¨è¿™é‡Œå‘ç°äº†Fastjsonä¸ºJAXRSæä¾›çš„SPIæ‰©å±• JAXRSï¼šJava API for RESTful Web Servicesï¼ŒJavaEEæä¾›çš„WebæœåŠ¡æ¥å£ã€‚Jersey å®ç°äº†JAXRSï¼Œè€ŒKafka Connect å¼•ç”¨äº†Jersey ã€‚SPIï¼šService Provider Interface ï¼Œæ˜¯JDKå†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘ç°æœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ Java SPI å®æˆ˜ æ‰“å¼€javax.ws.rs.ext.MessageBodyWriter æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æä¾›çš„å®ç°ç±»æ˜¯com.alibaba.fastjson.support.jaxrs.FastJsonProviderï¼Œå®šä½åˆ°FastJsonProviderä¸‹writeToæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæŠŠobjectå†™å…¥åˆ°OutputStreamä¸­ï¼Œçœ‹èµ·æ¥å¾ˆé è°±ï¼Œdebugè¯•ä¸€ä¸‹ æœç„¶ï¼Œè¯´æ˜Fastjsonæœç„¶å‚ä¸äº†Rest APIçš„å“åº”ã€‚ä¸ºä»€ä¹ˆä½¿ç”¨Fastjsonå°±å“åº”ä¸äº†æ•°æ®å‘¢ï¼Œçœ‹äº†ä¸‹æºç ï¼Œè¿™é‡Œè¦æ±‚è¢«åºåˆ—åŒ–çš„Beanå¿…é¡»æ ‡è®°Fastjsonç›¸å…³çš„æ³¨è§£ï¼Œè€Œå®é™…çš„Beanä½¿ç”¨çš„æ˜¯Jacksonçš„æ³¨è§£ï¼Œæ‰€ä»¥Fastjsonæ— æ³•åºåˆ—åŒ–æ•°æ®ã€‚ æ¥ä¸‹æ¥å¯ä»¥æ ¹æ®è°ƒç”¨æ ˆå’Œå…¨å±€æœç´¢æ‰¾ä¸€ä¸‹ï¼Œçœ‹çœ‹FastJsonProvideræ˜¯åœ¨ä»€ä¹ˆæ—¶æœºåŠ è½½çš„ï¼Œèƒ½å¦å¹²æ‰ä»–ã€‚ è°ƒç”¨æ ˆå¹¶æ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆæœ‰ç”¨çš„ä¿¡æ¯ï¼Œé€šè¿‡å…¨å±€æœç´¢MessageBodyWriteræ‰¾åˆ°äº†FastJsonProviderçš„åŠ è½½ä½ç½®ï¼ŒMessageBodyFactory::initialize ä¸Šå›¾å­—é¢æ„æ€ç†è§£ï¼Œä½¿ç”¨ injectionManager (æ³¨å…¥ç®¡ç†å™¨)ï¼Œæ‰¾åˆ°MessageBodyWriterçš„å¯ç”¨å®ç° è¿™é‡Œçš„ customMbws size = 2ï¼Œåˆ†åˆ«æ˜¯FastJsonå’ŒJacksonçš„å®ç°ã€‚ä½†æ˜¯FastJsonåœ¨å‰ï¼Œè€Œæ¯æ¬¡éœ€è¦åšJSONåºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šéå†writersï¼Œå¦‚æœæ‰¾åˆ°æ”¯æŒapplication/jsonçš„MessageBodyWriteråˆ™ç›´æ¥è¿”å›ï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨çš„éƒ½æ˜¯FastJsonçš„å®ç°ã€‚ è‡³æ­¤å·²ç»æ˜ç™½äº†ï¼Œä¸ºä»€ä¹ˆFastjson ä¼šå½±å“Kafka Connectäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æƒ³åŠæ³•è§£å†³äº† è¿™ä¸ªæ—¶å€™è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°Fastjsonæ˜¯åœ¨å“ªåŠ è½½çš„ï¼Œåœ¨Fastjsonçš„ wiki ä¸­æ‰¾åˆ°äº†äº›çµæ„Ÿï¼Œå‘ç°Fastjson åœ¨Jersey ä¸­å¹¶ä¸æ˜¯é€šè¿‡SPIçš„æ–¹å¼è¿›è¡Œçš„æ‰©å±•ï¼Œè€Œæ˜¯é€šè¿‡FastJsonAutoDiscoverableï¼Œå‘Jersey çš„ contextä¸­æ³¨å†ŒFastJsonProvider æœ€åï¼Œæˆ‘ä»¬åœ¨java è¿›ç¨‹å¯åŠ¨æ—¶æŒ‡å®šå‚æ•° -Dfastjson.auto.discoverable=falseï¼Œç¦ç”¨ FastJsonProvider å‚è€ƒhttps://github.com/alibaba/fastjson/wiki/Integrate-Fastjson-in-JAXRS]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸ªäººç®€å†å¤‡ä»½]]></title>
    <url>%2Fpost%2Fe860cc2d.html</url>
    <content type="text"><![CDATA[åŸºæœ¬ä¿¡æ¯ æ®·å¤©æ–‡/ç”·/1995 ä¸“ç§‘/å¤§è¿è½¯ä»¶èŒä¸šå­¦é™¢/è½¯ä»¶å·¥ç¨‹ å·¥ä½œå¹´é™ï¼š4.5å¹´ ç”µå­é‚®ç®±ï¼š** ç”µè¯ï¼š** åšå®¢ï¼šhttp://yintianwen.top Github: https://github.com/TavenYin ç®€ä¹¦ï¼šhttps://www.jianshu.com/u/cd682de00804 å…¬ä¼—å·ï¼šæ®·å¤©æ–‡ æœŸæœ›å²—ä½ï¼šé«˜çº§åç«¯å¼€å‘ / é«˜çº§Javaå·¥ç¨‹å¸ˆ ä¸“ä¸šæŠ€èƒ½ æ‰å®çš„JavaåŸºç¡€ï¼Œäº†è§£JVMï¼Œç†Ÿæ‚‰å¸¸ç”¨APIå®ç°åŸç†ï¼Œç†Ÿç»ƒæŒæ¡å¤šçº¿ç¨‹å¼€å‘ï¼Œç†Ÿæ‚‰IO/NIO ç†Ÿç»ƒä½¿ç”¨Javaçˆ¬è™«æŠ€æœ¯ ç†Ÿæ‚‰å¸¸ç”¨è®¾è®¡æ¨¡å¼ ç†Ÿç»ƒæŒæ¡Springç­‰å¸¸ç”¨Javaå¼€æºæ¡†æ¶ï¼Œå¹¶æ·±å…¥åˆ†æè¿‡å…¶å®ç°åŸç†ï¼Œå¯¹æºç å­¦ä¹ æœ‰æµ“åšçš„å…´è¶£ ç†Ÿç»ƒä½¿ç”¨MySQL/Redis/Oracleç­‰æ•°æ®åº“ï¼Œäº†è§£Elasticsearch/MongoDB/Postgresç­‰æ•°æ®åº“ ç†Ÿç»ƒæŒæ¡Seata/å¯é æ¶ˆæ¯ç­‰åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ ç†Ÿç»ƒæŒæ¡æ•°æ®åº“è¿ç§»ï¼ŒSQLä¼˜åŒ–ï¼Œåˆ†åº“åˆ†è¡¨ç­‰æŠ€æœ¯ ç†Ÿç»ƒæŒæ¡Kafka/RabbitMQ/RocketMQ ç†Ÿæ‚‰Dubbo/SpringCloudç­‰å¾®æœåŠ¡æ¡†æ¶ ç†Ÿæ‚‰PHP/JavaScript/Luaç­‰è¯­è¨€çš„å¼€å‘ ç†Ÿæ‚‰Linux/Shell/Docker å·¥ä½œç»å†æ€ä½°ç›Šå¿…æ™ºä¿¡æ¯æŠ€æœ¯ï¼ˆå¤§è¿ï¼‰æœ‰é™å…¬å¸ 2021.1 ~ è‡³ä»Š APP DBA æ•°æ®è¿ç§»ç³»ç»Ÿ 2021.1 ~ è‡³ä»ŠæŠ€æœ¯ï¼šKafka, Kafka Connect, Debezium, Oracle, Postgreså‚ä¸æ•°æ®è¿ç§»ç³»ç»Ÿçš„äºŒæ¬¡å¼€å‘ï¼ŒæŠ€æœ¯æ–¹æ¡ˆè°ƒç ”ï¼Œæµ‹è¯•ï¼Œéƒ¨ç½² æŒæ¡äº†Oracleå…¨é‡åŠ å¢é‡æ•°æ®è¿ç§»æ–¹æ¡ˆï¼ˆé—ªå›æŸ¥è¯¢ + LogMiner/XStreamï¼‰ æŒæ¡äº†Debezium Oracle-Connectoræºç  æœŸé—´è‡ªå­¦äº†Kafka/Kafka Connect å¤§è¿äº‘åŒ ç§‘æŠ€ 2019.8 ~ 2021.1 åç«¯ç ”å‘å·¥ç¨‹å¸ˆ IronERP 2020.8 ~ 2021.1æŠ€æœ¯ï¼šJava8, SpringBoot, Mybatis, MySQL, Redis, RocketMQå‚ä¸å¹¶ä¸»å¯¼äº†è®¢å•æ¨é€æ¶ˆè´¹çš„å¼€å‘ æœŸé—´è‡ªå­¦å¹¶æŒæ¡äº†RocketMQ çˆ±å¿ƒåŠ©å†œ 2020.1 ~ 2020.6æŠ€æœ¯ï¼šPHP, YII2, MySQL, Rediså‚ä¸å¹¶ä¸»å¯¼äº†åº“å­˜çš„é‡æ„ï¼Œè§£å†³è¶…å–é—®é¢˜ï¼Œå¹¶æ€»ç»“äº†å®Œæ•´çš„åº“å­˜å®ç°æ–¹æ¡ˆ é‡æ„åŸç³»ç»Ÿä¸­ä¸åˆç†çš„åº“å­˜è¡¨è®¾è®¡ï¼Œåˆ©ç”¨Rediså‘½ä»¤åŸå­æ€§çš„ç‰¹ç‚¹ï¼Œä½¿ç”¨Redis+Luaä½œä¸ºåº“å­˜æ‰£å‡çš„æ–°æ–¹æ¡ˆ åæ¥è¿˜å‘ç°äº†è®¢å•çš„å¹¶å‘æ“ä½œæƒ…å†µï¼ˆä¾‹å¦‚ç”¨æˆ·å–æ¶ˆå’Œç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆï¼Œç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆå’Œæ”¯ä»˜å›è°ƒï¼‰åŒæ ·ä¼šé€ æˆè¶…å–çš„ç°è±¡ï¼Œåˆ†åˆ«é’ˆå¯¹è¿™äº›åœºæ™¯åšäº†ä¼˜åŒ– æœŸé—´è‡ªå­¦äº†PHPç›¸å…³æŠ€æœ¯ å°å¤ªç†Š/ç”µå•†Saas 2019.8 - 2020.6æŠ€æœ¯ï¼šJava8, SpringBoot, JdbcTemplate, SpringCloud Config, Spring Security, ElasticSearch, Redis, MySQL, RabbitMQå‚ä¸å¹¶ä¸»å¯¼äº†æ ¸å¿ƒä¸šåŠ¡çš„è®¾è®¡ä¸å¼€å‘ï¼Œå¦‚äº¤æ˜“åŠŸèƒ½ï¼Œä¿è¯é‡‘ç›¸å…³ æŒæ¡MQå®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ¡ˆ æŒæ¡å¦‚ä½•åœ¨å¹¶å‘åœºæ™¯å¢å‡åº“å­˜ å­¦ä¹ åˆ°äº†å¦‚ä½•è®¾è®¡å¯æ’æ‹”çš„ä¸šåŠ¡æ’ä»¶ å¼€å‘äº†åŸºäºLogbackçš„åˆ†å¸ƒå¼æ—¥å¿—æ”¶é›† å¤§è¿ä¸œæ–¹ä¹‹æ˜Ÿ 2018.10 ~ 2019.8 å›½å®¶ä¹‰åŠ¡æ•™è‚²ä¼˜è´¨å‡è¡¡å‘å±•è¯„ä¼°ç³»ç»Ÿ 2018/10 ~ 2019/8æŠ€æœ¯ï¼šJava8, SpringBoot, Mybatis, MySQL, Druid, Shiro, JWT, Rediså‚ä¸å¹¶ä¸»å¯¼äº†äº§å“åŸºç¡€æ¶æ„ä¸æ ¸å¿ƒä¸šåŠ¡çš„è®¾è®¡ã€‚è¿˜è´Ÿè´£äº†ä¸šåŠ¡åŠŸèƒ½çš„åˆ†é…ï¼Œä»£ç Reviewç­‰ å¼€å‘äº†åŸºäºShiro + Jwtå®ç°äº†ç”¨æˆ·é‰´æƒä»¥åŠé¢˜å‡ºç”¨æˆ·åŠŸèƒ½ å¼€å‘äº†åŸºäºSpring AOP å’Œ Redisåˆ†å¸ƒå¼é”çš„é˜²æ­¢å¹¶å‘æäº¤åŠŸèƒ½ å¤§è¿ä¸‡æ€åŠ¨ç§‘æŠ€ 2016.9 ~ 2018.10 é€šä¿¡è¿è¡Œæ–¹å¼ç®¡ç†ç³»ç»Ÿï¼ˆå›½å®¶ç”µç½‘ï¼‰æŠ€æœ¯ï¼šJava8, Springboot, Mybatis, MySQL, Ehcache, ElasticSearch, Thymeleaf, Openlayer3å‚ä¸å¹¶ä¸»å¯¼äº†æ•´ä¸ªåç«¯ä¸šåŠ¡çš„è®¾è®¡ä¸å¼€å‘ è‡ªå­¦å¹¶æŒæ¡äº†Dijkstraç®—æ³•ï¼Œç”¨äºæ•…éšœè¿‚å›ç®—æ³•çš„å¼€å‘ è‡ªå­¦å¹¶æŒæ¡äº†ElasticSearchçš„ä½¿ç”¨ï¼Œå®ç°äº†åˆ†è¯æœç´¢ï¼ŒåŒä¹‰è¯åŒ¹é…æœç´¢ç­‰åŠŸèƒ½ æŠ€æœ¯æ–‡ç« /ä¸ªäººé¡¹ç›® æ•°æ®åº“CDC (Change Data Capture) æ ¸å¿ƒæŠ€æœ¯ æ·±å…¥ç†è§£ Dijkstra ç®—æ³•å®ç°åŸç† åˆ†å¸ƒå¼äº‹åŠ¡ Seata ATæ¨¡å¼åŸç†ä¸å®æˆ˜ Spring æºç è§£æ @RequestBody @ResponseBody çš„æ¥é¾™å»è„‰ æµ…å…¥æµ…å‡º Spring äº‹åŠ¡ä¼ æ’­å®ç°åŸç† Redisson æºç è§£æï¼Œå¦‚ä½•åˆ©ç”¨Rediså®ç°åˆ†å¸ƒå¼å¯é‡å…¥é” è‡´è°¢æ„Ÿè°¢æ‚¨èŠ±æ—¶é—´é˜…è¯»æˆ‘çš„ç®€å†ï¼ŒæœŸå¾…èƒ½æœ‰æœºä¼šå’Œæ‚¨å…±äº‹]]></content>
      <categories>
        <category>resume</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[åˆ†å¸ƒå¼äº‹åŠ¡ Seata ATæ¨¡å¼åŸç†ä¸å®æˆ˜]]></title>
    <url>%2Fpost%2F6fe3d525.html</url>
    <content type="text"><![CDATA[Seata æ˜¯é˜¿é‡Œå¼€æºçš„åŸºäºJavaçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ ATï¼ŒXAï¼ŒTCCï¼ŒSagaSeata æä¾›å››ç§æ¨¡å¼è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯ï¼ŒATï¼ŒXAï¼ŒTCCï¼ŒSagaã€‚ç®€å•å¨å’•å¨å’•æˆ‘å¯¹è¿™å‡ ç§æ¨¡å¼çš„ç†è§£ AT è¿™æ˜¯Seataçš„ä¸€å¤§ç‰¹è‰²ï¼ŒATå¯¹ä¸šåŠ¡ä»£ç å®Œå…¨æ— ä¾µå…¥æ€§ï¼Œä½¿ç”¨éå¸¸ç®€å•ï¼Œæ”¹é€ æˆæœ¬ä½ã€‚æˆ‘ä»¬åªéœ€è¦å…³æ³¨è‡ªå·±çš„ä¸šåŠ¡SQLï¼ŒSeataä¼šé€šè¿‡åˆ†ææˆ‘ä»¬ä¸šåŠ¡SQLï¼Œåå‘ç”Ÿæˆå›æ»šæ•°æ® AT åŒ…å«ä¸¤ä¸ªé˜¶æ®µ ä¸€é˜¶æ®µï¼Œæ‰€æœ‰å‚ä¸äº‹åŠ¡çš„åˆ†æ”¯ï¼Œæœ¬åœ°äº‹åŠ¡Commit ä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—ï¼ˆundoLogï¼‰ äºŒé˜¶æ®µï¼Œäº‹åŠ¡åè°ƒè€…æ ¹æ®æ‰€æœ‰åˆ†æ”¯çš„æƒ…å†µï¼Œå†³å®šæœ¬æ¬¡å…¨å±€äº‹åŠ¡æ˜¯Commit è¿˜æ˜¯ Rollbackï¼ˆäºŒé˜¶æ®µæ˜¯å®Œå…¨å¼‚æ­¥ï¼‰ XAä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è¯´çš„äºŒé˜¶æ®µæäº¤ï¼ŒXAè¦æ±‚æ•°æ®åº“æœ¬èº«æä¾›å¯¹è§„èŒƒå’Œåè®®çš„æ”¯æŒã€‚XAç”¨èµ·æ¥çš„è¯ï¼Œä¹Ÿæ˜¯å¯¹ä¸šåŠ¡ä»£ç æ— ä¾µå…¥æ€§çš„ã€‚ ä¸Šè¿°å…¶ä»–ä¸‰ç§æ¨¡å¼ï¼Œéƒ½æ˜¯å±äºè¡¥å¿å‹ï¼Œæ— æ³•ä¿è¯å…¨å±€ä¸€è‡´æ€§ã€‚å•¥æ„æ€å‘¢ï¼Œä¾‹å¦‚åˆšåˆšè¯´çš„ATæ¨¡å¼ï¼Œæˆ‘ä»¬æ˜¯å¯èƒ½è¯»åˆ°è¿™ä¸€æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸­é—´çŠ¶æ€ï¼Œè€ŒXAæ¨¡å¼ä¸ä¼šã€‚ è¡¥å¿å‹ äº‹åŠ¡å¤„ç†æœºåˆ¶æ„å»ºåœ¨ äº‹åŠ¡èµ„æºï¼ˆæ•°æ®åº“ï¼‰ ä¹‹ä¸Šï¼ˆè¦ä¹ˆåœ¨ä¸­é—´ä»¶å±‚é¢ï¼Œè¦ä¹ˆåœ¨åº”ç”¨å±‚é¢ï¼‰ï¼Œäº‹åŠ¡èµ„æº æœ¬èº«å¯¹åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†è¡¥å¿å‹äº‹åŠ¡æ— æ³•åšåˆ°çœŸæ­£çš„ å…¨å±€ä¸€è‡´æ€§ ã€‚æ¯”å¦‚ï¼Œä¸€æ¡åº“å­˜è®°å½•ï¼Œå¤„åœ¨ è¡¥å¿å‹ äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œç”± 100 æ‰£å‡ä¸º 50ã€‚æ­¤æ—¶ï¼Œä»“åº“ç®¡ç†å‘˜è¿æ¥æ•°æ®åº“ï¼ŒæŸ¥è¯¢ç»Ÿè®¡åº“å­˜ï¼Œå°±çœ‹åˆ°å½“å‰çš„ 50ã€‚ä¹‹åï¼Œäº‹åŠ¡å› ä¸ºæ„å¤–å›æ»šï¼Œåº“å­˜ä¼šè¢«è¡¥å¿å›æ»šä¸º 100ã€‚æ˜¾ç„¶ï¼Œä»“åº“ç®¡ç†å‘˜æŸ¥è¯¢ç»Ÿè®¡åˆ°çš„ 50 å°±æ˜¯ è„ æ•°æ®ã€‚å¦‚æœæ˜¯XAçš„è¯ï¼Œä¸­é—´æ€æ•°æ®åº“å­˜ 50 ç”±æ•°æ®åº“æœ¬èº«ä¿è¯ï¼Œä¸ä¼šè¢«ä»“åº“ç®¡ç†å‘˜è¯»åˆ°ï¼ˆå½“ç„¶éš”ç¦»çº§åˆ«éœ€è¦ è¯»å·²æäº¤ ä»¥ä¸Šï¼‰ ä½†æ˜¯å…¨å±€ä¸€è‡´æ€§å¸¦æ¥çš„ç»“æœå°±æ˜¯æ•°æ®çš„é”å®šï¼ˆATæ¨¡å¼ä¹Ÿæ˜¯å­˜åœ¨å…¨å±€é”çš„ï¼Œä½†æ˜¯éš”ç¦»çº§åˆ«æ— æ³•ä¿è¯ï¼Œåè¾¹æˆ‘ä»¬ä¼šè¯¦ç»†è¯´ï¼‰ï¼Œä¾‹å¦‚å…¨å±€äº‹åŠ¡ä¸­æœ‰ä¸€æ¡updateè¯­å¥ï¼Œå…¶ä»–äº‹åŠ¡æƒ³è¦æ›´æ–°åŒä¸€æ¡æ•°æ®çš„è¯ï¼Œåªèƒ½ç­‰å¾…å…¨å±€äº‹åŠ¡ç»“æŸ ä¼ ç»ŸXAæ¨¡å¼æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜çš„ï¼ŒSeataä¹Ÿæ˜¯åšäº†ç›¸å…³çš„ä¼˜åŒ–ï¼Œæ›´å¤šå…³äºSeata XAçš„å†…å®¹ï¼Œä¼ é€é—¨ğŸ‘‰http://seata.io/zh-cn/blog/seata-xa-introduce.html TCC TCC æ¨¡å¼åŒæ ·åŒ…å«ä¸¤ä¸ªé˜¶æ®µ Try é˜¶æ®µ ï¼šæ‰€æœ‰å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„åˆ†æ”¯ï¼Œå¯¹ä¸šåŠ¡èµ„æºè¿›è¡Œæ£€æŸ¥å’Œé¢„ç•™ äºŒé˜¶æ®µ Confirmï¼šæ‰€æœ‰åˆ†æ”¯çš„Tryå…¨éƒ¨æˆåŠŸåï¼Œæ‰§è¡Œä¸šåŠ¡æäº¤ äºŒé˜¶æ®µ Cancelï¼šå–æ¶ˆTryé˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº å¯¹æ¯”ATæˆ–è€…XAæ¨¡å¼æ¥è¯´ï¼ŒTCCæ¨¡å¼éœ€è¦æˆ‘ä»¬è‡ªå·±æŠ½è±¡å¹¶å®ç°Tryï¼ŒConfirmï¼ŒCancelä¸‰ä¸ªæ¥å£ï¼Œç¼–ç é‡ä¼šå¤§ä¸€äº›ï¼Œä½†æ˜¯ç”±äºäº‹åŠ¡çš„æ¯ä¸€ä¸ªé˜¶æ®µéƒ½ç”±å¼€å‘äººå‘˜è‡ªè¡Œå®ç°ã€‚è€Œä¸”ç›¸è¾ƒäºATæ¨¡å¼æ¥è¯´ï¼Œå‡å°‘äº†SQLè§£æçš„è¿‡ç¨‹ï¼Œä¹Ÿæ²¡æœ‰å…¨å±€é”çš„é™åˆ¶ï¼Œæ‰€ä»¥TCCæ¨¡å¼çš„æ€§èƒ½æ˜¯ä¼˜äºAT ã€XAæ¨¡å¼ã€‚PSï¼šæœç„¶ç®€å•å’Œé«˜æ•ˆéš¾ä»¥ä¸¤å…¨çš„ Saga Saga æ˜¯é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œæ¯ä¸ªå‚ä¸è€…éœ€è¦å®ç°äº‹åŠ¡çš„æ­£å‘æ“ä½œå’Œè¡¥å¿æ“ä½œã€‚å½“å‚ä¸è€…æ­£å‘æ“ä½œæ‰§è¡Œå¤±è´¥æ—¶ï¼Œå›æ»šæœ¬åœ°äº‹åŠ¡çš„åŒæ—¶ï¼Œä¼šè°ƒç”¨ä¸Šä¸€é˜¶æ®µçš„è¡¥å¿æ“ä½œï¼Œåœ¨ä¸šåŠ¡å¤±è´¥æ—¶æœ€ç»ˆä¼šä½¿äº‹åŠ¡å›åˆ°åˆå§‹çŠ¶æ€ Sagaä¸TCCç±»ä¼¼ï¼ŒåŒæ ·æ²¡æœ‰å…¨å±€é”ã€‚ç”±äºç›¸æ¯”ç¼ºå°‘é”å®šèµ„æºè¿™ä¸€æ­¥ï¼Œåœ¨æŸäº›é€‚åˆçš„åœºæ™¯ï¼ŒSagaè¦æ¯”TCCå®ç°èµ·æ¥æ›´ç®€å•ã€‚ç”±äºSagaå’ŒTCCéƒ½éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ç¼–ç å®ç°ï¼Œæ‰€ä»¥åœ¨å¼€å‘æ—¶æˆ‘ä»¬éœ€è¦å‚è€ƒä¸€äº›è®¾è®¡ä¸Šçš„è§„èŒƒï¼Œç”±äºä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œå¯ä»¥å‚è€ƒåˆ†å¸ƒå¼äº‹åŠ¡ Seata åŠå…¶ä¸‰ç§æ¨¡å¼è¯¦è§£ åœ¨æˆ‘ä»¬äº†è§£å®Œå››ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„åŸç†ä¹‹åï¼Œæˆ‘ä»¬å›åˆ°æœ¬æ–‡é‡ç‚¹ATæ¨¡å¼ AT å¦‚ä½•ä½¿ç”¨æ¨¡æ‹Ÿéœ€æ±‚ï¼šä»¥ä¸‹è®¢å•ä¸ºä¾‹ï¼Œåœ¨åˆ†å¸ƒå¼çš„ç”µå•†åœºæ™¯ä¸­ï¼Œè®¢å•æœåŠ¡å’Œåº“å­˜æœåŠ¡å¯èƒ½æ˜¯ä¸¤ä¸ªæ•°æ®åº“ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ATæ¨¡å¼ä¸‹çš„ä»£ç æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œè¿™é‡Œå¿½ç•¥äº†Seataçš„ç›¸å…³é…ç½®ï¼Œåªçœ‹ä¸šåŠ¡éƒ¨åˆ† åœ¨éœ€è¦å¼€å¯åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ³•ä¸Šæ ‡è®°@GlobalTransactionalï¼Œç„¶åæ‰§è¡Œåˆ†åˆ«æ‰§è¡Œæ‰£å‡åº“å­˜å’Œåˆ›å»ºè®¢å•æ“ä½œï¼Œäº‹åŠ¡çš„å‚ä¸è€…å¯ä»¥æ˜¯æœ¬åœ°çš„æ•°æ®æºï¼Œæˆ–è€…RPCçš„è¿œç¨‹è°ƒç”¨ï¼ˆè¿œç¨‹è°ƒç”¨çš„è¯éœ€è¦æºå¸¦å…¨å±€äº‹åŠ¡IDï¼Œä¹Ÿå°±æ˜¯ä¸Šå›¾çš„xidï¼‰ AT ä¸€é˜¶æ®µä¹‹å‰è¯´è¿‡ATæ¨¡å¼åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µåŒ…æ‹¬æäº¤ä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—ï¼ˆundoLogï¼‰ï¼Œç¬¬ä¸€é˜¶æ®µå…·ä½“æµç¨‹å¦‚ä¸‹å›¾ GlobalTransactional åˆ‡é¢æ ‡è®°@GlobalTransactionalçš„æ–¹æ³•é€šè¿‡AOPå®ç°äº†ï¼Œå¼€å¯å…¨å±€äº‹åŠ¡å’Œæäº¤å…¨å±€äº‹åŠ¡ä¸¤ä¸ªæ“ä½œï¼Œä¸Spring äº‹åŠ¡æœºåˆ¶ç±»ä¼¼ï¼Œå½“ GlobalTransactionalInterceptor åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ•è·åˆ°Throwableæ—¶ï¼Œä¼šå‘èµ·å…¨å±€äº‹åŠ¡å›æ»š 0.1 æ­¥éª¤ä¸­ä¼šç”Ÿæˆä¸€ä¸ªå…¨å±€äº‹åŠ¡ID 0.2 æ‰€æœ‰äº‹åŠ¡å‚ä¸è€…æ‰§è¡Œç»“æŸåï¼Œä¸€é˜¶æ®µäº‹åŠ¡æäº¤ undoLogæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Seata undoLog çš„ç»“æ„1234567891011// çœç•¥äº†ç›¸å…³æ–¹æ³•public class SQLUndoLog &#123; // insert, update ... private SQLType sqlType; private String tableName; private TableRecords beforeImage; private TableRecords afterImage;&#125; Seata åœ¨æ‰§è¡Œä¸šåŠ¡SQLå‰åï¼Œä¼šç”ŸæˆbeforeImageå’ŒafterImageï¼Œåœ¨éœ€è¦å›æ»šæ—¶ï¼Œæ ¹æ®SQLTypeï¼Œå†³å®šå…·ä½“çš„å›æ»šç­–ç•¥ï¼Œä¾‹å¦‚SQLType=updateæ—¶ï¼Œå°†æ•°æ®å›æ»šåˆ°beforeImageçš„çŠ¶æ€ï¼Œå¦‚æœSQLType=insertï¼Œåˆ™æ ¹æ®afterImageåˆ é™¤æ•°æ® å¦‚2.4æ‰€ç¤ºï¼Œæ¯æ¡ä¸šåŠ¡SQLï¼Œæ‰§è¡ŒæˆåŠŸåï¼Œä¼šä¸ºè¿™æ¡SQLç”ŸæˆLockKeyï¼Œæ ¼å¼ä¸ºtableName:PrimaryKey æ³¨å†Œåˆ†æ”¯äº‹åŠ¡åœ¨3.1æ­¥éª¤æ³¨å†Œåˆ†æ”¯äº‹åŠ¡æ—¶ï¼Œclientä¼šæŠŠæ‰€æœ‰çš„LockKey æ‹¼åˆ°ä¸€èµ·ä½œä¸ºå…¨å±€é”å‘é€ç»™Seata-serverã€‚å¦‚æœæ³¨å†ŒæˆåŠŸï¼Œå†™å…¥undoLogï¼Œå¹¶æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œä¸€é˜¶æ®µç»“æŸï¼Œç­‰å¾…äºŒé˜¶æ®µåé¦ˆ å¦‚æœå½“å‰æœ‰å…¶ä»–åˆ†æ”¯äº‹åŠ¡å·²ç»æŒæœ‰äº†ç›¸åŒçš„é”ï¼ˆå³å…¶ä»–äº‹åŠ¡ä¹Ÿåœ¨å¤„ç†ç›¸åŒè¡¨çš„åŒä¸€è¡Œï¼‰ï¼Œåˆ™client æ³¨å†Œäº‹åŠ¡åˆ†æ”¯å¤±è´¥ã€‚clientä¼šæ ¹æ®å®¢æˆ·ç«¯å®šä¹‰çš„é‡å‘æ—¶é—´å’Œé‡å‘æ¬¡æ•°è¿›è¡Œä¸æ–­çš„å°è¯•ï¼Œå¦‚æœé‡è¯•ç»“æŸä»ç„¶æ²¡æœ‰è·å¾—é”ï¼Œåˆ™ä¸€é˜¶æ®µå¤±è´¥ï¼Œæœ¬åœ°äº‹åŠ¡å›æ»šã€‚å¦‚æœè¯¥å…¨å±€äº‹åŠ¡å­˜åœ¨å·²ç»æ³¨å†ŒæˆåŠŸåˆ†æ”¯äº‹åŠ¡ï¼ŒSeata-server è¿›è¡ŒäºŒé˜¶æ®µå›æ»š å…¨å±€é”ä¼šåœ¨åˆ†æ”¯äº‹åŠ¡äºŒé˜¶æ®µç»“æŸåé‡Šæ”¾ Seata å…¨å±€é”çš„è®¾è®¡æ˜¯ä¸ºäº†ä»€ä¹ˆï¼Ÿä»¥æ‰£å‡åº“å­˜åœºæ™¯ä¸ºä¾‹ï¼ŒTX1 å®Œæˆåº“å­˜æ‰£å‡çš„ä¸€é˜¶æ®µï¼Œåº“å­˜ä»100æ‰£å‡ä¸º99ï¼Œæ­£åœ¨ç­‰å¾…äºŒé˜¶æ®µçš„é€šçŸ¥ã€‚TX2ä¹Ÿè¦æ‰£å‡åŒä¸€å•†å“çš„åº“å­˜ï¼Œå¦‚æœæ²¡æœ‰å…¨å±€é”çš„é™åˆ¶ï¼ŒTX2åº“å­˜ä»99æ‰£å‡ä¸º98ï¼Œè¿™æ—¶å¦‚æœTX1æ¥æ”¶åˆ°å›æ»šé€šçŸ¥ï¼Œè¿›è¡Œå›æ»šæŠŠåº“å­˜ä»98å›æ»šåˆ°100ã€‚å› ä¸ºæ²¡æœ‰å…¨å±€é”ï¼Œé€ æˆäº†è„å†™ AT äºŒé˜¶æ®µäºŒé˜¶æ®µæ˜¯å®Œå…¨å¼‚æ­¥åŒ–çš„å¹¶ä¸”å®Œå…¨ç”±Seataæ§åˆ¶ï¼ŒSeataæ ¹æ®æ‰€æœ‰äº‹åŠ¡å‚ä¸è€…çš„æäº¤æƒ…å†µå†³å®šäºŒé˜¶æ®µå¦‚ä½•å¤„ç† å¦‚æœæ‰€æœ‰äº‹åŠ¡æäº¤æˆåŠŸï¼Œåˆ™äºŒé˜¶æ®µçš„ä»»åŠ¡å°±æ˜¯åˆ é™¤ä¸€é˜¶æ®µç”Ÿæˆ çš„undoLogï¼Œå¹¶é‡Šæ”¾å…¨å±€é” å¦‚æœéƒ¨åˆ†äº‹åŠ¡å‚ä¸è€…æäº¤å¤±è´¥ï¼Œåˆ™éœ€è¦æ ¹æ®undoLogå¯¹å·²ç»æ³¨å†Œçš„äº‹åŠ¡åˆ†æ”¯è¿›è¡Œå›æ»šï¼Œå¹¶é‡Šæ”¾å…¨å±€é” å¯¹Seataæå‡ºçš„ç–‘é—®è‡³æ­¤æˆ‘ä»¬å·²ç»åˆæ­¥äº†è§£äº†Seataçš„ATæ¨¡å¼æ˜¯å¦‚ä½•å®ç°çš„äº† å¦‚æœä½ ä¹Ÿå’Œæˆ‘ä¸€æ ·ï¼Œä»”ç»†æ€è€ƒäº†ä¸Šè¿°è¿‡ç¨‹ï¼Œå¯èƒ½ä¼šæå‡ºä¸€äº›é—®é¢˜ï¼Œè¿™è¾¹æˆ‘åˆ—ä¸¾ä¸€ä¸‹æˆ‘åœ¨å­¦ä¹ Seataæ—¶ï¼Œé‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠæˆ‘å¾—å‡ºçš„ç»“è®º é—®é¢˜1. Seataå¦‚ä½•åšåˆ°æ— ä¾µå…¥çš„åˆ†æä¸šåŠ¡SQLç”ŸæˆundoLogï¼Œæ³¨å†Œäº‹åŠ¡åˆ†æ”¯ç­‰æ“ä½œï¼Ÿ Seata ä»£ç†äº†DataSourceï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä»£ç æ³¨å…¥ä¸€ä¸ªDataSourceæ¥éªŒè¯æˆ‘çš„è¯´æ³•ï¼Œç›®å‰çš„DataSource æ˜¯ io.seata.rm.datasource.DataSourceProxy æ‰€æœ‰çš„JavaæŒä¹…åŒ–æ¡†æ¶ï¼Œæœ€ç»ˆåœ¨æ“ä½œæ•°æ®åº“æ—¶éƒ½ä¼šé€šè¿‡DataSourceæ¥å£è·å–Connectionï¼Œé€šè¿‡Connection å®ç°å¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥ï¼Œäº‹åŠ¡æ§åˆ¶ã€‚ Seata é€šè¿‡ä»£ç†Connectionçš„æ–¹å¼ï¼Œåšåˆ°äº†æ— ä¾µå…¥çš„ç”ŸæˆundoLogï¼Œæ³¨å†Œäº‹åŠ¡åˆ†æ”¯ï¼Œå…·ä½“æºç å¯ä»¥æŸ¥çœ‹io.seata.rm.datasource.ConnectionProxy é—®é¢˜2. ConnectionProxy å¦‚ä½•åˆ¤æ–­å½“å‰äº‹åŠ¡æ˜¯å…¨å±€äº‹åŠ¡ï¼Œè¿˜æ˜¯æœ¬åœ°äº‹åŠ¡ï¼Ÿ é€šè¿‡å½“å‰çº¿ç¨‹æ˜¯å¦ç»‘å®šäº†å…¨å±€äº‹åŠ¡idï¼Œåœ¨è¿›è¡Œå…¨å±€äº‹åŠ¡ä¹‹å‰ï¼Œéœ€è¦è°ƒç”¨RootContext.bind(xid); é—®é¢˜3. å…¨å±€äº‹åŠ¡å¹¶å‘æ›´æ–° è¿˜æ˜¯ä»¥ä¸‹è®¢å•æ‰£å‡åº“å­˜çš„åœºæ™¯ä¸ºä¾‹ï¼Œå¦‚æœTX1å’ŒTX2åŒæ—¶æ‰£å‡product_idä¸º1çš„åº“å­˜ï¼Œè¿™æ—¶Seataä¼šä¸ä¼šç”Ÿæˆç›¸åŒçš„beforeImageï¼Ÿ ä¸¾ä¸ªä¾‹å­ï¼ŒTX1è¯»åº“å­˜ä¸º100ï¼ŒTX1æ‰£å‡åº“å­˜1ï¼Œæ­¤æ—¶BeforeImageä¸º100ç´§æ¥ç€ å¦‚æœTX2è¯»åº“å­˜ä¹Ÿä¸º100ï¼Œé‚£ä¹ˆå°±æœ‰é—®é¢˜äº†ï¼Œä¸ç®¡TX2æ‰£å‡å¤šå°‘åº“å­˜ï¼Œå¦‚æœTX1å›æ»šé‚£ä¹ˆç›¸å½“äºè¦†ç›–äº†TX2æ‰£å‡çš„åº“å­˜ï¼Œå‡ºç°äº†è„å†™ Seataæ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Ÿ æºç ä½ç½®ï¼šio.seata.rm.datasource.exec.AbstractDMLBaseExecutor::executeAutoCommitFalse å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„é€»è¾‘å’Œæˆ‘ä¸Šé¢ç”»çš„å›¾ä¸€è‡´ï¼Œè¯æ˜æˆ‘æ²¡æœ‰çè¯´ ğŸ˜„ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹beforeImage()ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹ä»–çš„å­ç±»UpdateExecutoræ˜¯å¦‚ä½•å®ç°çš„ é€šè¿‡Debugï¼Œå¯ä»¥çœ‹å‡ºSeataè¿™è¾¹ä¹Ÿæ˜¯ç¡®å®è€ƒè™‘äº†è¿™ä¸ªé—®é¢˜ï¼Œç›´æ¥ç®€å•è€Œæœ‰æ•ˆçš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ å›åˆ°æˆ‘ä»¬çš„ä¾‹å­ï¼Œç”±äºSELECT FOR UPDATEçš„å­˜åœ¨ï¼ŒTX2å¦‚æœä¹Ÿæƒ³è¯»åŒä¸€æ¡æ•°æ®çš„è¯ï¼Œåªèƒ½ç­‰åˆ°TX1 æäº¤äº‹åŠ¡åï¼Œæ‰èƒ½è¯»åˆ°ã€‚æ‰€ä»¥é—®é¢˜è§£å†³ é—®é¢˜4. å…¨å±€äº‹åŠ¡å¤–çš„æ›´æ–° æˆ‘ä»¬ç°åœ¨å¯ä»¥ç¡®è®¤åœ¨Seataçš„ä¿è¯ä¸‹ï¼Œå…¨å±€äº‹åŠ¡ï¼Œä¸ä¼šé€ æˆæ•°æ®çš„è„å†™ï¼Œä½†æ˜¯å…¨å±€äº‹åŠ¡å¤–ä¼šï¼ ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ è¿˜ä»¥åº“å­˜ä¸ºä¾‹ ç”¨æˆ·æ­£åœ¨æŠ¢è´­ï¼Œç”¨æˆ·Aå®Œæˆäº†1é˜¶æ®µçš„åº“å­˜æ‰£å‡ï¼Œè¿™ä¸ªæ—¶å€™åº“å­˜ä¸º99ã€‚ æ­¤æ—¶åº“å­˜ç®¡ç†å‘˜ä¸Šçº¿äº†ï¼Œä»–æŸ¥äº†ä¸€ä¸‹åº“å­˜ä¸º99ã€‚å—¯â€¦å¤ªå°‘äº†ï¼Œæˆ‘åŠ 100ä¸ªï¼Œåº“å­˜ç®¡ç†å‘˜æŠŠåº“å­˜æ›´æ–°ä¸º200ã€‚ è€Œæ­¤æ—¶seataç»™ç”¨æˆ·Aç”ŸæˆbeforeImageä¸º100ï¼Œå¦‚æœæ­¤æ—¶ç”¨æˆ·Açš„å…¨å±€äº‹åŠ¡å¤±è´¥äº†ï¼Œå‘ç”Ÿäº†å›æ»šï¼Œå†æ¬¡å°†åº“å­˜æ›´æ–°ä¸º100â€¦ å†æ¬¡å‡ºç°è„å†™ Seata é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæä¾›äº†@GlobalLockæ³¨è§£ï¼Œæ ‡è®°è¯¥æ³¨è§£æ—¶ï¼Œä¼šåƒå…¨å±€äº‹åŠ¡ä¸€æ ·è¿›è¡ŒSQLåˆ†æï¼Œç«äº‰å…¨å±€é”ï¼Œå°±ä¸ä¼šå‡ºç°ä¸Šè¿°é—®é¢˜äº† å…³äºè¿™ä¸ªé—®é¢˜å¯ä»¥å‚è€ƒSeataçš„FAQæ–‡æ¡£ http://seata.io/zh-cn/docs/overview/faq.html é—®é¢˜5. @GlobalTransactional å’Œ @Transactional åŒæ—¶ä½¿ç”¨ä¼šæ€ä¹ˆæ · æˆ‘ä»¬ä¸Šæ–‡ä¸­å·²ç»è¯´è¿‡äº† @GlobalTransactional çš„ä½œç”¨äº†ï¼Œä»–æ˜¯è´Ÿè´£å¼€å¯å…¨å±€äº‹åŠ¡/æäº¤äº‹åŠ¡1é˜¶æ®µï¼Œè¯´ç™½äº†@GlobalTransactional åªå’ŒSeata-server äº¤äº’ï¼Œè€Œ @Transactional ç®¡ç†çš„æ˜¯æœ¬åœ°æ•°æ®åº“çš„äº‹åŠ¡ï¼Œæ‰€ä»¥äºŒè€…ä¸å‘ç”Ÿå†²çªã€‚ ä½†æ˜¯éœ€è¦æ³¨æ„ @GlobalTransactional AOP è¦†ç›–èŒƒå›´ä¸€å®šè¦å¤§äº @Transactional é—®é¢˜6. å¦‚æœå…¶ä¸­æŸä¸€ä¸ªäº‹åŠ¡åˆ†æ”¯è¶…æ—¶æœªæäº¤ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆ è¿™ä¸ªæˆ‘å¹¶æ²¡æœ‰çœ‹æºç ï¼Œè€Œæ˜¯é€šè¿‡è·‘demoï¼ŒéªŒè¯çš„ ä¾‹å¦‚ç°åœ¨æœ‰Aï¼ŒBä¸¤ä¸ªäº‹åŠ¡åˆ†æ”¯ A æ­£å¸¸æäº¤ï¼Œå¹¶å‘Seataæ³¨å†Œåˆ†æ”¯æˆåŠŸ B 2åˆ†é’Ÿåæäº¤äº‹åŠ¡ï¼Œå¹¶å‘Seataå‘èµ·æ³¨å†Œ Seataçš„å…¨å±€äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯1åˆ†é’Ÿï¼ŒSeata-server åœ¨æ£€æµ‹åˆ°æœ‰è¶…æ—¶çš„å…¨å±€äº‹åŠ¡æ—¶ï¼Œä¼šå‘æ‰€æœ‰å·²æäº¤çš„åˆ†æ”¯ï¼Œå‘èµ·å›æ»šã€‚è€Œè¶…æ—¶æäº¤çš„äº‹åŠ¡ï¼Œå‘Seata-serverå‘èµ·åˆ†æ”¯æ³¨å†Œæ—¶ï¼Œå“åº”ç»“æœä¸ºäº‹åŠ¡å·²è¶…æ—¶ï¼Œæˆ–è€…äº‹åŠ¡ä¸å­˜åœ¨ï¼Œä¹Ÿä¼šå›æ»šæœ¬åœ°äº‹åŠ¡ é—®é¢˜7. Seata-client å¦‚ä½•æ¥æ”¶Seata-serverå‘èµ·çš„é€šçŸ¥ Seata-client åŒ…å«äº†NettyæœåŠ¡ï¼Œåœ¨å¯åŠ¨æ—¶Nettyä¼šç›‘å¬ç«¯å£ï¼Œå¹¶å‘Seata-server å‘èµ·æ³¨å†Œã€‚serverä¸­å­˜å‚¨äº†client çš„è°ƒç”¨åœ°å€ã€‚ æ€»ç»“æˆ‘ä»¬å­¦ä¹ äº†Seataçš„ATæ¨¡å¼æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå¯ä»¥çœ‹å‡ºSeataæ¨¡å¼åœ¨å¼€å‘ä¸Šæ˜¯éå¸¸ç®€å•çš„ï¼Œä½†æ˜¯Seataçš„èƒŒåä¸ºäº†ç»´æŒåˆ†å¸ƒå¼äº‹åŠ¡çš„æ•°æ®ä¸€è‡´æ€§ï¼Œåšäº†å¤§é‡çš„å·¥ä½œï¼ŒATæ¨¡å¼éå¸¸é€‚åˆç°æœ‰çš„ä¸šåŠ¡æ¨¡å‹ç›´æ¥è¿ç§»ã€‚ ä½†æ˜¯ä»–çš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œæ€§èƒ½å¹¶ä¸æ˜¯é‚£ä¹ˆçš„ä¼˜ç§€ã€‚ä¾‹å¦‚æˆ‘ä»¬åˆšåˆšçœ‹åˆ°çš„å…¨å±€é”çš„é—®é¢˜ï¼Œä¸ºäº†æ•°æ®ä¸ä¼šå‘ç”Ÿè„å†™ï¼ŒSeataç‰ºç‰²äº†ä¸šåŠ¡çš„å¹¶å‘èƒ½åŠ›ã€‚åœ¨éå¸¸è¦æ±‚æ€§èƒ½çš„åœºæ™¯ï¼Œå¯èƒ½è¿˜æ˜¯éœ€è¦è€ƒè™‘TCCï¼ŒSAGAï¼Œå¯é æ¶ˆæ¯ç­‰æ–¹æ¡ˆ åœ¨ä½¿ç”¨Seataå¼€å‘å‰ï¼Œå»ºè®®å¤§å®¶å…ˆå»é˜…è¯»ä¸€ä¸‹FAQæ–‡æ¡£ï¼Œé¿å…è¸©å‘ https://seata.io/zh-cn/docs/overview/faq.html DEMOhttps://github.com/TavenYin/taven-springboot-learning/tree/master/springboot-seata å‚è€ƒSeataæ˜¯ä»€ä¹ˆ - http://seata.io/zh-cn/docs/overview/what-is-seata.htmlSeataå¸¸è§é—®é¢˜ - http://seata.io/zh-cn/docs/overview/faq.htmlåˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶ Seata çš„è®¾è®¡åŸç† - http://seata.io/zh-cn/blog/seata-at-mode-design.htmlåˆ†å¸ƒå¼äº‹åŠ¡ Seata åŠå…¶ä¸‰ç§æ¨¡å¼è¯¦è§£ - http://seata.io/zh-cn/blog/seata-at-tcc-saga.htmlåˆ†å¸ƒå¼äº‹åŠ¡å¦‚ä½•å®ç°ï¼Ÿæ·±å…¥è§£è¯» Seata çš„ XA æ¨¡å¼ - http://seata.io/zh-cn/blog/seata-xa-introduce.html]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>Seata</tag>
        <tag>åˆ†å¸ƒå¼äº‹åŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…å…¥æµ…å‡º Spring äº‹åŠ¡ä¼ æ’­å®ç°åŸç†]]></title>
    <url>%2Fpost%2Fbef5c7fd.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡å’Œå¤§å®¶ä¸€èµ·åˆ¨æ Spring äº‹åŠ¡çš„ç›¸å…³æºç ï¼Œç¯‡å¹…è¾ƒé•¿ï¼Œä»£ç ç‰‡æ®µè¾ƒå¤šï¼Œå»ºè®®ä½¿ç”¨ç”µè„‘é˜…è¯» æœ¬æ–‡ç›®æ ‡ ç†è§£Springäº‹åŠ¡ç®¡ç†æ ¸å¿ƒæ¥å£ ç†è§£Springäº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒé€»è¾‘ ç†è§£äº‹åŠ¡çš„ä¼ æ’­ç±»å‹åŠå…¶å®ç°åŸç† ç‰ˆæœ¬SpringBoot 2.3.3.RELEASE ä»€ä¹ˆæ˜¯äº‹åŠ¡çš„ä¼ æ’­ï¼ŸSpring é™¤äº†å°è£…äº†äº‹åŠ¡æ§åˆ¶ä¹‹å¤–ï¼Œè¿˜æŠ½è±¡å‡ºäº† äº‹åŠ¡çš„ä¼ æ’­ è¿™ä¸ªæ¦‚å¿µï¼Œäº‹åŠ¡çš„ä¼ æ’­å¹¶ä¸æ˜¯å…³ç³»å‹æ•°æ®åº“æ‰€å®šä¹‰çš„ï¼Œè€Œæ˜¯Springåœ¨å°è£…äº‹åŠ¡æ—¶åšçš„å¢å¼ºæ‰©å±•ï¼Œå¯ä»¥é€šè¿‡@Transactional æŒ‡å®šäº‹åŠ¡çš„ä¼ æ’­ï¼Œå…·ä½“ç±»å‹å¦‚ä¸‹ äº‹åŠ¡ä¼ æ’­è¡Œä¸ºç±»å‹ è¯´æ˜ PROPAGATION_REQUIRED å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ï¼Œå¦‚æœå·²ç»å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼ŒåŠ å…¥åˆ°è¿™ä¸ªäº‹åŠ¡ä¸­ã€‚Springçš„é»˜è®¤äº‹åŠ¡ä¼ æ’­ç±»å‹ PROPAGATION_SUPPORTS æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚ PROPAGATION_MANDATORY ä½¿ç”¨å½“å‰çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ã€‚ PROPAGATION_REQUIRES_NEW æ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ï¼ˆæš‚åœï¼‰ã€‚ PROPAGATION_NOT_SUPPORTED ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œæ“ä½œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œå°±æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚ PROPAGATION_NEVER ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ PROPAGATION_NESTED å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œã€‚å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æ‰§è¡Œä¸PROPAGATION_REQUIREDç±»ä¼¼çš„æ“ä½œã€‚ ä¸¾ä¸ªæ —å­ä»¥åµŒå¥—äº‹åŠ¡ä¸ºä¾‹123456789101112131415161718192021222324252627282930313233343536@Servicepublic class DemoServiceImpl implements DemoService &#123; @Autowired private JdbcTemplate jdbcTemplate; @Autowired private DemoServiceImpl self; @Transactional @Override public void insertDB() &#123; String sql = "INSERT INTO sys_user(`id`, `username`) VALUES (?, ?)"; jdbcTemplate.update(sql, uuid(), "taven"); try &#123; // å†…åµŒäº‹åŠ¡å°†ä¼šå›æ»šï¼Œè€Œå¤–éƒ¨äº‹åŠ¡ä¸ä¼šå—åˆ°å½±å“ self.nested(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; @Transactional(propagation = Propagation.NESTED) @Override public void nested() &#123; String sql = "INSERT INTO sys_user(`id`, `username`) VALUES (?, ?)"; jdbcTemplate.update(sql, uuid(), "nested"); throw new RuntimeException("rollback nested"); &#125; private String uuid() &#123; return UUID.randomUUID().toString(); &#125;&#125; ä¸Šè¿°ä»£ç ä¸­ï¼Œnested()æ–¹æ³•æ ‡è®°äº†äº‹åŠ¡ä¼ æ’­ç±»å‹ä¸ºåµŒå¥—ï¼Œå¦‚æœnested()ä¸­æŠ›å‡ºå¼‚å¸¸ä»…ä¼šå›æ»šnested()æ–¹æ³•ä¸­çš„sqlï¼Œä¸ä¼šå½±å“åˆ°insertDB()æ–¹æ³•ä¸­å·²ç»æ‰§è¡Œçš„sql æ³¨æ„ï¼šservice è°ƒç”¨å†…éƒ¨æ–¹æ³•æ—¶ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨thisè°ƒç”¨ï¼Œäº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆã€‚å› æ­¤ä½¿ç”¨thisè°ƒç”¨ç›¸å½“äºè·³è¿‡äº†å¤–éƒ¨çš„ä»£ç†ç±»ï¼Œæ‰€ä»¥AOPä¸ä¼šç”Ÿæ•ˆï¼Œæ— æ³•ä½¿ç”¨äº‹åŠ¡ æ€è€ƒä¼—æ‰€å‘¨çŸ¥ï¼ŒSpring äº‹åŠ¡æ˜¯é€šè¿‡AOPå®ç°çš„ï¼Œå¦‚æœæ˜¯æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªAOPæ§åˆ¶äº‹åŠ¡ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ1234567891011121314151617// ä¼ªä»£ç public Object invokeWithinTransaction() &#123; // å¼€å¯äº‹åŠ¡ connection.beginTransaction(); try &#123; // åå°„æ‰§è¡Œæ–¹æ³• Object result = invoke(); // æäº¤äº‹åŠ¡ connection.commit(); return result; &#125; catch(Exception e) &#123; // å‘ç”Ÿå¼‚å¸¸æ—¶å›æ»š connection.rollback(); throw e; &#125; &#125; åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹å¦‚æœæ˜¯æˆ‘ä»¬è‡ªå·±åšçš„è¯ï¼Œäº‹åŠ¡çš„ä¼ æ’­è¯¥å¦‚ä½•å®ç° ä»¥PROPAGATION_REQUIREDä¸ºä¾‹ï¼Œè¿™ä¸ªä¼¼ä¹å¾ˆç®€å•ï¼Œæˆ‘ä»¬åˆ¤æ–­ä¸€ä¸‹å½“å‰æ˜¯å¦æœ‰äº‹åŠ¡ï¼ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ThreadLocalå­˜å‚¨å·²å­˜åœ¨çš„äº‹åŠ¡å¯¹è±¡ï¼‰ï¼Œå¦‚æœæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå°±ä¸å¼€å¯æ–°çš„äº‹åŠ¡ã€‚åä¹‹ï¼Œæ²¡æœ‰äº‹åŠ¡ï¼Œæˆ‘ä»¬å°±åˆ›å»ºæ–°çš„äº‹åŠ¡ å¦‚æœäº‹åŠ¡æ˜¯ç”±å½“å‰åˆ‡é¢å¼€å¯çš„ï¼Œåˆ™æäº¤/å›æ»šäº‹åŠ¡ï¼Œåä¹‹ä¸åšå¤„ç† é‚£ä¹ˆäº‹åŠ¡ä¼ æ’­ä¸­æè¿°çš„æŒ‚èµ·ï¼ˆæš‚åœï¼‰å½“å‰äº‹åŠ¡ï¼Œå’Œå†…åµŒäº‹åŠ¡æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ æºç å…¥æ‰‹è¦é˜…è¯»äº‹åŠ¡ä¼ æ’­ç›¸å…³çš„æºç ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹Spring äº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒæ¥å£ä¸ç±» TransactionDefinitionè¯¥æ¥å£å®šä¹‰äº†äº‹åŠ¡çš„æ‰€æœ‰å±æ€§ï¼ˆéš”ç¦»çº§åˆ«ï¼Œä¼ æ’­ç±»å‹ï¼Œè¶…æ—¶æ—¶é—´ç­‰ç­‰ï¼‰ï¼Œæˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨çš„ @Transactional å…¶å®æœ€ç»ˆä¼šè¢«è½¬åŒ–ä¸º TransactionDefinition TransactionStatusäº‹åŠ¡çš„çŠ¶æ€ï¼Œä»¥æœ€å¸¸ç”¨çš„å®ç° DefaultTransactionStatus ä¸ºä¾‹ï¼Œè¯¥ç±»å­˜å‚¨äº†å½“å‰çš„äº‹åŠ¡å¯¹è±¡ï¼Œsavepointï¼Œå½“å‰æŒ‚èµ·çš„äº‹åŠ¡ï¼Œæ˜¯å¦å®Œæˆï¼Œæ˜¯å¦ä»…å›æ»šç­‰ç­‰ TransactionManagerè¿™æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œç›´æ¥ç»§æ‰¿ä»–çš„ interface æœ‰ PlatformTransactionManagerï¼ˆæˆ‘ä»¬å¹³æ—¶ç”¨çš„å°±æ˜¯è¿™ä¸ªï¼Œé»˜è®¤çš„å®ç°ç±»DataSourceTransactionManagerï¼‰ä»¥åŠReactiveTransactionManagerï¼ˆå“åº”å¼äº‹åŠ¡ç®¡ç†å™¨ï¼Œç”±äºä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œæˆ‘ä»¬ä¸å¤šè¯´ï¼‰ ä»ä¸Šè¿°ä¸¤ä¸ªæ¥å£æ¥çœ‹ï¼ŒTransactionManager çš„ä¸»è¦ä½œç”¨ é€šè¿‡TransactionDefinitionå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿”å›TransactionStatus é€šè¿‡TransactionStatus æäº¤ã€å›æ»šäº‹åŠ¡ï¼ˆå®é™…å¼€å¯äº‹åŠ¡çš„Connectioné€šå¸¸å­˜å‚¨åœ¨TransactionStatusä¸­ï¼‰ 123456789101112public interface PlatformTransactionManager extends TransactionManager &#123; TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException; void commit(TransactionStatus status) throws TransactionException; void rollback(TransactionStatus status) throws TransactionException;&#125; TransactionInterceptoräº‹åŠ¡æ‹¦æˆªå™¨ï¼Œäº‹åŠ¡AOPçš„æ ¸å¿ƒç±»ï¼ˆæ”¯æŒå“åº”å¼äº‹åŠ¡ï¼Œç¼–ç¨‹å¼äº‹åŠ¡ï¼Œä»¥åŠæˆ‘ä»¬å¸¸ç”¨çš„æ ‡å‡†äº‹åŠ¡ï¼‰ï¼Œç”±äºç¯‡å¹…åŸå› ï¼Œæœ¬æ–‡åªè®¨è®ºæ ‡å‡†äº‹åŠ¡çš„ç›¸å…³å®ç° ä¸‹é¢æˆ‘ä»¬ä»äº‹åŠ¡é€»è¾‘çš„å…¥å£ TransactionInterceptor å…¥æ‰‹ï¼Œæ¥çœ‹ä¸‹Springäº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒé€»è¾‘ä»¥åŠäº‹åŠ¡ä¼ æ’­çš„å®ç° TransactionInterceptorTransactionInterceptor å®ç°äº†MethodInvocationï¼ˆè¿™æ˜¯å®ç°AOPçš„ä¸€ç§æ–¹å¼ï¼‰ï¼Œå…¶æ ¸å¿ƒé€»è¾‘åœ¨çˆ¶ç±»TransactionAspectSupport ä¸­ï¼Œæ–¹æ³•ä½ç½®ï¼šTransactionInterceptor::invokeWithinTransaction 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950protected Object invokeWithinTransaction(Method method, @Nullable Class&lt;?&gt; targetClass, final InvocationCallback invocation) throws Throwable &#123; // If the transaction attribute is null, the method is non-transactional. TransactionAttributeSource tas = getTransactionAttributeSource(); // å½“å‰äº‹åŠ¡çš„å±æ€§ TransactionAttribute extends TransactionDefinition final TransactionAttribute txAttr = (tas != null ? tas.getTransactionAttribute(method, targetClass) : null); // äº‹åŠ¡å±æ€§ä¸­å¯ä»¥å®šä¹‰å½“å‰ä½¿ç”¨å“ªä¸ªäº‹åŠ¡ç®¡ç†å™¨ // å¦‚æœæ²¡æœ‰å®šä¹‰å°±å»Springä¸Šä¸‹æ–‡æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ TransactionManager final TransactionManager tm = determineTransactionManager(txAttr); // çœç•¥äº†å“åº”å¼äº‹åŠ¡çš„å¤„ç† ... PlatformTransactionManager ptm = asPlatformTransactionManager(tm); final String joinpointIdentification = methodIdentification(method, targetClass, txAttr); if (txAttr == null || !(ptm instanceof CallbackPreferringPlatformTransactionManager)) &#123; // Standard transaction demarcation with getTransaction and commit/rollback calls. TransactionInfo txInfo = createTransactionIfNecessary(ptm, txAttr, joinpointIdentification); Object retVal; try &#123; // This is an around advice: Invoke the next interceptor in the chain. // This will normally result in a target object being invoked. // å¦‚æœæœ‰ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨åˆ™æ‰§è¡Œï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°ç›®æ ‡æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç  retVal = invocation.proceedWithInvocation(); &#125; catch (Throwable ex) &#123; // target invocation exception // å½“æ•è·åˆ°å¼‚å¸¸æ—¶å®Œæˆå½“å‰äº‹åŠ¡ ï¼ˆæäº¤æˆ–è€…å›æ»šï¼‰ completeTransactionAfterThrowing(txInfo, ex); throw ex; &#125; finally &#123; cleanupTransactionInfo(txInfo); &#125; if (retVal != null &amp;&amp; vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) &#123; // Set rollback-only in case of Vavr failure matching our rollback rules... TransactionStatus status = txInfo.getTransactionStatus(); if (status != null &amp;&amp; txAttr != null) &#123; retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status); &#125; &#125; // æ ¹æ®äº‹åŠ¡çš„çŠ¶æ€æäº¤æˆ–è€…å›æ»š commitTransactionAfterReturning(txInfo); return retVal; &#125; // çœç•¥äº†ç¼–ç¨‹å¼äº‹åŠ¡çš„å¤„ç† ...&#125; è¿™é‡Œä»£ç å¾ˆå¤šï¼Œæ ¹æ®æ³¨é‡Šçš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ ¸å¿ƒé€»è¾‘æ¢³ç†å‡ºæ¥ è·å–å½“å‰äº‹åŠ¡å±æ€§ï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼ˆä»¥æ³¨è§£äº‹åŠ¡ä¸ºä¾‹ï¼Œè¿™äº›éƒ½å¯ä»¥é€šè¿‡@Transactionalæ¥å®šä¹‰ï¼‰ createTransactionIfNecessaryï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¿…è¦åˆ›å»ºäº‹åŠ¡ invocation.proceedWithInvocation æ‰§è¡Œæ‹¦æˆªå™¨é“¾ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°ç›®æ ‡æ–¹æ³• completeTransactionAfterThrowingå½“æŠ›å‡ºå¼‚å¸¸åï¼Œå®Œæˆè¿™ä¸ªäº‹åŠ¡ï¼Œæäº¤æˆ–è€…å›æ»šï¼Œå¹¶æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ commitTransactionAfterReturning ä»æ–¹æ³•å‘½åæ¥çœ‹ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæäº¤äº‹åŠ¡ã€‚ä½†æ˜¯æ·±å…¥æºç ä¸­ä¼šå‘ç°ï¼Œè¯¥æ–¹æ³•ä¸­ä¹ŸåŒ…å«å›æ»šé€»è¾‘ï¼Œå…·ä½“è¡Œä¸ºä¼šæ ¹æ®å½“å‰TransactionStatusçš„ä¸€äº›çŠ¶æ€æ¥å†³å®šï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®å½“å‰TransactionStatusï¼Œæ¥æ§åˆ¶äº‹åŠ¡å›æ»šï¼Œå¹¶ä¸ä¸€å®šåªèƒ½é€šè¿‡æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œè¯¦è§AbstractPlatformTransactionManager::commit æˆ‘ä»¬ç»§ç»­ï¼Œæ¥çœ‹çœ‹createTransactionIfNecessaryåšäº†ä»€ä¹ˆ TransactionAspectSupport::createTransactionIfNecessary1234567891011121314151617181920212223242526272829protected TransactionInfo createTransactionIfNecessary(@Nullable PlatformTransactionManager tm, @Nullable TransactionAttribute txAttr, final String joinpointIdentification) &#123; // If no name specified, apply method identification as transaction name. if (txAttr != null &amp;&amp; txAttr.getName() == null) &#123; txAttr = new DelegatingTransactionAttribute(txAttr) &#123; @Override public String getName() &#123; return joinpointIdentification; &#125; &#125;; &#125; TransactionStatus status = null; if (txAttr != null) &#123; if (tm != null) &#123; // é€šè¿‡äº‹åŠ¡ç®¡ç†å™¨å¼€å¯äº‹åŠ¡ status = tm.getTransaction(txAttr); &#125; else &#123; if (logger.isDebugEnabled()) &#123; logger.debug("Skipping transactional joinpoint [" + joinpointIdentification + "] because no transaction manager has been configured"); &#125; &#125; &#125; return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);&#125; createTransactionIfNecessaryä¸­çš„æ ¸å¿ƒé€»è¾‘ é€šè¿‡PlatformTransactionManagerï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰å¼€å¯äº‹åŠ¡ prepareTransactionInfo å‡†å¤‡äº‹åŠ¡ä¿¡æ¯ï¼Œè¿™ä¸ªå…·ä½“åšäº†ä»€ä¹ˆæˆ‘ä»¬ç¨åå†è®² ç»§ç»­æ¥çœ‹PlatformTransactionManager::getTransactionï¼Œè¯¥æ–¹æ³•åªæœ‰ä¸€ä¸ªå®ç° AbstractPlatformTransactionManager::getTransaction 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException &#123; // Use defaults if no transaction definition given. TransactionDefinition def = (definition != null ? definition : TransactionDefinition.withDefaults()); // è·å–å½“å‰äº‹åŠ¡ï¼Œè¯¥æ–¹æ³•æœ‰ç»§æ‰¿ AbstractPlatformTransactionManager çš„å­ç±»è‡ªè¡Œå®ç° Object transaction = doGetTransaction(); boolean debugEnabled = logger.isDebugEnabled(); // å¦‚æœç›®å‰å­˜åœ¨äº‹åŠ¡ if (isExistingTransaction(transaction)) &#123; // Existing transaction found -&gt; check propagation behavior to find out how to behave. return handleExistingTransaction(def, transaction, debugEnabled); &#125; // Check definition settings for new transaction. if (def.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123; throw new InvalidTimeoutException("Invalid transaction timeout", def.getTimeout()); &#125; // ä¼ æ’­ç±»å‹PROPAGATION_MANDATORY, è¦æ±‚å½“å‰å¿…é¡»æœ‰äº‹åŠ¡ // No existing transaction found -&gt; check propagation behavior to find out how to proceed. if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123; throw new IllegalTransactionStateException( "No existing transaction found for transaction marked with propagation 'mandatory'"); &#125; // PROPAGATION_REQUIRED, PROPAGATION_REQUIRES_NEW, PROPAGATION_NESTED ä¸å­˜åœ¨äº‹åŠ¡æ—¶åˆ›å»ºäº‹åŠ¡ else if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED || def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW || def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123; SuspendedResourcesHolder suspendedResources = suspend(null); if (debugEnabled) &#123; logger.debug("Creating new transaction with name [" + def.getName() + "]: " + def); &#125; try &#123; // å¼€å¯äº‹åŠ¡ return startTransaction(def, transaction, debugEnabled, suspendedResources); &#125; catch (RuntimeException | Error ex) &#123; resume(null, suspendedResources); throw ex; &#125; &#125; else &#123; // Create "empty" transaction: no actual transaction, but potentially synchronization. if (def.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123; logger.warn("Custom isolation level specified but no actual transaction initiated; " + "isolation level will effectively be ignored: " + def); &#125; boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); return prepareTransactionStatus(def, null, true, newSynchronization, debugEnabled, null); &#125;&#125; ä»£ç å¾ˆå¤šï¼Œé‡ç‚¹å…³æ³¨æ³¨é‡Šéƒ¨åˆ†å³å¯ doGetTransactionè·å–å½“å‰äº‹åŠ¡ å¦‚æœå­˜åœ¨äº‹åŠ¡ï¼Œåˆ™è°ƒç”¨handleExistingTransactionå¤„ç†ï¼Œè¿™ä¸ªæˆ‘ä»¬ç¨åä¼šè®²åˆ° æ¥ä¸‹æ¥ï¼Œä¼šæ ¹æ®äº‹åŠ¡çš„ä¼ æ’­å†³å®šæ˜¯å¦å¼€å¯äº‹åŠ¡ å¦‚æœäº‹åŠ¡ä¼ æ’­ç±»å‹ä¸ºPROPAGATION_MANDATORYï¼Œä¸”ä¸å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ å¦‚æœä¼ æ’­ç±»å‹ä¸º PROPAGATION_REQUIRED, PROPAGATION_REQUIRES_NEW, PROPAGATION_NESTEDï¼Œä¸”å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™è°ƒç”¨startTransactionåˆ›å»ºäº‹åŠ¡ å½“ä¸æ»¡è¶³ 3ã€4æ—¶ï¼Œä¾‹å¦‚ PROPAGATION_NOT_SUPPORTEDï¼Œæ­¤æ—¶ä¼šæ‰§è¡Œäº‹åŠ¡åŒæ­¥ï¼Œä½†æ˜¯ä¸ä¼šåˆ›å»ºçœŸæ­£çš„äº‹åŠ¡ Spring äº‹åŠ¡åŒæ­¥åœ¨ä¹‹å‰ä¸€ç¯‡åšå®¢ä¸­æœ‰è®²åˆ°ï¼Œä¼ é€é—¨ğŸ‘‰https://www.jianshu.com/p/7880d9a98a5f Spring å¦‚ä½•ç®¡ç†å½“å‰çš„äº‹åŠ¡æ¥ä¸‹æ¥è®²è®²ä¸Šé¢æåˆ°çš„doGetTransactionã€handleExistingTransactionï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯ç”±ä¸åŒçš„TransactionManagerè‡ªè¡Œå®ç°çš„ æˆ‘ä»¬ä»¥SpringBooté»˜è®¤çš„TransactionManagerï¼ŒDataSourceTransactionManagerä¸ºä¾‹123456789101112131415@Overrideprotected Object doGetTransaction() &#123; DataSourceTransactionObject txObject = new DataSourceTransactionObject(); txObject.setSavepointAllowed(isNestedTransactionAllowed()); ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(obtainDataSource()); txObject.setConnectionHolder(conHolder, false); return txObject;&#125;@Overrideprotected boolean isExistingTransaction(Object transaction) &#123; DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction; return (txObject.hasConnectionHolder() &amp;&amp; txObject.getConnectionHolder().isTransactionActive());&#125; ç»“åˆ AbstractPlatformTransactionManager::getTransaction ä¸€èµ·æ¥çœ‹ï¼ŒdoGetTransaction å…¶å®è·å–çš„æ˜¯å½“å‰çš„Connectionã€‚åˆ¤æ–­å½“å‰æ˜¯å¦å­˜åœ¨äº‹åŠ¡ï¼Œæ˜¯åˆ¤æ–­DataSourceTransactionObject å¯¹è±¡ä¸­æ˜¯å¦åŒ…å«connectionï¼Œä»¥åŠconnectionæ˜¯å¦å¼€å¯äº†äº‹åŠ¡ã€‚ æˆ‘ä»¬ç»§ç»­æ¥çœ‹ä¸‹TransactionSynchronizationManager.getResource(obtainDataSource())è·å–å½“å‰connectionçš„é€»è¾‘ TransactionSynchronizationManager::getResource12345678910111213141516171819202122232425262728293031323334353637383940private static final ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources = new NamedThreadLocal&lt;&gt;("Transactional resources");@Nullable// TransactionSynchronizationManager::getResourcepublic static Object getResource(Object key) &#123; // DataSourceTransactionManager è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œä»¥æ•°æ®æºä½œä¸ºkey // TransactionSynchronizationUtils::unwrapResourceIfNecessary å¦‚æœkeyä¸ºåŒ…è£…ç±»ï¼Œåˆ™è·å–è¢«åŒ…è£…çš„å¯¹è±¡ // æˆ‘ä»¬å¯ä»¥å¿½ç•¥è¯¥é€»è¾‘ Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key); Object value = doGetResource(actualKey); if (value != null &amp;&amp; logger.isTraceEnabled()) &#123; logger.trace("Retrieved value [" + value + "] for key [" + actualKey + "] bound to thread [" + Thread.currentThread().getName() + "]"); &#125; return value;&#125;/** * Actually check the value of the resource that is bound for the given key. */@Nullableprivate static Object doGetResource(Object actualKey) &#123; Map&lt;Object, Object&gt; map = resources.get(); if (map == null) &#123; return null; &#125; Object value = map.get(actualKey); // Transparently remove ResourceHolder that was marked as void... if (value instanceof ResourceHolder &amp;&amp; ((ResourceHolder) value).isVoid()) &#123; map.remove(actualKey); // Remove entire ThreadLocal if empty... if (map.isEmpty()) &#123; resources.remove(); &#125; value = null; &#125; return value;&#125; çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬èƒ½æ˜ç™½DataSourceTransactionManageræ˜¯å¦‚ä½•ç®¡ç†çº¿ç¨‹ä¹‹é—´çš„Connectionï¼ŒThreadLocal ä¸­å­˜å‚¨ä¸€ä¸ªMapï¼Œkeyä¸ºæ•°æ®æºå¯¹è±¡ï¼Œvalueä¸ºè¯¥æ•°æ®æºåœ¨å½“å‰çº¿ç¨‹çš„Connection DataSourceTransactionManager åœ¨å¼€å¯äº‹åŠ¡åï¼Œä¼šè°ƒç”¨TransactionSynchronizationManager::bindResourceå°†æŒ‡å®šæ•°æ®æºçš„Connectionç»‘å®šåˆ°å½“å‰çº¿ç¨‹ AbstractPlatformTransactionManager::handleExistingTransactionæˆ‘ä»¬ç»§ç»­å›å¤´çœ‹ï¼Œå¦‚æœå­˜åœ¨äº‹åŠ¡çš„æƒ…å†µï¼Œå¦‚ä½•å¤„ç†123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899private TransactionStatus handleExistingTransaction( TransactionDefinition definition, Object transaction, boolean debugEnabled) throws TransactionException &#123; // å¦‚æœäº‹åŠ¡çš„ä¼ æ’­è¦æ±‚ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ æŠ›å‡ºå¼‚å¸¸ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) &#123; throw new IllegalTransactionStateException( "Existing transaction found for transaction marked with propagation 'never'"); &#125; // PROPAGATION_NOT_SUPPORTED å¦‚æœå­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·å½“å‰äº‹åŠ¡ï¼Œä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) &#123; if (debugEnabled) &#123; logger.debug("Suspending current transaction"); &#125; // æŒ‚èµ·å½“å‰äº‹åŠ¡ Object suspendedResources = suspend(transaction); boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); // æ„å»ºä¸€ä¸ªæ— äº‹åŠ¡çš„TransactionStatus return prepareTransactionStatus( definition, null, false, newSynchronization, debugEnabled, suspendedResources); &#125; // PROPAGATION_REQUIRES_NEW å¦‚æœå­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·å½“å‰äº‹åŠ¡ï¼Œæ–°å»ºä¸€ä¸ªäº‹åŠ¡ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) &#123; if (debugEnabled) &#123; logger.debug("Suspending current transaction, creating new transaction with name [" + definition.getName() + "]"); &#125; SuspendedResourcesHolder suspendedResources = suspend(transaction); try &#123; return startTransaction(definition, transaction, debugEnabled, suspendedResources); &#125; catch (RuntimeException | Error beginEx) &#123; resumeAfterBeginException(transaction, suspendedResources, beginEx); throw beginEx; &#125; &#125; // PROPAGATION_NESTED å†…åµŒäº‹åŠ¡ï¼Œå°±æ˜¯æˆ‘ä»¬å¼€å¤´ä¸¾å¾—ä¾‹å­ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123; if (!isNestedTransactionAllowed()) &#123; throw new NestedTransactionNotSupportedException( "Transaction manager does not allow nested transactions by default - " + "specify 'nestedTransactionAllowed' property with value 'true'"); &#125; if (debugEnabled) &#123; logger.debug("Creating nested transaction with name [" + definition.getName() + "]"); &#125; // éJTAäº‹åŠ¡ç®¡ç†å™¨éƒ½æ˜¯é€šè¿‡savePointå®ç°çš„å†…åµŒäº‹åŠ¡ // savePointï¼šå…³ç³»å‹æ•°æ®åº“ä¸­äº‹åŠ¡å¯ä»¥åˆ›å»ºè¿˜åŸç‚¹ï¼Œå¹¶ä¸”å¯ä»¥å›æ»šåˆ°è¿˜åŸç‚¹ if (useSavepointForNestedTransaction()) &#123; // Create savepoint within existing Spring-managed transaction, // through the SavepointManager API implemented by TransactionStatus. // Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization. DefaultTransactionStatus status = prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null); // åˆ›å»ºè¿˜åŸç‚¹ status.createAndHoldSavepoint(); return status; &#125; else &#123; // Nested transaction through nested begin and commit/rollback calls. // Usually only for JTA: Spring synchronization might get activated here // in case of a pre-existing JTA transaction. return startTransaction(definition, transaction, debugEnabled, null); &#125; &#125; // å¦‚æœæ‰§è¡Œåˆ°è¿™ä¸€æ­¥ä¼ æ’­ç±»å‹ä¸€å®šæ˜¯ï¼ŒPROPAGATION_SUPPORTS æˆ–è€… PROPAGATION_REQUIRED // Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED. if (debugEnabled) &#123; logger.debug("Participating in existing transaction"); &#125; // æ ¡éªŒç›®å‰æ–¹æ³•ä¸­çš„äº‹åŠ¡å®šä¹‰å’Œå·²å­˜åœ¨çš„äº‹åŠ¡å®šä¹‰æ˜¯å¦ä¸€è‡´ if (isValidateExistingTransaction()) &#123; if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT) &#123; Integer currentIsolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel(); if (currentIsolationLevel == null || currentIsolationLevel != definition.getIsolationLevel()) &#123; Constants isoConstants = DefaultTransactionDefinition.constants; throw new IllegalTransactionStateException("Participating transaction with definition [" + definition + "] specifies isolation level which is incompatible with existing transaction: " + (currentIsolationLevel != null ? isoConstants.toCode(currentIsolationLevel, DefaultTransactionDefinition.PREFIX_ISOLATION) : "(unknown)")); &#125; &#125; if (!definition.isReadOnly()) &#123; if (TransactionSynchronizationManager.isCurrentTransactionReadOnly()) &#123; throw new IllegalTransactionStateException("Participating transaction with definition [" + definition + "] is not marked as read-only but existing transaction is"); &#125; &#125; &#125; boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER); // æ„å»ºä¸€ä¸ªTransactionStatusï¼Œä½†ä¸å¼€å¯äº‹åŠ¡ return prepareTransactionStatus(definition, transaction, false, newSynchronization, debugEnabled, null);&#125; è¿™é‡Œä»£ç å¾ˆå¤šï¼Œé€»è¾‘çœ‹ä¸Šè¿°æ³¨é‡Šå³å¯ã€‚è¿™é‡Œç»ˆäºçœ‹åˆ°äº†æœŸå¾…å·²ä¹…çš„æŒ‚èµ·äº‹åŠ¡å’Œå†…åµŒäº‹åŠ¡äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯çœ‹ä¸€ä¸‹DataSourceTransactionManagerçš„å®ç° æŒ‚èµ·äº‹åŠ¡ï¼šé€šè¿‡TransactionSynchronizationManager::unbindResource æ ¹æ®æ•°æ®æºè·å–å½“å‰çš„Connectionï¼Œå¹¶åœ¨resourceä¸­ç§»é™¤è¯¥Connectionã€‚ä¹‹åä¼šå°†è¯¥Connectionå­˜å‚¨åˆ°TransactionStatuså¯¹è±¡ä¸­ 1234567// DataSourceTransactionManager::doSuspend@Overrideprotected Object doSuspend(Object transaction) &#123; DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction; txObject.setConnectionHolder(null); return TransactionSynchronizationManager.unbindResource(obtainDataSource());&#125; åœ¨äº‹åŠ¡æäº¤æˆ–è€…å›æ»šåï¼Œè°ƒç”¨ AbstractPlatformTransactionManager::cleanupAfterCompletionä¼šå°†TransactionStatus ä¸­ç¼“å­˜çš„Connectioné‡æ–°ç»‘å®šåˆ°resourceä¸­ å†…åµŒäº‹åŠ¡ï¼šé€šè¿‡å…³ç³»å‹æ•°æ®åº“çš„savePointå®ç°ï¼Œæäº¤æˆ–å›æ»šçš„æ—¶å€™ä¼šåˆ¤æ–­å¦‚æœå½“å‰äº‹åŠ¡ä¸ºsavePointåˆ™é‡Šæ”¾savePointæˆ–è€…å›æ»šåˆ°savePointï¼Œå…·ä½“é€»è¾‘å‚è€ƒAbstractPlatformTransactionManager::processRollback å’Œ AbstractPlatformTransactionManager::processCommit è‡³æ­¤ï¼Œäº‹åŠ¡çš„ä¼ æ’­æºç åˆ†æç»“æŸ prepareTransactionInfoä¸Šæ–‡ç•™ä¸‹äº†ä¸€ä¸ªé—®é¢˜ï¼ŒprepareTransactionInfo æ–¹æ³•åšäº†ä»€ä¹ˆï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹TransactionInfoçš„ç»“æ„123456789101112131415161718protected static final class TransactionInfo &#123; @Nullable private final PlatformTransactionManager transactionManager; @Nullable private final TransactionAttribute transactionAttribute; private final String joinpointIdentification; @Nullable private TransactionStatus transactionStatus; @Nullable private TransactionInfo oldTransactionInfo; // ...&#125; è¯¥ç±»åœ¨Springä¸­çš„ä½œç”¨ï¼Œæ˜¯ä¸ºäº†å†…éƒ¨ä¼ é€’å¯¹è±¡ã€‚ThreadLocalä¸­å­˜å‚¨äº†æœ€æ–°çš„TransactionInfoï¼Œé€šè¿‡å½“å‰TransactionInfoå¯ä»¥æ‰¾åˆ°ä»–çš„oldTransactionInfoã€‚æ¯æ¬¡åˆ›å»ºäº‹åŠ¡æ—¶ä¼šæ–°å»ºä¸€ä¸ªTransactionInfoï¼ˆæ— è®ºæœ‰æ²¡æœ‰çœŸæ­£çš„äº‹åŠ¡è¢«åˆ›å»ºï¼‰å­˜å‚¨åˆ°ThreadLocalä¸­ï¼Œåœ¨æ¯æ¬¡äº‹åŠ¡ç»“æŸåï¼Œä¼šå°†å½“å‰ThreadLocalä¸­çš„TransactionInfoé‡ç½®ä¸ºoldTransactionInfoï¼Œè¿™æ ·çš„ç»“æ„å½¢æˆäº†ä¸€ä¸ªé“¾è¡¨ï¼Œä½¿å¾—Springäº‹åŠ¡åœ¨é€»è¾‘ä¸Šå¯ä»¥æ— é™åµŒå¥—ä¸‹å» å¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Œä½ çš„ç‚¹èµå’Œå…³æ³¨å°±æ˜¯å¯¹æˆ‘æœ€å¤§çš„æ”¯æŒ]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>æºç </tag>
        <tag>SpringBoot</tag>
        <tag>äº‹åŠ¡ä¼ æ’­</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java SPI å®æˆ˜]]></title>
    <url>%2Fpost%2Fe971632b.html</url>
    <content type="text"><![CDATA[SPI å…¨ç§°ä¸º (Service Provider Interface) ï¼Œæ˜¯JDKå†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘ç°æœºåˆ¶ï¼Œå¯ä»¥è½»æ¾å®ç°é¢å‘æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ï¼Œå®ŒæˆæœåŠ¡æä¾›ä¸ä½¿ç”¨çš„è§£è€¦ï¼Œå¹¶ä¸”å¯ä»¥å®ç°åŠ¨æ€åŠ è½½ SPI èƒ½åšä»€ä¹ˆåˆ©ç”¨SPIæœºåˆ¶ï¼Œsdkçš„å¼€å‘è€…å¯ä»¥ä¸ºä½¿ç”¨è€…æä¾›æ‰©å±•ç‚¹ï¼Œä½¿ç”¨è€…æ— éœ€ä¿®æ”¹æºç ï¼Œæœ‰ç‚¹ç±»ä¼¼Spring @ConditionalOnMissingBean çš„æ„æ€ åŠ¨æ‰‹å®ç°ä¸€ä¸ªSPIä¾‹å¦‚æˆ‘ä»¬è¦æ­£åœ¨å¼€å‘ä¸€ä¸ªsdkå…¶ä¸­æœ‰ä¸€ä¸ªç¼“å­˜çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç”¨æˆ·å¾ˆå¯èƒ½ä¸æƒ³ä½¿ç”¨æˆ‘ä»¬çš„ç¼“å­˜å®ç°ï¼Œç”¨æˆ·æƒ³è¦è‡ªå®šä¹‰ç¼“å­˜çš„å®ç°ï¼Œæ­¤æ—¶ä½¿ç”¨spiå°±éå¸¸çš„åˆé€‚äº† æ–°å»ºä¸€ä¸ªmavenå·¥ç¨‹å‘½åä¸ºsdk Cache æ¥å£12345678910111213import java.util.ServiceLoader;public interface Cache &#123; String getName(); static Cache load() &#123; // ServiceLoader å®ç°äº† Iterableï¼Œå¯ä»¥åŠ è½½åˆ°Cacheæ¥å£çš„å¤šä¸ªå®ç°ç±» ServiceLoader&lt;Cache&gt; cacheServiceLoader = ServiceLoader.load(Cache.class); return cacheServiceLoader.iterator().next(); &#125;&#125; ServiceLoader æ˜¯Javaæä¾›æœåŠ¡å‘ç°å·¥å…·ç±»ï¼Œè¿™æ˜¯æˆ‘ä»¬å®ç°SPIçš„å…³é”® CacheDefaultImpl12345public class CacheDefaultImpl implements Cache &#123; public String getName() &#123; return &quot;defaultImpl&quot;; &#125;&#125; é™¤æ­¤ä¹‹å¤–ï¼ŒServiceLoader è¿˜éœ€è¦åœ¨classpath:META-INF/services ä¸‹æ‰¾åˆ°ä»¥è¯¥æ¥å£å…¨åå‘½åçš„æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥åœ¨resource ç›®å½•ä¸‹åˆ›å»ºMETA-INF/services/ com.github.tavenyin.Cacheæ–‡ä»¶å³å¯ï¼Œæ–‡ä»¶ä¸­æŒ‡å®šCacheçš„å®ç°ç±» 12# æ­¤å¤„å¯ä»¥æŒ‡å®šå¤šä¸ªå®ç°ç±»com.github.tavenyin.CacheDefaultImpl Runæˆ‘ä»¬å»ºç«‹ä¸€ä¸ªæ–°çš„mavenå­å·¥ç¨‹ï¼Œå¹¶å¼•å…¥sdkæ¨¡å—ï¼Œæ‰§è¡Œæµ‹è¯•ä»£ç 12System.out.println(Cache.load().getName()) # è¾“å‡ºç»“æœä¸º defaultImpl ä½¿ç”¨è€…å®šåˆ¶åŒ–é‚£ä¹ˆå¦‚æœsdkçš„ä½¿ç”¨è€…ä¸æƒ³ä½¿ç”¨æˆ‘ä»¬çš„CacheDefaultImpläº†æ€ä¹ˆåŠï¼Œæ²¡å…³ç³»ä½¿ç”¨è€…åªéœ€è¦è¦†ç›– classpath:META-INF/services/com.github.tavenyin.Cache å°±å¯ä»¥äº† ï¼ˆä½¿ç”¨è€…åœ¨åŒæ ·åœ¨resourceä¸‹åˆ›å»ºå³å¯è¦†ç›–ï¼‰ æˆ‘ä»¬å†æ¥è¿è¡Œä¸€ä¸‹æµ‹è¯•ä»£ç ï¼Œè¾“å‡ºç»“æœä¸º newImpl ServiceLoader å®ç°åŸç†ServiceLoader çš„å®ç°åŸç†è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå·±å®ç°ä¸€ä¸ªServiceLoaderï¼Œæˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼Ÿ é€šè¿‡æŒ‡å®šçš„æ–‡ä»¶åŠ è½½å‡ºæ‰€æœ‰çš„ç±»å é€šè¿‡åå°„æ„å»ºè¿™äº›å¯¹è±¡ æ²¡é”™ï¼ŒServiceLoader å°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œæˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹æºç  å…¥å£ ServiceLoader::iterator::next 1234567891011121314151617181920212223242526272829303132// Cached providers, in instantiation orderprivate LinkedHashMap&lt;String,S&gt; providers = new LinkedHashMap&lt;&gt;();// The current lazy-lookup iteratorprivate LazyIterator lookupIterator; // ServiceLoader::iteratorpublic Iterator&lt;S&gt; iterator() &#123; return new Iterator&lt;S&gt;() &#123; Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders = providers.entrySet().iterator(); public boolean hasNext() &#123; if (knownProviders.hasNext()) return true; return lookupIterator.hasNext(); &#125; // ServiceLoader::iterator::next public S next() &#123; if (knownProviders.hasNext()) return knownProviders.next().getValue(); return lookupIterator.next(); &#125; public void remove() &#123; throw new UnsupportedOperationException(); &#125; &#125;;&#125; ä»providers åˆå§‹ä¸ºä¸€ä¸ªç©ºçš„LinkedHashMapï¼Œæˆ‘ä»¬æ— éœ€å…³æ³¨ï¼Œæ‰€ä»¥knownProviders::hasNext ä¸€å®šè¿”å›falseï¼Œæˆ‘ä»¬ç›´å¥”knownProviders::next knownProviders::next ä¸­æ ¸å¿ƒé€»è¾‘åœ¨nextService() ä¸­1234567891011121314151617181920212223242526272829303132private S nextService() &#123; // hasNextService ä¸­åšäº†ä¸¤ä»¶äº‹ // 1. åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æœåŠ¡çš„æä¾›è€… // 2. é€šè¿‡ &quot;META-INF/services/&quot; + æ¥å£å…¨å åŠ è½½æ‰€æœ‰æä¾›è€…ClassName if (!hasNextService()) throw new NoSuchElementException(); String cn = nextName; nextName = null; Class&lt;?&gt; c = null; try &#123; // é€šè¿‡ClassName åˆ›å»ºClass c = Class.forName(cn, false, loader); &#125; catch (ClassNotFoundException x) &#123; fail(service, &quot;Provider &quot; + cn + &quot; not found&quot;); &#125; if (!service.isAssignableFrom(c)) &#123; fail(service, &quot;Provider &quot; + cn + &quot; not a subtype&quot;); &#125; try &#123; // åå°„åˆ›å»ºå®ç°ç±»å®ä¾‹ S p = service.cast(c.newInstance()); providers.put(cn, p); return p; &#125; catch (Throwable x) &#123; fail(service, &quot;Provider &quot; + cn + &quot; could not be instantiated&quot;, x); &#125; throw new Error(); // This cannot happen&#125; ä¸æˆ‘ä»¬ä¸Šè¿°åˆ†æçš„å®ç°è¿‡ç¨‹ä¸€è‡´ï¼Œæ›´å¤šç»†èŠ‚æ„Ÿå…´è¶£çš„ç«¥é‹å¯è‡ªè¡Œé˜…è¯» ServiceLoader å¦‚ä½•å®ç°åŠ¨æ€åŠ è½½åŒä¸€ä¸ª ServiceLoader å¯¹è±¡çš„è¯ï¼Œä¸ä¼šé‡æ–°åŠ è½½META-INF/services/ä¸‹çš„ä¿¡æ¯ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦åŠ¨æ€åŠ è½½çš„è¯ï¼Œå¯ä»¥è€ƒè™‘æ¯æ¬¡é‡æ–°åˆ›å»ºæ–°çš„ServiceLoader å¯¹è±¡ï¼Œæˆ–è€…è°ƒç”¨ ServiceLoader::reload demo åœ°å€https://github.com/TavenYin/java-spi.git å¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€æ®·å¤©æ–‡ã€‘ï¼Œä½ çš„ç‚¹èµå’Œå…³æ³¨å°±æ˜¯å¯¹æˆ‘æœ€å¤§çš„æ”¯æŒ]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SPI</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot Websocket å®æˆ˜]]></title>
    <url>%2Fpost%2Fa77ef6c7.html</url>
    <content type="text"><![CDATA[Websocket æ˜¯ä¸€ç§åœ¨å•ä¸ªTCPè¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®ã€‚WebSocketè¿æ¥æˆåŠŸåï¼ŒæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å¯ä»¥åŒå‘é€šä¿¡ã€‚åœ¨éœ€è¦æ¶ˆæ¯æ¨é€çš„åœºæ™¯ï¼ŒWebsocket ç›¸å¯¹äºè½®è¯¢èƒ½æ›´å¥½çš„èŠ‚çœæœåŠ¡å™¨èµ„æºå’Œå¸¦å®½ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ›´å®æ—¶åœ°è¿›è¡Œé€šè®¯ã€‚ ä¸ HTTP åè®®æœ‰ç€è‰¯å¥½çš„å…¼å®¹æ€§ã€‚é»˜è®¤ç«¯å£ä¹Ÿæ˜¯80å’Œ443ï¼Œå¹¶ä¸”æ¡æ‰‹é˜¶æ®µé‡‡ç”¨ HTTP åè®®ï¼Œå› æ­¤æ¡æ‰‹æ—¶ä¸å®¹æ˜“å±è”½ï¼Œèƒ½é€šè¿‡å„ç§ HTTP ä»£ç†æœåŠ¡å™¨ã€‚ ä¾èµ–äºTCPåè®® æ•°æ®æ ¼å¼æ¯”è¾ƒè½»é‡ï¼Œæ€§èƒ½å¼€é”€å°ï¼Œé€šä¿¡é«˜æ•ˆã€‚ å¯ä»¥å‘é€æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥å‘é€äºŒè¿›åˆ¶æ•°æ®ã€‚ æ²¡æœ‰åŒæºé™åˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä¸ä»»æ„æœåŠ¡å™¨é€šä¿¡ã€‚ åè®®æ ‡è¯†ç¬¦æ˜¯wsï¼ˆå¦‚æœåŠ å¯†ï¼Œåˆ™ä¸ºwssï¼‰ï¼ŒæœåŠ¡å™¨ç½‘å€å°±æ˜¯ URLã€‚ SpringBoot ä¸­ä½¿ç”¨ Websocketåœ¨ç®€å•äº†è§£Websocket ä¹‹åï¼Œæˆ‘ä»¬æ¥åŠ¨æ‰‹å®è·µä¸€ä¸‹ã€‚SpringBoot ä¸­æœ‰å¤šç§æ–¹å¼å¯ä»¥å®ç°Websocket Serverï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨Tomcat ä¸­ javax.websocket.server çš„apiæ¥å®ç°ï¼Œç»“å°¾ä¼šç»™å‡ºdemoåœ°å€ å¼•å…¥Mavenä¾èµ– 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;&lt;/dependency&gt; åˆ›å»ºä¸€ä¸ªBeanç”¨äºå¤„ç†Websocket è¯·æ±‚ï¼Œé€šè¿‡ServerEndpoint å£°æ˜å½“å‰Bean æ¥å—çš„Websocket URL è¿™é‡Œä¸ºä»€ä¹ˆå£°æ˜çš„æ˜¯ @Controllerï¼Œåæ–‡ä¼šè§£é‡Š 1234567891011121314151617181920212223242526272829303132333435363738394041import org.springframework.stereotype.Controller;import javax.websocket.*;import javax.websocket.server.ServerEndpoint;@ServerEndpoint(value = &quot;/message_websocket&quot;)@Controllerpublic class MsgWebsocketController &#123; @OnOpen public void onOpen(Session session) &#123; // å…ˆé‰´æƒï¼Œå¦‚æœé‰´æƒé€šè¿‡åˆ™å­˜å‚¨WebsocketSessionï¼Œå¦åˆ™å…³é—­è¿æ¥ï¼Œè¿™é‡Œçœç•¥äº†é‰´æƒçš„ä»£ç  WebSocketSupport.storageSession(session); System.out.println(&quot;session open. ID:&quot; + session.getId()); &#125; /** * è¿æ¥å…³é—­è°ƒç”¨çš„æ–¹æ³• */ @OnClose public void onClose(Session session) &#123; System.out.println(&quot;session close. ID:&quot; + session.getId()); &#125; /** * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³• */ @OnMessage public void onMessage(String message, Session session) &#123; System.out.println(&quot;get client msg. ID:&quot; + session.getId() + &quot;. msg:&quot; + message); &#125; /** * å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”¨ */ @OnError public void onError(Session session, Throwable error) &#123; error.printStackTrace(); &#125;&#125; å£°æ˜ ServerEndpointExporter 123456789@Configurationpublic class WebsocketConfig &#123; @Bean public ServerEndpointExporter serverEndpointExporter() &#123; return new ServerEndpointExporter(); &#125;&#125; è‡³æ­¤ï¼ŒWebsocket Server å·²ç»æ­å»ºå®Œæˆï¼Œå®¢æˆ·ç«¯å·²ç»å¯ä»¥å’ŒæœåŠ¡ç«¯é€šä¿¡äº† æœåŠ¡ç«¯ å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ é€šè¿‡ session.getBasicRemote().sendText(message); å³å¯ æºç æµ…ææˆ‘ä»¬æ¥çœ‹ä¸‹ä¸Šè¿°çš„çŸ­çŸ­å‡ è¡Œä»£ç æ˜¯å¦‚ä½•ä¸ºæˆ‘ä»¬æ„å»º Websocket Server ServerEndpointExporter é‡ç‚¹å…³æ³¨ä¸‹çº¢æ¡†ä¸­çš„å†…å®¹ ServerEndpointExporter å®ç°äº† SmartInitializingSingletonï¼Œä¼šåœ¨bean å®ä¾‹åŒ–ç»“æŸåè°ƒç”¨ afterSingletonsInstantiated ä»Springä¸Šä¸‹æ–‡ä¸­è·å–æ‰€æœ‰æ ‡è®°@ServerEndpointçš„Beançš„name å…¶å® æˆ‘ä»¬å£°æ˜çš„ MsgWebsocketController ä¸­å¹¶ä¸æ˜¯åªèƒ½æ ‡è®°@Controllerï¼Œåªæ˜¯ä¸ºäº†å°†å…¶æ³¨å†Œåˆ°Springå®¹å™¨ä¸­ï¼Œæ–¹ä¾¿ServerEndpointçš„æ³¨å†Œè€Œå·²ï¼Œæ ‡è®° @Controller æ›´ç¬¦åˆSpringçš„å¼€å‘è§„èŒƒ é€šè¿‡ServerContainer å°†æ‰€æœ‰æ ‡è®°@ServerEndpointçš„Bean æ³¨å†Œ ServerContainer é»˜è®¤çš„å®ç°ç±»ä¸º WsServerContainerï¼Œä¼šå¯¹æˆ‘ä»¬çš„ServerEndpointåšä¸€ä¸ªæ˜ å°„ï¼ŒURL =&gt; å¯¹åº”çš„classï¼Œç„¶åé’ˆå¯¹ä¸åŒçš„äº‹ä»¶è°ƒç”¨æŒ‡å®šçš„æ–¹æ³•ï¼ˆä¾‹å¦‚å»ºç«‹è¿æ¥æ—¶è°ƒç”¨æ ‡è®°@Onopençš„æ–¹æ³•ï¼‰ï¼Œè¿™æœ‰ç‚¹Spring DispatcherServlet é‚£å‘³ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±çœ‹ä¸‹ åœ¨äº†è§£äº† Spring ä¸ºæˆ‘ä»¬åšäº†ä»€ä¹ˆåï¼Œæˆ‘ä»¬æ¥å®Œå–„ä¸€ä¸‹æˆ‘ä»¬çš„Demo å»ºç«‹ä¸€ä¸ªSessionManagerå½“æˆ‘ä»¬æƒ³å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å»ºç«‹çš„è¿æ¥ï¼Œä¹Ÿå°±æ˜¯WebscoketSession WsServerContainer ä¸­è™½ç„¶å·²ç»å­˜å‚¨äº† WebscoketSessionï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åŠæ³•ç›´æ¥é€šè¿‡SessionIdï¼Œæˆ–è€…æˆ‘ä»¬çš„ä¸šåŠ¡Id ç›´æ¥å®šä½åˆ°æŒ‡å®šçš„Sessionï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªè‡ªå·±çš„SessionManager 1final ConcurrentHashMap&lt;Object, Session&gt; sessionPool = new ConcurrentHashMap&lt;&gt;(); ä½¿ç”¨ ConcurrentHashMap ç®¡ç†å³å¯ åˆ†å¸ƒå¼æ¨é€è§£å†³ å¦‚å›¾ï¼Œç”¨æˆ·1ä¸æœåŠ¡å™¨Aå»ºç«‹Webscoketï¼Œç”¨æˆ·2ä¸æœåŠ¡å™¨Bå»ºç«‹Webscoketï¼Œé‚£ä¹ˆç”¨æˆ·1å¦‚æœæƒ³å‘ç”¨æˆ·2æ¨é€ä¸€æ¡æ¶ˆæ¯ï¼Œè¯¥å¦‚ä½•å®ç°ï¼Ÿ WebscoketSession å®é™…ä¸Šæ˜¯ç½‘ç»œè¿æ¥ï¼Œå¹¶ä¸åƒæˆ‘ä»¬ä¼ ç»Ÿåº”ç”¨çš„Sessionå¯ä»¥åºåˆ—åŒ–åˆ°Redisï¼Œåªèƒ½æ¯ä¸ªæœåŠ¡å™¨ç®¡ç†è‡ªå·±çš„WebscoketSessionï¼Œæ‰€ä»¥æ­¤æ—¶æœåŠ¡å™¨Aé€šçŸ¥æœåŠ¡å™¨Bï¼Œä½ è¦ç»™ç”¨æˆ·2æ¨é€ä¸€æ¡æ¶ˆæ¯ã€‚ ä¸€ä¸ªæ¯”è¾ƒç®€å•æœ‰æ•ˆçš„å®ç°æ–¹æ³•ï¼Œåˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚ä¸‹å›¾ è¿™ä¸ªæ–¹æ¡ˆä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œç¼ºç‚¹æ˜¯æ¯å°æœåŠ¡å™¨éƒ½éœ€è¦åˆ¤æ–­ä¸€éå½“å‰æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„WebscoketSession ï¼Œæ–¹æ¡ˆç»†åŒ–çš„è¯åˆ™éœ€è¦ç»´æŠ¤ç”¨æˆ·Sessionä¸æ¯å°æœåŠ¡å™¨çš„å…³ç³»ï¼Œè¿™æ ·ç›´æ¥å°†æ¶ˆæ¯æ¨é€ç»™æŒ‡å®šæœåŠ¡å™¨å³å¯ å…¶ä»–é—®é¢˜æµ‹è¯•æ—¶å‘ç°ï¼Œå½“å®¢æˆ·ç«¯æ–­ç½‘åï¼ŒæœåŠ¡ç«¯æ£€æµ‹ä¸åˆ°å®¢æˆ·ç«¯å¤±å»è¿æ¥çš„æƒ…å†µï¼Œä¾ç„¶å¯ä»¥è°ƒç”¨Sessionçš„æ¨é€æ–¹æ³•ï¼ŒæœåŠ¡ç«¯ä¼šä¸€ç›´æŒæœ‰è¿™ä¸ªæ— æ•ˆçš„Session ç›®å‰æƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®WebsocketSessionçš„æœ€å¤§ç©ºé—²æ—¶é—´ï¼ˆsession.setMaxIdleTimeout(milliseconds);ï¼‰ï¼Œå½“è¶…è¿‡è¿™ä¸ªæ—¶é—´æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šå…³é—­Sessionã€‚å‰ç«¯å®šæœŸå‘é€ä¸€æ¡å¿ƒè·³åŒ…ï¼Œç”¨äºç»´æŒSessionï¼Œå½“å‡ºç°ä¸Šè¿°æƒ…å†µæ—¶ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸ä¼šä¸€ç›´æŒæœ‰Sessionäº† å®Œæ•´demoåœ°å€å…³äºdemoçš„ç»†èŠ‚å‚è€ƒé¡¹ç›®åœ°å€ä¸­Readme Github ğŸ‘‰ https://github.com/TavenYin/taven-springboot-learning/tree/master/sp-websocket Gitee ğŸ‘‰ https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/sp-websocket å‚è€ƒhttp://www.ruanyifeng.com/blog/2017/05/websocket.html éƒ¨åˆ†ä»£ç å‚è€ƒäº†ä¸€ä½å…„å¼Ÿçš„åšå®¢ï¼Œä½†æ˜¯ç”±äºæ—¶é—´æœ‰ç‚¹é•¿ï¼Œæ‰¾ä¸åˆ°äº†ï¼Œåœ¨æ­¤è¯´ä¸€å£°æŠ±æ­‰ å¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€æ®·å¤©æ–‡ã€‘ï¼Œç¬¬ä¸€æ—¶é—´æ¥æ”¶åˆ°æˆ‘çš„æ›´æ–°]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Websocket</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Redisèƒ½å¦ä¿è¯æ•°æ®é«˜å¯é æ€§]]></title>
    <url>%2Fpost%2Ff4cc44a4.html</url>
    <content type="text"><![CDATA[è®°å½•ä¸‹å·¥ä½œä¸­å…³äºRedisçš„ä¸€äº›æ€è€ƒï¼Œä¸»è¦å…³äºRedisçš„äº‹åŠ¡ï¼Œè„šæœ¬ï¼ŒæŒä¹…åŒ– æœ¬æ–‡è®¨è®ºçš„é—®é¢˜ï¼š Redisçš„äº‹åŠ¡æˆ–è€…æ‰§è¡Œluaè„šæœ¬å¯ä»¥åƒå…³ç³»å‹æ•°æ®åº“äº‹åŠ¡é‚£æ ·ï¼Œè¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šå—ï¼Ÿ å½“è„šæœ¬æˆ–è€…äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå®•æœºRedisä¸­çš„æ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ åŸå­æ€§åœ¨Redisçš„å¼€å‘æ–‡æ¡£ä¸­å¯ä»¥äº†è§£åˆ°ï¼ŒRedisçš„äº‹åŠ¡ä»¥åŠRedisæ‰§è¡Œluaè„šæœ¬éƒ½å¯ä»¥ä¿è¯åŸå­æ€§ï¼ˆRedisçš„æ¯æ¡å‘½ä»¤ä¹Ÿæ˜¯åŸå­çš„ï¼‰ï¼Œé‚£ä¹ˆåŸå­æ€§å¯ä»¥ä¿è¯ä»€ä¹ˆï¼Ÿèƒ½å¦è§£å†³æˆ‘ä»¬çš„é—®é¢˜ï¼Ÿå…ˆæ¥çœ‹ä¸‹åŸå­æ€§çš„å®šä¹‰ æ¥è‡ªç»´åŸºç™¾ç§‘å¯¹å…³ç³»å‹æ•°æ®åº“äº‹åŠ¡åŸå­æ€§çš„å®šä¹‰ äº‹åŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«æ‰§è¡Œï¼ŒåŒ…å«åœ¨å…¶ä¸­çš„å¯¹æ•°æ®åº“çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ æ¥è‡ªç™¾åº¦ç™¾ç§‘åŸå­æ“ä½œçš„å®šä¹‰ åŸå­æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œåœ¨æ‰§è¡Œå®Œæ¯•ä¹‹å‰ä¸ä¼šè¢«ä»»ä½•å…¶å®ƒä»»åŠ¡æˆ–äº‹ä»¶ä¸­æ–­ Redis æ‰€ä¿è¯çš„åŸå­æ€§æ­£æ˜¯å¦‚æ­¤ ä¸å¯åˆ†å‰²ï¼Œä¿è¯äº‹åŠ¡å’Œè„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤æ‰“æ–­ äº‹åŠ¡å’Œè„šæœ¬ä¸­çš„å‘½ä»¤ï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ Redis Transactionså¦‚ä½•ä½¿ç”¨Redis äº‹åŠ¡12345&gt; MULTI // å¼€å¯äº‹åŠ¡OK&gt; SET KEY VALUE // æ‰§è¡Œå‘½ä»¤ï¼Œæ­¤æ—¶çš„å‘½ä»¤åªæ˜¯å…¥é˜Ÿï¼Œä¼šåœ¨ EXEC ä¹‹ååŸå­æ€§çš„æ‰§è¡Œäº‹åŠ¡ä¸­æ‰€æœ‰å‘½ä»¤QUEUED&gt; EXEC / DISCARD // æ‰§è¡Œæˆ–è€…å–æ¶ˆäº‹åŠ¡ Redisçš„äº‹åŠ¡ä¿è¯ åœ¨Redisäº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ°¸è¿œä¸ä¼šæ‰§è¡Œå¦ä¸€ä¸ªå®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚ æ‰€æœ‰å‘½ä»¤éƒ½ä¼šæ‰§è¡Œï¼Œæˆ–è€…ä¸æ‰§è¡Œã€‚å¦‚æœåœ¨æ‰§è¡Œ EXEC ä¹‹å‰ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å¤±å»å“åº”ï¼Œé‚£ä¹ˆäº‹åŠ¡ä¸­æ‰€æœ‰çš„å‘½ä»¤éƒ½ä¸ä¼šæ‰§è¡Œï¼Œç›¸åå¦‚æœæ‰§è¡Œ EXEC ä¿è¯æ‰€æœ‰çš„å‘½ä»¤éƒ½æ‰§è¡Œã€‚ äº‹åŠ¡ä¸­å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ EXEC ä¹‹å‰ï¼šå‘½ä»¤æ— æ³•Queuedï¼Œä¾‹å¦‚è¯­æ³•é”™è¯¯ï¼ˆé”™è¯¯çš„å‚æ•°æ•°é‡ï¼Œé”™è¯¯çš„å‘½ä»¤ï¼‰ï¼Œæˆ–è€…ä¸€äº›å…¶ä»–é”™è¯¯ï¼Œä¾‹å¦‚å†…å­˜ä¸è¶³ï¼ˆRedisä½¿ç”¨äº†maxmemory é™åˆ¶æœ€å¤§å†…å­˜ï¼‰ EXEC ä¹‹åï¼šå‘½ä»¤ä¹Ÿå¯èƒ½ä¼šå¤±è´¥ï¼Œä¾‹å¦‚é’ˆå¯¹stringç±»å‹ä½¿ç”¨listçš„å‘½ä»¤ EXEC ä¹‹å‰çš„é”™è¯¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æ£€æŸ¥æœåŠ¡ç«¯çš„å“åº”æ¥è§£å†³ï¼Œå½“å‘ç”Ÿå…¥é˜Ÿå¤±è´¥æ—¶ï¼ˆRediså“åº”å€¼éQUEUEDï¼‰ï¼Œå®¢æˆ·ç«¯DISCARDå½“å‰äº‹åŠ¡ ä»Redis 2.6.5å¼€å§‹ï¼ŒRedis ä¼šè®°å½•äº‹åŠ¡æœŸé—´å‘ç”Ÿçš„é”™è¯¯ï¼Œå¹¶æ‹’ç»æ‰§è¡Œäº‹åŠ¡ï¼Œåœ¨æ‰§è¡ŒEXECæ—¶è¿”å›é”™è¯¯ä¿¡æ¯å¹¶è‡ªåŠ¨ä¸¢å¼ƒè¯¥äº‹åŠ¡ ä½†æ˜¯EXEC ä¹‹åçš„é”™è¯¯ï¼Œå³ä½¿å¯¼è‡´éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼ŒRedisè¿˜æ˜¯ä¼šæ‰§è¡Œå…¶ä»–çš„å‰©ä½™å‘½ä»¤ Redis äº‹åŠ¡çš„ä¸å›æ»šæœºåˆ¶è™½ç„¶Redisä¿è¯äº†åŸå­æ€§ï¼Œä½†æ˜¯ä»–çš„äº‹åŠ¡å¹¶ä¸ä¼šåƒå…³ç³»å‹æ•°æ®åº“é‚£æ ·ï¼Œåœ¨Redisäº‹åŠ¡ä¸­å¦‚æœæŸæ¡å‘½ä»¤å‘ç”Ÿäº†é”™è¯¯ï¼Œå…¶ä»–çš„å‘½ä»¤ä¼šä¾æ—§æ‰§è¡Œï¼Œè¿™ç‚¹ç›¸æ¯”è¾ƒå…³ç³»å‹æ•°æ®åº“æ¥è¯´ä¸å…æœ‰äº›â€å¥‡æ€ªâ€äº† Rediså¼€å‘æ–‡æ¡£ä¸­ç»™å‡ºçš„è§£é‡Šå¦‚ä¸‹ åªæœ‰è¯­æ³•é”™è¯¯æ‰å¯èƒ½å¯¼è‡´å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå¤§å¤šæ•°æƒ…å†µéƒ½æ˜¯ç¼–ç¨‹é”™è¯¯å¯¼è‡´çš„ å› ä¸ºä¸éœ€è¦å›æ»šï¼Œä½¿å¾— Redis æ›´ç®€å• æ›´é«˜æ•ˆ å…³äºäº‹åŠ¡çš„æ›´å¤šå†…å®¹ğŸ‘‰ https://redis.io/topics/transactions Redis lua2.6.0 ç‰ˆæœ¬åï¼ŒRedis å¢åŠ äº†å¯¹luaè„šæœ¬çš„æ”¯æŒï¼Œè„šæœ¬å’ŒRedisäº‹åŠ¡ä¸€æ ·ä¿è¯äº†åŸå­æ€§ï¼Œæ‰§è¡Œè„šæœ¬æ—¶ä¸ä¼šæ‰§è¡Œå…¶ä»–è„šæœ¬æˆ–Rediså‘½ä»¤ï¼ˆæ‰€ä»¥ä¸è¦è®©è„šæœ¬è¿è¡Œæ—¶é—´è¿‡é•¿ï¼‰ï¼ŒåŒæ ·è„šæœ¬ä¹Ÿæ²¡æœ‰å›æ»šæœºåˆ¶ï¼Œå½“è„šæœ¬ä¸­å‡ºç°luaçš„å¼‚å¸¸ï¼Œæˆ–è€…Rediså‘½ä»¤é”™è¯¯ï¼Œä¹Ÿæ— æ³•ä¿è¯å…¨éƒ¨æ‰§è¡ŒæˆåŠŸ Redis lua å’Œäº‹åŠ¡æœ‰ç‚¹ç±»ä¼¼ï¼Œä½†æ˜¯æœ‰äº›åœºæ™¯ä½¿ç”¨äº‹åŠ¡æ˜¯æ— æ³•åšåˆ°çš„ï¼Œä¾‹å¦‚æˆ‘æƒ³å¯¹Redisä¸­çš„æ•°æ®å…ˆè¯»ï¼Œç„¶åæ ¹æ®åŸæœ‰æ•°æ®å˜æ›´ï¼Œæ•´ä¸ªè¿‡ç¨‹æƒ³è¦ä¿è¯åŸå­æ€§ï¼Œç”±äºäº‹åŠ¡åœ¨EXECä¹‹å‰æ— æ³•è·å–è¿”å›å€¼ï¼Œä½¿ç”¨lua å°±éå¸¸åˆé€‚ å…³äºRedis lua æ›´å¤šå†…å®¹ ğŸ‘‰ https://redis.io/commands/eval Redis æ‰§è¡Œå‘½ä»¤æ—¶å®•æœºæ•°æ®ä¼šä¸¢å¤±å—çœ‹åˆ°äº†è¿™ï¼Œç¬¬ä¸€ä¸ªé—®é¢˜æˆ‘ä»¬å·²ç»æ¸…æ¥šäº†ï¼ŒRediså¹¶æ²¡æœ‰å›æ»šçš„èƒ½åŠ›ï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™äº›éœ€è¦å›æ»šçš„åœºæ™¯éƒ½æ˜¯ç¼–ç é”™è¯¯ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥é¿å…çš„ã€‚æˆ‘ä»¬ç»§ç»­æ¢å¯»ç¬¬äºŒä¸ªé—®é¢˜çš„ç­”æ¡ˆ Redisæ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œæ‰€ä»¥å½“å‘ç”Ÿå®•æœºæˆ–è€…åœæ­¢åé‡æ–°å¯åŠ¨æ—¶ï¼ŒRedisä¼šä½¿ç”¨ç£ç›˜ä¸Šçš„æŒä¹…åŒ–æ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œæ‰€ä»¥æ˜¯å¦èƒ½æ¢å¤æ•°æ®ï¼Œèƒ½æ¢å¤å¤šå°‘æ•°æ®ï¼Œå–å†³äºä½¿ç”¨å“ªä¸€ç§æŒä¹…åŒ–ç­–ç•¥ ç®€å•è¯´ä¸‹ä¸¤ç§æŒä¹…åŒ–ç­–ç•¥ RDBæŒ‰æŒ‡å®šçš„æ—¶é—´é—´éš”å°†å†…å­˜ä¸­æ•°æ®é›†å†™å…¥å¿«ç…§ AOFAOFä¼šè®°å½•æœåŠ¡å™¨æ¥æ”¶çš„æ¯ä¸ªå†™å…¥æ“ä½œã€‚å½“Rediså‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œå‘½ä»¤ä¼šè¢«ä¼ æ’­åˆ°AOFç¨‹åºä¸­ã€‚AOF çš„ä¸‰ç§åŒæ­¥ç­–ç•¥ appendfsync always ï¼šæ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šåŒæ­¥åˆ°AOFæ–‡ä»¶ appendfsync everysec ï¼šæ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼ŒAOFçš„é»˜è®¤ç­–ç•¥ appendfsync no ï¼šå°†æ•°æ®åŒæ­¥å°†ç»™æ“ä½œç³»ç»Ÿç®¡ç†ï¼Œé€šå¸¸linuxç³»ç»Ÿ30sä¼šåŒæ­¥ä¸€æ¬¡æ•°æ®ï¼Œä½†è¿™å–å†³äºæ“ä½œç³»ç»Ÿ å³ä½¿ä½¿ç”¨always ä¹Ÿæ— æ³•ä¿è¯å†™å…¥çš„æ¯ä¸€æ¡å‘½ä»¤éƒ½è¢«æŒä¹…åŒ–ï¼Œä»å‘½ä»¤æ‰§è¡ŒæˆåŠŸåˆ°æ•°æ®ä¿å­˜åˆ°ç¡¬ç›˜ä¹‹é—´ï¼Œè¿˜æ˜¯æœ‰ä¸€æ®µéå¸¸å°çš„é—´éš” å›åˆ°æˆ‘ä»¬çš„é—®é¢˜ä¸Šï¼Œå¦‚æœä½¿ç”¨RDBï¼Œæ¯«æ— ç–‘é—®ï¼Œæ•°æ®åªèƒ½æ¢å¤åˆ°ä¸Šæ¬¡çš„å¤‡ä»½ å³ä½¿ä½¿ç”¨AOFçš„è¯ï¼Œå¦‚æœåœ¨Redisäº‹åŠ¡æ‰§è¡ŒæœŸé—´å®•æœºï¼Œé‚£ä¹ˆè¿™æ¬¡äº‹åŠ¡è¿˜æ˜¯ç›¸å½“äºâ€æ²¡æœ‰æ‰§è¡Œâ€ï¼Œç”±äºå‘½ä»¤è¿˜æ²¡æ¥åŠå†™å…¥AOFï¼Œåœ¨æœåŠ¡æ¢å¤åæ›´ä¸å¯èƒ½æ¢å¤æ•°æ®ã€‚å¯¹äºRediså®¢æˆ·ç«¯è€Œè¨€ï¼Œä¼šæ”¶åˆ°æœåŠ¡ç«¯çš„å¼‚å¸¸å“åº” å†™å…¥AOFçš„è¿‡ç¨‹ä¹Ÿæ˜¯ä¼šè¢«æ‰“æ–­çš„ï¼ŒRedis æ–‡æ¡£ä¸­æåˆ°ï¼Œå¦‚æœRedisæœåŠ¡å™¨çªç„¶å´©æºƒï¼Œå¯¼è‡´å‡ºç°äº†â€åŠå†™çŠ¶æ€â€çš„AOFæ–‡ä»¶æ—¶ï¼ŒæœåŠ¡å™¨é‡æ–°å¯åŠ¨æ—¶ï¼Œä¼šæ£€æµ‹åˆ°è¿™ç§æƒ…å†µï¼Œå¹¶ä¸”é€€å‡ºæç¤ºç”¨æˆ·ä½¿ç”¨ redis-check-aof ä¿®å¤ AOF æ–‡ä»¶ã€‚â€åŠå†™çŠ¶æ€â€çš„äº‹åŠ¡æˆ–è€…å‘½ä»¤ä¼šè¢«åˆ é™¤ï¼ŒæœåŠ¡å™¨å¯ä»¥é‡æ–°å¯åŠ¨ã€‚ å¦‚æœå†™å…¥AOFè¿‡ç¨‹è¢«æ‰“æ–­ï¼Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€å¯èƒ½æ˜¯æ¯«æ— æ„ŸçŸ¥çš„ï¼ˆçœ‹äº†ä¸‹Rediså‘½ä»¤æ‰§è¡Œç›¸å…³ï¼ŒAOFåº”è¯¥æ˜¯å‘ç”Ÿåœ¨å“åº”å®¢æˆ·ç«¯ä¹‹åï¼‰ æ‰€ä»¥ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿæ¸…æ¥šäº†ï¼ŒRedis å¹¶ä¸èƒ½ä¿è¯æˆ‘ä»¬å†™å…¥çš„æ•°æ®éƒ½å®‰å…¨çš„æŒä¹…åŒ– å…³äºæŒä¹…åŒ–çš„æ›´å¤šå†…å®¹ğŸ‘‰ https://redis.io/topics/persistence æ‰©å±•ï¼šè„šæœ¬å¦‚ä½•æŒä¹…åŒ–è¿™é‡Œè¯´çš„æ˜¯AOFçš„æƒ…å†µ åœ¨Redis 5 ä¹‹å‰ï¼Œé»˜è®¤æ˜¯å°†è„šæœ¬æœ¬èº«ä¼ æ’­åˆ°AOFä¸­ã€‚è¿™ç§ä¼ æ’­æ–¹å¼çš„å¥½å¤„ï¼Œä¸éœ€è¦å°†è„šæœ¬è½¬æˆRediså‘½ä»¤ï¼Œåœ¨å†™å…¥AOFæˆ–è€…å…¶ä»–Rediså®ä¾‹æ—¶ä¸ä¼šå ç”¨è¿‡å¤šçš„å¸¦å®½å’ŒCPU å¤åˆ¶è„šæœ¬ä¸å…è®¸è„šæœ¬ä¸­å‡ºç°éšæœºæ€§çš„å†™å…¥ï¼Œå› ä¸ºè¿™ä¼šå¯¼è‡´é€šè¿‡AOFæ¢å¤æ•°æ®æ—¶ï¼Œæ•°æ®ä¸ä¸€è‡´ï¼Œåœ¨è¿™ç‚¹ä¸ŠRedisåšäº†ä¸€äº›é™åˆ¶ï¼Œç”±äºä¸æ˜¯æœ¬æ–‡é‡ç‚¹å°±ä¸å¤šè¯´äº†ï¼Œå¯ä»¥å‚è€ƒRediså¼€å‘æ–‡æ¡£ ä»Redis 3.2 å¼€å§‹æ–°å¢äº†ä¸€ç§è„šæœ¬å¤åˆ¶æ–¹å¼ script effects replicationï¼ˆRedis 5 å¼€å§‹é»˜è®¤ä½¿ç”¨è¿™ç§æ–¹å¼å¤„ç†è„šæœ¬ï¼‰ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼ŒRedis ä¼šæ”¶é›†è„šæœ¬ä¸­æ‰€æœ‰ä¿®æ”¹æ•°æ®çš„å‘½ä»¤ã€‚å½“è„šæœ¬æ‰§è¡Œå®Œæˆåï¼Œè¿™äº›å‘½ä»¤è¢«åŒ…è£…æˆä¸€ä¸ªäº‹åŠ¡ï¼Œä¼ æ’­åˆ°AOF å’Œå…¶ä»–å®ä¾‹ã€‚ è¿™ç§æ–¹å¼çš„å¥½å¤„ å½“è„šæœ¬æ‰§è¡Œå¾ˆæ…¢çš„æ—¶å€™ï¼Œä¼šå½±å“åŠ è½½AOFé‡å»ºæ•°æ®çš„æ—¶é—´ï¼Œè¿™ç§æƒ…å†µä½¿ç”¨ script effects replication æ•ˆç‡æ›´é«˜ è¿™ç§æ–¹å¼ä¼šå…è®¸è„šæœ¬ä¸­å­˜åœ¨éšæœºæ€§çš„å†™å…¥ ä½¿ç”¨æ–¹å¼12-- åœ¨æ‰§è¡ŒRediså‘½ä»¤å‰è°ƒç”¨ï¼ŒæˆåŠŸå¯ç”¨ script effects replication è¿”å›trueredis.replicate_commands() æ€»ç»“æ‰€ä»¥è¯´Redisæ— è®ºæ˜¯äº‹åŠ¡è¿˜æ˜¯è„šæœ¬ï¼Œå¹¶ä¸èƒ½åšåˆ°åƒå…³ç³»å‹æ•°æ®äº‹åŠ¡ä¸€æ ·ï¼Œæ‰€ä»¥é’ˆå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¹¶ä¸é€‚åˆä½¿ç”¨Redis è€Œä¸”ä»æŒä¹…åŒ–æ–¹é¢æ¥è€ƒè™‘ï¼Œè¿™ä¹Ÿä¸æ˜¯Redisçš„å¼ºé¡¹ï¼ŒRedisçš„ä¼˜åŠ¿æ­£æ˜¯åŸºäºå†…å­˜ï¼Œæ‰€ä»¥è¯»å†™æ€§èƒ½é«˜ã€‚è™½ç„¶å®•æœºçš„å¯èƒ½æ€§çœ‹ä¼¼å¾ˆæç«¯ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨äº†æŸä¸ªæœåŠ¡åï¼Œæˆ‘ä»¬ä¼šå°½å¯èƒ½çš„ä¿è¯å®ƒçš„é«˜å¯ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦çŸ¥é“Redisçš„â€æŒä¹…åŒ–â€å¹¶ä¸èƒ½ä¿è¯æˆ‘ä»¬çš„æ•°æ®ç»å¯¹å®‰å…¨ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯å¯¹æ•°æ®ä¸€è‡´æ€§ï¼ŒæŒä¹…åŒ–è¦æ±‚å¾ˆé«˜çš„æ—¶å€™ï¼Œå…³ç³»å‹æ•°æ®åº“ä¾æ—§æ˜¯å¾ˆå¥½çš„é€‰æ‹© å‚è€ƒRedis è®¾è®¡ä¸å®ç° AOFRedis è®¾è®¡ä¸å®ç° äº‹åŠ¡Redis å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹(ä¸Š)Redis å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹(ä¸‹)]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java ThreadLocal å®ç°åŸç†]]></title>
    <url>%2Fpost%2F764a84a5.html</url>
    <content type="text"><![CDATA[ThreadLocal çº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œç®—æ˜¯Javaå¼€å‘ä¸­æ¯”è¾ƒå¸¸ç”¨çš„APIäº†ï¼Œä»Šå¤©æˆ‘ä»¬æ¥ä¸€æ¢ç©¶ç«Ÿ ä½¿ç”¨åœºæ™¯ThreadLocal é€‚ç”¨äºæ¯ä¸ªçº¿ç¨‹éœ€è¦è‡ªå·±ç‹¬ç«‹çš„å®ä¾‹ä¸”è¯¥å®ä¾‹éœ€è¦åœ¨å¤šä¸ªæ–¹æ³•ä¸­è¢«ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯å˜é‡åœ¨çº¿ç¨‹é—´éš”ç¦»ï¼Œè€Œåœ¨åŒä¸€çº¿ç¨‹å…±äº«çš„åœºæ™¯ã€‚ä¾‹å¦‚ç®¡ç†Connectionï¼Œæˆ‘ä»¬å¸Œæœ›æ¯ä¸ªçº¿ç¨‹åªä½¿ç”¨ä¸€ä¸ªConnectionå®ä¾‹ï¼Œè¿™ä¸ªæ—¶å€™ç”¨ThreadLocalå°±å¾ˆåˆé€‚ã€‚ 12345678910111213141516public class ThreadLocalDemo &#123; private static final ThreadLocal&lt;Object&gt; threadLocal = new ThreadLocal&lt;&gt;(); public static void main(String[] args) &#123; threadLocal.set(new Object()); someMethod(); &#125; static void someMethod() &#123; // è·å–åœ¨threadLocalä¸­å­˜å‚¨çš„å¯¹è±¡ threadLocal.get(); // æ¸…é™¤ThreadLocalä¸­æ•°æ® threadLocal.remove(); &#125;&#125; è¿˜æœ‰ä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡åŠ¨æ€åˆ‡æ¢æ•°æ®æº https://www.jianshu.com/p/0a485c965b8bï¼ŒAOP é€šè¿‡ ThreadLocal ä¿å­˜å½“å‰çº¿ç¨‹éœ€è¦è®¿é—®çš„æ•°æ®æºçš„keyï¼ŒAbstractRoutingDataSource å†é€šè¿‡ ThreadLocal ä¸­çš„æ•°æ®åˆ‡æ¢åˆ°æŒ‡å®šçš„æ•°æ®æºï¼Œå¯¹ä¸šåŠ¡ä»£ç æ¯«æ— å…¥ä¾µ åŸç†åœ¨æˆ‘ä»¬äº†è§£äº†å¦‚ä½•ä½¿ç”¨ä¹‹åï¼Œæ¥çœ‹ä¸‹ ThreadLocal æ˜¯å¦‚ä½•å®ç°çš„ ThreadLocal.get()æˆ‘ä»¬ä»getæ–¹æ³•æ¥åˆ†æï¼Œå¯ä»¥çœ‹åˆ°æ–¹æ³•ä¸­è·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶é€šè¿‡å½“å‰çº¿ç¨‹å¾—åˆ°ä¸€ä¸ª ThreadLocalMapï¼Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶æŠŠè¿™ä¸ªThreadLocalMap ç†è§£ä¸ºæˆ‘ä»¬ç†Ÿæ‚‰çš„HashMapï¼Œç„¶åé€šè¿‡ thisï¼ˆå½“å‰ThreadLocalå¯¹è±¡ï¼‰ä½œä¸ºkeyï¼Œä»Mapä¸­è·å–Entry æˆ‘ä»¬å†æ¥çœ‹ä¸‹ï¼ŒThreadLocalMap ä»¥åŠThreadLocalMap.Entry ä¸­çš„æ ¸å¿ƒæˆå‘˜å˜é‡ï¼ŒThreadLocalMap ä¸­å®ç°äº†ä¸€ä¸ªç®€å•çš„hashè¡¨ çœ‹åˆ°è¿™é‡Œä½ å¯èƒ½è¿˜ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œç»“åˆä¸‹é¢è¿™å¼ å›¾ç†è§£ä¸€ä¸‹ï¼Œæ¯ä¸ªçº¿ç¨‹ï¼ˆThreadå¯¹è±¡ï¼‰ä¸­æœ‰ä¸€ä¸ªThreadLocalMapï¼Œä½¿çº¿ç¨‹ä¹‹é—´çš„æ•°æ®å¤©ç„¶éš”ç¦»ï¼ŒThreadLocalMap æœ‰ä¸€å¼ hashè¡¨ Entry[]ï¼Œæ¯ä¸ª Entry ä¸­å¯¹åº”å­˜å‚¨ç€ä¸€ä¸ªThreadLocalå®ä¾‹ - valueï¼Œè¿™æ ·ä½¿å¾—ä¸åŒçš„ThreadLocal å¯¹è±¡ä¹‹é—´ä¹Ÿå½¢æˆäº†éš”ç¦» ThreadLocalMap ä¸­çš„hashè¡¨æˆ‘ä»¬é€šè¿‡ ThreadLocalMap.set() æ¥äº†è§£ä¸‹å†…éƒ¨çš„hashè¡¨æ˜¯å¦‚ä½•å®ç°çš„ çº¿æ€§æ¢æµ‹æ˜¯æŒ‡å½“å‘ç”Ÿhashå†²çªæ—¶ï¼Œåˆ©ç”¨å›ºå®šçš„ç®—æ³•å¯»æ‰¾ä¸€å®šæ­¥é•¿çš„ä¸‹ä¸ªä½ç½®ï¼ˆThreadLocalä¸­å‘ç”Ÿhashå†²çªæ—¶ï¼Œindex+1ï¼‰ï¼Œä¾æ¬¡åˆ¤æ–­ï¼Œç›´è‡³æ‰¾åˆ°èƒ½å¤Ÿå­˜æ”¾çš„ä½ç½® å¦‚æœçº¿ç¨‹ä¸­æ“ä½œäº†å¤§é‡çš„ ThreadLocal å¯¹è±¡ï¼ŒåŠ¿å¿…ä¼šé€ æˆhashå†²çªï¼Œè¿™æ˜¯æ²¡æœ‰å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åªä¿ç•™ä¸€ä¸ªThreadLocalå¯¹è±¡ å…³äº ThreadLocal çš„ä¸€äº›æ€è€ƒ ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¼±å¼•ç”¨ å›¾3ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°hashè¡¨ä¸­ä¼šå‡ºç° key == nullçš„Entryï¼Œè¿™æ˜¯å› ä¸º ThreadLocalMap.Entry çš„key ï¼ˆEntry å¯¹ThreadLocalè®¾ç½®äº†å¼±å¼•ç”¨ï¼Œå¯ä»¥å›é¡¾ä¸€ä¸‹å›¾2ï¼‰ å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨GCæ—¶ï¼Œä¸€æ—¦å‘ç°äº†å¯¹è±¡åªå…·æœ‰å¼±å¼•ç”¨ï¼Œè¿™ä¸ªå¯¹è±¡ä¸€å®šè¢«å›æ”¶ è¿™ä¹ˆåšçš„åŸå› ï¼šå¦‚æœThreadLocal å¯¹è±¡éœ€è¦è¢«å›æ”¶æ—¶ï¼ˆæ­¤æ—¶å¹¶æ²¡æœ‰è°ƒç”¨ThreadLocal.removeï¼‰ï¼Œçº¿ç¨‹ä¸­çš„ThreadLocalMap ä¸€ç›´å¼ºå¼•ç”¨ç€ ThreadLocalå¯¹è±¡ï¼Œè¿™ä¼šè®© ThreadLocalå¯¹è±¡ ä»¥åŠå¯¹åº”çš„valueå¯¹è±¡å†…å­˜æ— æ³•é‡Šæ”¾ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚è¿™ç®—æ˜¯ThreadLocalçš„ä¸€ç§å®¹é”™æœºåˆ¶ï¼Œè¿™æ ·åšä½¿å¾—äº†ThreadLocalå¯¹è±¡å¾—åˆ°äº†å›æ”¶ï¼Œä½†æ˜¯valueçš„å†…å­˜å¹¶æ²¡æœ‰é‡Šæ”¾ï¼Œæ‰€ä»¥ThreadLocalMap çš„getã€setæ–¹æ³•ä¸­éƒ½ä¼šå»å°è¯•æ¸…ç†ThreadLocalå·²ç»è¢«å›æ”¶çš„entryã€‚ ä½¿ç”¨è¿‡åä¸åŠæ—¶removeä¼šæ€ä¹ˆæ · å¾ˆå¤šåšå®¢ä¸­éƒ½å¼ºè°ƒäº†ï¼ŒThreadLocal.removeçš„é‡è¦æ€§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æ–°å¯äº†ä¸€ä¸ªçº¿ç¨‹åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨äº†ThreadLocalï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è°ƒç”¨removeï¼Œè¿™ä¼šå¯¼è‡´å­˜å‚¨çš„valueå¯¹è±¡ä¸€ç›´æ²¡æœ‰åŠæ³•è¢«å›æ”¶ï¼Œç›´åˆ°çº¿ç¨‹è¢«é”€æ¯ çº¿ç¨‹æ± ä¸­ä¹Ÿéœ€è¦removeå— ä»¥webçº¿ç¨‹æ± ä¸ºä¾‹ï¼Œå¦‚æœæ¯æ¬¡éƒ½åœ¨è¿‡æ»¤å™¨ä¸­æ“ä½œåŒä¸€ä¸ªThreadLocal.setï¼Œç„¶åä¸šåŠ¡ä»£ç ä¸­getï¼Œä¼¼ä¹æ²¡ä»€ä¹ˆé—®é¢˜ã€‚è®¡ç®—å‡ºçš„hashå€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ§½ä½ä¹Ÿæ˜¯ä¸€æ ·çš„ä¼šè¦†ç›–ä¸Šä¸€æ¬¡çš„å€¼ã€‚ç¡®å®ä¸šåŠ¡ä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯æ¨èå¤§å®¶åœ¨ä½¿ç”¨å®Œä¹‹åremoveï¼Œå› ä¸ºè¿™æ ·ä¼šè®©æ— ç”¨çš„valueå¯¹è±¡æ—©ç‚¹è¢«å›æ”¶ï¼Œåœ¨å¾ˆå¤šjavaæºç ä¸­éƒ½ä¼šçœ‹åˆ°ï¼Œå¯¹ä¸€äº›ä¸å†ä½¿ç”¨çš„å¯¹è±¡è¿›è¡Œå¦‚ä¸‹çš„help GCæ“ä½œ1object = null // help GC æ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦è®©æ— ç”¨çš„å¯¹è±¡å¤±å»å¼•ç”¨ï¼Œå¸®åŠ©GC ç»¼ä¸Šæ‰€è¿° ThreadLocal ä½¿ç”¨è¿‡åè¦åŠæ—¶removeï¼Œå¸®åŠ©JVMé‡Šæ”¾å†…å­˜ å‚è€ƒhttps://www.jianshu.com/p/98b68c97df9b]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>æºç </tag>
        <tag>Thread</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”µå•†æŠ€æœ¯--åº“å­˜è®¾è®¡æŒ‡åŒ—]]></title>
    <url>%2Fpost%2Fc4f13c61.html</url>
    <content type="text"><![CDATA[å‰è¨€æœ€è¿‘åœ¨è§£å†³ä¸€å¥—è€ç”µå•†ç³»ç»Ÿçš„åº“å­˜â€è¶…å–â€é—®é¢˜ã€‚ä¸€ç›´ä»¥ä¸ºè¶…å–é—®é¢˜ï¼Œæœ€éš¾è§£å†³çš„æ˜¯åº“å­˜æ‰£å‡ï¼Œå®åˆ™ä¸ç„¶ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿåœ¨è§£å†³äº†åº“å­˜æ‰£å‡é—®é¢˜ä¹‹åï¼Œè¿˜ä¼šä¸€ç›´æœ‰â€œè¶…å–â€ç°è±¡ï¼Ÿè¿™ä¸€åˆ‡çš„èƒŒååˆ°åº•æ˜¯é“å¾·çš„æ²¦ä¸§ï¼Œè¿˜æ˜¯äººæ€§çš„æ‰­æ›²ï¼Œæ¬¢è¿æ”¶çœ‹æœ¬æœŸèµ°è¿‘ç§‘å­¦ æœ¬æ–‡å¸¦ä½ è§£å†³ä»¥ä¸‹ç”µå•†åœºæ™¯é—®é¢˜ ä¿è¯åº“å­˜çº¿ç¨‹å®‰å…¨çš„æ‰£å‡ é˜²æ­¢åº“å­˜çš„å¤šæ¬¡æ‰£å‡ã€å›æ»š è¶…æ—¶æœªæ”¯ä»˜è¢«å–æ¶ˆçš„è®¢å•ï¼ˆå–æ¶ˆä¼šå›æ»šåº“å­˜ï¼‰ï¼Œ å¦‚æœæ”¶åˆ°äº†æ”¯ä»˜å›è°ƒæ€ä¹ˆåŠ å¦‚ä½•çº¿ç¨‹å®‰å…¨çš„æ‰£å‡åº“å­˜å…ˆæ¥è¯´è¯´åº“å­˜æ‰£å‡çš„é—®é¢˜ï¼Œè¿™æ˜¯æˆ‘ä»¬åŸæ¥è€ç³»ç»Ÿçš„é€»è¾‘ï¼Œæ³¨æ„ï¼è¿™é‡Œæ˜¯é”™è¯¯çš„ç¤ºä¾‹ 123456789// ä»¥ä¸‹æ˜¯ä¼ªä»£ç ï¼Œé”™è¯¯çš„ç¤ºä¾‹// æŸ¥è¯¢å‡ºGoodså¯¹è±¡$goods = selectGoodsById($id);if ($goods-&gt;num - $order_num &gt; 0) &#123; // è®¡ç®—å‡ºæ‰£å‡åçš„åº“å­˜ $goods-&gt;num = $goods-&gt;num - $order_num; // ä¿å­˜ save($goods);&#125; ä¸Šè¿°ä»£ç çŠ¯äº†å¤§å¿Œï¼Œå¹¶å‘æƒ…å†µä¼šå¯¼è‡´å¤šä¸ªçº¿ç¨‹è¯»åˆ°ç›¸åŒçš„åº“å­˜æ•°ï¼Œç„¶åæ‰£å‡ï¼Œç„¶åä¿å­˜åˆ°DBï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¯´ä¸‹æ­£ç¡®çš„å§¿åŠ¿ æ­£ç¡®çš„åšæ³•åˆ©ç”¨MySQL update ä¼šæŒæœ‰å½“å‰è®°å½•é”çš„ç‰¹ç‚¹ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨çš„æ‰£å‡ SQL ç¤ºä¾‹ï¼š1update kucun set num = num - ? where id = ? and num - ? &gt;= 0 æˆ‘ä»¬çš„è¿™æ¡è®°å½•æ ¹æ®ä¸»é”®æ›´æ–°ï¼Œå½“äº‹åŠ¡A update è¿™æ¡è®°å½•æ—¶ï¼Œä¼šæŒæœ‰å½“å‰è®°å½•çš„é”ï¼Œå½“äº‹åŠ¡Aæœªæäº¤æ—¶ï¼Œå…¶ä»–æƒ³è¦æ›´æ–°è¿™æ¡è®°å½•çš„äº‹åŠ¡åªèƒ½ç­‰å¾…é”é‡Šæ”¾ å…³äºMySQL update é”çš„ç»†èŠ‚ï¼Œæœ¬æ–‡ä¸è®¨è®ºï¼Œå¯ä»¥å‚è€ƒMySQLæ–‡æ¡£ https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.htmlhttps://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.htmlhttps://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html è™½ç„¶MySQLå¯ä»¥ä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ï¼Œä½†æ˜¯å¤§å¹¶å‘é‡åœºæ™¯ä¸‹ï¼Œå¤§é‡çš„é”ç«äº‰ï¼Œå¯¼è‡´åº“å­˜çš„æ‰£å‡å¯èƒ½æˆä¸ºç³»ç»Ÿæ€§èƒ½çš„ç“¶é¢ˆ ä½¿ç”¨ Redis åº“å­˜æ‰£å‡ä½¿ç”¨Redisçš„ä¼˜åŠ¿å¾ˆå¤šï¼Œå•çº¿ç¨‹çš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä¿è¯äº†å¹¶å‘ä¸‹å¯ä»¥çº¿ç¨‹çš„å®‰å…¨æ‰£å‡ã€å›æ»šåº“å­˜ï¼Œ ä»¥åŠRedisé«˜æ€§èƒ½ã€‚ è™½ç„¶Redisè§£å†³äº†çº¿ç¨‹å®‰å…¨å’Œæ€§èƒ½çš„é—®é¢˜ï¼Œä½†æ˜¯Rediså¹¶ä¸èƒ½åšåˆ°åƒMySQLé‚£æ ·ä¸€æ¡SQLå‘½ä»¤å®Œæˆåº“å­˜æ‰£å‡ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè¯»å‡ºå·²æœ‰åº“å­˜ï¼Œå†å’Œå½“å‰ä¸‹å•åº“å­˜åšä¸€ä¸ªåˆ¤æ–­æ˜¯å¦å¯ä»¥åº“å­˜æ‰£å‡ã€‚æ‰€ä»¥æœ€ä½³çš„å®ç°æ–¹æ¡ˆæ˜¯é€šè¿‡Redis æ‰§è¡Œluaè„šæœ¬ï¼Œä¿è¯æ•´ä¸ªé€»è¾‘å¤„ç†æœŸé—´ï¼Œä¸ä¼šæœ‰å…¶ä»–å®¢æˆ·ç«¯æ’è¿›æ¥ 12345678910111213141516171819202122232425262728293031/** * * æ‰£å‡åº“å­˜Luaè„šæœ¬ * åº“å­˜ï¼ˆstockï¼‰-1ï¼šè¡¨ç¤ºä¸é™åº“å­˜ * åº“å­˜ï¼ˆstockï¼‰0ï¼šè¡¨ç¤ºæ²¡æœ‰åº“å­˜ * åº“å­˜ï¼ˆstockï¼‰å¤§äº0ï¼šè¡¨ç¤ºå‰©ä½™åº“å­˜ * * @params åº“å­˜key * @return * -3:åº“å­˜æœªåˆå§‹åŒ– * -2:åº“å­˜ä¸è¶³ * -1:ä¸é™åº“å­˜ * å¤§äºç­‰äº0:å‰©ä½™åº“å­˜ï¼ˆæ‰£å‡ä¹‹åå‰©ä½™çš„åº“å­˜ï¼‰ */const SUB_STOCK_LUA = &quot; if (redis.call(&apos;exists&apos;, KEYS[1]) == 1) then local stock = tonumber(redis.call(&apos;get&apos;, KEYS[1])); local num = tonumber(ARGV[1]); if (stock == -1) then return -1; end; if (stock &gt;= num) then return redis.call(&apos;incrby&apos;, KEYS[1], 0 - num); end; return -2; end; return -3;&quot;; æ³¨æ„ï¼šå½“å¯¹ä¸€ä¸ªè®¢å•ä¸­çš„ good_list æ‰£å‡åº“å­˜çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„ï¼Œå½“æŸä¸€ä¸ªå•†å“åº“å­˜æ‰£å‡å¤±è´¥æ—¶ï¼Œä¹‹å‰çš„æ‰£å‡çš„å•†å“åº“å­˜éœ€è¦å›æ»šã€‚è¿™ä¼šæ¶‰åŠåˆ°å¯¹redisçš„å¤šæ¬¡æ“ä½œï¼Œä½ å¯ä»¥æŠŠæ•´ä½“é€»è¾‘å†™åˆ°ä¸€ä¸ªluaè„šæœ¬ä¸­ ä½¿ç”¨Redis åšåº“å­˜æ‰£å‡ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼ˆä¼ªä»£ç å¦‚ä¸‹ï¼‰ï¼ŒRedisæ•°æ®å’ŒMySQLæ•°æ®å¹¶ä¸èƒ½ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œå› ä¸ºRedisçš„æ•°æ®ç›¸å½“äºç›´æ¥å†™è¿›å»äº†ï¼Œå¦‚æœåœ¨éœ€è¦å›æ»šçš„æ—¶å€™ï¼ŒRedisä¸å¯ç”¨äº†å¯¼è‡´æ•°æ®æ— æ³•å›æ»šï¼Œæœ€ç»ˆä¼šé€ æˆMySQLæ²¡æœ‰å†™å…¥è®¢å•æ•°æ®ï¼ŒRediså´æ‰£å‡äº†åº“å­˜ 123456789101112try &#123; $db-&gt;beginTransaction(); $db-&gt;saveOrder(); $redis-&gt;reduceStock(); $db-&gt;commit(); &#125; catch (Exception $e) &#123; $db-&gt;rollback(); $redis-&gt;rollbackStock();&#125; è¿™ç§æƒ…å†µå¹¶æ²¡æœ‰ä»€ä¹ˆå¥½çš„è§£å†³åŠæ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡ ç‡éå¸¸å°çš„æ•…éšœï¼Œé¦–å…ˆæˆ‘ä»¬è‚¯å®šè¦å°½å¯èƒ½çš„ä¿è¯Redisçš„é«˜å¯ç”¨æ€§ï¼Œå…¶æ¬¡åœ¨å‘ç”Ÿè¿™ç§æƒ…å†µåï¼Œæˆ‘ä»¬è¦æƒ³åŠæ³•æ¢å¤Redisä¸­çš„æ•°æ®ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥åœ¨æ•´ä¸ªé€»è¾‘ä¹‹åï¼Œé€‰æ‹©å¼‚æ­¥çš„æ–¹å¼ï¼ˆä¾‹å¦‚MQï¼‰å‘MySQLä¸­åŒæ­¥åº“å­˜ï¼Œå½“å‘ç”Ÿæ•…éšœåï¼Œä»¥MySQLæ•°æ®ä¸ºå‡†æ¢å¤æ•°æ® æ‰€ä»¥Redisæ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œæå‡æ€§èƒ½çš„åŒæ—¶ï¼Œä¹Ÿå¸¦æ¥äº†é—®é¢˜ AliSQLè¿™æ˜¯åæ¥æˆ‘åœ¨ç½‘ä¸Šçœ‹åˆ°çš„æ–¹æ¡ˆï¼ŒAliSQL æ˜¯é˜¿é‡Œè‡ªç ” MySQL åˆ†æ”¯ï¼ŒAliSQL é’ˆå¯¹å¹¶å‘ä¿®æ”¹åŒä¸€è®°å½•çš„æƒ…å†µï¼Œä½¿ç”¨æ•°æ®åº“å±‚é¢çš„ç¼“å†²é˜Ÿåˆ—ï¼Œé¿å…å¤§é‡äº‰é”çš„ä»£ä»·ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è¯•ä¸‹ï¼ˆé˜¿é‡Œäº‘MySQL 8.0 é›†æˆäº†è¿™ä¸€åŠŸèƒ½ï¼‰ï¼Œå¦‚æœAliSQLè§£å†³äº†æ€§èƒ½é—®é¢˜çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ¡ˆç›¸æ¯”Redisè¦æ›´å¥½ å…³äºåº“å­˜å¤šæ¬¡æ‰£å‡çš„é—®é¢˜å½“è®¢å•çš„æäº¤å’Œåº“å­˜çš„æ‰£å‡åŒæ­¥è¿›è¡Œçš„æ—¶å€™ï¼Œä¸éœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ã€‚ ä¸¾ä¾‹ï¼šè®¢å•ç³»ç»Ÿç”Ÿæˆè®¢å•ä¹‹åï¼Œé€šè¿‡MQé€šçŸ¥åº“å­˜ç³»ç»Ÿï¼Œåº“å­˜ç³»ç»Ÿå¼‚æ­¥æ‰£å‡åº“å­˜ï¼Œè¿™ä¸ªæ—¶å€™åº“å­˜ç³»ç»Ÿå¯èƒ½ä¼šå¤šæ¬¡æ¶ˆè´¹ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜äº†ã€‚ æˆ–è€…æˆ‘ä»¬ä¸Šé¢è¯´çš„é€šè¿‡MQåŒæ­¥MySQLåº“å­˜ä¹Ÿéœ€è¦è€ƒè™‘å¯èƒ½å‘ç”Ÿå¤šæ¬¡æ‰£å‡ è§£å†³æ–¹æ¡ˆå¦‚å›¾ï¼Œé€šè¿‡è®¢å•åšä¸ºå”¯ä¸€ç´¢å¼•ä¿è¯æµæ°´è®°å½•çš„å”¯ä¸€æ€§ï¼Œä»è€Œä¿è¯åªèƒ½æœ‰ä¸€æ¬¡æˆåŠŸçš„æ‰£å‡ åº“å­˜å›æ»šé—®é¢˜å¤šæ•°åšå®¢å¯¹äºè¶…å–çš„è®²è§£åªåœ¨äºåº“å­˜çš„æ‰£å‡ï¼Œä½†æ˜¯åº“å­˜æ‰£å‡å®‰å…¨äº†ï¼ŒçœŸçš„å°±å¯ä»¥ä¿è¯ä¸è¶…å–å—ï¼Ÿæˆ‘ä»¬çš„ç³»ç»Ÿåœ¨è§£å†³äº†åº“å­˜æ‰£å‡é—®é¢˜åï¼Œè¿˜æ˜¯å‡ºç°æˆäº¤è®¢å• &gt; åº“å­˜çš„é—®é¢˜ï¼Œä¸ºæ­¤æˆ‘ä¹Ÿæ˜¯ç»å°½è„‘æ±ï¼ŒæŠ“ç ´äº†å¤´ åœ¨å¯¹ä¸‹å•è¿›è¡Œå‹åŠ›æµ‹è¯•ä¹‹åï¼Œæˆ‘åšä¿¡ä¸‹å•ä¸ä¼šå‡ºç°è¶…å–çš„é—®é¢˜ï¼Œåæ¥æˆ‘æ€€ç–‘é—®é¢˜å‡ºåœ¨äº†åº“å­˜å›æ»šï¼Œå¦‚æœä¸€ä¸ªè®¢å•å›æ»šäº†ä¸¤æ¬¡åº“å­˜ï¼ˆå–æ¶ˆè¶…æ—¶æœªæ”¯ä»˜è®¢å•çš„çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹åŒæ—¶å–æ¶ˆä¸€ä¸ªè®¢å•ï¼‰ï¼ŒåŒæ ·ä¹Ÿä¼šå‡ºç°è¶…å–çš„ç°è±¡ã€‚ è§£å†³æ–¹æ³•ï¼šå’Œé˜²æ­¢å¤šæ¬¡æ‰£å‡ä¸€æ ·ï¼Œé‡‡ç”¨å†™å…¥è®¢å•å›æ»šæµæ°´çš„æ–¹å¼ï¼Œä¸ªäººè®¤ä¸ºè¿™ç§æ–¹æ³•æ¯”è¾ƒåŠ é”è¦å¥½ï¼Œæ•°æ®æœ‰è¿¹å¯å¾ª è¶…æ—¶æœªæ”¯ä»˜è¢«å–æ¶ˆçš„è®¢å•æ”¶åˆ°äº†æ”¯ä»˜å›è°ƒåœ¨è§£å†³äº†åº“å­˜å›æ»šé—®é¢˜ä¹‹åï¼Œè¶…å–é—®é¢˜è¿˜æ²¡æœ‰è§£å†³ï¼Œæœ€åé€šè¿‡æ—¥å¿—å®šä½åˆ°äº†è¿™ä¸ªé—®é¢˜ã€‚ é—®é¢˜æè¿°ï¼šç”¨æˆ·åœ¨ç³»ç»Ÿå³å°†è‡ªåŠ¨å–æ¶ˆè®¢å•çš„å‰ä¸€ç¬é—´å®Œæˆäº†æ”¯ä»˜ï¼Œç³»ç»Ÿå–æ¶ˆäº†è¯¥è®¢å•å¹¶å›æ»šäº†åº“å­˜ï¼ŒåŒæ—¶ç³»ç»Ÿæ”¶åˆ°äº†è¯¥è®¢å•çš„æ”¯ä»˜å›è°ƒï¼Œè¯¥è®¢å•çš„çŠ¶æ€æ›´æ”¹ä¸ºå·²æ”¯ä»˜ï¼Œå› ä¸ºä¸è¯¥å‡ºç°çš„åº“å­˜å›æ»šå¯¼è‡´äº†â€œè¶…å–â€ ä¸‹é¢è¯´ä¸‹æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆï¼Œä»¥å¾®ä¿¡æ”¯ä»˜ä¸ºä¾‹ æˆ‘ä»¬çš„ç³»ç»Ÿåœ¨æäº¤è®¢å•ä¹‹åï¼Œä¼šè°ƒç”¨å¾®ä¿¡çš„ç»Ÿä¸€ä¸‹å•æ¥å£ï¼Œè¿™æ—¶å€™å¾®ä¿¡æ”¶åˆ°äº†æˆ‘ä»¬çš„å•†æˆ·è®¢å•å·ï¼ˆå¾®ä¿¡å·²ç»ç”Ÿæˆè®¢å•ï¼‰ï¼Œç”¨æˆ·é€‰æ‹©ä¸æ”¯ä»˜ã€‚è¶…æ—¶è‡ªåŠ¨å–æ¶ˆé€»è¾‘å¤„ç†ä¹‹å‰ï¼Œå…ˆè°ƒç”¨å¾®ä¿¡çš„å…³é—­è®¢å•æ¥å£ï¼Œå¦‚æœå…³é—­æˆåŠŸï¼Œåˆ™è¿™ä¸ªæ—¶å€™ç”¨æˆ·åç»­æ— æ³•å¯¹è¯¥è®¢å•å‘èµ·æ”¯ä»˜ã€‚å¦‚æœè¿”å›è®¢å•å·²æ”¯ä»˜ï¼Œåˆ™æ— éœ€å¤„ç†è¯¥è®¢å•ï¼Œè¯¥è®¢å•ä¼šæ”¶åˆ°å¾®ä¿¡æ”¯ä»˜çš„å›è°ƒ å‚è€ƒhttps://www.jianshu.com/p/76bc0e963172https://www.zhihu.com/question/268937734https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_3 å¦‚æœè§‰å¾—æ–‡ç« æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµã€è½¬å‘ã€å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Œä½ çš„æ”¯æŒå°±æ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›]]></content>
      <categories>
        <category>ç”µå•†æŠ€æœ¯</category>
      </categories>
      <tags>
        <tag>ç”µå•†</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ•™ä½ å¦‚ä½•ä½¿ç”¨MySQL8é€’å½’.]]></title>
    <url>%2Fpost%2F2e0c1b4e.html</url>
    <content type="text"><![CDATA[ä¹‹å‰å†™è¿‡ä¸€ç¯‡ MySQLé€šè¿‡è‡ªå®šä¹‰å‡½æ•°çš„æ–¹å¼ï¼Œé€’å½’æŸ¥è¯¢æ ‘ç»“æ„ï¼Œä»MySQL 8.0 å¼€å§‹ç»ˆäºæ”¯æŒäº†é€’å½’æŸ¥è¯¢çš„è¯­æ³• CTEé¦–å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ CTEï¼Œå…¨å Common Table Expressions12345WITH cte1 AS (SELECT a, b FROM table1), cte2 AS (SELECT c, d FROM table2)SELECT b, d FROM cte1 JOIN cte2WHERE cte1.a = cte2.c; cte1, cte2 ä¸ºæˆ‘ä»¬å®šä¹‰çš„CTEï¼Œå¯ä»¥åœ¨å½“å‰æŸ¥è¯¢ä¸­å¼•ç”¨ å¯ä»¥çœ‹å‡º CTE å°±æ˜¯ä¸€ä¸ªä¸´æ—¶ç»“æœé›†ï¼Œå’Œæ´¾ç”Ÿè¡¨ç±»ä¼¼ï¼ŒäºŒè€…çš„åŒºåˆ«è¿™é‡Œä¸ç»†è¯´ï¼Œå¯ä»¥å‚è€ƒä¸‹MySQLå¼€å‘æ–‡æ¡£ï¼šhttps://dev.mysql.com/doc/refman/8.0/en/with.html#common-table-expressions-recursive-examples é€’å½’æŸ¥è¯¢å…ˆæ¥çœ‹ä¸‹é€’å½’æŸ¥è¯¢çš„è¯­æ³•1234567WITH RECURSIVE cte_name AS( SELECT ... -- return initial row set UNION ALL / UNION DISTINCT SELECT ... -- return additional row sets)SELECT * FROM cte; å®šä¹‰ä¸€ä¸ªCTEï¼Œè¿™ä¸ªCTE æœ€ç»ˆçš„ç»“æœé›†å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ â€é€’å½’å¾—åˆ°çš„æ ‘ç»“æ„â€ï¼ŒRECURSIVEä»£è¡¨å½“å‰ CTE æ˜¯é€’å½’çš„ ç¬¬ä¸€ä¸ªSELECT ä¸º â€œåˆå§‹ç»“æœé›†â€ ç¬¬äºŒä¸ªSELECT ä¸ºé€’å½’éƒ¨åˆ†ï¼Œåˆ©ç”¨ â€œåˆå§‹ç»“æœé›†/ä¸Šä¸€æ¬¡é€’å½’è¿”å›çš„ç»“æœé›†â€ è¿›è¡ŒæŸ¥è¯¢å¾—åˆ° â€œæ–°çš„ç»“æœé›†â€ ç›´åˆ°é€’å½’éƒ¨åˆ†ç»“æœé›†è¿”å›ä¸ºnullï¼ŒæŸ¥è¯¢ç»“æŸ æœ€ç»ˆUNION ALL ä¼šå°†ä¸Šè¿°æ­¥éª¤ä¸­çš„æ‰€æœ‰ç»“æœé›†åˆå¹¶ï¼ˆUNION DISTINCT ä¼šè¿›è¡Œå»é‡ï¼‰ï¼Œå†é€šè¿‡ SELECT * FROM cte; æ‹¿åˆ°æ‰€æœ‰çš„ç»“æœé›† é€’å½’éƒ¨åˆ†ä¸èƒ½åŒ…æ‹¬ï¼š èšåˆå‡½æ•°ä¾‹å¦‚ SUM() GROUP BY ORDER BY LIMIT DISTINCT ä¸Šé¢çš„è®²è§£å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œé€šè¿‡ä¾‹å­æ…¢æ…¢æ¥ç†è§£12345678910111213141516171819WITH RECURSIVE cte (n) AS -- è¿™é‡Œå®šä¹‰çš„nç›¸å½“äºç»“æœé›†çš„åˆ—åï¼Œä¹Ÿå¯åœ¨ä¸‹é¢æŸ¥è¯¢ä¸­å®šä¹‰( SELECT 1 UNION ALL SELECT n + 1 FROM cte WHERE n &lt; 5)SELECT * FROM cte;-- result+------+| n |+------+| 1 || 2 || 3 || 4 || 5 |+------+ åˆå§‹ç»“æœé›†ä¸º n =1 è¿™æ—¶å€™çœ‹é€’å½’éƒ¨åˆ†ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œ CTEç»“æœé›†å³æ˜¯ n =1ï¼Œæ¡ä»¶å‘ç°å¹¶ä¸æ»¡è¶³ n &lt; 5ï¼Œè¿”å› n + 1 ç¬¬äºŒæ¬¡æ‰§è¡Œé€’å½’éƒ¨åˆ†ï¼ŒCTEç»“æœé›†ä¸º n = 2ï¼Œé€’å½’â€¦ ç›´è‡³æ¡ä»¶ä¸æ»¡è¶³ æœ€ååˆå¹¶ç»“æœé›† EXAMPLEæœ€åæ¥çœ‹ä¸€ä¸ªæ ‘ç»“æ„çš„ä¾‹å­123456CREATE TABLE `c_tree` ( `id` int(11) NOT NULL AUTO_INCREMENT, `cname` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL, `parent_id` int(11) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci; 1234567891011121314151617mysql&gt; select * from c_tree;+----+---------+-----------+| id | cname | parent_id |+----+---------+-----------+| 1 | 1 | 0 || 2 | 2 | 0 || 3 | 3 | 0 || 4 | 1-1 | 1 || 5 | 1-2 | 1 || 6 | 2-1 | 2 || 7 | 2-2 | 2 || 8 | 3-1 | 3 || 9 | 3-1-1 | 8 || 10 | 3-1-2 | 8 || 11 | 3-1-1-1 | 9 || 12 | 3-2 | 3 |+----+---------+-----------+ 1234567891011121314151617mysql&gt; WITH RECURSIVE tree_cte as( select * from c_tree where parent_id = 3 UNION ALL select t.* from c_tree t inner join tree_cte tcte on t.parent_id = tcte.id)SELECT * FROM tree_cte;+----+---------+-----------+| id | cname | parent_id |+----+---------+-----------+| 8 | 3-1 | 3 || 12 | 3-2 | 3 || 9 | 3-1-1 | 8 || 10 | 3-1-2 | 8 || 11 | 3-1-1-1 | 9 |+----+---------+-----------+ åˆå§‹ç»“æœé›†R0 = select * from c_tree where parent_id = 3 é€’å½’éƒ¨åˆ†ï¼Œç¬¬ä¸€æ¬¡ R0 ä¸ c_tree inner join å¾—åˆ° R1 R1 å†ä¸ c_tree inner join å¾—åˆ° R2 â€¦ åˆå¹¶æ‰€æœ‰ç»“æœé›† R0 + â€¦ + Ri æ›´å¤šä¿¡æ¯https://dev.mysql.com/doc/refman/8.0/en/with.html]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Redissonæºç è§£æï¼Œå¦‚ä½•åˆ©ç”¨Rediså®ç°åˆ†å¸ƒå¼å¯é‡å…¥é”]]></title>
    <url>%2Fpost%2Fd5899455.html</url>
    <content type="text"><![CDATA[æœ€å¼€å§‹ä½¿ç”¨Redisson çš„apiçš„æ—¶å€™ï¼Œæˆ‘è§‰å¾—å“‡ï¼Œè¿™ä¸ªapi å¤ªç‰›é€¼äº†å±…ç„¶æœ‰åˆ†å¸ƒå¼çš„å¯é‡å…¥é”ï¼Œæ­£å¥½æœ€è¿‘ç ”ç©¶äº†ä¸‹Redissonçš„æºç ï¼Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ å‰è¨€é¦–å…ˆæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ Java ä¸­çš„ ReentrantLock æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ è¿™é‡Œæˆ‘å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ReentrantLock å®ç°çš„æ€è·¯ é”æ ‡è¯†ï¼šé€šè¿‡AQSçš„stateå˜é‡ä½œä¸ºé”æ ‡è¯†ï¼Œåˆ©ç”¨Javaçš„CASä¿è¯å¤šçº¿ç¨‹ç«äº‰é”æ—¶çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ é˜Ÿåˆ—ï¼šæœªç«äº‰åˆ°é”çš„çº¿ç¨‹è¿›å…¥AQSçš„é˜Ÿåˆ—å¹¶æŒ‚èµ·ï¼Œç­‰å¾…è§£é”æ—¶è¢«å”¤é†’ï¼ˆæˆ–è€…è¶…æ—¶ï¼‰ å¦‚ä½•è®¾è®¡åˆ†å¸ƒå¼å¯é‡å…¥é”é¦–å…ˆé”æ ‡è¯†ï¼Œè¿™ä¸ªåœ¨Redisä¸­å¾ˆå®¹æ˜“å®ç°ï¼Œå¯ä»¥ç”¨lock name ä½œä¸ºkeyï¼Œå½“å‰çº¿ç¨‹ç”Ÿæˆä¸€ä¸ªuuidï¼Œä½œä¸ºvalueï¼ŒåŠ ä¸ŠRedis å•çº¿ç¨‹æ¨¡å‹ï¼Œå®ç°çº¿ç¨‹å®‰å…¨çš„é”ç«äº‰ è¿™ç§æ–¹å¼åœ¨ä¹‹å‰çš„åšå®¢é‡Œä¹Ÿæåˆ°è¿‡ï¼Œå¯ä»¥å‚è€ƒä¸‹ Redisåˆ†å¸ƒå¼é”çš„æ­£ç¡®å®ç°æ–¹å¼ ä½†æ˜¯å¦‚ä½•åŸºäºRedis åšä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåƒJavaé‚£æ ·å¯ä»¥æŒ‚èµ·å”¤é†’çº¿ç¨‹å‘¢ï¼Ÿè¿™ç‚¹æˆ‘åœ¨çœ‹æºç ä¹‹å‰ä¸€ç›´æ²¡æœ‰æƒ³åˆ°â€¦ é‚£ä¹ˆRedisson æ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿ ç­”æ¡ˆï¼šåˆ©ç”¨Redisçš„å‘å¸ƒè®¢é˜…ï¼ŒåŠ ä¸ŠJavaçš„Semaphoreï¼ˆä¿¡å·é‡ï¼Œä¸äº†è§£Semaphoreçš„å°ä¼™ä¼´å¯ä»¥Googleä¸€ä¸‹ï¼‰ Redisson åˆ†å¸ƒå¼é”å®ç°æ€è·¯é”æ ‡è¯†ï¼šHash æ•°æ®ç»“æ„ï¼Œkey ä¸ºé”çš„åå­—ï¼Œfiled å½“å‰ç«äº‰é”æˆåŠŸçº¿ç¨‹çš„â€œå”¯ä¸€æ ‡è¯†â€ï¼Œvalue é‡å…¥æ¬¡æ•° é˜Ÿåˆ—ï¼šæ‰€æœ‰ç«äº‰é”å¤±è´¥çš„çº¿ç¨‹ï¼Œä¼šè®¢é˜…å½“å‰é”çš„è§£é”äº‹ä»¶ï¼Œåˆ©ç”¨ Semaphore å®ç°çº¿ç¨‹çš„æŒ‚èµ·å’Œå”¤é†’ æºç åˆ†ææˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹tryLockæ–¹æ³•çš„æºç  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879 public boolean tryLock(long waitTime, long leaseTime, TimeUnit unit) throws InterruptedException &#123; long time = unit.toMillis(waitTime); long current = System.currentTimeMillis(); long threadId = Thread.currentThread().getId(); // å°è¯•è·å–é”ï¼Œè¿”å›null ä»£è¡¨è·å–é”æˆåŠŸï¼Œå½“è·å–é”å¤±è´¥æ—¶è¿”å›å½“å‰é”çš„é‡Šæ”¾æ—¶é—´ Long ttl = tryAcquire(leaseTime, unit, threadId); // lock acquired if (ttl == null) &#123; return true; &#125; // å¦‚æœæ­¤æ—¶å·²ç»è¶…è¿‡ç­‰å¾…æ—¶é—´åˆ™è·å–é”å¤±è´¥ time -= System.currentTimeMillis() - current; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; current = System.currentTimeMillis(); // è®¢é˜…è§£é”äº‹ä»¶ RFuture&lt;RedissonLockEntry&gt; subscribeFuture = subscribe(threadId); // ç­‰å¾…è®¢é˜…æˆåŠŸï¼ŒæˆåŠŸåå”¤é†’å½“å‰çº¿ç¨‹ if (!await(subscribeFuture, time, TimeUnit.MILLISECONDS)) &#123; if (!subscribeFuture.cancel(false)) &#123; subscribeFuture.onComplete((res, e) -&gt; &#123; if (e == null) &#123; unsubscribe(subscribeFuture, threadId); &#125; &#125;); &#125; acquireFailed(threadId); return false; &#125; try &#123; // å†æ¬¡åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦è¶…æ—¶ time -= System.currentTimeMillis() - current; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; while (true) &#123; long currentTime = System.currentTimeMillis(); // å°è¯•è·å–é” ttl = tryAcquire(leaseTime, unit, threadId); // lock acquired if (ttl == null) &#123; return true; &#125; time -= System.currentTimeMillis() - currentTime; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; // waiting for message currentTime = System.currentTimeMillis(); if (ttl &gt;= 0 &amp;&amp; ttl &lt; time) &#123; // ç­‰å¾…è§£é”æ¶ˆæ¯ï¼Œæ­¤å¤„åˆ©ç”¨Semaphoreï¼Œé”æœªé‡Šæ”¾æ—¶ï¼Œpermits=0ï¼Œçº¿ç¨‹å¤„äºæŒ‚èµ·çŠ¶æ€ // å½“å‘å¸ƒè§£é”æ¶ˆæ¯æ—¶ï¼Œå½“å‰çš„Semaphoreå¯¹è±¡çš„release() permits=1 // æ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’ï¼Œå»å°è¯•ç«äº‰é” getEntry(threadId).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS); &#125; else &#123; getEntry(threadId).getLatch().tryAcquire(time, TimeUnit.MILLISECONDS); &#125; time -= System.currentTimeMillis() - currentTime; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; &#125; &#125; finally &#123; unsubscribe(subscribeFuture, threadId); &#125;// return get(tryLockAsync(waitTime, leaseTime, unit)); &#125; tryAcquire(leaseTime, unit, threadId); è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ä¸‹é¢ä¼šåˆ†æï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦çŸ¥é“è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥è·å–é”å°±å¯ä»¥äº† è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å·²ç»å¯ä»¥ç†æ¸…Redissonå¯é‡å…¥é”çš„æ€è·¯äº† è·å–é” å¦‚æœè·å–é”å¤±è´¥ï¼Œè®¢é˜…è§£é”äº‹ä»¶ ä¹‹åæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯12345678910while(true) &#123; // å°è¯•è·å–é” // åˆ¤æ–­æ˜¯å¦è¶…æ—¶ // ç­‰å¾…è§£é”æ¶ˆæ¯é‡Šæ”¾ä¿¡å·é‡ //ï¼ˆæ­¤æ—¶æ¯ä¸ªJavaå®¢æˆ·ç«¯éƒ½å¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè¢«å”¤é†’ï¼‰ // åˆ¤æ–­æ˜¯å¦è¶…æ—¶&#125; åˆ©ç”¨ä¿¡å·é‡ï¼Œåˆç†æ§åˆ¶çº¿ç¨‹å¯¹é”çš„ç«äº‰ï¼Œåˆç†åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œå¯ä»¥è¯´åšçš„ç°å¸¸çš„å¥ˆæ–¯äº† éœ€è¦æ³¨æ„ï¼š!await(subscribeFuture, time, TimeUnit.MILLISECONDS) ï¼Œè¿™é‡Œå¾ˆå¤šåšå®¢éƒ½è§£é‡Šé”™äº†ï¼Œè¿™é‡Œå¹¶ä¸æ˜¯ç­‰å¾…å‘å¸ƒè§£é”æ¶ˆæ¯ï¼Œåªè¦è®¢é˜…äº‹ä»¶æˆåŠŸåï¼Œå°±ä¼šå¾€ä¸‹æ‰§è¡Œï¼ŒçœŸæ­£ç­‰å¾…è§£é”æ¶ˆæ¯çš„æ˜¯ getEntry(threadId).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS); è¿™é‡Œä½ å¯èƒ½ä¸ä¿¡ï¼Œä¸ºä»€ä¹ˆæˆ‘è¯´çš„å°±å¯¹å•Šï¼Œdebugä¸€ä¸‹ä½ å°±çŸ¥é“ tryLockInnerAsynctryAcquire å†…éƒ¨ä¾é  tryLockInnerAsync æ¥å®ç°è·å–é”çš„é€»è¾‘ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹æºç 123456789101112131415161718192021222324252627&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) &#123; internalLockLeaseTime = unit.toMillis(leaseTime); return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, command, // æ˜¯å¦å­˜åœ¨é” "if (redis.call('exists', KEYS[1]) == 0) then " + // ä¸å­˜åœ¨åˆ™åˆ›å»º "redis.call('hset', KEYS[1], ARGV[2], 1); " + // è®¾ç½®è¿‡æœŸæ—¶é—´ "redis.call('pexpire', KEYS[1], ARGV[1]); " + // ç«äº‰é”æˆåŠŸ è¿”å›null "return nil; " + "end; " + // å¦‚æœé”å·²ç»è¢«å½“å‰çº¿ç¨‹è·å– "if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then " + // é‡å…¥æ¬¡æ•°åŠ 1 "redis.call('hincrby', KEYS[1], ARGV[2], 1); " + "redis.call('pexpire', KEYS[1], ARGV[1]); " + "return nil; " + "end; " + // é”è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼Œè¿”å›é”çš„è¿‡æœŸæ—¶é—´ "return redis.call('pttl', KEYS[1]);", // ä¸‹é¢ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º KEYS[1], ARGV[1], ARGV[2] // å³é”çš„nameï¼Œé”é‡Šæ”¾æ—¶é—´ï¼Œå½“å‰çº¿ç¨‹å”¯ä¸€æ ‡è¯† Collections.&lt;Object&gt;singletonList(getName()), internalLockLeaseTime, getLockName(threadId));&#125; tryLockInnerAsync ä¸­åˆ©ç”¨luaè„šæœ¬ å’Œ Redis å•çº¿ç¨‹çš„ç‰¹ç‚¹æ¥å®ç°é”çš„ç«äº‰ è¿™é‡Œå¯ä»¥çœ‹åˆ°é”çš„ç»“æ„ï¼Œå’Œæˆ‘ä»¬ä¸Šæ–‡æ‰€è¯´çš„ä¸€æ ·ï¼ŒHash æ•°æ®ç»“æ„ï¼Œkey ä¸ºé”çš„nameï¼Œfiled å½“å‰ç«äº‰é”æˆåŠŸçº¿ç¨‹çš„â€å”¯ä¸€æ ‡è¯†â€ï¼Œvalue é‡å…¥æ¬¡æ•° unlockInnerAsyncæ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹è§£é”çš„æ ¸å¿ƒä»£ç 123456789101112131415161718192021222324252627282930protected RFuture&lt;Boolean&gt; unlockInnerAsync(long threadId) &#123; return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN, // ç”¨é”çš„nameå’Œçº¿ç¨‹å”¯ä¸€æ ‡è¯†å»åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™æ ·çš„é”®å€¼å¯¹ // è§£é“ƒè¿˜é¡»ç³»é“ƒäººï¼Œä¸å­˜åœ¨åˆ™æ— æƒè§£é”ï¼Œè¿”å›null "if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then " + "return nil;" + "end; " + // è§£é”é€»è¾‘ // å†²å…¥æ¬¡æ•°-1 "local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); " + // å¦‚æœå¤§äº0 ä»£è¡¨å½“å‰çº¿ç¨‹é‡å…¥é”å¤šæ¬¡æ— æ³•è§£é”ï¼Œæ›´æ–°é”çš„æœ‰æ•ˆæ—¶é—´ "if (counter &gt; 0) then " + "redis.call('pexpire', KEYS[1], ARGV[2]); " + "return 0; " + "else " + // è§£é”ï¼Œåˆ é™¤key "redis.call('del', KEYS[1]); " + // å‘å¸ƒè§£é”æ¶ˆæ¯ "redis.call('publish', KEYS[2], ARGV[1]); " + "return 1; "+ "end; " + "return nil;", // KEYS[1]ï¼ŒKEYS[2] // é”çš„nameï¼Œå‘å¸ƒè®¢é˜…çš„Channel Arrays.&lt;Object&gt;asList(getName(), getChannelName()), // ARGV[1] ~ ARGV[3] // è§£é”æ¶ˆæ¯ï¼Œé‡Šæ”¾æ—¶é—´ï¼Œå½“å‰çº¿ç¨‹å”¯ä¸€æ ‡è¯† LockPubSub.UNLOCK_MESSAGE, internalLockLeaseTime, getLockName(threadId));&#125; å‘å¸ƒè§£é”æ¶ˆæ¯åï¼Œä¼šè°ƒç”¨åˆ°LockPubSub çš„ onMessageï¼Œé‡Šæ”¾ä¿¡å·é‡ï¼Œå”¤é†’ç­‰å¾…é”çš„çº¿ç¨‹1234567891011121314151617181920212223242526272829303132333435363738public class LockPubSub extends PublishSubscribe&lt;RedissonLockEntry&gt; &#123; public static final Long UNLOCK_MESSAGE = 0L; public static final Long READ_UNLOCK_MESSAGE = 1L; public LockPubSub(PublishSubscribeService service) &#123; super(service); &#125; @Override protected RedissonLockEntry createEntry(RPromise&lt;RedissonLockEntry&gt; newPromise) &#123; return new RedissonLockEntry(newPromise); &#125; @Override protected void onMessage(RedissonLockEntry value, Long message) &#123; if (message.equals(UNLOCK_MESSAGE)) &#123; Runnable runnableToExecute = value.getListeners().poll(); if (runnableToExecute != null) &#123; runnableToExecute.run(); &#125; // é‡Šæ”¾ä¿¡å·é‡ value.getLatch().release(); &#125; else if (message.equals(READ_UNLOCK_MESSAGE)) &#123; while (true) &#123; Runnable runnableToExecute = value.getListeners().poll(); if (runnableToExecute == null) &#123; break; &#125; runnableToExecute.run(); &#125; value.getLatch().release(value.getLatch().getQueueLength()); &#125; &#125;&#125; å‚è€ƒ æ…¢è°ˆ Redis å®ç°åˆ†å¸ƒå¼é” ä»¥åŠ Redisson æºç è§£æ https://www.programcreek.com/java-api-examples/?code=rollenholt-SourceReading/redisson/redisson-master/src/main/java/org/redisson/RedissonLock.java æ¬¢è¿ç‚¹èµã€è½¬å‘ã€‚ä½ çš„æ”¯æŒå°±æ˜¯å¯¹æˆ‘æœ€å¤§çš„å¸®åŠ©]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>é”</tag>
        <tag>Redis</tag>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>æºç </tag>
        <tag>åˆ†å¸ƒå¼</tag>
        <tag>Redisson</tag>
        <tag>ReentrantLock</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQLä¼˜åŒ–å®æˆ˜--ç´¢å¼•ç¯‡]]></title>
    <url>%2Fpost%2F1e0091db.html</url>
    <content type="text"><![CDATA[å…³äºSQLä¼˜åŒ–ï¼Œè¿™ä¸ªé—®é¢˜ï¼Œç›¸ä¿¡å¤§å®¶è¿‡å¤šè¿‡å°‘éƒ½æœ‰è¿‡ä¸€äº›äº†è§£ã€‚æœ€è¿‘æˆ‘ä¹Ÿåœ¨ç ”ç©¶SQLä¼˜åŒ–æ–¹é¢çš„ä¸œè¥¿ï¼Œåˆ†äº«ä¸€äº›ç»éªŒã€‚ é¦–å…ˆç®€å•ä»‹ç»ä¸‹ç´¢å¼•ï¼Œâ€œç´¢å¼•â€ æ˜¯SQLä¼˜åŒ–ä¸­å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†ï¼ˆä½†æ˜¯ç´¢å¼•å¹¶ä¸æ˜¯ä¼˜åŒ–çš„å”¯ä¸€é€‰é¡¹ï¼‰ ç´¢å¼•åŸç†ç®€è¿°å¦‚ä½•ç†è§£ç´¢å¼•ï¼Ÿç´¢å¼•å…¶å®å°±æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œç”¨äºå¿«é€Ÿå®šä½å’Œè®¿é—®æ•°æ®åº“ä¸­çš„æ•°æ®ã€‚ é€šå¸¸æ¥è¯´ç´¢å¼•ä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯ B-Tree / B+Treeã€‚ä»¥B-Treeä¸ºä¾‹ï¼Œå‡è®¾æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨100ä¸ªKeyï¼Œä¸‰å±‚çš„B-Tree å¯å­˜å‚¨ä¸€ç™¾ä¸‡æ•°æ®ï¼Œå¦‚æœå°†æ ¹èŠ‚ç‚¹å­˜å…¥å†…å­˜ä¸­çš„è¯ï¼Œåªéœ€è¦è¯»å–ä¸¤æ¬¡ç£ç›˜å°±å¯ä»¥ä»100ä¸‡æ•°æ®ä¸­æ‰¾åˆ°æŒ‡å®šæ•°æ® å…³äºB-Tree æ¨èé˜…è¯»è¿™ç¯‡ https://www.geeksforgeeks.org/introduction-of-b-tree-2/ åŒ…å«B-Treeçš„æŸ¥è¯¢ï¼Œæ–°å¢ï¼Œåˆ é™¤æ“ä½œå¦‚ä½•å®ç° MySQL æ‰§è¡Œè®¡åˆ’SQLä¼˜åŒ–ä¸­æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’æ˜¯å¿…ä¸å¯å°‘çš„ä¸€é¡¹ï¼Œé€šè¿‡ explain å…³é”®å­—å¯ä»¥æŸ¥çœ‹MySQLä¸­çš„æ‰§è¡Œè®¡åˆ’ æ³¨ï¼š\G å«ä¹‰æ˜¯çºµå‘æ˜¾ç¤ºç»“æœ å¦‚æœä¹‹å‰æ²¡æœ‰äº†è§£çš„ EXPLAIN çš„åŒå­¦ï¼Œçœ‹åˆ°è¿™ä¸ªåˆ—è¡¨è‚¯å®šæ˜¯ä¸€è„¸æ‡µé€¼ã€‚æ²¡å…³ç³»æˆ‘ä»¬å…ˆæ¥æŒ‘å‡ ä¸ªé‡è¦çš„å±æ€§è®¤è¯†ä¸€ä¸‹ã€‚ typeï¼šALL ä»£è¡¨å…¨è¡¨æ‰«æ keyï¼šä»£è¡¨ä½¿ç”¨çš„ç´¢å¼•ï¼ŒNULL ä»£è¡¨æ²¡æœ‰ä½¿ç”¨ç´¢å¼• rowsï¼šæ‰«æè¡Œæ•° å…³äºexplain å†æ‰©å±•ä¸€ä¸‹ï¼Œå…ˆæ‰§è¡Œ explain extended ...; ï¼Œå†æ‰§è¡Œ SHOW WARNINGS å¯ä»¥çœ‹åˆ°MySQLä¼˜åŒ–å™¨å¯¹æˆ‘ä»¬çš„SQLåšäº†ä»€ä¹ˆä¼˜åŒ–ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º åˆ©ç”¨ç´¢å¼•æ¥ä¼˜åŒ–SQL ä½¿ç”¨ç´¢å¼•çš„ä¼˜ç‚¹ï¼šå‡å°‘æœåŠ¡å™¨æ‰«æçš„æ•°æ®é‡ã€é¿å…æ’åºå’Œä¸´æ—¶è¡¨ã€å°†éšæœºI/Oå˜ä¸ºé¡ºåºI/O é€šè¿‡ä¸‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ·»åŠ äº†ç´¢å¼•ä¹‹åæ‰«æè¡Œæ•°ä»ä¸‰åä¸‡è¡Œé™åˆ°äº†1ï¼Œæ€§èƒ½æå‡å¯æƒ³è€ŒçŸ¥ ç”Ÿäº§ç¯å¢ƒè¦æ³¨æ„ï¼Œåˆ›å»ºç´¢å¼•æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶çš„æ“ä½œï¼Œå¹¶ä¸”ä¼šé˜»å¡å…¶ä»–æ“ä½œã€‚ ç”Ÿäº§ç¯å¢ƒæ·»åŠ ç´¢å¼•æœ‰æ²¡æœ‰ä»€ä¹ˆå®Œç¾æ–¹æ¡ˆï¼Ÿæœ‰çš„ï¼Œå¦‚æœä½ çš„MySQLä½¿ç”¨ä¸»ä»ç­–ç•¥çš„æ—¶å€™ï¼Œå¯ä»¥åƒNginxä¸åœæœºå‡çº§webæœåŠ¡é‚£æ ·ï¼Œå…ˆç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ä¸ºè¯¥èŠ‚ç‚¹æ‰§è¡Œ ALTER TABLE æ“ä½œï¼Œç„¶åå·´æ‹‰å·´æ‹‰ï¼Œå› ä¸ºå…·ä½“æˆ‘ä¹Ÿæ²¡æ“ä½œè¿‡å°±ä¸ç»†è¯´äº†ï¼Œæ„Ÿå…´è¶£å¤§å®¶å¯ä»¥Googleä¸€ä¸‹ï¼ŒåŠ¨æ‰‹å°è¯•ä¸€ä¸‹ã€‚å¦‚æœæ˜¯å•æœºéƒ¨ç½²çš„è¯ï¼Œåªèƒ½ç”¨æˆ·å°‘çš„æ—¶å€™åœ¨æ‰§è¡Œè¿™ç§æ“ä½œäº† ä½¿ç”¨ç´¢å¼•è¿æ¥è¡¨ç´¢å¼•ä¹Ÿå¯ä»¥æé«˜è¡¨è¿æ¥çš„æ€§èƒ½ï¼Œä¸‹é¢æ˜¯ä¸ªä¾‹å­ï¼Œç”¨æˆ·è¡¨å·¦è¿è®¢å•è¡¨ï¼Œå¯¹user_id æ·»åŠ ç´¢å¼•çš„å‰åå¯¹æ¯” likeä¼˜åŒ– é€šè¿‡ä¸Šè¿°ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæ¨¡ç³ŠæŸ¥è¯¢æ—¶ä»¥%å¼€å¤´çš„è¯ï¼ŒMySQLæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œä½†æ˜¯é€šå¸¸æ¥è¯´æ¨¡ç³ŠæŸ¥è¯¢æ—¶æˆ‘ä»¬çš„åŒ¹é…æ–¹å¼éƒ½ä¼šæ˜¯ %xxx%ï¼Œé‚£ä¹ˆå¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ è¿™é‡Œå¯ä»¥é€šè¿‡å­˜â€œåå€¼â€çš„æ–¹å¼å·§å¦™çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚æˆ‘ç°åœ¨åœ¨æ•°æ®åº“åŠ ä¸€åˆ— reverse_order_no å­˜å‚¨è®¢å•å·çš„åå€¼ï¼ˆå¹¶æ·»åŠ ç´¢å¼•ï¼‰ï¼ŒåŒ¹é…çš„æ—¶å€™å†é€šè¿‡ REVERSE(â€˜%910â€™) å‡½æ•°å°†å‚æ•°å–åã€‚ è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨ orï¼Œå¦‚ä¸‹å›¾ï¼ŒæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ä¼šå‘ç°Extra å±æ€§è¿”å› &quot;Using sort_union(order_no,reverse_order_no); Using where&quot; è¿™é‡Œä»£è¡¨MySQLå‘ç”Ÿäº†ç´¢å¼•åˆå¹¶ï¼Œåæ–‡æˆ‘ä»¬ä¼šè®²åˆ° æ’åºä»¥åŠå¤šåˆ—ç´¢å¼•æ’åºéœ€è¦åŠ ç´¢å¼•ï¼ç›¸ä¿¡å¤§å®¶å¯èƒ½çŸ¥é“è¿™ä¸ªé“ç†ï¼Œä½†æ˜¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œuser_id å’Œ addtime ä¸¤åˆ—éƒ½å»ºç«‹äº†ç´¢å¼•ï¼Œé‚£ä¹ˆä¸‹é¢è¿™æ¡æŸ¥è¯¢æ’åºä½¿ç”¨ç´¢å¼•äº†å—ï¼Ÿ ç­”æ¡ˆæ˜¯ï¼šå¹¶æ²¡æœ‰ï¼ä¸ºä»€ä¹ˆï¼Ÿæ³¨æ„ Extra ä¸­çš„ using filesortï¼Œä»£è¡¨MySQL ä½¿ç”¨äº†å†…éƒ¨æ–‡ä»¶æ’åºç®—æ³•å¯¹ç»“æœé›†è¿›è¡Œäº†æ’åºã€‚MySQL é€šå¸¸åœ¨ä¸€ä¸ªè¡¨ä¸Šåªé€‰æ‹©ä¸€ä¸ªç´¢å¼•ï¼ˆæœ‰ä¾‹å¤–çš„æƒ…å†µï¼‰ï¼Œè¿™ç§æƒ…å†µå¦‚æœæˆ‘ä»¬å¸Œæœ›æ’åºä½¿ç”¨ç´¢å¼•çš„è¯ï¼Œå¯ä»¥å»ºç«‹ä¸€ä¸ªå¤šåˆ—ç´¢å¼•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º è€Œä¸”å¤šåˆ—ç´¢å¼•æœ€å·¦è¾¹çš„åˆ—ï¼Œå¯ä»¥å½“ä½œå•åˆ—ç´¢å¼•æ¥ä½¿ç”¨ MySQL ä¼˜åŒ–å™¨ç‰¹æ€§æˆ‘ä»¬åˆšåˆšè¯´è¿‡ MySQL é€šå¸¸åœ¨ä¸€ä¸ªè¡¨ä¸Šåªé€‰æ‹©ä¸€ä¸ªç´¢å¼•ï¼Œå¦‚ä½•ç†è§£ï¼Ÿä¾‹å¦‚ç´¢å¼•Aå’Œç´¢å¼•B ä¸€ä¸ªéœ€è¦æ‰«æåä¸‡è¡Œï¼Œä¸€ä¸ªéœ€è¦æ‰«æäº”ä¸‡è¡Œï¼Œé‚£ä¹ˆMySQLä¸€å®šé€‰æ‹©å¼€é”€æœ€å°çš„ç´¢å¼•æ–¹å¼ã€‚ åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼ŒMySQL ä¼šé€‰æ‹© Index Mergeï¼ˆç´¢å¼•åˆå¹¶ï¼‰ï¼Œå³åœ¨ä¸€ä¸ªè¡¨ä¸Šä½¿ç”¨å¤šä¸ªç´¢å¼• Unionï¼šä¸¤ä¸ªåŸºæ•°å¾ˆé«˜çš„ç´¢å¼•æ‰§è¡ŒORæ“ä½œæ—¶ Sort-Unionï¼šä¸ä¸Šè¿°ç±»ä¼¼ï¼Œä¸€æ—¦orçš„å·¦å³ä¸¤è¾¹å‡ºç°èŒƒå›´æŸ¥è¯¢ï¼Œä¼šä½¿ç”¨è¯¥ç®—æ³•ï¼ŒåŒºåˆ«æ˜¯Sort-Unionä¼šè¿›è¡Œæ’åº intersectï¼šé’ˆå¯¹å”¯ä¸€å€¼ä¸å¤šçš„ç´¢å¼•åˆ—ï¼Œä¾‹å¦‚åœ¨ is_payï¼ˆ0-æœªæ”¯ä»˜ï¼Œ1-æ”¯ä»˜ï¼‰ï¼Œis_sendï¼ˆ0-æœªå‘è´§ï¼Œ1-å‘è´§ï¼‰ ä¸¤åˆ—å»ºç«‹ç´¢å¼•ï¼ŒæŸ¥è¯¢å·²æ”¯ä»˜å¹¶ä¸”æœªå‘è´§çš„è®¢å•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º æ ¹æ®MySQL 5.7å¼€å‘æ–‡æ¡£æ‰€ç¤ºï¼Œè¿˜æœ‰ä¸€ç§ä¼šä½¿ç”¨intersectï¼ŒInnoDB ä¸»é”®ä¸Šçš„ä»»ä½•èŒƒå›´æœç´¢ å…³äºIndex Mergeçš„æ›´å¤šä¿¡æ¯ï¼Œå‚è€ƒMySQLå¼€å‘æ–‡æ¡£https://dev.mysql.com/doc/refman/5.7/en/index-merge-optimization.html ç´¢å¼•çš„å½±å“æ·»åŠ ç´¢å¼•è™½ç„¶å¯ä»¥æå‡æˆ‘ä»¬çš„SQLæ€§èƒ½ï¼Œä½†æ˜¯éšä¹‹è€Œæ¥ä¹Ÿä¼šå¸¦æ¥ä¸€å®šçš„å¼€é”€ æ•°æ®æ’å…¥å’Œæ›´æ–°çš„æ€§èƒ½ï¼Œå› ä¸ºéœ€è¦æ„å»ºç´¢å¼•çš„åŸå› ï¼Œåœ¨æ•°æ®é‡å¤§çš„æ—¶å€™ä¼šæ¯”è¾ƒæ˜æ˜¾ï¼Œä¸‹å›¾æ˜¯ ã€ŠEffective MySQLä¹‹SQLè¯­å¥æœ€ä¼˜åŒ–ã€‹ä¸­å¯¹æ·»åŠ ç´¢å¼•å‰åçš„æ’å…¥æ€§èƒ½å¯¹æ¯” ç£ç›˜ç©ºé—´çš„å½±å“ï¼ŒåŒæ ·ä¹Ÿæ˜¯æ¥è‡ªäºä¹¦ä¸­çš„æµ‹è¯• å¯ä»¥çœ‹åˆ°åœ¨æ·»åŠ äº†ç´¢å¼•ä¹‹åï¼Œç©ºé—´å ç”¨æ˜¯åŸæ¥çš„7å€ï¼Œåœ¨æ•°æ®é‡åºå¤§æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªéœ€è¦å…³æ³¨çš„ç‚¹ã€‚ è¿˜æœ‰éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨MySQL Innodb ä¸­æœ‰èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•ï¼Œä¸€èˆ¬æ¥è¯´ä¸»é”®å°±æ˜¯èšç°‡ç´¢å¼•ï¼Œè€Œå…¶ä»–çš„ç´¢å¼•éƒ½æ˜¯äºŒçº§ç´¢å¼•ã€‚ äºŒçº§ç´¢å¼•æ‰€å­˜å‚¨çš„å€¼æ˜¯èšç°‡ç´¢å¼•ã€‚æ‰€ä»¥å½“ä½¿ç”¨äºŒçº§ç´¢å¼•æ¥è¿›è¡Œæ£€ç´¢æ—¶ï¼ŒMySQL ä¼šå…ˆé€šè¿‡è¯¥ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„èšç°‡ç´¢å¼•ï¼Œå†é€šè¿‡è¯¥èšç°‡ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„æ•°æ®ã€‚è¿™æ—¶ä½¿ç”¨å ç”¨å­—èŠ‚æ›´å°çš„ç±»å‹æ¥åšä¸»é”®ä¼šæ›´å¥½ï¼Œä¼šèŠ‚çœç´¢å¼•å ç”¨ç©ºé—´ å‚è€ƒ Effective MySQLä¹‹SQLè¯­å¥æœ€ä¼˜åŒ–]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>ç´¢å¼•</tag>
        <tag>sqlä¼˜åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Securityå®æˆ˜(äºŒ) åŠ¨æ€æƒé™]]></title>
    <url>%2Fpost%2Fb718a659.html</url>
    <content type="text"><![CDATA[å¥½æ¶ˆæ¯å¥½æ¶ˆæ¯ï¼Securityç³»åˆ—ç»ˆäºæœ‰äº†ç¬¬äºŒæœŸï¼Œæœ€è¿‘åœ¨çœ‹é¡¹ç›®æºç å¿ä¸ä½åˆæèµ·æ¥Spring Securityï¼Œæ¥ç»™å¤§å®¶åˆ†äº«ä¸€ä¸‹ï¼Œè™½ç„¶å’Œä¸Šä¸€èŠ‚è¯´å¥½çš„å†…å®¹ä¸åŒğŸ¤­ å›é¡¾ä¸ŠèŠ‚æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•è¿›è¡Œç®€å•çš„æƒé™é…ç½®ï¼ŒåŒ…æ‹¬urlæƒé™å’Œæ–¹æ³•æƒé™ï¼Œè¿˜æœ‰å¦‚ä½•æˆäºˆç”¨æˆ·æƒé™ã€‚12345678910111213141516171819protected void configure(HttpSecurity http) throws Exception &#123; http .authorizeRequests() .antMatchers("/", "/home").permitAll() // æµ‹è¯•é…ç½®URLæƒé™ .antMatchers("/match/**").hasAuthority("sys:match") // å¯¹æŸURLæ·»åŠ å¤šä¸ªæƒé™ï¼Œå¯ä»¥å¤šæ¬¡é…ç½® .antMatchers("/match/**").hasAuthority("sys:mm") .anyRequest().authenticated() .and() .formLogin() .loginPage("/login") .permitAll() .and() .logout() .permitAll() .and() ;&#125; ä½†æ˜¯å¦‚æœç°åœ¨ä½ çš„ä¸šåŠ¡ç³»ç»Ÿè¦æ±‚åŠ¨æ€æƒé™å‘¢ï¼Ÿ æ¯”å¦‚ç”¨æˆ·æƒé™å˜æ›´äº†ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°æ„å»ºSecurityä¸Šä¸‹æ–‡ä¸­Authentication å¯¹è±¡ï¼Œè¿™è¿˜å¥½è¯´ã€‚å¦‚æœè¯´æŸä¸ªæ¥å£çš„æƒé™ä¿®æ”¹äº†ï¼Œå¦‚æœæŒ‰ç…§ä¸Šè¿°çš„æ–¹æ³•æ¥åšçš„è¯ï¼Œæ˜¯ä¸å¯èƒ½å®ç°åŠ¨æ€ä¿®æ”¹çš„ã€‚ æœ¬èŠ‚æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹Spring Security å¦‚ä½•å®ç°åŠ¨æ€æƒé™ å®ç°åŸç†FilterSecurityInterceptor è´Ÿè´£ Securityä¸­çš„æƒé™æ§åˆ¶ï¼Œå…¶æ ¸å¿ƒä»£ç åœ¨çˆ¶ç±»AbstractSecurityInterceptorä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ è¿™é‡Œæˆ‘åˆ äº†ä¸€äº›ä¸æ ¸å¿ƒé€»è¾‘æ— å…³çš„ä»£ç ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨çº¢æ¡†é‡Œçš„å†…å®¹ è¿™æ—¶å€™èªæ˜çš„ä½ åº”è¯¥å·²ç»æ˜ç™½äº†FilterSecurityInterceptoræ˜¯å¦‚ä½•ç®¡ç†æƒé™çš„ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥è‡ªå·±å®ç°ä¸Šé¢çš„AccessDecisionManagerå’ŒSecurityMetadataSourceæ¥å®ç°æˆ‘ä»¬çš„åŠ¨æ€æƒé™ ä½†æ˜¯å…ˆåˆ«æ€¥ï¼Œå…ˆçœ‹çœ‹AccessDecisionManagerçš„é»˜è®¤å®ç°AffirmativeBased è¿™ä»£ç å†™çš„æœ‰æ„æ€äº†ï¼Œé€šè¿‡éå†æ‰€æœ‰çš„Voterï¼Œæ¯ä¸ªVoterå®ç°å…·ä½“çš„åˆ¤æ–­é€»è¾‘ï¼Œè¿”å› 1ï¼Œ0ï¼Œ-1ï¼ˆåˆ†åˆ«ä»£è¡¨åŒæ„ã€å¼ƒæƒã€æ‹’ç»ï¼‰ï¼Œå½“å­˜åœ¨æ‹’ç»æ—¶ç›´æ¥æŠ›å‡ºAccessDeniedException éå¸¸çš„æ°‘ä¸»ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°ä¸€ä¸ªVoterå³å¯ æ³¨ï¼šAccessDecisionManager è¿˜æœ‰å…¶ä»–çš„é»˜è®¤å®ç°ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç  CodingOKï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆæ‹ä¸€ä¸‹æ€è·¯ å®ç°SecurityMetadataSourceï¼Œæä¾›å½“å‰èµ„æºè¦æ±‚çš„æƒé™ å®ç°AccessDecisionVoterï¼Œç”¨äºåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—® å°†æˆ‘ä»¬è‡ªå·±çš„å®ç°æ³¨å†Œåˆ°FilterSecurityInterceptorä¸­ OKï¼Œå¯ä»¥å¼€æäº† SecurityServiceå®ç°ä¸€ä¸ªServiceï¼Œç”¨äºä»æ•°æ®åº“åŠ è½½æ•°æ®1234567891011121314151617181920212223242526@Servicepublic class SecurityService &#123; @Autowired private JdbcTemplate jdbcTemplate; /** * åŠ è½½èµ„æºè¦æ±‚çš„æƒé™ * * @param resource * @return */ public List&lt;String&gt; getPermByResource(String resource) &#123; return jdbcTemplate.queryForList(Sql.getPermByResource, String.class, resource); &#125; /** * å½“å‰ç”¨æˆ·çš„æƒé™ * * @param username * @return */ public List&lt;String&gt; getPermByUsername(String username) &#123; return jdbcTemplate.queryForList(Sql.getPermByUsername, String.class, username); &#125;&#125; æ³¨ï¼šè¿™é‡Œä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥åŠ ä¸Šç¼“å­˜ï¼Œç”±äºdemoæ¼”ç¤ºï¼Œæˆ‘å°±æ²¡æœ‰è¿™ä¹ˆåš å®ç°SecurityMetadataSourceMySecurityMetadataSource å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡SecurityServiceåŠ è½½ä¸€ä¸‹æ•°æ®12345678910111213141516171819202122232425262728public class MySecurityMetadataSource implements FilterInvocationSecurityMetadataSource &#123; private SecurityService securityService; public MySecurityMetadataSource(SecurityService securityService) &#123; this.securityService = securityService; &#125; @Override public Collection&lt;ConfigAttribute&gt; getAttributes(Object object) throws IllegalArgumentException &#123; String uri = ((FilterInvocation) object).getHttpRequest().getRequestURI(); List&lt;String&gt; list = securityService.getPermByResource(uri); if (list != null &amp;&amp; list.size() != 0) &#123; return SecurityConfig.createList(list.toArray(new String[0])); &#125; return null; &#125; @Override public Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() &#123; return null; &#125; @Override public boolean supports(Class&lt;?&gt; clazz) &#123; return FilterInvocation.class.isAssignableFrom(clazz); &#125;&#125; å®ç°AccessDecisionVoterè¿™é‡ŒåŠ è½½ä¸€ä¸‹å½“å‰ç”¨æˆ·çš„æƒé™ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ»¡è¶³å½“å‰èµ„æºæ‰€è¦æ±‚çš„æƒé™12345678910111213141516171819202122232425262728293031323334public class MyAccessDecisionVoter implements AccessDecisionVoter&lt;Object&gt; &#123; private SecurityService securityService; public MyAccessDecisionVoter(SecurityService securityService) &#123; this.securityService = securityService; &#125; @Override public boolean supports(ConfigAttribute attribute) &#123; return true; &#125; @Override public boolean supports(Class&lt;?&gt; clazz) &#123; return true; &#125; @Override public int vote(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; attributes) &#123; Object principal = authentication.getPrincipal(); if ("anonymousUser".equals(principal)) &#123; // å½“å‰ç”¨æˆ·æœªç™»å½•ï¼Œå¦‚æœä¸è¦æ±‚æƒé™-&gt;å…è®¸è®¿é—®ï¼Œå¦åˆ™æ‹’ç»è®¿é—® return CollectionUtils.isEmpty(attributes) ? ACCESS_GRANTED : ACCESS_DENIED; &#125; else &#123; // è¿™é‡Œæˆ‘çš„é€»è¾‘æ˜¯ï¼Œå½“å‰èµ„æºçš„è¦æ±‚æƒé™ï¼Œç”¨æˆ·å¿…é¡»å…¨éƒ¨æ»¡è¶³æ—¶æ‰å¯ä»¥è®¿é—® User user = (User) principal; List&lt;String&gt; permitList = securityService.getPermByUsername(user.getUsername()); List&lt;String&gt; stringAttributes = attributes.stream().map(ConfigAttribute::getAttribute).collect(Collectors.toList()); return permitList.containsAll(stringAttributes) ? ACCESS_GRANTED : ACCESS_DENIED; &#125; &#125;&#125; æ³¨å†Œåˆ°FilterSecurityInterceptoræˆ‘ä»¬æ ¸å¿ƒçš„ä¸šåŠ¡å·²ç»å®ç°å®Œäº†ï¼Œç°åœ¨éœ€è¦æŠŠMySecurityMetadataSourceå’ŒMyAccessDecisionVoteræ³¨å†Œåˆ°FilterSecurityInterceptorä¸­ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒFilterSecurityInterceptorå¹¶ä¸å¯ä»¥é€šè¿‡@Beançš„æ–¹å¼æ¥å£°æ˜ï¼Œè¯¥å¯¹è±¡æ˜¯åœ¨WebSecurityConfigurerAdapterçš„åˆå§‹åŒ–æ–¹æ³•ä¸­é»˜è®¤åˆ›å»ºçš„ ä½†æ˜¯Spring Securityä¸ºæˆ‘ä»¬æä¾›äº†ObjectPostProcessorï¼Œç”¨äºè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå…·ä½“ç”¨æ³•å¦‚ä¸‹12345678910111213http .authorizeRequests() .antMatchers("/", "/home", "/403").permitAll() .anyRequest().authenticated() .withObjectPostProcessor(new ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() &#123; @Override public &lt;O extends FilterSecurityInterceptor&gt; O postProcess( O fsi) &#123; fsi.setSecurityMetadataSource(new MySecurityMetadataSource(securityService)); fsi.setAccessDecisionManager(new AffirmativeBased(getDecisionVoters())); return fsi; &#125; &#125;) å®Œæ•´DemoGithub ğŸ‘‰ https://github.com/TavenYin/security-example/tree/master/dynamic-permissions]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Spring Security</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨ Spring Cloud åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ]]></title>
    <url>%2Fpost%2Fbca00fad.html</url>
    <content type="text"><![CDATA[Spring Cloud Config èƒ½åšä»€ä¹ˆï¼Ÿæˆ‘ä»¬å¯ä»¥å°†åˆ†å¸ƒå¼ç³»ç»Ÿçš„é…ç½®æ–‡ä»¶æ‰˜ç®¡åœ¨Gitä»“åº“æˆ–è€…æ•°æ®åº“ä¸­ï¼ŒConfig Server è´Ÿè´£ç®¡ç†é…ç½®æ–‡ä»¶ï¼Œä»¥Restfulçš„å½¢å¼æä¾›ç»™å…¶ä»–æœåŠ¡ï¼Œå¯ä»¥åœ¨ä»»ä½•å…¶ä»–è¯­è¨€çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ï¼Œä¸ä¾èµ–Spring Cloudå…¨å®¶æ¡¶ã€‚ æœ¬èŠ‚ç›®æ ‡ä½¿ç”¨Spring Cloud åŸºäºGitä»“åº“æ­å»ºåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ ç‰ˆæœ¬Spring Cloud Greenwich.SR2Spring Boot 2.1.7.RELEASE Gitä»“åº“åœ¨ä½ å–œæ¬¢çš„Gitå¹³å°ä¸Šå»ºç«‹ä¸€ä¸ªä»“åº“ï¼Œåˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œå¹¶å»ºç«‹å‡ ä¸ªé…ç½®æ–‡ä»¶ï¼ˆå»ºè®®ç½‘ç»œè¾ƒæ…¢çš„åŒå­¦é€‰æ‹©Giteeï¼‰ æ­å»ºConfig Serverpom.xml1234567891011121314151617181920212223&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; ...&lt;/dependencies&gt;&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;Greenwich.SR2&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt; application.properties12345678910server.port = 9001spring.application.name = config-server#è¡¨ç¤ºé…ç½®ä¸­å¿ƒæ‰€åœ¨ä»“åº“çš„ä½ç½®spring.cloud.config.server.git.uri = https://gitee.com/yintianwen7/cloud-config.git#ä»“åº“è·¯å¾„ä¸‹çš„çš„ç›¸å¯¹æœç´¢ä½ç½®ï¼Œå¯ä»¥é…ç½®å¤šä¸ªspring.cloud.config.server.git.search-paths = demo#gitçš„ç”¨æˆ·åspring.cloud.config.server.git.username = yourusername#gitçš„å¯†ç spring.cloud.config.server.git.password = yourpassword ConfigServerApplication.java123456789@EnableConfigServer@SpringBootApplicationpublic class ConfigServerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfigServerApplication.class, args); &#125;&#125; è‡³æ­¤ï¼ŒConfigServer æ­å»ºå®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®ConfigServer æŸ¥çœ‹ cloud-config/demo ä¸‹çš„é…ç½®æ–‡ä»¶ è®¿é—®æ–¹å¼å¦‚ä¸‹: /{application}/{profile}[/{label}] /{application}-{profile}.yml /{label}/{application}-{profile}.yml /{application}-{profile}.properties /{label}/{application}-{profile}.properties è¿™é‡Œ label ä¸ºgit åˆ†æ”¯ï¼Œé»˜è®¤master ä¾‹å¦‚è®¿é—® application-dev.ymlï¼Œç›´æ¥è¯·æ±‚ localhost:9001/application/devå³å¯ å¯ä»¥å°è¯•ä¿®æ”¹ä¸€ä¸‹Gitä»“åº“ä¸­çš„é…ç½®æ–‡ä»¶ï¼Œå†è®¿é—®Config Serverï¼Œè¿™æ—¶ä½ ä¼šå‘ç°Config Serverä¸­çš„æ•°æ®æ˜¯å®æ—¶çš„ã€‚ æ­å»º Client åº”ç”¨è®¿é—®Config Serverpom.xml1234567891011121314151617181920212223&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; ...&lt;/dependencies&gt;&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;Greenwich.SR2&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt; bootstrap.propertiesï¼Œæ³¨æ„è¿™é‡Œæ˜¯ bootstrap.propertiesï¼Œä¸ç„¶ä½ ä¼šå‘ç°ä½ è¯·æ±‚çš„URIä¸€ç›´æ˜¯localhost:888812345spring.profiles.active=simplespring.application.name=applicationspring.cloud.config.label=master# æ‹¼æ¥è§„åˆ™: uri/name/profile/labelspring.cloud.config.uri=http://localhost:9001 CloudConfig.java é…ç½®æ–‡ä»¶çš„æ˜ å°„å®ä½“ï¼ŒåŒç†ä¹Ÿå¯ä»¥@Value æˆ–è€… Environment å¯¹è±¡è¯»å–å±æ€§12345678@ConfigurationProperties("cloud.config")public class CloudConfig &#123; private String a; private String b; private String c; // çœç•¥ get set&#125; ClientApplication.java123456789101112131415161718@RestController@SpringBootApplication@EnableConfigurationProperties(CloudConfig.class)public class ClientApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ClientApplication.class, args); &#125; @Autowired private CloudConfig cloudConfig; // åˆ·æ–°é…ç½®æ—¶ POST /actuator/refresh @GetMapping("config") public Object config() &#123; return cloudConfig; &#125;&#125; å¯åŠ¨ Clientï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°è¯·æ±‚é…ç½®ä¸­å¿ƒçš„URL è¯·æ±‚ localhost:8080/config ï¼ŒéªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦è¯»å–æˆåŠŸ åˆ·æ–°å®¢æˆ·ç«¯é…ç½®Client ä¸­è¯»å–çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸æ˜¯å®æ—¶çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹Gitä»“åº“ä¸­çš„æ–‡ä»¶æ¥éªŒè¯è¿™ç‚¹ã€‚é‚£ä¹ˆå¦‚ä½•åˆ·æ–°é…ç½®å‘¢ï¼Ÿ pom.xml å¼•å…¥1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt; bootstrap.properties è¿½åŠ 1management.endpoints.web.exposure.include=* å¯¹éœ€è¦åˆ·æ–°çš„Beanï¼Œæ·»åŠ æ³¨è§£@RefreshScope1234@RefreshScope@ConfigurationProperties("cloud.config")public class CloudConfig &#123;&#125; POST /actuator/refreshï¼Œå³å¯åˆ·æ–°é…ç½® Config Server åŠ å¯†è§£å¯†å…è®¸æ•°æ®ä»¥åŠ å¯†å½¢å¼å­˜å‚¨åœ¨Gitä»“åº“ï¼Œé…ç½®ä¸­å¿ƒè´Ÿè´£å¯¹åŠ å¯†çš„æ•°æ®è¿›è¡Œè§£å¯†ï¼Œç„¶åæä¾›ç»™å®¢æˆ·ç«¯åº”ç”¨ã€‚ç”±äºç¯‡å¹…é—®é¢˜ï¼Œè¿™é‡Œä¸è®²äº†ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å‚è€ƒ Spring Cloudæ„å»ºå¾®æœåŠ¡æ¶æ„ï¼šåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼ˆåŠ å¯†è§£å¯†ï¼‰ é…ç½®ä¸­å¿ƒé«˜å¯ç”¨æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¼ ç»Ÿè´Ÿè½½å‡è¡¡å™¨ æ–¹æ¡ˆ2ï¼šå°†clientã€config server æ³¨å†Œåˆ°Spring Cloudæ³¨å†Œä¸­å¿ƒï¼Œé€šè¿‡æ³¨å†Œä¸­å¿ƒè®¿é—®é…ç½®ä¸­å¿ƒï¼Œå…·ä½“ä»£ç å‚è€ƒğŸ‘‡ Demoæœ¬æ–‡demoğŸ‘‰ï¼šGithubï¼Œ Gitee å‚è€ƒhttp://blog.didispace.com/spring-cloud-starter-dalston-3-2/https://segmentfault.com/a/1190000012908853]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>Spring Cloud</tag>
        <tag>åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RabbitMQ é›†ç¾¤æ­å»º]]></title>
    <url>%2Fpost%2F4c62e394.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡è®°å½•RabbitMQé›†ç¾¤æ­å»ºè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ ç¯å¢ƒ vmware12 è™šæ‹Ÿæœºï¼ŒCentOS7æœ¬æ–‡ä»¥ä¸¤å°CentOS ä¸ºä¾‹ï¼ŒIP 192.168.32.128ï¼Œ192.168.32.129 ç£ç›˜èŠ‚ç‚¹å’Œå†…å­˜èŠ‚ç‚¹é›†ç¾¤ä¸­ï¼Œæ¯ä¸€ä¸ªRabbitMQå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€ŒèŠ‚ç‚¹åˆ†ä¸ºç£ç›˜èŠ‚ç‚¹å’Œå†…å­˜èŠ‚ç‚¹ å†…å­˜èŠ‚ç‚¹ï¼šå°†Rabbitä¸­çš„å…ƒæ•°æ®ï¼ˆQueue, Exchange, binding, vhostç­‰ï¼‰å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒæŒä¹…åŒ–çš„ Message ä¾æ—§ä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œå†…å­˜èŠ‚ç‚¹çš„æ€§èƒ½åªèƒ½ä½“ç°åœ¨èµ„æºç®¡ç†ä¸Šï¼Œæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶å’Œç£ç›˜èŠ‚ç‚¹æ²¡æœ‰åŒºåˆ« ç£ç›˜èŠ‚ç‚¹ï¼šå…ƒæ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸­ï¼Œä¸€ä¸ªRabbité›†ç¾¤è¦æ±‚è‡³å°‘æœ‰ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ï¼Œå› ä¸ºå†…å­˜èŠ‚ç‚¹ä¸­ä¸å­˜å‚¨å…ƒæ•°æ®ï¼Œæ‰€ä»¥æ¯æ¬¡å†…å­˜èŠ‚ç‚¹å¯åŠ¨ï¼Œéƒ½ä¼šä»å…¶ä»–èŠ‚ç‚¹ä¸­åŒæ­¥å…ƒæ•°æ® å¦å¤–å¦‚æœå”¯ä¸€ç£ç›˜çš„ç£ç›˜èŠ‚ç‚¹å´©æºƒäº†ï¼Œä¸èƒ½è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š ä¸èƒ½åˆ›å»ºé˜Ÿåˆ— ä¸èƒ½åˆ›å»ºäº¤æ¢å™¨ ä¸èƒ½åˆ›å»ºç»‘å®š ä¸èƒ½æ·»åŠ ç”¨æˆ· ä¸èƒ½æ›´æ”¹æƒé™ ä¸èƒ½æ·»åŠ å’Œåˆ é™¤é›†ç¾¤å‡ ç‚¹ RabbitMQé›†ç¾¤çš„å‡ ç§ç±»å‹ å•ä¸€æ¨¡å¼ï¼šä»…æœ‰ä¸€ä¸ªrabbitå®ä¾‹ æ™®é€šæ¨¡å¼ï¼šé»˜è®¤é›†ç¾¤æ¨¡å¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹å„è‡ªç»´æŠ¤è‡ªå·±çš„æ•°æ®ï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä»…å­˜æœ‰ç›¸åŒçš„å…ƒæ•°æ®ã€‚ä¾‹å¦‚RabbitA å’Œ RabbitBï¼ŒAä¸­å­˜åœ¨ QueueAï¼Œæ¶ˆè´¹è€…å¯ä»¥ä»RabbitBå®ä¾‹ä¸­ï¼Œè¯»å–QueueAçš„æ¶ˆæ¯ï¼Œè¿™æ—¶RabbitBä¼šä»Aä¸­è¯»å–æ¶ˆæ¯ï¼Œè¿”å›ç»™æ¶ˆè´¹è€…ã€‚ä½†æ˜¯å¦‚æœRabbitA å®•æœºï¼Œè¿™æ—¶å°±æ— æ³•è·å–QueueAçš„æ•°æ®äº† é•œåƒæ¨¡å¼ï¼šRabbit ä¼šå°†æ•°æ®åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ä¸­ï¼Œè¿™å›ºç„¶æé«˜äº†å¯ç”¨æ€§ï¼Œä½†æ˜¯éšä¹‹è€Œæ¥çš„é—®é¢˜æ˜¯ï¼Œç³»ç»Ÿçš„æ€§èƒ½ä¼šé™ä½ã€‚èŠ‚ç‚¹ä¹‹é—´æ¶ˆæ¯çš„ä¼ é€’ä¼šå ç”¨å¸¦å®½ï¼Œè€Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®é‡ä¼šå˜å¤§ æ™®é€šæ¨¡å¼æˆ‘ä»¬å…ˆæ¥æ­å»ºæ™®é€šæ¨¡å¼çš„é›†ç¾¤ï¼Œåœ¨RabbitMQä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åå¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œé»˜è®¤ä»¥ rabbit@hostnameä¸ºèŠ‚ç‚¹name è€Œæ¯å°è™šæ‹Ÿæœºä¸­é»˜è®¤çš„hostæ˜¯localhostï¼Œè¿™å°±å¯¼è‡´äº†æ¯ä¸ªèŠ‚ç‚¹çš„nameéƒ½æ˜¯ rabbit@localhost 1. ä¿®æ”¹hostsä¿®æ”¹ä¸¤å°ä¸»æœºçš„hostsæ–‡ä»¶ï¼Œä»¥ä¸‹æ˜¯129çš„é…ç½®ï¼Œæˆ‘ä»¬æŠŠ128å®šä¹‰ä¸ºFï¼Œ129å®šä¹‰ä¸ºG 123456cat /etc/hosts127.0.0.1 G::1 G192.168.32.129 G192.168.32.128 F ä¿è¯Få’ŒGå¯ä»¥pingé€š 2. å®‰è£…RabbitMQå¯ä»¥å‚è€ƒ https://www.linuxprobe.com/install-rabbitmq-on-centos-7.html å½“æ—¶å®‰è£…å®Œä¸€ç›´å‘ç°æ— æ³•è®¿é—® Rabbitçš„webæ§åˆ¶å°ï¼Œé™¤äº†å¼€å¯æ’ä»¶ï¼Œå’Œæ·»åŠ ä¸€ä¸ªç”¨æˆ·ä¹‹å¤–ï¼Œè¿˜éœ€è¦æ”¾å¼€é˜²ç«å¢™çš„ç«¯å£12345678firewall-cmd --add-port=4369/tcp --permanentfirewall-cmd --add-port=25672/tcp --permanentfirewall-cmd --add-port=5671-5672/tcp --permanentfirewall-cmd --add-port=15672/tcp --permanentfirewall-cmd --add-port=61613-61614/tcp --permanentfirewall-cmd --add-port=1883/tcp --permanentfirewall-cmd --add-port=8883/tcp --permanentfirewall-cmd --reload # é‡è½½é…ç½® 3. åŒæ­¥Erlang cookieErlang VMå°†å°è¯•åœ¨RabbitMQæœåŠ¡å™¨å¯åŠ¨æ—¶åˆ›å»ºä¸€ä¸ªéšæœºç”Ÿæˆçš„å€¼ï¼ˆErlang Cookieï¼‰ã€‚é›†ç¾¤ç¯å¢ƒä¸­ï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„Erlang Cookieå¿…é¡»ä¸€è‡´ã€‚ .erlang.cookie é€šå¸¸åœ¨ $HOMEä¸‹æˆ–è€…/var/lib/rabbitmqä¸‹1234567# æ‰¾åˆ°å…¶ä¸­ä¸€å°ä¸»æœºçš„ .erlang.cookie# ä¿®æ”¹æƒé™chmod 777 /var/lib/rabbitmq/.erlang.cookie# æ‹·è´åˆ°å¦ä¸€å°ä¸»æœºscp /var/lib/rabbitmq/.erlang.cookie G:/var/lib/rabbitmq/# å†æŠŠæƒé™ä¿®æ”¹å›æ¥chmod 400 /var/lib/rabbitmq/.erlang.cookie 4. æ£€æŸ¥èŠ‚ç‚¹å å¦‚æœä¸¤ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ rabbit@localhostï¼Œè¿™æ˜¯æ— æ³•å»ºç«‹é›†ç¾¤çš„ æˆ‘å½“æ—¶å°±æ˜¯é‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ä¿®æ”¹èŠ‚ç‚¹nameï¼Œå‚è€ƒ https://ubuntuqa.com/article/6619.html æˆ‘é‡‡å–çš„æ–¹æ³•ï¼š1234567vi /etc/rabbitmq/rabbitmq-env.conf# æ·»åŠ å¦‚ä¸‹é…ç½®NODENAME=rabbit@G# ä¿å­˜åï¼Œé‡å¯rabbitmq ç”Ÿæ•ˆservice rabbitmq-server restart 5. ç»„æˆé›†ç¾¤ä¸Šè¿°æ­¥éª¤éƒ½æˆåŠŸåï¼Œæˆ‘ä»¬å¯ä»¥ç»„æˆé›†ç¾¤äº† è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å…ˆå¯åŠ¨rabbitmq@Fï¼Œç„¶årabbit@Gæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼ŒåŠ å…¥Fï¼Œç»„æˆé›†ç¾¤1234rabbitmqctl stop_app # åœæ­¢rabbitmqæœåŠ¡rabbitmqctl reset # æ¸…ç©ºèŠ‚ç‚¹çŠ¶æ€rabbitmqctl join_cluster rabbit@F # åŠ å…¥Fï¼Œç»„æˆé›†ç¾¤rabbitmqctl start_app é›†ç¾¤ä¸­ï¼Œä»»æ„èŠ‚ç‚¹åœæœºåï¼Œæ‰§è¡Œ rabbitmqctl start_app å³å¯å†æ¬¡åŠ å…¥é›†ç¾¤ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ rabbitmqctl cluster_status é•œåƒæ¨¡å¼ä»»æ„rabbitèŠ‚ç‚¹è¾“å…¥å‘½ä»¤ï¼Œå°†æ‰€æœ‰é˜Ÿåˆ—ï¼ŒåŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹ä¸­1rabbitmqctl set_policy ha-all "^" '&#123;"ha-mode":"all"&#125;' 12345678910111213rabbitmqctl set_policy [-p Vhost] Name Pattern Definition [Priority]-p Vhostï¼š å¯é€‰å‚æ•°ï¼Œé’ˆå¯¹æŒ‡å®švhostä¸‹çš„queueè¿›è¡Œè®¾ç½®Name: policyçš„åç§°Pattern: queueçš„åŒ¹é…æ¨¡å¼(æ­£åˆ™è¡¨è¾¾å¼)Definitionï¼šé•œåƒå®šä¹‰ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ha-mode, ha-params, ha-sync-mode ha-mode:æŒ‡æ˜é•œåƒé˜Ÿåˆ—çš„æ¨¡å¼ï¼Œæœ‰æ•ˆå€¼ä¸º all/exactly/nodes allï¼šè¡¨ç¤ºåœ¨é›†ç¾¤ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒ exactlyï¼šè¡¨ç¤ºåœ¨æŒ‡å®šä¸ªæ•°çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒï¼ŒèŠ‚ç‚¹çš„ä¸ªæ•°ç”±ha-paramsæŒ‡å®š nodesï¼šè¡¨ç¤ºåœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒï¼ŒèŠ‚ç‚¹åç§°é€šè¿‡ha-paramsæŒ‡å®š ha-paramsï¼šha-modeæ¨¡å¼éœ€è¦ç”¨åˆ°çš„å‚æ•° ha-sync-modeï¼šè¿›è¡Œé˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„åŒæ­¥æ–¹å¼ï¼Œæœ‰æ•ˆå€¼ä¸ºautomaticå’Œmanualpriorityï¼šå¯é€‰å‚æ•°ï¼Œpolicyçš„ä¼˜å…ˆçº§ å…³äºé•œåƒæ¨¡å¼ç­–ç•¥çš„æ›´å¤šè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.rabbitmq.com/ha.html é›†ç¾¤çš„è´Ÿè½½å‡è¡¡ä¸ºä»€ä¹ˆæœ‰äº†é›†ç¾¤è¿˜éœ€è¦è´Ÿè½½å‡è¡¡ï¼Ÿ è¿™é‡Œæˆ‘çº ç»“äº†å¥½å‡ å¤©ï¼ŒåŸå› æ˜¯ï¼Œåœ¨æˆ‘çš„ç†è§£é‡Œ é›†ç¾¤ == è´Ÿè½½å‡è¡¡ï¼Œè¿™æ ·çš„ç†è§£æ˜¯æœ‰é—®é¢˜çš„ã€‚æ­£è§£ï¼šåˆ†å¸ƒå¼é›†ç¾¤ä¿è¯çš„æ˜¯é«˜å¯ç”¨ï¼Œè€Œå¹¶ä¸æ˜¯è´Ÿè½½å‡è¡¡ã€‚ rabbitmqæ–‡æ¡£ä¸­ï¼Œä¹Ÿå»ºè®®æˆ‘ä»¬ä½¿ç”¨TCPè´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™æ ·ä¹Ÿä¸éœ€è¦åœ¨æˆ‘ä»¬åº”ç”¨ç¨‹åºé‡Œç®¡ç†é›†ç¾¤çš„åœ°å€ Connecting to Clusters from ClientsA client can connect as normal to any node within a cluster. If that node should fail, and the rest of the cluster survives, then the client should notice the closed connection, and should be able to reconnect to some surviving member of the cluster. Generally, itâ€™s not advisable to bake in node hostnames or IP addresses into client applications: this introduces inflexibility and will require client applications to be edited, recompiled and redeployed should the configuration of the cluster change or the number of nodes in the cluster change. Instead, we recommend a more abstracted approach: this could be a dynamic DNS service which has a very short TTL configuration, or a plain TCP load balancer, or some sort of mobile IP achieved with pacemaker or similar technologies. In general, this aspect of managing the connection to nodes within a cluster is beyond the scope of RabbitMQ itself, and we recommend the use of other technologies designed specifically to solve these problems. ç½‘ä¸Šæ¯”è¾ƒå¤šçš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨ HAProxy ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™é‡Œå¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ä¸€ç¯‡ HAProxyä»é›¶å¼€å§‹åˆ°æŒæ¡ å…·ä½“å®‰è£…é…ç½®çš„ç»†èŠ‚æœ¬æ–‡å°±ä¸è¯´äº† è¿™é‡Œæˆ‘åˆæ·»åŠ äº†ä¸€å° 130 çš„è™šæ‹Ÿæœºæ¥è·‘ HAProxy è´´ä¸€ä¸‹æˆ‘çš„ haproxy.cfgï¼Œä»…ä¾›å‚è€ƒ 1234567891011121314151617181920212223242526272829globaldaemonpidfile /home/ha/haproxy/conf/haproxy.pidlog 127.0.0.1 local2defaultsmode tcpmaxconn 10000timeout connect 5stimeout client 100stimeout server 100sfrontend http-in bind *:5670 maxconn 30000 default_backend default_serversbackend default_servers balance roundrobin server F 192.168.32.128:5672 check inter 2000 rise 2 fall 3 weight 1 server G 192.168.32.129:5672 check inter 2000 rise 2 fall 3 weight 1listen stats bind *:1936 mode http stats refresh 30s #æ¯30ç§’æ›´æ–°ç›‘æ§æ•°æ® stats uri /stats #è®¿é—®ç›‘æ§é¡µé¢çš„uri stats realm HAProxy\ Stats #ç›‘æ§é¡µé¢çš„è®¤è¯æç¤º stats auth admin:admin åšå®Œè´Ÿè½½å‡è¡¡ä¹‹åï¼Œå¯ä»¥è·‘ä¸€ä¸‹ç¨‹åºï¼ŒæŸ¥çœ‹ä¸€ä¸‹è´Ÿè½½å‡è¡¡çš„æ•ˆæœï¼Œè¿™é‡Œæˆ‘çš„10ä¸ª Connection æŒ‰ç…§æƒé‡ 1:1 åˆ†é…åœ¨äº†ä¸¤å° Rabbit ä¸Š å‚è€ƒ https://www.cnblogs.com/knowledgesea/p/6535766.htmlhttps://www.rabbitmq.com/clustering.html]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
        <tag>é›†ç¾¤</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RabbitMQ ç†è§£ Exchange]]></title>
    <url>%2Fpost%2Fea1358e6.html</url>
    <content type="text"><![CDATA[æœ¬èŠ‚ç›®æ ‡ äº†è§£ AMQP æ¨¡å‹ äº†è§£ Exchange å»ºè®®å¤§å®¶åœ¨å­¦ä¹ MQä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹ ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„ä¸€ç¯‡ Java ç†è§£ç”Ÿäº§è€…-æ¶ˆè´¹è€…è®¾è®¡æ¨¡å¼ AMQP ç®€ä»‹RabbitMQ æ˜¯å®ç°äº† AMQP åè®®çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ‰€ä»¥è¯´ä¸‹é¢è®²åˆ°è¿™äº›æ¦‚å¿µä¸ä»…é™äºRabbitMQï¼Œæ‰€æœ‰å®ç°AMQP åè®®çš„æ¶ˆæ¯ä¸­é—´ä»¶éƒ½å…·å¤‡è¿™äº› AMQP æ¨¡å‹å›¾å¦‚ä¸‹ Publisherï¼ˆå‘å¸ƒè€…ï¼‰å’Œ Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰å¯ä»¥ç†è§£ä¸ºæ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº Exchangeï¼ˆäº¤æ¢æœºï¼‰ï¼Œæˆ‘ä»¬çš„Publisher ä¼šå°†æ¶ˆæ¯å…ˆæ¨é€åˆ°Exchange ï¼ŒExchange ç±»ä¼¼é‚®å±€ï¼Œä»–ä¼šå°†æ¶ˆæ¯å†è·¯ç”±åˆ° Queueï¼ˆé˜Ÿåˆ—ï¼‰ä¸­ï¼ŒQueueä¼šå°†æ¶ˆæ¯æ¨é€ç»™Consumer Exchange å’Œ Queue ä¹‹é—´é€šè¿‡ Binding ï¼ˆç»‘å®šï¼‰å°†ä¸¤è€…å…³è”åˆ°ä¸€èµ·ï¼Œä¸€ä¸ªExchange å¯ä»¥ç»‘å®šå¤šä¸ªQueueï¼Œä¸€ä¸ªQueue å¯ä»¥ç»‘å®šå¤šä¸ªExchange Exchangeåˆšåˆšæˆ‘ä»¬è¯´Exchangeç±»ä¼¼é‚®å±€ã€‚é‚®å±€çš„è¯ï¼Œå½“ç„¶ä¼šæœ‰å¾ˆå¤šçš„é‚®é€’æ–¹å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„Exchangeæœ‰å¤šç§ç±»å‹ï¼Œæ¯ç§ç±»å‹éƒ½æœ‰è‡ªå·±çš„ç­–ç•¥ AMQP æä¾›å››ç§Exchangeç±»å‹ name é»˜è®¤é¢„è®¾å Direct exchange (Empty string) and amq.direct Fanout exchange amq.fanout Topic exchange amq.topic Headers exchange amq.match (and amq.headers in RabbitMQ) Direct ExchangeRabbit æ–‡æ¡£ä¸­ç»™å‡ºçš„å®šä¹‰ç¿»è¯‘è¿‡æ¥æ˜¯è¿™æ ·çš„ Direct ExchangeåŸºäºRoutingKey å°†æ¶ˆæ¯ä¼ é€’åˆ°é˜Ÿåˆ— é€šä¿—ç‚¹è®²æ˜¯å•¥æ„æ€å‘¢ï¼Œç›´æ¥çœ‹ä»£ç å§ 12// ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºExchangeï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯RoutingKey rabbitTemplate.convertAndSend("user_exchange", "user_routingKey", message); æˆ‘ä»¬å†æ¥çœ‹ç»‘å®šçš„æ—¶å€™ï¼Œä¹Ÿä¼šå…³è”ä¸€ä¸ªRoutingKey12// ç»‘å®šçš„æ—¶å€™ ä¹Ÿä¼šå…³è”ä¸€ä¸ªRoutingKeyBindingBuilder.bind(queue()).to(userExchange()).with("user_routingKey") åƒè¨€ä¸‡è¯­éƒ½åœ¨å›¾é‡Œ Default ExchangeDefault Exchange å…¶å®æ˜¯AMQPä¸­é¢„å…ˆå£°æ˜çš„ï¼Œå¹¶ä¸”å®ƒå±äº Direct Exchangeï¼Œé€šå¸¸æ¥è¯´æ¯ä¸ªExchangeéƒ½ä¼šæœ‰è‡ªå·±çš„åï¼ŒDefault Exchange çš„åæ˜¯ &quot;&quot;. ä»–æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼Œå½“ä½ æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼ŒMQä¼šè‡ªåŠ¨å°†è¿™ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°Default Exchange ä¸Šï¼Œç»‘å®šæ—¶ RoutingKey ä¸é˜Ÿåˆ—åç§°ç›¸åŒ è¯´çš„å¥½åƒæŒºç»•çš„ï¼Œæ¥çœ‹ä¸€ä¸‹ä»£ç å§12345// å£°æ˜ä¸€ä¸ª Queueï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¸ä¸»åŠ¨Bindingçš„è¯ï¼Œtest_queue ä¼šå’ŒDefault Exchange ç»‘å®šï¼Œæ­¤æ—¶ routingKey = test_queueQueue queue = new Queue("test_queue");// å‘é»˜è®¤äº¤æ¢æœºå‘å¸ƒæ¶ˆæ¯rabbitTemplate.convertAndSend("", "test_queue", message); Fanout ExchangeFanout Exchange å¾ˆç®€å•ï¼Œé€‚åˆå‘å¸ƒè®¢é˜…åœºæ™¯ã€‚ä»–ä¸ä½¿ç”¨RoutingKeyï¼Œä»–å°†æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ä¸å…¶ç»‘å®šçš„é˜Ÿåˆ— Topic ExchangeTopic Exchange åˆæ˜¯åŸºäºRoutingKeyæ¥è·¯ç”±è½¬å‘çš„ï¼Œä½†æ˜¯æœ‰äº›ä¸åŒï¼Œä¸Šå›¾ åœ¨ä½¿ç”¨ Topic çš„æ—¶å€™ï¼ŒroutingKey å¯ä»¥æ˜¯ *.orange.*,lazy.# è¿™ç§è¡¨è¾¾å¼ * (æ˜Ÿ) ä»£è¡¨ä¸€ä¸ªè¯. # (hash) ä»£è¡¨0æˆ–å¤šä¸ªè¯. åŒç†ï¼Œå½“å‘å¸ƒæ¶ˆæ¯æ—¶çš„ routingKey ä¸å…¶åŒ¹é…æ—¶ï¼Œä¼šè·¯ç”±åˆ°ç›¸åº”çš„é˜Ÿåˆ— Headers ExchangeåŸºäºHeaderä¸­çš„å±æ€§æ¥åŒ¹é…è·¯ç”±ï¼Œç”±äºä¸æ˜¯å¾ˆå¸¸ç”¨ï¼Œè¿™é‡Œå°±ä¸è¯´äº† å‚è€ƒ https://www.rabbitmq.com/tutorials/amqp-concepts.html]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
        <tag>Exchange</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring æºç è§£æ åŒæ­¥äº‹åŠ¡çš„å®ç°åŸç†]]></title>
    <url>%2Fpost%2Fff158ca0.html</url>
    <content type="text"><![CDATA[åœ¨æœ€å¼€å§‹å­¦ä¹ Spring AOPçš„æ—¶å€™ï¼Œé‚£æ—¶å€™åªçŸ¥é“äº‹åŠ¡æ˜¯åˆ©ç”¨AOPç®¡ç†çš„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç¿»çœ‹è¿‡æºç ï¼Œåæ¥å‘ç°Springä¸å…‰å¯ä»¥ç®¡ç†å…³ç³»å‹æ•°æ®çš„äº‹åŠ¡ã€‚ç”šè‡³å¯ä»¥åŒæ­¥ç®¡ç†Redisç­‰å…¶ä»–æ•°æ®åº“çš„äº‹åŠ¡ï¼Œè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿæœ¬èŠ‚æˆ‘ä»¬ä¸€èµ·æ¢ç´¢ä¸€ä¸‹Springçš„äº‹åŠ¡ ç‰ˆæœ¬SpringBoot 2.1.6.RELEASE åˆ†æé¦–å…ˆå¦‚æœæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªAOPæ¥ç®¡ç†äº‹åŠ¡çš„è¯ï¼Œä¼šæ€ä¹ˆåšï¼Ÿ æ‰§è¡Œä»£ç†æ–¹æ³•å‰å¼€å¯äº‹åŠ¡ æ‰§è¡Œä»£ç†çš„æ–¹æ³• æ‰§è¡Œä»£ç†æ–¹æ³•åå›æ»šæˆ–è€…æäº¤äº‹åŠ¡ å¦‚ä½•å®ç°Redisäº‹åŠ¡çš„åŒæ­¥æäº¤å’Œå›æ»šï¼Ÿ Springä¸­å…³äºäº‹åŠ¡çš„ç®¡ç†è¦æ¯”æˆ‘ä»¬æƒ³è±¡çš„å¤æ‚çš„å¤šï¼Œæœ¬æ–‡åªå…³æ³¨åŒæ­¥äº‹åŠ¡çš„å®ç°ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹æºç  TransactionAspectSupportåœ¨ç¿»çœ‹æºç åæ‰¾åˆ°è¿™ä¸ªç±»ï¼Œäº‹åŠ¡åˆ‡é¢æ”¯æŒï¼Œè¿™ä¸ªç±»å®ç°äº†äº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒé€»è¾‘ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ ¸å¿ƒä»£ç  æˆ‘ä»¬é€šå¸¸åœ¨é¡¹ç›®ä¸­ä¼šä½¿ç”¨é»˜è®¤çš„DataSourceTransactionManageräº‹åŠ¡ç®¡ç†å™¨ + æ³¨è§£å¼äº‹åŠ¡ï¼ˆä¹Ÿå°±æ˜¯å£°æ˜å¼äº‹åŠ¡ï¼‰CallbackPreferringPlatformTransactionManager æ˜¯Springæä¾›çš„å›è°ƒå¼äº‹åŠ¡ç®¡ç†å™¨ï¼ˆç”¨äºç¼–ç¨‹å¼äº‹åŠ¡ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸è®¨è®ºã€‚ å¯ä»¥çœ‹åˆ°å£°æ˜å¼äº‹åŠ¡çš„å¤„ç†é€»è¾‘ï¼Œå’Œæˆ‘ä»¬ä¸Šè¿°åˆ†æçš„åŸºæœ¬ä¸€è‡´ï¼Œé‚£ä¹ˆä»–æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åŒæ­¥å¤„ç†äº†å…¶ä»–æ•°æ®çš„äº‹åŠ¡å‘¢ï¼Ÿç»§ç»­æ·±å…¥æºç  æºç è·Ÿè¸ªæˆ‘ä»¬ä»¥completeTransactionAfterThrowing() è¿™ä¸ªæ–¹æ³•ä¸ºä¾‹ï¼ˆä¸Šå›¾çº¢æ¡†æ¡†ï¼‰ï¼Œè·Ÿè¸ªä¸‹å» å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬å¼‚å¸¸éœ€è¦å›æ»šæ—¶ï¼Œä¼šè°ƒç”¨ TransactionManager.rollback()ï¼Œæˆ‘ä»¬ç»§ç»­æ¥è·Ÿè¸ªè¿™ä¸ªæ–¹æ³• è¿™é‡Œä»£ç é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œæˆ‘ä»¬åªå…³æ³¨çº¢æ¡†é‡Œçš„ä»£ç å—ï¼ŒdoRollbackä¸­åªåšäº†æ•°æ®æºçš„å›æ»šï¼Œé‚£ä¹ˆåƒRedisäº‹åŠ¡çš„æäº¤æ˜¯åœ¨å“ªé‡Œå®ç°çš„ï¼Ÿ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ triggerAfterCompletion() æ–¹æ³•ï¼Œç­”æ¡ˆé©¬ä¸Šå°±çŸ¥é“äº† åŒæ­¥äº‹åŠ¡ TransactionSynchronizationManager ä¸­ä¼šä»ThreadLocal ä¸­è·å–å‡ºå½“å‰çº¿ç¨‹ä¸­ â€œåŒæ­¥äº‹åŠ¡â€æ¥å£é›†åˆ Listï¼Œç„¶åæ¥ä¸‹æ¥çš„æ“ä½œå°±æ˜¯éå†æ‰€æœ‰çš„TransactionSynchronizationï¼Œæ‰§è¡Œsynchronization.afterCompletion(completionStatus); æˆ‘ä»¬å¯ä»¥åœ¨TransactionSynchronizationæ¥å£ä¸‹æ‰¾åˆ°ä¸€ä¸ªRedisçš„å®ç° ä»£ç é€»è¾‘å¾ˆç®€å•ï¼Œäº‹åŠ¡æäº¤åˆ™Redisäº‹åŠ¡æ‰§è¡Œï¼Œå¦åˆ™å–æ¶ˆRedisäº‹åŠ¡ åŒæ­¥äº‹åŠ¡çš„æ³¨å†Œ æˆ‘ä»¬RedisTemplateå¼€å¯äº‹åŠ¡åï¼Œä¼šæ‰§è¡Œåˆ°ä¸Šå›¾çš„debugå¤„ï¼ŒRedisConnection å¼€å¯äº‹åŠ¡ï¼Œå¹¶å°†å½“å‰Connectionæ³¨å†Œåˆ°TransactionSynchronizationManager ä¸­ï¼Œè¿™æ ·åœ¨triggerAfterCompletion å°±å¯ä»¥åŒæ­¥çš„ç®¡ç†æˆ‘ä»¬Redisçš„äº‹åŠ¡äº†]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>æºç </tag>
        <tag>Spring</tag>
        <tag>äº‹åŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç†è§£æ¶ˆæ¯é˜Ÿåˆ— - ä½¿ç”¨åœºæ™¯ç®€ä»‹]]></title>
    <url>%2Fpost%2F81e2e5c7.html</url>
    <content type="text"><![CDATA[åœ¨ä¹‹å‰çš„ Java ç†è§£ç”Ÿäº§è€…-æ¶ˆè´¹è€…è®¾è®¡æ¨¡å¼ ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´é€šè¿‡ä¸€ä¸ªç¼“å†²é˜Ÿåˆ—è¿›è¡Œé€šè®¯ï¼Œå³åšåˆ°äº†å¼‚æ­¥æ¶ˆæ¯ååï¼Œåˆä½¿å¾—ç¨‹åºè§£è€¦ å¯ä»¥è¯´ï¼Œä½¿ç”¨ MQï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ å¯ä»¥åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ é€‚åˆMQä½¿ç”¨çš„åœºæ™¯ æ¶ˆæ¯çš„å‘é€è€…å’Œæ¶ˆè´¹è€…éœ€è¦è§£è€¦çš„æƒ…å†µ å¼‚æ­¥å¤„ç† å¤šä¸ªæ¶ˆè´¹è€…ï¼ˆæ¶ˆæ¯çš„å…³æ³¨è€…ä¸æ­¢ä¸€ä¸ªï¼‰ æ¶ˆè´¹è€…çš„å¤„ç†ç»“æœä¸è¿”å›ç»™å‘é€è€… ï¼ˆä»¥RabbitMQä¸ºä¾‹ï¼Œè™½ç„¶å¯ä»¥åšåˆ°RPCè°ƒç”¨ï¼Œä½†æ˜¯è¿™ç§è°ƒç”¨ä¼šå¸¦æ¥æ›´å¤šçš„éº»çƒ¦ï¼‰ å‰Šå³°å¡«è°· ä¸‹é¢æˆ‘è·Ÿè¯¦ç»†åˆ†æä¸€ä¸‹å„ç§ä½¿ç”¨åœºæ™¯ è§£è€¦ å…¶å®å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€šè¿‡MQè¿›è¡Œé€šè®¯ï¼Œå¯ä»¥è¯´ä¸¤è€…æ²¡æœ‰ä»€ä¹ˆç›´æ¥çš„ç“œè‘›ï¼Œå¿…ç„¶è§£è€¦ å¼‚æ­¥ &amp;&amp; å¤šä¸ªæ¶ˆè´¹è€…ç”Ÿäº§è€…åªè´Ÿè´£æŠŠæ¶ˆæ¯å‘å¸ƒï¼Œå¹¶åœ¨æ„è°å¤„ç†æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªæ¶ˆè´¹è€…å¤„ç†è¯¥æ¶ˆæ¯ ä¾‹å¦‚ç”¨æˆ·æ³¨å†Œï¼Œæˆ‘ä»¬ä¼šç»™ç”¨æˆ·å‘é€æ³¨å†Œé‚®ä»¶å’ŒçŸ­ä¿¡ï¼ˆå¯ä»¥æŠŠé‚®ä»¶å’ŒçŸ­ä¿¡ç†è§£ä¸ºå¤šä¸ªæ¶ˆè´¹è€…æœåŠ¡ï¼‰ å¯ä»¥çœ‹åˆ°åœ¨ä½¿ç”¨äº†MQï¼Œå³å¯ä»¥é€šè¿‡å¼‚æ­¥å¤„ç†çš„æ–¹å¼ï¼Œé™ä½å“åº”æ—¶é—´ï¼Œåˆå¯ä»¥é™ä½ä¸šåŠ¡ä¹‹é—´çš„è€¦åˆåº¦ æ¶ˆè´¹è€…çš„å¤„ç†ç»“æœä¸è¿”å›ç»™å‘é€è€…çº¿ç¨‹æ± å’ŒMQéƒ½å¯ä»¥çœ‹æˆ ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„å®ç°ï¼Œè€Œè¿™ä¸¤è€…ä¹Ÿéƒ½å¯ä»¥è·å¾—æ¶ˆè´¹è€…çš„è¿”å›å€¼ã€‚ä½†æ˜¯å¦‚æœä½ è¿™æ ·åšçš„è¯ï¼Œä½ çš„ç”Ÿäº§è€…çº¿ç¨‹ä¼šé˜»å¡ï¼ˆç­‰å¾…æ¶ˆè´¹è€…çš„è¿”å›ï¼‰ï¼Œæ²¡æ³•åšåˆ°å®Œå…¨å¼‚æ­¥çš„å¤„ç†ï¼Œæœ‰äº›è¿èƒŒäº†ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„åˆè¡·ã€‚è€Œä¸”è¿˜è¦è€ƒè™‘ç­‰å¾…è¶…æ—¶åçš„å¤„ç†ã€‚ä½†æ˜¯ä¸èƒ½è¯´è¿™ç§ç”¨æ³•æ˜¯ä¸å¯¹çš„ï¼Œå…·ä½“ä¸šåŠ¡å…·ä½“åˆ†æ å‰Šå³°å¡«è°·ä½•ä¸ºå‰Šå³°å¡«è°·ï¼Œå¯ä»¥ç†è§£ä¸ºæµé‡æ§åˆ¶ã€‚ä¾‹å¦‚åœ¨æŠ¢ç¥¨ï¼Œç§’æ€ç­‰ä¸šåŠ¡åœºæ™¯æ—¶ï¼Œå¯èƒ½ä¼šçªç„¶æœ‰å¤§é‡çš„è¯·æ±‚æ¶Œå…¥ã€‚ä½†æ˜¯æˆ‘ä»¬çš„æœåŠ¡å™¨èµ„æºæœ‰é™ï¼Œå¹¶ä¸èƒ½å¤„ç†è¿™ä¹ˆå¤šçš„è¯·æ±‚ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ MQè¿›è¡Œæµé‡æ§åˆ¶ å› ä¸ºï¼Œè¯·æ±‚éƒ½ç¼“å­˜åœ¨äº†MQä¸­ï¼Œä¸‹æ¸¸æœåŠ¡å¯ä»¥æ ¹æ®è‡ªå·±çš„é€Ÿåº¦è¿›è¡Œå¤„ç†ã€‚ å‚è€ƒ https://www.kancloud.cn/cosmicyang/rabbitmq/824050]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>MQ</tag>
        <tag>æ¶ˆæ¯é˜Ÿåˆ—</tag>
        <tag>ç”Ÿäº§è€…æ¶ˆè´¹è€…</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java ç†è§£ ThreadPoolExecutor å®ç°åŸç†]]></title>
    <url>%2Fpost%2Fa5233273.html</url>
    <content type="text"><![CDATA[ä½¿ç”¨çº¿ç¨‹æ± ï¼ˆThreadPoolExecutorï¼‰çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€èŠ±çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºçš„å¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜ã€‚å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½é€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜ã€‚ â€“ é˜¿é‡ŒJavaå¼€å‘æ‰‹å†Œ ç‰ˆæœ¬JDK 1.8 æœ¬èŠ‚ç›®æ ‡ ç†è§£çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•° ç†è§£çº¿ç¨‹æ± å·¥ä½œåŸç† ç†è§£çº¿ç¨‹æ± æ ¸å¿ƒæ–¹æ³• çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°å’Œæ„é€ æ–¹æ³•ctl12345678910111213141516171819202122232425262728293031323334353637// çº¿ç¨‹æ± æ ¸å¿ƒå˜é‡ï¼ŒåŒ…å«çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€å’Œæœ‰æ•ˆçº¿ç¨‹æ•°ï¼Œåˆ©ç”¨äºŒè¿›åˆ¶çš„ä½æ©ç å®ç°private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));private static final int COUNT_BITS = Integer.SIZE - 3;private static final int CAPACITY = (1 &lt;&lt; COUNT_BITS) - 1;// runState is stored in the high-order bits// çº¿ç¨‹æ± çŠ¶æ€private static final int RUNNING = -1 &lt;&lt; COUNT_BITS;private static final int SHUTDOWN = 0 &lt;&lt; COUNT_BITS;private static final int STOP = 1 &lt;&lt; COUNT_BITS;private static final int TIDYING = 2 &lt;&lt; COUNT_BITS;private static final int TERMINATED = 3 &lt;&lt; COUNT_BITS;// Packing and unpacking ctl// è·å–å½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€private static int runStateOf(int c) &#123; return c &amp; ~CAPACITY; &#125;// è·å–å½“å‰çº¿ç¨‹æ± æœ‰æ•ˆçº¿ç¨‹æ•°private static int workerCountOf(int c) &#123; return c &amp; CAPACITY; &#125;// æ‰“åŒ…ctlå˜é‡private static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125;/* * Bit field accessors that don't require unpacking ctl. * These depend on the bit layout and on workerCount being never negative. */private static boolean runStateLessThan(int c, int s) &#123; return c &lt; s;&#125;private static boolean runStateAtLeast(int c, int s) &#123; return c &gt;= s;&#125;private static boolean isRunning(int c) &#123; return c &lt; SHUTDOWN;&#125; JDK7 ä»¥åï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€å’Œæœ‰æ•ˆçº¿ç¨‹æ•°é€šè¿‡ ctl è¿™ä¸ªå˜é‡è¡¨ç¤ºï¼ˆä½¿ç”¨äºŒè¿›åˆ¶çš„ä½æ©ç æ¥å®ç°ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸æ·±ç©¶ï¼‰ï¼Œç†è§£ä¸Šè¿°å‡ ä¸ªæ–¹æ³•ä½œç”¨å³å¯ï¼Œä¸å½±å“ä¸‹é¢çš„æºç é˜…è¯» å…³äºçº¿ç¨‹æ± çš„äº”ç§çŠ¶æ€ RUNNINGï¼šæ¥å—æ–°ä»»åŠ¡å¹¶å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ SHUTDOWN ï¼šä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä½†å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ STOP ï¼šä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå¹¶ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼ˆä¸­æ–­å¹¶ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œåªæ˜¯ä¿®æ”¹äº†Threadçš„çŠ¶æ€ï¼Œæ˜¯å¦ä¸­æ–­å–å†³äºRunnable çš„å®ç°é€»è¾‘ï¼‰ TIDYING ï¼šæ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»ˆæ­¢ï¼ŒworkerCountä¸º0æ—¶ï¼Œçº¿ç¨‹æ± ä¼šè¿‡åº¦åˆ°è¯¥çŠ¶æ€ï¼Œå¹¶å³å°†è°ƒç”¨ terminate() TERMINATED ï¼šterminated() è°ƒç”¨å®Œæˆï¼›çº¿ç¨‹æ± ä¸­æ­¢ çº¿ç¨‹æ± çŠ¶æ€çš„è½¬æ¢ RUNNING =&gt; SHUTDOWN ï¼šè°ƒç”¨ shutdown() RUNNING / SHUTDOWN =&gt; STOP ï¼šè°ƒç”¨ shutdownNow() ï¼ˆè¯¥æ–¹æ³•ä¼šè¿”å›é˜Ÿåˆ—ä¸­æœªæ‰§è¡Œçš„ä»»åŠ¡ï¼‰ SHUTDOWN =&gt; TIDYINGï¼š å½“çº¿ç¨‹æ± å’Œé˜Ÿåˆ—éƒ½ä¸ºç©ºæ—¶ STOP =&gt; TIDYINGï¼šå½“çº¿ç¨‹æ± ä¸ºç©ºæ—¶ TIDYING =&gt; TERMINATEDï¼šå½“ terminated() è°ƒç”¨å®Œæˆæ—¶ æ„é€ æ–¹æ³•çº¿ç¨‹æ± æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨å¦‚ä¸‹æ„é€ æ–¹æ³•123456789public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) &#123; // çœç•¥&#125; æ ¸å¿ƒå‚æ•°æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹çº¿ç¨‹æ± ä¸­çš„æ ¸å¿ƒå‚æ•°éƒ½æ˜¯ä»€ä¹ˆä½œç”¨123456789101112131415161718192021222324private final BlockingQueue&lt;Runnable&gt; workQueue; // é˜»å¡é˜Ÿåˆ—ï¼Œç”¨äºç¼“å­˜ä»»åŠ¡private final ReentrantLock mainLock = new ReentrantLock(); // çº¿ç¨‹æ± ä¸»é”private final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;(); // å·¥ä½œçº¿ç¨‹é›†åˆprivate final Condition termination = mainLock.newCondition(); // awaitTermination() æ–¹æ³•çš„ç­‰å¾…æ¡ä»¶private int largestPoolSize; // è®°å½•æœ€å¤§çº¿ç¨‹æ± å¤§å°private long completedTaskCount; //ç”¨æ¥è®°å½•çº¿ç¨‹æ± ä¸­æ›¾ç»å‡ºç°è¿‡çš„æœ€å¤§çº¿ç¨‹æ•°private volatile ThreadFactory threadFactory; // çº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹private volatile RejectedExecutionHandler handler; // ä»»åŠ¡æ‹’ç»æ—¶çš„ç­–ç•¥private volatile long keepAliveTime; // çº¿ç¨‹å­˜æ´»æ—¶é—´ // å½“çº¿ç¨‹æ•°è¶…è¿‡æ ¸å¿ƒæ± æ•°æ—¶ï¼Œæˆ–å…è®¸æ ¸å¿ƒæ± çº¿ç¨‹è¶…æ—¶ï¼Œè¯¥å‚æ•°ä¼šèµ·ä½œç”¨ã€‚å¦åˆ™ä¸€ç›´ä¼šç­‰å¾…æ–°çš„ä»»åŠ¡private volatile boolean allowCoreThreadTimeOut; // æ˜¯å¦å…è®¸æ ¸å¿ƒæ± çº¿ç¨‹è¶…æ—¶private volatile int corePoolSize; // æ ¸å¿ƒçº¿ç¨‹æ± æ•°é‡private volatile int maximumPoolSize; // æœ€å¤§çº¿ç¨‹æ± æ•°é‡ workQueueè¿™ä¸ªé˜Ÿåˆ—çš„ä½œç”¨ï¼Œå’Œä¹‹å‰çš„ Java ç†è§£ç”Ÿäº§è€…-æ¶ˆè´¹è€…è®¾è®¡æ¨¡å¼ ä¸­è®²åˆ°çš„ç¼“å†²é˜Ÿåˆ—ï¼Œä½œç”¨å¾ˆç›¸ä¼¼ï¼Œæˆ–è€…è¯´çº¿ç¨‹æ± å°±æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„ä¸€ç§å®ç°ã€‚ å…³äº handler ThreadPoolExecutor.AbortPolicy:ä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸ã€‚ ThreadPoolExecutor.DiscardPolicyï¼šä¹Ÿæ˜¯ä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚ ThreadPoolExecutor.DiscardOldestPolicyï¼šä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°å°è¯•æ‰§è¡Œä»»åŠ¡ï¼ˆé‡å¤æ­¤è¿‡ç¨‹ï¼‰ ThreadPoolExecutor.CallerRunsPolicyï¼šå½“å‰ä»»åŠ¡è‡ªå·±å†³å®š corePoolSize å’Œ maximumPoolSizeå¦‚æœä½ å¯¹è¿™ä¸¤ä¸ªå‚æ•°æœ‰ç–‘é—®ï¼Œçœ‹å®Œä¸‹é¢çš„æ —å­ä½ ä¼šæ¸…æ™°å¾ˆå¤š ä¸‹é¢æˆ‘ä»¬æ¥ä¸¾ä¸ªæ —å­æ¥æ›´å¥½çš„ç†è§£ä¸€ä¸‹çº¿ç¨‹æ±  ç†è§£çº¿ç¨‹æ± å·¥ä½œåŸç†å‡å¦‚æœ‰ä¸€ä¸ªå·¥å‚ï¼Œå·¥å‚é‡Œé¢æœ‰10ä¸ªå·¥äººï¼Œæ¯ä¸ªå·¥äººåŒæ—¶åªèƒ½åšä¸€ä»¶ä»»åŠ¡ã€‚ å› æ­¤åªè¦å½“10ä¸ªå·¥äººä¸­æœ‰å·¥äººæ˜¯ç©ºé—²çš„ï¼Œæ¥äº†ä»»åŠ¡å°±åˆ†é…ç»™ç©ºé—²çš„å·¥äººåšï¼› å½“10ä¸ªå·¥äººéƒ½æœ‰ä»»åŠ¡åœ¨åšæ—¶ï¼Œå¦‚æœè¿˜æ¥äº†ä»»åŠ¡ï¼Œå°±æŠŠä»»åŠ¡è¿›è¡Œæ’é˜Ÿç­‰å¾…ï¼› æ¯ä¸ªå·¥äººåšå®Œè‡ªå·±çš„ä»»åŠ¡åï¼Œä¼šå»ä»»åŠ¡é˜Ÿåˆ—ä¸­é¢†å–æ–°çš„ä»»åŠ¡ï¼› å¦‚æœè¯´æ–°ä»»åŠ¡æ•°ç›®å¢é•¿çš„é€Ÿåº¦è¿œè¿œå¤§äºå·¥äººåšä»»åŠ¡çš„é€Ÿåº¦ï¼ˆä»»åŠ¡ç´¯ç§¯è¿‡å¤šæ—¶ï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶å·¥å‚ä¸»ç®¡å¯èƒ½ä¼šæƒ³è¡¥æ•‘æªæ–½ï¼Œæ¯”å¦‚é‡æ–°æ‹›4ä¸ªä¸´æ—¶å·¥äººè¿›æ¥ï¼› ç„¶åå°±å°†ä»»åŠ¡ä¹Ÿåˆ†é…ç»™è¿™4ä¸ªä¸´æ—¶å·¥äººåšï¼› å¦‚æœè¯´ç€14ä¸ªå·¥äººåšä»»åŠ¡çš„é€Ÿåº¦è¿˜æ˜¯ä¸å¤Ÿï¼Œæ­¤æ—¶å·¥å‚ä¸»ç®¡å¯èƒ½å°±è¦è€ƒè™‘ä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡æˆ–è€…æŠ›å¼ƒå‰é¢çš„ä¸€äº›ä»»åŠ¡äº†ã€‚ å½“è¿™14ä¸ªå·¥äººå½“ä¸­æœ‰äººç©ºé—²æ—¶ï¼Œè€Œæ–°ä»»åŠ¡å¢é•¿çš„é€Ÿåº¦åˆæ¯”è¾ƒç¼“æ…¢ï¼Œå·¥å‚ä¸»ç®¡å¯èƒ½å°±è€ƒè™‘è¾æ‰4ä¸ªä¸´æ—¶å·¥äº†ï¼Œåªä¿æŒåŸæ¥çš„10ä¸ªå·¥äººï¼Œæ¯•ç«Ÿè¯·é¢å¤–çš„å·¥äººæ˜¯è¦èŠ±é’±çš„ã€‚ å¼€å§‹å·¥å‚çš„10ä¸ªå·¥äººï¼Œå°±æ˜¯ corePoolSize (æ ¸å¿ƒæ± æ•°é‡)ï¼› å½“10ä¸ªäººéƒ½åœ¨å·¥ä½œæ—¶ (æ ¸å¿ƒæ± è¾¾åˆ° corePoolSize)ï¼Œä»»åŠ¡æ’é˜Ÿç­‰å¾…æ—¶ï¼Œä¼šç¼“å­˜åˆ° workQueue ä¸­ï¼› å½“ä»»åŠ¡ç´¯ç§¯è¿‡å¤šæ—¶(è¾¾åˆ° workQueue æœ€å¤§å€¼æ—¶)ï¼Œæ‰¾ä¸´æ—¶å·¥ï¼› 14ä¸ªä¸´æ—¶å·¥ï¼Œå°±æ˜¯ maximumPoolSize (æ•°é‡)ï¼› å¦‚æœæ­¤æ—¶å·¥ä½œé€Ÿåº¦è¿˜æ˜¯ä¸å¤Ÿï¼Œçº¿ç¨‹æ± è¿™æ—¶ä¼šè€ƒè™‘æ‹’ç»ä»»åŠ¡ï¼Œå…·ä½“ç”±æ‹’ç»ç­–ç•¥å†³å®š ç†è§£çº¿ç¨‹æ± æ ¸å¿ƒæ–¹æ³•execute()çº¿ç¨‹æ± ä¸­æ‰€æœ‰æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•æœ‰å…³çš„æ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨ execute()ã€‚å¦‚æœä½ ç†è§£äº†ä¸Šè¿°çš„å°ä¾‹å­ï¼Œå†æ¥çœ‹è¿™ä¸ªä¼šæ¸…æ™°å¾ˆå¤š123456789101112131415161718192021222324252627282930313233343536373839public void execute(Runnable command) &#123; if (command == null) throw new NullPointerException(); /* * Proceed in 3 steps: * * 1. If fewer than corePoolSize threads are running, try to * start a new thread with the given command as its first * task. The call to addWorker atomically checks runState and * workerCount, and so prevents false alarms that would add * threads when it shouldn't, by returning false. * * 2. If a task can be successfully queued, then we still need * to double-check whether we should have added a thread * (because existing ones died since last checking) or that * the pool shut down since entry into this method. So we * recheck state and if necessary roll back the enqueuing if * stopped, or start a new thread if there are none. * * 3. If we cannot queue task, then we try to add a new * thread. If it fails, we know we are shut down or saturated * and so reject the task. */ int c = ctl.get(); if (workerCountOf(c) &lt; corePoolSize) &#123; if (addWorker(command, true)) return; c = ctl.get(); &#125; if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; int recheck = ctl.get(); if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); else if (workerCountOf(recheck) == 0) addWorker(null, false); &#125; else if (!addWorker(command, false)) reject(command);&#125; åˆ†æexecute() step 1 1ï¼‰é¦–å…ˆæ£€æŸ¥å½“å‰æœ‰æ•ˆçº¿ç¨‹æ•° æ˜¯å¦å°äº æ ¸å¿ƒæ± æ•°é‡if (workerCountOf(c) &lt; corePoolSize) 2ï¼‰å¦‚æœæ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œåˆ™å°è¯•å‘æ ¸å¿ƒæ± æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ ï¼ˆaddWorker() ç¬¬äºŒä¸ªå‚æ•°å†³å®šäº†æ˜¯æ·»åŠ æ ¸å¿ƒæ± ï¼Œè¿˜æ˜¯æœ€å¤§æ± ï¼‰if (addWorker(command, true)) 3ï¼‰å¦‚æœæˆåŠŸåˆ™é€€å‡ºæ–¹æ³•ï¼Œå¦åˆ™å°†æ‰§è¡Œ step2 step 2 1ï¼‰å¦‚æœå½“å‰çº¿ç¨‹æ± å¤„äºè¿è¡ŒçŠ¶æ€ &amp;&amp; å°è¯•å‘ç¼“å†²é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡if (isRunning(c) &amp;&amp; workQueue.offer(command)) 2ï¼‰å¦‚æœçº¿ç¨‹æ± æ­£åœ¨è¿è¡Œå¹¶ä¸”ç¼“å†²é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡æˆåŠŸï¼Œè¿›è¡Œ double checkï¼ˆå†æ¬¡æ£€æŸ¥ï¼‰ 3ï¼‰å¦‚æœæ­¤æ—¶çº¿ç¨‹æ± éè¿è¡ŒçŠ¶æ€ =&gt; ç§»é™¤é˜Ÿåˆ— =&gt; æ‹’ç»å½“å‰ä»»åŠ¡ï¼Œé€€å‡ºæ–¹æ³•ï¼ˆè¿™ä¹ˆåšæ˜¯ä¸ºäº†ï¼Œå½“çº¿ç¨‹æ± ä¸å¯ç”¨æ—¶åŠæ—¶å›æ»šï¼‰ 12if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); 4ï¼‰å¦‚æœå½“å‰æœ‰æ•ˆçº¿ç¨‹æ•°ä¸º0ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ— ä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹ï¼ˆæ­¤æ—¶è¿™ä¸ªçº¿ç¨‹ä¼šå»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼‰ step 3 1ï¼‰å½“æ— æ³•æ— æ³•å‘æ ¸å¿ƒæ± å’Œé˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šå†å°è¯•å‘æœ€å¤§æ± ä¸­æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœå¤±è´¥åˆ™æ‹’ç»è¯¥ä»»åŠ¡ 12else if (!addWorker(command, false)) reject(command); å›¾è§£execute()æ ¹æ®ä¸Šè¿°çš„æ­¥éª¤ç”»äº†å¦‚ä¸‹çš„è¿™ä¸ªå›¾ï¼Œå¸Œæœ›èƒ½å¸®åŠ©å¤§å®¶æ›´å¥½çš„ç†è§£ addWorker()åœ¨åˆ†æexecute() æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† addWorker() çš„ä½œç”¨äº†ï¼Œå¯ä»¥å‘æ ¸å¿ƒæ± æˆ–è€…æœ€å¤§æ± æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•éƒ½åšäº†ä»€ä¹ˆ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566private boolean addWorker(Runnable firstTask, boolean core) &#123; retry: for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; for (;;) &#123; int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125; &#125; boolean workerStarted = false; boolean workerAdded = false; Worker w = null; try &#123; w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); workers.add(w); int s = workers.size(); if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; t.start(); workerStarted = true; &#125; &#125; &#125; finally &#123; if (! workerStarted) addWorkerFailed(w); &#125; return workerStarted;&#125; è¿™ä¸ªæ–¹æ³•ä»£ç çœ‹ä¼¼å¾ˆå¤æ‚ï¼Œæ²¡å…³ç³»ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥åˆ†æ step 1å…ˆçœ‹ç¬¬ä¸€éƒ¨åˆ† 12345678910111213141516171819202122232425retry:for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; for (;;) &#123; int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125;&#125; è¿™ä¸€éƒ¨åˆ†ä»£ç ï¼Œä¸»è¦æ˜¯åˆ¤æ–­ï¼Œæ˜¯å¦å¯ä»¥æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚ åœ¨execute()ä¸­å·²ç»åˆ¤æ–­è¿‡if (workerCountOf(c) &lt; corePoolSize)äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å†åˆ¤æ–­ï¼Ÿ å› ä¸ºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå½“ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œå¯èƒ½çº¿ç¨‹æ± å·²ç»å…³é—­äº†ï¼Œæˆ–è€…å…¶ä»–çº¿ç¨‹æäº¤äº†ä»»åŠ¡ï¼Œå¯¼è‡´workerCountOf(c) &gt; corePoolSize 1ï¼‰é¦–å…ˆè¿›å…¥ç¬¬ä¸€ä¸ªæ— é™forå¾ªç¯ï¼Œè·å–ctlå¯¹è±¡ï¼Œè·å–å½“å‰çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼Œç„¶ååˆ¤æ–­12345if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; è¿™ä¸ªåˆ¤æ–­çš„æ„ä¹‰ä¸ºï¼Œå½“çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ &gt;= SHUTDOWN æ—¶ï¼Œå‘æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¿…é¡»åŒæ—¶æ»¡è¶³ rs == SHUTDOWN firstTask == null ! workQueue.isEmpty()ä¸‰ä¸ªæ¡ä»¶ï¼Œå¦åˆ™æ·»åŠ çº¿ç¨‹å¤±è´¥ æ‰€ä»¥å½“çº¿ç¨‹çŠ¶æ€ä¸ºSHUTDOWNæ—¶ï¼Œçº¿ç¨‹æ± å…è®¸æ·»åŠ ä¸€ä¸ªæ— ä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹å»æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚ 2ï¼‰è¿›å…¥ç¬¬äºŒä¸ªæ— é™forå¾ªç¯ 123456789101112for (;;) &#123; int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop&#125; è·å–å½“å‰æœ‰æ•ˆçº¿ç¨‹æ•°ï¼Œif æœ‰æ•ˆçº¿ç¨‹æ•° &gt;= å®¹é‡ || æœ‰æ•ˆçº¿ç¨‹æ•° &gt;= æ ¸å¿ƒæ± æ•°é‡/æœ€å¤§æ± æ•°é‡ï¼Œåˆ™return false; æ·»åŠ çº¿ç¨‹å¤±è´¥ å¦‚æœæœ‰æ•ˆçº¿ç¨‹æ•°åœ¨åˆç†èŒƒå›´ä¹‹å†…ï¼Œå°è¯•ä½¿ç”¨ CAS è‡ªå¢æœ‰æ•ˆçº¿ç¨‹æ•° ï¼ˆCAS æ˜¯Javaä¸­çš„ä¹è§‚é”ï¼Œä¸äº†è§£çš„å°ä¼™ä¼´å¯ä»¥Googleä¸€ä¸‹ï¼‰ï¼Œä¹è§‚é”è‡ªå¢æˆåŠŸï¼Œä»£è¡¨å½“å‰æ— å…¶ä»–çº¿ç¨‹ç«äº‰ï¼Œç›¸å½“äºè·å–åˆ°é”äº† å¦‚æœè‡ªå¢æˆåŠŸï¼Œbreak retry; è·³å‡ºè¿™ä¸¤ä¸ªå¾ªç¯ï¼Œæ‰§è¡Œä¸‹é¢çš„ä»£ç  è‡ªå¢å¤±è´¥ï¼Œæ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå›åˆ°ç¬¬ä¸€ä¸ªfor ç»§ç»­æ‰§è¡Œï¼›å¦åˆ™ç»§ç»­åœ¨ç¬¬äºŒä¸ªfor ä¸­ï¼› step 2ä¸‹é¢è¿™éƒ¨åˆ†å°±æ¯”è¾ƒç®€å•äº† 1234567891011121314151617181920212223242526272829303132333435363738boolean workerStarted = false;boolean workerAdded = false;Worker w = null;try &#123; w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); workers.add(w); int s = workers.size(); if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; t.start(); workerStarted = true; &#125; &#125;&#125; finally &#123; if (! workerStarted) addWorkerFailed(w);&#125;return workerStarted; 1ï¼‰åˆ›å»ºå·¥ä½œçº¿ç¨‹å¯¹è±¡Workerï¼› 2ï¼‰åŠ é”ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦å…è®¸å¯åŠ¨çº¿ç¨‹ï¼›å¦‚æœå¯ä»¥ï¼Œå°†çº¿ç¨‹åŠ å…¥workersï¼ˆè¿™ä¸ªå˜é‡åœ¨éœ€è¦éå†æ‰€æœ‰å·¥ä½œçº¿ç¨‹æ—¶ä¼šç”¨åˆ°ï¼‰ï¼Œè®°å½•æœ€å¤§å€¼ï¼Œå¯åŠ¨çº¿ç¨‹ï¼› 3ï¼‰å¦‚æœçº¿ç¨‹å¯åŠ¨å¤±è´¥ï¼Œæ‰§è¡ŒaddWorkerFailedï¼ˆä»workersä¸­ç§»é™¤è¯¥å¯¹è±¡ï¼Œæœ‰æ•ˆçº¿ç¨‹æ•°å‡ä¸€ï¼Œå°è¯•ä¸­æ­¢çº¿ç¨‹æ± ï¼‰ WorkerWorkerå¯¹è±¡æ˜¯çº¿ç¨‹æ± ä¸­çš„å†…éƒ¨ç±»ï¼Œçº¿ç¨‹çš„å¤ç”¨ã€çº¿ç¨‹è¶…æ—¶éƒ½æ˜¯åœ¨è¿™å®ç°çš„ 123456789private final class Worker extends AbstractQueuedSynchronizer implements Runnable&#123; // è¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒRun()ï¼Œçœç•¥äº†å…¶ä»–æºç ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±çœ‹ä¸€ä¸‹æºç  public void run() &#123; runWorker(this); &#125;&#125; Worker å®ç°äº† Runnableï¼Œæˆ‘ä»¬è¿™é‡Œåªå…³å¿ƒ Worker çš„runæ–¹æ³•ä¸­åšäº†ä»€ä¹ˆï¼Œå…³äº AbstractQueuedSynchronizer æœ‰å…³çš„ä¸åœ¨æœ¬æ–‡è®¨è®º ä¸‹é¢æˆ‘ä»¬åˆ†æä¸€ä¸‹runWorker()1234567891011121314151617181920212223242526272829303132333435363738394041424344final void runWorker(Worker w) &#123; Thread wt = Thread.currentThread(); Runnable task = w.firstTask; w.firstTask = null; w.unlock(); // allow interrupts boolean completedAbruptly = true; try &#123; while (task != null || (task = getTask()) != null) &#123; w.lock(); // If pool is stopping, ensure thread is interrupted; // if not, ensure thread is not interrupted. This // requires a recheck in second case to deal with // shutdownNow race while clearing interrupt if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); try &#123; beforeExecute(wt, task); Throwable thrown = null; try &#123; task.run(); &#125; catch (RuntimeException x) &#123; thrown = x; throw x; &#125; catch (Error x) &#123; thrown = x; throw x; &#125; catch (Throwable x) &#123; thrown = x; throw new Error(x); &#125; finally &#123; afterExecute(task, thrown); &#125; &#125; finally &#123; task = null; w.completedTasks++; w.unlock(); &#125; &#125; // é€šè¿‡è¯¥å˜é‡åˆ¤æ–­æ˜¯ç”¨æˆ·ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸ç»“æŸï¼Œè¿˜æ˜¯çº¿ç¨‹æ± è‡ªç„¶ç»“æŸ completedAbruptly = false; &#125; finally &#123; processWorkerExit(w, completedAbruptly); &#125;&#125; 1ï¼‰123 while (task != null || (task = getTask()) != null) &#123;// ...&#125; ä¸å¯¹åœ°é€šè¿‡getTask() ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼Œå¯ä»¥é—´æ¥é€šè¿‡getTask()çš„è¿”å›å€¼æ§åˆ¶çº¿ç¨‹çš„ç»“æŸ 2ï¼‰123456789// If pool is stopping, ensure thread is interrupted;// if not, ensure thread is not interrupted. This// requires a recheck in second case to deal with// shutdownNow race while clearing interruptif ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); æ¥ä¸‹æ¥è¿™ä¸ªåˆ¤æ–­ï¼Œå…¶å®æˆ‘æ˜¯æ²¡æœ‰å¤ªç†è§£çš„ï¼Œæš‚ä¸”è®¤ä¸ºæ˜¯ä¿è¯å½“çº¿ç¨‹æ± STOPæ—¶ï¼Œçº¿ç¨‹ä¸€å®šä¼šè¢«æ‰“æ–­ 3ï¼‰æ‰§è¡ŒRunnable12345678910111213141516171819try &#123; beforeExecute(wt, task); Throwable thrown = null; try &#123; task.run(); &#125; catch (RuntimeException x) &#123; thrown = x; throw x; &#125; catch (Error x) &#123; thrown = x; throw x; &#125; catch (Throwable x) &#123; thrown = x; throw new Error(x); &#125; finally &#123; afterExecute(task, thrown); &#125;&#125; finally &#123; task = null; w.completedTasks++; w.unlock();&#125; beforeExecute(wt, task); å’Œ afterExecute(task, thrown); é»˜è®¤æ˜¯æ²¡æœ‰å®ç°çš„ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ‰©å±• 4ï¼‰æœ€åæ˜¯å½“è·³å‡ºwhileå¾ªç¯åï¼ˆgetTask() == nullæˆ–è€…ç”¨æˆ·ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œä¼šå»æ‰§è¡ŒprocessWorkerExit(w, completedAbruptly);çº¿ç¨‹é€€å‡ºå·¥ä½œï¼ˆè¯¥æ–¹æ³•ä¼šæ ¹æ®çº¿ç¨‹æ± çŠ¶æ€ï¼Œå°è¯•ä¸­æ­¢çº¿ç¨‹æ± ã€‚ç„¶åä¼šè€ƒè™‘æ˜¯ç»“æŸå½“å‰çº¿ç¨‹ï¼Œè¿˜æ˜¯å†æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œè¿™é‡Œå°±ä¸ç»†è¯´äº†ï¼‰ æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ getTask() æ–¹æ³•12345678910111213141516171819202122232425262728293031323334353637private Runnable getTask() &#123; boolean timedOut = false; // Did the last poll() time out? for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123; decrementWorkerCount(); return null; &#125; int wc = workerCountOf(c); // Are workers subject to culling? boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize; if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123; if (compareAndDecrementWorkerCount(c)) return null; continue; &#125; try &#123; Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take(); if (r != null) return r; timedOut = true; &#125; catch (InterruptedException retry) &#123; timedOut = false; &#125; &#125;&#125; 1ï¼‰ ç¬¬ä¸€æ®µä¸åšè§£é‡Šï¼Œæ»¡è¶³è¯¥æ¡ä»¶æ—¶ï¼Œreturn null; é€€å‡ºçº¿ç¨‹12345// Check if queue empty only if necessary.if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123; decrementWorkerCount(); return null;&#125; 2ï¼‰ ä¸‹é¢è¿™æ®µå¾ˆæœ‰æ„æ€12345678910111213141516int wc = workerCountOf(c);// Are workers subject to culling?// æ˜¯å¦å…è®¸çº¿ç¨‹è¶…æ—¶// å½“æˆ‘ä»¬è®¾ç½®äº†å…è®¸æ ¸å¿ƒæ± è¶…æ—¶ æˆ–è€… æœ‰æ•ˆçº¿ç¨‹æ•° &gt; æ ¸å¿ƒæ± æ•°é‡çš„æ—¶å€™// çº¿ç¨‹æ± ä¼šè€ƒè™‘ä¸ºæˆ‘ä»¬æ¸…é™¤æ‰ä¸€äº›çº¿ç¨‹boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;// (æœ‰æ•ˆçº¿ç¨‹æ•° &gt; æœ€å¤§çº¿ç¨‹æ± æ•°é‡ || (å…è®¸è¶…æ—¶ &amp;&amp; è¶…æ—¶) ) // &amp;&amp; (æœ‰æ•ˆçº¿ç¨‹æ•° &gt; 1 || æˆ–è€…é˜Ÿåˆ—ä¸ºç©ºæ—¶)if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) // timedOut è¡¨ç¤ºå½“å‰çº¿ç¨‹è¶…æ—¶ï¼Œä¸‹æ–‡ä¼šè¯´åˆ° &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123; if (compareAndDecrementWorkerCount(c)) return null; continue;&#125; æˆ‘åœ¨ç¬¬ä¸€æ¬¡çœ‹è¿™æ®µä»£ç çš„æ—¶å€™ï¼Œå‚»å‚»çš„ä»¥ä¸º timedOut ä¸æ˜¯æ°¸è¿œä¸ºfalseå—ï¼Œæˆ‘ä»¥ä¸ºJDKæºç æ€ä¹ˆå†™å‡ºè¿™ä¹ˆä¸ªBugã€‚åˆ«å¿˜äº†å½“å‰çš„getTask()æ–¹æ³•ä¹Ÿæ˜¯åœ¨ä¸€ä¸ªæ— é™å¾ªç¯é‡Œ 3ï¼‰12345678910try &#123; Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take(); if (r != null) return r; timedOut = true;&#125; catch (InterruptedException retry) &#123; timedOut = false;&#125; æ ¹æ® timedï¼Œå†³å®šè°ƒç”¨ä½¿ç”¨poll() æˆ–è€… take()ã€‚ poll åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ä¼šç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œå¦‚æœè¿™æœŸé—´æ²¡æœ‰è·å–åˆ°å…ƒç´ ï¼Œåˆ™return null take åˆ™åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´è‡³é˜Ÿåˆ—ä¸­è¢«æ·»åŠ æ–°çš„ä»»åŠ¡ï¼Œæˆ–è€…è¢«æ‰“æ–­ï¼›è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè¢«shutdown() æˆ–è€… shutdownNowçš„ thread.interrupt()æ‰“æ–­ï¼›å¦‚æœè¢«æ‰“æ–­åˆ™å›åˆ°ç¬¬ä¸€æ­¥ è‡³æ­¤ execute() æ–¹æ³•æ‰€æ¶‰åŠçš„é€»è¾‘æˆ‘ä»¬å·®ä¸å¤šåˆ†æå®Œäº† å¤‡æ³¨çº¿ç¨‹æ± ä½¿ç”¨1234567891011121314public class Test &#123; public static void main(String[] args) &#123; ThreadPoolExecutor executor = new ThreadPoolExecutor(5, 10, 60, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(5)); executor.execute(() -&gt; &#123; // ä¸šåŠ¡é€»è¾‘ &#125;); executor.shutdown(); &#125;&#125; åˆç†é…ç½®çº¿ç¨‹æ± çš„å¤§å°ä¸€èˆ¬éœ€è¦æ ¹æ®ä»»åŠ¡çš„ç±»å‹æ¥é…ç½®çº¿ç¨‹æ± å¤§å°ï¼š å¦‚æœæ˜¯CPUå¯†é›†å‹ä»»åŠ¡ï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ä¸º N+1 ï¼ˆN ä¸ºCPUæ ¸å¿ƒæ•°ï¼‰ å¦‚æœæ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ç½®ä¸º2*N å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå‚è€ƒå€¼ï¼Œå…·ä½“çš„è®¾ç½®è¿˜éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ï¼Œæ¯”å¦‚å¯ä»¥å…ˆå°†çº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸ºå‚è€ƒå€¼ï¼Œå†è§‚å¯Ÿä»»åŠ¡è¿è¡Œæƒ…å†µå’Œç³»ç»Ÿè´Ÿè½½ã€èµ„æºåˆ©ç”¨ç‡æ¥è¿›è¡Œé€‚å½“è°ƒæ•´ã€‚ å‚è€ƒ JDK1.8 https://www.cnblogs.com/dolphin0520/p/3932921.html]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>ThreadPoolExecutor</tag>
        <tag>çº¿ç¨‹æ± </tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring æºç è§£æ @RequestBody @ResponseBody çš„æ¥é¾™å»è„‰]]></title>
    <url>%2Fpost%2Fb75109d6.html</url>
    <content type="text"><![CDATA[@RequestBody å’Œ @ResponseBody æ˜¯å®é™…å¼€å‘ä¸­å¾ˆå¸¸ç”¨çš„ä¸¤ä¸ªæ³¨è§£ï¼Œé€šå¸¸ç”¨æ¥è§£æå’Œå“åº”JSONï¼Œç”¨èµ·æ¥ååˆ†çš„æ–¹ä¾¿ï¼Œè¿™ä¸¤ä¸ªæ³¨è§£çš„èƒŒåæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ æºç ç‰ˆæœ¬SpringBoot 2.1.3.RELEASE RequestResponseBodyMethodProcessor Resolves method arguments annotated with @RequestBody and handles return values from methods annotated with @ResponseBody by reading and writing to the body of the request or response with an HttpMessageConverter.An @RequestBody method argument is also validated if it is annotated with @javax.validation.Valid. In case of validation failure, MethodArgumentNotValidException is raised and results in an HTTP 400 response status code if DefaultHandlerExceptionResolver is configured. ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªç±»ç”¨æ¥è§£æ@RequestBodyçš„å‚æ•°å’Œå¤„ç† @ResponseBodyè¿”å›å€¼ï¼Œé€šè¿‡ HttpMessageConverter è¿™ä¸ªæ¥å£æ¥å®ç°ã€‚ å¦‚æœ@RequestBodyæ ‡è®°çš„å‚æ•°åŒ…å«@Validï¼Œè¿˜ä¼šå¯¹è¿™ä¸ªå‚æ•°è¿›è¡Œæ ¡éªŒã€‚ ç»§æ‰¿å…³ç³» HandlerMethodArgumentResolver å’Œ HandlerMethodReturnValueHandler åˆ†åˆ«æ˜¯Springçš„å‚æ•°å¤„ç†å™¨å’Œè¿”å›å€¼å¤„ç†å™¨ HandlerMethodArgumentResolver 12345678public interface HandlerMethodArgumentResolver &#123; boolean supportsParameter(MethodParameter parameter); Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer, NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception;&#125; Springçš„å‚æ•°è§£æå™¨æ¥å£ï¼ŒsupportsParameter() æ–¹æ³•ç”¨äºåˆ¤æ–­è§£æå™¨æ˜¯å¦æ”¯æŒå½“å‰Controlleræ–¹æ³•çš„å‚æ•°ï¼ŒresolveArgument() åˆ™æ˜¯å°†Requestè§£æä¸ºControlleræ–¹æ³•å¯¹åº”çš„å‚æ•°Bean HandlerMethodReturnValueHandler 12345678public interface HandlerMethodReturnValueHandler &#123; boolean supportsReturnType(MethodParameter returnType); void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception;&#125; åŒç†è¿™ä¸ªæ¥å£å°†Controlleræ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œå°è£…ä¸ºResponse æˆ‘ä»¬åœ¨å®é™…å¼€å‘æ—¶ï¼Œä¹Ÿå¯ä»¥å®ç°è¿™ä¸¤ä¸ªæ¥å£è‡ªå®šä¹‰è‡ªå·±çš„å‚æ•°è§£æå’Œå“åº”å¤„ç†ï¼ŒRequestResponseBodyMethodProcessor å®ç°äº†è¿™ä¸¤ä¸ªæ¥å£ï¼Œæ—¢åšäº†å‚æ•°è§£æå™¨ä¹Ÿåšäº†å“åº”å¤„ç†å™¨ã€‚ RequestResponseBodyMethodProcessor æºç åˆ†ææˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ RequestResponseBodyMethodProcessor æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»¥è§£æå‚æ•°ä¸ºä¾‹ resolveArgument 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647@Overridepublic boolean supportsParameter(MethodParameter parameter) &#123; // æ”¯æŒæ ‡è®°@RequestBodyçš„å‚æ•° return parameter.hasParameterAnnotation(RequestBody.class);&#125;@Overridepublic Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer, NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception &#123; parameter = parameter.nestedIfOptional(); // é€šè¿‡HttpMessageConverters å°†è¯·æ±‚ä½“, å°è£…ä¸º@RequestBodyæ‰€æ ‡è®°çš„XXBean Object arg = readWithMessageConverters(webRequest, parameter, parameter.getNestedGenericParameterType()); String name = Conventions.getVariableNameForParameter(parameter); if (binderFactory != null) &#123; WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name); if (arg != null) &#123; // å¦‚æœå­˜åœ¨@Valid å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒ validateIfApplicable(binder, parameter); if (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123; throw new MethodArgumentNotValidException(parameter, binder.getBindingResult()); &#125; &#125; if (mavContainer != null) &#123; mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult()); &#125; &#125; return adaptArgumentIfNecessary(arg, parameter);&#125;@Overrideprotected &lt;T&gt; Object readWithMessageConverters(NativeWebRequest webRequest, MethodParameter parameter, Type paramType) throws IOException, HttpMediaTypeNotSupportedException, HttpMessageNotReadableException &#123; HttpServletRequest servletRequest = webRequest.getNativeRequest(HttpServletRequest.class); Assert.state(servletRequest != null, "No HttpServletRequest"); ServletServerHttpRequest inputMessage = new ServletServerHttpRequest(servletRequest); Object arg = readWithMessageConverters(inputMessage, parameter, paramType); if (arg == null &amp;&amp; checkRequired(parameter)) &#123; throw new HttpMessageNotReadableException("Required request body is missing: " + parameter.getExecutable().toGenericString(), inputMessage); &#125; return arg;&#125; ä½œä¸ºå‚æ•°è§£æå™¨ï¼ŒRequestResponseBodyMethodProcessor æ”¯æŒæ‰€æœ‰æ ‡è®°@RequestBodyçš„å‚æ•°ã€‚åœ¨resolveArgument()æ–¹æ³•ä¸­ï¼Œé€šè¿‡è°ƒç”¨readWithMessageConverters() å°† Request è½¬ä¸ºå¯¹åº” argã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ readWithMessageConverters() åˆ°åº•åšäº†ä»€ä¹ˆ readWithMessageConverters 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980protected &lt;T&gt; Object readWithMessageConverters(HttpInputMessage inputMessage, MethodParameter parameter, Type targetType) throws IOException, HttpMediaTypeNotSupportedException, HttpMessageNotReadableException &#123; // å½“å‰è¯·æ±‚çš„contentType MediaType contentType; boolean noContentType = false; try &#123; contentType = inputMessage.getHeaders().getContentType(); &#125; catch (InvalidMediaTypeException ex) &#123; throw new HttpMediaTypeNotSupportedException(ex.getMessage()); &#125; if (contentType == null) &#123; noContentType = true; contentType = MediaType.APPLICATION_OCTET_STREAM; &#125; // Controllerå‚æ•°çš„Class Class&lt;?&gt; contextClass = parameter.getContainingClass(); Class&lt;T&gt; targetClass = (targetType instanceof Class ? (Class&lt;T&gt;) targetType : null); if (targetClass == null) &#123; ResolvableType resolvableType = ResolvableType.forMethodParameter(parameter); targetClass = (Class&lt;T&gt;) resolvableType.resolve(); &#125; // å½“å‰è¯·æ±‚æ–¹å¼ HttpMethod httpMethod = (inputMessage instanceof HttpRequest ? ((HttpRequest) inputMessage).getMethod() : null); Object body = NO_VALUE; EmptyBodyCheckingHttpInputMessage message; try &#123; message = new EmptyBodyCheckingHttpInputMessage(inputMessage); // éå†æ‰€æœ‰çš„HttpMessageConverterï¼Œ for (HttpMessageConverter&lt;?&gt; converter : this.messageConverters) &#123; Class&lt;HttpMessageConverter&lt;?&gt;&gt; converterType = (Class&lt;HttpMessageConverter&lt;?&gt;&gt;) converter.getClass(); GenericHttpMessageConverter&lt;?&gt; genericConverter = (converter instanceof GenericHttpMessageConverter ? (GenericHttpMessageConverter&lt;?&gt;) converter : null); // å¦‚æœå½“å‰çš„HttpMessageConverterå¯ä»¥è§£æå¯¹åº”çš„ classå’ŒcontentType if (genericConverter != null ? genericConverter.canRead(targetType, contextClass, contentType) : (targetClass != null &amp;&amp; converter.canRead(targetClass, contentType))) &#123; if (message.hasBody()) &#123; HttpInputMessage msgToUse = getAdvice().beforeBodyRead(message, parameter, targetType, converterType); // å°†HttpæŠ¥æ–‡è½¬æ¢ä¸ºå¯¹åº”çš„class body = (genericConverter != null ? genericConverter.read(targetType, contextClass, msgToUse) : ((HttpMessageConverter&lt;T&gt;) converter).read(targetClass, msgToUse)); body = getAdvice().afterBodyRead(body, msgToUse, parameter, targetType, converterType); &#125; else &#123; body = getAdvice().handleEmptyBody(null, message, parameter, targetType, converterType); &#125; break; &#125; &#125; &#125; catch (IOException ex) &#123; throw new HttpMessageNotReadableException("I/O error while reading input message", ex, inputMessage); &#125; if (body == NO_VALUE) &#123; if (httpMethod == null || !SUPPORTED_METHODS.contains(httpMethod) || (noContentType &amp;&amp; !message.hasBody())) &#123; return null; &#125; throw new HttpMediaTypeNotSupportedException(contentType, this.allSupportedMediaTypes); &#125; MediaType selectedContentType = contentType; Object theBody = body; LogFormatUtils.traceDebug(logger, traceOn -&gt; &#123; String formatted = LogFormatUtils.formatValue(theBody, !traceOn); return "Read \"" + selectedContentType + "\" to [" + formatted + "]"; &#125;); return body;&#125; ä¸Šè¿°ä»£ç æ ¸å¿ƒé€»è¾‘å°±æ˜¯éå†å½“å‰è§£æä¸­é…ç½®çš„æ‰€æœ‰ HttpMessageConverterï¼Œå¦‚æœæŸä¸ªConverterå¯ä»¥è§£æå½“å‰çš„ contentTypeï¼Œå°±æŠŠè½¬æ¢å·¥ä½œäº¤ç»™ä»–å»è¿›è¡Œã€‚ ä¹‹å‰åšè¿‡å°†é»˜è®¤è§£ææ›¿æ¢ä¸ºfastjsonï¼Œå½“æ—¶å°±æ˜¯æ·»åŠ ä¸€ä¸ªFastJsonå®ç°çš„HttpMessageConverterï¼Œä½†æ˜¯é‚£æ—¶å€™å¹¶ä¸ç†è§£è¿™ä¹ˆåšæ˜¯ä¸ºäº†ä»€ä¹ˆï¼Œç°åœ¨æ‰æç„¶å¤§æ‚Ÿâ€¦ handleReturnValue RequestResponseBodyMethodProcessor çš„Responseå¤„ç†é€»è¾‘å’Œè§£æé€»è¾‘ç±»ä¼¼ï¼Œæ‰¾åˆ°ä¸€ä¸ªæ”¯æŒçš„HttpMessageConverterï¼ŒæŠŠå“åº”å·¥ä½œäº¤ç»™ä»–ï¼Œæ„Ÿå…´è¶£çš„ç«¥é‹å¯ä»¥è‡ªå·±æ‰¾ä¸‹æºç ã€‚ RequestResponseBodyMethodProcessor æ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„ä¸Šé¢è®²äº† RequestResponseBodyMethodProcessor åšäº†å‚æ•°è§£æå’Œå“åº”å¤„ç†çš„å·¥ä½œï¼Œé‚£ä¹ˆä»–åœ¨Springæ¡†æ¶ä¸­æ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ å¦‚å›¾ï¼ŒRequestMappingHandlerAdapter çš„resolversï¼ˆRequestè§£æå™¨ï¼‰ã€handlersï¼ˆResponseå¤„ç†å™¨ï¼‰è¿˜æœ‰ ExceptionHandlerExceptionResolver çš„handlers è°ƒç”¨äº† RequestResponseBodyMethodProcessor RequestMappingHandlerAdapteræˆ‘ä»¬åªåˆ†æä¸€ä¸‹ RequestMappingHandlerAdapter ï¼Œè¯¥ç±»å¯¹æ‰€æœ‰æ ‡è®° @RequestMappingçš„æ³¨è§£è¿›è¡Œè§£æå’Œå“åº” åœ¨WebMvcConfigurationSupportä¸­ï¼Œé…ç½®äº†è¯¥Beanï¼Œå°†å…¶åŠ å…¥åˆ°Springå®¹å™¨ä¸­ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„å‚æ•°è§£æã€å“åº”è§£æã€å’ŒHttpMessageConvert é€šè¿‡ä¸Šå›¾çš„æ–¹æ³•setåˆ° RequestMappingHandlerAdapter ä¸­ã€‚ 123456789101112131415161718192021222324252627282930@Beanpublic RequestMappingHandlerAdapter requestMappingHandlerAdapter() &#123; RequestMappingHandlerAdapter adapter = createRequestMappingHandlerAdapter(); adapter.setContentNegotiationManager(mvcContentNegotiationManager()); // è·å–æ‰€æœ‰HttpMessageConverterï¼ŒåŒ…æ‹¬æˆ‘ä»¬è‡ªå®šä¹‰çš„é…ç½® adapter.setMessageConverters(getMessageConverters()); adapter.setWebBindingInitializer(getConfigurableWebBindingInitializer()); // è‡ªå®šä¹‰çš„å‚æ•°è§£æå™¨ adapter.setCustomArgumentResolvers(getArgumentResolvers()); // è‡ªå®šä¹‰çš„å“åº”å¤„ç†å™¨ adapter.setCustomReturnValueHandlers(getReturnValueHandlers()); if (jackson2Present) &#123; adapter.setRequestBodyAdvice(Collections.singletonList(new JsonViewRequestBodyAdvice())); adapter.setResponseBodyAdvice(Collections.singletonList(new JsonViewResponseBodyAdvice())); &#125; AsyncSupportConfigurer configurer = new AsyncSupportConfigurer(); configureAsyncSupport(configurer); if (configurer.getTaskExecutor() != null) &#123; adapter.setTaskExecutor(configurer.getTaskExecutor()); &#125; if (configurer.getTimeout() != null) &#123; adapter.setAsyncRequestTimeout(configurer.getTimeout()); &#125; adapter.setCallableInterceptors(configurer.getCallableInterceptors()); adapter.setDeferredResultInterceptors(configurer.getDeferredResultInterceptors()); return adapter;&#125; ç»§ç»­è¯´ RequestMappingHandlerAdapter ï¼ŒgetDefaultArgumentResolvers() å°è£…äº†SpringBootä¸­çš„é»˜è®¤å‚æ•°è§£æå™¨ï¼Œå…¶ä¸­å°±æœ‰æˆ‘ä»¬çš„æœ¬èŠ‚æ‰€è®²çš„ RequestResponseBodyMethodProcessor ï¼Œåœ¨afterPropertiesSet() æ–¹æ³•ä¸­è°ƒç”¨äº†è¯¥æ–¹æ³• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667@Overridepublic void afterPropertiesSet() &#123; // Do this first, it may add ResponseBody advice beans initControllerAdviceCache(); if (this.argumentResolvers == null) &#123; List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers(); this.argumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers); &#125; if (this.initBinderArgumentResolvers == null) &#123; List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultInitBinderArgumentResolvers(); this.initBinderArgumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers); &#125; if (this.returnValueHandlers == null) &#123; List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers(); this.returnValueHandlers = new HandlerMethodReturnValueHandlerComposite().addHandlers(handlers); &#125;&#125;private List&lt;HandlerMethodArgumentResolver&gt; getDefaultArgumentResolvers() &#123; List&lt;HandlerMethodArgumentResolver&gt; resolvers = new ArrayList&lt;&gt;(); // Annotation-based argument resolution resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), false)); resolvers.add(new RequestParamMapMethodArgumentResolver()); resolvers.add(new PathVariableMethodArgumentResolver()); resolvers.add(new PathVariableMapMethodArgumentResolver()); resolvers.add(new MatrixVariableMethodArgumentResolver()); resolvers.add(new MatrixVariableMapMethodArgumentResolver()); resolvers.add(new ServletModelAttributeMethodProcessor(false)); // æ·»åŠ RequestResponseBodyMethodProcessor resolvers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice)); // çœç•¥ï¼Œè¯¦è§æºç ... return resolvers;&#125;private List&lt;HandlerMethodReturnValueHandler&gt; getDefaultReturnValueHandlers() &#123; List&lt;HandlerMethodReturnValueHandler&gt; handlers = new ArrayList&lt;&gt;(); // Single-purpose return value types handlers.add(new ModelAndViewMethodReturnValueHandler()); handlers.add(new ModelMethodProcessor()); handlers.add(new ViewMethodReturnValueHandler()); handlers.add(new ResponseBodyEmitterReturnValueHandler(getMessageConverters(), this.reactiveAdapterRegistry, this.taskExecutor, this.contentNegotiationManager)); handlers.add(new StreamingResponseBodyReturnValueHandler()); handlers.add(new HttpEntityMethodProcessor(getMessageConverters(), this.contentNegotiationManager, this.requestResponseBodyAdvice)); handlers.add(new HttpHeadersReturnValueHandler()); handlers.add(new CallableMethodReturnValueHandler()); handlers.add(new DeferredResultMethodReturnValueHandler()); handlers.add(new AsyncTaskMethodReturnValueHandler(this.beanFactory)); // Annotation-based return value types handlers.add(new ModelAttributeMethodProcessor(false)); // æ·»åŠ RequestResponseBodyMethodProcessor handlers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(), this.contentNegotiationManager, this.requestResponseBodyAdvice)); // çœç•¥ï¼Œè¯¦è§æºç ... return handlers;&#125; RequestResponseBodyMethodProcessor ä½•æ—¶è¢«è°ƒç”¨ä¸Šé¢é“ºå«äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºæ¥äº† RequestMappingHandlerAdapter çš„ invokeHandlerMethod ä¸­ æ„å»ºäº† invocableMethod å¯¹è±¡å¹¶å°†æ‰€æœ‰çš„è§£æå™¨å’Œå¤„ç†å™¨å°è£…åˆ°è¯¥å¯¹è±¡ï¼Œé€šè¿‡invocableMethod.invokeAndHandle() è¿›è¡Œå¯¹è¯·æ±‚çš„è§£æï¼Œå¯¹controllerçš„è°ƒç”¨ï¼Œä»¥åŠå“åº”çš„å¤„ç† invocableMethod.invokeAndHandle() ä¸­æ˜¯æ€ä¹ˆæ ·å®ç°çš„123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687public void invokeAndHandle(ServletWebRequest webRequest, ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123; // å‚æ•°è§£æï¼Œå¹¶åå°„è°ƒç”¨controlleræ–¹æ³•ï¼Œè·å–æ–¹æ³•è¿”å›å€¼ Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs); // ä¸‹é¢å°±æ˜¯å¯¹Responseçš„å¤„ç† setResponseStatus(webRequest); if (returnValue == null) &#123; if (isRequestNotModified(webRequest) || getResponseStatus() != null || mavContainer.isRequestHandled()) &#123; mavContainer.setRequestHandled(true); return; &#125; &#125; else if (StringUtils.hasText(getResponseStatusReason())) &#123; mavContainer.setRequestHandled(true); return; &#125; mavContainer.setRequestHandled(false); Assert.state(this.returnValueHandlers != null, "No return value handlers"); try &#123; this.returnValueHandlers.handleReturnValue( returnValue, getReturnValueType(returnValue), mavContainer, webRequest); &#125; catch (Exception ex) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(formatErrorForReturnValue(returnValue), ex); &#125; throw ex; &#125;&#125;public Object invokeForRequest(NativeWebRequest request, @Nullable ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123; // è°ƒç”¨å‚æ•°è§£æå™¨è·å–è°ƒç”¨controller æ‰€éœ€çš„å‚æ•° Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs); if (logger.isTraceEnabled()) &#123; logger.trace("Arguments: " + Arrays.toString(args)); &#125; // åå°„è°ƒç”¨ controller return doInvoke(args);&#125;protected Object[] getMethodArgumentValues(NativeWebRequest request, @Nullable ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123; if (ObjectUtils.isEmpty(getMethodParameters())) &#123; return EMPTY_ARGS; &#125; MethodParameter[] parameters = getMethodParameters(); Object[] args = new Object[parameters.length]; // éå†è§£æå‚æ•° for (int i = 0; i &lt; parameters.length; i++) &#123; MethodParameter parameter = parameters[i]; parameter.initParameterNameDiscovery(this.parameterNameDiscoverer); args[i] = findProvidedArgument(parameter, providedArgs); if (args[i] != null) &#123; continue; &#125; // è¿™é‡Œçš„ resolvers æ˜¯ä¸€ä¸ªå°è£…äº†æ‰€æœ‰å‚æ•°è§£æå™¨çš„åŒ…è£…ç±»ï¼Œéå†æ‰€æœ‰è§£æå™¨ï¼Œå¦‚æœä¸èƒ½æ‰¾åˆ°æ”¯æŒå½“å‰å‚æ•°çš„ï¼ŒæŠ›å‡ºå¼‚å¸¸ // å¦‚æœæ‰¾åˆ°å½“å‰å‚æ•°å¯¹åº”çš„è§£æå™¨ï¼Œåˆ™ç¼“å­˜èµ·æ¥ï¼Œåœ¨ä¸‹é¢çš„ resolvers.resolveArgument æ—¶ï¼Œç›´æ¥ä½¿ç”¨ if (!this.resolvers.supportsParameter(parameter)) &#123; throw new IllegalStateException(formatArgumentError(parameter, "No suitable resolver")); &#125; try &#123; // è°ƒç”¨å‚æ•°è§£æå™¨ args[i] = this.resolvers.resolveArgument(parameter, mavContainer, request, this.dataBinderFactory); &#125; catch (Exception ex) &#123; // Leave stack trace for later, exception may actually be resolved and handled.. if (logger.isDebugEnabled()) &#123; String error = ex.getMessage(); if (error != null &amp;&amp; !error.contains(parameter.getExecutable().toGenericString())) &#123; logger.debug(formatArgumentError(parameter, error)); &#125; &#125; throw ex; &#125; &#125; return args;&#125; invokeAndHandle() é‡Œåšäº†ä¸‰ä»¶äº‹ å°†è¯·æ±‚ä¸­è§£æä¸ºControllerä¸­æŒ‡å®šçš„å‚æ•° ç”¨è§£æå¥½çš„å‚æ•°åå°„è°ƒç”¨ Controller æ–¹æ³• å¤„ç†å“åº” ä¸€æ¬¡Httpè¯·æ±‚ç»å†äº†ä»€ä¹ˆå›è¿‡å¤´æ¥å†çœ‹ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å‘ä¸€ä¸ªè¯·æ±‚ï¼Œåœ¨ RequestMappingHandlerAdapter çš„ invokeHandlerMethod()ä¸­ debugä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹çº¿ç¨‹æ ˆæ˜¯ä»€ä¹ˆæ ·çš„ ç®€å•ç”»ä¸€å¼ å›¾æ¥è¡¨ç¤ºä¸€ä¸‹ END æ¬¢è¿å„ä½ç»™å‡ºæ„è§å’ŒæŒ‡æ­£]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>æºç </tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaå¹¶å‘ç¼–ç¨‹-volatile]]></title>
    <url>%2Fpost%2Feb0b8344.html</url>
    <content type="text"><![CDATA[åŸæ–‡ï¼šJavaå¹¶å‘ç¼–ç¨‹ï¼švolatileå…³é”®å­—è§£æ åŸæ–‡è®²è§£äº†å¾ˆå¤šä¸œè¥¿ä½œä¸ºé“ºå«ï¼Œåœ¨åŸæ–‡å†…å®¹æœ‰äº›åˆ å‡å’Œæ›´æ”¹ã€‚å¦‚è¯»è€…è§‰å¾—ä¸å¦¥ï¼Œæˆ–è€…ç†è§£ä¸åˆ°ä½ï¼Œå»ºè®®é˜…è¯»åŸæ–‡ã€‚ å†…å­˜æ¨¡å‹ç›¸å…³æ¦‚å¿µå¤§å®¶éƒ½çŸ¥é“ï¼Œè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½æ˜¯åœ¨CPUä¸­æ‰§è¡Œçš„ï¼Œè€Œæ‰§è¡ŒæŒ‡ä»¤è¿‡ç¨‹ä¸­ï¼ŒåŠ¿å¿…æ¶‰åŠåˆ°æ•°æ®çš„è¯»å–å’Œå†™å…¥ã€‚ç”±äºç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ•°æ®æ˜¯å­˜æ”¾åœ¨ä¸»å­˜ï¼ˆç‰©ç†å†…å­˜ï¼‰å½“ä¸­çš„ï¼Œè¿™æ—¶å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºCPUæ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ï¼Œè€Œä»å†…å­˜è¯»å–æ•°æ®å’Œå‘å†…å­˜å†™å…¥æ•°æ®çš„è¿‡ç¨‹è·ŸCPUæ‰§è¡ŒæŒ‡ä»¤çš„é€Ÿåº¦æ¯”èµ·æ¥è¦æ…¢çš„å¤šï¼Œå› æ­¤å¦‚æœä»»ä½•æ—¶å€™å¯¹æ•°æ®çš„æ“ä½œéƒ½è¦é€šè¿‡å’Œå†…å­˜çš„äº¤äº’æ¥è¿›è¡Œï¼Œä¼šå¤§å¤§é™ä½æŒ‡ä»¤æ‰§è¡Œçš„é€Ÿåº¦ã€‚å› æ­¤åœ¨CPUé‡Œé¢å°±æœ‰äº†é«˜é€Ÿç¼“å­˜ã€‚ ä¹Ÿå°±æ˜¯ï¼Œå½“ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå°†è¿ç®—éœ€è¦çš„æ•°æ®ä»ä¸»å­˜å¤åˆ¶ä¸€ä»½åˆ°CPUçš„é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œé‚£ä¹ˆCPUè¿›è¡Œè®¡ç®—æ—¶å°±å¯ä»¥ç›´æ¥ä»å®ƒçš„é«˜é€Ÿç¼“å­˜è¯»å–æ•°æ®å’Œå‘å…¶ä¸­å†™å…¥æ•°æ®ï¼Œå½“è¿ç®—ç»“æŸä¹‹åï¼Œå†å°†é«˜é€Ÿç¼“å­˜ä¸­çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚ä¸‹é¢çš„è¿™æ®µä»£ç ï¼š 1i = i + 1; å½“çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªè¯­å¥æ—¶ï¼Œä¼šå…ˆä»ä¸»å­˜å½“ä¸­è¯»å–içš„å€¼ï¼Œç„¶åå¤åˆ¶ä¸€ä»½åˆ°é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œç„¶åCPUæ‰§è¡ŒæŒ‡ä»¤å¯¹iè¿›è¡ŒåŠ 1æ“ä½œï¼Œç„¶åå°†æ•°æ®å†™å…¥é«˜é€Ÿç¼“å­˜ï¼Œæœ€åå°†é«˜é€Ÿç¼“å­˜ä¸­iæœ€æ–°çš„å€¼åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚ è¿™ä¸ªä»£ç åœ¨å•çº¿ç¨‹ä¸­è¿è¡Œæ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸­è¿è¡Œå°±ä¼šæœ‰é—®é¢˜äº†ã€‚åœ¨å¤šæ ¸CPUä¸­ï¼Œæ¯æ¡çº¿ç¨‹å¯èƒ½è¿è¡Œäºä¸åŒçš„CPUä¸­ï¼Œå› æ­¤æ¯ä¸ªçº¿ç¨‹è¿è¡Œæ—¶æœ‰è‡ªå·±çš„é«˜é€Ÿç¼“å­˜ï¼ˆå¯¹å•æ ¸CPUæ¥è¯´ï¼Œå…¶å®ä¹Ÿä¼šå‡ºç°è¿™ç§é—®é¢˜ï¼Œåªä¸è¿‡æ˜¯ä»¥çº¿ç¨‹è°ƒåº¦çš„å½¢å¼æ¥åˆ†åˆ«æ‰§è¡Œçš„ï¼‰ã€‚æœ¬æ–‡æˆ‘ä»¬ä»¥å¤šæ ¸CPUä¸ºä¾‹ã€‚ æ¯”å¦‚åŒæ—¶æœ‰2ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™æ®µä»£ç ï¼Œå‡å¦‚åˆå§‹æ—¶içš„å€¼ä¸º0ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä¹‹åiçš„å€¼å˜ä¸º2ã€‚ä½†æ˜¯äº‹å®ä¼šæ˜¯è¿™æ ·å—ï¼Ÿ å¯èƒ½å­˜åœ¨ä¸‹é¢ä¸€ç§æƒ…å†µï¼šåˆå§‹æ—¶ï¼Œä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è¯»å–içš„å€¼å­˜å…¥å„è‡ªæ‰€åœ¨çš„CPUçš„é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œç„¶åçº¿ç¨‹1è¿›è¡ŒåŠ 1æ“ä½œï¼Œç„¶åæŠŠiçš„æœ€æ–°å€¼1å†™å…¥åˆ°å†…å­˜ã€‚æ­¤æ—¶çº¿ç¨‹2çš„é«˜é€Ÿç¼“å­˜å½“ä¸­içš„å€¼è¿˜æ˜¯0ï¼Œè¿›è¡ŒåŠ 1æ“ä½œä¹‹åï¼Œiçš„å€¼ä¸º1ï¼Œç„¶åçº¿ç¨‹2æŠŠiçš„å€¼å†™å…¥å†…å­˜ã€‚ æœ€ç»ˆç»“æœiçš„å€¼æ˜¯1ï¼Œè€Œä¸æ˜¯2ã€‚è¿™å°±æ˜¯è‘—åçš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚é€šå¸¸ç§°è¿™ç§è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®çš„å˜é‡ä¸ºå…±äº«å˜é‡ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªå˜é‡åœ¨å¤šä¸ªCPUä¸­éƒ½å­˜åœ¨ç¼“å­˜ï¼ˆä¸€èˆ¬åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶æ‰ä¼šå‡ºç°ï¼‰ï¼Œé‚£ä¹ˆå°±å¯èƒ½å­˜åœ¨ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ ä¸ºäº†è§£å†³ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜ï¼Œé€šå¸¸æ¥è¯´æœ‰ä»¥ä¸‹2ç§è§£å†³æ–¹æ³•ï¼š 1ï¼‰é€šè¿‡åœ¨æ€»çº¿åŠ LOCK#é”çš„æ–¹å¼ 2ï¼‰é€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®® è¿™2ç§æ–¹å¼éƒ½æ˜¯ç¡¬ä»¶å±‚é¢ä¸Šæä¾›çš„æ–¹å¼ã€‚ åœ¨æ—©æœŸçš„CPUå½“ä¸­ï¼Œæ˜¯é€šè¿‡åœ¨æ€»çº¿ä¸ŠåŠ LOCK#é”çš„å½¢å¼æ¥è§£å†³ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚å› ä¸ºCPUå’Œå…¶ä»–éƒ¨ä»¶è¿›è¡Œé€šä¿¡éƒ½æ˜¯é€šè¿‡æ€»çº¿æ¥è¿›è¡Œçš„ï¼Œå¦‚æœå¯¹æ€»çº¿åŠ LOCK#é”çš„è¯ï¼Œä¹Ÿå°±æ˜¯è¯´é˜»å¡äº†å…¶ä»–CPUå¯¹å…¶ä»–éƒ¨ä»¶è®¿é—®ï¼ˆå¦‚å†…å­˜ï¼‰ï¼Œä»è€Œä½¿å¾—åªèƒ½æœ‰ä¸€ä¸ªCPUèƒ½ä½¿ç”¨è¿™ä¸ªå˜é‡çš„å†…å­˜ã€‚æ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­ å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œ i = i +1ï¼Œå¦‚æœåœ¨æ‰§è¡Œè¿™æ®µä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨æ€»çº¿ä¸Šå‘å‡ºäº†LCOK#é”çš„ä¿¡å·ï¼Œé‚£ä¹ˆåªæœ‰ç­‰å¾…è¿™æ®µä»£ç å®Œå…¨æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå…¶ä»–CPUæ‰èƒ½ä»å˜é‡iæ‰€åœ¨çš„å†…å­˜è¯»å–å˜é‡ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„æ“ä½œã€‚è¿™æ ·å°±è§£å†³äº†ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ ä½†æ˜¯ä¸Šé¢çš„æ–¹å¼ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºåœ¨é”ä½æ€»çº¿æœŸé—´ï¼Œå…¶ä»–CPUæ— æ³•è®¿é—®å†…å­˜ï¼Œå¯¼è‡´æ•ˆç‡ä½ä¸‹ã€‚ æ‰€ä»¥å°±å‡ºç°äº†ç¼“å­˜ä¸€è‡´æ€§åè®®ã€‚æœ€å‡ºåçš„å°±æ˜¯Intel çš„MESIåè®®ï¼ŒMESIåè®®ä¿è¯äº†æ¯ä¸ªç¼“å­˜ä¸­ä½¿ç”¨çš„å…±äº«å˜é‡çš„å‰¯æœ¬æ˜¯ä¸€è‡´çš„ã€‚å®ƒæ ¸å¿ƒçš„æ€æƒ³æ˜¯ï¼šå½“CPUå†™æ•°æ®æ—¶ï¼Œå¦‚æœå‘ç°æ“ä½œçš„å˜é‡æ˜¯å…±äº«å˜é‡ï¼Œå³åœ¨å…¶ä»–CPUä¸­ä¹Ÿå­˜åœ¨è¯¥å˜é‡çš„å‰¯æœ¬ï¼Œä¼šå‘å‡ºä¿¡å·é€šçŸ¥å…¶ä»–CPUå°†è¯¥å˜é‡çš„ç¼“å­˜è¡Œç½®ä¸ºæ— æ•ˆçŠ¶æ€ï¼Œå› æ­¤å½“å…¶ä»–CPUéœ€è¦è¯»å–è¿™ä¸ªå˜é‡æ—¶ï¼Œå‘ç°è‡ªå·±ç¼“å­˜ä¸­ç¼“å­˜è¯¥å˜é‡çš„ç¼“å­˜è¡Œæ˜¯æ— æ•ˆçš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šä»å†…å­˜é‡æ–°è¯»å–ã€‚ ä»€ä¹ˆæ˜¯Java å†…å­˜æ¨¡å‹åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­è¯•å›¾å®šä¹‰ä¸€ç§Javaå†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰æ¥å±è”½å„ä¸ªç¡¬ä»¶å¹³å°å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®©Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœã€‚é‚£ä¹ˆJavaå†…å­˜æ¨¡å‹è§„å®šäº†å“ªäº›ä¸œè¥¿å‘¢ï¼Œå®ƒå®šä¹‰äº†ç¨‹åºä¸­å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œå¾€å¤§ä¸€ç‚¹è¯´æ˜¯å®šä¹‰äº†ç¨‹åºæ‰§è¡Œçš„æ¬¡åºã€‚æ³¨æ„ï¼Œä¸ºäº†è·å¾—è¾ƒå¥½çš„æ‰§è¡Œæ€§èƒ½ï¼ŒJavaå†…å­˜æ¨¡å‹å¹¶æ²¡æœ‰é™åˆ¶æ‰§è¡Œå¼•æ“ä½¿ç”¨å¤„ç†å™¨çš„å¯„å­˜å™¨æˆ–è€…é«˜é€Ÿç¼“å­˜æ¥æå‡æŒ‡ä»¤æ‰§è¡Œé€Ÿåº¦ï¼Œä¹Ÿæ²¡æœ‰é™åˆ¶ç¼–è¯‘å™¨å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨javaå†…å­˜æ¨¡å‹ä¸­ï¼Œä¹Ÿä¼šå­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜å’ŒæŒ‡ä»¤é‡æ’åºçš„é—®é¢˜ã€‚ Javaå†…å­˜æ¨¡å‹è§„å®šæ‰€æœ‰çš„å˜é‡éƒ½æ˜¯å­˜åœ¨ä¸»å­˜å½“ä¸­ï¼ˆç±»ä¼¼äºå‰é¢è¯´çš„ç‰©ç†å†…å­˜ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼ˆç±»ä¼¼äºå‰é¢çš„é«˜é€Ÿç¼“å­˜ï¼‰ã€‚çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥å¯¹ä¸»å­˜è¿›è¡Œæ“ä½œã€‚å¹¶ä¸”æ¯ä¸ªçº¿ç¨‹ä¸èƒ½è®¿é—®å…¶ä»–çº¿ç¨‹çš„å·¥ä½œå†…å­˜ã€‚ å¤šçº¿ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„é—®é¢˜å†…å­˜ä¸å¯è§12345678//çº¿ç¨‹1boolean stop = false;while(!stop)&#123; doSomething();&#125; //çº¿ç¨‹2stop = true; çº¿ç¨‹2é€šè¿‡stop = true å°è¯•åœæ­¢çº¿ç¨‹1ï¼Œçº¿ç¨‹1ä¸€å®šä¼šä¸­æ–­å—ï¼Ÿä¸ä¸€å®š å› ä¸ºä¸Šæ–‡è¯´è¿‡äº†ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹1è¿è¡Œæ—¶ï¼Œåœ¨å°†stopå˜é‡æ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­ã€‚çº¿ç¨‹2è¿™æ—¶å€™ä¿®æ”¹äº†stopï¼Œç„¶åæ²¡æ¥å¾—åŠåŒæ­¥åˆ°ä¸»å­˜ï¼Œè¿™æ—¶å€™çº¿ç¨‹2å»åšåˆ«çš„å·¥ä½œäº†ï¼Œçº¿ç¨‹1ä¸çŸ¥é“çº¿ç¨‹2ä¿®æ”¹äº†å˜é‡ï¼Œä¸€ç›´å¾ªç¯ä¸‹å»ã€‚ é‡æ’åº ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼Ÿ ä¸€èˆ¬æ¥è¯´ï¼Œå¤„ç†å™¨ä¸ºäº†æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œå¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥çš„æ‰§è¡Œå…ˆåé¡ºåºåŒä»£ç ä¸­çš„é¡ºåºä¸€è‡´ï¼Œä½†æ˜¯å®ƒä¼šä¿è¯ç¨‹åºæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºæ‰§è¡Œçš„ç»“æœæ˜¯ä¸€è‡´çš„ã€‚ ä¾‹å¦‚ä¸‹é¢ä»£ç 1234int a = 10; //è¯­å¥1int r = 2; //è¯­å¥2a = a + 3; //è¯­å¥3r = a*a; //è¯­å¥4 å¯èƒ½çš„é¡ºåº ä½†æ˜¯ç»ä¸å¯èƒ½å‡ºç° è¯­å¥2 -&gt; è¯­å¥1 -&gt; è¯­å¥4 -&gt; è¯­å¥3 ä¸Šè¿°é¡ºåºæ”¹å˜æ•°æ®ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¤„ç†å™¨ä¼šè€ƒè™‘è¯­å¥ä¹‹é—´çš„ä¾èµ–å…³ç³» é‡æ’åºé€ æˆçš„å½±å“ 123456789//çº¿ç¨‹1:context = loadContext(); //è¯­å¥1inited = true; //è¯­å¥2 //çº¿ç¨‹2:while(!inited )&#123; sleep()&#125;doSomethingwithconfig(context); çº¿ç¨‹1çš„ä»£ç æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¦‚æœé¡ºåºå˜ä¸ºäº† è¯­å¥2 -&gt; è¯­å¥1ï¼Œçº¿ç¨‹2å¯èƒ½å°±ä¼šæ‹¿åˆ°ä¸€ä¸ªæ²¡æœ‰åˆå§‹åŒ–çš„ contextå¯¹è±¡ä»è€Œå¯¼è‡´ç¨‹åºå¼‚å¸¸ï¼Œè€Œè¿™ç§å¼‚å¸¸æ˜¯å¾ˆéš¾æ’æŸ¥çš„ volatileä½œç”¨volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªå˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œ ä¸€æ—¦ä¸€ä¸ªå…±äº«å˜é‡ï¼ˆç±»çš„æˆå‘˜å˜é‡ã€ç±»çš„é™æ€æˆå‘˜å˜é‡ï¼‰è¢«volatileä¿®é¥°ä¹‹åï¼Œé‚£ä¹ˆå°±å…·å¤‡äº†ä¸¤å±‚è¯­ä¹‰ï¼š 1ï¼‰ä¿è¯äº†ä¸åŒçº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œè¿™æ–°å€¼å¯¹å…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯ç«‹å³å¯è§çš„ã€‚ 2ï¼‰ç¦æ­¢è¿›è¡ŒæŒ‡ä»¤é‡æ’åºã€‚ 1. å†…å­˜å¯è§æ€§å˜é‡ä½¿ç”¨äº†volatileä¹‹åï¼Œæ‰€æœ‰è¯»å–æ“ä½œå…¨éƒ¨å‘ç”Ÿåœ¨ä¸»å­˜ä¸­ï¼Œä¹Ÿå°±é¿å…äº†ä¸Šè¿°çš„å†…å­˜ä¸å¯è§çš„é—®é¢˜äº† 2. é˜²æ­¢é‡æ’åºvolatileå…³é”®å­—ç¦æ­¢æŒ‡ä»¤é‡æ’åºæœ‰ä¸¤å±‚æ„æ€ï¼š 1ï¼‰å½“ç¨‹åºæ‰§è¡Œåˆ°volatileå˜é‡çš„è¯»æ“ä½œæˆ–è€…å†™æ“ä½œæ—¶ï¼Œåœ¨å…¶å‰é¢çš„æ“ä½œçš„æ›´æ”¹è‚¯å®šå…¨éƒ¨å·²ç»è¿›è¡Œï¼Œä¸”ç»“æœå·²ç»å¯¹åé¢çš„æ“ä½œå¯è§ï¼›åœ¨å…¶åé¢çš„æ“ä½œè‚¯å®šè¿˜æ²¡æœ‰è¿›è¡Œï¼› 2ï¼‰åœ¨è¿›è¡ŒæŒ‡ä»¤ä¼˜åŒ–æ—¶ï¼Œä¸èƒ½å°†åœ¨å¯¹volatileå˜é‡è®¿é—®çš„è¯­å¥æ”¾åœ¨å…¶åé¢æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½æŠŠvolatileå˜é‡åé¢çš„è¯­å¥æ”¾åˆ°å…¶å‰é¢æ‰§è¡Œã€‚ volidate åº”ç”¨åœºæ™¯1.çŠ¶æ€æ ‡è®°123456789volatile boolean flag = false; while(!flag)&#123; doSomething();&#125; public void setFlag() &#123; flag = true;&#125; 12345678910volatile boolean inited = false;//çº¿ç¨‹1:context = loadContext(); inited = true; //çº¿ç¨‹2:while(!inited )&#123;sleep()&#125;doSomethingwithconfig(context); 2.åŒé‡æ£€æŸ¥é” ï¼ˆdouble checkï¼‰1234567891011121314151617class Singleton &#123; private volatile static Singleton instance = null; private Singleton() &#123; &#125; public static Singleton getInstance() &#123; if(instance==null) &#123; synchronized (Singleton.class) &#123; if(instance==null) instance = new Singleton(); &#125; &#125; return instance; &#125;&#125; å…³äºåŒé‡æ£€æŸ¥é”volatile çš„ä¸¤ä¸ªä½œç”¨ å¯è§æ€§ é˜²æ­¢new Singleton()æ—¶é‡æ’åº åˆ›å»ºå¯¹è±¡å¯ä»¥ç®€å•åˆ†è§£ä¸ºä¸‰æ­¥ 1.åˆ†é…å†…å­˜ç©ºé—´ 2.åˆå§‹åŒ–å¯¹è±¡ 3.å°†å¯¹è±¡æŒ‡å‘åˆšåˆ†é…çš„å†…å­˜ç©ºé—´ å¤„ç†å™¨åœ¨ä¼˜åŒ–æ€§èƒ½æ—¶ï¼Œå¯èƒ½ä¼šå°†ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥è¿›è¡Œé‡æ’åºï¼Œè¿™æ ·ä¼šå¯¼è‡´ç¬¬äºŒä¸ªçº¿ç¨‹è·å–åˆ°æœªåˆå§‹åŒ–å®Œæˆçš„å¯¹è±¡ï¼Œå¯¼è‡´ç¨‹åºå¼‚å¸¸ã€‚]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot å¹¶å‘ç™»å½•äººæ•°æ§åˆ¶]]></title>
    <url>%2Fpost%2F5f58dc01.html</url>
    <content type="text"><![CDATA[é€šå¸¸ç³»ç»Ÿéƒ½ä¼šé™åˆ¶åŒä¸€ä¸ªè´¦å·çš„ç™»å½•äººæ•°ï¼Œå¤šäººç™»å½•è¦ä¹ˆé™åˆ¶åè€…ç™»å½•ï¼Œè¦ä¹ˆè¸¢å‡ºå‰è€…ï¼ŒSpring Security æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œæœ¬æ–‡è®²è§£ä¸€ä¸‹åœ¨æ²¡æœ‰ä½¿ç”¨Securityçš„æ—¶å€™å¦‚ä½•æ‰‹åŠ¨å®ç°è¿™ä¸ªåŠŸèƒ½ æœ¬æ–‡å€Ÿé‰´äº† https://jinnianshilongnian.iteye.com/blog/2039760, å¦‚æœä½ æ˜¯ä½¿ç”¨ Shiro + Session çš„æ¨¡å¼ï¼Œæ¨èé˜…è¯»æ­¤æ–‡ demo æŠ€æœ¯é€‰å‹ SpringBoot JWT Filter Redis + Redisson JWTï¼ˆtokenï¼‰å­˜å‚¨åœ¨Redisä¸­ï¼Œç±»ä¼¼ JSessionId-Sessionçš„å…³ç³»ï¼Œç”¨æˆ·ç™»å½•åæ¯æ¬¡è¯·æ±‚åœ¨Headerä¸­æºå¸¦jwt å¦‚æœä½ æ˜¯ä½¿ç”¨sessionçš„è¯ï¼Œä¹Ÿå®Œå…¨å¯ä»¥å€Ÿé‰´æœ¬æ–‡çš„æ€è·¯ï¼Œåªæ˜¯ä»£ç ä¸Šéœ€è¦åŠ äº›æ”¹åŠ¨ ä¸¤ç§å®ç°æ€è·¯æ¯”è¾ƒæ—¶é—´æˆ³ç»´æŠ¤ä¸€ä¸ª username: jwtToken è¿™æ ·çš„ä¸€ä¸ª key-value åœ¨Reidsä¸­, Filteré€»è¾‘å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142public class CompareKickOutFilter extends KickOutFilter &#123; @Autowired private UserService userService; @Override public boolean isAccessAllowed(HttpServletRequest request, HttpServletResponse response) &#123; String token = request.getHeader("Authorization"); String username = JWTUtil.getUsername(token); String userKey = PREFIX + username; RBucket&lt;String&gt; bucket = redissonClient.getBucket(userKey); String redisToken = bucket.get(); if (token.equals(redisToken)) &#123; return true; &#125; else if (StringUtils.isBlank(redisToken)) &#123; bucket.set(token); &#125; else &#123; Long redisTokenUnixTime = JWTUtil.getClaim(redisToken, "createTime").asLong(); Long tokenUnixTime = JWTUtil.getClaim(token, "createTime").asLong(); // token &gt; redisToken åˆ™è¦†ç›– if (tokenUnixTime.compareTo(redisTokenUnixTime) &gt; 0) &#123; bucket.set(token); &#125; else &#123; // æ³¨é”€å½“å‰token userService.logout(token); sendJsonResponse(response, 4001, "æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"); return false; &#125; &#125; return true; &#125;&#125; é˜Ÿåˆ—è¸¢å‡º 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192public class QueueKickOutFilter extends KickOutFilter &#123; /** * è¸¢å‡ºä¹‹å‰ç™»å½•çš„/ä¹‹åç™»å½•çš„ç”¨æˆ· é»˜è®¤è¸¢å‡ºä¹‹å‰ç™»å½•çš„ç”¨æˆ· */ private boolean kickoutAfter = false; /** * åŒä¸€ä¸ªå¸å·æœ€å¤§ä¼šè¯æ•° é»˜è®¤1 */ private int maxSession = 1; public void setKickoutAfter(boolean kickoutAfter) &#123; this.kickoutAfter = kickoutAfter; &#125; public void setMaxSession(int maxSession) &#123; this.maxSession = maxSession; &#125; @Override public boolean isAccessAllowed(HttpServletRequest request, HttpServletResponse response) throws Exception &#123; String token = request.getHeader("Authorization"); UserBO currentSession = CurrentUser.get(); Assert.notNull(currentSession, "currentSession cannot null"); String username = currentSession.getUsername(); String userKey = PREFIX + "deque_" + username; String lockKey = PREFIX_LOCK + username; RLock lock = redissonClient.getLock(lockKey); lock.lock(2, TimeUnit.SECONDS); try &#123; RDeque&lt;String&gt; deque = redissonClient.getDeque(userKey); // å¦‚æœé˜Ÿåˆ—é‡Œæ²¡æœ‰æ­¤tokenï¼Œä¸”ç”¨æˆ·æ²¡æœ‰è¢«è¸¢å‡ºï¼›æ”¾å…¥é˜Ÿåˆ— if (!deque.contains(token) &amp;&amp; currentSession.isKickout() == false) &#123; deque.push(token); &#125; // å¦‚æœé˜Ÿåˆ—é‡Œçš„sessionIdæ•°è¶…å‡ºæœ€å¤§ä¼šè¯æ•°ï¼Œå¼€å§‹è¸¢äºº while (deque.size() &gt; maxSession) &#123; String kickoutSessionId; if (kickoutAfter) &#123; // å¦‚æœè¸¢å‡ºåè€… kickoutSessionId = deque.removeFirst(); &#125; else &#123; // å¦åˆ™è¸¢å‡ºå‰è€… kickoutSessionId = deque.removeLast(); &#125; try &#123; RBucket&lt;UserBO&gt; bucket = redissonClient.getBucket(kickoutSessionId); UserBO kickoutSession = bucket.get(); if (kickoutSession != null) &#123; // è®¾ç½®ä¼šè¯çš„kickoutå±æ€§è¡¨ç¤ºè¸¢å‡ºäº† kickoutSession.setKickout(true); bucket.set(kickoutSession); &#125; &#125; catch (Exception e) &#123; &#125; &#125; // å¦‚æœè¢«è¸¢å‡ºäº†ï¼Œç›´æ¥é€€å‡ºï¼Œé‡å®šå‘åˆ°è¸¢å‡ºåçš„åœ°å€ if (currentSession.isKickout()) &#123; // ä¼šè¯è¢«è¸¢å‡ºäº† try &#123; // æ³¨é”€ userService.logout(token); sendJsonResponse(response, 4001, "æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"); &#125; catch (Exception e) &#123; &#125; return false; &#125; &#125; finally &#123; if (lock.isHeldByCurrentThread()) &#123; lock.unlock(); LOGGER.info(Thread.currentThread().getName() + " unlock"); &#125; else &#123; LOGGER.info(Thread.currentThread().getName() + " already automatically release lock"); &#125; &#125; return true; &#125;&#125; æ¯”è¾ƒä¸¤ç§æ–¹æ³• ç¬¬ä¸€ç§æ–¹æ³•é€»è¾‘ç®€å•ç²—æš´, åªç»´æŠ¤ä¸€ä¸ªkey-value ä¸éœ€è¦ä½¿ç”¨é”ï¼Œéè¦è¯´ç¼ºç‚¹çš„è¯æ²¡æœ‰ç¬¬äºŒç§æ–¹æ³•çµæ´»ã€‚ ç¬¬äºŒç§æ–¹æ³•æˆ‘å¾ˆå–œæ¬¢ï¼Œä»£ç å¾ˆä¼˜é›…çµæ´»ï¼Œä½†æ˜¯é€»è¾‘ç›¸å¯¹éº»çƒ¦ä¸€äº›ï¼Œè€Œä¸”ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨åœ°æ“ä½œé˜Ÿåˆ—ï¼Œè¦ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚ç›®å‰æˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹æ³• æ¼”ç¤ºä¸‹è½½åœ°å€: https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/login-control è¿è¡Œé¡¹ç›®ï¼Œè®¿é—®localhost:8887 demoä¸­æ²¡æœ‰å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œéšæ„è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œç”¨æˆ·åç›¸åŒåˆ™è¢«è¸¢å‡º è®¿é—® localhost:8887/index.html å¼¹å‡ºç”¨æˆ·ä¿¡æ¯, ä»£è¡¨å½“å‰ç”¨æˆ·æœ‰æ•ˆ å¦ä¸€ä¸ªæµè§ˆå™¨ç™»å½•ç›¸åŒç”¨æˆ·åï¼Œå›åˆ°ç¬¬ä¸€ä¸ªæµè§ˆå™¨åˆ·æ–°é¡µé¢ï¼Œæç¤ºè¢«è¸¢å‡º application.propertiesä¸­é€‰æ‹©å¼€å¯å“ªç§è¿‡æ»¤å™¨æ¨¡å¼ï¼Œé»˜è®¤æ˜¯æ¯”è¾ƒæ—¶é—´æˆ³è¸¢å‡ºï¼Œå¼€å¯é˜Ÿåˆ—è¸¢å‡º queue-filter.enabled=true]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>Redis</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaç†è§£ç”Ÿäº§è€…-æ¶ˆè´¹è€…è®¾è®¡æ¨¡å¼]]></title>
    <url>%2Fpost%2F5b860a98.html</url>
    <content type="text"><![CDATA[åœ¨å®é™…çš„è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°å¦‚ä¸‹åœºæ™¯ï¼šæŸä¸ªæ¨¡å—è´Ÿè´£äº§ç”Ÿæ•°æ®ï¼Œè¿™äº›æ•°æ®ç”±å¦ä¸€ä¸ªæ¨¡å—æ¥è´Ÿè´£å¤„ç†ï¼ˆæ­¤å¤„çš„æ¨¡å—æ˜¯å¹¿ä¹‰çš„ï¼Œå¯ä»¥æ˜¯ç±»ã€å‡½æ•°ã€çº¿ç¨‹ã€è¿›ç¨‹ç­‰ï¼‰ã€‚äº§ç”Ÿæ•°æ®çš„æ¨¡å—ï¼Œå°±å½¢è±¡åœ°ç§°ä¸ºç”Ÿäº§è€…ï¼›è€Œå¤„ç†æ•°æ®çš„æ¨¡å—ï¼Œå°±ç§°ä¸ºæ¶ˆè´¹è€…ï¼› ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´é€šè¿‡ç¼“å†²åŒº(é€šå¸¸æ˜¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—)å®ç°é€šè®¯, ç”Ÿäº§è€…å°†äº§ç”Ÿçš„æ•°æ®æ”¾å…¥ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…ä»ç¼“å†²åŒºä¸­è·å–æ•°æ®ã€‚ ä¸¾ä¸ªæ —å­å»é£Ÿå ‚åƒé¥­ï¼Œé£Ÿå ‚çš„å”å”é˜¿å§¨ä¼šå…ˆå°†é¥­åšå¥½ï¼Œæ”¾åˆ°é£Ÿå ‚çª—å£ï¼ŒåŒå­¦ä»¬ä¼šå»é£Ÿå ‚æ‰“é¥­ã€‚ ç”Ÿäº§è€…(é£Ÿå ‚çš„å”å”é˜¿å§¨) -&gt; ç”Ÿäº§æ•°æ®(åšé¥­) -&gt; ç¼“å†²åŒº(é£Ÿå ‚çª—å£) -&gt; æ¶ˆè´¹æ•°æ®(æ‰“é¥­) -&gt; æ¶ˆè´¹è€…(åŒå­¦) ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°æ€è·¯ ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä»»åŠ¡å¾ˆæ˜ç¡®ï¼Œç”Ÿäº§è€…åªç®¡ç”Ÿäº§æ•°æ®ï¼Œç„¶åæ·»åŠ åˆ°ç¼“å†²é˜Ÿåˆ—ã€‚è€Œæ¶ˆè´¹è€…åªç®¡ä»ç¼“å†²é˜Ÿåˆ—ä¸­è·å–æ•°æ® å¯ä»¥è¯´ç”Ÿäº§è€…æ¶ˆè´¹è€…éƒ½å¾ˆæ— è„‘ï¼Œè€Œç¼“å†²é˜Ÿåˆ—åˆ™è¦å¿™ä¸€äº›ï¼Œä»–èµ·åˆ°äº†ä¸€ä¸ªå¹³è¡¡ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä½œç”¨ã€‚ å¦‚æœç”Ÿäº§è€…ç”Ÿäº§é€Ÿåº¦è¿‡å¿«ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹çš„å¾ˆæ…¢ï¼Œå¹¶ä¸”ç¼“å†²é˜Ÿåˆ—è¾¾åˆ°äº†æœ€å¤§é•¿åº¦æ—¶ã€‚ç¼“å†²é˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§è€…ï¼Œè®©ç”Ÿäº§è€…åœæ­¢ç”Ÿäº§ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ•°æ®åï¼Œå†å”¤é†’ç”Ÿäº§è€… åŒç†ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹é€Ÿåº¦è¿‡å¿«æ—¶ï¼Œé˜Ÿåˆ—ä¸ºç©ºæ—¶ã€‚ç¼“å†²é˜Ÿåˆ—åˆ™ä¼šé˜»å¡æ¶ˆè´¹è€…ï¼Œå¾…ç”Ÿäº§è€…å‘é˜Ÿåˆ—æ·»åŠ æ•°æ®åï¼Œå†å”¤é†’æ¶ˆè´¹è€… å®ç°é€šè¿‡ä¸Šè¿°çš„åˆ†æåï¼Œæˆ‘ä»¬æ¥ç”¨æœ€åŸºæœ¬çš„Javaä»£ç å®ç°ä¸€ä¸‹ æˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸‹Consumer å’ŒProducer ï¼Œä»–ä»¬çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬åªå¾ªç¯åæ¬¡æ¨¡æ‹Ÿä¸€ä¸‹ç”Ÿäº§æ¶ˆè´¹çš„åœºæ™¯ã€‚Buffer ä¸ºç¼“å†²åŒºï¼Œæˆ‘ä»¬å¾…ä¼šå†çœ‹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/** * æ¶ˆè´¹è€… */class Consumer extends Thread &#123; private Buffer buffer; private int number; public Consumer(Buffer b, int number) &#123; buffer = b; this.number = number; &#125; public void run() &#123; int value; for (int i = 0; i &lt; 10; i++) &#123; // ä»ç¼“å†²åŒºä¸­è·å–æ•°æ® value = buffer.get(); try &#123; // æ¨¡æ‹Ÿæ¶ˆè´¹æ•°æ® sleep(1000); &#125; catch (InterruptedException e) &#123; &#125; System.out.println("æ¶ˆè´¹è€… #" + this.number + " got: " + value); &#125; &#125;&#125;/** * ç”Ÿäº§è€… */class Producer extends Thread &#123; private Buffer buffer; private int number; public Producer(Buffer b, int number) &#123; buffer = b; this.number = number; &#125; public void run() &#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; // æ¨¡æ‹Ÿç”Ÿäº§æ•°æ® sleep(500); &#125; catch (InterruptedException e) &#123; &#125; // å°†æ•°æ®æ”¾å…¥ç¼“å†²åŒº buffer.put(i); System.out.println("ç”Ÿäº§è€… #" + this.number + " put: " + i); &#125; &#125;&#125; å¯ä»¥çœ‹åˆ° Consumer å’ŒProducer æ²¡æœ‰ä»€ä¹ˆé€»è¾‘ï¼Œåªæ˜¯å¯¹ç¼“å†²åŒºçš„è¯»å†™æ“ä½œï¼Œä¸‹é¢æˆ‘ä»¬æ¥é‡ç‚¹çœ‹ä¸€ä¸‹ Bufferçš„å®ç° 12345678910111213141516171819202122232425262728293031/** * ç¼“å†²åŒº */class Buffer &#123; private List&lt;Integer&gt; data = new ArrayList&lt;&gt;(); private static final int MAX = 10; private static final int MIN = 0; public synchronized int get() &#123; while (MIN == data.size()) &#123; try &#123; wait(); &#125; catch (InterruptedException e) &#123; &#125; &#125; Integer i = data.remove(0); notifyAll(); return i; &#125; public synchronized void put(int value) &#123; while (MAX == data.size()) &#123; try &#123; wait(); &#125; catch (InterruptedException e) &#123; &#125; &#125; data.add(value); notifyAll(); &#125;&#125; åˆ†æput(): ç”Ÿäº§è€…å‘ç¼“å†²åŒºå†™å…¥æ•°æ®çš„æ“ä½œï¼Œå½“MAX == data.size()æ—¶ï¼Œå°±æ˜¯æˆ‘ä»¬åˆšåˆšæ‰€è¯´çš„ç”Ÿäº§è€…é€Ÿåº¦è¿‡å¿«ï¼Œæ¶ˆè´¹è€…é€Ÿåº¦è¿‡æ…¢çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™èº«ä¸º â€œç¼“å†²åŒºâ€ è¦å¹³è¡¡ä¸€ä¸‹ï¼Œè°ƒç”¨ Object.wait()ï¼Œè®©å½“å‰ç”Ÿäº§è€…çº¿ç¨‹è¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®åå°†å…¶å”¤é†’ å½“MAX &gt; data.size()æ—¶ï¼Œå‘ArrayListä¸­æ·»åŠ æ•°æ®ï¼Œå¹¶å°è¯•å”¤é†’æ­£åœ¨ç­‰å¾…çš„æ¶ˆè´¹è€…ï¼ˆè¿™ä¸€æ­¥æ˜¯å¿…é¡»çš„ï¼‰ get(): æ¶ˆè´¹è€…å‘ç¼“å†²åŒºè¯»æ•°æ®çš„æ“ä½œï¼Œå’Œä¸Šè¿°é€»è¾‘ç›¸åï¼Œå½“MIN == data.size()æ—¶ï¼Œè¿™æ—¶æ¶ˆè´¹è€…é€Ÿåº¦å¤ªå¿«ï¼Œç”Ÿäº§è€…å¤ªæ…¢ï¼Œé˜Ÿåˆ—ä¸­å·²ç»æ²¡æœ‰æ•°æ®äº†ã€‚â€ç¼“å†²åŒºâ€ å†ä¸€æ¬¡ç«™äº†å‡ºæ¥ï¼Œé€šè¿‡wait()ï¼Œè®©å½“å‰æ¶ˆè´¹è€…çº¿ç¨‹è¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œç­‰å¾…ç”Ÿäº§è€…ç”Ÿäº§æ•°æ®åå°†å…¶å”¤é†’ å½“MIN &lt; data.size()æ—¶ï¼Œå–å‡ºArrayListä¸­ç¬¬ä¸€æ¡æ•°æ®ï¼Œå¹¶å°è¯•å”¤é†’æ­£åœ¨ç­‰å¾…çš„ç”Ÿäº§è€… ä¸Šè¿°æ¡ˆä¾‹å®Œæ•´ä»£ç  ProducerConsumer.java ä¸Šè¿°ä½¿ç”¨æœ€åŸºæœ¬çš„Javaä»£ç å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå®é™…å¼€å‘ä¸­æˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨BlockingQueueã€ReentrantLockã€ThreadPoolExecutorè¿™äº›æ›´æˆç†Ÿçš„è½®å­ï¼Œä½†æ˜¯ä¸€é€šç™¾é€š å…³äºä¸Šè¿°æ¡ˆä¾‹çš„æ€è€ƒ ä¸ºä»€ä¹ˆç¼“å†²åŒºçš„åˆ¤æ–­æ¡ä»¶æ˜¯ while(condition) è€Œä¸æ˜¯ if(condition)ï¼Ÿç­”ï¼šé˜²æ­¢çº¿ç¨‹è¢«é”™è¯¯çš„å”¤é†’ä¸¾ä¾‹ï¼šå½“æœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹wait() æ—¶ï¼Œæ­¤æ—¶ç”Ÿäº§è€…åœ¨é˜Ÿåˆ—é‡Œæ”¾å…¥äº†ä¸€æ¡æ•°æ®ï¼Œå¹¶è°ƒç”¨notifyAll(), ä¸¤ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹è¢«å”¤é†’ï¼Œç¬¬ä¸€ä¸ªæ¶ˆè´¹è€…æˆåŠŸå–å‡ºé˜Ÿåˆ—ä¸­æ•°æ®ï¼Œè€Œç¬¬äºŒä¸ªæ¶ˆè´¹è€…æ­¤æ—¶å°±æ˜¯è¢«é”™è¯¯çš„å”¤é†’äº†ï¼Œç¨‹åºæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥æ­¤å¤„ä½¿ç”¨ while(condition)å¾ªç¯æ£€æŸ¥ Javaä¸­è¦æ±‚wait()æ–¹æ³•ä¸ºä»€ä¹ˆè¦æ”¾åœ¨åŒæ­¥å—ä¸­ï¼Ÿç­”ï¼šé˜²æ­¢å‡ºç°Lost Wake-Upä¸¾ä¾‹ï¼šå¦‚æœé˜Ÿåˆ—æ²¡æœ‰åŒæ­¥é™åˆ¶ï¼Œæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…å¹¶å‘æ‰§è¡Œï¼Œå¾ˆå¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼Œæ¶ˆè´¹è€…è¿™æ—¶å€™æ£€æŸ¥äº†æ¡ä»¶æ­£å‡†å¤‡wait(),è¿™æ—¶å€™ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°äº†ç”Ÿäº§è€…ï¼Œç”Ÿäº§è€…å’”å’”ä¸€é¡¿æ“ä½œå‘é˜Ÿåˆ—ä¸­æ·»åŠ äº†æ•°æ®ï¼Œå¹¶å”¤é†’äº†æ¶ˆè´¹è€…ï¼Œè€Œæ­¤æ—¶æ¶ˆè´¹è€…å¹¶æ²¡æœ‰wait()ï¼Œè¿™ä¸ªé€šçŸ¥å°±ä¸¢æ‰äº†ï¼Œç„¶åæ¶ˆè´¹è€…wait() å°±è¿™æ ·ç¡å»äº†â€¦ ä¸ºä»€ä¹ˆç¼“å†²åŒºä¸€å®šè¦ä½¿ç”¨é˜»å¡é˜Ÿåˆ—å®ç°ï¼ŸåŒç†å°±æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°Lost Wake-Up ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼é¡ºåºæ‰§è¡Œä¸å°±å¯ä»¥äº†å—ï¼Ÿç”Ÿäº§è€…æ¶ˆè´¹è€…åˆ°åº•æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿ å¹¶å‘ ï¼ˆå¼‚æ­¥ï¼‰ç”Ÿäº§è€…ç›´æ¥è°ƒç”¨æ¶ˆè´¹è€…ï¼Œä¸¤è€…æ˜¯åŒæ­¥ï¼ˆé˜»å¡ï¼‰çš„ï¼Œå¦‚æœæ¶ˆè´¹è€…ååæ•°æ®å¾ˆæ…¢ï¼Œè¿™æ—¶å€™ç”Ÿäº§è€…ç™½ç™½æµªè´¹å¤§å¥½æ—¶å…‰ã€‚è€Œä½¿ç”¨è¿™ç§æ¨¡å¼ä¹‹åï¼Œç”Ÿäº§è€…å°†æ•°æ®ä¸¢åˆ°ç¼“å†²åŒºï¼Œç»§ç»­ç”Ÿäº§ï¼Œå®Œå…¨ä¸ä¾èµ–æ¶ˆè´¹è€…ï¼Œç¨‹åºæ‰§è¡Œæ•ˆç‡ä¼šå¤§å¤§æé«˜ã€‚ è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¸ç›´æ¥ä¾èµ–ï¼Œé€šè¿‡ç¼“å†²åŒºé€šè®¯ï¼Œå°†ä¸¤ä¸ªç±»ä¹‹é—´çš„è€¦åˆåº¦é™åˆ°æœ€ä½ã€‚ å‚è€ƒhttps://blog.csdn.net/u011109589/article/details/80519863]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Boot ä½¿ç”¨ AOP é˜²æ­¢é‡å¤æäº¤]]></title>
    <url>%2Fpost%2F8398a16a.html</url>
    <content type="text"><![CDATA[åœ¨ä¼ ç»Ÿçš„webé¡¹ç›®ä¸­ï¼Œé˜²æ­¢é‡å¤æäº¤ï¼Œé€šå¸¸åšæ³•æ˜¯ï¼šåç«¯ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æäº¤ä»¤ç‰Œï¼ˆuuidï¼‰ï¼Œå¹¶å­˜å‚¨åœ¨æœåŠ¡ç«¯ã€‚é¡µé¢æäº¤è¯·æ±‚æºå¸¦è¿™ä¸ªæäº¤ä»¤ç‰Œï¼Œåç«¯éªŒè¯å¹¶åœ¨ç¬¬ä¸€æ¬¡éªŒè¯ååˆ é™¤è¯¥ä»¤ç‰Œï¼Œä¿è¯æäº¤è¯·æ±‚çš„å”¯ä¸€æ€§ã€‚ ä¸Šè¿°çš„æ€è·¯å…¶å®æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯éœ€è¦å‰åç«¯éƒ½ç¨åŠ æ”¹åŠ¨ï¼Œå¦‚æœåœ¨ä¸šåŠ¡å¼€å‘å®Œåœ¨åŠ è¿™ä¸ªçš„è¯ï¼Œæ”¹åŠ¨é‡æœªå…æœ‰äº›å¤§äº†ï¼Œæœ¬èŠ‚çš„å®ç°æ–¹æ¡ˆæ— éœ€å‰ç«¯é…åˆï¼Œçº¯åç«¯å¤„ç†ã€‚ æ€è·¯ è‡ªå®šä¹‰æ³¨è§£ @NoRepeatSubmit æ ‡è®°æ‰€æœ‰Controllerä¸­çš„æäº¤è¯·æ±‚ é€šè¿‡AOP å¯¹æ‰€æœ‰æ ‡è®°äº† @NoRepeatSubmit çš„æ–¹æ³•æ‹¦æˆª åœ¨ä¸šåŠ¡æ–¹æ³•æ‰§è¡Œå‰ï¼Œè·å–å½“å‰ç”¨æˆ·çš„ tokenï¼ˆæˆ–è€…JSessionIdï¼‰+ å½“å‰è¯·æ±‚åœ°å€ï¼Œä½œä¸ºä¸€ä¸ªå”¯ä¸€ KEYï¼Œå»è·å– Redis åˆ†å¸ƒå¼é”ï¼ˆå¦‚æœæ­¤æ—¶å¹¶å‘è·å–ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šæˆåŠŸè·å–é”ï¼‰ ä¸šåŠ¡æ–¹æ³•æ‰§è¡Œåï¼Œé‡Šæ”¾é” å…³äºRedis åˆ†å¸ƒå¼é” ä¸äº†è§£çš„åŒå­¦æˆ³è¿™é‡Œ ==&gt; Redisåˆ†å¸ƒå¼é”çš„æ­£ç¡®å®ç°æ–¹å¼ ä½¿ç”¨Redis æ˜¯ä¸ºäº†åœ¨è´Ÿè½½å‡è¡¡éƒ¨ç½²ï¼Œå¦‚æœæ˜¯å•æœºçš„éƒ¨ç½²çš„é¡¹ç›®å¯ä»¥ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æœ¬åœ°Cache æ›¿ä»£ Redis Codeè¿™é‡Œåªè´´å‡º AOP ç±»å’Œæµ‹è¯•ç±»ï¼Œå®Œæ•´ä»£ç è§ ==&gt; Gitee12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061@Aspect@Componentpublic class RepeatSubmitAspect &#123; private final static Logger LOGGER = LoggerFactory.getLogger(RepeatSubmitAspect.class); @Autowired private RedisLock redisLock; @Pointcut("@annotation(noRepeatSubmit)") public void pointCut(NoRepeatSubmit noRepeatSubmit) &#123; &#125; @Around("pointCut(noRepeatSubmit)") public Object around(ProceedingJoinPoint pjp, NoRepeatSubmit noRepeatSubmit) throws Throwable &#123; int lockSeconds = noRepeatSubmit.lockTime(); HttpServletRequest request = RequestUtils.getRequest(); Assert.notNull(request, "request can not null"); // æ­¤å¤„å¯ä»¥ç”¨tokenæˆ–è€…JSessionId String token = request.getHeader("Authorization"); String path = request.getServletPath(); String key = getKey(token, path); String clientId = getClientId(); boolean isSuccess = redisLock.tryLock(key, clientId, lockSeconds); if (isSuccess) &#123; LOGGER.info("tryLock success, key = [&#123;&#125;], clientId = [&#123;&#125;]", key, clientId); // è·å–é”æˆåŠŸ, æ‰§è¡Œè¿›ç¨‹ Object result; try &#123; result = pjp.proceed(); &#125; finally &#123; // è§£é” redisLock.releaseLock(key, clientId); LOGGER.info("releaseLock success, key = [&#123;&#125;], clientId = [&#123;&#125;]", key, clientId); &#125; return result; &#125; else &#123; // è·å–é”å¤±è´¥ï¼Œè®¤ä¸ºæ˜¯é‡å¤æäº¤çš„è¯·æ±‚ LOGGER.info("tryLock fail, key = [&#123;&#125;]", key); return new ResultBean(ResultBean.FAIL, "é‡å¤è¯·æ±‚ï¼Œè¯·ç¨åå†è¯•", null); &#125; &#125; private String getKey(String token, String path) &#123; return token + path; &#125; private String getClientId() &#123; return UUID.randomUUID().toString(); &#125;&#125; å¤šçº¿ç¨‹æµ‹è¯•æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼Œæ¨¡æ‹Ÿåä¸ªè¯·æ±‚å¹¶å‘åŒæ—¶æäº¤1234567891011121314151617181920212223242526272829303132333435363738394041424344@Componentpublic class RunTest implements ApplicationRunner &#123; private static final Logger LOGGER = LoggerFactory.getLogger(RunTest.class); @Autowired private RestTemplate restTemplate; @Override public void run(ApplicationArguments args) throws Exception &#123; System.out.println("æ‰§è¡Œå¤šçº¿ç¨‹æµ‹è¯•"); String url="http://localhost:8000/submit"; CountDownLatch countDownLatch = new CountDownLatch(1); ExecutorService executorService = Executors.newFixedThreadPool(10); for(int i=0; i&lt;10; i++)&#123; String userId = "userId" + i; HttpEntity request = buildRequest(userId); executorService.submit(() -&gt; &#123; try &#123; countDownLatch.await(); System.out.println("Thread:"+Thread.currentThread().getName()+", time:"+System.currentTimeMillis()); ResponseEntity&lt;String&gt; response = restTemplate.postForEntity(url, request, String.class); System.out.println("Thread:"+Thread.currentThread().getName() + "," + response.getBody()); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;); &#125; countDownLatch.countDown(); &#125; private HttpEntity buildRequest(String userId) &#123; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); headers.set("Authorization", "yourToken"); Map&lt;String, Object&gt; body = new HashMap&lt;&gt;(); body.put("userId", userId); return new HttpEntity&lt;&gt;(body, headers); &#125;&#125; æˆåŠŸé˜²æ­¢é‡å¤æäº¤ï¼Œæ§åˆ¶å°æ—¥å¿—å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°åä¸ªçº¿ç¨‹çš„å¯åŠ¨æ—¶é—´å‡ ä¹åŒæ—¶å‘èµ·ï¼Œåªæœ‰ä¸€ä¸ªè¯·æ±‚æäº¤æˆåŠŸäº† æœ¬èŠ‚demoæˆ³è¿™é‡Œ ==&gt; Giteebuildé¡¹ç›®ä¹‹åï¼Œå¯åŠ¨æœ¬åœ°redisï¼Œè¿è¡Œé¡¹ç›®è‡ªåŠ¨æ‰§è¡Œæµ‹è¯•æ–¹æ³• å‚è€ƒhttps://www.jianshu.com/p/09c6b05b670a]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>SpringBoot</tag>
        <tag>AOP</tag>
        <tag>åˆ†å¸ƒå¼é”</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-å¹¶å‘æ§åˆ¶----è¯»é”ã€å†™é”ã€ä¹è§‚é”]]></title>
    <url>%2Fpost%2Fe708def4.html</url>
    <content type="text"><![CDATA[å¹¶å‘æ˜¯ä¸€ä¸ªè®©äººå¾ˆå¤´ç–¼çš„é—®é¢˜ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåœ¨æœåŠ¡ç«¯æˆ–è€…æ•°æ®åº“ç«¯åšå¤„ç†ï¼Œä¿è¯åœ¨å¹¶å‘ä¸‹æ•°æ®çš„å‡†ç¡®æ€§ï¼Œä»Šå¤©æˆ‘ä»¬ç®€è¦çš„è®¨è®ºä¸€ä¸‹MySQLä¸­å¦‚ä½•é€šè¿‡é”è§£å†³å¹¶å‘é—®é¢˜ è¯»é” ä¹Ÿå«å…±äº«é” ï¼ˆshared lockï¼‰ å¦‚ä½•ä½¿ç”¨SELECT * FROM table_name WHERE ... LOCK IN SHARE MODE è¯¦è§£å³äº‹åŠ¡A ä½¿ç”¨å…±äº«é” è·å–äº†æŸæ¡ï¼ˆæˆ–è€…æŸäº›ï¼‰è®°å½•æ—¶ï¼Œäº‹åŠ¡B å¯ä»¥è¯»å–è¿™äº›è®°å½•ï¼Œå¯ä»¥ç»§ç»­æ·»åŠ å…±äº«é”ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹æˆ–åˆ é™¤è¿™äº›è®°å½•ï¼ˆå½“äº‹åŠ¡B å¯¹è¿™äº›æ•°æ®ä¿®æ”¹æˆ–åˆ é™¤æ—¶ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´è‡³é”ç­‰å¾…è¶…æ—¶æˆ–è€…äº‹åŠ¡Aæäº¤ï¼‰ ä½¿ç”¨åœºæ™¯è¯»å–ç»“æœé›†çš„æœ€æ–°ç‰ˆæœ¬ï¼ŒåŒæ—¶é˜²æ­¢å…¶ä»–äº‹åŠ¡äº§ç”Ÿæ›´æ–°è¯¥ç»“æœé›†ä¸»è¦ç”¨åœ¨éœ€è¦æ•°æ®ä¾å­˜å…³ç³»æ—¶ç¡®è®¤æŸè¡Œè®°å½•æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ç¡®ä¿æ²¡æœ‰äººå¯¹è¿™ä¸ªè®°å½•è¿›è¡ŒUPDATEæˆ–è€…DELETEæ“ä½œ æ³¨æ„äº‹é¡¹å½“ä½¿ç”¨è¯»é”æ—¶ï¼Œé¿å…äº§ç”Ÿå¦‚ä¸‹æ“ä½œ 123456äº‹åŠ¡1BEGIN;select * from sys_user where id = 1 LOCK IN SHARE MODE; (æ­¥éª¤1)update sys_user set username = &quot;taven&quot; where id = 1; (æ­¥éª¤3ï¼Œå‘ç”Ÿé˜»å¡)COMMIT; 123456äº‹åŠ¡2BEGIN;select * from sys_user where id = 1 LOCK IN SHARE MODE; (æ­¥éª¤2)update sys_user set username = &quot;taven&quot; where id = 1; (æ­¥éª¤4ï¼Œæ­»é”)COMMIT; åˆ†ææ ¹æ®æˆ‘ä»¬ä¹‹å‰å¯¹è¯»é”å®šä¹‰å¯çŸ¥ï¼Œå½“æœ‰äº‹åŠ¡æ‹¿åˆ°ä¸€ä¸ªç»“æœé›†çš„è¯»é”æ—¶ï¼Œå…¶ä»–äº‹åŠ¡æƒ³è¦æ›´æ–°è¯¥ç»“æœé›†ï¼Œéœ€è¦æ‹¿åˆ°è¯»é”çš„äº‹åŠ¡æäº¤ï¼ˆé‡Šæ”¾é”ï¼‰ã€‚è€Œä¸Šè¿°æƒ…å†µä¸¤ä¸ªäº‹åŠ¡åˆ†åˆ«æ‹¿åˆ°äº†è¯»é”ï¼Œè€Œä¸”éƒ½æœ‰update æ“ä½œï¼Œä¸¤ä¸ªäº‹åŠ¡äº’ç›¸ç­‰å¾…é€ æˆæ­»é”ï¼ˆéƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾è¯»é”ï¼‰ å†™é” ä¹Ÿå«æ’å®ƒé”ï¼ˆexclusive lockï¼‰ å¦‚ä½•ä½¿ç”¨SELECT * FROM table_name WHERE ... FOR UPDATE è¯¦è§£ä¸€ä¸ªå†™é”ä¼šé˜»å¡å…¶ä»–çš„è¯»é”å’Œå†™é”å³äº‹åŠ¡A å¯¹æŸäº›è®°å½•æ·»åŠ å†™é”æ—¶ï¼Œäº‹åŠ¡B æ— æ³•å‘è¿™äº›è®°å½•æ·»åŠ å†™é”æˆ–è€…è¯»é”ï¼ˆä¸æ·»åŠ é”çš„è¯»å–æ˜¯å¯ä»¥çš„ï¼‰ï¼Œäº‹åŠ¡B ä¹Ÿæ— æ³•æ‰§è¡Œå¯¹ é”ä½çš„æ•°æ® update delete ä½¿ç”¨åœºæ™¯è¯»å–ç»“æœé›†çš„æœ€æ–°ç‰ˆæœ¬ï¼ŒåŒæ—¶é˜²æ­¢å…¶ä»–äº‹åŠ¡äº§ç”Ÿè¯»å–æˆ–è€…æ›´æ–°è¯¥ç»“æœé›†ã€‚ä¾‹å¦‚ï¼šå¹¶å‘ä¸‹å¯¹å•†å“åº“å­˜çš„æ“ä½œ æ³¨æ„äº‹é¡¹åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½éœ€è¦æ³¨æ„ï¼Œè¯»é”ã€å†™é”å±äºè¡Œçº§é”ã€‚å³äº‹åŠ¡1 å¯¹å•†å“A è·å–å†™é”ï¼Œå’Œäº‹åŠ¡2 å¯¹å•†å“B è·å–å†™é”äº’ç›¸ä¸ä¼šé˜»å¡çš„ã€‚éœ€è¦æˆ‘ä»¬æ³¨æ„çš„æ˜¯æˆ‘ä»¬çš„SQLè¦åˆç†ä½¿ç”¨ç´¢å¼•ï¼Œå½“æˆ‘ä»¬çš„SQL å…¨è¡¨æ‰«æçš„æ—¶å€™ï¼Œè¡Œçº§é”ä¼šå˜æˆè¡¨é”ã€‚ä½¿ç”¨EXPLAINæŸ¥çœ‹ SQLæ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•ï¼Œæ‰«æäº†å¤šå°‘è¡Œ ä¹è§‚é” ä¸Šè¿°ä»‹ç»çš„æ˜¯è¡Œçº§é”ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦åœ°æ”¯æŒå¹¶å‘å¤„ç†ï¼ˆåŒæ—¶ä¹Ÿå¸¦æ¥äº†æœ€å¤§çš„é”å¼€é”€ï¼‰ä¹è§‚é”æ˜¯ä¸€ç§é€»è¾‘é”ï¼Œé€šè¿‡æ•°æ®çš„ç‰ˆæœ¬å·ï¼ˆvesionï¼‰çš„æœºåˆ¶æ¥å®ç°ï¼Œæå¤§é™ä½äº†æ•°æ®åº“çš„æ€§èƒ½å¼€é”€ã€‚ æˆ‘ä»¬ä¸ºè¡¨æ·»åŠ ä¸€ä¸ªå­—æ®µ versionï¼Œè¯»å–æ•°æ®æ—¶å°†æ­¤ç‰ˆæœ¬å·ä¸€åŒè¯»å‡ºï¼Œä¹‹åæ›´æ–°æ—¶ï¼Œå¯¹æ­¤ç‰ˆæœ¬å·+1ï¼ŒåŒæ—¶å°†æäº¤æ•°æ®çš„version ä¸æ•°æ®åº“ä¸­å¯¹åº”è®°å½•çš„å½“å‰version è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæäº¤çš„æ•°æ®ç‰ˆæœ¬å·å¤§äºæ•°æ®åº“è¡¨å½“å‰ç‰ˆæœ¬å·ï¼Œåˆ™äºˆä»¥æ›´æ–°ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯è¿‡æœŸæ•°æ® 123update t_goods set status=2,version=version+1where id=#&#123;id&#125; and version &lt; #&#123;version&#125;; // æ›´æ–°å‰å°†versionè‡ªå¢ æˆ–è€…123update t_goods set status=2,version=version+1where id=#&#123;id&#125; and version = #&#123;version&#125;; // æ›´æ–°å‰version ä¸è‡ªå¢]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>å¹¶å‘</tag>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-ç†è§£äº‹åŠ¡éš”ç¦»çº§åˆ«]]></title>
    <url>%2Fpost%2Feca98c0.html</url>
    <content type="text"><![CDATA[åœ¨SQLæ ‡å‡†ä¸­å®šä¹‰äº†å››ç§éš”ç¦»çº§åˆ«ï¼Œæ¯ä¸€ç§çº§åˆ«éƒ½è§„å®šäº†ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰€åšçš„ä¿®æ”¹ï¼Œå“ªäº›åœ¨äº‹åŠ¡å†…å’Œäº‹åŠ¡é—´æ˜¯å¯è§çš„ï¼Œå“ªäº›æ˜¯ä¸å¯è§ï¼Œè¾ƒä½çš„éš”ç¦»çº§åˆ«é€šå¸¸å¯ä»¥æ‰§è¡Œæ›´é«˜çš„å¹¶å‘ï¼Œç³»ç»Ÿçš„å¼€é”€ä¹Ÿæ›´ä½ äº‹åŠ¡çš„ACID åŸå­æ€§ï¼ˆatomicityï¼‰ä¸€ä¸ªäº‹åŠ¡å¿…é¡»è§†ä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æœ€å°å·¥ä½œå•å…ƒï¼Œæ•´ä¸ªäº‹åŠ¡çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æäº¤æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰æ•°æ®åº“æ€»æ˜¯ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚ éš”ç¦»æ€§ï¼ˆisolationï¼‰é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰€ä½œçš„ä¿®æ”¹åœ¨æœ€ç»ˆæäº¤ä»¥å‰ï¼Œå¯¹å…¶ä»–äº‹åŠ¡æ˜¯ä¸å¯è§çš„ï¼Œåœ¨è®¨è®ºéš”ç¦»çº§åˆ«çš„æ—¶å€™ï¼Œä¼šç†è§£ä¸ºä»€ä¹ˆè¯´æ˜¯ â€œé€šå¸¸æ¥è¯´â€ æ˜¯ä¸å¯è§çš„ æŒä¹…æ€§ï¼ˆdurabilityï¼‰ä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œåˆ™æ‰€åšçš„ä¿®æ”¹å°±ä¼šæ°¸ä¹…çš„ä¿å­˜åˆ°æ•°æ®åº“ä¸­ éš”ç¦»çº§åˆ«1.READ UNCOMMITTED ï¼ˆæœªæäº¤è¯»ï¼‰ å³åœ¨è¯¥çº§åˆ«ï¼Œäº‹åŠ¡ä¸­çš„å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„ã€‚è¿™ç§æƒ…å†µè¢«ç§°ä¸ºè„è¯»ï¼ˆDirty Readï¼‰ï¼Œè¿™ä¸ªçº§åˆ«ä¼šå¯¼è‡´å¾ˆå¤šé—®é¢˜ï¼Œè€Œä¸”æ€§èƒ½ç›¸æ¯”å…¶ä»–çº§åˆ«ä¸ä¼šå¥½å¤ªå¤šï¼Œå®é™…å¾ˆå°‘ä½¿ç”¨ã€‚ 2.READ COMMITTED ï¼ˆæäº¤è¯»ï¼‰ å¤§å¤šæ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆä½†MySQLä¸æ˜¯ï¼‰ï¼Œè¯¥çº§åˆ«è§£å†³äº†è„è¯»çš„é—®é¢˜ã€‚ä½†æ˜¯äº‹åŠ¡ä¸­ä¼šè¯»åˆ°å…¶ä»–äº‹åŠ¡å·²æäº¤çš„æ•°æ®ï¼Œæ— æ³•ä¿è¯è¯»ä¸€è‡´æ€§ï¼Œä¼šé€ æˆä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚å¦‚ä¸‹äº‹åŠ¡çš„ä¸¤æ¬¡è¯»å–æ˜¯ä¸ä¸€è‡´çš„ 3.REPEATABLE READ ï¼ˆå¯é‡å¤è¯»ï¼‰ è¯¥éš”ç¦»çº§åˆ«ï¼Œè§£å†³äº†è„è¯»ï¼Œä¸å¯é‡å¤è¯»ã€‚InnoDB ä½¿ç”¨ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ä¸‹æ–‡ä¼šè®²åˆ°ï¼‰ ä¿è¯äº†äº‹åŠ¡ä¸­çš„è¯»ä¸€è‡´æ€§ã€‚ä½†è¿˜æ˜¯ä¼šå‡ºç°ä¸€ä¸ªå¹»è¯»çš„æƒ…å†µ å¦‚ä¸‹å›¾ï¼ˆå·¦ä¸ºäº‹åŠ¡Aï¼Œå³ä¸ºäº‹åŠ¡Bï¼‰äº‹åŠ¡æ‰§è¡Œè¿™æ ·çš„é€»è¾‘ï¼šæŸ¥æ‰¾æ˜¯å¦æœ‰æŸæ¡è®°å½•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ–°å¢ã€‚ äº‹åŠ¡A æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ id=&quot;1&quot;è¿™æ¡æ•°æ®ï¼Œå‘ç°ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ‰§è¡Œinsert æ­¤æ—¶äº‹åŠ¡B insertäº†è¿™æ¡æ•°æ®ï¼Œå¹¶æäº¤äº†äº‹åŠ¡ã€‚ äº‹åŠ¡A æ‰§è¡Œinsert å‘ç”Ÿä¸»é”®å†²çªï¼Œå†æ¬¡æ‰§è¡Œäº† select * from where id = &quot;1&quot;ï¼Œå‘ç°ä¾æ—§ä¸å­˜åœ¨å½“å‰ç»“æœé›† RR çº§åˆ«ä¸‹å¦‚ä½•é˜²æ­¢å¹»è¯»12# ç”¨ Xé”SELECT i` FROM `users` WHERE `id` = &quot;1&quot; FOR UPDATE; å¦‚æœ id = 1 çš„è®°å½•å­˜åœ¨åˆ™ä¼šè¢«åŠ è¡Œï¼ˆXï¼‰é”ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¼šåŠ  next-lock key / gap é”ï¼ˆèŒƒå›´è¡Œé”ï¼‰ï¼Œå³è®°å½•å­˜åœ¨ä¸å¦ï¼Œmysql éƒ½ä¼šå¯¹è®°å½•åº”è¯¥å¯¹åº”çš„ç´¢å¼•åŠ é”ï¼Œå…¶ä»–äº‹åŠ¡æ˜¯æ— æ³•å†è·å¾—åšæ“ä½œçš„ã€‚ 4.SERIALIZABLE ï¼ˆä¸²è¡ŒåŒ–ï¼‰åœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¯»å–çš„æ¯ä¸€è¡Œéƒ½ä¼šè¢«æ·»åŠ é”ï¼ˆä¸ªäººç†è§£æ˜¯è¯»é”å’Œgapé”ï¼‰ï¼Œå¯¼è‡´å¤§é‡çš„è¶…æ—¶å’Œé”äº‰ç”¨é—®é¢˜ï¼Œå®é™…åº”ç”¨ä¸­å¾ˆå°‘ä½¿ç”¨ï¼Œåªæœ‰åœ¨éå¸¸éœ€è¦ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ä¸”å¯ä»¥æ¥å—æ²¡æœ‰å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæ‰è€ƒè™‘è¯¥çº§åˆ«ã€‚ åœ¨ SERIALIZABLE çº§åˆ«ä¸‹å†è¿è¡Œä¸€ä¸‹ ä¸Šè¿°çš„demo å¯ä»¥çœ‹åˆ°æ­¥éª¤2çš„ insert è¢«é˜»å¡äº†ï¼Œä¸Šè¿°â€œå¹»è¯»â€çš„æƒ…å†µ MVCCMVCC æ˜¯ä»€ä¹ˆ MVVC (Multi-Version Concurrency Control, å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)ï¼Œåœ¨InnoDBå¼•æ“ä¸‹ï¼ŒMVCCæ˜¯ä¸ºäº†å®ç°äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œé€šè¿‡ç‰ˆæœ¬å·ï¼Œé¿å…åŒä¸€æ•°æ®åœ¨ä¸åŒäº‹åŠ¡é—´çš„ç«äº‰ï¼Œä½ å¯ä»¥æŠŠå®ƒå½“æˆåŸºäºå¤šç‰ˆæœ¬å·çš„ä¸€ç§ä¹è§‚é”ï¼Œè¯»ä¸åŠ é”ï¼Œè¯»å†™ä¸å†²çªMVCC å®ç°æœºåˆ¶ InnoDBåœ¨æ¯è¡Œæ•°æ®éƒ½å¢åŠ ä¸¤ä¸ªéšè—å­—æ®µï¼Œä¸€ä¸ªè®°å½•åˆ›å»ºçš„ç‰ˆæœ¬å·ï¼Œä¸€ä¸ªè®°å½•åˆ é™¤çš„ç‰ˆæœ¬å·ã€‚ åœ¨MVVC ä¸­ï¼Œä¸ºäº†ä¿è¯æ•°æ®æ“ä½œåœ¨å¤šçº¿ç¨‹è¿‡ç¨‹ä¸­ï¼Œä¿è¯äº‹åŠ¡éš”ç¦»çš„æœºåˆ¶ï¼Œé™ä½é”ç«äº‰çš„å‹åŠ›ï¼Œä¿è¯è¾ƒé«˜çš„å¹¶å‘é‡ã€‚åœ¨æ¯å¼€å¯ä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªäº‹åŠ¡çš„ç‰ˆæœ¬å·ï¼Œè¢«æ“ä½œçš„æ•°æ®ä¼šç”Ÿæˆä¸€æ¡æ–°çš„æ•°æ®è¡Œï¼ˆä¸´æ—¶ï¼‰ï¼Œä½†æ˜¯åœ¨æäº¤å‰å¯¹å…¶ä»–äº‹åŠ¡æ˜¯ä¸å¯è§çš„ï¼Œå¯¹äºæ•°æ®çš„æ›´æ–°ï¼ˆåŒ…æ‹¬å¢åˆ æ”¹ï¼‰æ“ä½œæˆåŠŸï¼Œä¼šå°†è¿™ä¸ªç‰ˆæœ¬å·æ›´æ–°åˆ°æ•°æ®çš„è¡Œä¸­ï¼Œäº‹åŠ¡æäº¤æˆåŠŸï¼Œå°†æ–°çš„ç‰ˆæœ¬å·æ›´æ–°åˆ°æ­¤æ•°æ®è¡Œä¸­ï¼Œè¿™æ ·ä¿è¯äº†æ¯ä¸ªäº‹åŠ¡æ“ä½œçš„æ•°æ®ï¼Œéƒ½æ˜¯äº’ä¸å½±å“çš„ï¼Œä¹Ÿä¸å­˜åœ¨é”çš„é—®é¢˜ã€‚ MVVCä¸‹çš„CRUD ï¼ˆREPEATABLE READä¸‹ï¼‰ SELECTï¼š InnoDB æŸ¥è¯¢çš„æ¯è¡Œæ•°æ®å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ç‚¹ 1ã€InnoDBå¿…é¡»æ‰¾åˆ°ä¸€ä¸ªè¡Œçš„ç‰ˆæœ¬ï¼Œå®ƒè‡³å°‘è¦å’Œäº‹åŠ¡çš„ç‰ˆæœ¬ä¸€æ ·è€(å³å®ƒçš„ç‰ˆæœ¬å·ä¸å¤§äºäº‹åŠ¡çš„ç‰ˆæœ¬å·)ã€‚è¿™ä¿è¯äº†ä¸ç®¡æ˜¯äº‹åŠ¡å¼€å§‹ä¹‹å‰ï¼Œæˆ–è€…äº‹åŠ¡åˆ›å»ºæ—¶ï¼Œæˆ–è€…ä¿®æ”¹äº†è¿™è¡Œæ•°æ®çš„æ—¶å€™ï¼Œè¿™è¡Œæ•°æ®æ˜¯å­˜åœ¨çš„ã€‚ 2ã€è¿™è¡Œæ•°æ®çš„åˆ é™¤ç‰ˆæœ¬å¿…é¡»æ˜¯æœªå®šä¹‰çš„æˆ–è€…æ¯”äº‹åŠ¡ç‰ˆæœ¬è¦å¤§ã€‚è¿™å¯ä»¥ä¿è¯åœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰è¿™è¡Œæ•°æ®æ²¡æœ‰è¢«åˆ é™¤ã€‚ç¬¦åˆè¿™ä¸¤ä¸ªæ¡ä»¶çš„è¡Œå¯èƒ½ä¼šè¢«å½“ä½œæŸ¥è¯¢ç»“æœè€Œè¿”å›ã€‚ INSERTï¼š InnoDBä¸ºè¿™ä¸ªæ–°è¡Œè®°å½•å½“å‰çš„ç³»ç»Ÿç‰ˆæœ¬å·ã€‚ DELETEï¼š InnoDBå°†å½“å‰çš„ç³»ç»Ÿç‰ˆæœ¬å·è®¾ç½®ä¸ºè¿™ä¸€è¡Œçš„åˆ é™¤IDã€‚ UPDATEï¼š InnoDBä¼šå†™ä¸€ä¸ªè¿™è¡Œæ•°æ®çš„æ–°æ‹·è´ï¼Œè¿™ä¸ªæ‹·è´çš„ç‰ˆæœ¬ä¸ºå½“å‰çš„ç³»ç»Ÿç‰ˆæœ¬å·ã€‚å®ƒåŒæ—¶ä¹Ÿä¼šå°†è¿™ä¸ªç‰ˆæœ¬å·å†™åˆ°æ—§è¡Œçš„åˆ é™¤ç‰ˆæœ¬é‡Œã€‚ å‚è€ƒ MySQLä¹‹MVVCç®€ä»‹ mysql å¹»è¯»çš„è¯¦è§£ã€å®ä¾‹åŠè§£å†³åŠæ³• ã€Šé«˜æ€§èƒ½MySQL ç¬¬ä¸‰ç‰ˆã€‹]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-10w+æ•°æ®-insert-ä¼˜åŒ–]]></title>
    <url>%2Fpost%2F5c987bd6.html</url>
    <content type="text"><![CDATA[ç”±äºä¸šåŠ¡åŸå› ï¼Œé‡åˆ°äº†å¦‚é¢˜æ‰€è¿°çš„ä¸šåŠ¡é—®é¢˜ï¼Œäº‹åŠ¡æ‰§è¡Œæ—¶é—´åœ¨30s~50s ä¸ç­‰ï¼Œæ•ˆæœéå¸¸ä¸ç†æƒ³ æ–¹æ¡ˆ1. jdbcæ‰¹å¤„ç†5w+ æ•°æ®æµ‹è¯•ï¼Œåˆ†åˆ«ä½¿ç”¨äº†mybatis insert()()ï¼ˆæ‹¼æ¥xmlï¼‰, mybatisçš„æ‰¹å¤„ç†å’Œ jdbcçš„æ‰¹å¤„ç†ã€‚å¯ä»¥çœ‹åˆ°åœ¨jdbcæ‰§è¡Œæ—¶é—´æ–¹é¢æ˜¯å·®ä¸å¤šçš„ï¼Œä½†æ˜¯åœ¨æ–¹æ³•æ‰§è¡Œæ—¶é—´ä¸Šï¼Œæ‰¹å¤„ç†è¦ç¨å¾®å¿«äº†ä¸€äº›ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸ç†æƒ³ æ–¹æ¡ˆ2. ä¼˜åŒ–MySQL å‚æ•°ä¿®æ”¹ my.ini innodb_buffer_pool_size : InnoDB, unlike MyISAM, uses a buffer pool to cache both indexes androw data. The bigger you set this the less disk I/O is needed toaccess data in tables. On a dedicated database server you may set thisparameter up to 80% of the machine physical memory size. Do not set ittoo large, though, because competition of the physical memory maycause paging in the operating system. Note that on 32bit systems youmight be limited to 2-3.5G of user level memory per process, so do notset it too high. Innodbçš„ç¼“å†²æ± ä¼šç¼“å­˜æ•°æ®å’Œç´¢å¼•ï¼Œè®¾ç½®çš„è¶Šå¤§è®¿é—®è¡¨ä¸­çš„æ•°æ®æ‰€éœ€çš„ç£ç›˜I/Oå°±è¶Šå°‘ã€‚ ä¿®æ”¹innodb_buffer_pool_size = 512Mæµ‹è¯•ä¸€ä¸‹æ•ˆç‡ï¼Œè¿™é€Ÿåº¦ç®€ç›´æ„Ÿäººï¼ innodb_log_buffer_size : The size of the buffer InnoDB uses for buffering log data. As soon asit is full, InnoDB will have to flush it to disk. As it is flushed once per second anyway, it does not make sense to have it very large(even with long transactions). è¡¨ç¤ºInnoDBå†™å…¥åˆ°ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶æ—¶ä½¿ç”¨çš„ç¼“å†²åŒºçš„å­—èŠ‚æ•°ï¼Œé»˜è®¤å€¼ä¸º8Mã€‚å½“ç¼“å†²åŒºå……æ»¡æ—¶ï¼ŒInnoDBå°†åˆ·æ–°æ•°æ®åˆ°ç£ç›˜ã€‚ç”±äºå®ƒæ¯ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œæ‰€ä»¥å°†å®ƒè®¾ç½®å¾—éå¸¸å¤§æ˜¯æ²¡æœ‰æ„ä¹‰çš„ (å³ä½¿æ˜¯é•¿äº‹åŠ¡)ã€‚ innodb_log_file_size : Size of each log file in a log group. You should set the combined sizeof log files to about 25%-100% of your buffer pool size to avoidunneeded buffer pool flush activity on log file overwrite. However,note that a larger logfile size will increase the time needed for therecovery process. è¯¥å€¼è¶Šå¤§ï¼Œç¼“å†²æ± ä¸­å¿…è¦çš„æ£€æŸ¥ç‚¹åˆ·æ–°æ´»åŠ¨å°±ä¼šè¶Šå°‘ï¼ŒèŠ‚çœç£ç›˜I/ Oã€‚ä½†æ˜¯è¶Šå¤§çš„æ—¥å¿—æ–‡ä»¶ï¼Œmysqlçš„å´©æºƒæ¢å¤å°±è¶Šæ…¢ è®¾ç½®ä¸Šè¿°ä¸¤ä¸ªå‚æ•°innodb_log_file_size=64M innodb_log_buffer_size=16Mï¼Œæ•ˆç‡æå‡çš„å¹¶ä¸æ˜æ˜¾ã€‚ æ€»ç»“ æ•°æ®é‡å¤§æ—¶ï¼Œæ‰¹å¤„ç†åœ¨æ–¹æ³•æ‰§è¡Œæ—¶é—´ä¸Šè¦æ¯” mybatis xmlæ‹¼æ¥å¿«ä¸€ç‚¹ ï¼ˆæ‰¹å¤„ç†åªç¼–è¯‘ä¸€æ¡SQLï¼Œè€Œæ‹¼æ¥çš„æ–¹å¼SQLä¼šå¾ˆé•¿ï¼‰ æ€§èƒ½ç“¶é¢ˆä¼˜åŒ–è¿˜æ˜¯è¦ä»æ•°æ®åº“ä¸‹æ‰‹ï¼Œç›®å‰æ¥çœ‹MySQL å¤§æ•°æ®é‡æ—¶å¾ˆä¾èµ– innodb_buffer_pool_size ï¼ˆç¼“å†²æ± ï¼‰å‚è€ƒ https://my.oschina.net/realfighter/blog/368225]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>ä¼˜åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaæ‰“åŒ…æˆexe åœ¨æ²¡æœ‰JREç¯å¢ƒçš„ç”µè„‘ä¸Šè¿è¡Œ]]></title>
    <url>%2Fpost%2F33eaa3e0.html</url>
    <content type="text"><![CDATA[å…¬å¸ä¸šåŠ¡éœ€æ±‚åŸå› ï¼Œéœ€è¦ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªæ¡Œé¢åº”ç”¨ç¨‹åºã€‚ç”±äºæ—¶é—´å…³ç³»ï¼Œæ²¡æœ‰è€ƒè™‘.netï¼Œä½¿ç”¨äº†æ±Ÿæ¹–ä¸Šå¤±ä¼ å·²ä¹…çš„Java Swing å‡†å¤‡å·¥ä½œ å°†ä½ çš„Javaé¡¹ç›®æ‰“åŒ…ä¸º å¯æ‰§è¡ŒJar ä½¿ç”¨ exe4j ç”Ÿæˆ.exe æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå°†ä½ çš„ JREï¼ˆä¸JDKåŒçº§åˆ«çš„é‚£ä¸ªJREï¼‰ï¼Œå¯æ‰§è¡Œjar éƒ½å¤åˆ¶è¿‡æ¥ï¼Œä¸‹å›¾é™¤çº¢åœˆä»¥å¤–çš„Jar ä¸ºé¡¹ç›®çš„ä¾èµ–Jar åŒ… æ‰“å¼€ exe4j ï¼ŒNext é€‰æ‹© JAR IN EXE é€‰æ‹©åˆšåˆšæˆ‘ä»¬æ–°å»ºçš„æ–‡ä»¶å¤¹ ï¼ˆåŒ…å«JREï¼Œå’Œé¡¹ç›®å¯æ‰§è¡ŒJARï¼‰ è¿™é‡Œæ˜¯è®¾ç½®æ–‡ä»¶åï¼Œå›¾æ ‡ï¼Œæ˜¯å¦ä»…å…è®¸ä¸€ä¸ªåº”ç”¨å®ä¾‹ç­‰ç­‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ64ä½çš„ jdkæ˜¯éœ€è¦è®¾ç½®ä¸€ä¸‹çš„ï¼Œå¦‚å›¾ è¿™é‡Œæ˜¯å°†é¡¹ç›®çš„ï¼Œå¯æ‰§è¡ŒJARï¼Œè¿˜æœ‰ä¾èµ–JAR å…¨éƒ¨æ·»åŠ è¿›æ¥ï¼Œæ³¨æ„ä¸€å®šè¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ŒMain class from é€‰æ‹©ä¸€ä¸ªé¡¹ç›®çš„å¯åŠ¨ç±»ã€‚ è®¾ç½® Search sequence æ¸…é™¤é»˜è®¤é…ç½®ï¼Œè®¾ç½®JREï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„ åå‡ æ­¥é»˜è®¤é…ç½®ï¼Œä¸‹ä¸€æ­¥å³å¯ã€‚ å¤‡æ³¨ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJARå’ŒJRE ä¸€å®šè¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„æ— æ³•ä¿è¯ä½ çš„è·¯å¾„å’Œç”¨æˆ·ç”µè„‘ä¸€è‡´ï¼‰ exe4jï¼Œæ²¡æœ‰æ¿€æ´»ä¹‹å‰ç”Ÿæˆçš„exeï¼Œå¯åŠ¨ä¹‹å‰ä¼šè·³ä¸ªå¯¹è¯æ¡†ï¼Œæ¿€æ´»å³å¯ ç”Ÿæˆçš„exe ä¸ä¾èµ–ä¹‹å‰çš„JARï¼Œåªä¾èµ–JRE å‚è€ƒï¼šhttps://www.cnblogs.com/lsy-blogs/p/7668425.html]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>swing</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨Spring Cache + Redis ä½œä¸ºç¼“å­˜]]></title>
    <url>%2Fpost%2Fef257646.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ spring-cacheï¼Œä»¥åŠé›†æˆ Redis ä½œä¸ºç¼“å­˜å®ç°ã€‚è¡¨æ ¼è¿‡é•¿ï¼Œæ¨èè¯»è€…ä½¿ç”¨ç”µè„‘é˜…è¯» å‡†å¤‡å·¥ä½œRedis windows å®‰è£… å¦‚ä½•é…ç½®mavenå®Œæ•´ä¾èµ–è¯¦è§ ==&gt; Gitee123456789101112131415161718&lt;!-- ä½¿ç”¨spring cache --&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;&lt;/dependency&gt;&lt;!-- redis --&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;&lt;/dependency&gt;&lt;!-- ä¸ºäº†è§£å†³ ClassNotFoundException: org.apache.commons.poolimpl.GenericObjectPoolConfig --&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.commons&lt;/groupId&gt; &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt; &lt;version&gt;0&lt;/version&gt;&lt;/dependency&gt; application.properties1234567891011121314151617181920212223# Redisæ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰spring.redis.database=0 # RedisæœåŠ¡å™¨åœ°å€spring.redis.host=localhost# RedisæœåŠ¡å™¨è¿æ¥ç«¯å£spring.redis.port=6379 # RedisæœåŠ¡å™¨è¿æ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰#spring.redis.password=yourpwd# è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰spring.redis.lettuce.pool.max-active=8 # è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ spring.redis.lettuce.pool.max-wait=-1ms# è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥spring.redis.lettuce.pool.max-idle=8 # è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥spring.redis.lettuce.pool.min-idle=0 # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰spring.redis.timeout=5000ms#é…ç½®ç¼“å­˜ç›¸å…³cache.default.expire-time=200cache.user.expire-time=180cache.user.name=test @EnableCachingæ ‡è®°æ³¨è§£ @EnableCachingï¼Œå¼€å¯ç¼“å­˜ï¼Œå¹¶é…ç½®Redisç¼“å­˜ç®¡ç†å™¨ï¼Œéœ€è¦åˆå§‹åŒ–ä¸€ä¸ªç¼“å­˜ç©ºé—´ã€‚åœ¨ç¼“å­˜çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦æ ‡è®°ä½¿ç”¨å“ªä¸€ä¸ªç¼“å­˜ç©ºé—´123456789101112131415161718192021222324252627282930313233343536373839404142434445@Configuration@EnableCachingpublic class RedisConfig &#123; @Value("$&#123;cache.default.expire-time&#125;") private int defaultExpireTime; @Value("$&#123;cache.user.expire-time&#125;") private int userCacheExpireTime; @Value("$&#123;cache.user.name&#125;") private String userCacheName; /** * ç¼“å­˜ç®¡ç†å™¨ * * @param lettuceConnectionFactory * @return */ @Bean public CacheManager cacheManager(RedisConnectionFactory lettuceConnectionFactory) &#123; RedisCacheConfiguration defaultCacheConfig = RedisCacheConfiguration.defaultCacheConfig(); // è®¾ç½®ç¼“å­˜ç®¡ç†å™¨ç®¡ç†çš„ç¼“å­˜çš„é»˜è®¤è¿‡æœŸæ—¶é—´ defaultCacheConfig = defaultCacheConfig.entryTtl(Duration.ofSeconds(defaultExpireTime)) // è®¾ç½® keyä¸ºstringåºåˆ—åŒ– .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer())) // è®¾ç½®valueä¸ºjsonåºåˆ—åŒ– .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer())) // ä¸ç¼“å­˜ç©ºå€¼ .disableCachingNullValues(); Set&lt;String&gt; cacheNames = new HashSet&lt;&gt;(); cacheNames.add(userCacheName); // å¯¹æ¯ä¸ªç¼“å­˜ç©ºé—´åº”ç”¨ä¸åŒçš„é…ç½® Map&lt;String, RedisCacheConfiguration&gt; configMap = new HashMap&lt;&gt;(); configMap.put(userCacheName, defaultCacheConfig.entryTtl(Duration.ofSeconds(userCacheExpireTime))); RedisCacheManager cacheManager = RedisCacheManager.builder(lettuceConnectionFactory) .cacheDefaults(defaultCacheConfig) .initialCacheNames(cacheNames) .withInitialCacheConfigurations(configMap) .build(); return cacheManager; &#125;&#125; åˆ°æ­¤é…ç½®å·¥ä½œå·²ç»ç»“æŸäº† Spring Cache ä½¿ç”¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748@Service@CacheConfig(cacheNames="user")// cacheName æ˜¯ä¸€å®šè¦æŒ‡å®šçš„å±æ€§ï¼Œå¯ä»¥é€šè¿‡ @CacheConfig å£°æ˜è¯¥ç±»çš„é€šç”¨é…ç½®public class UserService &#123; /** * å°†ç»“æœç¼“å­˜ï¼Œå½“å‚æ•°ç›¸åŒæ—¶ï¼Œä¸ä¼šæ‰§è¡Œæ–¹æ³•ï¼Œä»ç¼“å­˜ä¸­å– * * @param id * @return */ @Cacheable(key = "#id") public User findUserById(Integer id) &#123; System.out.println("===&gt; findUserById(id), id = " + id); return new User(id, "taven"); &#125; /** * å°†ç»“æœç¼“å­˜ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•ä¸ç®¡ç¼“å­˜æ˜¯å¦å­˜åœ¨ï¼Œæ¯æ¬¡éƒ½ä¼šæ‰§è¡Œ * * @param user * @return */ @CachePut(key = "#user.id") public User update(User user) &#123; System.out.println("===&gt; update(user), user = " + user); return user; &#125; /** * ç§»é™¤ç¼“å­˜ï¼Œæ ¹æ®æŒ‡å®škey * * @param user */ @CacheEvict(key = "#user.id") public void deleteById(User user) &#123; System.out.println("===&gt; deleteById(), user = " + user); &#125; /** * ç§»é™¤å½“å‰ cacheNameä¸‹æ‰€æœ‰ç¼“å­˜ * */ @CacheEvict(allEntries = true) public void deleteAll() &#123; System.out.println("===&gt; deleteAll()"); &#125;&#125; æ³¨è§£ ä½œç”¨ @Cacheable | å°†æ–¹æ³•çš„ç»“æœç¼“å­˜èµ·æ¥ï¼Œä¸‹ä¸€æ¬¡æ–¹æ³•æ‰§è¡Œå‚æ•°ç›¸åŒæ—¶ï¼Œå°†ä¸æ‰§è¡Œæ–¹æ³•ï¼Œè¿”å›ç¼“å­˜ä¸­çš„ç»“æœ@CacheEvict | ç§»é™¤æŒ‡å®šç¼“å­˜@CachePut | æ ‡è®°è¯¥æ³¨è§£çš„æ–¹æ³•æ€»ä¼šæ‰§è¡Œï¼Œæ ¹æ®æ³¨è§£çš„é…ç½®å°†ç»“æœç¼“å­˜@Caching | å¯ä»¥æŒ‡å®šç›¸åŒç±»å‹çš„å¤šä¸ªç¼“å­˜æ³¨è§£ï¼Œä¾‹å¦‚æ ¹æ®ä¸åŒçš„æ¡ä»¶@CacheConfig | ç±»çº§åˆ«æ³¨è§£ï¼Œå¯ä»¥è®¾ç½®ä¸€äº›å…±é€šçš„é…ç½®ï¼Œ@CacheConfig(cacheNames=&quot;user&quot;), ä»£è¡¨è¯¥ç±»ä¸‹çš„æ–¹æ³•å‡ä½¿ç”¨è¿™ä¸ªcacheNames ä¸‹é¢è¯¦ç»†è®²ä¸€ä¸‹æ¯ä¸ªæ³¨è§£çš„ä½œç”¨å’Œå¯é€‰é¡¹ã€‚ Spring Cache æ³¨è§£@EnableCaching åšäº†ä»€ä¹ˆ @EnableCaching æ³¨é‡Šè§¦å‘åç½®å¤„ç†å™¨, æ£€æŸ¥æ¯ä¸€ä¸ªSpring bean çš„ public æ–¹æ³•æ˜¯å¦å­˜åœ¨ç¼“å­˜æ³¨è§£ã€‚å¦‚æœæ‰¾åˆ°è¿™æ ·çš„ä¸€ä¸ªæ³¨é‡Š, è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä»£ç†æ‹¦æˆªæ–¹æ³•è°ƒç”¨å’Œå¤„ç†ç›¸åº”çš„ç¼“å­˜è¡Œä¸ºã€‚ å¸¸ç”¨ç¼“å­˜æ³¨è§£ç®€è¿°@Cacheableå°†æ–¹æ³•çš„ç»“æœç¼“å­˜ï¼Œå¿…é¡»è¦æŒ‡å®šä¸€ä¸ª cacheNameï¼ˆç¼“å­˜ç©ºé—´ï¼‰12@Cacheable(&quot;books&quot;)public Book findBook(ISBN isbn) &#123;...&#125; é»˜è®¤ cache keyç¼“å­˜çš„æœ¬è´¨è¿˜æ˜¯ä»¥ key-value çš„å½¢å¼å­˜å‚¨çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹æˆ‘ä»¬ä¸æŒ‡å®škeyçš„æ—¶å€™ ï¼Œä½¿ç”¨ SimpleKeyGenerator ä½œä¸ºkeyçš„ç”Ÿæˆç­–ç•¥ å¦‚æœæ²¡æœ‰ç»™å‡ºå‚æ•°ï¼Œåˆ™è¿”å›SimpleKey.EMPTYã€‚ å¦‚æœåªç»™å‡ºä¸€ä¸ªParamï¼Œåˆ™è¿”å›è¯¥å®ä¾‹ã€‚ å¦‚æœç»™å‡ºäº†æ›´å¤šçš„Paramï¼Œåˆ™è¿”å›åŒ…å«æ‰€æœ‰å‚æ•°çš„SimpleKeyã€‚ æ³¨æ„ï¼šå½“ä½¿ç”¨é»˜è®¤ç­–ç•¥æ—¶ï¼Œæˆ‘ä»¬çš„å‚æ•°éœ€è¦æœ‰ æœ‰æ•ˆçš„hashCode()å’Œequals()æ–¹æ³• è‡ªå®šä¹‰ cache key12345678@Cacheable(cacheNames=&quot;books&quot;, key=&quot;#isbn&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed)@Cacheable(cacheNames=&quot;books&quot;, key=&quot;#isbn.rawNumber&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed)@Cacheable(cacheNames=&quot;books&quot;, key=&quot;T(someType).hash(#isbn)&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed) å¦‚ä¸Šï¼Œé…åˆSpring EL ä½¿ç”¨ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç» Spring EL å¯¹ Cache çš„æ”¯æŒ æŒ‡å®šå¯¹è±¡ æŒ‡å®šå¯¹è±¡ä¸­çš„å±æ€§ æŸä¸ªç±»çš„æŸä¸ªé™æ€æ–¹æ³• è‡ªå®šä¹‰ keyGenerator12@Cacheable(cacheNames=&quot;books&quot;, keyGenerator=&quot;myKeyGenerator&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed) å®ç° KeyGeneratoræ¥å£å¯ä»¥è‡ªå®šä¹‰ cache key çš„ç”Ÿæˆç­–ç•¥ è‡ªå®šä¹‰ cacheManager12@Cacheable(cacheNames=&quot;books&quot;, cacheManager=&quot;anotherCacheManager&quot;) public Book findBook(ISBN isbn) &#123;...&#125; å½“æˆ‘ä»¬çš„é¡¹ç›®åŒ…å«å¤šä¸ªç¼“å­˜ç®¡ç†å™¨æ—¶ï¼Œå¯ä»¥æŒ‡å®šå…·ä½“çš„ç¼“å­˜ç®¡ç†å™¨ï¼Œä½œä¸ºç¼“å­˜è§£æ åŒæ­¥ç¼“å­˜åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°ç›¸åŒçš„å‚æ•°çš„è¯·æ±‚å¹¶å‘è°ƒç”¨æ–¹æ³•çš„æ“ä½œï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œspring cache ä¸ä¼šé”å®šä»»ä½•ä¸œè¥¿ï¼Œç›¸åŒçš„å€¼å¯èƒ½ä¼šè¢«è®¡ç®—å‡ æ¬¡ï¼Œè¿™å°±è¿èƒŒäº†ç¼“å­˜çš„ç›®çš„ å¯¹äºè¿™äº›ç‰¹æ®Šæƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨syncå±æ€§ã€‚æ­¤æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å¤„äºè®¡ç®—ï¼Œè€Œå…¶ä»–çº¿ç¨‹åˆ™è¢«é˜»å¡ï¼Œç›´åˆ°åœ¨ç¼“å­˜ä¸­æ›´æ–°æ¡ç›®ä¸ºæ­¢ã€‚12@Cacheable(cacheNames=&quot;foos&quot;, sync=true) public Foo executeExpensiveOperation(String id) &#123;...&#125; æ¡ä»¶ç¼“å­˜ condition: ä»€ä¹ˆæƒ…å†µç¼“å­˜ï¼Œcondition = true æ—¶ç¼“å­˜ï¼Œåä¹‹ä¸ç¼“å­˜ unless: ä»€ä¹ˆæƒ…å†µä¸ç¼“å­˜ï¼Œunless = true æ—¶ä¸ç¼“å­˜ï¼Œåä¹‹ç¼“å­˜12345@Cacheable(cacheNames=&quot;book&quot;, condition=&quot;#name.length() &lt; 32&quot;) public Book findBook(String name)@Cacheable(cacheNames=&quot;book&quot;, condition=&quot;#name.length() &lt; 32&quot;, unless=&quot;#result?.hardback&quot;)public Optional&lt;Book&gt; findBook(String name) Spring EL å¯¹ Cache çš„æ”¯æŒ Name Location Description Example methodName Root object è¢«è°ƒç”¨çš„æ–¹æ³•çš„åç§° #root.methodName method Root object è¢«è°ƒç”¨çš„æ–¹æ³• #root.method.name target Root object å½“å‰è°ƒç”¨æ–¹æ³•çš„å¯¹è±¡ #root.target targetClass Root object å½“å‰è°ƒç”¨æ–¹æ³•çš„ç±» #root.targetClass args Root object å½“å‰æ–¹æ³•çš„å‚æ•° #root.args[0] caches Root object å½“å‰æ–¹æ³•çš„ç¼“å­˜é›†åˆ #root.caches[0].name Argument name Evaluation context å½“å‰æ–¹æ³•çš„å‚æ•°åç§° #iban or #a0 (you can also use #p0 or #p&lt;#arg&gt; notation as an alias). result Evaluation context æ–¹æ³•è¿”å›çš„ç»“æœ(è¦ç¼“å­˜çš„å€¼)ã€‚åªæœ‰åœ¨ unless ã€@CachePut(ç”¨äºè®¡ç®—é”®)æˆ–@CacheEvict(beforeInvocation=false)ä¸­æ‰å¯ç”¨.å¯¹äºæ”¯æŒçš„åŒ…è£…å™¨(ä¾‹å¦‚Optional)ï¼Œ#resultå¼•ç”¨çš„æ˜¯å®é™…å¯¹è±¡ï¼Œè€Œä¸æ˜¯åŒ…è£…å™¨ #result @CachePutè¿™ä¸ªæ³¨è§£å’Œ @Cacheable æœ‰ç‚¹ç±»ä¼¼ï¼Œéƒ½ä¼šå°†ç»“æœç¼“å­˜ï¼Œä½†æ˜¯æ ‡è®° @CachePut çš„æ–¹æ³•æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œï¼Œç›®çš„åœ¨äºæ›´æ–°ç¼“å­˜ï¼Œæ‰€ä»¥ä¸¤ä¸ªæ³¨è§£çš„ä½¿ç”¨åœºæ™¯å®Œå…¨ä¸åŒã€‚@Cacheable æ”¯æŒçš„æ‰€æœ‰é…ç½®é€‰é¡¹ï¼ŒåŒæ ·é€‚ç”¨äº@CachePut 12@CachePut(cacheNames=&quot;book&quot;, key=&quot;#isbn&quot;)public Book updateBook(ISBN isbn, BookDescriptor descriptor) éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸è¦åœ¨ä¸€ä¸ªæ–¹æ³•ä¸ŠåŒæ—¶ä½¿ç”¨@Cacheable å’Œ @CachePut @CacheEvictç”¨äºç§»é™¤ç¼“å­˜ å¯ä»¥ç§»é™¤æŒ‡å®škey å£°æ˜ allEntries=trueç§»é™¤è¯¥CacheNameä¸‹æ‰€æœ‰ç¼“å­˜ å£°æ˜beforeInvocation=true åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æ¸…é™¤ç¼“å­˜ï¼Œæ— è®ºæ–¹æ³•æ‰§è¡Œæ˜¯å¦æˆåŠŸ12345@CacheEvict(cacheNames=&quot;book&quot;, key=&quot;#isbn&quot;)public Book updateBook(ISBN isbn, BookDescriptor descriptor)@CacheEvict(cacheNames=&quot;books&quot;, allEntries=true) public void loadBooks(InputStream batch) @Cachingå¯ä»¥è®©ä½ åœ¨ä¸€ä¸ªæ–¹æ³•ä¸ŠåµŒå¥—å¤šä¸ªç›¸åŒçš„Cache æ³¨è§£ï¼ˆ@Cacheable, @CachePut, @CacheEvictï¼‰ï¼Œåˆ†åˆ«æŒ‡å®šä¸åŒçš„æ¡ä»¶12@Caching(evict = &#123; @CacheEvict(&quot;primary&quot;), @CacheEvict(cacheNames=&quot;secondary&quot;, key=&quot;#p0&quot;) &#125;)public Book importBooks(String deposit, Date date) @CacheConfigç±»çº§åˆ«æ³¨è§£ï¼Œç”¨äºé…ç½®ä¸€äº›å…±åŒçš„é€‰é¡¹ï¼ˆå½“æ–¹æ³•æ³¨è§£å£°æ˜çš„æ—¶å€™ä¼šè¢«è¦†ç›–ï¼‰ï¼Œä¾‹å¦‚ CacheNameã€‚ æ”¯æŒçš„é€‰é¡¹å¦‚ä¸‹ï¼š123456789101112@Target(&#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface CacheConfig &#123; String[] cacheNames() default &#123;&#125;; String keyGenerator() default &quot;&quot;; String cacheManager() default &quot;&quot;; String cacheResolver() default &quot;&quot;;&#125; å‚è€ƒï¼š https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#cache-annotations-cacheable https://spring.io/guides/gs/caching/ æœ¬æ–‡demoï¼š https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-redis]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>SpringBoot</tag>
        <tag>Cache</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ã€ŠShiro ä¸€ã€‹SpringBoot+Shiro æ„å»ºWebå·¥ç¨‹]]></title>
    <url>%2Fpost%2F9d0d6a3a.html</url>
    <content type="text"><![CDATA[Shiro ä¸€æ¬¾ç®€å•æ˜“ç”¨ï¼ŒåŠŸèƒ½å¼ºå¤§çš„å®‰å…¨æ¡†æ¶ï¼Œå¸®åŠ©æˆ‘ä»¬å®‰å…¨é«˜æ•ˆçš„æ„å»ºä¼ä¸šçº§åº”ç”¨ã€‚ä¹‹å‰å‡ ä¸ªé¡¹ç›®éƒ½ç”¨åˆ°è¿‡ Shiroï¼Œæœ€è¿‘æŠ½ç©ºæ¢³ç†äº†ä¸€ä¸‹ï¼Œåˆ†äº«ä¸€äº›ç»éªŒã€‚ æœ¬æ–‡demoï¼šæˆ³è¿™é‡Œæœ¬æ–‡demoé€‰å‹ï¼šthymeleaf, springboot 2, shiro, ehcachePS:å¦‚æœæˆ‘ä¸æ‹–å»¶çš„è¯ï¼Œä¼°è®¡è¿˜æ˜¯ä¼šæœ‰åç»­çš„ :ï¼‰ Shiro èƒ½åšä»€ä¹ˆ è®¤è¯ï¼šç™»å½•ç”¨æˆ·çš„è®¤è¯ æƒé™ï¼šåŸºäºè§’è‰²å’Œæƒé™çš„è®¿é—®æƒé™ï¼ˆurlæƒé™ï¼‰ï¼Œä»¥åŠé¢—ç²’åŒ–æƒé™æ§åˆ¶ï¼ˆæŒ‰é’®æƒé™ï¼‰ åŠ å¯†æŠ€æœ¯ï¼šShiroçš„cryptoåŒ…ä¸­åŒ…å«äº†ä¸€ç³»åˆ—çš„æ˜“äºç†è§£å’Œä½¿ç”¨çš„åŠ å¯†ã€å“ˆå¸Œï¼ˆakaæ‘˜è¦ï¼‰è¾…åŠ©ç±» sessionç®¡ç†ï¼šå¯åœ¨webå®¹å™¨ä»¥åŠ EJBå®¹å™¨ä¸­ä½¿ç”¨ sessionï¼Œå¯æ‰©å±• ï¼ˆä¾‹å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™ sessionDao å°† session å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼‰ RememberMeï¼šåŸºäºcookieçš„è®°ä½æˆ‘æœåŠ¡ Shiro å¸¸ç”¨ç»„ä»¶ä»‹ç» Subjectï¼šSubjectå…¶å®ä»£è¡¨çš„å°±æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œæ“ä½œçš„ç”¨æˆ·ï¼Œåªä¸è¿‡å› ä¸ºâ€œUserâ€ä¸€èˆ¬æŒ‡ä»£äººï¼Œä½†æ˜¯ä¸€ä¸ªâ€œSubjectâ€å¯ä»¥æ˜¯äººï¼Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•çš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼ŒæœåŠ¡è´¦å·ç­‰ä»»ä½•å…¶ä»–æ­£åœ¨å’Œå½“å‰ç³»ç»Ÿäº¤äº’çš„ç¬¬ä¸‰æ–¹è½¯ä»¶ç³»ç»Ÿã€‚ æ‰€æœ‰çš„Subjectå®ä¾‹éƒ½è¢«ç»‘å®šåˆ°ä¸€ä¸ªSecurityManagerï¼Œå¦‚æœä½ å’Œä¸€ä¸ªSubjectäº¤äº’ï¼Œæ‰€æœ‰çš„äº¤äº’åŠ¨ä½œéƒ½ä¼šè¢«è½¬æ¢æˆSubjectä¸SecurityManagerçš„äº¤äº’ SecurityManagerï¼šShiroçš„æ ¸å¿ƒï¼Œä»–ä¸»è¦ç”¨äºåè°ƒShiroå†…éƒ¨å„ç§å®‰å…¨ç»„ä»¶ï¼Œä¸è¿‡æˆ‘ä»¬ä¸€èˆ¬ä¸ç”¨å¤ªå…³å¿ƒSecurityManagerï¼Œå¯¹äºåº”ç”¨ç¨‹åºå¼€å‘è€…æ¥è¯´ï¼Œä¸»è¦è¿˜æ˜¯ä½¿ç”¨Subjectçš„APIæ¥å¤„ç†å„ç§å®‰å…¨éªŒè¯é€»è¾‘ Realmï¼šè¿™æ˜¯ç”¨äºè¿æ¥Shiroå’Œå®¢æˆ·ç³»ç»Ÿçš„ç”¨æˆ·æ•°æ®çš„æ¡¥æ¢ã€‚ä¸€æ—¦ShiroçœŸæ­£éœ€è¦è®¿é—®å„ç§å®‰å…¨ç›¸å…³çš„æ•°æ®ï¼ˆæ¯”å¦‚ä½¿ç”¨ç”¨æˆ·è´¦æˆ·æ¥åšç”¨æˆ·èº«ä»½éªŒè¯ä»¥åŠæƒé™éªŒè¯ï¼‰æ—¶ï¼Œä»–æ€»æ˜¯é€šè¿‡è°ƒç”¨ç³»ç»Ÿé…ç½®çš„å„ç§Realmæ¥è¯»å–æ•°æ® å…³äºShiro çš„å…¶ä½™æ ¸å¿ƒç»„ä»¶å‚è€ƒ Shiro å®˜ç½‘ æˆ–è€… Shiroçš„æ¶æ„ æœ¬æ–‡ä¸åšè¿‡å¤šçš„é˜è¿° Shiro æ˜¯å¦‚ä½•å·¥ä½œçš„ç®€å•æ¥è®²çš„è¯ï¼Œåœ¨Springé¡¹ç›®ä¸­ Shiro ä¼šå°†ä»–çš„æ‰€æœ‰ç»„ä»¶æ³¨å†Œåˆ° SecurityManagerä¸­ å†é€šè¿‡å°† SecurityManager æ³¨å†Œåˆ° ShiroFilterFactoryBeanï¼ˆè¿™ä¸ªç±»å®ç°äº†Spring çš„BeanPostProcessorä¼šé¢„å…ˆåŠ è½½ï¼‰ ä¸­ï¼Œ æœ€åä»¥ filter çš„å½¢å¼æ³¨å†Œåˆ°Springå®¹å™¨ï¼ˆå®ç°äº†Springçš„FactoryBeanï¼Œæ„é€ ä¸€ä¸ª filter æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ï¼‰ï¼Œå®ç°ç”¨æˆ·æƒé™çš„ç®¡ç†ã€‚ Shiro å¦‚ä½•é›†æˆ shiro æ‰€éœ€ä¾èµ–ï¼Œå®Œæ•´è§demoæºç  12345678910111213141516171819202122&lt;!--shiro--&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt; &lt;artifactId&gt;shiro-core&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt; &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt; &lt;artifactId&gt;shiro-ehcache&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt;&lt;/dependency&gt;&lt;!-- åŸºäºthymeleafçš„shiroæ‰©å±• --&gt;&lt;dependency&gt; &lt;groupId&gt;com.github.theborakompanioni&lt;/groupId&gt; &lt;artifactId&gt;thymeleaf-extras-shiro&lt;/artifactId&gt; &lt;version&gt;2.0.0&lt;/version&gt;&lt;/dependency&gt; ShiroConfig 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117@Configurationpublic class ShiroConfig &#123; private static final Logger log = LoggerFactory.getLogger(ShiroConfig.class); @Bean public ShiroFilterFactoryBean shiroFilterFactoryBean(DefaultWebSecurityManager securityManager) &#123; ShiroFilterFactoryBean shiroFilter = new ShiroFilterFactoryBean(); shiroFilter.setSecurityManager(securityManager); Map&lt;String, String&gt; chainDefinition = new LinkedHashMap&lt;&gt;(); // é™æ€èµ„æºä¸ç™»å½•è¯·æ±‚ä¸æ‹¦æˆª chainDefinition.put("/js/**", "anon"); chainDefinition.put("/css/**", "anon"); chainDefinition.put("/img/**", "anon"); chainDefinition.put("/layui/**", "anon"); chainDefinition.put("/login", "anon"); chainDefinition.put("/login.html", "anon"); // ç”¨æˆ·ä¸ºæˆæƒé€šè¿‡è®¤è¯ &amp;&amp; åŒ…å«'admin'è§’è‰² chainDefinition.put("/admin/**", "authc, roles[super_admin]"); // ç”¨æˆ·ä¸ºæˆæƒé€šè¿‡è®¤è¯æˆ–è€…RememberMe &amp;&amp; åŒ…å«'document:read'æƒé™ chainDefinition.put("/docs/**", "user, perms[document:read]"); // ç”¨æˆ·è®¿é—®æ‰€æœ‰è¯·æ±‚ æˆæƒé€šè¿‡ || RememberMe chainDefinition.put("/**", "user"); shiroFilter.setFilterChainDefinitionMap(chainDefinition); // å½“ ç”¨æˆ·èº«ä»½å¤±æ•ˆæ—¶é‡å®šå‘åˆ° loginUrl shiroFilter.setLoginUrl("/login.html"); // ç”¨æˆ·ç™»å½•åé»˜è®¤é‡å®šå‘è¯·æ±‚ shiroFilter.setSuccessUrl("/index.html"); return shiroFilter; &#125; @Bean public Realm realm() &#123; ShiroRealm realm = new ShiroRealm(); realm.setCredentialsMatcher(credentialsMatcher()); realm.setCacheManager(ehCacheManager()); return realm; &#125; @Bean public CacheManager ehCacheManager() &#123; EhCacheManager cacheManager = new EhCacheManager(); cacheManager.setCacheManagerConfigFile("classpath:ehcache.xml"); return cacheManager; &#125; @Bean public CredentialsMatcher credentialsMatcher() &#123; AuthCredentialsMatcher credentialsMatcher = new AuthCredentialsMatcher(ehCacheManager()); credentialsMatcher.setHashAlgorithmName(AuthCredentialsMatcher.HASH_ALGORITHM_NAME); credentialsMatcher.setHashIterations(AuthCredentialsMatcher.HASH_ITERATIONS); credentialsMatcher.setStoredCredentialsHexEncoded(true); return credentialsMatcher; &#125; @Bean public DefaultWebSecurityManager securityManager() &#123; log.debug("--------------shiroå·²ç»åŠ è½½----------------"); DefaultWebSecurityManager manager = new DefaultWebSecurityManager(); manager.setCacheManager(ehCacheManager()); manager.setRealm(realm()); manager.setRememberMeManager(rememberMeManager()); return manager; &#125; @Bean public RememberMeManager rememberMeManager() &#123; CookieRememberMeManager cookieRememberMeManager = new CookieRememberMeManager(); //rememberMe cookieåŠ å¯†çš„å¯†é’¥ å»ºè®®æ¯ä¸ªé¡¹ç›®éƒ½ä¸ä¸€æ · é»˜è®¤AESç®—æ³• å¯†é’¥é•¿åº¦(128 256 512 ä½) cookieRememberMeManager.setCipherKey(Base64.decode("2AvVhdsgUs0FSA3SDFAdag==")); cookieRememberMeManager.setCookie(rememberMeCookie()); return cookieRememberMeManager; &#125; @Bean public SimpleCookie rememberMeCookie()&#123; //è¿™ä¸ªå‚æ•°æ˜¯cookieçš„åç§°ï¼Œå¯¹åº”å‰ç«¯çš„checkboxçš„name = rememberMe SimpleCookie simpleCookie = new SimpleCookie("rememberMe"); //&lt;!-- è®°ä½æˆ‘cookieç”Ÿæ•ˆæ—¶é—´30å¤© ,å•ä½ç§’;--&gt; simpleCookie.setMaxAge(259200); return simpleCookie; &#125; /** * Shiroç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨: * ç”¨äºåœ¨å®ç°äº†Initializableæ¥å£çš„Shiro beanåˆå§‹åŒ–æ—¶è°ƒç”¨Initializableæ¥å£å›è°ƒ(ä¾‹å¦‚:UserRealm) * åœ¨å®ç°äº†Destroyableæ¥å£çš„Shiro beané”€æ¯æ—¶è°ƒç”¨ Destroyableæ¥å£å›è°ƒ(ä¾‹å¦‚:DefaultSecurityManager) */ @Bean public LifecycleBeanPostProcessor lifecycleBeanPostProcessor() &#123; return new LifecycleBeanPostProcessor(); &#125; /** * å¯ç”¨shrioæˆæƒæ³¨è§£æ‹¦æˆªæ–¹å¼ï¼ŒAOPå¼æ–¹æ³•çº§æƒé™æ£€æŸ¥ */ @Bean public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(DefaultWebSecurityManager securityManager) &#123; AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = new AuthorizationAttributeSourceAdvisor(); authorizationAttributeSourceAdvisor.setSecurityManager(securityManager); return authorizationAttributeSourceAdvisor; &#125; /** * thymeleafçš„shiroæ‰©å±• * * @return */ @Bean public ShiroDialect shiroDialect() &#123; return new ShiroDialect(); &#125;&#125; ä»¥ä¸ŠåŸºæœ¬æ˜¯Springé¡¹ç›®é›†æˆ Shiro çš„é€šç”¨é…ç½®ï¼Œä¸‹é¢é’ˆå¯¹ä¸Šè¿°çš„å‡ ä¸ªBean èŠä¸€èŠ1. ShiroFilterFactoryBeanï¼šç”¨äºå®šä¹‰ è¯·æ±‚çš„æ‹¦æˆªè§„åˆ™, Shiroä¸ºæˆ‘ä»¬é»˜è®¤æä¾›äº†ä¸€äº›é€‰é¡¹ï¼Œå¸¸ç”¨å¦‚ä¸‹ anon: è¯·æ±‚ä¸æ‹¦æˆª authc: è¦æ±‚ç”¨æˆ·å¿…é¡»è®¤è¯é€šè¿‡ user: è¦æ±‚ç”¨æˆ·ä¸ºè®°ä½æˆ‘çŠ¶æ€ roles[xxx]: è¦æ±‚ç”¨æˆ·å¿…é¡»æ»¡è¶³ xxx è§’è‰² perms[xxx]: è¦æ±‚ç”¨æˆ·å¿…é¡»æ»¡è¶³ xxx æƒé™å…¶å®ä¸Šè¿°æ¯ä¸€ä¸ªéƒ½å¯¹åº”äº†ä¸€ä¸ª Shiro è¿‡æ»¤å™¨ Filter Name Class anon org.apache.shiro.web.filter.authc.AnonymousFilter authc org.apache.shiro.web.filter.authc.FormAuthenticationFilter authcBasic org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter logout org.apache.shiro.web.filter.authc.LogoutFilter noSessionCreation org.apache.shiro.web.filter.session.NoSessionCreationFilter perms | org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilterport| org.apache.shiro.web.filter.authz.PortFilterrest| org.apache.shiro.web.filter.authz.HttpMethodPermissionFilterroles| org.apache.shiro.web.filter.authz.RolesAuthorizationFilterssl| org.apache.shiro.web.filter.authz.SslFilteruser| org.apache.shiro.web.filter.authc.UserFilter æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ è¿‡æ»¤å™¨æ¥å®ç°æ‹¦æˆª 2. Realmï¼šä¸Šé¢æåˆ°è¿‡Realmæ˜¯ç”¨äºè¿æ¥Shiroå’Œå®¢æˆ·ç³»ç»Ÿçš„ç”¨æˆ·æ•°æ®çš„æ¡¥æ¢, æˆ‘ä»¬é€šè¿‡å®ç°AuthorizingRealm æ¥æä¾›ç”¨æˆ·è®¤è¯å’Œæˆæƒä¸¤ä¸ªAPI 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778public class ShiroRealm extends AuthorizingRealm &#123; private static final Logger log = LoggerFactory.getLogger(AuthorizingRealm.class); @Autowired @Lazy // è¿™é‡Œlazy æ˜¯æœ‰å¿…è¦çš„, shiroç»„ä»¶ä¼šé¢„å…ˆåŠ è½½ï¼Œå¯¼è‡´ä¾èµ–çš„bean æ²¡æœ‰ç”Ÿæˆä»£ç†å¯¹è±¡ï¼ˆAOPå¤±æ•ˆï¼‰ private UserService userService; /** * è®¤è¯ * * @param authenticationToken * @return * @throws AuthenticationException */ @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException &#123; String username = (String) authenticationToken.getPrincipal(); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executing doGetAuthenticationInfo", username)); &#125; User user = userService.getUserByUsername(username); if (user == null) &#123; throw new UnknownAccountException(); &#125; if (Constant.IS_LOCK.equals(user.getIsLock())) &#123; throw new LockedAccountException(); &#125; // ShiroUser ä½œä¸ºå®é™…çš„ principal ShiroUser shiroUser = new ShiroUser(); BeanUtils.copyProperties(user, shiroUser); // SimpleAuthenticationInfo(Object principal, Object credentials, String realmName) // principal ä¼šè¢«å°è£…åˆ° subject ä¸­ // shiro é»˜è®¤ä¼šæŠŠæˆ‘ä»¬çš„ credentials (ä¹Ÿå°±æ˜¯password) å’Œ token ä¸­çš„ä½œå¯¹æ¯”ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸ç”¨åšå¯†ç æ ¡éªŒ ByteSource salt = ByteSource.Util.bytes(user.getUsername()); SimpleAuthenticationInfo info = new SimpleAuthenticationInfo(shiroUser, user.getPassword(), salt, getName()); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executed doGetAuthenticationInfo", username)); &#125; return info; &#125; /** * æˆæƒ * * @param principalCollection * @return */ @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) &#123; ShiroUser shiroUser = (ShiroUser) principalCollection.getPrimaryPrincipal(); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executing doGetAuthorizationInfo", shiroUser.getUsername())); &#125; AuthorizationDTO authorizationDTO = userService.getRolesAndPermissions(shiroUser.getId()); SimpleAuthorizationInfo info = new SimpleAuthorizationInfo(); info.addRoles(authorizationDTO.getRoleCodeSet()); info.addStringPermissions(authorizationDTO.getPermissionCodeSet()); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executed doGetAuthorizationInfo", shiroUser.getUsername())); &#125; return info; &#125;&#125; doGetAuthenticationInfo : è®¤è¯æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œ subject.login(token);åï¼ŒShiroè®¤è¯å™¨ä¼šè¯»å– Realm ä¸­çš„è¯¥æ–¹æ³•è·å– AuthenticationInfoå¯¹è±¡ï¼ˆè®¤è¯ä¿¡æ¯ï¼‰ï¼ŒåŒ…å«principalï¼ˆæˆ‘ä»¬å­˜å‚¨åœ¨shiro subjectä¸­çš„å¯¹è±¡ï¼‰ï¼Œcredentials ï¼ˆå¯†ç ï¼‰ã€‚ doGetAuthorizationInfo: æˆæƒæ–¹æ³•ï¼Œåœ¨éœ€è¦æ ¡éªŒç”¨æˆ·è®¿é—®æƒé™çš„æ—¶å€™ï¼ŒShiroæˆæƒå™¨ä¼šè¯»å– Realm ä¸­çš„è¯¥æ–¹æ³•è·å– AuthorizationInfoå¯¹è±¡ï¼ˆæˆæƒä¿¡æ¯ï¼‰è¯»å–DBåï¼Œå¯ä»¥é€šè¿‡ addRoles(roleCollection) å’Œ addStringPermissions(permCollection) è®¾ç½®å½“å‰ç”¨æˆ·çš„è§’è‰²å’Œæƒé™ã€‚Shiro åœ¨æ‹¿åˆ°è¿™ä¸ªæƒé™ä¿¡æ¯åï¼Œä¼šå»æ‰¾ç¼“å­˜ç®¡ç†å™¨ï¼Œä»¥å½“å‰ subject çš„ principal ä½œä¸ºkey ç¼“å­˜èµ·æ¥ã€‚ 3. CredentialsMatcher: å¯†ç åŒ¹é…å™¨ï¼Œç”¨äºåŒ¹é… doGetAuthenticationInfo æ–¹æ³•è¿”å›çš„ credentials å’Œ subject.login(token);æ—¶çš„ token ä¸­çš„ passwordæ˜¯å¦ä¸€è‡´ã€‚å¸¸ç”¨çš„å®ç°æœ‰ SimpleCredentialsMatcherï¼ˆé»˜è®¤æ˜¯è¯¥å®ç°ï¼‰ã€HashedCredentialsMatcher ï¼ˆè¯¥å®ç°å¯ä»¥è¿›è¡ŒåŠ å¯†åŒ¹é…ï¼‰ 4. DefaultWebSecurityManagerï¼šå¦‚ä¸Šè¿°ï¼Œç”¨äºåè°ƒShiroå†…éƒ¨å„ç§å®‰å…¨ç»„ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬æ‰©å±•çš„bean æ³¨å†Œåˆ° SecurityManager ä¸­ 5. RememberMeManagerï¼šå¼€å¯è¯¥ç»„ä»¶åä½¿ç”¨è®°ä½æˆ‘æœåŠ¡ï¼Œ token ä¸­ rememberMe ä¸º true æ—¶ï¼Œç™»å½•æˆåŠŸä¹‹åä¼šåˆ›å»ºRememberMe cookieã€‚ å…¶ä½™å‚è€ƒä¸Šæ–‡ä»£ç æ³¨é‡Š å…³äº thymeleaf-extras-shiroShiro é»˜è®¤æ”¯æŒåœ¨ jsp ä¸­ä½¿ç”¨ shiroæ ‡ç­¾ã€‚ä½†æ˜¯æƒ³åœ¨ thymeleaf ä¸­ä½¿ç”¨ Shiro æ ‡ç­¾å‘¢ï¼Ÿ ä½¿ç”¨ thymeleaf-extras-shiro å®Œç¾è§£å†³ thymeleaf é¢—ç²’åŒ–æƒé™æ§åˆ¶1234567891011ä½ å¥½, &lt;span th:text=&quot;$&#123;principal&#125;&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;p shiro:hasRole=&quot;super_admin&quot;&gt;å½“å‰è§’è‰²è¶…çº§ç®¡ç†å‘˜&lt;/p&gt;&lt;button shiro:hasPermission=&quot;&apos;sys:user:add&apos;&quot;&gt;æ·»åŠ &lt;/button&gt;&lt;button shiro:hasPermission=&quot;&apos;sys:user:update&apos;&quot;&gt;ç¼–è¾‘&lt;/button&gt;&lt;button shiro:hasPermission=&quot;&apos;sys:user:lock&apos;&quot;&gt;å†»ç»“&lt;/button&gt;&lt;div shiro:hasAllPermissions=&quot;&apos;sys:user:add, sys:user:update, sys:user:lock&apos;&quot;&gt; &lt;span&gt;æ»¡è¶³æ‰€æœ‰æƒé™æ—¶æ˜¾ç¤º&lt;/span&gt;&lt;/div&gt;&lt;div shiro:hasAnyPermissions=&quot;&apos;sys:user:add, sys:user:update, sys:user:lock&apos;&quot;&gt; &lt;span&gt;æ»¡è¶³ä¸€ä¸ªæƒé™å³å¯æ˜¾ç¤º&lt;/span&gt;&lt;/div&gt; æ›´å¤šç”¨æ³•å‚è€ƒGithub æ–‡æ¡£ï¼šhttps://github.com/theborakompanioni/thymeleaf-extras-shiro æœ¬æ–‡demohttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-shiroå¦‚æœä½ å‘ç°æˆ‘çš„æ–‡ç« æˆ–è€…demoä¸­å­˜åœ¨é—®é¢˜ï¼Œè¯·è”ç³»æˆ‘]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Shiro</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring-åˆä¸€æ¬¡äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„æ’æŸ¥]]></title>
    <url>%2Fpost%2F836297d7.html</url>
    <content type="text"><![CDATA[ä¸Šä¸€ç¯‡å…³äºäº‹åŠ¡çš„ è§£å†³ spring service è°ƒç”¨å½“å‰ç±»æ–¹æ³•äº‹åŠ¡ä¸ç”Ÿæ•ˆ æ­£æ–‡ä»Šå¤©åœ¨å·¥ä½œä¸­çªç„¶å‘ç°æ ‡è®°äº† @Transactional çš„æ–¹æ³•ï¼Œäº‹åŠ¡å¹¶æ²¡æœ‰ç”Ÿæ•ˆã€‚åœ¨æ£€æŸ¥äº†ä¸šåŠ¡å±‚æ˜¯å¦ try catchå¼‚å¸¸ï¼ŒMySQLå­˜å‚¨å¼•æ“ä¹‹åã€‚å¿ƒæ€å·²è¿‘å´©æºƒçš„è¾¹ç¼˜ï¼š)è¿™ä¸ªæ—¶å€™çªç„¶å‘ç°äº†ä¸€ä¸ªç¥å¥‡çš„ç°è±¡ï¼ä¸¤ä¸ª@Service éƒ½æ ‡è®°äº† @Transactionalï¼ŒuserService å¹¶æ²¡æœ‰ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œä¹Ÿå°±å¯¼è‡´äº†äº‹åŠ¡ä¸ç”Ÿæ•ˆã€‚ ç»§ç»­æ’æŸ¥ï¼Œæœ€åé”å®šäº†å‡¶æ‰‹ â€” BeanPostProcessor å…ˆçœ‹ä¸€ä¸‹å®˜æ–¹æè¿°1234567891011121314/** * Factory hook that allows for custom modification of new bean instances, * e.g. checking for marker interfaces or wrapping them with proxies. * * &lt;p&gt;ApplicationContexts can autodetect BeanPostProcessor beans in their * bean definitions and apply them to any beans subsequently created. * Plain bean factories allow for programmatic registration of post-processors, * applying to all beans created through this factory. * * &lt;p&gt;Typically, post-processors that populate beans via marker interfaces * or the like will implement &#123;@link #postProcessBeforeInitialization&#125;, * while post-processors that wrap beans with proxies will normally * implement &#123;@link #postProcessAfterInitialization&#125;. * ç®€å•çš„æ¥è¯´ï¼ŒBeanPostProcessoræ˜¯Spring ç»™æˆ‘ä»¬æä¾›çš„ä¸€ä¸ªæ‰©å±•æ¥å£1234567public interface BeanPostProcessor &#123; // beanå®ä¾‹åŒ–æ–¹æ³•è°ƒç”¨å‰è¢«è°ƒç”¨ Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException; // beanå®ä¾‹åŒ–æ–¹æ³•è°ƒç”¨åè¢«è°ƒç”¨ Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException;&#125; åˆ†æ ApplicationContexts æ£€æµ‹åˆ° BeanPostProcessor ä¹‹åä¼šå°†ä»–åº”ç”¨äºéšååˆ›å»ºçš„æ‰€æœ‰ beanï¼Œæ‰€ä»¥ BeanPostProcessor ä¼šåœ¨å…¶ä»–Beançš„ä¹‹å‰åŠ è½½ï¼Œä½†æ˜¯éšä¹‹å¼•å‘çš„é—®é¢˜çš„å°±æ˜¯ BeanPostProcessor å®ç°ç±»æ‰€å¼•ç”¨çš„Bean æ²¡æœ‰è¢«ä»£ç†ï¼Œåªæ˜¯è¢«æ‰˜ç®¡åˆ° IOC å®¹å™¨ä¸­ã€‚ æˆ‘çš„é¡¹ç›®é‡Œå¼•ç”¨äº† Shiroï¼Œè€Œ Shiro çš„æ‰€æœ‰ç»„ä»¶æœ€ç»ˆä¼šè¢«å°è£…åˆ° ShiroFilterFactoryBean ï¼ˆè¯¥ç±»å®ç°äº† BeanPostProcessorï¼‰ä¸­ï¼Œè€Œ Shiro çš„ Realm ä¸­åˆä¾èµ–äº†æˆ‘ä»¬çš„ Serviceï¼Œè¯¥ Service é¢„å…ˆåŠ è½½ï¼Œå¯¼è‡´æ²¡æœ‰è¢«ä»£ç† è§£å†³æ–¹æ¡ˆ1234567public class AuthRealm extends AuthorizingRealm &#123; @Autowired @Lazy // å»¶è¿ŸåŠ è½½ private UserService userService;&#125; æ€»ç»“è¿™é‡Œç»™å¤§å®¶ç®€å•ä»‹ç»å¼•èµ·äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„å‡ ä¸ªåŸå›  try catch æ•è· Service è¿è¡Œæ—¶å¼‚å¸¸ï¼Œå› ä¸º Spring é»˜è®¤åœ¨æ•è·åˆ° RuntimeException æ—¶å›æ»š MySQLå­˜å‚¨å¼•æ“ InnoDB æ˜¯æ”¯æŒäº‹åŠ¡çš„ï¼Œè€Œ MyISAM ä¸æ”¯æŒ ç”±äºå„ç§åŸå› æ²¡æœ‰ä½¿ç”¨æˆ–è€… Spring æ²¡æœ‰ç”Ÿæˆä»£ç†å¯¹è±¡]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>AOP</tag>
        <tag>Shiro</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-insert-or-update]]></title>
    <url>%2Fpost%2F73b0b9b2.html</url>
    <content type="text"><![CDATA[æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ç±»ä¼¼çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ’å…¥ä¸€æ¡æ•°æ®å¦‚æœä»–ä¸å­˜åœ¨åˆ™æ‰§è¡Œ insert ï¼Œå½“è¿™æ¡è®°å½•å­˜åœ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å» update ä»–çš„ä¸€äº›å±æ€§ï¼ˆæˆ–è€…ä»€ä¹ˆéƒ½ä¸åšï¼‰ã€‚ è§£å†³æ–¹æ¡ˆï¼š ä½¿ç”¨ ON DUPLICATE KEY UPDATEåœ¨ ä¸»é”® æˆ–è€… å”¯ä¸€çº¦æŸ é‡å¤æ—¶ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œã€‚ ä½¿ç”¨ REPLACE INTOåœ¨ ä¸»é”® æˆ–è€… å”¯ä¸€çº¦æŸ é‡å¤æ—¶ï¼Œå…ˆ delete å† insertã€‚ ON DUPLICATE KEY UPDATE åˆ›å»ºè¡¨ï¼Œå»ºç«‹å”¯ä¸€çº¦æŸï¼Œå‡†å¤‡ä¸€æ¡æ•°æ®123456789101112CREATE TABLE `stu_class_ref` ( `id` varchar(30) NOT NULL, `stu_id` varchar(30) DEFAULT NULL, `class_id` varchar(30) DEFAULT NULL, `note` varchar(100) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `stu_id` (`stu_id`,`class_id`) USING BTREE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;INSERT INTO `test`.`stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (&apos;001&apos;, &apos;zhangsan&apos;, &apos;yuwen&apos;, NULL); ä½¿ç”¨ ON DUPLICATE KEY UPDATE 123456INSERT INTO `test`.`stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (UUID_SHORT(), &apos;zhangsan&apos;, &apos;yuwen&apos;, &apos;æˆ‘å–œæ¬¢è¯­æ–‡:)&apos;)ON DUPLICATE KEY UPDATE note = &apos;æˆ‘å–œæ¬¢è¯­æ–‡:)&apos;&gt; Affected rows: 2&gt; æ—¶é—´: 0.042s Affected rows: 2ï¼ŒMySQL æ£€æŸ¥æ’å…¥çš„è¡Œæ˜¯å¦ä¼šäº§ç”Ÿé‡å¤é”®é”™è¯¯ï¼Œå¦‚æœä¼šåˆ™æ‰§è¡Œupdate å¦‚æœæƒ³è¦å¼•ç”¨ VALUES ä¸­çš„å€¼ï¼Œå‚è€ƒå¦‚ä¸‹123456INSERT INTO `test`.`stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (UUID_SHORT(), &apos;zhangsan&apos;, &apos;yuwen&apos;, NULL)ON DUPLICATE KEY UPDATE note = VALUES(class_id)&gt; Affected rows: 2&gt; æ—¶é—´: 0.006s REPLACE INTO MySQL ä¸­ è¿˜æœ‰ä¸€ä¸ªé»‘ç§‘æŠ€è¯­æ³• REPLACE INTO1234REPLACE INTO `stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (UUID_SHORT(), &apos;zhangsan&apos;, &apos;yuwen&apos;, NULL)&gt; Affected rows: 2&gt; æ—¶é—´: 0.004s REPLACE INTO å°±æ¯”è¾ƒç®€å•ç²—æš´äº†ï¼Œä»–ä¼šå…ˆæ‰§è¡Œdelete æ“ä½œï¼Œç„¶åinsert ON DUPLICATE KEY UPDATE ä¸ REPLACE INTO å†æ¥åˆ›å»ºä¸€å¼ è¡¨, åˆ›å»ºä¸‰ä¸ªå”¯ä¸€çº¦æŸ, æ’å…¥ä¸‰æ¡æ•°æ®123456789101112131415161718CREATE TABLE `interesting` ( `id` varchar(30) NOT NULL, `uni_a` varchar(30) DEFAULT NULL, `uni_b` varchar(30) DEFAULT NULL, `uni_c` varchar(30) DEFAULT NULL, `version` int(11) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `uni_a` (`uni_a`) USING BTREE, UNIQUE KEY `uni_b` (`uni_b`) USING BTREE, UNIQUE KEY `uni_c` (`uni_c`) USING BTREE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;INSERT INTO `test`.`interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (&apos;1&apos;, &apos;a&apos;, &apos;a&apos;, &apos;a&apos;, NULL);INSERT INTO `test`.`interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (&apos;2&apos;, &apos;b&apos;, &apos;b&apos;, &apos;b&apos;, NULL);INSERT INTO `test`.`interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (&apos;3&apos;, &apos;c&apos;, &apos;c&apos;, &apos;c&apos;, NULL); æ‰§è¡Œ ON DUPLICATE KEY UPDATE12345INSERT INTO `interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (UUID_SHORT(), &apos;a&apos;, &apos;b&apos;, &apos;c&apos;, NULL)ON DUPLICATE KEY UPDATE version = 666&gt; Affected rows: 2&gt; æ—¶é—´: 0.049s Affected rows: 2 ä½†æ˜¯å…¶å®ä¸‰æ¡ä¸»é”®éƒ½æœ‰å†²çªäº† å†çœ‹ä¸€ä¸‹ REPLACE INTO1234REPLACE INTO `interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (UUID_SHORT(), &apos;a&apos;, &apos;b&apos;, &apos;c&apos;, NULL)&gt; Affected rows: 4&gt; æ—¶é—´: 0.026s Affected rows: 4 REPLACE INTO å°†ä¸‰æ¡æœ‰å†²çªçš„å…¨éƒ¨delete ç„¶å insert ####æ€»ç»“ï¼š ON DUPLICATE KEY UPDATE åªä¼šå¯¹æ‰€åŒ¹é…çš„ç¬¬ä¸€è¡Œè¿›è¡Œupdate, REPLACE INTO ä¼šå¯¹æ‰€æœ‰åŒ¹é…è¡Œè¿›è¡Œdelete, insert æ‰€ä»¥åº”é¿å…å¯¹æœ‰å¤šä¸ªå”¯ä¸€ç´¢å¼•çš„è¡¨ä½¿ç”¨]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot ä½¿ç”¨ hibernate validator]]></title>
    <url>%2Fpost%2F81ef5d67.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡å°†å…¨é¢çš„ä»‹ç»å¦‚ä½•ä½¿ç”¨ validator è¿›è¡Œæ•°æ®æ ¡éªŒ æœ¬æ–‡æºç ï¼šhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-validate å‡†å¤‡å·¥ä½œæˆ‘ä»¬åªéœ€è¦å¼•å…¥ spring-boot-starter-webåŒ…å³å¯ä½¿ç”¨ å¸¸ç”¨æ³¨è§£ æ³¨è§£ é‡Šä¹‰ @Valid è¢«æ³¨é‡Šçš„å…ƒç´ æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦æ£€æŸ¥æ­¤å¯¹è±¡çš„æ‰€æœ‰å­—æ®µå€¼ @Null è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º null @NotNull è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸ä¸º null @NotEmpty è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¿…é¡»éç©º, å³ä¸ä¸ºnull, â€œâ€ @NotBlank è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¿…é¡»éç©º, å³ä¸ä¸ºnull, â€œâ€, â€œ â€œ @AssertTrue è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º true @AssertFalse è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º false @Min(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼ @Max(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼ @DecimalMin(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼ @DecimalMax(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼ @Size(max, min) è¢«æ³¨é‡Šçš„å…ƒç´ çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†… @Digits (integer, fraction) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»åœ¨å¯æ¥å—çš„èŒƒå›´å†… @Past è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªè¿‡å»çš„æ—¥æœŸ @Future è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªå°†æ¥çš„æ—¥æœŸ @Pattern(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼ @Email è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ç”µå­é‚®ç®±åœ°å€ @Length(min=, max=) è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†… @Range(min=, max=) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»åœ¨åˆé€‚çš„èŒƒå›´ ç®€å•çš„å®ä½“æ ¡éªŒ123456789101112131415161718public class CardDTO &#123; @NotBlank private String cardId; @Size(min = 10, max = 10) @NotNull private String cardNum; // å¡å· @Past @NotNull private Date createDate; @Range(max = 3) private String cardType; // çœç•¥get set&#125; 123456789@RestControllerpublic class UserController &#123; @PostMapping(&quot;simple&quot;) public Object simple(@RequestBody @Valid CardDTO cardDTO) &#123; return cardDTO; &#125;&#125; å®ä½“å±æ€§ä¸Šæ·»åŠ æ ¡éªŒæ³¨è§£ controller æ–¹æ³• å‚æ•°å‰ ä½¿ç”¨@Valid å³å¯ å¤æ‚çš„å®ä½“æ ¡éªŒåµŒå¥—å®ä½“æ ¡éªŒ123456789101112131415public class UserDTO &#123; @NotBlank private String userId; @NotBlank private String username; private String password; @Valid private List&lt;CardDTO&gt; cardList; //çœç•¥ get set&#125; controller å†™æ³• åŒä¸Šï¼Œåªæ˜¯åœ¨ UserDTO cardList å±æ€§ä¸Šæ ‡è®°@Valid æ³¨è§£ å³å¯ã€‚ List æ ¡éªŒ æˆ‘ä»¬éœ€è¦åƒ åµŒå¥—æ ¡éªŒ æ—¶ä¸€æ ·ï¼Œå¯¹List&lt;CardDTO&gt; åšä¸€å±‚å°è£… 123456789101112131415public class ValidList&lt;E&gt; implements List&lt;E&gt; &#123; @Valid private List&lt;E&gt; list = new ArrayList&lt;&gt;(); public List&lt;E&gt; getList() &#123; return list; &#125; public void setList(List&lt;E&gt; list) &#123; this.list = list; &#125; // çœç•¥äº† å®ç°æ–¹æ³•&#125; é‡å†™å®ç°æ–¹æ³•å®Œå…¨ä½¿ç”¨ this.list.xxx()Gitee:spring ä¼šå°†æ•°æ®å°è£…åˆ°æˆ‘ä»¬å®šä¹‰çš„ list å±æ€§ä¸­ï¼Œåˆå°†å±æ€§å£°æ˜äº† @Valid ä½¿å¾— hibernate validator å¯ä»¥ä¸ºæˆ‘ä»¬åšæ ¡éªŒï¼ ä½¿ç”¨ @Validated åˆ†ç»„æ ¡éªŒ12345public interface Insert &#123;&#125;public interface Update &#123;&#125; å®šä¹‰ä¸¤ä¸ªæ¥å£ 12345678910111213public class GroupCardDTO &#123; @NotBlank(groups = &#123;Update.class&#125;) private String id; @NotBlank(groups = &#123;Insert.class&#125;) private String cardNum; @NotNull(groups = &#123;Insert.class, Update.class&#125;) private Integer cardType; //çœç•¥ get set&#125; å®ä½“æ ‡è®°çš„æ³¨è§£ä¸­æ·»åŠ  group å±æ€§ 1234@PostMapping(&quot;insert_card&quot;)public Object insert_card(@RequestBody @Validated(Insert.class) GroupCardDTO card)&#123; return card;&#125; ä½¿ç”¨ @Validated(xxx.class) æ ‡è®°å‚æ•°ï¼Œå®Œæˆåˆ†ç»„æ ¡éªŒï¼ è‡ªå®šä¹‰æ³¨è§£æ ¡éªŒå½“ validator æä¾›çš„æ³¨è§£æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„æ–¹å¼æ¥å®ç°æ ¡éªŒã€‚ éœ€æ±‚ï¼šæ ¡éªŒæŸå­—ç¬¦ä¸²å¿…é¡»ä¸ºå¤§å†™æˆ–è€…å°å†™1234public enum CaseMode &#123; UPPER, LOWER&#125; å®šä¹‰ä¸€ä¸ªæšä¸¾ç±» 12345678910111213141516171819import javax.validation.Constraint;import javax.validation.Payload;import java.lang.annotation.*;@Target( &#123; ElementType.FIELD &#125;)@Retention(RetentionPolicy.RUNTIME)@Constraint(validatedBy = CheckCaseValidator.class)@Documentedpublic @interface CheckCase &#123; String message() default ""; Class&lt;?&gt;[] groups() default &#123;&#125;; Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;; CaseMode value() default CaseMode.LOWER;&#125; å®šä¹‰æ³¨è§£ @Constraint æŒ‡å®šæˆ‘ä»¬çš„æ ¡éªŒé€»è¾‘å®ç°ç±» 12345678910111213141516171819202122232425262728293031import javax.validation.ConstraintValidator;import javax.validation.ConstraintValidatorContext;public class CheckCaseValidator implements ConstraintValidator&lt;CheckCase, String&gt; &#123; private CaseMode caseMode; @Override public void initialize(CheckCase constraintAnnotation) &#123; this.caseMode = constraintAnnotation.value(); &#125; @Override public boolean isValid(String value, ConstraintValidatorContext context) &#123; if (value == null || "".equals(value.trim())) &#123; return false; &#125; switch (this.caseMode) &#123; case LOWER: return value.equals(value.toLowerCase()); case UPPER: return value.equals(value.toUpperCase()); default: return false; &#125; &#125;&#125; initialize() åˆå§‹åŒ–æ—¶æ‰§è¡Œï¼Œå¯ä»¥ç”¨æ¥è·å–æ³¨è§£ä¸­çš„å±æ€§ isValid() å®ç°æˆ‘ä»¬çš„æ ¡éªŒé€»è¾‘ å¤‡æ³¨ æˆ‘ä»¬è‡ªå®šä¹‰çš„æ³¨è§£ä¾ç„¶æ”¯æŒ @Validated group åˆ†ç»„ æ‰‹åŠ¨ä½¿ç”¨ validator æ ¡éªŒ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869import org.hibernate.validator.internal.engine.path.PathImpl;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;import java.util.Set;import javax.validation.ConstraintViolation;import javax.validation.Validation;import javax.validation.Validator;import javax.validation.ValidatorFactory;public class ValidateUtil &#123; /** * æ ¡éªŒå®ä½“ç±» * * @param t * @return */ public static &lt;T&gt; List&lt;Map&gt; validate(T t) &#123; //å®šä¹‰è¿”å›é”™è¯¯List List&lt;Map&gt; errList = new ArrayList&lt;&gt;(); Map&lt;String, String&gt; errorMap; ValidatorFactory factory = Validation.buildDefaultValidatorFactory(); Validator validator = factory.getValidator(); Set&lt;ConstraintViolation&lt;T&gt;&gt; errorSet = validator.validate(t); for (ConstraintViolation&lt;T&gt; c : errorSet) &#123; errorMap = new HashMap&lt;&gt;(); errorMap.put("field", c.getPropertyPath().toString()); //è·å–å‘ç”Ÿé”™è¯¯çš„å­—æ®µ errorMap.put("msg", c.getMessage()); //è·å–æ ¡éªŒä¿¡æ¯ errList.add(errorMap); &#125; return errList; &#125; /** * ä½¿ç”¨ ValidList æ ¡éªŒList, è¿”å›å¯¹åº”ç´¢å¼•å’Œé”™è¯¯æ¶ˆæ¯ * * @param t * @param &lt;T&gt; * @return */ public static &lt;T&gt; List&lt;Map&gt; validateList(T t) &#123; //å®šä¹‰è¿”å›é”™è¯¯List List&lt;Map&gt; errList = new ArrayList&lt;&gt;(); Map&lt;String, Object&gt; errorMap; ValidatorFactory factory = Validation.buildDefaultValidatorFactory(); Validator validator = factory.getValidator(); Set&lt;ConstraintViolation&lt;T&gt;&gt; errorSet = validator.validate(t); for (ConstraintViolation&lt;T&gt; c : errorSet) &#123; errorMap = new HashMap&lt;&gt;(); int index = ((PathImpl) c.getPropertyPath()).getLeafNode().getIndex(); errorMap.put("index", index); // å½“å‰ç´¢å¼• errorMap.put("field", c.getPropertyPath().toString()); //è·å–å‘ç”Ÿé”™è¯¯çš„å­—æ®µ errorMap.put("msg", c.getMessage()); //è·å–æ ¡éªŒä¿¡æ¯ errList.add(errorMap); &#125; return errList; &#125;&#125; æœ¬èŠ‚æºç https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-validate]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JWT é‰´æƒ]]></title>
    <url>%2Fpost%2F606cdcbb.html</url>
    <content type="text"><![CDATA[JWT æ˜¯ä»€ä¹ˆ JSON Web Tokenï¼ˆJWTï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾å¼æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘ä¸”è‡ªåŒ…å«çš„æ–¹å¼ï¼Œç”¨äºåœ¨å„æ–¹ä¹‹é—´ä»¥JSONå¯¹è±¡å®‰å…¨ä¼ è¾“ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥é€šè¿‡æ•°å­—ç­¾åè¿›è¡ŒéªŒè¯å’Œä¿¡ä»»ã€‚ JWT çš„ç»„æˆJWT çš„æ ¼å¼ä¸º xxx.yyy.zzzã€‚åŒ…å« Headerï¼ˆå¤´éƒ¨ï¼‰ï¼ŒPayloadï¼ˆè´Ÿè½½ï¼‰ï¼ŒSignatureï¼ˆç­¾åï¼‰ä¸‰éƒ¨åˆ†ã€‚ Headeré€šå¸¸ä¼šå£°æ˜ä½¿ç”¨çš„åŠ å¯†ç®—æ³•å’Œtokenç±»å‹ 1234&#123; &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot;&#125; PayloadPayload åŒ…å« Claimsï¼ŒClaimæ˜¯ä¸€äº›å®ä½“ï¼ˆä¸€èˆ¬éƒ½æ˜¯ç”¨æˆ·ï¼‰çš„çŠ¶æ€å’Œé¢å¤–çš„æ•°æ®ç»„æˆã€‚JWT ä¸ºæˆ‘ä»¬é¢„å®šä¹‰äº†ä¸€äº› Claimsï¼Œä¾‹å¦‚ï¼šiss (issuer), exp (expiration time), sub (subject), aud (audience), and others.ä½†æ˜¯å¹¶ä¸è¦æ±‚æˆ‘ä»¬å¼ºåˆ¶ä½¿ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰ Claim 12345&#123; &quot;sub&quot;: &quot;1234567890&quot;, &quot;name&quot;: &quot;Taven&quot;, &quot;admin&quot;: true&#125; Signature 1234HMACSHA256( base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), secret) è¿™æ®µä¼ªä»£ç å·²ç»å¾ˆå¥½çš„è®²è§£äº†ï¼Œç­¾åæ˜¯å¦‚ä½•è®¡ç®—çš„ã€‚æœåŠ¡ç«¯æä¾›ä¸€ä¸ªsecretï¼Œå°†headerã€payload è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åä½¿ç”¨headerä¸­å£°æ˜çš„ç®—æ³•è®¡ç®—ç­¾åã€‚ JWT ä¸ session å¯¹æ¯” æ€§èƒ½ï¼šJWT è½»é‡çº§ï¼Œè€Œsession ä¼šå ç”¨å¤§é‡æœåŠ¡ç«¯å†…å­˜ï¼› éƒ¨ç½²ï¼šä½¿ç”¨sessionçš„ç³»ç»Ÿ è´Ÿè½½å‡è¡¡éœ€è¦è€ƒè™‘ session å…±äº«ï¼Œè€ŒJWT ä¸éœ€è¦ï¼› å®‰å…¨ï¼šå®‰å…¨æ€§çš„è¯ï¼Œå°å¼Ÿä¸æ•¢å¤šè¯´ï¼Œæˆ‘è§‰å¾—äº”äº”å¼€å§ï¼Œæœ‰äººè¯´ JWT æ³„éœ²çš„è¯ï¼Œç›´æ¥å°±å¯ä»¥ç™»å½•äº†ã€‚ä½†æ˜¯ä½¿ç”¨ session å¦‚æœè¯·æ±‚è¢«æ‹¦æˆªäº†éƒ½æ˜¯ä¸€æ ·çš„ï¼› åœºæ™¯ï¼šAPP ä¸­ç”±äºæ²¡æœ‰cookieå§ï¼Œå¤šæ˜¯ä½¿ç”¨tokenã€‚è€Œ web åº”ç”¨çš„è¯ï¼Œä½¿ç”¨ token å’Œ session éƒ½æ˜¯å¯ä»¥çš„ã€‚ å®ç°æ€è·¯ç®€å•ä¸€å¥è¯å°±æ˜¯ï¼Œç™»å½•ä¹‹åæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯é¢å‘JWTï¼Œå®¢æˆ·ç«¯å°† JWT æ”¾åœ¨è¯·æ±‚å¤´ä¸­ï¼ŒæœåŠ¡ç«¯ filter æ ¡éªŒhttp headerä¸­çš„JWTã€‚ æŸ¥é˜…äº†ä¸€äº›èµ„æ–™åå‘ç°ä¸€äº›åˆ†æ­§ æ–¹æ¡ˆ1ï¼š æœ‰çš„æœ‹å‹è®¤ä¸ºæœåŠ¡ç«¯ä¸éœ€è¦å­˜å‚¨ JWTï¼Œåªåœ¨ filter æ ¡éªŒçš„æ—¶å€™è§£ææ— è¯¯ï¼Œå³è®¤ä¸º JWT æ˜¯å¯ç”¨çš„ã€‚åœ¨éœ€è¦é‡ç½® JWT çš„æ—¶å€™ï¼ˆä¾‹å¦‚æ³¨é”€ï¼‰ï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨åˆ é™¤JWTã€‚è¿™ç§åšæ³•å¼•å‘çš„é—®é¢˜ï¼Œä¾‹å¦‚åœ¨æ³¨é”€äº†ä¹‹åï¼Œtoken ä¾ç„¶å¯ç”¨ï¼Œç”±äºæœåŠ¡ç«¯æ²¡æœ‰å­˜å‚¨ tokenï¼Œæ— æ³•å»æ ¡éªŒã€‚äºæ˜¯ä¹æœ‰äº†æ–¹æ¡ˆ2 æ–¹æ¡ˆ2ï¼šæœåŠ¡ç«¯æ•°æ®åº“ä¸­å­˜å‚¨ JWTï¼Œfilter æ¯æ¬¡æ ¡éªŒ token ä¸æ•°æ®åº“ä¸­æ˜¯å¦ä¸€è‡´ï¼Œè¿™ç§åšæ³•è™½ç„¶ç¨³å¦¥ï¼Œä½†æ˜¯åœ¨æ€§èƒ½ä¸Šä¸€å®šæ˜¯ä¸å¦‚æ–¹æ¡ˆ1çš„ã€‚ demohttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-boot-jwt]]></content>
      <categories>
        <category>æŠ€æœ¯</category>
      </categories>
      <tags>
        <tag>JWT</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot Atomikos å¤šæ•°æ®æºåˆ†å¸ƒå¼äº‹åŠ¡]]></title>
    <url>%2Fpost%2F2727b3ac.html</url>
    <content type="text"><![CDATA[ä¹‹å‰çš„ ã€Šspring åŠ¨æ€åˆ‡æ¢ã€æ·»åŠ æ•°æ®æºå®ç°ä»¥åŠæºç æµ…æã€‹ ä¸­ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ spring æä¾›çš„ AbstractRoutingDataSource é…ç½®å¤šæ•°æ®æºï¼Œæœ‰äº†å¤šæ•°æ®æºè‡ªç„¶è¦ç®¡ç†äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚ä¸Šç¯‡æ–‡ç« ä¸­æåˆ°è¿‡é…ç½®å¤šæ•°æ®æºçš„ä¸¤ç§æ–¹å¼ ä½¿ç”¨AbstractRoutingDataSource é…ç½®å¤šä¸ª SqlSessionFactory å‰è¨€ç²—ç•¥é˜…è¯»äº†ä¸€ä¸‹springçš„æºç ï¼Œç”±äº spring äº‹åŠ¡çš„æœºåˆ¶ï¼Œåœ¨å¼€å¯äº‹åŠ¡ä¹‹å‰spring ä¼šå»åˆ›å»ºå½“å‰æ•°æ®æºçš„ äº‹åŠ¡objectï¼Œç›´åˆ°äº‹åŠ¡æäº¤ï¼Œspring éƒ½ä¸ä¼šåœ¨ä¹ä½ æ˜¯å¦åˆ‡æ¢äº†æ•°æ®æºã€‚è¿™å°±å¯¼è‡´äº†ï¼Œä½¿ç”¨ AbstractRouting DataSource æ–¹å¼å¼€å¯äº‹åŠ¡æ—¶ï¼Œåˆ‡æ¢æ•°æ®æºä¸ç”Ÿæ•ˆã€‚å…³äºå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å»é˜…è¯»ä¸€ä¸‹ï¼šhttps://www.jianshu.com/p/61e8961c6154 æœ¬æ–‡åªè®¨è®ºä¸Šè¿°ç¬¬äºŒç§æ–¹å¼ç»“åˆ atomikos ç®¡ç†å¤šæ•°æ®æºäº‹åŠ¡ã€‚ Atomikosæ¥è‡ªï¼šhttp://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-jta.html Atomikos is a popular open source transaction manager which can be embedded into your Spring Boot application. You can use thespring-boot-starter-jta-atomikos Starter to pull in the appropriate Atomikos libraries. Spring Boot auto-configures Atomikos and ensures that appropriate depends-on settings are applied to your Spring beans for correct startup and shutdown ordering. By default, Atomikos transaction logs are written to a transaction-logs directory in your applicationâ€™s home directory (the directory in which your application jar file resides). You can customize the location of this directory by setting a spring.jta.log-dir property in your application.properties file. Properties starting with spring.jta.atomikos.properties can also be used to customize the Atomikos UserTransactionServiceImp. See the AtomikosProperties Javadoc for complete details. å¼•å…¥spring-boot-starter-jta-atomikosï¼Œspring boot ä¸ºæˆ‘ä»¬è‡ªåŠ¨é…ç½®Atomikosï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ spring.jta.xxx ä¿®æ”¹é»˜è®¤é…ç½®ã€‚ Talk is cheap. Show me the code demoæºç ï¼šhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-atomikos æ·»åŠ  maven ä¾èµ– 12345678910&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jta-atomikos&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;1.1.1&lt;/version&gt;&lt;/dependency&gt; application.properties 1234567891011121314151617181920212223242526272829303132333435363738394041424344#spring.jta.log-dir=classpath:tx-logsspring.jta.transaction-manager-id=txManagerspring.datasource.druid.system-db.name=system-dbspring.datasource.druid.system-db.url=jdbc:mysql://localhost:3306/test1?useSSL=falsespring.datasource.druid.system-db.username=rootspring.datasource.druid.system-db.password=taven753spring.datasource.druid.system-db.initialSize=5spring.datasource.druid.system-db.minIdle=5spring.datasource.druid.system-db.maxActive=20spring.datasource.druid.system-db.maxWait=60000spring.datasource.druid.system-db.timeBetweenEvictionRunsMillis=60000spring.datasource.druid.system-db.minEvictableIdleTimeMillis=30000spring.datasource.druid.system-db.validationQuery=SELECT 1spring.datasource.druid.system-db.validationQueryTimeout=10000spring.datasource.druid.system-db.testWhileIdle=truespring.datasource.druid.system-db.testOnBorrow=falsespring.datasource.druid.system-db.testOnReturn=falsespring.datasource.druid.system-db.poolPreparedStatements=truespring.datasource.druid.system-db.maxPoolPreparedStatementPerConnectionSize=20spring.datasource.druid.system-db.filters=stat,wallspring.datasource.druid.system-db.connectionProperties=druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000spring.datasource.druid.system-db.useGlobalDataSourceStat=truespring.datasource.druid.business-db.name=business-dbspring.datasource.druid.business-db.url=jdbc:mysql://localhost:3306/test2?useSSL=falsespring.datasource.druid.business-db.username=rootspring.datasource.druid.business-db.password=taven753spring.datasource.druid.business-db.initialSize=5spring.datasource.druid.business-db.minIdle=5spring.datasource.druid.business-db.maxActive=20spring.datasource.druid.business-db.maxWait=60000spring.datasource.druid.business-db.timeBetweenEvictionRunsMillis=60000spring.datasource.druid.business-db.minEvictableIdleTimeMillis=30000spring.datasource.druid.business-db.validationQuery=SELECT 1spring.datasource.druid.business-db.validationQueryTimeout=10000spring.datasource.druid.business-db.testWhileIdle=truespring.datasource.druid.business-db.testOnBorrow=falsespring.datasource.druid.business-db.testOnReturn=falsespring.datasource.druid.business-db.poolPreparedStatements=truespring.datasource.druid.business-db.maxPoolPreparedStatementPerConnectionSize=20spring.datasource.druid.business-db.filters=stat,wallspring.datasource.druid.business-db.connectionProperties=druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000spring.datasource.druid.business-db.useGlobalDataSourceStat=true system æ•°æ®æºçš„é…ç½®ç±» 12345678910111213141516171819202122232425262728293031323334353637383940414243import javax.sql.DataSource;import org.apache.ibatis.session.SqlSessionFactory;import org.mybatis.spring.SqlSessionFactoryBean;import org.mybatis.spring.annotation.MapperScan;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.jta.atomikos.AtomikosDataSourceBean;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.context.annotation.Primary;import com.gitee.taven.config.prop.SystemProperties;import com.gitee.taven.utils.PojoUtil;@Configuration@MapperScan(basePackages = SystemDataSourceConfig.PACKAGE, sqlSessionFactoryRef = "systemSqlSessionFactory")public class SystemDataSourceConfig &#123; static final String PACKAGE = "com.gitee.taven.mapper.system"; @Autowired private SystemProperties systemProperties; @Bean(name = "systemDataSource") @Primary public DataSource systemDataSource() &#123; AtomikosDataSourceBean ds = new AtomikosDataSourceBean(); ds.setXaProperties(PojoUtil.obj2Properties(systemProperties)); ds.setXaDataSourceClassName("com.alibaba.druid.pool.xa.DruidXADataSource"); ds.setUniqueResourceName("systemDataSource"); ds.setPoolSize(5); return ds; &#125; @Bean @Primary public SqlSessionFactory systemSqlSessionFactory() throws Exception &#123; SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean(); sqlSessionFactoryBean.setDataSource(systemDataSource()); return sqlSessionFactoryBean.getObject(); &#125; &#125; business æ•°æ®æºçš„é…ç½®ç±»åŒä¸Š çœç•¥äº† mybatis ä»£ç ï¼Œé€šè¿‡service æµ‹è¯•äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸åï¼Œäº‹åŠ¡ä¼šå›æ»š 1234567891011121314151617181920212223@Servicepublic class UserService &#123; @Autowired private UsersMapper usersMapper; @Autowired private UserInformationsMapper userInformationsMapper; @Transactional public void testJTA() &#123; Users u = new Users(); u.setUsername("hmj"); u.setPassword("hmjbest"); usersMapper.insertSelective(u); UserInformations ui = new UserInformations(); ui.setUserid(666l); ui.setEmail("dsb"); userInformationsMapper.insertSelective(ui); // int i = 10/0; &#125; &#125; demoæºç ï¼šhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-atomikos]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>å¤šæ•°æ®æº</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot å¤šçº¿ç¨‹å¼‚æ­¥è°ƒç”¨---æé«˜ç¨‹åºæ‰§è¡Œæ•ˆç‡]]></title>
    <url>%2Fpost%2F574b9274.html</url>
    <content type="text"><![CDATA[åŸæ–‡ï¼šhttps://spring.io/guides/gs/async-method/ ä¸ºä»€ä¹ˆè¦ç”¨å¼‚æ­¥ï¼Ÿå½“éœ€è¦è°ƒç”¨å¤šä¸ªæœåŠ¡æ—¶ï¼Œä½¿ç”¨ä¼ ç»Ÿçš„åŒæ­¥è°ƒç”¨æ¥æ‰§è¡Œæ—¶ï¼Œæ˜¯è¿™æ ·çš„ è°ƒç”¨æœåŠ¡A ç­‰å¾…æœåŠ¡Açš„å“åº” è°ƒç”¨æœåŠ¡B ç­‰å¾…æœåŠ¡Bçš„å“åº” è°ƒç”¨æœåŠ¡C ç­‰å¾…æœåŠ¡Cçš„å“åº” æ ¹æ®ä»æœåŠ¡Aã€æœåŠ¡Bå’ŒæœåŠ¡Cè¿”å›çš„æ•°æ®å®Œæˆä¸šåŠ¡é€»è¾‘ï¼Œç„¶åç»“æŸ å¦‚æœæ¯ä¸ªæœåŠ¡éœ€è¦3ç§’çš„å“åº”æ—¶é—´ï¼Œè¿™æ ·é¡ºåºæ‰§è¡Œä¸‹æ¥ï¼Œå¯èƒ½éœ€è¦9ç§’ä»¥ä¸Šæ‰èƒ½å®Œæˆä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨å¼‚æ­¥è°ƒç”¨ è°ƒç”¨æœåŠ¡A è°ƒç”¨æœåŠ¡B è°ƒç”¨æœåŠ¡C ç„¶åç­‰å¾…ä»æœåŠ¡Aã€Bå’ŒCçš„å“åº” æ ¹æ®ä»æœåŠ¡Aã€æœåŠ¡Bå’ŒæœåŠ¡Cè¿”å›çš„æ•°æ®å®Œæˆä¸šåŠ¡é€»è¾‘ï¼Œç„¶åç»“æŸ ç†è®ºä¸Š 3ç§’å·¦å³å³å¯å®ŒæˆåŒæ ·çš„ä¸šåŠ¡é€»è¾‘ Talk is cheap. Show me the code123456789101112131415161718192021222324252627public class User &#123; private String name; private String blog; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125; public String getBlog() &#123; return blog; &#125; public void setBlog(String blog) &#123; this.blog = blog; &#125; @Override public String toString() &#123; return "User [name=" + name + ", blog=" + blog + "]"; &#125;&#125; 12345678910111213141516171819202122232425262728293031import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.boot.web.client.RestTemplateBuilder;import org.springframework.scheduling.annotation.Async;import org.springframework.stereotype.Service;import org.springframework.web.client.RestTemplate;import java.util.concurrent.CompletableFuture;@Servicepublic class GitHubLookupService &#123; private static final Logger logger = LoggerFactory.getLogger(GitHubLookupService.class); private final RestTemplate restTemplate; public GitHubLookupService(RestTemplateBuilder restTemplateBuilder) &#123; this.restTemplate = restTemplateBuilder.build(); &#125; @Async public CompletableFuture&lt;User&gt; findUser(String user) throws InterruptedException &#123; logger.info("Looking up " + user); String url = String.format("https://api.github.com/users/%s", user); User results = restTemplate.getForObject(url, User.class); // Artificial delay of 3s for demonstration purposes Thread.sleep(3000L); return CompletableFuture.completedFuture(results); &#125;&#125; The findUser method is flagged with Springâ€™s @Async annotation, indicating it will run on a separate thread. The methodâ€™s return type is CompletableFuture&lt;User&gt; instead of User, a requirement for any asynchronous service. findUser æ–¹æ³•è¢«æ ‡è®°ä¸ºSpringçš„ @Async æ³¨è§£ï¼Œè¡¨ç¤ºå®ƒå°†åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸Šè¿è¡Œã€‚è¯¥æ–¹æ³•çš„è¿”å›ç±»å‹æ˜¯ CompleetableFuture&lt;user&gt; è€Œä¸æ˜¯ Userï¼Œè¿™æ˜¯ä»»ä½•å¼‚æ­¥æœåŠ¡çš„è¦æ±‚ã€‚ 1234567891011121314151617181920212223242526272829import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.context.annotation.Bean;import org.springframework.scheduling.annotation.EnableAsync;import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;import java.util.concurrent.Executor;@SpringBootApplication@EnableAsyncpublic class App &#123; public static void main(String[] args) &#123; // close the application context to shut down the custom ExecutorService SpringApplication.run(App.class, args).close(); &#125; @Bean public Executor asyncExecutor() &#123; ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(2); executor.setMaxPoolSize(2); executor.setQueueCapacity(500); executor.setThreadNamePrefix("GithubLookup-"); executor.initialize(); return executor; &#125;&#125; The @EnableAsync annotation switches on Springâ€™s ability to run @Async methods in a background thread pool. This class also customizes the used Executor. In our case, we want to limit the number of concurrent threads to 2 and limit the size of the queue to 500. There are many more things you can tune. By default, a SimpleAsyncTaskExecutor is used. @EnableAsync æ³¨è§£å¼€å¯Springåœ¨åå°çº¿ç¨‹æ± ä¸­è¿è¡Œ @Async æ–¹æ³•çš„èƒ½åŠ›ã€‚è¯¥ç±»ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä½¿ç”¨çš„ Executorã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å¹¶å‘çº¿ç¨‹çš„æ•°é‡é™åˆ¶ä¸º2ï¼Œå¹¶å°†é˜Ÿåˆ—çš„å¤§å°é™åˆ¶ä¸º500ã€‚æœ‰å¾ˆå¤šä½ å¯ä»¥é…ç½®çš„ä¸œè¥¿)ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨SimpleAsyncTaskExecutorã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243import java.util.concurrent.CompletableFuture;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.boot.CommandLineRunner;import org.springframework.stereotype.Component;import com.gitee.taven.entity.User;import com.gitee.taven.service.GitHubLookupService;@Componentpublic class AppRunner implements CommandLineRunner &#123; private static final Logger logger = LoggerFactory.getLogger(AppRunner.class); private final GitHubLookupService gitHubLookupService; public AppRunner(GitHubLookupService gitHubLookupService) &#123; this.gitHubLookupService = gitHubLookupService; &#125; @Override public void run(String... args) throws Exception &#123; // Start the clock long start = System.currentTimeMillis(); // Kick of multiple, asynchronous lookups CompletableFuture&lt;User&gt; page1 = gitHubLookupService.findUser("PivotalSoftware"); CompletableFuture&lt;User&gt; page2 = gitHubLookupService.findUser("CloudFoundry"); CompletableFuture&lt;User&gt; page3 = gitHubLookupService.findUser("Spring-Projects"); // Wait until they are all done CompletableFuture.allOf(page1,page2,page3).join(); // Print results, including elapsed time float exc = (float)(System.currentTimeMillis() - start)/1000; logger.info("Elapsed time: " + exc + " seconds"); logger.info("--&gt; " + page1.get()); logger.info("--&gt; " + page2.get()); logger.info("--&gt; " + page3.get()); &#125; &#125; é€šè¿‡å®ç° CommandLineRunner è°ƒç”¨ service æœåŠ¡ï¼Œæˆ‘ä»¬è®¾ç½®äº† Thread.sleep(3000L); è¿è¡Œdemoï¼Œ4.73s ç»“æŸæˆ˜æ–—ï¼ æœ¬æ–‡demohttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-async-demo]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring åŠ¨æ€åˆ‡æ¢ã€æ·»åŠ æ•°æ®æºå®ç°ä»¥åŠæºç æµ…æ]]></title>
    <url>%2Fpost%2F9ffabefe.html</url>
    <content type="text"><![CDATA[å…¬å¸é¡¹ç›®éœ€æ±‚ï¼Œç”±äºè¦å…¼å®¹è€ç³»ç»Ÿçš„æ•°æ®åº“ç»“æ„ï¼Œéœ€è¦æ­å»ºä¸€ä¸ª å¯ä»¥åŠ¨æ€åˆ‡æ¢ã€æ·»åŠ æ•°æ®æºçš„åç«¯æœåŠ¡ã€‚ åˆ†æå‚è€ƒäº†è¿‡å»çš„é¡¹ç›®ï¼Œé€šè¿‡é…ç½®å¤šä¸ªSqlSessionFactory æ¥å®ç°å¤šæ•°æ®æºï¼Œè¿™ä¹ˆåšçš„è¯ï¼Œæœªå…è¿‡äºç¬¨é‡ï¼Œè€Œä¸”æ— æ³•å®ç°åŠ¨æ€æ·»åŠ æ•°æ®æºè¿™ä¸ªéœ€æ±‚é€šè¿‡ spring AbstractRoutingDataSource ä¸ºæˆ‘ä»¬æŠ½è±¡äº†ä¸€ä¸ª DynamicDataSource è§£å†³è¿™ä¸€é—®é¢˜ æºç ç®€å•åˆ†æä¸‹ AbstractRoutingDataSource çš„æºç  targetDataSources å°±æ˜¯æˆ‘ä»¬çš„å¤šä¸ªæ•°æ®æºï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨afterPropertiesSet()ï¼Œå»è§£ææˆ‘ä»¬çš„æ•°æ®æº ç„¶å put åˆ° resolvedDataSources å®ç°äº† DataSource çš„ getConnection(); æˆ‘ä»¬çœ‹çœ‹ determineTargetDataSource(); åšäº†ä»€ä¹ˆ é€šè¿‡ä¸‹é¢çš„ determineCurrentLookupKey();ï¼ˆè¿™ä¸ªæ–¹æ³•éœ€è¦æˆ‘ä»¬å®ç°ï¼‰ è¿”å›ä¸€ä¸ªkeyï¼Œç„¶åä» resolvedDataSources ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯ targetDataSourcesï¼‰ ä¸­ get ä¸€ä¸ªæ•°æ®æºï¼Œå®ç°äº†æ¯æ¬¡è°ƒç”¨ getConnection(); æ‰“å¼€è¿æ¥ åˆ‡æ¢æ•°æ®æºï¼Œå¦‚æœæƒ³åŠ¨æ€æ·»åŠ çš„è¯ åªéœ€è¦é‡æ–° set targetDataSources å†è°ƒç”¨ afterPropertiesSet() å³å¯ Talk is cheap. Show me the codeæˆ‘ä½¿ç”¨çš„springbootç‰ˆæœ¬ä¸º 1.5.xï¼Œä¸‹é¢æ˜¯æ ¸å¿ƒä»£ç å®Œæ•´ä»£ç ï¼šhttps://gitee.com/yintianwen7/spring-dynamic-datasource123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778/** * å¤šæ•°æ®æºé…ç½® * * @author Taven * */@Configuration@MapperScan("com.gitee.taven.mapper")public class DataSourceConfigurer &#123; /** * DataSource è‡ªåŠ¨é…ç½®å¹¶æ³¨å†Œ * * @return data source */ @Bean("db0") @Primary @ConfigurationProperties(prefix = "datasource.db0") public DataSource dataSource0() &#123; return DruidDataSourceBuilder.create().build(); &#125; /** * DataSource è‡ªåŠ¨é…ç½®å¹¶æ³¨å†Œ * * @return data source */ @Bean("db1") @ConfigurationProperties(prefix = "datasource.db1") public DataSource dataSource1() &#123; return DruidDataSourceBuilder.create().build(); &#125; /** * æ³¨å†ŒåŠ¨æ€æ•°æ®æº * * @return */ @Bean("dynamicDataSource") public DataSource dynamicDataSource() &#123; DynamicRoutingDataSource dynamicRoutingDataSource = new DynamicRoutingDataSource(); Map&lt;Object, Object&gt; dataSourceMap = new HashMap&lt;&gt;(); dataSourceMap.put("dynamic_db0", dataSource0()); dataSourceMap.put("dynamic_db1", dataSource1()); dynamicRoutingDataSource.setDefaultTargetDataSource(dataSource0());// è®¾ç½®é»˜è®¤æ•°æ®æº dynamicRoutingDataSource.setTargetDataSources(dataSourceMap); return dynamicRoutingDataSource; &#125; /** * Sql session factory bean. * Here to config datasource for SqlSessionFactory * &lt;p&gt; * You need to add @&#123;@code @ConfigurationProperties(prefix = "mybatis")&#125;, if you are using *.xml file, * the &#123;@code 'mybatis.type-aliases-package'&#125; and &#123;@code 'mybatis.mapper-locations'&#125; should be set in * &#123;@code 'application.properties'&#125; file, or there will appear invalid bond statement exception * * @return the sql session factory bean */ @Bean @ConfigurationProperties(prefix = "mybatis") public SqlSessionFactoryBean sqlSessionFactoryBean() &#123; SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean(); // å¿…é¡»å°†åŠ¨æ€æ•°æ®æºæ·»åŠ åˆ° sqlSessionFactoryBean sqlSessionFactoryBean.setDataSource(dynamicDataSource()); return sqlSessionFactoryBean; &#125; /** * äº‹åŠ¡ç®¡ç†å™¨ * * @return the platform transaction manager */ @Bean public PlatformTransactionManager transactionManager() &#123; return new DataSourceTransactionManager(dynamicDataSource()); &#125;&#125; é€šè¿‡ ThreadLocal è·å–çº¿ç¨‹å®‰å…¨çš„æ•°æ®æº key12345678910111213141516171819202122232425262728293031323334353637package com.gitee.taven.config;public class DynamicDataSourceContextHolder &#123; private static final ThreadLocal&lt;String&gt; contextHolder = new ThreadLocal&lt;String&gt;() &#123; @Override protected String initialValue() &#123; return "dynamic_db0"; &#125; &#125;; /** * To switch DataSource * * @param key the key */ public static void setDataSourceKey(String key) &#123; contextHolder.set(key); &#125; /** * Get current DataSource * * @return data source key */ public static String getDataSourceKey() &#123; return contextHolder.get(); &#125; /** * To set DataSource as default */ public static void clearDataSourceKey() &#123; contextHolder.remove(); &#125;&#125; åŠ¨æ€ æ·»åŠ ã€åˆ‡æ¢æ•°æ®æº123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081/** * åŠ¨æ€æ•°æ®æº * * @author Taven * */public class DynamicRoutingDataSource extends AbstractRoutingDataSource &#123; private final Logger logger = LoggerFactory.getLogger(getClass()); private static Map&lt;Object, Object&gt; targetDataSources = new HashMap&lt;&gt;(); /** * è®¾ç½®å½“å‰æ•°æ®æº * * @return */ @Override protected Object determineCurrentLookupKey() &#123; logger.info("Current DataSource is [&#123;&#125;]", DynamicDataSourceContextHolder.getDataSourceKey()); return DynamicDataSourceContextHolder.getDataSourceKey(); &#125; @Override public void setTargetDataSources(Map&lt;Object, Object&gt; targetDataSources) &#123; super.setTargetDataSources(targetDataSources); DynamicRoutingDataSource.targetDataSources = targetDataSources; &#125; /** * æ˜¯å¦å­˜åœ¨å½“å‰keyçš„ DataSource * * @param key * @return å­˜åœ¨è¿”å› true, ä¸å­˜åœ¨è¿”å› false */ public static boolean isExistDataSource(String key) &#123; return targetDataSources.containsKey(key); &#125; /** * åŠ¨æ€å¢åŠ æ•°æ®æº * * @param map æ•°æ®æºå±æ€§ * @return */ public synchronized boolean addDataSource(Map&lt;String, String&gt; map) &#123; try &#123; Connection connection = null; // æ’é™¤è¿æ¥ä¸ä¸Šçš„é”™è¯¯ try &#123; Class.forName(map.get(DruidDataSourceFactory.PROP_DRIVERCLASSNAME)); connection = DriverManager.getConnection( map.get(DruidDataSourceFactory.PROP_URL), map.get(DruidDataSourceFactory.PROP_USERNAME), map.get(DruidDataSourceFactory.PROP_PASSWORD)); System.out.println(connection.isClosed()); &#125; catch (Exception e) &#123; return false; &#125; finally &#123; if (connection != null &amp;&amp; !connection.isClosed()) connection.close(); &#125; String database = map.get("database");//è·å–è¦æ·»åŠ çš„æ•°æ®åº“å if (StringUtils.isBlank(database)) return false; if (DynamicRoutingDataSource.isExistDataSource(database)) return true; DruidDataSource druidDataSource = (DruidDataSource) DruidDataSourceFactory.createDataSource(map); druidDataSource.init(); Map&lt;Object, Object&gt; targetMap = DynamicRoutingDataSource.targetDataSources; targetMap.put(database, druidDataSource); // å½“å‰ targetDataSources ä¸ çˆ¶ç±» targetDataSources ä¸ºåŒä¸€å¯¹è±¡ æ‰€ä»¥ä¸éœ€è¦set// this.setTargetDataSources(targetMap); this.afterPropertiesSet(); logger.info("dataSource &#123;&#125; has been added", database); &#125; catch (Exception e) &#123; logger.error(e.getMessage()); return false; &#125; return true; &#125; &#125; å¯ä»¥é€šè¿‡ AOP æˆ–è€… æ‰‹åŠ¨ DynamicDataSourceContextHolder.setDataSourceKey(String key) åˆ‡æ¢æ•°æ®æº éœ€è¦æ³¨æ„çš„ï¼šå½“æˆ‘ä»¬å¼€å¯äº†äº‹åŠ¡ä¹‹åï¼Œæ˜¯æ— æ³•åœ¨å»åˆ‡æ¢æ•°æ®æºçš„ æœ¬æ–‡é¡¹ç›®æºç ï¼šhttps://gitee.com/yintianwen7/spring-dynamic-datasourceå‚è€ƒæ–‡çŒ®ï¼šhttps://github.com/helloworlde/SpringBoot-DynamicDataSource]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>å¤šæ•°æ®æº</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Service è°ƒç”¨å½“å‰ç±»æ–¹æ³•äº‹åŠ¡ä¸ç”Ÿæ•ˆ]]></title>
    <url>%2Fpost%2Ff2e584e4.html</url>
    <content type="text"><![CDATA[ä»Šå¤©åœ¨æµ‹è¯•æ¡†æ¶çš„æ—¶å€™ï¼Œæˆ‘æƒ³åœ¨ä¸€ä¸ªserviceç±»çš„æ–¹æ³•ä¸­è°ƒç”¨ å½“å‰ç±»çš„å¦ä¸€ä¸ªæ–¹æ³•ï¼ˆè¯¥æ–¹æ³•é€šè¿‡@Transactionalå¼€å¯äº‹åŠ¡ï¼‰ï¼Œè¿™æ—¶å€™å‘ç°è¢«è°ƒç”¨ç±»çš„äº‹åŠ¡å¹¶æ²¡æœ‰ç”Ÿæ•ˆã€‚ 1234567891011public boolean test1() &#123; // xxx ä¸šåŠ¡é€»è¾‘ return test2();&#125;@Transactionalpublic boolean test2() &#123; testMapper.insertSalary(&quot;test&quot;, UUID.randomUUID().toString()); int a = 10/0; return true;&#125; WHY? æœç´¢å¼•æ“ä¸€ç•ªæŸ¥è¯¢ä¹‹åï¼Œäº†è§£åˆ°é—®é¢˜çš„å…³é”®ï¼š@Transactional æ˜¯åŸºäºaopç”Ÿçš„ä»£ç†å¯¹è±¡å¼€å¯äº‹åŠ¡çš„PS:ä¸äº†è§£ä»£ç†æ¨¡å¼çš„å°ä¼™ä¼´ï¼Œç»“å°¾æœ‰ä¼ é€é—¨ æ€è·¯ spring çš„äº‹åŠ¡æ˜¯é€šè¿‡ aop ç®¡ç†çš„ aop ä¼šé€šè¿‡åŠ¨æ€ä»£ç† ä¸ºæˆ‘ä»¬ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œaop çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚äº‹åŠ¡ï¼‰éƒ½æ˜¯åœ¨ä»£ç†å¯¹è±¡ä¸­å®ç°çš„ aop ç”Ÿæˆçš„ä»£ç†ç±»åˆåœ¨ spring å®¹å™¨ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦åœ¨ spring å®¹å™¨ä¸­æ‹¿åˆ°å½“å‰è¿™ä¸ªbean å†å»è°ƒç”¨ test2() å°±å¯ä»¥å¼€å¯äº‹åŠ¡äº†ã€‚ è§£å†³123456789101112131415161718192021222324252627282930313233343536373839404142import org.springframework.beans.BeansException;import org.springframework.context.ApplicationContext;import org.springframework.context.ApplicationContextAware;import org.springframework.stereotype.Component;/** * Springçš„ApplicationContextçš„æŒæœ‰è€…,å¯ä»¥ç”¨é™æ€æ–¹æ³•çš„æ–¹å¼è·å–springå®¹å™¨ä¸­çš„bean * */@Componentpublic class SpringContextHolder implements ApplicationContextAware &#123; private static ApplicationContext applicationContext; @Override public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123; SpringContextHolder.applicationContext = applicationContext; &#125; public static ApplicationContext getApplicationContext() &#123; assertApplicationContext(); return applicationContext; &#125; @SuppressWarnings("unchecked") public static &lt;T&gt; T getBean(String beanName) &#123; assertApplicationContext(); return (T) applicationContext.getBean(beanName); &#125; public static &lt;T&gt; T getBean(Class&lt;T&gt; requiredType) &#123; assertApplicationContext(); return applicationContext.getBean(requiredType); &#125; private static void assertApplicationContext() &#123; if (SpringContextHolder.applicationContext == null) &#123; throw new RuntimeException("applicaitonContextå±æ€§ä¸ºnull,è¯·æ£€æŸ¥æ˜¯å¦æ³¨å…¥äº†SpringContextHolder!"); &#125; &#125;&#125; 123456789101112public boolean test1() &#123; // xxx ä¸šåŠ¡é€»è¾‘ // åœ¨springå®¹å™¨ä¸­ è·å–å½“å‰ç±»çš„ä»£ç†ç±» return SpringContextHolder.getBean(TestS.class).test2();&#125;@Transactionalpublic boolean test2() &#123; testMapper.insertSalary(&quot;test&quot;, UUID.randomUUID().toString()); int a = 10/0; return true;&#125; okï¼æå®šï¼ ä¼ é€é—¨Spring AOPçš„å®ç°åŸç†Java ä»£ç†æ¨¡å¼]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>AOP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[(è½¬)Java ä»£ç†æ¨¡å¼]]></title>
    <url>%2Fpost%2F4dd31fbe.html</url>
    <content type="text"><![CDATA[åŸæ–‡ï¼šhttps://www.cnblogs.com/cenyu/p/6289209.html ä»£ç†(Proxy)æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡è®¿é—®ç›®æ ‡å¯¹è±¡.è¿™æ ·åšçš„å¥½å¤„æ˜¯:å¯ä»¥åœ¨ç›®æ ‡å¯¹è±¡å®ç°çš„åŸºç¡€ä¸Šï¼Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚ ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ï¼šå‡å¦‚è¯´æˆ‘ç°åœ¨æƒ³ä¹°ä¸€è¾†äºŒæ‰‹è½¦ï¼Œæœ€ä¾¿æ·çš„æ–¹æ³•ä¸€å®šæ˜¯æˆ‘å»æ‰¾ä¸­ä»‹ï¼Œä»–ä»¬æ¥ç»™æˆ‘åšçç¢çš„äº‹æƒ…ï¼Œæˆ‘åªæ˜¯è´Ÿè´£é€‰æ‹©è‡ªå·±å–œæ¬¢çš„è½¦ï¼Œç„¶åä»˜é’±å°±å¯ä»¥äº†ã€‚ ä»£ç†å¯¹è±¡æ˜¯å¯¹ç›®æ ‡å¯¹è±¡çš„æ‰©å±•,å¹¶ä¼šè°ƒç”¨ç›®æ ‡å¯¹è±¡ é™æ€ä»£ç†12345public interface IUserDao &#123; void save(); &#125; 12345678public class UserDao implements IUserDao &#123; @Override public void save() &#123; System.out.println(&quot;----å·²ç»ä¿å­˜æ•°æ®!----&quot;); &#125;&#125; 12345678910111213141516public class UserDaoProxy implements IUserDao &#123; //ç›®æ ‡å¯¹è±¡ private IUserDao target; public UserDaoProxy(IUserDao target)&#123; this.target=target; &#125; @Override public void save() &#123; System.out.println(&quot;å¼€å§‹äº‹åŠ¡...&quot;); target.save();//æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³• System.out.println(&quot;æäº¤äº‹åŠ¡...&quot;); &#125;&#125; 12345678@Testpublic void staticProxy() &#123; //ç›®æ ‡å¯¹è±¡ UserDao target = new UserDao(); //ä»£ç†å¯¹è±¡ï¼Œå»ºç«‹ä»£ç†å…³ç³» UserDaoProxy proxy = new UserDaoProxy(target); proxy.save();//æ‰§è¡Œçš„æ˜¯ä»£ç†çš„æ–¹æ³•&#125; é™æ€ä»£ç†çš„ç¼ºç‚¹ï¼šæ¥å£æ–°å¢æ–¹æ³•æ—¶ï¼Œç±»è¿‡å¤šæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ï¼Œè¿‡äºç¹çï¼Œä½†æ˜¯é€šè¿‡åŠ¨æ€ä»£ç†æœºåˆ¶å¯ä»¥è§£å†³è¿™ä¸€é—®é¢˜ã€‚ åŠ¨æ€ä»£ç†spring ä¸­ AOP é€šè¿‡ åŠ¨æ€ä»£ç† åœ¨è¿è¡Œæ—¶ä¸ºæˆ‘ä»¬çš„ä»£ç å¢å¼ºï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨å¼€å‘çš„æ—¶å€™åªéœ€è¦åšä¸šåŠ¡é€»è¾‘ï¼ŒAOP é€šè¿‡åŠ¨æ€ä»£ç†å¯ä»¥ä¸ºæˆ‘ä»¬åšäº‹åŠ¡ï¼Œæ—¥å¿—ç®¡ç†ï¼Œæƒé™æ ¡éªŒç­‰ç­‰ã€‚ jdk åŠ¨æ€ä»£ç†æˆ‘ä»¬ä¸éœ€è¦å†å»æ‰‹åŠ¨åˆ›å»ºä»£ç†ç±»ï¼ˆä½†æ˜¯è¦æ±‚è¢«ä»£ç†ç±»å¿…é¡»å®ç°ä¸€ä¸ªæ¥å£ï¼‰ï¼Œåªéœ€è¦åšä¸€ä¸ªåŠ¨æ€ä»£ç†å·¥å‚å³å¯ï¼Œjdké€šè¿‡åå°„ä¸ºæˆ‘ä»¬åœ¨å†…å­˜ä¸­åŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä»¥åŠåœ¨æ–¹æ³•æ‰§è¡Œçš„å‰åæ·»åŠ é€šçŸ¥ã€‚1234567891011121314151617181920212223242526272829303132333435import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;/** * åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡ * */public class JdkProxyFactory&#123; //ç»´æŠ¤ä¸€ä¸ªç›®æ ‡å¯¹è±¡ private Object target; public JdkProxyFactory(Object target)&#123; this.target=target; &#125; //ç»™ç›®æ ‡å¯¹è±¡ç”Ÿæˆä»£ç†å¯¹è±¡ public Object getProxyInstance()&#123; return Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), new InvocationHandler() &#123; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; System.out.println("å¼€å§‹äº‹åŠ¡2"); //æ‰§è¡Œç›®æ ‡å¯¹è±¡æ–¹æ³• Object returnValue = method.invoke(target, args); System.out.println("æäº¤äº‹åŠ¡2"); return returnValue; &#125; &#125; ); &#125;&#125; 123456789101112131415@Testpublic void jdkProxy() &#123; // ç›®æ ‡å¯¹è±¡ IUserDao target = new UserDao(); // åŸå§‹ç±»å‹ System.out.println(&quot;åŸå§‹ç±»å‹&quot; + target.getClass()); // ç»™ç›®æ ‡å¯¹è±¡ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡ IUserDao proxy = (IUserDao) new JdkProxyFactory(target).getProxyInstance(); // class $Proxy0 å†…å­˜ä¸­åŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ System.out.println(&quot;åŠ¨æ€ä»£ç†åå¯¹è±¡ç±»å‹:&quot; + proxy.getClass()); // ä»£ç†å¯¹è±¡ æ‰§è¡Œæ–¹æ³• proxy.save();&#125; æ‰§è¡Œæµ‹è¯•æ–¹æ³•12345åŸå§‹ç±»å‹class com.example.demo.original_code.UserDaoåŠ¨æ€ä»£ç†åå¯¹è±¡ç±»å‹:class com.sun.proxy.$Proxy4å¼€å§‹äº‹åŠ¡2----å·²ç»ä¿å­˜æ•°æ®!----æäº¤äº‹åŠ¡2 cglib åŠ¨æ€ä»£ç†é™æ€ä»£ç† å’Œ jdkä»£ç† è¦æ±‚ç›®æ ‡å¯¹è±¡å¿…é¡»å®ç°æ¥å£ï¼Œè€Œ cglib åŠ¨æ€ä»£ç†æ— éœ€å®ç°æ¥å£ã€‚cglib ä¼šåŠ¨æ€ä¸ºç›®æ ‡å¯¹è±¡ åˆ›å»ºä¸€ä¸ªå­ç±»å¯¹è±¡ã€‚ä½¿ç”¨é¡»çŸ¥ï¼š1.è¢«ä»£ç†çš„ç±»ä¸èƒ½ä¸º final2.è¢«ä»£ç†ç±»çš„æ–¹æ³• ä¸èƒ½ä¸º final/staticï¼Œå¦åˆ™æ— æ³•è¢«æ‹¦æˆª12345678910111213141516171819202122232425262728293031323334353637383940414243import java.lang.reflect.Method;import org.springframework.cglib.proxy.Enhancer;import org.springframework.cglib.proxy.MethodInterceptor;import org.springframework.cglib.proxy.MethodProxy;/** * Cglibå­ç±»ä»£ç†å·¥å‚ * å¯¹UserDaoåœ¨å†…å­˜ä¸­åŠ¨æ€æ„å»ºä¸€ä¸ªå­ç±»å¯¹è±¡ */public class CglibProxyFactory implements MethodInterceptor &#123; //ç»´æŠ¤ç›®æ ‡å¯¹è±¡ private Object target; public CglibProxyFactory(Object target) &#123; this.target = target; &#125; //ç»™ç›®æ ‡å¯¹è±¡åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ public Object getProxyInstance()&#123; //1.å·¥å…·ç±» Enhancer en = new Enhancer(); //2.è®¾ç½®çˆ¶ç±» en.setSuperclass(target.getClass()); //3.è®¾ç½®å›è°ƒå‡½æ•° en.setCallback(this); //4.åˆ›å»ºå­ç±»(ä»£ç†å¯¹è±¡) return en.create(); &#125; @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable &#123; System.out.println("å¼€å§‹äº‹åŠ¡..."); //æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³• Object returnValue = method.invoke(target, args); System.out.println("æäº¤äº‹åŠ¡..."); return returnValue; &#125;&#125; 1234567891011@Testpublic void cglibProxy() &#123; //ç›®æ ‡å¯¹è±¡ UserDao target = new UserDao(); //ä»£ç†å¯¹è±¡ UserDao proxy = (UserDao) new CglibProxyFactory(target).getProxyInstance(); //æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³• proxy.save();&#125;]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-æŸ¥è¯¢æ ‘ç»“æ„]]></title>
    <url>%2Fpost%2Fa998078e.html</url>
    <content type="text"><![CDATA[åœ¨ oracle æ•°æ®åº“ä¸­ï¼Œé€šè¿‡ start with connect by prior é€’å½’å¯ä»¥ç›´æ¥æŸ¥å‡ºæ ‘ç»“æ„ï¼Œä½†æ˜¯åœ¨ mysql å½“ä¸­å¦‚ä½•è§£å†³æ ‘æŸ¥è¯¢é—®é¢˜å‘¢ï¼Ÿ #####æ€è·¯ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰å‡½æ•°ï¼Œéå†æ‰¾å‡ºæŸä¸€èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ ï¼ˆæˆ–è€…æŸä¸€èŠ‚ç‚¹çš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹ï¼‰çš„å­—ç¬¦ä¸²é›†åˆã€‚ç„¶åé€šè¿‡ FIND_IN_SET å‡½æ•°ï¼Œè¿™å°±æŸ¥å‡ºäº†æˆ‘ä»¬æƒ³è¦çš„æ ‘ #####å®è·µï¼š1ï¼‰å»ºè¡¨ ä»¥åŠ æµ‹è¯•æ•°æ®å‡†å¤‡123456CREATE TABLE `tree` ( `id` int(11) NOT NULL, `pid` int(11) DEFAULT NULL, `name` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8; 12345678INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;1&apos;, NULL, &apos;ä¸€çº§&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;2&apos;, &apos;1&apos;, &apos;äºŒçº§1&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;3&apos;, &apos;2&apos;, &apos;ä¸‰çº§1&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;4&apos;, &apos;3&apos;, &apos;å››çº§1&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;5&apos;, &apos;4&apos;, &apos;äº”çº§&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;6&apos;, &apos;1&apos;, &apos;ä¸‰çº§2&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;7&apos;, &apos;1&apos;, &apos;äºŒçº§2&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;8&apos;, &apos;6&apos;, &apos;å››çº§2&apos;); 2ï¼‰æŸ¥è¯¢ æŸèŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹12345678910111213CREATE FUNCTION `GET_CHILD_NODE`(rootId varchar(100)) RETURNS varchar(2000) BEGIN DECLARE str varchar(2000); DECLARE cid varchar(100); SET str = &apos;$&apos;; SET cid = rootId; WHILE cid is not null DO SET str = concat(str, &apos;,&apos;, cid); SELECT group_concat(id) INTO cid FROM tree where FIND_IN_SET(pid, cid); END WHILE; RETURN str; END ç¬¬ä¸€æ¬¡è¿›å…¥å‡½æ•° cid ä¸ºæ ¹èŠ‚ç‚¹ï¼Œå¼€å§‹å¾ªç¯åï¼Œcid ä¸ºæ¯æ¬¡æŸ¥è¯¢ç»“æœé›† ï¼ˆä¹Ÿå°±æ˜¯å­èŠ‚ç‚¹ï¼‰ï¼Œä¸‹ä¸€æ¬¡ä¼šæŸ¥è¯¢å‡ºæ‰€æœ‰å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ â€¦ ä»¥æ­¤ç±»æ¨ï¼Œå½“æ²¡æœ‰å­èŠ‚ç‚¹æ—¶é€€å‡ºå¾ªç¯ï¼Œä¹Ÿå°±å¾—åˆ°äº†æ‰€æœ‰çš„èŠ‚ç‚¹ã€‚12345678910mysql&gt; SELECT * from tree where FIND_IN_SET(id, GET_CHILD_NODE(2));+----+-----+-------+| id | pid | name |+----+-----+-------+| 2 | 1 | äºŒçº§1 || 3 | 2 | ä¸‰çº§1 || 4 | 3 | å››çº§1 || 5 | 4 | äº”çº§ |+----+-----+-------+4 rows in set å†é€šè¿‡è¿™äº›èŠ‚ç‚¹ ç­›é€‰ï¼Œok ! 3ï¼‰æŸ¥è¯¢ æŸèŠ‚ç‚¹çš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹1234567891011121314151617CREATE FUNCTION `GET_PARENT_NODE`(rootId varchar(100)) RETURNS varchar(1000) BEGIN DECLARE fid varchar(100) default &apos;&apos;; DECLARE str varchar(1000) default rootId; WHILE rootId is not null do SET fid =(SELECT pid FROM tree WHERE id = rootId); IF fid is not null THEN SET str = concat(str, &apos;,&apos;, fid); SET rootId = fid; ELSE SET rootId = fid; END IF; END WHILE; return str; END å’Œä¸Šä¸€ä¸ªå‡½æ•°ç±»ä¼¼ï¼Œä¸æ–­çš„éå†å»æ‰¾ çˆ¶idï¼Œç„¶åæ‹¼æ¥åˆ°å­—ç¬¦ä¸²ä¸­ï¼Œä¸ºç©ºé€€å‡ºå¾ªç¯ã€‚1234567891011mysql&gt; select * from tree where FIND_IN_SET(id, GET_PARENT_NODE(5));+----+------+-------+| id | pid | name |+----+------+-------+| 1 | NULL | ä¸€çº§ || 2 | 1 | äºŒçº§1 || 3 | 2 | ä¸‰çº§1 || 4 | 3 | å››çº§1 || 5 | 4 | äº”çº§ |+----+------+-------+5 rows in set]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ·±å…¥ç†è§£ Dijkstra ç®—æ³•å®ç°åŸç†]]></title>
    <url>%2Fpost%2F9186820e.html</url>
    <content type="text"><![CDATA[è¿ªæ°æ–¯ç‰¹æ‹‰(Dijkstra)ç®—æ³•æ˜¯å…¸å‹æœ€çŸ­è·¯å¾„ç®—æ³•ï¼Œç”¨äºè®¡ç®—ä¸€ä¸ªèŠ‚ç‚¹åˆ°å…¶ä»–èŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„ã€‚å®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ä»¥èµ·å§‹ç‚¹ä¸ºä¸­å¿ƒå‘å¤–å±‚å±‚æ‰©å±•(å¹¿åº¦ä¼˜å…ˆæœç´¢æ€æƒ³)ï¼Œç›´åˆ°æ‰©å±•åˆ°ç»ˆç‚¹ä¸ºæ­¢ã€‚ ï¼ˆå—¯ï¼Œç¬¬ä¸€æ®µæ˜¯æŠ„çš„ï¼Œç”±äºæœ¬äººç®—æ³•çš„åŸºç¡€æ¯”è¾ƒè–„å¼±ï¼Œæˆ‘ä¼šå°½é‡ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€æ¥è®©å¤§å®¶ç†è§£æœ¬æ–‡ï¼‰ å‚è€ƒåšå®¢:æ•°æ®ç»“æ„â€“Dijkstraç®—æ³•æœ€æ¸…æ¥šçš„è®²è§£ å¤§æ¦‚å°±æ˜¯è¿™æ ·ä¸€ä¸ªæœ‰æƒå›¾ï¼ŒDijkstraç®—æ³•å¯ä»¥è®¡ç®—ä»»æ„èŠ‚ç‚¹åˆ°å…¶ä»–èŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„ ç®—æ³•æ€è·¯ æŒ‡å®šä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¾‹å¦‚æˆ‘ä»¬è¦è®¡ç®— â€˜Aâ€™ åˆ°å…¶ä»–èŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„ å¼•å…¥ä¸¤ä¸ªé›†åˆï¼ˆSã€Uï¼‰ï¼ŒSé›†åˆåŒ…å«å·²æ±‚å‡ºçš„æœ€çŸ­è·¯å¾„çš„ç‚¹ï¼ˆä»¥åŠç›¸åº”çš„æœ€çŸ­é•¿åº¦ï¼‰ï¼ŒUé›†åˆåŒ…å«æœªæ±‚å‡ºæœ€çŸ­è·¯å¾„çš„ç‚¹ï¼ˆä»¥åŠAåˆ°è¯¥ç‚¹çš„è·¯å¾„ï¼Œæ³¨æ„ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒA-&gt;Cç”±äºæ²¡æœ‰ç›´æ¥ç›¸è¿ åˆå§‹æ—¶ä¸ºâˆï¼‰ åˆå§‹åŒ–ä¸¤ä¸ªé›†åˆï¼ŒSé›†åˆåˆå§‹æ—¶ åªæœ‰å½“å‰è¦è®¡ç®—çš„èŠ‚ç‚¹ï¼ŒA-&gt;A = 0ï¼ŒUé›†åˆåˆå§‹æ—¶ä¸º A-&gt;B = 4, A-&gt;C = âˆ, A-&gt;D = 2, A-&gt;E = âˆï¼Œæ•²é»‘æ¿ï¼ï¼ï¼æ¥ä¸‹æ¥è¦è¿›è¡Œæ ¸å¿ƒä¸¤æ­¥éª¤äº† ä»Ué›†åˆä¸­æ‰¾å‡ºè·¯å¾„æœ€çŸ­çš„ç‚¹ï¼ŒåŠ å…¥Sé›†åˆï¼Œä¾‹å¦‚ A-&gt;D = 2 æ›´æ–°Ué›†åˆè·¯å¾„ï¼Œif ( &#39;D åˆ° B,C,E çš„è·ç¦»&#39; + &#39;AD è·ç¦»&#39; &lt; &#39;A åˆ° B,C,E çš„è·ç¦»&#39; ) åˆ™æ›´æ–°U å¾ªç¯æ‰§è¡Œ 4ã€5 ä¸¤æ­¥éª¤ï¼Œç›´è‡³éå†ç»“æŸï¼Œå¾—åˆ°A åˆ°å…¶ä»–èŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„ç®—æ³•å›¾è§£1.é€‰å®šAèŠ‚ç‚¹å¹¶åˆå§‹åŒ–ï¼Œå¦‚ä¸Šè¿°æ­¥éª¤3æ‰€ç¤º 2.æ‰§è¡Œä¸Šè¿° 4ã€5ä¸¤æ­¥éª¤ï¼Œæ‰¾å‡ºUé›†åˆä¸­è·¯å¾„æœ€çŸ­çš„èŠ‚ç‚¹D åŠ å…¥Sé›†åˆï¼Œå¹¶æ ¹æ®æ¡ä»¶ if ( &#39;D åˆ° B,C,E çš„è·ç¦»&#39; + &#39;AD è·ç¦»&#39; &lt; &#39;A åˆ° B,C,E çš„è·ç¦»&#39; ) æ¥æ›´æ–°Ué›†åˆ 3.è¿™æ—¶å€™ A-&gt;B, A-&gt;C éƒ½ä¸º3ï¼Œæ²¡å…³ç³»ã€‚å…¶å®è¿™æ—¶å€™ä»–ä¿©éƒ½æ˜¯æœ€çŸ­è·ç¦»ï¼Œå¦‚æœä»ç®—æ³•é€»è¾‘æ¥è®²çš„è¯ï¼Œä¼šå…ˆå–åˆ°Bç‚¹ã€‚è€Œè¿™ä¸ªæ—¶å€™ if æ¡ä»¶å˜æˆäº† if ( &#39;B åˆ° C,E çš„è·ç¦»&#39; + &#39;AB è·ç¦»&#39; &lt; &#39;A åˆ° C,E çš„è·ç¦»&#39; ) ï¼Œå¦‚å›¾æ‰€ç¤ºè¿™æ—¶å€™A-&gt;Bè·ç¦» å…¶å®ä¸º A-&gt;D-&gt;B æ€è·¯å°±æ˜¯è¿™æ ·ï¼Œå¾€åå°±æ˜¯å¤§åŒå°å¼‚äº† ç®—æ³•ç»“æŸ ä»£ç å®ç°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public class Dijkstra &#123; public static final int M = 10000; // ä»£è¡¨æ­£æ— ç©· public static void main(String[] args) &#123; // äºŒç»´æ•°ç»„æ¯ä¸€è¡Œåˆ†åˆ«æ˜¯ Aã€Bã€Cã€Dã€E å„ç‚¹åˆ°å…¶ä½™ç‚¹çš„è·ç¦», // A -&gt; A è·ç¦»ä¸º0, å¸¸é‡M ä¸ºæ­£æ— ç©· int[][] weight1 = &#123; &#123;0,4,M,2,M&#125;, &#123;4,0,4,1,M&#125;, &#123;M,4,0,1,3&#125;, &#123;2,1,1,0,7&#125;, &#123;M,M,3,7,0&#125; &#125;; int start = 0; int[] shortPath = dijkstra(weight1, start); for (int i = 0; i &lt; shortPath.length; i++) System.out.println(&quot;ä»&quot; + start + &quot;å‡ºå‘åˆ°&quot; + i + &quot;çš„æœ€çŸ­è·ç¦»ä¸ºï¼š&quot; + shortPath[i]); &#125; public static int[] dijkstra(int[][] weight, int start) &#123; // æ¥å—ä¸€ä¸ªæœ‰å‘å›¾çš„æƒé‡çŸ©é˜µï¼Œå’Œä¸€ä¸ªèµ·ç‚¹ç¼–å·startï¼ˆä»0ç¼–å·ï¼Œé¡¶ç‚¹å­˜åœ¨æ•°ç»„ä¸­ï¼‰ // è¿”å›ä¸€ä¸ªint[] æ•°ç»„ï¼Œè¡¨ç¤ºä»startåˆ°å®ƒçš„æœ€çŸ­è·¯å¾„é•¿åº¦ int n = weight.length; // é¡¶ç‚¹ä¸ªæ•° int[] shortPath = new int[n]; // ä¿å­˜startåˆ°å…¶ä»–å„ç‚¹çš„æœ€çŸ­è·¯å¾„ String[] path = new String[n]; // ä¿å­˜startåˆ°å…¶ä»–å„ç‚¹æœ€çŸ­è·¯å¾„çš„å­—ç¬¦ä¸²è¡¨ç¤º for (int i = 0; i &lt; n; i++) path[i] = new String(start + &quot;--&gt;&quot; + i); int[] visited = new int[n]; // æ ‡è®°å½“å‰è¯¥é¡¶ç‚¹çš„æœ€çŸ­è·¯å¾„æ˜¯å¦å·²ç»æ±‚å‡º,1è¡¨ç¤ºå·²æ±‚å‡º // åˆå§‹åŒ–ï¼Œç¬¬ä¸€ä¸ªé¡¶ç‚¹å·²ç»æ±‚å‡º shortPath[start] = 0; visited[start] = 1; for (int count = 1; count &lt; n; count++) &#123; // è¦åŠ å…¥n-1ä¸ªé¡¶ç‚¹ int k = -1; // é€‰å‡ºä¸€ä¸ªè·ç¦»åˆå§‹é¡¶ç‚¹startæœ€è¿‘çš„æœªæ ‡è®°é¡¶ç‚¹ int dmin = Integer.MAX_VALUE; for (int i = 0; i &lt; n; i++) &#123; if (visited[i] == 0 &amp;&amp; weight[start][i] &lt; dmin) &#123; dmin = weight[start][i]; k = i; &#125; &#125; // å°†æ–°é€‰å‡ºçš„é¡¶ç‚¹æ ‡è®°ä¸ºå·²æ±‚å‡ºæœ€çŸ­è·¯å¾„ï¼Œä¸”åˆ°startçš„æœ€çŸ­è·¯å¾„å°±æ˜¯dmin shortPath[k] = dmin; visited[k] = 1; // ä»¥kä¸ºä¸­é—´ç‚¹ï¼Œä¿®æ­£ä»startåˆ°æœªè®¿é—®å„ç‚¹çš„è·ç¦» for (int i = 0; i &lt; n; i++) &#123; //å¦‚æœ &apos;èµ·å§‹ç‚¹åˆ°å½“å‰ç‚¹è·ç¦»&apos; + &apos;å½“å‰ç‚¹åˆ°æŸç‚¹è·ç¦»&apos; &lt; &apos;èµ·å§‹ç‚¹åˆ°æŸç‚¹è·ç¦»&apos;, åˆ™æ›´æ–° if (visited[i] == 0 &amp;&amp; weight[start][k] + weight[k][i] &lt; weight[start][i]) &#123; weight[start][i] = weight[start][k] + weight[k][i]; path[i] = path[k] + &quot;--&gt;&quot; + i; &#125; &#125; &#125; for (int i = 0; i &lt; n; i++) &#123; System.out.println(&quot;ä»&quot; + start + &quot;å‡ºå‘åˆ°&quot; + i + &quot;çš„æœ€çŸ­è·¯å¾„ä¸ºï¼š&quot; + path[i]); &#125; System.out.println(&quot;=====================================&quot;); return shortPath; &#125; &#125;]]></content>
      <categories>
        <category>æŠ€æœ¯</category>
      </categories>
      <tags>
        <tag>ç®—æ³•</tag>
        <tag>Dijkstra</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot jacksonï¼ˆDateç±»å‹å…¥å‚ã€æ ¼å¼åŒ–ï¼Œä»¥åŠå¦‚ä½•å¤„ç†nullï¼‰]]></title>
    <url>%2Fpost%2F23d9d33.html</url>
    <content type="text"><![CDATA[é¦–å…ˆï¼Œæˆ‘ä»¬è¦çŸ¥é“ springboot é»˜è®¤ä½¿ç”¨ jackson è§£æ jsonï¼ˆå½“ç„¶è¿™é‡Œä¹Ÿæ˜¯å¯ä»¥é…ç½®ä½¿ç”¨å…¶ä»– json è§£ææ¡†æ¶ï¼‰ã€‚åœ¨ä¸é…ç½®å…¶ä»– json è§£æçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ spring boot æä¾›çš„æ³¨è§£å’Œé…ç½® æ¥è®© jackson å¸®åŠ©æˆ‘ä»¬æé«˜å¼€å‘æ•ˆç‡ ä½¿ç”¨ @ResponseBody @RequestBodyï¼Œ Date ç±»å‹å¯¹è±¡å…¥å‚ï¼Œè¿”å›jsonæ ¼å¼åŒ–è§£å†³æ–¹æ³•å¦‚ä¸‹: 1. application.propertiesä¸­åŠ å…¥å¦‚ä¸‹ä»£ç 12spring.jackson.date-format=yyyy-MM-dd HH:mm:ssspring.jackson.time-zone=GMT+8 2. å¦‚æœä¸ªåˆ«å®ä½“éœ€è¦ä½¿ç”¨å…¶ä»–æ ¼å¼çš„ patternï¼Œåœ¨å®ä½“ä¸ŠåŠ å…¥æ³¨è§£å³å¯1234567import org.springframework.format.annotation.DateTimeFormat;import com.fasterxml.jackson.annotation.JsonFormat;public class MrType &#123; @JsonFormat(timezone = "GMT+8",pattern = "yyyy-MM-dd") @DateTimeFormat(pattern="yyyy-MM-dd") private Date createdDate;&#125; å…³äºspring boot æ—¶é—´ç±»å‹æ”¯æŒæˆ‘åšäº†ä»¥ä¸‹æµ‹è¯•ï¼š1) application.properties é…ç½®æ³¨é‡Šï¼Œä¸æ·»åŠ æ³¨è§£ï¼šspring æ— æ³•æ¥æ”¶æ—¶é—´å‚æ•°ï¼ˆ400ï¼‰ï¼Œjson è¾“å‡º &quot;2018-03-29T09:45:31.513+0000&quot;2) application.properties é…ç½®å¼€å¯ï¼Œä¸æ·»åŠ æ³¨è§£ï¼šä»…æ”¯æŒ yyyy-MM-dd HH:mm:ss çš„æ ¼å¼å‚æ•°å’Œ json è¾“å‡º3) application.properties é…ç½®å¼€å¯ï¼Œå®ä½“æ·»åŠ  @JsonFormat(pattern = &quot;yyyy-MM-dd&quot;)ï¼Œå®ä½“å¯æ¥å— yyyy-MM-dd HH:mm:ss å’Œ yyyy-MM-dd æ ¼å¼çš„å‚æ•°ï¼Œjsonè¾“å‡ºæ ¼å¼ä¸º yyyy-MM-ddï¼Œç”±æ­¤å¯è§@JsonFormatæ˜¯é™åˆ¶Date ç±»å‹ json è¾“å‡ºçš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå¯¹æ¥å—çš„ç±»å‹ä¹Ÿé€ æˆäº†å½±å“ï¼Ÿæœ‰å¾…è€ƒè¯4) application.properties é…ç½®å¼€å¯ï¼Œå®ä½“æ·»åŠ  @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)ï¼Œç»“æœä¸ç¬¬äºŒæ¡æµ‹è¯•ä¸€æ ·ï¼Ÿè²Œä¼¼@DateTimeFormat æ³¨è§£å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿæœ‰å¾…è€ƒè¯5) application.properties é…ç½®å¼€å¯ï¼Œå®ä½“æ·»åŠ  @JsonFormat å’Œ @DateTimeFormat ç»“æœä¸ç¬¬ä¸‰æ¡ä¸€æ · ç»“è®ºï¼šå®é™…é¡¹ç›®ä¸­ application.propertiesè®¾ç½®é€šç”¨æ—¶é—´æ ¼å¼ï¼Œä¸ªåˆ«å±æ€§éœ€è¦ç‰¹æ®Šå¤„ç†æ—¶ï¼Œæ·»åŠ @JsonFormatï¼ˆ@JsonFormat è‡ªå·±å¥½åƒå°±æŠŠè¿™ä»¶äº‹æå®šäº†ï¼‰ ä½¿ç”¨ @ResponseBody æ—¶ å¿½ç•¥ json ä¸­å€¼ä¸ºnullçš„å±æ€§1. application.propertiesä¸­åŠ å…¥å¦‚ä¸‹ä»£ç 1spring.jackson.default-property-inclusion=non-null æˆ–è€…åœ¨ç±»ä¸Šå£°æ˜@JsonInclude(JsonInclude.Include.NON_NULL) 1234567import java.io.Serializable;import com.fasterxml.jackson.annotation.JsonInclude;@JsonInclude(JsonInclude.Include.NON_NULL)//è¯¥æ³¨è§£é…åˆjacksonï¼Œåºåˆ—åŒ–æ—¶å¿½ç•¥ nullå±æ€§public class AjaxResult implements Serializable &#123;&#125;]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>jackson</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-å¹¶å‘ä¸‹ç”Ÿæˆä¸é‡å¤æµæ°´å·]]></title>
    <url>%2Fpost%2Fef3d0933.html</url>
    <content type="text"><![CDATA[æ›´æ–°äº 2018-12-23 22:21:44å‰è¨€ï¼šä¸€å¹´å‰çš„å†™çš„ï¼Œå½“æ—¶çš„åšæ³•å¹¶ä¸èƒ½åœ¨å¹¶å‘ä¸‹ä¿è¯æµæ°´å·çš„å”¯ä¸€æ€§ï¼Œå› ä¸ºå½“æ—¶å¹¶æ²¡æœ‰å†™å¤šçº¿ç¨‹æµ‹è¯•è¿‡â€¦ æ€è·¯ sCode sName sQz sValue order è®¢å• DD 18120100 é¦–å…ˆæ¯ä¸ªä¸šåŠ¡çš„æµæ°´å·å¯¹åº”è¡¨ä¸­çš„ä¸€æ¡æ•°æ® æ¯ä¸ªè¦è·å–æµæ°´å·çš„çº¿ç¨‹è°ƒç”¨ ä¸€ä¸ªç”¨æ¥ç”Ÿæˆæµæ°´å·çš„ å­˜å‚¨è¿‡ç¨‹ æ ¹æ®sCode æ‰¾åˆ° sValueã€‚1234if (sValue == null) åˆå§‹åŒ–å€¼ else sValue ++ æ•²é»‘æ¿ï¼åˆ’é‡ç‚¹ï¼ åˆ†æï¼šä¸Šè¿°çš„æ€è·¯çœ‹ä¼¼æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœä¸¤ä¸ªçº¿ç¨‹å¹¶å‘çš„æ‰§è¡Œä¼šå‡ºç°ä¸¤ä¸ªäº‹åŠ¡è¯»å–åˆ°ç›¸åŒçš„æ•°æ®ï¼ŒåŒæ—¶éƒ½æ‰§è¡Œåˆå§‹åŒ–æˆ–è€…è‡ªå¢ã€‚ æ–¹æ¡ˆï¼šä½¿ç”¨ MySQL å†™é”ï¼ˆselectâ€¦for updateï¼Œä¹Ÿå«Xé”ï¼Œæ’å®ƒé”ï¼‰ æ¥è§£å†³è¿™ä¸€é—®é¢˜ ä¾‹å¦‚ï¼šäº‹åŠ¡Aå’Œäº‹åŠ¡BåŒæ—¶è¿›è¡Œï¼Œäº‹åŠ¡A æ‹¿åˆ° å½“å‰è¿™æ¡æ•°æ®çš„å†™é”ï¼Œæ­¤æ—¶å¦‚æœäº‹åŠ¡B æƒ³è®¿é—®è¿™æ¡æ•°æ®éœ€è¦ç­‰å¾…äº‹åŠ¡Aç»“æŸã€‚å¹¶å‘æ—¶è®©ä¸¤ä¸ªäº‹åŠ¡å¯¹åŒä¸€æ¡æ•°æ®çš„æ“ä½œå˜æˆäº†ä¸²è¡ŒåŒ–ã€‚ 123456CREATE TABLE `sys_sno` ( `sCode` varchar(50) DEFAULT NULL COMMENT &apos;ç¼–ç &apos;, `sName` varchar(100) DEFAULT NULL COMMENT &apos;åç§°&apos;, `sQz` varchar(50) DEFAULT NULL COMMENT &apos;å‰ç¼€&apos;, `sValue` varchar(80) DEFAULT NULL COMMENT &apos;å€¼&apos;) ENGINE=InnoDB DEFAULT CHARSET=utf8; 123456789101112131415161718192021222324252627282930313233343536373839CREATE DEFINER=`root`@`localhost` PROCEDURE `GetSerialNo`(IN tsCode VARCHAR(50),OUT result VARCHAR(200) )BEGIN DECLARE tsValue VARCHAR(50); DECLARE tdToday VARCHAR(20); DECLARE nowdate VARCHAR(20); DECLARE tsQZ VARCHAR(50); DECLARE t_error INTEGER DEFAULT 0; DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET t_error=1; START TRANSACTION; /* UPDATE sys_sno SET sValue=sValue WHERE sCode=tsCode; */ SELECT sValue INTO tsValue FROM sys_sno WHERE sCode=tsCode for UPDATE; SELECT sQz INTO tsQZ FROM sys_sno WHERE sCode=tsCode ; -- å› å­è¡¨ä¸­æ²¡æœ‰è®°å½•ï¼Œæ’å…¥åˆå§‹å€¼ IF tsValue IS NULL THEN SELECT CONCAT(DATE_FORMAT(NOW(),&apos;%y%m&apos;),&apos;0001&apos;) INTO tsValue; UPDATE sys_sno SET sValue=tsValue WHERE sCode=tsCode ; SELECT CONCAT(tsQZ,tsValue) INTO result; ELSE SELECT SUBSTRING(tsValue,1,4) INTO tdToday; SELECT CONVERT(DATE_FORMAT(NOW(),&apos;%y%m&apos;),SIGNED) INTO nowdate; -- åˆ¤æ–­å¹´æœˆæ˜¯å¦éœ€è¦æ›´æ–° IF tdToday = nowdate THEN SET tsValue=CONVERT(tsValue,SIGNED) + 1; ELSE SELECT CONCAT(DATE_FORMAT(NOW(),&apos;%y%m&apos;) ,&apos;0001&apos;) INTO tsValue ; END IF; UPDATE sys_sno SET sValue =tsValue WHERE sCode=tsCode; SELECT CONCAT(tsQZ,tsValue) INTO result; END IF; IF t_error =1 THEN ROLLBACK; SET result = &apos;Error&apos;; ELSE COMMIT; END IF; SELECT result ; END; æµ‹è¯•ä»£ç å®Œæ•´æµ‹è¯•ä»£ç ï¼šhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/uni-number123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657import com.gitee.taven.uninumber.mapper.OrderMapper;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import java.util.HashMap;import java.util.Map;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;@Servicepublic class OrderService &#123; private static OrderMapper orderMapper; @Autowired public void setOrderMapper(OrderMapper orderMapper) &#123; this.orderMapper = orderMapper; &#125; private static final int TOTAL_THREADS = 100; public void multiThread() &#123; // åˆ›å»ºå›ºå®šé•¿åº¦çº¿ç¨‹æ±  ExecutorService fixedThreadPool = Executors.newFixedThreadPool(50); for (int i = 0; i &lt; TOTAL_THREADS; i++) &#123; Thread thread = new OrderThread(); fixedThreadPool.execute(thread); &#125; &#125; public static class OrderThread extends Thread &#123; @Override public void run() &#123; try &#123; Map&lt;String, String&gt; parameterMap = initParameterMap(); orderMapper.createOrderNum(parameterMap); String number = parameterMap.get(&quot;result&quot;); System.out.println(Thread.currentThread().getName() + &quot; : &quot; +number); &#125; catch (Exception e) &#123; System.out.println(e); &#125; &#125; public Map&lt;String, String&gt; initParameterMap() &#123; Map&lt;String, String&gt; parameterMap = new HashMap&lt;&gt;(); parameterMap.put(&quot;tsCode&quot;, &quot;order&quot;); parameterMap.put(&quot;result&quot;, &quot;-1&quot;); return parameterMap; &#125; &#125;&#125; 12345678910111213141516// mapper æ¥å£public interface OrderMapper &#123; int createOrderNum(Map&lt;String, String&gt; parameterMap);&#125;// xml &lt;update id=&quot;createOrderNum&quot; parameterMap=&quot;initMap&quot; statementType=&quot;CALLABLE&quot;&gt; CALL GetSerialNo(?,?) &lt;/update&gt; &lt;parameterMap type=&quot;java.util.Map&quot; id=&quot;initMap&quot;&gt; &lt;parameter property=&quot;tsCode&quot; mode=&quot;IN&quot; jdbcType=&quot;VARCHAR&quot;/&gt; &lt;parameter property=&quot;result&quot; mode=&quot;OUT&quot; jdbcType=&quot;VARCHAR&quot;/&gt; &lt;/parameterMap&gt; å¤‡æ³¨ æ‰§è¡Œäº†ä¸€ä¸ªç™¾ä¸ªçº¿ç¨‹ä¹‹å å¯ä»¥çœ‹ä¸€ä¸‹æ•°æ®ï¼Œè‡ªå¢åˆ°äº†100 è¯´æ˜æˆåŠŸäº† åˆ æ‰ å­˜å‚¨è¿‡ç¨‹ä¸­çš„ for updateï¼Œå†æ‰§è¡Œ å¯ä»¥çœ‹å‡ºé”çš„ä½œç”¨]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
</search>
