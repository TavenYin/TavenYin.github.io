<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Droolsï¼šè§„åˆ™åŠ è½½ & åŠ¨æ€æ›´æ–°æ–¹æ¡ˆ]]></title>
    <url>%2Fpost%2F907c3799.html</url>
    <content type="text"><![CDATA[å‰è¨€æœ¬æ–‡ä¸»è¦æƒ³èŠä¸‹è¿™å‡ ä¸ªé—®é¢˜ Drools çš„è§„åˆ™èµ„æºåŠ è½½æœ‰å‡ ç§æ–¹å¼ Drools çš„è§„åˆ™åŠ¨æ€æ›´æ–°æœ‰å‡ ç§æ–¹å¼ ç‰ˆæœ¬7.69.0.Final è§„åˆ™çš„åŠ è½½1. ä½¿ç”¨ KieClasspathContaineræœ€ç®€å•çš„åŠ è½½æ–¹å¼ï¼Œå®˜æ–¹çš„ demo ä¸­ä½¿ç”¨çš„ä¹Ÿæ˜¯è¿™ç§æ–¹å¼ï¼Œä»Ž classpath ä¸‹åŠ è½½ kmodule å’Œè§„åˆ™èµ„æºã€‚å¯ä»¥å¿«é€Ÿå¼€å§‹ Drools åº”ç”¨å¼€å‘ 1.1. å¼•å…¥ Drools ä¾èµ–12345678910&lt;dependency&gt; &lt;groupId&gt;org.drools&lt;/groupId&gt; &lt;artifactId&gt;drools-compiler&lt;/artifactId&gt; &lt;version&gt;$&#123;drools.version&#125;&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.drools&lt;/groupId&gt; &lt;artifactId&gt;drools-traits&lt;/artifactId&gt; &lt;version&gt;$&#123;drools.version&#125;&lt;/version&gt;&lt;/dependency&gt; 1.2. æ–°å»º resource/META-INF/kmodule.xml123456789&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;kmodule xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://www.drools.org/xsd/kmodule&quot;&gt; &lt;kbase name=&quot;HelloWorldKB&quot; packages=&quot;org.example.drools.helloworld&quot;&gt; &lt;ksession name=&quot;HelloWorldKS&quot;/&gt; &lt;/kbase&gt;&lt;/kmodule&gt; 1.3. æ–°å»º resource/org/example/drools/helloworld/hello.drl12345678910111213package org.example.drools.helloworld;rule &quot;helloworld1&quot; when then System.out.println(&quot;Hello World11111&quot;);endrule &quot;helloworld2&quot; when then System.out.println(&quot;Hello World2&quot;);end 1.4. åˆ›å»º ClasspathContainerï¼Œå¹¶è§¦å‘è§„åˆ™12345KieServices ks = KieServices.Factory.get();kieContainer = ks.newKieClasspathContainer();KieSession kieSession = kieContainer.newKieSession("HelloWorldKS");kieSession.fireAllRules();kieSession.dispose(); åˆ›å»º ClasspathContainer æµç¨‹æµ…æžå½“æ‰§è¡Œ ks.newKieClasspathContainer(); æ—¶ï¼Œä¼šè‡ªåŠ¨å¯»æ‰¾ META-INF/kmodule.xmlï¼Œç”¨äºŽåˆ›å»º KieModuleï¼ˆKieModule ä»…æ˜¯å¯¹ KieBase ä»¥åŠ KieSession çš„å®šä¹‰ï¼‰ å½“æ‰§è¡Œ kieContainer.newKieSession(&quot;HelloWorldKS&quot;) æ—¶ï¼Œä¼šå…ˆåˆ›å»º KieBaseï¼Œæ­¤æ—¶ä¹Ÿä¼šåŽ»ç¼–è¯‘è§„åˆ™ï¼ˆå¦‚æžœä½ çš„è§„åˆ™æ–‡ä»¶æ¯”è¾ƒå¤§çš„è¯ï¼Œè¿™ä¸ªç¼–è¯‘è¿‡ç¨‹å¯èƒ½ä¼šå¾ˆæ…¢ï¼‰ã€‚KieBase åˆ›å»ºå®ŒæˆåŽï¼Œä½¿ç”¨ KieBase åˆ›å»º KieSession ClasspathContainer æ–¹å¼å°ç»“ä½¿ç”¨è¯¥æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ç®€å•ã€å¯ä»¥å¿«é€Ÿå¼€å‘ï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿå¾ˆæ˜Žæ˜¾ï¼Œè§„åˆ™å’Œé…ç½®æ–‡ä»¶ç»‘å®šåœ¨é¡¹ç›®ä¸­ï¼ˆè€¦åˆåº¦å¤ªé«˜ï¼‰ã€‚å¦‚æžœä½ ä¸éœ€è¦ä¿®æ”¹è§„åˆ™æ–‡ä»¶ï¼Œè¿™ç§æ–¹å¼è¿˜æ˜¯å¯ä»¥é‡‡çº³çš„ 2. KieBuilder123456789101112KieServices ks = KieServices.Factory.get();KieFileSystem kfs = ks.newKieFileSystem();// kfskfs.write("src/main/resources/KBase1/ruleSet1.drl", drl);kfs.write("src/main/resources/META-INF/kmodule.xml", ResourceFactory.newClassPathResource("META-INF/kmodule.xml"));kfs.write("pom.xml", ResourceFactory.newFileResource("your_path/pom.xml"));KieBuilder kieBuilder = ks.newKieBuilder(kfs);kieBuilder.buildAll();// releaseId ä¸Ž pom ä¸­å£°æ˜Žçš„ä¸€è‡´// å¦‚æžœ kfs ä¸­æœªå†™å…¥ pom çš„è¯ï¼Œä½¿ç”¨ ks.getRepository().getDefaultReleaseId()KieContainer kieContainer = ks.newKieContainer(releaseId); ä½¿ç”¨è¿™ç§æ–¹å¼å¯ä»¥å°†è§„åˆ™å’Œ kmodule.xml å­˜å‚¨åœ¨å¤–éƒ¨ï¼Œç®€å•è¯´ä¸‹æµç¨‹ ä½¿ç”¨ KieFileSystem åˆ›å»ºä¸€ä¸ªåŸºäºŽå†…å­˜çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œkfs ä¸­çš„æ–‡ä»¶è·¯å¾„è§„èŒƒå‚è€ƒ ClasspathContainer æ–¹å¼ KieBuilder ä½¿ç”¨ kfs ä¸­çš„ kmodule.xml ä»¥åŠè§„åˆ™æ–‡ä»¶åˆ›å»º KieModuleï¼ˆKieBuilder å†…éƒ¨å†å°† KieModule ä¿å­˜åœ¨äº† KieRepositoryï¼‰ é€šè¿‡ releaseId åˆ›å»º KieContainerï¼Œå¦‚æžœ kfs ä¸­æœªæŒ‡å®š pomï¼Œåˆ™éœ€è¦å°† ks.getRepository().getDefaultReleaseId() ä½œä¸ºå‚æ•°ä¼ å…¥ å½“ä½ å¸Œæœ›æŠŠ Drools èµ„æºå¤–éƒ¨å­˜å‚¨æ—¶ï¼Œä½¿ç”¨ KieBuilder æ˜¯ä¸é”™çš„æ–¹æ¡ˆ 3. KieHelper1234Resource resource = ...;KieHelper helper = new KieHelper();helper.addResource(resource, ResourceType.DRL);KieBase kBase = helper.build(); ä½¿ç”¨ KieHelper å¯ä»¥å¸®ä½ å¿«é€Ÿåˆ›å»ºä¸€ä¸ª KieBaseï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ KieBuilder çš„æ“ä½œç®€åŒ–ï¼Œå†…éƒ¨è¿˜æ˜¯ä½¿ç”¨äº† KieFileSystem å’Œ KieBuilderï¼Œåªä¸è¿‡åœ¨åˆ›å»º KieContainer ä¹‹åŽæ–°å»ºäº†ä¸€ä¸ª KieBase ä½œä¸ºè¿”å›žå€¼ æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ–è€…è¯´æƒ³è‡ªå·±ç®¡ç† KieBase çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ª APIï¼Œæ€»çš„æ¥è¯´ä¸æŽ¨èä½¿ç”¨ã€‚ 4. KieScannerè¿™æ˜¯åœ¨ Drools å®˜æ–¹æ–‡æ¡£ä¸­çœ‹åˆ°çš„ä¸€ä¸ªéªšæ“ä½œï¼Œé€šè¿‡åŠ¨æ€åŠ è½½ jar çš„æ–¹å¼æ¥å®žçŽ°èµ„æºåŠ è½½å’ŒåŠ¨æ€æ›´æ–°ï¼Œä¸‹é¢ç®€å•ä»‹ç»ä¸‹ã€‚ é¦–å…ˆæˆ‘ä»¬éœ€è¦å°†ä¸šåŠ¡æœåŠ¡ä¸Ž Drools èµ„æºåˆ†ç¦»æˆä¸¤ä¸ª jar Drools èµ„æº jar å…·ä½“ç»“æž„å¦‚ä¸‹ï¼Œå¦‚æžœä½ ä¹ æƒ¯ä½¿ç”¨ drools-workbench çš„è¯ï¼Œä¹Ÿå¯ä»¥ç”¨å®ƒæ¥åˆ›å»ºèµ„æº jar 12345678910111213â”‚ pom.xmlâ”‚â””â”€â”€â”€src â”œâ”€â”€â”€main â”‚ â”œâ”€â”€â”€java â”‚ â””â”€â”€â”€resources â”‚ â”œâ”€â”€â”€com â”‚ â”‚ â””â”€â”€â”€company â”‚ â”‚ â””â”€â”€â”€hello â”‚ â”‚ helloworld.drl â”‚ â”‚ â”‚ â””â”€â”€â”€META-INF â”‚ kmodule.xml pom ä¸­éœ€è¦æ³¨æ„çš„ä¸¤ç‚¹æ˜¯ ä½ éœ€è¦é…ç½®ä¸€ä¸ª jar æŽ¨é€çš„è¿œç«¯ä»“åº“åœ°å€ï¼ˆè¿™é‡Œæˆ‘ç›´æŽ¥ä½¿ç”¨çš„æ˜¯å…¬å¸å†…éƒ¨æ­å»ºçš„ Nexusï¼‰ èµ„æº jar çš„ version å¿…é¡»ä»¥ -SNAPSHOT ç»“å°¾ èµ„æº jar å‡†å¤‡å®Œæˆä¹‹åŽï¼Œä½¿ç”¨å‘½ä»¤ mvn clean deploy å°†å…¶æŽ¨é€åˆ°è¿œç«¯ ä¸‹é¢æ˜¯ä¸šåŠ¡å·¥ç¨‹çš„æ“ä½œ é¦–å…ˆ pom ä¸­å¼•å…¥ kie-ciï¼Œè¿™é‡Œæ³¨æ„å•Šï¼Œä¸è¦å¼•å…¥ä½ åˆšåˆšåˆ›å»ºçš„èµ„æº jar 12345&lt;dependency&gt; &lt;groupId&gt;org.kie&lt;/groupId&gt; &lt;artifactId&gt;kie-ci&lt;/artifactId&gt; &lt;version&gt;7.69.0.Final&lt;/version&gt;&lt;/dependency&gt; é¡¹ç›®ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç  123456KieServices kieServices = KieServices.Factory.get();// æ³¨æ„è¿™é‡Œçš„ releaseId å°±æ˜¯å¯¹åº”çš„æ˜¯ä½ èµ„æº jar çš„ groupIdï¼ŒartifactIdï¼ŒversionReleaseId releaseId = kieServices.newReleaseId( "org.company", "drl-base", "0.1.0-SNAPSHOT" );KieContainer kContainer = kieServices.newKieContainer( releaseId );KieScanner kScanner = kieServices.newKieScanner( kContainer );kScanner.start( 10000L ); ç„¶åŽå¯åŠ¨ä¸šåŠ¡æœåŠ¡ jar è®¿é—®ä¸šåŠ¡æœåŠ¡éªŒè¯è§„åˆ™æ˜¯å¦åŠ è½½ æ›´æ–°èµ„æº jar å¹¶æŽ¨é€è‡³è¿œç«¯è¿™æ—¶å€™å¯ä»¥çœ‹åˆ°ä¸šåŠ¡è¿›ç¨‹ä¼šæ‰“å‡ºå¦‚ä¸‹æ—¥å¿—ï¼Œè¯´æ˜Žè§„åˆ™æ›´æ–°æˆåŠŸ 12022-05-19 16:43:11.223 INFO 20684 --- [ Timer-0] org.kie.api.builder.KieScanner : The following artifacts have been updated: &#123;yourjarName&#125; éªŒè¯è§„åˆ™æ›´æ–° KieScanner åŽŸç†æµ…æž KieScanner ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼ŒæŒ‰ç…§è§„å®šæ—¶é—´åŽ»æ‰«æè¿œç«¯ maven ä»“åº“ï¼ˆéƒ¨ç½²å‰è¦åœ¨ setting ä¸­é…ç½®å¥½ maven è¿œç«¯ä»“åº“ urlï¼‰ å½“å‘çŽ°å¿«ç…§æ—¶é—´æˆ³å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸‹è½½åˆ°æœ¬åœ°ï¼ˆå…·ä½“å¦‚ä½•åŠ¨æ€åŠ è½½çš„ class è¿™é‡Œæˆ‘æ²¡å¤ªå…³æ³¨ï¼‰ ä¹‹åŽä¼šæ–°å»ºä¸€ä¸ª KieModule é€šè¿‡ KieContainerImpl.updateToKieModule æ¥æ›´æ–°å®¹å™¨ï¼Œæœ¬è´¨ä¸Šæ˜¯æ›´æ–° KBase çœ‹åˆ°ç¬¬ä¸‰æ­¥åŽï¼Œæˆ‘åœ¨æƒ³æˆ‘è‡ªå·±æ˜¯å¦å¯ä»¥åˆ©ç”¨è¿™ä¸ª updateToKieModule æ–¹æ³•æ¥å®žçŽ°æ›´æ–° Container å‘¢ï¼ŸåŽæ¥å°è¯•äº†ä¸€ä¸‹ï¼Œè¯æ˜Žå¯ä»¥ è¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼Œå¤§æ¦‚å°±æ˜¯ä¸‹é¢è¿™æ · 123KieBuilder = ...KieModule kieModule = kieBuilder.getKieModule();kContainer.updateToKieModule((InternalKieModule) kieModule); è§„åˆ™åº“æ›´æ–°1. updateToKieModuleä¸Šé¢è®²åˆ°äº† KieContainerImpl.updateToKieModule çš„æ–¹å¼æ¥æ›´æ–°è§„åˆ™åº“ã€‚ 2. åˆ›å»ºæ–°çš„ KieContaineråŸºäºŽä¸Šé¢è®²åˆ°çš„æ–¹å¼ï¼Œå…¶å®žå¯ä»¥æƒ³åˆ°ã€‚å¦‚æžœé‡æ–°åˆ›å»º KieContainer çš„è¯ï¼Œä¹Ÿç›¸å½“äºŽå®žçŽ°è§„åˆ™åº“åŠ¨æ€æ›´æ–°ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼ä¹Ÿå­˜åœ¨ä¸€å®šé—®é¢˜ è¿™æ˜¯å¼€é”€æœ€å¤§çš„ä¸€ç§æ–¹å¼ æ—§çš„ container éœ€è¦é”€æ¯ï¼Œå¦‚æžœç›´æŽ¥è°ƒç”¨ dispose æ–¹æ³•æ¸…ç†èµ„æºå¯èƒ½ä¼šé”€æ¯æ­£åœ¨ä½¿ç”¨çš„ kSessionã€‚ 3. InternalKnowledgeBaseé™¤æ­¤ä¹‹å¤–ï¼ŒKieBase çš„å®žçŽ°ç±»æœ¬èº«ä¹Ÿæä¾›äº†æ›´æ–°ä»¥åŠåˆ é™¤çš„ API 123456789101112131415// æ–°å¢žæˆ–è€…æ›´æ–°KnowledgeBuilder kBuilder = KnowledgeBuilderFactory.newKnowledgeBuilder();kBuilder.add(resource, ResourceType.DRL);if (kBuilder.hasErrors()) &#123; KnowledgeBuilderErrors errors = kBuilder.getErrors(); log.error(errors.toString()); return;&#125;InternalKnowledgeBase knowledgeBase = (InternalKnowledgeBase) kContainer.getKieBase(kieBaseName);knowledgeBase.addPackages(kBuilder.getKnowledgePackages());// åˆ é™¤è§„åˆ™knowledgeBase.removeKiePackage(packageName);// æˆ–è€…knowledgeBase.removeRule(packageName, ruleName); é‡ç‚¹è¯´æ˜Žä¸‹ï¼Œå¦‚æžœä½ è¦æ›´æ–°ä¸€ä¸ªè§„åˆ™çš„è¯ï¼Œç›´æŽ¥è°ƒç”¨ addPackages å³å¯ï¼Œå¹¶ä¸éœ€è¦å…ˆåˆ é™¤å†æ–°å¢žï¼ˆè¿™æ ·åè€Œæœ‰å¯èƒ½é€ æˆé—®é¢˜ï¼‰ è¿™ç§æ–¹å¼ç›¸æ¯”ä¸Šé¢è¯´åˆ°çš„ KieContainerImpl.updateToKieModule çš„æ–¹å¼é¢—ç²’åº¦è¦å°ä¸€äº›ï¼ŒupdateToKieModule ä¼šæ›´æ–°æ‰€æœ‰çš„ KBase å¹¶å‘æ›´æ–°è§„åˆ™èµ·å› å°±æ˜¯æˆ‘æƒ³äº†è§£ä¸€ä¸‹ï¼ŒKSession æ­£åœ¨æ‰§è¡Œæ—¶ï¼Œæ›´æ–° KBase ä¼šæœ‰ä»€ä¹ˆå½±å“ ä¸¾ä¸ªä¾‹å­å…·ä½“è¯´ä¸‹ 12345678910111213KnowledgeBuilder kbuilder = getKnowledgeBuilder("helloworld.drl");InternalKnowledgeBase kieBase = KnowledgeBaseFactory.newKnowledgeBase();kieBase.addPackages(kbuilder.getKnowledgePackages());KieSession kieSession = kieBase.newKieSession();kieSession.insert(1d);CompletableFuture.runAsync(() -&gt; &#123; kieBase.removeKiePackage("com.example.drools.helloworld"); log.info("remove package");&#125;).join();kieSession.fireAllRules();kieSession.dispose(); helloworld.drl åªæœ‰ä¸€ä¸ªè§„åˆ™ï¼Œåœ¨æ‰§è¡Œ fireAllRules ä¹‹å‰ï¼Œæ‰§è¡Œäº† KBase remove æ“ä½œï¼Œè¿™ä¼šå¯¼è‡´æœ¬æ¬¡ fire æ²¡æœ‰è§¦å‘ä»»ä½•è§„åˆ™ï¼Œå› ä¸ºæ­¤æ—¶ KBase å†…éƒ¨æ²¡æœ‰è§„åˆ™ è¿™çœ‹èµ·æ¥å¥½åƒæŒºåˆç†çš„ï¼Œä½†æ˜¯å¦‚æžœä½ çš„æœ¬æ„æ˜¯æƒ³å…ˆåˆ é™¤ï¼Œå†æ–°å¢žå‘¢ï¼Ÿåˆ é™¤ + æ–°å¢žå¹¶æ²¡æœ‰ä¸€ä¸ªåŽŸå­æ“ä½œï¼Œå¯¼è‡´ä¸šåŠ¡æ•°æ®å¯èƒ½æ²¡æœ‰è§¦å‘ä»»ä½•è§„åˆ™ã€‚ çº¿ç¨‹1 çº¿ç¨‹2 åˆ›å»º kSession å¹¶æ’å…¥äº‹å®ž kBase removePackage fireAllRules kBase addPackage æ‰€ä»¥æŽ¨èå°½å¯èƒ½ä¸è¦åœ¨è¿è¡Œæ—¶åšè¿™ç§ åˆ é™¤ + æ–°å¢žçš„æ“ä½œ çœ‹åˆ°è¿™æ—¶ï¼Œå…¶å®žæˆ‘è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚å½“æ‰§è¡Œ kieSession.fireAllRules(); æ—¶ï¼Œè§„åˆ™åº“ä¹Ÿå…è®¸è¢«æ›´æ–°å—ï¼Ÿ ç”±äºŽç¯‡å¹…é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ç›´æŽ¥è¯´ç»“è®ºï¼š fireAllRules æˆåŠŸä¿®æ”¹å†…éƒ¨çŠ¶æ€ä¸º FIRING_ALL_RULES æ—¶ï¼Œä»»ä½• kBase çš„ä¿®æ”¹æ“ä½œä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼ˆç­‰å¾… fire ç»“æŸï¼‰ å¦‚æžœ kBase ä¿®æ”¹æ“ä½œå…ˆæ‰§è¡Œäº†ï¼ŒfireAllRules ä¼šç­‰å¾… kBase æ›´æ–°æˆåŠŸåŽå†è§¦å‘è§„åˆ™ æ‰€ä»¥ä»…æ˜¯åŠ¨æ€æ›´æ–°è§„åˆ™çš„è¯ï¼Œå¯¹ Drools çš„æ‰§è¡Œæ˜¯æ²¡æœ‰å½±å“çš„ å…¨æ–‡æ€»ç»“ æˆ‘è§‰å¾—æ—¢ç„¶ä½¿ç”¨äº†è§„åˆ™å¼•æ“Žï¼Œè§£è€¦æ˜¯éžå¸¸é‡è¦çš„ï¼Œæ‰€ä»¥æ¯”è¾ƒæŽ¨èä½¿ç”¨ KieBuilder çš„æ–¹å¼æ¥åŠ è½½è§„åˆ™ï¼›å¦‚æžœä½ çœŸçš„å°±ä¸éœ€è¦è§„åˆ™èµ„æºå¤–éƒ¨å­˜å‚¨çš„è¯ï¼Œç›´æŽ¥ä½¿ç”¨ ks.newKieClasspathContainer(); å°±å¯ä»¥äº† å¦‚æžœä½ æƒ³ä½¿ç”¨ KieScanner çš„è¯ï¼Œä¸€å®šè¦æ³¨æ„åšå¥½å¿«ç…§ç‰ˆæœ¬çš„ç®¡ç†ã€‚ç”Ÿäº§çŽ¯å¢ƒå’Œå¼€å‘çŽ¯å¢ƒä¸èƒ½ä½¿ç”¨åŒä¸€ä¸ª maven ä»“åº“ï¼Œæˆ–è€…ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬é˜²æ­¢å¼€å‘çŽ¯å¢ƒæ›´æ–°å½±å“ç”Ÿäº§çŽ¯å¢ƒ è§„åˆ™åº“åŠ¨æ€æ›´æ–°æ–¹æ¡ˆçš„è¯ï¼Œæœ¬æ–‡æ€»ç»“äº†ä¸‰ç§ ä»¥åˆ›å»º KieContainer çš„æ–¹å¼ï¼Œå®žçŽ°åŠ¨æ€æ›´æ–° ä½¿ç”¨ KieContainerImpl.updateToKieModule ä½¿ç”¨ InternalKnowledgeBase çš„ API å¦‚æžœä½ éœ€è¦åŠ¨æ€æ›´æ–° KieModule çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ updateToKieModule æˆ–è€…é‡æ–°åˆ›å»º KieContainer çš„æ–¹å¼ï¼ˆéœ€è¦æ³¨æ„é”€æ¯æ—§çš„ Containerï¼‰ å¦‚æžœä½ ä»…ä»…æ˜¯éœ€è¦åŠ¨æ€æ›´æ–°è§„åˆ™çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ InternalKnowledgeBaseï¼ˆè¯¥æ–¹å¼å¼€é”€æ›´å°ï¼Œéœ€è¦æ³¨æ„ä¸è¦ä½¿ç”¨åˆ é™¤+æ–°å¢žçš„æ–¹å¼ï¼‰å’Œ updateToKieModule ï¼ˆå¼€é”€ç›¸å¯¹å‰è€…è¾ƒå¤§ï¼‰]]></content>
      <categories>
        <category>Drools</category>
      </categories>
      <tags>
        <tag>Drools</tag>
        <tag>è§„åˆ™å¼•æ“Ž</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è§„åˆ™å¼•æ“Ž Drools æ‰§è¡Œæµç¨‹æµ…æž]]></title>
    <url>%2Fpost%2Fa1c836ef.html</url>
    <content type="text"><![CDATA[ä»€ä¹ˆæ˜¯è§„åˆ™å¼•æ“Ž è§„åˆ™å¼•æ“Žæ˜¯å¤„ç†å¤æ‚è§„åˆ™é›†åˆçš„å¼•æ“Žã€‚é€šè¿‡è¾“å…¥ä¸€äº›åŸºç¡€äº‹ä»¶ï¼Œä»¥æŽ¨æ¼”æˆ–è€…å½’çº³ç­‰æ–¹å¼ï¼Œå¾—åˆ°æœ€ç»ˆçš„æ‰§è¡Œç»“æžœã€‚è§„åˆ™å¼•æ“Žçš„æ ¸å¿ƒä½œç”¨åœ¨äºŽå°†å¤æ‚ã€æ˜“å˜çš„è§„åˆ™ä»Žç³»ç»Ÿä¸­æŠ½ç¦»å‡ºæ¥ï¼Œç”±çµæ´»å¯å˜çš„è§„åˆ™æ¥æè¿°ä¸šåŠ¡éœ€æ±‚ Drools ç®€ä»‹Drools æ˜¯ Java ç¼–å†™çš„ä¸€æ¬¾å¼€æºè§„åˆ™å¼•æ“Žã€‚Drools çš„æ ¸å¿ƒç®—æ³•åŸºäºŽ Reteã€‚æ—©äº›ç‰ˆæœ¬ä¸­ï¼ŒDrools ä½¿ç”¨çš„æ˜¯åŸºäºŽ Rete äºŒæ¬¡å¼€å‘çš„ ReteOO ç®—æ³•ã€‚åœ¨ 7.x ç‰ˆæœ¬çš„ Drools ä¸­ï¼Œå…¶å†…éƒ¨ç®—æ³•å·²ç»æ”¹ä¸ºä½¿ç”¨ Phreakã€‚Phreak ä¹Ÿæ˜¯Drools å›¢é˜Ÿè‡ªç ”çš„ç®—æ³•ï¼Œè™½ç„¶ç½‘ä¸Šå…³äºŽè¯¥ç®—æ³•çš„èµ„æ–™å¾ˆå°‘ï¼Œä½†æ˜¯æ€»ä½“æ¥è¯´ä¸Ž Rete ç®—æ³•ç›¸ä¼¼ã€‚é˜…è¯»æœ¬æ–‡ä¹‹å‰å¯ä»¥å…ˆäº†è§£ä¸‹ Rete ç®—æ³• ç¼–å†™ä¸€ä¸ªç®€å•çš„è§„åˆ™ä½¿ç”¨ Drools éœ€è¦æˆ‘ä»¬å°†åŽŸæœ‰çš„ä»£ç æŠ½è±¡æˆï¼šRuleï¼ˆè§„åˆ™ï¼‰ + Factï¼ˆäº‹å®žï¼‰ é¦–å…ˆæˆ‘ä»¬å…ˆæ¥ç¼–å†™ä¸€ä¸ªç®€å•çš„ demo ç”¨äºŽåŽæ–‡çš„åŽŸç†å­¦ä¹  å¼•å…¥ pom ä¾èµ– 123456789101112131415&lt;properties&gt; &lt;drools.version&gt;7.62.0.Final&lt;/drools.version&gt;&lt;/properties&gt;//...&lt;dependency&gt; &lt;groupId&gt;org.drools&lt;/groupId&gt; &lt;artifactId&gt;drools-compiler&lt;/artifactId&gt; &lt;version&gt;$&#123;drools.version&#125;&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.drools&lt;/groupId&gt; &lt;artifactId&gt;drools-mvel&lt;/artifactId&gt; &lt;version&gt;$&#123;drools.version&#125;&lt;/version&gt;&lt;/dependency&gt; resource ç›®å½•ä¸‹æ–°å»º order.drl 1234567891011121314151617181920212223242526272829303132333435363738394041424344// åŒ…åç”¨äºŽé€»è¾‘ä¸ŠåŒºåˆ† rulepackage com.example.drools.order;import com.example.drools.demo.HelloDrools.Orderimport com.example.drools.demo.HelloDrools.Userimport java.util.ArrayList;global java.util.List list// æŒ‡å®šæ–¹è¨€ä¸º javadialect &quot;java&quot;// è§„åˆ™çš„ç»„æˆåŒ…æ‹¬ï¼Œæ¡ä»¶ï¼ˆwhen éƒ¨åˆ†ï¼‰å’ŒåŠ¨ä½œï¼ˆthen éƒ¨åˆ†ï¼‰// å½“æ»¡è¶³ when æ—¶ï¼Œä¼šæ‰§è¡Œ then çš„é€»è¾‘rule &quot;order can pay&quot; when // è¦æ±‚æ’å…¥çš„ fact å¿…é¡»æœ‰ä¸€ä¸ª User å¯¹è±¡ // å¹¶ä¸” Order fact å¿…é¡»æ»¡è¶³ price &lt; $user.price $user: User() $order: Order(price &lt; $user.price) then System.out.println(&quot;username:&quot; + $user.getName() + &quot;, order price:&quot; + $order.getPrice());endrule &quot;calculate member point&quot; when $user: User(level &gt; 0) $order: Order() then Double point = $user.getPoint(); if ($user.getLevel() &gt; 10) &#123; $user.setPoint(point + $order.getPrice()); &#125; else &#123; $user.setPoint(point + $order.getPrice() * 0.5); &#125; System.out.println(&quot;previous point:&quot; + point + &quot;, present point:&quot; + $user.getPoint());endrule &quot;user age &gt; 18&quot; when $user: User(age &gt; 18) then System.out.println(&quot;user age &gt; 18&quot;);end resource ä¸‹æ–°å»º META-INF\kmodule.xml 1234&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;kmodule xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://www.drools.org/xsd/kmodule&quot;&gt;&lt;/kmodule&gt; java ä»£ç éƒ¨åˆ† 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152package com.example.drools.demo;import lombok.Data;import org.kie.api.KieServices;import org.kie.api.runtime.KieContainer;import org.kie.api.runtime.KieSession;/** * @author tianwen.yin */public class HelloDrools &#123; public static void main(String[] args) &#123; // åˆå§‹åŒ– KieServices kieServices = KieServices.Factory.get(); KieContainer kieContainer = kieServices.newKieClasspathContainer(); KieSession kieSession = kieContainer.newKieSession(); // æž„å»º fact User user = new User(); user.setName("taven"); user.setPoint(10D); user.setLevel(5); user.setPrice(100D); user.setAge(19); Order order = new Order(); order.setPrice(58D); // insert fact kieSession.insert(user); kieSession.insert(order); // è§¦å‘æ‰€æœ‰è§„åˆ™ int fireCount = kieSession.fireAllRules(); System.out.println("fireRuleCount:" + fireCount); kieSession.dispose(); &#125; @Data public static class Order &#123; private Double price; &#125; @Data public static class User &#123; private String name; private Integer age; private Double price; private Integer level; private Double point; &#125;&#125; æ‰§è¡Œç»“æžœå¦‚ä¸‹ 1234username:taven, order price:58.0previous point:10.0, present point:39.0user age &gt; 18fireRuleCount:3 Drools æ‰§è¡Œæµç¨‹æµ…æžDrools çš„ä½¿ç”¨çœ‹èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯å®žé™…ä¸ŠçœŸæ­£è½åœ°ä½¿ç”¨è¿˜æ˜¯éœ€è¦è¯¦è¯»å®˜æ–¹æ–‡æ¡£çš„ï¼Œä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œå°±ä¸å¤šèµ˜è¿°äº†ã€‚æŽ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥æ­£é¢˜ï¼Œåˆ†æžä¸‹æ‰§è¡Œæµç¨‹ ä¸Šè¿°çš„å›¾ï¼Œæ˜¯æˆ‘ç»“åˆæºç æ€»ç»“çš„ Drools æ‰§è¡Œæµç¨‹å›¾ï¼Œæœ€ç»ˆç›®çš„å°±æ˜¯æ ¹æ®æ’å…¥çš„ fact è¿›è¡ŒæŽ¨æ¼”ï¼Œå¦‚æžœèƒ½èµ°åˆ°æœ€åŽçš„ Terminal èŠ‚ç‚¹åˆ™ä»£è¡¨è§„åˆ™ä¼šè¢«æ‰§è¡Œ æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä¸Šå›¾ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ Object Type Nodeï¼šç®€ç§° OTNï¼Œfact ä¼šæ ¹æ®ç±»åž‹æµè½¬åˆ°ä¸åŒçš„ OTN Alpha Nodeï¼šä¹Ÿè¢«ç§°ä¸ºå•è¾“å…¥èŠ‚ç‚¹ï¼Œæ‰€æœ‰å•å¯¹è±¡çš„çº¦æŸæ¡ä»¶éƒ½ä¼šè¢«æž„å»ºä¸º Alpha èŠ‚ç‚¹ï¼Œä¾‹å¦‚ â€œage &gt; 18â€ï¼Œâ€leve &gt; 0â€ Beta Nodeï¼šåŒè¾“å…¥èŠ‚ç‚¹ï¼Œä¸åŒå¯¹è±¡ä¹‹é—´çš„çº¦æŸä¼šè¢«æž„å»ºä¸º Beta èŠ‚ç‚¹ï¼Œä¾‹å¦‚ â€œorder.price &gt; user.priceâ€ï¼›å½“ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦åŒæ—¶æ»¡è¶³å¤šä¸ªå•å¯¹è±¡çº¦æŸæ—¶ä¹Ÿæ˜¯ Beta èŠ‚ç‚¹ï¼›ä¸€ä¸ªèŠ‚ç‚¹æœ‰è¶…è¿‡ä¸¤ä¸ªæ¡ä»¶çº¦æŸæ—¶ï¼Œä¼šæž„å»ºä¸ºå¤šä¸ª Beta èŠ‚ç‚¹ç›¸è¿ž Beta èŠ‚ç‚¹åˆåˆ†ä¸º Joinï¼ŒNotï¼ŒExist ç­‰ï¼Œæœ¬æ–‡ä¸»è¦ä»¥ Join èŠ‚ç‚¹ä¸ºä¾‹è¿›è¡Œè¯´æ˜Žã€‚å¯¹äºŽå…¶ä»–èŠ‚ç‚¹æ¥è¯´æµç¨‹ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æŸäº›å…·ä½“ç»†èŠ‚çš„å®žçŽ°ä¸åŒ è¡¥å……ä¸€å¼ å¤š Beta èŠ‚ç‚¹ç›¸è¿žçš„å›¾ LeftInputAdapterNodeï¼šå·¦è¾“å…¥èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„ä½œç”¨æˆ‘æœ€å¼€å§‹ä¹Ÿå¾ˆè¿·æƒ‘ã€‚åŽæ¥åœ¨åå¤ Debug åŽç»ˆäºŽé¡¿æ‚Ÿäº†ï¼ŒBeta èŠ‚ç‚¹è¢«è®¾è®¡æˆåªå­˜å‚¨å³ä¾§è¿›å…¥çš„ factï¼Œå·¦ä¾§çš„æ•°æ®æ¥è‡ª LeftInputAdapterNode æˆ–è€…å¦ä¸€ä¸ª Beta èŠ‚ç‚¹ï¼ˆå¯èƒ½ç†è§£ä¸äº†ï¼Œè¯·ç»§ç»­å¾€ä¸‹è¯»ï¼‰ Rule Terminalï¼šå½“ä¸€ä¸ª fact æµè½¬åˆ° Terminal æ—¶ï¼Œä»£è¡¨å½“å‰ fact ä¼šè§¦å‘è¯¥è§„åˆ™ å†…å­˜ç»“æž„ï¼šå…³äºŽ Drools å†…å­˜ç»“æž„è¿™å—ï¼Œä¸Žä¼ ç»Ÿ RETE ç®—æ³•ä¸å¤ªä¸€æ ·ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰å¤ªä»”ç»†çš„ç ”ç©¶è¿™å—ï¼Œä¸Šå›¾ä¸­åªæ˜¯æŠŠä¼šå­˜å‚¨ fact çš„ä½ç½®æ ‡è¯†äº†å‡ºæ¥ å®žé™…ä¸Š Drools çš„æºç éžå¸¸å¤æ‚ï¼Œå…¶ä¸­åŒ…å«çš„èŠ‚ç‚¹è¿œä¸æ­¢æåˆ°çš„è¿™äº›ï¼Œæˆ‘è¿™é‡Œä»…æ˜¯åŸºäºŽ RETE ç®—æ³•çš„æ ¸å¿ƒå†…å®¹æ¥åˆ¨æžä¸‹ Drools åŽŸç† æ³¨ï¼šè¿™é‡Œæˆ‘è¡¥å……ä¸‹ï¼ŒBeta èŠ‚ç‚¹çš„å³ä¾§åˆ†æ”¯ï¼Œåœ¨è¿›å…¥åˆ° Beta ä¹‹å‰ï¼Œä¹Ÿæ˜¯å¯ä»¥æœ‰ Alpha èŠ‚ç‚¹çš„ã€‚å¹¶ä¸”å½“å¤šä¸ª rule ä¸­åŒ…å«ç›¸åŒæ¡ä»¶æ—¶ä¹Ÿä¼šå…±ç”¨åˆ†æ”¯ã€‚æ”¹å›¾å’Œç¼– demo å®žåœ¨å¤ªéº»çƒ¦äº† å‡†å¤‡çŽ¯èŠ‚ åœ¨è§£æžè§„åˆ™æ–‡ä»¶æ—¶ï¼Œåº”è¯¥å°±å·²ç»åˆ›å»ºäº†ç±»ä¼¼ä¸Šå›¾çš„èŠ‚ç‚¹å…³ç³»ï¼ˆè¿™ä¸ªå…·ä½“æºç æ²¡æœ‰é˜…è¯»ï¼‰ ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼ŒkieSession.insert(user); ä¼šå°† fact æ’å…¥åˆ° PropagationList è°ƒç”¨ kieSession.fireAllRules(); åŽï¼Œè¿›å…¥åˆ°è§„åˆ™å¼•æ“Žæ ¸å¿ƒçŽ¯èŠ‚ fireAllRuleså­—é¢æ„æ€å·²ç»å¾ˆæ˜Žæ˜¾äº†ï¼Œè§¦å‘ Session ä¸­çš„æ‰€æœ‰è§„åˆ™ flush é˜¶æ®µä¼ æ’­ PropagationList ä¸­æ‰€æœ‰ factï¼Œå¯¹ç…§ä¸Šå›¾ä¸­ flushï¼ŒOTN ä¸‹æ¸¸çš„æ‰€æœ‰åˆ†æ”¯éƒ½ä¼šéåŽ†è®¿é—® å¦‚æžœæŸæ¡åˆ†æ”¯å…¨éƒ¨éƒ½æ˜¯ Alpha èŠ‚ç‚¹çš„è¯ï¼Œå¯ä»¥ç›´æŽ¥ä¼ æ’­åˆ° Terminal èŠ‚ç‚¹ å¦‚æžœ fact æµè½¬åˆ° LeftInputAdapterNode çš„è¯ï¼Œä¼šå°† fact å­˜å‚¨åœ¨ LeftInputAdapterNode å¯¹åº”çš„å†…å­˜ä¸­ å¦‚æžœ fact æµè½¬åˆ° Beta èŠ‚ç‚¹å³ä¾§çš„è¯ï¼Œä¼šå°† fact å­˜å‚¨åœ¨ Beta èŠ‚ç‚¹çš„å³ä¾§ å½“åˆ†æ”¯èµ°åˆ° Alpha Terminal èŠ‚ç‚¹æ—¶ï¼Œæž„å»ºä¸€ä¸ª RuleAgendaItem æ’å…¥åˆ° InternalAgendaGroup ä¸­ã€‚è¿™ä¸ªåŠ¨ä½œä»£è¡¨å½“å‰è§„åˆ™éœ€è¦è¿›è¡Œä¸‹ä¸€ä¸ªé˜¶æ®µ evaluateAndFire Beta èŠ‚ç‚¹çš„é€»è¾‘æ˜¯ï¼Œå½“æ‰€æœ‰çš„åˆ†æ”¯å…¥å£éƒ½å­˜å‚¨äº†æ•°æ®æ—¶ï¼Œæ’å…¥ InternalAgendaGroupï¼ˆè¿™å¥è¯å¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œå½“ä»…æœ‰ä¸€ä¸ª Beta èŠ‚ç‚¹æ—¶ï¼Œå·¦å³éƒ½å­˜å‚¨äº†æ•°æ®ï¼Œå°±ä¼šæ’å…¥ InternalAgendaGroupã€‚å¦‚æžœæ˜¯å¤šä¸ª Beta èŠ‚ç‚¹ç›¸è¿žçš„è¯ï¼Œå¿…é¡»è¦æ»¡è¶³ç¬¬ä¸€ä¸ª Beta çš„å·¦å³ï¼Œä»¥åŠä¸‹æ¸¸æ‰€æœ‰ Beta çš„å³èŠ‚ç‚¹éƒ½æœ‰æ•°æ®æ—¶æ‰ä¼šæ’å…¥ InternalAgendaGroupï¼‰ã€‚ evaluateï¼ˆè¯„ä¼°ï¼‰çº¯ Alpha èŠ‚ç‚¹çš„åˆ†æ”¯ï¼Œæ˜¯æ²¡æœ‰è¿™ä¸ªæ­¥éª¤çš„ ä»¥ Beta èŠ‚ç‚¹ä¸ºä¾‹ï¼Œevaluate å°±æ˜¯åŸºäºŽå·¦å³å†…å­˜è¿›è¡ŒåŒ¹é…ï¼Œæ‰¾åˆ°æ‰€æœ‰é…å¯¹æˆåŠŸçš„æ•°æ®æ”¾å…¥ä¸€ä¸ªé›†åˆï¼Œå°†è¿™ä¸ªé›†åˆç»§ç»­å¸¦å…¥åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸‹ä¸ªèŠ‚ç‚¹åˆå¯èƒ½æ˜¯ Beta èŠ‚ç‚¹æˆ–è€… Terminal èŠ‚ç‚¹ã€‚ å¦‚æžœæ˜¯ Beta èŠ‚ç‚¹çš„è¯ï¼Œåˆ™ç»§ç»­è¿›è¡ŒåŒ¹é…ï¼Œé…å¯¹æˆåŠŸçš„é›†åˆå¸¦å…¥åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹â€¦ å¦‚æžœæ˜¯ Terminal èŠ‚ç‚¹çš„è¯ï¼Œä¼šå°†æ•°æ®æ’å…¥åˆ° RuleExecutor çš„ tupleList ä¸­ã€‚è¿™æ­¥åˆæ˜¯å•¥æ„æ€å‘¢ï¼ŒtupleList çš„æ•°æ®ä»£è¡¨ï¼Œè¿™äº›æ•°æ®ä¼šçœŸæ­£çš„ä»£å…¥åˆ°è§„åˆ™æ‰§è¡Œå½“ä¸­åŽ»ï¼ˆAlpha Terminal ä¹Ÿä¼šæ‰§è¡Œè¿™ä¸ªæ“ä½œï¼‰ Beta èŠ‚ç‚¹è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯åœ¨è¿›è¡Œå·¦å³é…å¯¹çš„æ—¶å€™ï¼Œå¹¶ä¸åªæ˜¯éåŽ†æŸ¥æ‰¾ï¼Œè€Œæ˜¯åœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹ï¼ŒDrools åœ¨å­˜å‚¨è¿™äº›æ•°æ®çš„æ—¶å€™ä¼šå»ºç«‹ç´¢å¼•ã€‚ä¸Šè¿°ç¤ºä¾‹çš„è¯ï¼Œå¹¶æ²¡æœ‰å»ºç«‹ç´¢å¼•ï¼Œéšä¾¿æŠŠæ¡ä»¶æ”¹æˆ xx.a = yy.b è¿™ç§æ¡ä»¶çš„è¯ï¼Œå°±ä¼šå»ºç«‹ç´¢å¼•ã€‚å…·ä½“ç´¢å¼•çš„å®žçŽ°ä¹Ÿå¾ˆç®€å•ï¼ŒDrools å®žçŽ°äº†ä¸€ä¸ªç±»ä¼¼ HashMap çš„ç»“æž„æ¥ç®¡ç†ç´¢å¼•ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±æ‰“ä¸ªæ–­ç‚¹ debug ä¸‹ã€‚ æ–­ç‚¹ Classï¼šPhreakJoinNode æ³¨ï¼šä¸Šå›¾ä¸­ä¸¤ä¸ªä½ç½®ï¼Œåªæœ‰ä¸€å¤„ä¼šè¢«æ‰§è¡Œ fireè¿™é‡Œä¼šéåŽ† RuleExecutor çš„ tupleList æ‰§è¡Œè¿™äº›è§„åˆ™ã€‚æˆ‘ä»¬çš„è§„åˆ™æ–‡ä»¶åœ¨ Drools è¿è¡Œæ—¶ä¼šè¢«ç¼–è¯‘æˆå­—èŠ‚ç åŠ¨æ€æ‰§è¡Œï¼Œå…·ä½“è¿™å—å…·ä½“ç”¨å•¥å®žçŽ°çš„æ²¡ç ”ç©¶ã€‚ fire é˜¶æ®µè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚å°±æ˜¯ï¼Œæˆ‘ä»¬çš„è§„åˆ™æ–‡ä»¶å†…éƒ¨æ˜¯å¯ä»¥è°ƒç”¨ insert modify è¿™äº›å‡½æ•°çš„ï¼Œè¿™äº› fact åŒæ ·ä¼šè¢«æ’å…¥åˆ° PropagationList ä¸­ï¼Œå†…éƒ¨ä¹Ÿä¼šå†æ‰§è¡Œä¸€æ¬¡ PropagationList flush æ“ä½œã€‚æ•´ä¸ª fireAllRules æ–¹æ³•å†…éƒ¨æ˜¯ä¸€ä¸ªå¾ªçŽ¯ï¼Œå¦‚æžœ fire å†…éƒ¨çš„ fact å‘½ä¸­äº†è§„åˆ™çš„è¯ï¼Œåœ¨ fire ç»“æŸåŽè¿˜ä¼šç»§ç»­æ‰§è¡Œ evaluateAndFire ç›´åˆ°å…¨éƒ¨è§¦å‘å®Œä¸ºæ­¢ï¼ˆæ‰€ä»¥åœ¨è§„åˆ™ç¼–å†™é”™è¯¯çš„æƒ…å†µä¸‹ï¼ŒDrools å¯èƒ½è¿›å…¥æ­»å¾ªçŽ¯ï¼‰ Conflict resolutionå†²çªè§£å†³ç®€å•æ¥è¯´å°±æ˜¯ï¼Œå½“æˆ‘ä»¬çŸ¥é“äº†è¦æ‰§è¡Œçš„è§„åˆ™éƒ½æœ‰å“ªäº›æ—¶ï¼Œè¿˜éœ€è¦æ˜Žç¡®è¿™äº›è§„åˆ™æ‰§è¡Œçš„é¡ºåºã€‚ Drools è¿™é‡Œå¦‚ä½•è§£å†³é¡ºåºé—®é¢˜çš„å‘¢ï¼Ÿå›žé¡¾ä¸€ä¸‹ä¸Šé¢æåˆ°çš„ flush é˜¶æ®µã€‚RuleAgendaItem æ’å…¥åˆ° InternalAgendaGroup ä¸­è¿™ä¸€æ­¥ï¼ŒInternalAgendaGroup çš„é»˜è®¤å®žçŽ°ä¸º AgendaGroupQueueImplï¼ŒAgendaGroupQueueImpl ä¸­ä½¿ç”¨äº† BinaryHeapQueueï¼ˆäºŒå‰å †é˜Ÿåˆ—ï¼‰æ¥å­˜å‚¨å…ƒç´  é€šè¿‡äºŒå‰å †ç®—æ³•ä¿è¯æ¯æ¬¡é˜Ÿåˆ—å¼¹å‡ºä¼˜å…ˆçº§æœ€é«˜çš„è§„åˆ™ï¼Œä¼˜å…ˆçº§çš„è®¡ç®—é€šè¿‡ PhreakConflictResolver æ¥å®Œæˆ PhreakConflictResolver ä»Žä¸¤ä¸ªæ–¹é¢æ¥åˆ¤æ–­ä¼˜å…ˆçº§ è§„åˆ™æ˜¯å¦å£°æ˜Ž salienceï¼ˆsalience è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼‰ æ— æ³•é€šè¿‡ salience æ¥è®¡ç®—çš„è¯ï¼Œåˆ™é€šè¿‡è§„åˆ™ loadOrder æ¥å†³å®šä¼˜å…ˆçº§ï¼ˆè§„åˆ™åœ¨æ–‡ä»¶ä¸­è¶Šé å‰åˆ™ loadOrder å°±è¶Šé«˜ï¼‰ æ€»ç»“ä¸‹Drools è¿™ç§ç®—æ³•é€»è¾‘æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿä¸‹è¿°ç»“è®ºå‚è€ƒäº† https://en.wikipedia.org/wiki/Rete_algorithm é€šè¿‡å…±äº«èŠ‚ç‚¹æ¥å‡å°‘èŠ‚ç‚¹çš„å†—ä½™ï¼ˆå¦‚æžœå¤šä¸ª Rule ä¸­æœ‰ç›¸åŒçš„æ¡ä»¶ï¼Œä¸ä¼šé‡å¤è®¡ç®—ï¼‰ fact çš„å˜åŒ–ï¼Œä¸éœ€è¦å®Œå…¨é‡æ–°è¯„ä¼°ï¼Œåªéœ€è¦è¿›è¡Œå¢žé‡è¯„ä¼°ï¼ˆåªéœ€è¦å¯¹ fact å¯¹åº”çš„ OTN é‡æ–°è¯„ä¼°å°±å¯ä»¥ï¼‰ æ”¯æŒé«˜æ•ˆçš„åˆ é™¤ fact ï¼ˆä»Ž Drools çš„è§’åº¦æ¥çœ‹è¿™å¥è¯ï¼Œfact å­˜å‚¨æ—¶ä¼šå»ºç«‹ä¸€ä¸ªåŒå‘å…³è”ï¼Œä¹Ÿå°±æ˜¯ fact çŸ¥é“è‡ªå·±è¢«å“ªäº›èŠ‚ç‚¹å­˜å‚¨äº†ï¼Œæ‰€ä»¥å¯ä»¥é«˜æ•ˆçš„åˆ é™¤ï¼‰ æœ¬æ–‡ä»‹ç»äº† Drools çš„æ‰§è¡Œæµç¨‹ï¼Œç”±äºŽç½‘ä¸Šæ²¡æœ‰æ‰¾åˆ°å¤ªå¤šå‚è€ƒèµ„æ–™ï¼Œå¤§å¤šæ•°ç»“è®ºéƒ½æ˜¯æˆ‘è‡ªå·±æ€»ç»“å‡ºæ¥çš„ï¼Œå¦‚æžœæœ‰å†™é”™çš„åœ°æ–¹æ¬¢è¿Žå„ä½æŒ‡æ­£ã€‚ æœ€åŽå¦‚æžœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿Žç‚¹èµžï¼Œå…³æ³¨ï¼Œè½¬å‘ã€‚ä½ çš„æ”¯æŒæ˜¯å¯¹æˆ‘æœ€å¤§çš„å¸®åŠ©]]></content>
      <categories>
        <category>Drools</category>
      </categories>
      <tags>
        <tag>Drools</tag>
        <tag>è§„åˆ™å¼•æ“Ž</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringCloud NamedContextFactory åŽŸç†ä¸Žä½¿ç”¨]]></title>
    <url>%2Fpost%2Ff5339159.html</url>
    <content type="text"><![CDATA[æœ€è¿‘åœ¨é˜…è¯» Ribbon çš„æºç ï¼Œå‘çŽ° SpringCloud ä¸­ NamedContextFactory è¿™ä¸ªç±»å¯ä»¥å®žçŽ°å­å®¹å™¨ã€‚Ribbon ä¸ºæ¯ä¸ª ServiceName éƒ½æ‹¥æœ‰è‡ªå·±çš„ Spring Context å’Œ Bean å®žä¾‹ï¼ˆä¸åŒæœåŠ¡ä¹‹é—´çš„ LoadBalancer å’Œå…¶ä¾èµ–çš„ Bean éƒ½æ˜¯å®Œå…¨éš”ç¦»çš„ï¼‰ã€‚ è¿™ä¹ˆåšæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ å­å®¹å™¨ä¹‹é—´æ•°æ®éš”ç¦»ã€‚ä¸åŒçš„ LoadBalancer åªç®¡ç†è‡ªå·±çš„æœåŠ¡å®žä¾‹ï¼Œæ˜Žç¡®è‡ªå·±çš„èŒè´£ã€‚ å­å®¹å™¨ä¹‹é—´é…ç½®éš”ç¦»ã€‚ä¸åŒçš„ LoadBalancer å¯ä»¥ä½¿ç”¨ä¸åŒçš„é…ç½®ã€‚ä¾‹å¦‚æŠ¥è¡¨æœåŠ¡éœ€è¦ç»Ÿè®¡å’ŒæŸ¥è¯¢å¤§é‡æ•°æ®ï¼Œå“åº”æ—¶é—´å¯èƒ½å¾ˆæ…¢ã€‚è€Œä¼šå‘˜æœåŠ¡é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œæ‰€ä»¥ä¸¤ä¸ªæœåŠ¡çš„å“åº”è¶…æ—¶æ—¶é—´å¯èƒ½è¦æ±‚ä¸åŒã€‚ å­å®¹å™¨ä¹‹é—´ Bean éš”ç¦»ã€‚å¯ä»¥è®©å­å®¹å™¨ä¹‹é—´æ³¨å†Œä¸åŒçš„ Beanã€‚ä¾‹å¦‚è®¢å•æœåŠ¡çš„ LoadBalancer åº•å±‚é€šè¿‡ Nacos èŽ·å–å®žä¾‹ï¼Œä¼šå‘˜æœåŠ¡çš„ LoadBalancer åº•å±‚é€šè¿‡ Eureka èŽ·å–å®žä¾‹ã€‚ä¹Ÿå¯ä»¥è®©ä¸åŒçš„ LoadBalancer é‡‡ç”¨ä¸åŒçš„ç®—æ³• NamedContextFactory ç®€ä»‹ NamedContextFactory å¯ä»¥åˆ›å»ºä¸€ä¸ªå­å®¹å™¨ï¼ˆæˆ–è€…è¯´å­ä¸Šä¸‹æ–‡ï¼‰ï¼Œæ¯ä¸ªå­å®¹å™¨å¯ä»¥é€šè¿‡ Specification å®šä¹‰ Beanã€‚ ç§»æ¤è‡ª spring-cloud-netflix FeignClientFactory å’Œ SpringClientFactory ä¸Šé¢æ˜¯å¯¹äºŽ NamedContextFactory ç±»æ³¨é‡Šçš„ç¿»è¯‘ã€‚ æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šä½¿ç”¨ NamedContextFactory å®žçŽ°ä¸€ä¸ª demoï¼Œä¾¿äºŽå„ä½ç†è§£ã€‚ æˆ‘å®žåœ¨æ²¡æƒ³åˆ°ä»€ä¹ˆç‰¹åˆ«å¥½çš„åœºæ™¯ã€‚æ‰€ä»¥æˆ‘ä»¿ç…§ Ribbon å®žçŽ°ä¸€ä¸ª HttpClientï¼Œæ¯ä¸ªå­å®¹å™¨çš„ HttpClient ç”Ÿæ•ˆä¸åŒçš„é…ç½®ï¼Œåˆ›å»ºä¸åŒçš„ Bean å­å®¹å™¨çš„å®šåˆ¶NamedContextFactoryä¸‹é¢æ¥è¿›å…¥æ­£é¢˜ å­å®¹å™¨éœ€è¦é€šè¿‡ NamedContextFactory æ¥åˆ›å»ºã€‚é¦–å…ˆæˆ‘ä»¬å…ˆç»§æ‰¿ä¸€ä¸‹è¯¥ç±»å®žçŽ°ä¸€ä¸ªè‡ªå·±çš„ Factory12345678@Componentpublic class NamedHttpClientFactory extends NamedContextFactory&lt;NamedHttpClientSpec&gt; &#123; public NamedHttpClientFactory() &#123; super(NamedHttpClientConfiguration.class, "namedHttpClient", "http.client.name"); &#125;&#125; è§£é‡Šä¸€ä¸‹ä¸Šè¿° super æž„é€ æ–¹æ³•ä¸‰ä¸ªå‚æ•°çš„å«ä¹‰ ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œé»˜è®¤é…ç½®ç±»ã€‚å½“ä½¿ç”¨ NamedHttpClientFactory åˆ›å»ºå­å®¹å™¨æ—¶ï¼ŒNamedHttpClientConfiguration ä¸€å®šä¼šè¢«åŠ è½½ ç¬¬äºŒä¸ªå‚æ•°ï¼Œæˆ‘ç›®å‰æ²¡å‘çŽ°æœ‰ä»€ä¹ˆç”¨ï¼ŒçœŸçš„å°±æ˜¯éšä¾¿å®šä¹‰ä¸€ä¸ª name ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå¾ˆé‡è¦ã€‚åˆ›å»ºå­å®¹å™¨æ—¶é€šå¸¸ä¼šæä¾›å­å®¹å™¨çš„å®¹å™¨ nameã€‚å­å®¹å™¨ä¸­çš„ Environment ä¼šè¢«å†™å…¥ä¸€æ¡é…ç½®ï¼Œhttp.client.name=å®¹å™¨nameï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œå­å®¹å™¨å¯ä»¥é€šè¿‡è¯»å–é…ç½® http.client.name æ¥èŽ·å–å®¹å™¨åï¼‰ çœ‹åˆ°è¿™å¯èƒ½è¿˜æ˜¯å¾ˆè¿·æƒ‘ï¼Œè¿™å®žé™…æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿä»¥ Ribbon ä¸ºä¾‹ï¼Œå®¹å™¨åå°±æ˜¯ ServiceNameï¼ŒRibbon å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­å®šåˆ¶æ¯ä¸ªå­å®¹å™¨çš„é…ç½®æˆ–è€… Beanï¼Œé…ç½®å¦‚ä¸‹ 1234# è®¢å•æœåŠ¡çš„è¶…æ—¶æ—¶é—´ä¸º 3000orderService.ribbon.ReadTimeout = 3000# æŒ‡å®š orderService å®¹å™¨çš„ ServerListorderService.ribbon.NIWSServerListClassName = com.netflix.loadbalancer.ConfigurationBasedServerList å½“æ¯ä¸ªå­å®¹å™¨éƒ½çŸ¥é“è‡ªå·±çš„å®¹å™¨åæ—¶ï¼Œå°±å¯ä»¥æ‰¾åˆ°è‡ªå·±å¯¹åº”çš„é…ç½®äº† æŽ¥ä¸‹æ¥çœ‹ä¸‹ï¼Œæˆ‘çš„é»˜è®¤é…ç½®ç±»éƒ½å¹²äº†ä»€ä¹ˆ123456789101112131415161718public class NamedHttpClientConfiguration &#123; @Value("$&#123;http.client.name&#125;") private String httpClientName; // 1. @Bean @ConditionalOnMissingBean public ClientConfig clientConfig(Environment env) &#123; return new ClientConfig(httpClientName, env); // 2. &#125; @Bean @ConditionalOnMissingBean public NamedHttpClient namedHttpClient(ClientConfig clientConfig) &#123; return new NamedHttpClient(httpClientName, clientConfig); // 3. &#125;&#125; @Value(&quot;${http.client.name}&quot;)ï¼Œç»“åˆä¸Šè¾¹è®²çš„ï¼Œè¿™æ ·å¯ä»¥è¯»åˆ°å½“å‰å­å®¹å™¨çš„ name ClientConfigï¼Œè´Ÿè´£æ ¹æ®å®¹å™¨ nameï¼ŒåŠ è½½å±žäºŽè‡ªå·±çš„é…ç½®ã€‚ä»£ç æ¯”è¾ƒç®€å•å°±ä¸è´´å‡ºæ¥äº† NamedHttpClientï¼Œç®€å•çš„åŒ…è£…ä¸€ä¸‹ HttpClientï¼Œä¼šæ ¹æ® ClientConfig å¯¹ HttpClient è¿›è¡Œé…ç½® NamedContextFactory.Specificationä¸Šé¢è®²çš„æ˜¯å¯ä»¥æ‰‹åŠ¨ç¼–ç¨‹æ¥å®šåˆ¶å­å®¹å™¨çš„ Beanï¼ŒNamedContextFactory ä¹Ÿæä¾›äº†å®šåˆ¶å­å®¹å™¨çš„æŽ¥å£ NamedContextFactory.Specificationã€‚ 1234567891011121314151617181920public class NamedHttpClientSpec implements NamedContextFactory.Specification &#123; private final String name; private final Class&lt;?&gt;[] configuration; public NamedHttpClientSpec(String name, Class&lt;?&gt;[] configuration) &#123; this.name = name; this.configuration = configuration; &#125; @Override public String getName() &#123; return name; &#125; @Override public Class&lt;?&gt;[] getConfiguration() &#123; return configuration; &#125;&#125; æˆ‘ä»¬ç®€å•çš„å®žçŽ°ä¸€ä¸‹è¯¥æŽ¥å£ï¼Œç„¶åŽé€šè¿‡ NamedHttpClientFactory#setConfigurationsï¼Œå°† Specification èµ‹å€¼ç»™ NamedHttpClientFactoryã€‚ åˆ›å»ºå­å®¹å™¨æ—¶ï¼Œå¦‚æžœå®¹å™¨çš„ name åŒ¹é…äº† Specification çš„ nameï¼Œåˆ™ä¼šåŠ è½½ Specification å¯¹åº” Configuration ç±»ã€‚ é¢˜å¤–è¯: @RibbonClient ä¹Ÿæ˜¯é€šè¿‡ NamedContextFactory.Specification å®žçŽ°çš„ Run ä¸€ä¸‹è®²åˆ°è¿™ï¼Œä¹Ÿè®¸ä½ è¿˜æ˜¯æ²¡æ‡‚ï¼Œæ²¡å…³ç³»ï¼Œå»ºè®® Debug ä¸€ä¸‹è¿™ä¸ªå•å…ƒæµ‹è¯•123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172public class NamedContextFactoryTest &#123; private void initEnv(AnnotationConfigApplicationContext parent) &#123; Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put("baidu.socketTimeout", 123); map.put("google.socketTimeout", 456); parent.getEnvironment() .getPropertySources() .addFirst(new MapPropertySource("test", map)); &#125; @Test public void test() &#123; // åˆ›å»º parent context AnnotationConfigApplicationContext parent = new AnnotationConfigApplicationContext(); // parent context çš„ Beanï¼Œå¯ä»¥è¢«å­å®¹å™¨ç»§æ‰¿ parent.register(ParentConfiguration.class); initEnv(parent); parent.refresh(); // å®¹å™¨ name = baidu çš„ context ä¸­ä¼šæ³¨å†Œ TestConfiguration NamedHttpClientSpec spec = new NamedHttpClientSpec("baidu", new Class[]&#123;TestConfiguration.class&#125;); NamedHttpClientFactory namedHttpClientFactory = new NamedHttpClientFactory(); // SpringBoot ä¸­æ— éœ€æ‰‹åŠ¨è®¾ç½®ï¼Œä¼šè‡ªåŠ¨æ³¨å…¥ parent namedHttpClientFactory.setApplicationContext(parent); namedHttpClientFactory.setConfigurations(List.of(spec)); // å‡†å¤‡å·¥ä½œå®Œæˆï¼ŒçŽ°åœ¨å¼€å§‹é€šè¿‡ NamedContextFactory get Bean ParentBean baiduParentBean = namedHttpClientFactory.getInstance("baidu", ParentBean.class); NamedHttpClient baidu = namedHttpClientFactory.getInstance("baidu", NamedHttpClient.class); TestBean baiduTestBean = namedHttpClientFactory.getInstance("baidu", TestBean.class); Assert.assertNotNull(baiduParentBean); Assert.assertEquals("baidu", baidu.getServiceName()); Assert.assertEquals(123, baidu.getRequestConfig().getSocketTimeout()); Assert.assertNotNull(baiduTestBean); ParentBean googleParentBean = namedHttpClientFactory.getInstance("google", ParentBean.class); NamedHttpClient google = namedHttpClientFactory.getInstance("google", NamedHttpClient.class); TestBean googleTestBean = namedHttpClientFactory.getInstance("google", TestBean.class); Assert.assertNotNull(googleParentBean); Assert.assertEquals("google", google.getServiceName()); Assert.assertEquals(456, google.getRequestConfig().getSocketTimeout()); Assert.assertNull(googleTestBean); &#125; static class ParentConfiguration &#123; @Bean public ParentBean parentBean() &#123; return new ParentBean(); &#125; &#125; static class TestConfiguration &#123; @Bean public TestBean testBean() &#123; return new TestBean(); &#125; &#125; static class ParentBean &#123; &#125; static class TestBean &#123; &#125;&#125; UT å®Œæ•´è¿è¡Œå‚è€ƒðŸ‘‰https://github.com/TavenYin/taven-springcloud-learning/blob/master/springcloud-alibaba-nacos/nacos-discovery/src/test/java/com/github/taven/NamedContextFactoryTest.java Spring é¡¹ç›®ä¸­ä½¿ç”¨å­å®¹å™¨å‚è€ƒ ðŸ‘‰https://github.com/TavenYin/taven-springcloud-learning/tree/master/springcloud-alibaba-nacos/nacos-discovery/src/main/java/com/github/taven/namedcontext å¦‚æžœæŸä¸ª Configuration ç±»ï¼Œåªéœ€è¦å­å®¹å™¨åŠ è½½ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä¸æ·»åŠ  @Configurationï¼Œè¿™æ ·å°±ä¸ä¼šè¢« Spring å®¹å™¨ï¼ˆçˆ¶å®¹å™¨ï¼‰åŠ è½½äº†ã€‚ NamedContextFactory æºç åˆ†æžä½¿ç”¨è¯¥ç±»çš„å…¥å£é€šå¸¸æ˜¯ getInstance æ–¹æ³•123456789101112public &lt;T&gt; T getInstance(String name, Class&lt;T&gt; type) &#123; // 1. èŽ·å–å­å®¹å™¨ AnnotationConfigApplicationContext context = getContext(name); try &#123; // 2. ä»Žå­å®¹å™¨ä¸­èŽ·å– Bean return context.getBean(type); &#125; catch (NoSuchBeanDefinitionException e) &#123; // ignore &#125; return null;&#125; è¿™ä¸ªæ–¹æ³•å†…éƒ¨é€»è¾‘å¾ˆç®€å• èŽ·å–å­å®¹å™¨ï¼ˆå¦‚æžœä¸å­˜åœ¨çš„è¯ï¼Œä¼šåˆ›å»ºï¼‰ ä»Žï¼ˆå­ï¼‰å®¹å™¨ä¸­èŽ·å– Beanï¼Œè¿™æ­¥å°±å¯ç†è§£ä¸ºå’Œå¸¸è§„ Spring æ“ä½œä¸€æ ·äº†ï¼Œä»Žå®¹å™¨ä¸­èŽ·å– Beanï¼ˆå­å®¹å™¨åªæ˜¯æ¦‚å¿µä¸Šçš„ä¸€ä¸ªä¸œè¥¿ï¼Œå®žé™… API éƒ½æ˜¯ä¸€æ ·çš„ï¼‰ æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ getContext æ–¹æ³•åšäº†ä»€ä¹ˆ 1234567891011121314151617181920212223242526272829303132333435363738394041public abstract class NamedContextFactory&lt;C extends NamedContextFactory.Specification&gt; implements DisposableBean, ApplicationContextAware &#123; private Map&lt;String, C&gt; configurations = new ConcurrentHashMap&lt;&gt;(); // 1. // çœç•¥å…¶ä»–æˆå‘˜å˜é‡ protected AnnotationConfigApplicationContext createContext(String name) &#123; AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(); if (this.configurations.containsKey(name)) &#123; // 2. for (Class&lt;?&gt; configuration : this.configurations.get(name) .getConfiguration()) &#123; context.register(configuration); &#125; &#125; for (Map.Entry&lt;String, C&gt; entry : this.configurations.entrySet()) &#123; if (entry.getKey().startsWith("default.")) &#123; // 3. for (Class&lt;?&gt; configuration : entry.getValue().getConfiguration()) &#123; context.register(configuration); &#125; &#125; &#125; context.register(PropertyPlaceholderAutoConfiguration.class, this.defaultConfigType); // 4. context.getEnvironment().getPropertySources().addFirst(new MapPropertySource( this.propertySourceName, Collections.&lt;String, Object&gt;singletonMap(this.propertyName, name))); // 5. if (this.parent != null) &#123; // Uses Environment from parent as well as beans context.setParent(this.parent); // jdk11 issue // https://github.com/spring-cloud/spring-cloud-netflix/issues/3101 context.setClassLoader(this.parent.getClassLoader()); &#125; context.setDisplayName(generateDisplayName(name)); context.refresh(); return context; &#125; // çœç•¥å…¶ä»–æ–¹æ³•&#125; è¯¥ Map çš„ value ä¸º Specification çš„å®žçŽ°ï¼ˆç”¨äºŽæä¾› Configurationï¼‰ï¼Œname ä¸ºå®¹å™¨åï¼Œç”¨äºŽå®šåˆ¶æ¯ä¸ªå­å®¹å™¨çš„é…ç½® å¦‚æžœ name åŒ¹é…ï¼Œåˆ™åŠ è½½ Configuration å¦‚æžœ Specification çš„ name ä»¥ default. å¼€å¤´ï¼Œåˆ™æ¯ä¸ªå­å®¹å™¨åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šåŠ è½½è¿™äº›é…ç½® å­å®¹å™¨ä¸­æ³¨å†Œ PropertyPlaceholderAutoConfigurationï¼Œä»¥åŠ defaultConfigTypeï¼ˆPropertyPlaceholderAutoConfiguration ç”¨äºŽè§£æž Bean æˆ–è€… @Value ä¸­çš„å ä½ç¬¦ã€‚defaultConfigType æ˜¯ä¸Šæ–‡ä¸­æåˆ°è¿‡çš„ï¼Œæž„é€ æ–¹æ³•ä¸­æä¾›çš„å­å®¹å™¨é»˜è®¤é…ç½®ç±»ï¼‰ ä¹Ÿæ˜¯æˆ‘ä»¬ä¸Šæ–‡ä¸­è¯´è¿‡çš„ï¼Œå­å®¹å™¨ä¸­å†™å…¥ä¸€æ¡é…ç½®ã€‚ä»¥ä¸Šæ–‡ä¸ºä¾‹ï¼Œä¼šåœ¨å®¹å™¨ä¸­å†™å…¥ä¸€æ¡ http.client.name=å®¹å™¨name å‰©ä¸‹çš„å°±æ˜¯ï¼Œè®¾ç½®çˆ¶å®¹å™¨ï¼Œä»¥åŠåˆå§‹åŒ–æ“ä½œ æœ€åŽå¦‚æžœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼ŒåŠ¨åŠ¨å°æ‰‹ç‚¹ä¸‹å…³æ³¨æˆ–è€…å–œæ¬¢ï¼Œä½ çš„æ”¯æŒæ˜¯å¯¹æˆ‘æœ€å¤§çš„å¸®åŠ©]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SpringBoot</tag>
        <tag>Spring</tag>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring RestTemplate è®¾ç½®æ¯æ¬¡è¯·æ±‚çš„ Timeout]]></title>
    <url>%2Fpost%2F1a81d82f.html</url>
    <content type="text"><![CDATA[å‰è¨€åœ¨å®žçŽ°è¿™ä¸ªåŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘ä¹Ÿä¸Šç½‘æœç´¢äº†ä¸€ä¸‹æ–¹æ¡ˆã€‚å¤§å¤šæ•°çš„è§£å†³æ–¹æ³•éƒ½æ˜¯å®šä¹‰å¤šä¸ª RestTemplate è®¾ç½®ä¸åŒçš„è¶…æ—¶æ—¶é—´ã€‚æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹å¼å‘¢ï¼Ÿå¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ·±å…¥ä¸€ä¸‹ RestTemplate çš„æºç  æç¤ºï¼šæœ¬æ–‡åŒ…å«äº†å¤§é‡çš„æºç åˆ†æžï¼Œå¦‚æžœæƒ³ç›´æŽ¥çœ‹ç¬”è€…æ˜¯å¦‚ä½•å®žçŽ°çš„ï¼Œç›´æŽ¥è·³åˆ°æœ€åŽçš„æ”¹é€ æ€è·¯ ç‰ˆæœ¬SpringBootï¼š2.3.4.RELEASE RestTemplate RestTemplate#doExecute RestTemplate å‘é€è¯·æ±‚çš„æ–¹æ³•ï¼Œéšä¾¿æ‰¾ä¸€ä¸ªæœ€åŽéƒ½ä¼šèµ°åˆ°ä¸Šå›¾çš„ doExecuteã€‚ ä»Žä¸Šå›¾æ¥çœ‹ï¼Œè¿™ä¸ªæ–¹æ³•åšçš„å°±æ˜¯è¿™å‡ ä»¶äº‹ createRequest æ‰§è¡Œ RequestCallback æ‰§è¡Œ Request å¤„ç†å“åº”ï¼Œå°†å“åº”è½¬æ¢æˆç”¨æˆ·å£°æ˜Žçš„ç±»åž‹ RequestCallback åšäº†ä»€ä¹ˆ æ ¹æ® RestTemplate ä¸­çš„å®šä¹‰ HttpMessageConverter å¡«å…… Header Acceptï¼ˆæ”¯æŒçš„å“åº”ç±»åž‹ï¼‰ é€šè¿‡ HttpMessageConverter è½¬æ¢ HttpBody è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯ï¼ŒcreateRequest å’Œ æ‰§è¡Œ Request éƒ¨åˆ† createRequestRestTemplate ä¸­çš„ Request æ˜¯ç”± RequestFactory å®Œæˆåˆ›å»ºã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹èŽ·å– RequestFactory çš„é€»è¾‘ å¦‚æžœ RestTemplate é…ç½®äº† ClientHttpRequestInterceptorï¼ˆæ‹¦æˆªå™¨ï¼‰çš„è¯ï¼Œåˆ™åˆ›å»º InterceptingClientHttpRequestFactoryï¼Œåä¹‹åˆ™ç›´æŽ¥èŽ·å– RequestFactory æˆ‘ä»¬å¯ä»¥é€šè¿‡ RestTemplate#setInterceptors æ‰‹åŠ¨æ·»åŠ æ‹¦æˆªå™¨ï¼› å½“ä½¿ç”¨ @LoadBalanced æ ‡è®° RestTemplate æ—¶ï¼ŒRestTemplate ä¸­ä¹Ÿä¼šè¢«åŠ å…¥æ‹¦æˆªå™¨ï¼Œå…·ä½“åŽŸç†å¯ä»¥å‚è€ƒ org.springframework.cloud.client.loadbalancer.LoadBalancerAutoConfiguration æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ InterceptingClientHttpRequestFactory æ˜¯ä»€ä¹ˆé€»è¾‘ InterceptingClientHttpRequestFactory createRequest æ–¹æ³•ç›´æŽ¥è¿”å›žäº† InterceptingClientHttpRequestï¼Œå‚è€ƒ doExecute çš„é€»è¾‘ï¼ŒæŽ¥ä¸‹æ¥ä¼šæ‰§è¡Œ InterceptingClientHttpRequest#executeï¼Œå…¶å†…éƒ¨ä¼šæ‰§è¡Œåˆ° InterceptingRequestExecution#execute è¿™é‡Œéšä¾¿æ‰¾ä¸€ä¸ªæ‹¦æˆªå™¨çš„å®žçŽ°é…åˆç€æ¥çœ‹ é€»è¾‘æ¢³ç†ä¸€ä¸‹ï¼š InterceptingRequestExecution ä¼šå…ˆåŽ»æ‰§è¡Œæ‰€æœ‰çš„æ‹¦æˆªå™¨ æ‹¦æˆªå™¨åœ¨æ‰§è¡Œå®Œé€»è¾‘ä¹‹åŽï¼Œå†æ¬¡ InterceptingRequestExecution#executeã€‚InterceptingRequestExecution å†æ¬¡è°ƒç”¨ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ åœ¨æ‹¦æˆªå™¨é€»è¾‘æ‰§è¡Œå®Œä¹‹åŽï¼Œä¼šåŽ»è°ƒç”¨çœŸæ­£çš„ RequestFactory åˆ›å»ºè¯·æ±‚ï¼Œç„¶åŽæ‰§è¡Œè¯·æ±‚ åœ¨é˜…è¯»å®Œ InterceptingRequestExecution#execute çš„ä»£ç ä¹‹åŽï¼Œæˆ‘ä»¬å¯ä»¥å‘çŽ°ã€‚è¿™é‡Œä»…ä»…æ˜¯å°† request çš„ uriï¼Œmethodï¼Œheaderï¼Œbody å¤åˆ¶åˆ°äº† delegate ä¸­ã€‚è¯´æ˜Žæ‹¦æˆªå™¨åªèƒ½å¯¹è¿™äº›å±žæ€§è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸èƒ½åœ¨æ‹¦æˆªå™¨å±‚é¢æ·»åŠ  timeout çš„ç›¸å…³å¤„ç†ã€‚ é»˜è®¤æƒ…å†µçš„ RequestFactoryé»˜è®¤æƒ…å†µä¸‹ RestTemplate ä¼šä½¿ç”¨ SimpleClientHttpRequestFactory æ¥åˆ›å»ºè¯·æ±‚ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªç±»ä¸­çœ‹åˆ° setReadTimeout æ–¹æ³•ã€‚ä½†æ˜¯ SimpleClientHttpRequestFactory å¹¶æ²¡æœ‰æä¾›å¯ä»¥æ‹“å±•çš„ç‚¹ï¼Œåªèƒ½è®¾ç½®ä¸€ä¸ªé’ˆå¯¹æ‰€æœ‰è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±é˜…è¯»ä¸‹æºç ï¼Œè¿™é‡Œå°±ä¸è´´å‡ºæ¥äº† HttpComponentsClientHttpRequestFactory åœ¨é˜…è¯» HttpComponentsClientHttpRequestFactory æ—¶ï¼Œå‘çŽ°äº†å¯ä»¥æ‰©å±•çš„åœ°æ–¹ã€‚æ¯æ¬¡åœ¨åˆ›å»º Request çš„æ—¶å€™ï¼Œéƒ½éœ€è¦åœ¨ HttpContext è¿™ä¸ªç±»ä¸­è®¾ç½® RequestConfigï¼Œä½¿ç”¨è¿‡ apache http client çš„åŒå­¦å¯èƒ½çŸ¥é“ RequestConfig è¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»åŒ…å«äº†å¤§é‡çš„å±žæ€§å¯ä»¥å®šä¹‰è¯·æ±‚çš„è¡Œä¸ºï¼Œè¿™å…¶ä¸­æœ‰ä¸€ä¸ªå±žæ€§ socketTimeout æ­£æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„ã€‚ è¿™ä¸ªç±»ä¸­æˆ‘ä»¬å¯ä»¥æ‰©å±•çš„åœ°æ–¹å°±åœ¨ createHttpContext æ–¹æ³•ä¸­ é»˜è®¤æƒ…å†µä¸‹ createHttpContext è¿”å›ž nullï¼Œç„¶åŽä¼šå°è¯•ä»Ž HttpUriRequest å’Œ HttpClient ä¸­èŽ·å– RequestConfig èµ‹å€¼åˆ° HttpContext ä¸­ã€‚ createHttpContext è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ä¹Ÿæ¥çœ‹ä¸€ä¸‹ 12345678910111213141516171819202122232425262728@Nullableprivate BiFunction&lt;HttpMethod, URI, HttpContext&gt; httpContextFactory;/** * Configure a factory to pre-create the &#123;@link HttpContext&#125; for each request. * &lt;p&gt;This may be useful for example in mutual TLS authentication where a * different &#123;@code RestTemplate&#125; for each client certificate such that * all calls made through a given &#123;@code RestTemplate&#125; instance as associated * for the same client identity. &#123;@link HttpClientContext#setUserToken(Object)&#125; * can be used to specify a fixed user token for all requests. * @param httpContextFactory the context factory to use * @since 5.2.7 */public void setHttpContextFactory(BiFunction&lt;HttpMethod, URI, HttpContext&gt; httpContextFactory) &#123; this.httpContextFactory = httpContextFactory;&#125;/** * Template methods that creates a &#123;@link HttpContext&#125; for the given HTTP method and URI. * &lt;p&gt;The default implementation returns &#123;@code null&#125;. * @param httpMethod the HTTP method * @param uri the URI * @return the http context */@Nullableprotected HttpContext createHttpContext(HttpMethod httpMethod, URI uri) &#123; return (this.httpContextFactory != null ? this.httpContextFactory.apply(httpMethod, uri) : null);&#125; è‡³æ­¤ï¼Œå·²ç»å¾ˆæ¸…æ™°äº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ setHttpContextFactory æ¥æ”¹å˜ createHttpContext çš„ç»“æžœã€‚ æ”¹é€ æ€è·¯æˆ‘ä»¬å¯ä»¥å¼€å§‹è¿›è¡Œæ”¹é€ äº†ï¼Œæ€è·¯å¦‚ä¸‹ é»˜è®¤çš„è¶…æ—¶æ—¶é—´ç­‰å±žæ€§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ HttpComponentsClientHttpRequestFactory#setHttpClient æˆ–è€… HttpComponentsClientHttpRequestFactory#setReadTimeout æ¥å†³å®š åœ¨éœ€è¦è‡ªå®šä¹‰ RequsetConfig çš„åœºæ™¯ï¼Œå°† RequsetConfig å­˜å‚¨åœ¨ ThreadLocal ä¸­ æˆ‘ä»¬è‡ªå®šä¹‰çš„ HttpContextFactory åœ¨è¯»å–åˆ° ThreadLocal ä¸­çš„ RequsetConfig åŽï¼Œä¼šç”Ÿæˆä¸€ä¸ª HttpContextï¼Œå…¶ä»–æƒ…å†µè¿”å›ž nullï¼ˆèµ°åŽŸæ¥çš„é€»è¾‘ï¼‰ ä»£ç å¦‚ä¸‹123456789101112public class CustomHttpContextFactory implements BiFunction&lt;HttpMethod, URI, HttpContext&gt; &#123; @Override public HttpContext apply(HttpMethod httpMethod, URI uri) &#123; RequestConfig requestConfig = RequestConfigHolder.get(); if (requestConfig != null) &#123; HttpContext context = HttpClientContext.create(); context.setAttribute(HttpClientContext.REQUEST_CONFIG, requestConfig); return context; &#125; return null; &#125;&#125; 12345678910111213141516public class RequestConfigHolder &#123; private static final ThreadLocal&lt;RequestConfig&gt; threadLocal = new ThreadLocal&lt;&gt;(); public static void bind(RequestConfig requestConfig) &#123; threadLocal.set(requestConfig); &#125; public static RequestConfig get() &#123; return threadLocal.get(); &#125; public static void clear() &#123; threadLocal.remove(); &#125;&#125; é…ç½®ç±»1234567891011121314@Configurationpublic class RestTemplateConfiguration &#123; @Bean("customTimeoutRestTemplate") public RestTemplate customTimeout() &#123; RestTemplate restTemplate = new RestTemplate(); HttpComponentsClientHttpRequestFactory requestFactory = new HttpComponentsClientHttpRequestFactory(); requestFactory.setHttpContextFactory(new CustomHttpContextFactory()); requestFactory.setReadTimeout(3000); restTemplate.setRequestFactory(requestFactory); return restTemplate; &#125;&#125; ä½¿ç”¨æ¡ˆä¾‹1234567891011@GetMapping("custom/setTimeout")public String customSetTimeout(Integer timeout) &#123; RequestConfig requestConfig = RequestConfig.custom().setSocketTimeout(timeout).build(); try &#123; RequestConfigHolder.bind(requestConfig); customTimeoutRestTemplate.getForObject("https://www.baidu.com", String.class); &#125; finally &#123; RequestConfigHolder.clear(); &#125; return "OK";&#125; æ€è·¯å°±æ˜¯è¿™æ ·ï¼Œå¯ä»¥å°†è¿™ä¸ªä½¿ç”¨æ–¹å¼å°è£…ä¸º æ³¨è§£ + AOPï¼Œè¿™æ ·ç”¨èµ·æ¥ä¼šæ›´ç®€å•ã€‚ Demoæœ¬æ–‡å®Œæ•´ demoï¼šhttps://github.com/TavenYin/taven-springboot-learning/tree/master/springboot-restTemplate æœ€åŽå¦‚æžœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼ŒåŠ¨åŠ¨å°æ‰‹ç‚¹ä¸‹å…³æ³¨æˆ–è€…å–œæ¬¢ï¼Œä½ çš„æ”¯æŒæ˜¯å¯¹æˆ‘æœ€å¤§çš„å¸®åŠ©]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SpringBoot</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å“åº”å¼ç¼–ç¨‹å…¥é—¨ä¹‹ Project Reactor]]></title>
    <url>%2Fpost%2Fe1d95725.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡ç›®æ ‡ ç†è§£å“åº”å¼ç¼–ç¨‹ å‰è¨€ä¹‹å‰çš„ ã€ŠèŠèŠ IO å¤šè·¯å¤ç”¨ã€‹ ä¸­ï¼Œæˆ‘ä»¬ç†è§£äº†éžé˜»å¡ž IO çš„æ„ä¹‰ã€‚ä½†æ˜¯ Spring MVC å¹¶ä¸èƒ½å®Œç¾Žçš„åº”ç”¨éžé˜»å¡žç¼–ç¨‹ï¼ŒäºŽæ˜¯ Spring å›¢é˜Ÿå¼€å‘äº† WebFluxï¼Œè€Œ WebFlux çš„åŸºç¡€æ­£æ˜¯æœ¬æ–‡è¦è®²åˆ°çš„ Project Reactorï¼ˆä¸‹æ–‡ç®€ç§°ä¸º Reactorï¼‰ æœ¬æ–‡ä»¥ Reactor ä¸ºä¾‹å¸¦å¤§å®¶å…¥é—¨å“åº”å¼ç¼–ç¨‹ ç‰ˆæœ¬12345&lt;dependency&gt; &lt;groupId&gt;io.projectreactor&lt;/groupId&gt; &lt;artifactId&gt;reactor-core&lt;/artifactId&gt; &lt;version&gt;3.4.6&lt;/version&gt;&lt;/dependency&gt; ä»€ä¹ˆæ˜¯ Reactor Reactor æ˜¯ JVM çš„éžé˜»å¡žå“åº”å¼ç¼–ç¨‹åŸºç¡€ï¼Œæ”¯æŒèƒŒåŽ‹ã€‚ å®ƒç›´æŽ¥ä¸Ž Java 8 å‡½æ•°å¼ API é›†æˆï¼Œç‰¹åˆ«æ˜¯ CompletableFutureã€Stream å’Œ Durationã€‚ å®ƒæä¾›äº†å¯ç»„åˆçš„å¼‚æ­¥åºåˆ— API â€” Fluxï¼ˆç”¨äºŽ [N] ä¸ªå…ƒç´ ï¼‰å’Œ Monoï¼ˆç”¨äºŽ [0|1] ä¸ªå…ƒç´ ï¼‰ï¼Œå¹¶å®žçŽ°äº† Reactive Streams è§„èŒƒã€‚åœ¨ Reactor çš„åŸºç¡€ä¸Šè¿˜æ¼”åŒ–å‡ºäº†é€‚åˆå¾®æœåŠ¡æž¶æž„çš„ Reactor Netty ã€‚ä¸º HTTPï¼ˆåŒ…æ‹¬ Websocketsï¼‰ã€TCP å’Œ UDP æä¾›æ”¯æŒèƒŒåŽ‹å’Œå“åº”å¼çš„ç½‘ç»œå¼•æ“Žã€‚ ä¸Šé¢æ˜¯å¯¹äºŽå®˜æ–¹æ–‡æ¡£çš„ç¿»è¯‘ã€‚ä¸‹é¢æ¥è¯´è¯´æˆ‘è‡ªå·±å¯¹ Reactor å’Œå“åº”å¼ç¼–ç¨‹çš„ç†è§£ã€‚ å›žæƒ³ä¸€ä¸‹ä¹‹å‰çš„éžé˜»å¡ž IO ç¼–ç¨‹ï¼Œä¾‹å¦‚æˆ‘ä»¬çŽ°åœ¨è¦ç”¨éžé˜»å¡žçš„æ–¹å¼è°ƒç”¨ä¸€ä¸ªè¿œç¨‹æœåŠ¡ï¼Œå½“è¿œç¨‹æŽ¥å£æ•°æ®å¯ç”¨æ—¶åŽ»åšä¸€äº›ä¸šåŠ¡å¤„ç†ã€‚è¿™æ—¶å€™ä»£ç æ€Žä¹ˆå†™å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªå›žè°ƒå‡½æ•°ï¼Œç„¶åŽåœ¨å“åº”å°±ç»ªçš„æ—¶å€™ï¼ŒåŽ»è°ƒç”¨æˆ‘ä»¬çš„å›žè°ƒå‡½æ•°ã€‚ ä»Žé€»è¾‘ä¸Šæ¥çœ‹ï¼Œè¿™å®Œå…¨æ²¡æœ‰é—®é¢˜ã€‚ä½†æ˜¯å¦‚æžœæˆ‘ä»¬çš„å›žè°ƒå¾ˆå¤æ‚ï¼Œä»£ç çœ‹èµ·æ¥ä¼šæ˜¯ä»€ä¹ˆæ ·å‘¢ï¼Ÿ 1234567891011121314151617181920212223242526272829303132333435363738// ä»¥ä¸‹æ¡ˆä¾‹æ¥è‡ª Reactor å®˜ç½‘userService.getFavorites(userId, new Callback&lt;List&lt;String&gt;&gt;() &#123; public void onSuccess(List&lt;String&gt; list) &#123; if (list.isEmpty()) &#123; suggestionService.getSuggestions(new Callback&lt;List&lt;Favorite&gt;&gt;() &#123; public void onSuccess(List&lt;Favorite&gt; list) &#123; UiUtils.submitOnUiThread(() -&gt; &#123; list.stream() .limit(5) .forEach(uiList::show); &#125;); &#125; public void onError(Throwable error) &#123; UiUtils.errorPopup(error); &#125; &#125;); &#125; else &#123; list.stream() .limit(5) .forEach(favId -&gt; favoriteService.getDetails(favId, new Callback&lt;Favorite&gt;() &#123; public void onSuccess(Favorite details) &#123; UiUtils.submitOnUiThread(() -&gt; uiList.show(details)); &#125; public void onError(Throwable error) &#123; UiUtils.errorPopup(error); &#125; &#125; )); &#125; &#125; public void onError(Throwable error) &#123; UiUtils.errorPopup(error); &#125;&#125;); è¿™ä¸ªä»£ç è¯´å®žè¯å·²ç»æœ‰ç‚¹å›žè°ƒåœ°ç‹±é‚£å‘³å„¿äº†ï¼Œè®©ä¸€æ®µä¸æ˜¯å¾ˆå¤æ‚çš„é€»è¾‘å˜å¾—å¾ˆéš¾è¯»äº†ã€‚ä½†æ˜¯å¦‚æžœç”¨ Reactor å†™å‘¢ï¼Ÿ 1234567// ä»¥ä¸‹æ¡ˆä¾‹æ¥è‡ª Reactor å®˜ç½‘userService.getFavorites(userId) .flatMap(favoriteService::getDetails) .switchIfEmpty(suggestionService.getSuggestions()) .take(5) .publishOn(UiUtils.uiThreadScheduler()) .subscribe(uiList::show, UiUtils::errorPopup); å¯ä»¥çœ‹åˆ°ï¼Œä»£ç å˜å¾—éžå¸¸çš„ç®€æ´ã€‚å”¯ä¸€å¸¦æ¥çš„å›°æ‰°å°±æ˜¯ï¼Œæˆ‘ä»¬ä¸çŸ¥é“è¿™äº›å‡½æ•°åˆ°åº•æ˜¯å•¥æ„æ€ ðŸ˜‚ å“åº”å¼ç¼–ç¨‹è™½ç„¶æœ‰éžå¸¸å¤šçš„ç‰¹æ€§ï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯ä»€ä¹ˆç¥žå¥‡çš„æŠ€æœ¯ï¼Œå®ƒä¹Ÿæ˜¯å»ºç«‹åœ¨ä¼ ç»Ÿå‘½ä»¤å¼ç¼–ç¨‹çš„åŸºç¡€ä¸Šã€‚åªä¸è¿‡å®ƒæ‰€æä¾›çš„ API ä»¥åŠè§„èŒƒæ›´é€‚åˆåœ¨éžé˜»å¡ž IO ä¸­ä½¿ç”¨ã€‚è™½ç„¶åœ¨éžé˜»å¡ž IO æ¡†æž¶ä¸­å‡ ä¹Žåªä½¿ç”¨å“åº”å¼ç¼–ç¨‹ï¼ˆVertxï¼ŒWebFluxï¼‰ï¼Œåªæ˜¯å› ä¸ºè¿™æ ·åšæ›´åˆé€‚ï¼Œå¹¶ä¸æ˜¯è¯´æ²¡äº†å“åº”å¼ç¼–ç¨‹ï¼Œå°±çŽ©ä¸äº†éžé˜»å¡ž IO äº†ã€‚ å“åº”å¼ç¼–ç¨‹å†…å¹•Reactor å®žçŽ°äº† org.reactivestreams æä¾›çš„ Java å“åº”å¼ç¼–ç¨‹è§„èŒƒï¼Œæˆ‘ä»¬åªè¦äº†è§£ reactivestreams ä¸­ä»£ç æ˜¯å¦‚ä½•è¿è½¬çš„ï¼Œå†çœ‹ Reactor ç›¸å…³çš„ä»£ç å°±å®¹æ˜“å¤šäº†ã€‚ ä¸‹å›¾å±•ç¤ºäº† reactivestreams ä¸­çš„æ ¸å¿ƒæŽ¥å£ Publisherï¼šå‘å¸ƒè€… Subscriberï¼šè®¢é˜…è€… Subscriptionï¼šè¿™ä¸ªå•è¯ä¸­æ–‡ç¿»è¯‘ä¸ºåè¯çš„è®¢é˜…ï¼Œåœ¨ä»£ç ä¸­å®ƒæ˜¯å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´çš„åª’ä»‹ Processorï¼šè¯¥æŽ¥å£ç»§æ‰¿äº†å‘å¸ƒè€…å’Œè®¢é˜…è€…ï¼Œå¯ä»¥ç†è§£ä¸ºå‘å¸ƒè€…å’Œè®¢é˜…è€…çš„ä¸­é—´æ“ä½œï¼ˆä½†æ˜¯ Reactor çš„ä¸­é—´æ“ä½œå¹¶æ²¡æœ‰å®žçŽ° Processorï¼Œåœ¨æœ€æ–°ç‰ˆæœ¬çš„ Reactor ä¸­ï¼ŒProcessor çš„ç›¸å…³å®žçŽ°æŽ¥å£å·²ç»è¢«å¼ƒç”¨ï¼‰ åœ¨äº†è§£äº†å“åº”å¼ç¼–ç¨‹çš„æ ¸å¿ƒæŽ¥å£ä¹‹åŽï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å“åº”å¼ç¼–ç¨‹æ˜¯å¦‚ä½•è¿ä½œçš„ åœ¨ Reactor ä¸­å¤§éƒ¨åˆ†å®žçŽ°éƒ½æ˜¯æŒ‰ç…§ä¸Šå›¾çš„é€»è¾‘æ¥æ‰§è¡Œçš„ é¦–å…ˆæ˜¯Subscriberï¼ˆè®¢é˜…è€…ï¼‰ä¸»åŠ¨è®¢é˜… Publisherï¼ˆå‘å¸ƒè€…ï¼‰ï¼Œé€šè¿‡è°ƒç”¨ Publisher çš„ subscribe æ–¹æ³• Publisher åœ¨å‘ä¸‹æ¸¸å‘é€æ•°æ®ä¹‹å‰ï¼Œä¼šå…ˆè°ƒç”¨ Subscriber çš„ onSubscribe æ–¹æ³•ï¼Œä¼ é€’çš„å‚æ•°ä¸º Subscriptionï¼ˆè®¢é˜…åª’ä»‹ï¼‰ Subscriber é€šè¿‡ Subscription#request æ¥è¯·æ±‚æ•°æ®ï¼Œæˆ–è€… Subscription#cancel æ¥å–æ¶ˆæ•°æ®å‘å¸ƒï¼ˆè¿™å°±æ˜¯å“åº”å¼ç¼–ç¨‹ä¸­çš„èƒŒåŽ‹ï¼Œè®¢é˜…è€…å¯ä»¥æŽ§åˆ¶æ•°æ®å‘å¸ƒï¼‰ Subscription åœ¨æŽ¥æ”¶åˆ°è®¢é˜…è€…çš„è°ƒç”¨åŽï¼Œé€šè¿‡ Subscriber#onNext å‘ä¸‹æ¸¸è®¢é˜…è€…ä¼ é€’æ•°æ®ã€‚ åœ¨æ•°æ®å‘å¸ƒå®ŒæˆåŽï¼Œè°ƒç”¨ Subscriber#onComplete ç»“æŸæœ¬æ¬¡æµï¼Œå¦‚æžœæ•°æ®å‘å¸ƒæˆ–è€…å¤„ç†é‡åˆ°é”™è¯¯ä¼šè°ƒç”¨ Subscriber#onError è°ƒç”¨ Subscriber#onNextï¼ŒonCompleteï¼ŒonError è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œå¯èƒ½æ˜¯åœ¨ Publisher ä¸­åšçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯åœ¨ Subscription ä¸­åšçš„ï¼Œæ ¹æ®ä¸åŒçš„åœºæ™¯æœ‰ä¸åŒçš„å®žçŽ°æ–¹å¼ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆä¸¥æ ¼çš„è¦æ±‚ã€‚å¯ä»¥è®¤ä¸º Publisher å’Œ Subscription å…±åŒé…åˆå®Œæˆäº†æ•°æ®å‘å¸ƒ å…¶å®ž Reactor ä¸­ API å®žçŽ°åŽŸç†ä¹Ÿéƒ½æ˜¯è¿™ä¸ªå¥—è·¯ï¼Œæˆ‘è¿™è¾¹ä¹Ÿè‡ªå·±å†™äº†ä¸ªä¾‹å­ä¾¿äºŽè®©è¯»è€…åŠ æ·±å¯¹å“åº”å¼ç¼–ç¨‹çš„ç†è§£ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687import org.reactivestreams.Publisher;import org.reactivestreams.Subscriber;import org.reactivestreams.Subscription;/** * @author tianwen.yin */public class SimpleReactiveStream &#123; /** * å®žçŽ°ä¸€ä¸ªç®€å•çš„å“åº”å¼ç¼–ç¨‹å‘å¸ƒè€… * é€»è¾‘ï¼šå½“è®¢é˜…è€…å‘èµ·è®¢é˜…æ—¶ï¼Œåƒä¸‹æ¸¸å‘é€ä¸€ä¸ª HelloWorldï¼Œå‘å¸ƒé€»è¾‘ç”± SimpleSubscription å®Œæˆ */ static class SimplePublisher implements Publisher &#123; @Override public void subscribe(Subscriber s) &#123; // 2. Publisher å‘å¸ƒæ•°æ®ä¹‹å‰ï¼Œè°ƒç”¨ Subscriber çš„ onSubscribe s.onSubscribe(new SimpleSubscription(data(), s)); &#125; private String data() &#123; return "Hello World"; &#125; &#125; static class SimpleSubscriber implements Subscriber &#123; @Override public void onSubscribe(Subscription s) &#123; // 3. Subscriber é€šè¿‡ Subscription#request æ¥è¯·æ±‚æ•°æ® // æˆ–è€… Subscription#cancel æ¥å–æ¶ˆæ•°æ®å‘å¸ƒ s.request(Long.MAX_VALUE); &#125; @Override public void onNext(Object o) &#123; System.out.println(o); &#125; @Override public void onError(Throwable t) &#123; System.out.println("error"); &#125; @Override public void onComplete() &#123; System.out.println("complete"); &#125; &#125; static class SimpleSubscription implements Subscription &#123; String data; Subscriber actual; boolean isCanceled; public SimpleSubscription(String data, Subscriber actual) &#123; this.data = data; this.actual = actual; &#125; @Override public void request(long n) &#123; if (!isCanceled) &#123; try &#123; // 4. Subscription åœ¨æŽ¥æ”¶åˆ°è®¢é˜…è€…çš„è°ƒç”¨åŽ // é€šè¿‡ Subscriber#onNext å‘ä¸‹æ¸¸è®¢é˜…è€…ä¼ é€’æ•°æ® actual.onNext(data); // 5. åœ¨æ•°æ®å‘å¸ƒå®ŒæˆåŽï¼Œè°ƒç”¨ Subscriber#onComplete ç»“æŸæœ¬æ¬¡æµ actual.onComplete(); &#125; catch (Exception e) &#123; // å¦‚æžœæ•°æ®å‘å¸ƒæˆ–è€…å¤„ç†é‡åˆ°é”™è¯¯ä¼šè°ƒç”¨ Subscriber#onError actual.onError(e); &#125; &#125; &#125; @Override public void cancel() &#123; isCanceled = true; &#125; &#125; public static void main(String[] args) &#123; // 1. Subscriber â€è®¢é˜…â€œ Publisher new SimplePublisher().subscribe(new SimpleSubscriber()); &#125;&#125; å“åº”å¼ç¼–ç¨‹æ€æƒ³å“åº”å¼ç¼–ç¨‹ï¼Œå°±åƒè£…é…ä¸€æ¡æµæ°´çº¿ã€‚Publisher è§„å®šäº†æ•°æ®å¦‚ä½•ç”Ÿäº§ï¼Œä¸­é—´ä¼šæœ‰ Operatorsï¼ˆæ“ä½œç¬¦ï¼‰å¯¹æµæ°´çº¿çš„æ•°æ®è¿›è¡Œè§£æžï¼Œæ ¡éªŒï¼Œè½¬æ¢ç­‰ç­‰æ“ä½œï¼Œæœ€ç»ˆå¤„ç†å¥½çš„æ•°æ®æµè½¬åˆ° Subscriberã€‚ è¿™æ¡æµæ°´çº¿è¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹å½“ Publisher çš„ subscribe æ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰ï¼Œä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿã€‚åœ¨è¢«è®¢é˜…ä¹‹å‰æˆ‘ä»¬åªæ˜¯åœ¨å®šä¹‰æµæ°´çº¿è¯¥å¦‚ä½•å·¥ä½œï¼Œç›´åˆ°çœŸæ­£æœ‰äººéœ€è¦çš„æ—¶å€™ï¼Œæµæ°´çº¿æ‰ä¼šå¯åŠ¨ã€‚ Reactor ä¸­çš„ OperatorOperators æ€Žä¹ˆç†è§£å‘¢ï¼Ÿå¯¹äºŽä¸Šæ¸¸æ¥è¯´ï¼ŒOperators åƒä¸€ä¸ªè®¢é˜…è€…ï¼Œè€Œå¯¹äºŽå®ƒçš„ä¸‹æ¸¸æ¥è¯´ï¼Œå®ƒåƒä¸€ä¸ªå‘å¸ƒè€…ï¼ˆæˆ‘ä»¬ä¸Šæ–‡è¯´è¿‡äº† Reactor ä¸­çš„ä¸­é—´æ“ä½œå¹¶æ²¡æœ‰å®žçŽ° Processor æŽ¥å£ï¼‰ 123Mono.just("hello") .map(a -&gt; a + "world") .subscribe(System.out::println); ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œmap å°±æ˜¯ä¸€ä¸ª Operatorï¼Œå®ƒçš„å®žçŽ°æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿæ¥çœ‹ä¸‹é¢çš„ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051// æ³¨æ„ï¼Œè¿™æ˜¯æˆ‘åŸºäºŽ Reactor API å®žçŽ°çš„ä¼ªä»£ç ï¼public static class MonoMap implements Publisher &#123; // æˆ‘ä»¬è‡ªå®šä¹‰çš„è½¬æ¢é€»è¾‘ private Function mapper; // source ä»£è¡¨å½“å‰æ“ä½œç¬¦çš„ä¸Šæ¸¸å‘å¸ƒè€… private Publisher source; public MonoMap(Publisher source, Function mapper) &#123; this.source = source; this.mapper = mapper; &#125; @Override public void subscribe(Subscriber actual) &#123; source.subscribe(new MonoMapSubscriber(mapper, actual)); &#125;&#125;public static class MonoMapSubscriber implements Subscriber &#123; // æˆ‘ä»¬è‡ªå®šä¹‰çš„è½¬æ¢é€»è¾‘ private Function mapper; // çœŸæ­£çš„ä¸‹æ¸¸ private Subscriber actual; public MonoMapSubscriber(Function mapper, Subscriber actual) &#123; this.mapper = mapper; this.actual = actual; &#125; @Override public void onSubscribe(Subscription s) &#123; actual.onSubscribe(s); &#125; @Override public void onNext(Object o) &#123; // å½“ä¸Šæ¸¸æ•°æ®å‘é€è¿‡æ¥æ—¶ï¼Œå…ˆè¿›è¡Œè½¬æ¢å†å‘é€ç»™ä¸‹æ¸¸ Object result = mapper.apply(o); actual.onNext(result); &#125; @Override public void onError(Throwable t) &#123; actual.onError(t); &#125; @Override public void onComplete() &#123; actual.onComplete(); &#125;&#125; ä¸Šè¿°ä»£ç æ˜¯æˆ‘è‡ªå·±å®žçŽ°çš„ä¸€ä¸ªä¼ªä»£ç ï¼Œç”¨äºŽè®©å¤§å®¶ç†è§£æ“ä½œç¬¦çš„å®žçŽ°æ€è·¯ï¼Œå®žé™… Reactor ä»£ç ä¹Ÿæ˜¯è¿™ä¸ªæ€è·¯ï¼Œåªä¸è¿‡å®žçŽ°çš„æ›´åŠ å·§å¦™å’Œä¸¥è°¨ æˆ‘ä»¬é¦–å…ˆæ¥åˆ†æžä¸€ä¸‹ Mono.just(&quot;hello&quot;).map(a -&gt; a + &quot;world&quot;) è¿™å¥è¯ å½“æ‰§è¡Œåˆ° Mono.just æ—¶ï¼Œä¼šæ–°å»ºä¸€ä¸ª MonoJust å¯¹è±¡ä½œä¸ºå½“å‰çš„ Publisherã€‚è¯¥å‘å¸ƒè€…çš„é€»è¾‘æ˜¯ï¼Œå½“è®¢é˜…æ—¶ï¼Œå‘ä¸‹æ¸¸å‘é€æ•°æ® â€œhelloâ€ å½“æ‰§è¡Œåˆ° map æ–¹æ³•æ—¶ï¼Œä¼šæ–°å»ºä¸€ä¸ª MonoMap å¯¹è±¡æ›¿ä½œä¸ºå½“å‰çš„ Publisherï¼ŒMonoJust æˆä¸ºäº† MonoMap ä¸­çš„ä¸€ä¸ªå±žæ€§ sourceï¼ˆå®žé™…çš„ä¸Šæ¸¸ï¼‰ å½“ MonoMap è¢«è®¢é˜…æ—¶ï¼Œä¼šå…ˆå°†å®ƒçš„ä¸‹æ¸¸ actual åšä¸€å±‚åŒ…è£…ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„ MonoMapSubscriberã€‚ç„¶åŽåŽ»è°ƒç”¨ source çš„ subscribe æ–¹æ³•ã€‚ä¸Šæ¸¸å‘å¸ƒæ•°æ®æ—¶ï¼ŒMonoMapSubscriber å…ˆå¯¹æ•°æ®è¿›è¡Œè½¬æ¢ï¼ˆæˆ‘ä»¬ä¸Šé¢çš„æ‹¼æŽ¥å­—ç¬¦ä¸²æ“ä½œï¼‰ï¼Œç„¶åŽå†å‘é€ç»™ actualï¼ˆå®ƒçš„ä¸‹æ¸¸ï¼‰ å½“ MonoMap è¢«å†æ¬¡è½¬æ¢æ—¶ï¼ŒMonoMap å°±å˜æˆäº†ä¸‹æ¸¸æ“ä½œç¬¦çš„ sourceâ€¦ æœ€åŽé€šè¿‡ä¸€å¼ å›¾æ¥æ€»ç»“ä¸€ä¸‹ Reactor è¯¥å¦‚ä½•å­¦ä¹ æœ¬æ–‡å¹¶æ²¡æœ‰ä»‹ç»å¤ªå¤š Reactor çš„ç»†èŠ‚ï¼Œå› ä¸ºè¿™äº›ä¸œè¥¿å®žåœ¨æ˜¯å¤ªå¤šäº†ã€‚æˆ‘æƒ³èŠèŠæˆ‘è‡ªå·±æ˜¯å¦‚ä½•å­¦ä¹  Reactor çš„ å¦‚æžœä½ å·²ç»é€šè¿‡æœ¬æ–‡ç†è§£äº†å“åº”å¼ç¼–ç¨‹çš„æ ¸å¿ƒæŽ¥å£æ˜¯å¦‚ä½•å·¥ä½œçš„äº†ï¼Œé‚£æ­å–œä½ å·²ç»è¿ˆå‘äº†æˆåŠŸçš„ç¬¬ä¸€æ­¥äº†ã€‚æŽ¥ä¸‹æ¥å°±æ˜¯é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼Œä¸æ–­çš„ç»ƒä¹ å’Œé˜…è¯» Reactor çš„æºç ã€‚æºç è¿½è¸ªçš„æ–¹å‘å·²ç»å¾ˆæ˜Žç¡®äº†ï¼Œå½“æˆ‘ä»¬æƒ³äº†è§£ä¸€ä¸ªå‘å¸ƒè€…çš„å®žçŽ°åŽŸç†æ˜¯ä»€ä¹ˆï¼Œæˆ‘å°±è¦åŽ»å…³æ³¨è¿™ä¸ªå‘å¸ƒè€…çš„ subscribe æ–¹æ³•å’Œ Subscription éƒ½åšäº†ä»€ä¹ˆã€‚æƒ³äº†è§£æ¶ˆè´¹è€…çš„é€»è¾‘ï¼Œå°±çœ‹å®ƒçš„ onNextï¼ŒonCompleteï¼ŒonErrorã€‚ æœ€åŽ å¦‚æžœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼ŒåŠ¨åŠ¨å°æ‰‹ç‚¹ä¸‹å…³æ³¨ï¼Œä½ çš„æ”¯æŒæ˜¯å¯¹æˆ‘æœ€å¤§çš„å¸®åŠ©]]></content>
      <categories>
        <category>å“åº”å¼ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Reactor</tag>
        <tag>å“åº”å¼ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Opentracing é“¾è·¯è¿½è¸ªå®žæˆ˜]]></title>
    <url>%2Fpost%2F8966d8dd.html</url>
    <content type="text"><![CDATA[é“¾è·¯è¿½è¸ªçš„ä½œç”¨å½“ç³»ç»Ÿæž¶æž„ä»Žå•æœºè½¬å˜ä¸ºå¾®æœåŠ¡åŽï¼Œæˆ‘ä»¬çš„ä¸€æ¬¡åŽç«¯è¯·æ±‚ï¼Œå¯èƒ½åŽ†ç»äº†å¤šä¸ªæœåŠ¡æ‰æœ€ç»ˆå“åº”åˆ°å®¢æˆ·ç«¯ã€‚å¦‚æžœè¯·æ±‚æŒ‰ç…§é¢„æœŸæ­£ç¡®å“åº”è¿˜å¥½ï¼Œä¸‡ä¸€åœ¨è°ƒç”¨é“¾çš„æŸä¸€çŽ¯èŠ‚å‡ºçŽ°äº†é—®é¢˜ï¼ŒæŽ’æŸ¥èµ·æ¥æ˜¯å¾ˆéº»çƒ¦çš„ã€‚ä½†æ˜¯å¦‚æžœæœ‰é“¾è·¯è¿½è¸ªçš„è¯ï¼Œå°±å®¹æ˜“å¾ˆå¤šäº†ã€‚ å¯ä»¥é€šè¿‡é“¾è·¯åŸ‹ç‚¹ï¼Œè®°å½•è¯·æ±‚é“¾ä¸­æ‰€æœ‰é‡è¦çš„æ­¥éª¤ï¼Œä¾‹å¦‚ä¸Žå“ªäº›æ•°æ®åº“åšäº†äº¤äº’ï¼Œè°ƒç”¨äº†å“ªäº›ä¸‹æ¸¸æœåŠ¡ï¼Œä¸‹æ¸¸æœåŠ¡åˆä¸Žå“ªäº›æ•°æ®åº“åšäº†äº¤äº’ï¼Œåˆè°ƒç”¨äº†å“ªäº›ä¸‹æ¸¸æœåŠ¡â€¦ ä¸‹å›¾æ˜¯ jaeger UI ä¸ºä¾‹ï¼Œæ¯æ¬¡é“¾è·¯è¿½è¸ªéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªå”¯ä¸€çš„ TraceIdï¼Œé€šè¿‡è¯¥ Id å¯ä»¥æŸ¥çœ‹è¯·æ±‚é“¾è·¯çš„çŠ¶æ€ ä¸‹æ¸¸æœåŠ¡å¯ä»¥æ­£å¸¸è®¿é—®æ—¶ RestTemplate æ— æ³•è®¿é—®ä¸‹æ¸¸æœåŠ¡æ—¶ å½“æœ‰äº†é“¾è·¯è¿½è¸ªä¹‹åŽã€‚æˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°é—®é¢˜å‡ºåœ¨å“ªã€‚ ä»€ä¹ˆæ˜¯ OpentracingOpentracing åˆ¶å®šäº†ä¸€å¥—é“¾è·¯è¿½è¸ªçš„ API è§„èŒƒï¼Œæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ã€‚è™½ç„¶OpenTracingä¸æ˜¯ä¸€ä¸ªæ ‡å‡†è§„èŒƒï¼Œä½†çŽ°åœ¨å¤§å¤šæ•°é“¾è·¯è·Ÿè¸ªç³»ç»Ÿéƒ½åœ¨å°½é‡å…¼å®¹OpenTracing ä½¿ç”¨ Opentracing æ—¶ï¼Œè¿˜éœ€è¦é›†æˆå®žçŽ°è¯¥è§„èŒƒçš„é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œä¾‹å¦‚æˆ‘ä»¬çš„é¡¹ç›®æ­£åœ¨ä½¿ç”¨ Jaegerï¼Œæœ¬æ–‡ä¹ŸåŒæ ·ä»¥ Jaeger ä¸ºä¾‹ Opentracing æ ¸å¿ƒæŽ¥å£ Tracerï¼šç”¨äºŽåˆ›å»º Spanï¼Œä»¥åŠè·¨è¿›ç¨‹é“¾è·¯è¿½è¸ª Spanï¼šTracer ä¸­çš„åŸºæœ¬å•å…ƒï¼Œä¸Šå›¾ä¸­æ¯ä¸€ä¸ªè“è‰²æˆ–è€…é»„è‰²çš„å—éƒ½æ˜¯ä¸€ä¸ª Spanã€‚Span åŒ…å«çš„å±žæ€§æœ‰ tagï¼Œlogï¼ŒSpanContextï¼ŒBaggageItem SpanContextï¼šSpan ä¸Šä¸‹æ–‡ï¼Œç”¨äºŽè·¨è¿›ç¨‹ä¼ é€’ Spanï¼Œä»¥åŠæ•°æ®å…±äº« ScopeManagerï¼šç”¨äºŽèŽ·å–å½“å‰ä¸Šä¸‹æ–‡ä¸­ Spanï¼Œæˆ–è€…å°† Span è®¾ç½®åˆ°å½“å‰ä¸Šä¸‹æ–‡ Scopeï¼šä¸Ž ScopeManager é…åˆä½¿ç”¨ï¼Œæˆ‘ä»¬åœ¨åŽé¢çš„ä¾‹å­ä¸­ä¼šè¯´æ˜Ž å¿«é€Ÿå¼€å§‹é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆéƒ¨ç½²ä¸€ä¸ª jaeger æœåŠ¡ã€‚å…³äºŽ jaeger æœåŠ¡çš„æ›´å¤šç»†èŠ‚ï¼Œè¿™é‡Œä¸å¤šè¯´äº†ï¼Œå„ä½è¯»è€…å¯ä»¥è‡ªè¡ŒåŽ» jaeger å®˜ç½‘é˜…è¯» æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå¯åŠ¨ jaeger æœåŠ¡docker run -d --name jaeger -e COLLECTOR_ZIPKIN_HOST_PORT=:9411 -p 5775:5775/udp -p 6831:6831/udp -p 6832:6832/udp -p 5778:5778 -p 16686:16686 -p 14268:14268 -p 14250:14250 -p 9411:9411 jaegertracing/all-in-one:1.23 å¼•å…¥ maven ä¾èµ–123456789101112131415161718&lt;!-- guava ä¾èµ–ï¼Œä¸Ž jaeger æ— å…³ --&gt;&lt;dependency&gt; &lt;groupId&gt;com.google.guava&lt;/groupId&gt; &lt;artifactId&gt;guava&lt;/artifactId&gt; &lt;version&gt;30.1.1-jre&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;io.opentracing&lt;/groupId&gt; &lt;artifactId&gt;opentracing-api&lt;/artifactId&gt; &lt;version&gt;0.33.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;io.jaegertracing&lt;/groupId&gt; &lt;artifactId&gt;jaeger-client&lt;/artifactId&gt; &lt;version&gt;1.6.0&lt;/version&gt;&lt;/dependency&gt; è®°å½•ä¸€ä¸ªç®€å•çš„é“¾è·¯1234567891011121314151617181920212223242526272829303132333435363738394041import com.google.common.collect.ImmutableMap;import io.jaegertracing.Configuration;import io.jaegertracing.internal.JaegerTracer;import io.opentracing.Span;import io.opentracing.Tracer;import java.time.LocalDateTime;public class GettingStarter &#123; public static void main(String[] args) &#123; // æŒ‡å®šæœåŠ¡åï¼Œåˆå§‹åŒ– Tracer Tracer tracer = initTracer("starter-service"); // æŒ‡å®š Span çš„ operationName Span span = tracer.buildSpan("") // æŒ‡å®šå½“å‰ Span çš„ Tagï¼Œ key value æ ¼å¼ .withTag("env", "local") .start(); span.setTag("system", "windows"); // log ä¹Ÿæ˜¯ key value æ ¼å¼ï¼Œé»˜è®¤ key ä¸º event span.log("create first Span"); // ä¼ å…¥ä¸€ä¸ª Map span.log(ImmutableMap.of("currentTime", LocalDateTime.now().toString())); // è¾“å‡ºå½“å‰ traceId System.out.println(span.context().toTraceId()); // ç»“æŸå¹¶ä¸ŠæŠ¥ span span.finish(); &#125; public static JaegerTracer initTracer(String service) &#123; Configuration.SamplerConfiguration samplerConfig = Configuration.SamplerConfiguration.fromEnv().withType("const").withParam(1); Configuration.ReporterConfiguration reporterConfig = Configuration.ReporterConfiguration.fromEnv().withLogSpans(true); Configuration config = new Configuration(service).withSampler(samplerConfig).withReporter(reporterConfig); return config.getTracer(); &#125;&#125; jaeger UI æŸ¥è¯¢é“¾è·¯ï¼Œè®¿é—® http://localhost:16686/searchï¼Œå³ä¸Šè§’è¾“å…¥ traceId æœç´¢ã€‚ç»“æžœå¦‚ä¸‹ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšåˆšåœ¨ä»£ç ä¸­çš„ Tag å’Œ Log éƒ½è®°å½•åœ¨é“¾è·¯ä¸Šäº† çº¿ç¨‹ä¼ é€’ SpanSpan ä¹‹é—´æ˜¯å¯ä»¥å»ºç«‹çˆ¶å­å…³ç³»çš„ï¼Œä½¿ç”¨1234Span parent= tracer.buildSpan("say-hello").start();tracer.buildSpan("son") .asChildOf(parent) .start(); æ•ˆæžœå¦‚å›¾ parent Span è‚¯å®šä¸èƒ½ä¸€ç›´åœ¨è°ƒç”¨æ ˆä¸­ä¼ é€’ä¸‹åŽ»ï¼Œè¿™å¯¹é›†æˆ opentracing çš„ç¨‹åºæ¥è¯´ä¾µå…¥æ€§å¤ªå¤§äº†ã€‚å›žé¡¾ä¸€ä¸‹ä¸Šé¢æˆ‘ä»¬æåˆ°äº†ä¸€ä¸ª ScopeManager ï¼Œæ¥çœ‹ä¸‹å…¶æ ¸å¿ƒæ–¹æ³• activate(Span span)ï¼šç”¨äºŽå°†å½“å‰ Span Set åˆ°å½“å‰ä¸Šä¸‹æ–‡ä¸­ã€‚ä¸Šå›¾ä¸­çš„æ³¨é‡Šä¹Ÿç»™å‡ºäº†è¯¥æ–¹æ³•å¦‚ä½•ä½¿ç”¨ã€‚è¿”å›žå€¼ Scope å­—é¢ç¿»è¯‘ä¸ºèŒƒå›´ / è·¨åº¦ã€‚ç¨åŽæˆ‘ä»¬æ‰¾ä¸€ä¸ªå®žçŽ°ç±»å…·ä½“åˆ†æžä¸€ä¸‹ activeSpan()ï¼šè¿™ä¸ªæ–¹æ³•å¾ˆå¥½ç†è§£ï¼Œä»Žå½“å‰ä¸Šä¸‹æ–‡ä¸­ Get Span ThreadLocalScopeManagerJaeger ä¸­é»˜è®¤çš„ ScopeManagerï¼Œè¯¥ç±»ç”± opentracing æä¾›ã€‚ 1234567891011121314public class ThreadLocalScopeManager implements ScopeManager &#123; final ThreadLocal&lt;ThreadLocalScope&gt; tlsScope = new ThreadLocal&lt;ThreadLocalScope&gt;(); @Override public Scope activate(Span span) &#123; return new ThreadLocalScope(this, span); &#125; @Override public Span activeSpan() &#123; ThreadLocalScope scope = tlsScope.get(); return scope == null ? null : scope.span(); &#125;&#125; 1234567891011121314151617181920212223242526public class ThreadLocalScope implements Scope &#123; private final ThreadLocalScopeManager scopeManager; private final Span wrapped; private final ThreadLocalScope toRestore; ThreadLocalScope(ThreadLocalScopeManager scopeManager, Span wrapped) &#123; this.scopeManager = scopeManager; this.wrapped = wrapped; this.toRestore = scopeManager.tlsScope.get(); scopeManager.tlsScope.set(this); &#125; @Override public void close() &#123; if (scopeManager.tlsScope.get() != this) &#123; // This shouldn't happen if users call methods in the expected order. Bail out. return; &#125; scopeManager.tlsScope.set(toRestore); &#125; Span span() &#123; return wrapped; &#125;&#125; ThreadLocalScopeManager#activateï¼šç›´æŽ¥è°ƒç”¨äº†new ThreadLocalScopeã€‚åœ¨ ThreadLocalScope æž„é€ æ–¹æ³•ä¸­ï¼Œé¦–å…ˆå°†ä»Ž ThreadLocal ä¸­èŽ·å–åˆ°ç›®å‰ä¸Šä¸‹æ–‡ä¸­çš„ ThreadLocalScope èµ‹å€¼ç»™ toRestoreï¼Œç„¶åŽå°† this (ThreadLocalScope å¯¹è±¡) set åˆ° ThreadLocalã€‚ ThreadLocalScope ä¸­å­˜å‚¨ç€å½“å‰çš„ Spanã€‚åŽç»­çš„ä»£ç å¦‚æžœæƒ³è¦èŽ·å– Spanï¼Œåªéœ€è¦è°ƒç”¨ ScopeManager#activeSpan å°±å¯ä»¥ï¼ˆScopeManager å¯ä»¥åœ¨ Tracer å¯¹è±¡ä¸­æ‹¿åˆ°ï¼‰ åœ¨æ‰§è¡Œ close æ—¶ï¼ˆScope ç»§æ‰¿äº† Closeableï¼‰ï¼Œå°†ä¹‹å‰çš„ Span é‡æ–°æ”¾å›žåˆ°ä¸Šä¸‹æ–‡ä¸­ çº¿ç¨‹ä¼ é€’ Span æ¼”ç¤º1234567891011121314Span parentSpan = tracer.buildSpan("parentSpan").start();try (Scope scope = tracer.activateSpan(parentSpan)) &#123; xxxMethod();&#125; finally &#123; parentSpan.finish();&#125;public void xxxMethod() &#123; // è¿™é‡Œå¹¶ä¸éœ€è¦æ‰‹åŠ¨ä»Ž ScopeManager ä¸­å–å‡ºä¸Šä¸‹æ–‡ä¸­çš„ Span // start æ–¹æ³•ä¸­å·²ç»åšäº† // å¦‚æžœ ScopeManager.activeSpan() != null ä¼šè‡ªåŠ¨è°ƒç”¨ asChildOf tracer.buildSpan("sonSpan").start();&#125; é“¾è·¯ä¸­æ•°æ®å…±äº«å¦‚æžœéœ€è¦å’Œé“¾è·¯çš„ä¸‹æ¸¸å…±äº«æŸäº›æ•°æ®ï¼Œä½¿ç”¨å¦‚ä¸‹æ–¹æ³•12345// å†™span.setBaggageItem(&quot;key&quot;, &quot;value&quot;);// è¯»span.getBaggageItem(&quot;key&quot;); åªè¦ä¿è¯åœ¨åŒä¸€æ¡é“¾è·¯ä¸­ï¼Œå³ä½¿ä¸‹æ¸¸ Span åœ¨ä¸åŒçš„è¿›ç¨‹ï¼Œä¾ç„¶å¯ä»¥é€šè¿‡ getBaggageItem è¯»åˆ°æ•°æ® è·¨è¿›ç¨‹é“¾è·¯è¿½è¸ªopentracing ä¸­æä¾›äº†å®žçŽ°è·¨è¿›ç¨‹è¿½è¸ªçš„è§„èŒƒ Tracer æŽ¥å£ä¸­æä¾›äº†å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³• injectï¼šå°† SpanContext æ³¨å…¥åˆ° Carrier ä¸­ï¼Œä¼ é€’ç»™ä¸‹æ¸¸çš„å…¶ä»–è¿›ç¨‹ extractï¼šä¸‹æ¸¸è¿›ç¨‹ä»Ž Carrier ä¸­æŠ½å–å‡º SpanContextï¼Œç”¨äºŽåˆ›å»ºä¸‹æ¸¸çš„ Child Span ç®€å•ä¸¾ä¸ªä¾‹å­è§£é‡Šä¸‹ï¼Œä¾‹å¦‚æˆ‘ä»¬ä½¿ç”¨ Http åè®®è®¿é—®ä¸‹æ¸¸æœåŠ¡ï¼Œinject å¯ä»¥å°† SpanContext æ³¨å…¥åˆ° HttpHeaders ä¸­ã€‚ä¸‹æ¸¸æœåŠ¡å†ä»Ž HttpHeaders ä¸­æŒ‰ç…§é“¾è·¯ä¸­çš„çº¦å®šå–å‡ºæœ‰ç‰¹æ®Šæ ‡è¯†çš„ header æ¥æž„å»º SpanContextã€‚è¿™æ ·ä¸€æ¥å°±å®žçŽ°äº†é“¾è·¯çš„è·¨è¿›ç¨‹ å†å›žåˆ°ä»£ç å±‚é¢ï¼Œé€šè¿‡æŽ¥å£æ–¹æ³•çš„å£°æ˜Žæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼ŒFormat å†³å®šäº† Carrier çš„ç±»åž‹ã€‚ä¸‹é¢æ¥çœ‹çœ‹å®žé™…ä»£ç ä¸­å¦‚ä½•å®žçŽ° è·¨è¿›ç¨‹é“¾è·¯è¿½è¸ªæ¼”ç¤º123456789101112131415161718192021222324252627282930313233public class TracingRestTemplateInterceptor implements ClientHttpRequestInterceptor &#123; private static final String SPAN_URI = "uri"; private final Tracer tracer; public TracingRestTemplateInterceptor(Tracer tracer) &#123; this.tracer = tracer; &#125; @Override public ClientHttpResponse intercept(HttpRequest request, byte[] body, ClientHttpRequestExecution execution) throws IOException &#123; ClientHttpResponse httpResponse; // ä¸ºå½“å‰ RestTemplate è°ƒç”¨ï¼Œåˆ›å»ºä¸€ä¸ª Span Span span = tracer.buildSpan("RestTemplate-RPC") .withTag(Tags.SPAN_KIND.getKey(), Tags.SPAN_KIND_CLIENT) .withTag(SPAN_URI, request.getURI().toString()) .start(); // å°†å½“å‰ SpanContext æ³¨å…¥åˆ° HttpHeaders tracer.inject(span.context(), Format.Builtin.HTTP_HEADERS, new HttpHeadersCarrier(request.getHeaders())); try (Scope scope = tracer.activateSpan(span)) &#123; httpResponse = execution.execute(request, body); &#125; catch (Exception ex) &#123; TracingError.handle(span, ex); throw ex; &#125; finally &#123; span.finish(); &#125; return httpResponse; &#125;&#125; TracingRestTemplateInterceptor å®žçŽ°äº† RestTemplate çš„æ‹¦æˆªå™¨ï¼Œç”¨äºŽåœ¨ Http è°ƒç”¨ä¹‹å‰ï¼Œå°† SpanContext æ³¨å…¥åˆ° HttpHeaders ä¸­ã€‚ Format.Builtin.HTTP_HEADERS å†³å®šäº†å½“å‰çš„ Carrier ç±»åž‹å¿…é¡» TextMap ï¼ˆæºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæˆ‘æ²¡æœ‰åˆ—å‡ºï¼‰ 1234567891011121314151617public class HttpHeadersCarrier implements TextMap &#123; private final HttpHeaders httpHeaders; public HttpHeadersCarrier(HttpHeaders httpHeaders) &#123; this.httpHeaders = httpHeaders; &#125; @Override public void put(String key, String value) &#123; httpHeaders.add(key, value); &#125; @Override public Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iterator() &#123; throw new UnsupportedOperationException("Should be used only with tracer#inject()"); &#125;&#125; tracer.inject å†…éƒ¨ä¼šè°ƒç”¨ TextMap çš„ put æ–¹æ³•ï¼Œè¿™æ ·å°±å°† SpanContext æ³¨å…¥åˆ° HttpHeaders äº†ã€‚ ä¸‹é¢å†æ¥çœ‹çœ‹ä¸‹æ¸¸æ€Žä¹ˆå†™ 123456789101112131415161718192021222324252627282930313233public class TracingFilter implements Filter &#123; private final Tracer tracer; public TracingFilter(Tracer tracer) &#123; this.tracer = tracer; &#125; @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123; HttpServletRequest httpRequest = (HttpServletRequest) servletRequest; HttpServletResponse httpResponse = (HttpServletResponse) servletResponse; // é€šè¿‡ HttpHeader æž„å»º SpanContext SpanContext extractedContext = tracer.extract(Format.Builtin.HTTP_HEADERS, new HttpServletRequestExtractAdapter(httpRequest)); String operationName = httpRequest.getMethod() + ":" + httpRequest.getRequestURI(); Span span = tracer.buildSpan(operationName) .asChildOf(extractedContext) .withTag(Tags.SPAN_KIND.getKey(), Tags.SPAN_KIND_SERVER) .start(); httpResponse.setHeader("TraceId", span.context().toTraceId()); try (Scope scope = tracer.activateSpan(span)) &#123; filterChain.doFilter(servletRequest, servletResponse); &#125; catch (Exception ex) &#123; TracingError.handle(span, ex); throw ex; &#125; finally &#123; span.finish(); &#125; &#125;&#125; TracingFilter å®žçŽ°äº† Servlet Filterï¼Œæ¯æ¬¡è¯·æ±‚è®¿é—®åˆ°æœåŠ¡å™¨æ—¶åˆ›å»º Spanï¼Œå¦‚æžœå¯ä»¥æŠ½å–åˆ° SpanContextï¼Œåˆ™åˆ›å»ºçš„æ˜¯ Child Span 12345678910111213141516171819202122232425262728293031323334353637public class HttpServletRequestExtractAdapter implements TextMap &#123; private final IdentityHashMap&lt;String, String&gt; headers; public HttpServletRequestExtractAdapter(HttpServletRequest httpServletRequest) &#123; headers = servletHeadersToMap(httpServletRequest); &#125; @Override public Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iterator() &#123; return headers.entrySet().iterator(); &#125; @Override public void put(String key, String value) &#123; throw new UnsupportedOperationException("This class should be used only with Tracer.inject()!"); &#125; private IdentityHashMap&lt;String, String&gt; servletHeadersToMap(HttpServletRequest httpServletRequest) &#123; IdentityHashMap&lt;String, String&gt; headersResult = new IdentityHashMap&lt;&gt;(); Enumeration&lt;String&gt; headerNamesIt = httpServletRequest.getHeaderNames(); while (headerNamesIt.hasMoreElements()) &#123; String headerName = headerNamesIt.nextElement(); Enumeration&lt;String&gt; valuesIt = httpServletRequest.getHeaders(headerName); while (valuesIt.hasMoreElements()) &#123; // IdentityHashMap åˆ¤æ–­ä¸¤ä¸ª Key ç›¸ç­‰çš„æ¡ä»¶ä¸º k1 == k2 // ä¸ºäº†è®©ä¸¤ä¸ªç›¸åŒçš„å­—ç¬¦ä¸²åŒæ—¶å­˜åœ¨ï¼Œå¿…é¡»ä½¿ç”¨ new String headersResult.put(new String(headerName), valuesIt.nextElement()); &#125; &#125; return headersResult; &#125;&#125; tracer.extract å†…éƒ¨ä¼šè°ƒç”¨ HttpServletRequestExtractAdapter iterator æ–¹æ³•ç”¨äºŽæž„å»º SpanContext å¦‚æžœä½ çœ‹å®Œäº†è¿™äº›è¿˜æ˜¯å¯¹äºŽè·¨è¿›ç¨‹é“¾è·¯è¿½è¸ªæœ‰ç–‘æƒ‘çš„ï¼Œå¯ä»¥ä¸‹è½½ä¸€ä¸‹æˆ‘å†™çš„ Demoï¼Œé€šè¿‡ Debug æ¥æ›´è¿›ä¸€æ­¥äº†è§£ https://github.com/TavenYin/taven-springcloud-learning/tree/master/jaeger-mutilserver Demo ä¸­çš„ä»£ç å‚è€ƒäº† opentracing çš„å®žçŽ°ï¼Œåšäº†ç›¸åº”çš„ç®€åŒ–ï¼Œè¯¸ä½å¯ä»¥æ”¾å¿ƒé£Ÿç”¨ å®žé™…ä½¿ç”¨opentracing å·²ç»å®žçŽ°äº†ä¸€äº›å¸¸ç”¨ api çš„é“¾è·¯åŸ‹ç‚¹ï¼Œåœ¨æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šéœ€æ±‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æŽ¥ä½¿ç”¨è¿™äº›ä»£ç ã€‚å…·ä½“å‚è€ƒ]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¾®æœåŠ¡</tag>
        <tag>Opentracing</tag>
        <tag>é“¾è·¯è¿½è¸ª</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[èŠèŠ IO å¤šè·¯å¤ç”¨]]></title>
    <url>%2Fpost%2Fa52e1819.html</url>
    <content type="text"><![CDATA[åƒ Nginx è¿™ç§ä»¥é«˜å¹¶å‘é«˜æ€§èƒ½é—»åçš„é¡¹ç›®ï¼Œä¹‹æ‰€ä»¥æ€§èƒ½å¦‚æ­¤ä¼˜ç§€ï¼Œå…¶åŽŸå› æ˜¯ä½¿ç”¨äº† IO å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå¯ä»¥ç”¨æœ€å°‘çš„è¿›ç¨‹æ¥æ”¯æŒå¤§é‡çš„è¯·æ±‚ã€‚æœ¬æ–‡å’Œå¤§å®¶ä¸€èµ·èŠèŠä»€ä¹ˆæ˜¯ IO å¤šè·¯å¤ç”¨ï¼Œå®ƒèƒ½å¸¦æ¥ä»€ä¹ˆ å¸¸è§çš„ IO æ¨¡åž‹ æ‰€æœ‰çš„ IO éƒ½åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šâ€ç­‰å¾…æ•°æ®å°±ç»ªâ€ å’Œ â€œæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´â€ã€‚ æˆ‘æœ€å¼€å§‹ä¸ç†Ÿæ‚‰ IO çš„æ—¶å€™ï¼Œå¾ˆéš¾ç†è§£ä¸ºä»€ä¹ˆæœ‰è¿™ä¸¤ä¸ªè¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘æ¥ä»”ç»†è¯´è¯´ ç­‰å¾…æ•°æ®å°±ç»ªï¼šä»¥ socket.read ä¸ºä¾‹ï¼Œä¸ç®¡æˆ‘ä»¬ä½¿ç”¨ä»€ä¹ˆç¼–ç¨‹è¯­è¨€ï¼Œè¿™ä¸ªæ“ä½œéƒ½æ˜¯åŽ»äº¤ç»™æ“ä½œç³»ç»Ÿå®Œæˆçš„ï¼ˆè°ƒç”¨ç³»ç»Ÿå‡½æ•°ï¼‰ã€‚åœ¨æ‰§è¡Œç³»ç»Ÿå‡½æ•°æ—¶ CPU å‘ç½‘å¡å‘å‡º IO è¯·æ±‚ã€‚ç½‘å¡åœ¨æŽ¥æ”¶åˆ°æ•°æ®ä¹‹åŽï¼Œç”±ç½‘å¡çš„ DMA æŠŠçš„æ•°æ®å†™åˆ°æ“ä½œç³»ç»Ÿçš„å†…æ ¸ç¼“å†²åŒºï¼Œå®ŒæˆåŽé€šçŸ¥ CPUï¼Œä¹‹åŽ CPU ä¼šå°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼šæ“ä½œç³»ç»Ÿæœ‰è‡ªå·±çš„å†…å­˜åŒºåŸŸï¼Œå«åšå†…æ ¸ç©ºé—´ã€‚æˆ‘ä»¬å¹³å¸¸è·‘çš„ç¨‹åºéƒ½åœ¨ç”¨æˆ·ç©ºé—´ï¼Œç”¨æˆ·ç©ºé—´æ— æ³•ç›´æŽ¥è®¿é—®å†…æ ¸ç©ºé—´çš„æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦æ‹·è´ã€‚æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´è¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç†è§£ä¸ºçº¯ CPU æ“ä½œï¼Œéžå¸¸åœ°å¿«ï¼Œå¯ä»¥è®¤ä¸ºåŸºæœ¬ä¸è€—æ—¶ èŠèŠå¼€å‘ä¸­ BIO åœºæ™¯æˆ‘ä»¬å¹³æ—¶ Java å¼€å‘å¸¸ç”¨çš„æ¡†æž¶ Spring æˆ–è€… Servlet è¿™éƒ½æ˜¯ç»å…¸çš„ BIO ï¼ˆBlocking IOï¼Œé˜»å¡ž IOï¼‰æ¨¡åž‹ã€‚ ä½¿ç”¨ Servlet è¿™ç§ BIO çš„æ¨¡åž‹éƒ½éœ€è¦å¤§é‡çš„çº¿ç¨‹ï¼Œå…¶æ ¹æœ¬åŽŸå› æœ‰ä¸¤ç‚¹ è™½ç„¶ Servlet å·²ç»æ”¯æŒäº† NIOï¼Œä½†æ˜¯æœ¬æ–‡è¿˜æ˜¯æŠŠå®ƒä½œä¸ºä¸€ä¸ªç»å…¸çš„ BIO æ¨¡åž‹æ¥è®¨è®º 1. åŽ‹æ¦¨ CPUå½“ IO é˜»å¡žæ—¶ï¼ŒCPU å¤„äºŽç©ºé—²çŠ¶æ€ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ ä¸€æ¡ SQL å‘ç»™æ•°æ®åº“ï¼Œè¿™ä¸ªæ—¶å€™å¿…é¡»ç­‰åˆ°æ•°æ®åº“ç»™ä½ å“åº”æ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚è€Œ IO æœ¬èº«å¹¶ä¸æ˜¯æ—¶åˆ»éƒ½éœ€è¦ CPU çš„å‚ä¸Žï¼ˆä¾‹å¦‚æˆ‘ä»¬ä¸Šé¢è¯´çš„ç­‰å¾…å°±ç»ªè¿‡ç¨‹ä¸éœ€è¦ CPU å‚ä¸Žï¼‰ã€‚è™½ç„¶è¿™ä¸ªè¿‡ç¨‹å¯¹äºŽäººç±»æ¥è¯´å¯èƒ½å¾ˆå¿«ï¼Œä½†æ˜¯ CPU ç¡®å®žåœ¨æ‘¸é±¼ã€‚æ‰€ä»¥ BIO æ¨¡åž‹ä¸­ä¸ºäº†å……åˆ†çš„åˆ©ç”¨ CPU å¿…é¡»ä½¿ç”¨å¤§é‡çš„çº¿ç¨‹ï¼ˆå½“å‘ç”Ÿ IO é˜»å¡žæ—¶ï¼ŒCPUåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ç»§ç»­å·¥ä½œï¼‰ 2. ä¸ºäº†å¤„ç†æ›´å¤šçš„è¿žæŽ¥ä»¥å‰çš„æˆ‘å¾ˆå‚»çš„è®¤ä¸ºä¸€ä¸ªçº¿ç¨‹åªèƒ½å¤„ç†ä¸€ä¸ªè¿žæŽ¥ã€‚ä½†æ˜¯å…¶å®ž Thread å’Œ Connection è¿™ä¸¤ä¸ªä¸œè¥¿ä¹‹é—´æ ¹æœ¬æ²¡æœ‰ä»€ä¹ˆç¾ç»Šï¼Œä½ å®Œå…¨å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç† N å¤šä¸ªè¯·æ±‚ï¼Œåªä¸è¿‡å¯¹äºŽé åŽçš„è¯·æ±‚æ¥è¯´ï¼Œä»–è¦ç­‰å¾…çš„æ—¶é—´å¤ªé•¿äº†ã€‚æ‰€ä»¥åœ¨ BIO æ¨¡åž‹ä¸­ï¼Œå¤§å¤šæ•°éƒ½æ˜¯ æ¯è¿žæŽ¥æ¯çº¿ç¨‹ çš„æ–¹å¼ BIO å¸¦æ¥çš„ç“¶é¢ˆBIO ä¸ºäº†æ›´å……åˆ†çš„åˆ©ç”¨ CPU å’Œå¤„ç†æ›´å¤šçš„è¿žæŽ¥ï¼Œå¿…é¡»è¦ä½¿ç”¨å¤§é‡çš„çº¿ç¨‹ã€‚è€Œçº¿ç¨‹è¿‡å¤šå¸¦æ¥çš„å‰¯ä½œç”¨å°±æ˜¯å ç”¨å¤§é‡å†…å­˜ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å ç”¨å¤§é‡ CPU æ—¶é—´ç‰‡ç­‰ç­‰ é‚£ä¹ˆæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ¡ˆå‘¢ï¼Ÿ NIOç›¸å¯¹äºŽ BIO æ¥è¯´ï¼ŒNIO è°ƒç”¨å¯ä»¥ç«‹åˆ»å¾—åˆ°åé¦ˆï¼Œä¸éœ€è¦å†å‚»ç­‰äº†ã€‚ä»¥ read ä¸ºä¾‹ï¼Œå¦‚æžœæ•°æ®å·²ç»å°±ç»ªåˆ™è¿”å›žç»™ç”¨æˆ·ï¼›åä¹‹è¿”å›ž 0ï¼Œæ°¸è¿œä¸ä¼šé˜»å¡žã€‚ NIO ç‰¹æ€§è²Œä¼¼å¯ä»¥è§£å†³ BIO çš„ç—›ç‚¹ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªçº¿ç¨‹æ¥ç›‘å¬æ‰€æœ‰çš„ socketï¼Œå½“ socket å°±ç»ªæ—¶ï¼Œå†è¿›è¡Œè¯»å†™æ“ä½œï¼Œè¿™æ ·åšå¯ä»¥å—ï¼Ÿ å¯ä»¥ï¼Œä½†æ˜¯éœ€è¦ä¸æ–­çš„éåŽ†æ‰€æœ‰çš„ socketï¼Œè¿™æ ·åšçš„è¯æ•ˆçŽ‡è¿˜æ˜¯æœ‰ç‚¹ä½Žï¼Œæœ‰æ›´å¥½çš„åŠžæ³•å—ï¼Ÿ IO å¤šè·¯å¤ç”¨IO å¤šè·¯å¤ç”¨å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆLinux ä¸­ä¸‡ç‰©çš†æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆä¸€èˆ¬æ˜¯è¯»å°±ç»ªæˆ–è€…å†™å°±ç»ªï¼‰ï¼Œèƒ½å¤Ÿé€šçŸ¥ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œã€‚ select poll epollè¿™ä¸‰ä¸ªå‡½æ•°éƒ½å¯ä»¥ç”¨äºŽå®žçŽ° IO å¤šè·¯å¤ç”¨ï¼Œç®€å•æ¥èŠèŠè¿™ä¸‰ä¸ªå‡½æ•° selectï¼šå½“è¢«ç›‘å¬çš„ fdï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰å°±ç»ªåŽä¼šè¿”å›žï¼Œä½†æ˜¯æˆ‘ä»¬æ— æ³•çŸ¥é“å…·ä½“æ˜¯å“ªäº› fd å°±ç»ªäº†ï¼Œåªèƒ½éåŽ†æ‰€æœ‰çš„ fdã€‚é€šå¸¸æ¥è¯´æŸä¸€æ—¶åˆ»ï¼Œå°±ç»ªçš„ fd å¹¶ä¸ä¼šå¾ˆå¤šï¼Œä½†æ˜¯ä½¿ç”¨ select å¿…é¡»è¦éåŽ†æ‰€æœ‰çš„ fdï¼Œè¿™å°±é€ æˆäº†ä¸€å®šç¨‹åº¦ä¸Šçš„æ€§èƒ½æŸå¤±ã€‚select æœ€å¤šå¯ç›‘å¬çš„ fd æ˜¯æœ‰é™åˆ¶çš„ï¼Œ32ä½æ“ä½œç³»ç»Ÿé»˜è®¤1024ä¸ªï¼Œ64ä½é»˜è®¤2048 pollï¼šå’Œ select ä¸€æ ·ï¼Œä½¿ç”¨ poll æ—¶ä¹Ÿæ— æ³•çŸ¥é“å…·ä½“å“ªäº› fd å°±ç»ªäº†ï¼Œè¿˜æ˜¯éœ€è¦éåŽ†ã€‚poll æœ€å¤§çš„æ”¹è¿›å°±æ˜¯æ²¡æœ‰äº†ç›‘å¬æ•°é‡çš„é™åˆ¶ï¼Œä½†æ˜¯ç›‘å¬äº†è¿‡å¤šçš„ fd ä¼šå¯¼è‡´æ€§èƒ½ä¸ä½³ epollï¼šé€šå¸¸åœ¨ Linux ç³»ç»Ÿä¸­ä½¿ç”¨ IO å¤šè·¯å¤ç”¨ï¼Œéƒ½æ˜¯åœ¨ä½¿ç”¨ epoll å‡½æ•°ã€‚epoll æ˜¯ select å’Œ poll çš„å¢žå¼ºï¼Œå¯ä»¥é€šçŸ¥æˆ‘ä»¬å“ªäº› fd å·²ç»å°±ç»ªäº†ï¼Œå¹¶ä¸”æ²¡æœ‰ç›‘å¬æ•°é‡çš„é™åˆ¶ã€‚æ‰€ä»¥ä½¿ç”¨ epoll çš„æ€§èƒ½è¦è¿œè¿œä¼˜äºŽ select å’Œ poll å…³äºŽè¿™ä¸‰ä¸ªå‡½æ•°çš„ç»†èŠ‚ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è‡ªè¡Œè°·æ­Œä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘å°±ä¸å¤šè¯´äº†ã€‚ åŸºäºŽ IO å¤šè·¯å¤ç”¨çš„å¼€å‘æ¨¡åž‹BIO çº¿ç¨‹æ¨¡åž‹ ä¼ ç»Ÿçš„ BIO æ¨¡åž‹ï¼Œæ¯å½“æœåŠ¡ç«¯ accept åˆ°ä¸€ä¸ª socket æ—¶ï¼Œå°±å°†å…¶åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹å•ç‹¬å¤„ç†ã€‚ å•çº¿ç¨‹ Reactor ä¸Šå›¾å±•ç¤ºäº†ä¸€ä¸ªå•çº¿ç¨‹çš„ Reactor æ¨¡åž‹ æ­¥éª¤1ï¼šacceptï¼Œç­‰å¾…äº‹ä»¶åˆ°æ¥ï¼ˆReactorè´Ÿè´£ï¼‰æ­¥éª¤2ï¼šread + dispatchï¼Œå°†è¯»å°±ç»ªäº‹ä»¶åˆ†å‘ç»™ç”¨æˆ·å®šä¹‰çš„å¤„ç†å™¨ï¼ˆReactorè´Ÿè´£ï¼‰æ­¥éª¤3ï¼šdecodeï¼Œè¯»æ•°æ®ï¼ˆç”¨æˆ·å¤„ç†å™¨è´Ÿè´£ï¼‰æ­¥éª¤4ï¼šcomputeï¼Œå¤„ç†æ•°æ®ï¼ˆç”¨æˆ·å¤„ç†å™¨è´Ÿè´£ï¼‰æ­¥éª¤5ï¼šencodeï¼ˆç”¨æˆ·å¤„ç†å™¨è´Ÿè´£ï¼‰æ­¥éª¤6ï¼šsendï¼Œå†™å°±ç»ªåŽå‘é€æ•°æ®ï¼ˆReactorè´Ÿè´£ï¼‰ ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œè¿™é‡Œè´´å‡ºå•çº¿ç¨‹ Reactor ä¼ªä»£ç 1234567891011121314151617181920212223242526272829303132333435// å‚è€ƒè‡ªç¾Žå›¢æŠ€æœ¯å›¢é˜Ÿinterface ChannelHandler&#123; void channelReadComplate(Channel channelï¼Œbyte[] data); void channelWritable(Channel channel);&#125;class Channel&#123; Socket socket; Event event;//è¯»ï¼Œå†™æˆ–è€…è¿žæŽ¥&#125;//IOçº¿ç¨‹ä¸»å¾ªçŽ¯ï¼šclass IOThread extends Thread&#123; Map&lt;Channel, ChannelHandler&gt; handlerMap;//æ‰€æœ‰channelçš„å¯¹åº”äº‹ä»¶å¤„ç†å™¨ public void run()&#123; Channel channel; while(channel=Selector.select())&#123;//é€‰æ‹©å°±ç»ªçš„äº‹ä»¶å’Œå¯¹åº”çš„è¿žæŽ¥ if(channel.event==accept)&#123; registerNewChannelHandler(channel);//å¦‚æžœæ˜¯æ–°è¿žæŽ¥ï¼Œåˆ™æ³¨å†Œä¸€ä¸ªæ–°çš„è¯»å†™å¤„ç†å™¨ Selector.interested(read); &#125; if(channel.event==write)&#123; getChannelHandler(channel).channelWritable(channel);//å¦‚æžœå¯ä»¥å†™ï¼Œåˆ™æ‰§è¡Œå†™äº‹ä»¶ &#125; if(channel.event==read)&#123; byte[] data = channel.read(); if(channel.read()==0)//æ²¡æœ‰è¯»åˆ°æ•°æ®ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®è¯»å®Œäº† &#123; getChannelHandler(channel).channelReadComplate(channel, data);//å¤„ç†è¯»å®Œæˆäº‹ä»¶ &#125; &#125; &#125; &#125;&#125; é€šè¿‡ä½¿ç”¨ IO å¤šè·¯å¤ç”¨ï¼ŒReactor æ¨¡åž‹å¯ä»¥éžé˜»å¡žçš„åœ¨å•ä¸ªçº¿ç¨‹ä¸­å¤„ç†å¤šä¸ª Socketï¼Œè¿™æ ·åšæ€§èƒ½ç¡®å®žå¾ˆä¸é”™ï¼Œä½†æ˜¯èƒ½å¦åœ¨æ­¤åŸºç¡€ä¸Šå……åˆ†åˆ©ç”¨ CPU å¤šæ ¸æ¥å®žçŽ°å¤šè·¯ IO å¤ç”¨å‘¢ï¼Ÿ æˆ‘ä»¬ç†è§£äº†å•çº¿ç¨‹ Reactor æ¨¡åž‹çš„å·¥ä½œåŽŸç†ä¹‹åŽï¼Œå†æ¥çœ‹çœ‹å¤šçº¿ç¨‹ Reactor æ¨¡åž‹å¦‚ä½•å·¥ä½œ å¤šçº¿ç¨‹ Reactor 1 ä¸Šå›¾æ˜¯ Reactor çš„å¤šçº¿ç¨‹çš„ä¸€ç§ã€‚ä¾‹å¦‚ Netty ä»¥åŠåŸºäºŽ Netty çš„ä¸€äº›æ¡†æž¶ï¼ˆVert.x å’Œ WebFluxï¼‰ï¼Œä½¿ç”¨çš„å°±æ˜¯ç±»ä¼¼çš„çº¿ç¨‹æ¨¡åž‹ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU mainReactor è´Ÿè´£ accpetã€‚subReactor æ˜¯ä¸€ç»„çº¿ç¨‹ï¼Œåœ¨ç›‘å¬åˆ° Socket è¯»å†™å°±ç»ªæ—¶ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç† éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åˆšåˆšè®²è¿‡çš„è¿™ä¸¤ç§ Reactor æ¨¡åž‹ï¼Œä¸èƒ½é˜»å¡žä¸» IO çº¿ç¨‹ã€‚åœ¨ compute è¿‡ç¨‹ä¸­å¦‚æžœæ¶‰åŠ IO è°ƒç”¨ï¼Œæˆ–è€…å¤§é‡çš„è®¡ç®—çš„è¯ï¼Œä¼šå¯¼è‡´æ•´ä½“ç³»ç»Ÿåžåé‡å’Œå“åº”æ—¶é—´é™ä½Žã€‚ ä½†æ˜¯ä¸ç®¡ä»€ä¹ˆç³»ç»Ÿï¼Œä¸æ¶‰åŠ IO è°ƒç”¨æ˜¯ä¸çŽ°å®žçš„ã€‚é€šå¸¸åœ¨ Vert.x å’Œ WebFlux è¿™ç§ Reactor æ¨¡åž‹çš„æ¡†æž¶ä¸­ï¼Œæ‰§è¡Œé˜»å¡ž IO å’Œæ•°æ®åº“è°ƒç”¨éƒ½ä¼šåœ¨å•ç‹¬çš„çº¿ç¨‹æ± ä¸­ å¤šçº¿ç¨‹ Reactor 2 è¿™ä¹Ÿæ˜¯å¤šçº¿ç¨‹ Reactor çš„ä¸€ç§ï¼ŒåŒæ ·å¯ä»¥åˆ©ç”¨ IO å¤šè·¯å¤ç”¨éžé˜»å¡žçš„è¿›è¡Œ read å’Œ sendã€‚ å’Œå•çº¿ç¨‹ Reactor çš„åŒºåˆ«æ˜¯ï¼ŒæŠŠ decode, compute, encode è¿™ä¸‰ä¸ªæ­¥éª¤äº¤ç»™çº¿ç¨‹æ± æ¥å¤„ç† è¯¥æ¨¡åž‹çš„ç¼ºç‚¹ä¹Ÿå’Œå•çº¿ç¨‹æ¨¡åž‹ç±»ä¼¼ï¼Œåªä½¿ç”¨äº†ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œ Socket çš„è¯»å†™ï¼Œæ‰€ä»¥è¯¥æ¨¡åž‹å¯ä»¥å†ä¼˜åŒ–ä¸€ä¸‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º å’Œä¸Šé¢çš„å¤šçº¿ç¨‹ Reactor 1 æ€è·¯æ˜¯ä¸€æ ·çš„ï¼ŒmainReactor è´Ÿè´£ acceptï¼ŒsubReactor æ˜¯ä¸€ç»„çº¿ç¨‹è´Ÿè´£ Socket çš„è¯»å†™ Tomcat NIO æ¨¡å¼ä½¿ç”¨çš„å°±æ˜¯ç±»ä¼¼çš„çº¿ç¨‹æ¨¡åž‹ã€‚è™½ç„¶ Tomcat ä¸­æ”¯æŒäº† NIOï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆåŸºäºŽ Tomcat çš„åº”ç”¨è¿˜æ˜¯éœ€è¦å¤§é‡çš„çº¿ç¨‹ï¼Ÿé¦–å…ˆ Tomcat çš„NIO ä»…ä»…æ˜¯ä½œç”¨åœ¨ Socket çš„è¯»å†™ã€‚å…¶æ¬¡æˆ‘ä»¬ä¸šåŠ¡å¼€å‘ä¸­ä½¿ç”¨äº†å¤ªå¤šçš„ BIO APIï¼ˆä¾‹å¦‚ JDBCï¼‰ï¼Œæ²¡æ³•å®Œå…¨çš„éžé˜»å¡žåŒ– ä½¿ç”¨ IO å¤šè·¯å¤ç”¨æ¡†æž¶èƒ½å¸¦æ¥ä»€ä¹ˆIO å¤šè·¯å¤ç”¨è¿™ä¹ˆå¼ºï¼Œå¦‚æžœæŠŠä¸šåŠ¡å¼€å‘å…¨éƒ¨æ”¹é€ æˆè¿™ç§æ¨¡åž‹æ˜¯ä¸æ˜¯æ€§èƒ½ä¼šå¤§å¹…åº¦æå‡ï¼Ÿå®žåˆ™ä¸ç„¶ï¼ŒIO å¤šè·¯å¤ç”¨çš„ä¼˜åŠ¿æ˜¯ä½¿ç”¨æ›´å°‘çš„çº¿ç¨‹å¤„ç†æ›´å¤šçš„è¿žæŽ¥ï¼Œä¾‹å¦‚ Nginxï¼Œç½‘å…³ï¼Œè¿™ç§å¯èƒ½éœ€è¦å¤„ç†æµ·é‡è¿žæŽ¥è½¬å‘çš„æœåŠ¡ï¼Œå®ƒä»¬å°±éžå¸¸é€‚åˆä½¿ç”¨ IO å¤šè·¯å¤ç”¨ã€‚IO å¤šè·¯å¤ç”¨å¹¶ä¸èƒ½è®©ä½ çš„ä¸šåŠ¡ç³»ç»Ÿæé€Ÿï¼Œä½†æ˜¯å®ƒå¯ä»¥è®©ä½ çš„ç³»ç»Ÿæ”¯æ’‘æ›´å¤šçš„è¿žæŽ¥ å‚è€ƒhttps://tech.meituan.com/2016/11/04/nio.htmlhttp://c.biancheng.net/view/2349.htmlhttps://segmentfault.com/a/1190000003063859https://www.zhihu.com/question/28594409https://www.zhihu.com/question/37271342https://juejin.cn/post/6844903492121788429https://www.pdai.tech/md/java/io/java-io-nio-select-epoll.html]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>NIO</tag>
        <tag>IO å¤šè·¯æœç”¨</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Sentinel çƒ­ç‚¹å‚æ•°é™æµåŽŸç†]]></title>
    <url>%2Fpost%2Fb174070f.html</url>
    <content type="text"><![CDATA[ä½•ä¸ºçƒ­ç‚¹çƒ­ç‚¹å³ç»å¸¸è®¿é—®çš„æ•°æ®ã€‚å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¸Œæœ›ç»Ÿè®¡æŸä¸ªçƒ­ç‚¹æ•°æ®ä¸­è®¿é—®é¢‘æ¬¡æœ€é«˜çš„ Top K æ•°æ®ï¼Œå¹¶å¯¹å…¶è®¿é—®è¿›è¡Œé™åˆ¶ï¼Œæ¯”å¦‚ï¼š å•†å“ ID ä¸ºå‚æ•°ï¼Œç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…æœ€å¸¸è´­ä¹°çš„å•†å“ ID å¹¶è¿›è¡Œé™åˆ¶ ç”¨æˆ· ID ä¸ºå‚æ•°ï¼Œé’ˆå¯¹ä¸€æ®µæ—¶é—´å†…é¢‘ç¹è®¿é—®çš„ç”¨æˆ· ID è¿›è¡Œé™åˆ¶ ç‰ˆæœ¬æœ¬æ–‡åŸºäºŽ 1.8.0 å¦‚ä½•ä½¿ç”¨1.pom ä¸­å¼•å…¥å¦‚ä¸‹ 1234567891011&lt;dependency&gt; &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt; &lt;artifactId&gt;sentinel-core&lt;/artifactId&gt; &lt;version&gt;$&#123;sentinel.version&#125;&lt;/version&gt;&lt;/dependency&gt; &lt;!-- çƒ­ç‚¹å‚æ•°é™æµ --&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt; &lt;artifactId&gt;sentinel-parameter-flow-control&lt;/artifactId&gt; &lt;version&gt;$&#123;sentinel.version&#125;&lt;/version&gt;&lt;/dependency&gt; 2.å®šä¹‰ ParamFlowRule 123456789101112131415private static void loadRules() &#123; ParamFlowRule rule = new ParamFlowRule(RESOURCE_KEY) .setParamIdx(0) // æŒ‡å®šå½“å‰ rule å¯¹åº”çš„çƒ­ç‚¹å‚æ•°ç´¢å¼• .setGrade(RuleConstant.FLOW_GRADE_QPS) // é™æµçš„ç»´åº¦ï¼Œè¯¥ç­–ç•¥é’ˆå¯¹ QPS é™æµ .setDurationInSec(1) // é™æµçš„å•ä½æ—¶é—´ .setCount(50) // æœªä½¿ç”¨æŒ‡å®šçƒ­ç‚¹å‚æ•°æ—¶ï¼Œè¯¥èµ„æºé™æµå¤§å°ä¸º50 .setParamFlowItemList(new ArrayList&lt;&gt;()); // item1 è®¾ç½®äº†å¯¹ goods_id = goods_uuid1 çš„é™æµï¼Œå•ä½æ—¶é—´ï¼ˆDurationInSecï¼‰å†…åªèƒ½è®¿é—®10æ¬¡ ParamFlowItem item1 = new ParamFlowItem().setObject("goods_uuid1") // çƒ­ç‚¹å‚æ•° value .setClassType(String.class.getName()) // çƒ­ç‚¹å‚æ•°æ•°æ®ç±»åž‹ .setCount(10); // é’ˆå¯¹è¯¥valueçš„é™æµå€¼ ParamFlowRuleManager.loadRules(Collections.singletonList(rule));&#125; è¿™é‡Œçš„é…ç½®å±žæ€§åŽæ–‡è®²æºç çš„æ—¶å€™éƒ½ä¼šçœ‹åˆ°ï¼Œæ‰€ä»¥è¦é‡ç‚¹å…³æ³¨ä¸€ä¸‹ Rule æœ¬èº«å¯ä»¥å®šä¹‰ä¸€ä¸ªé™æµé˜ˆå€¼ï¼Œæ¯ä¸ªçƒ­ç‚¹å‚æ•°ä¹Ÿå¯ä»¥å®šä¹‰è‡ªå·±çš„é™æµé˜ˆå€¼ è¿˜å¯ä»¥ä¸ºé™æµé˜€å€¼è®¾ç½®ä¸€ä¸ªå•ä½æ—¶é—´ 3.è°ƒç”¨ 12345678910111213try &#123; // è°ƒç”¨é™æµ entry = SphU.entry(RESOURCE_KEY, EntryType.IN, 1, hotParamValue); // ä¸šåŠ¡ä»£ç ...&#125; catch (BlockException e) &#123; // å½“å‰è¯·æ±‚è¢«é™æµ e.printStackTrace();&#125; finally &#123; if (entry != null) &#123; entry.exit(1, hotParamValue); &#125;&#125; å®Œæ•´ demo å‚è€ƒï¼šä¼ é€é—¨ ä¹‹å‰æœ‰ç”¨è¿‡ Sentinel çš„åŒå­¦çš„è¯å…¶å®žå¾ˆå¥½ç†è§£ã€‚é…ç½®æ–¹é¢çš„è¯ Rule å±žæ€§æœ‰äº›ä¸åŒï¼Œè°ƒç”¨æ–¹é¢ï¼Œéœ€è¦æ·»åŠ ä¸Šæœ¬æ¬¡è°ƒç”¨ç›¸å…³çš„å‚æ•° ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬é…ç½®äº†å¯¹å•†å“ ID = 1 çš„é™æµè§„åˆ™ï¼Œæ¯æ¬¡è¯·æ±‚å•†å“æŽ¥å£ä¹‹å‰è°ƒç”¨ Sentinel çš„é™æµ APIï¼ŒæŒ‡å®š Resource å¹¶ä¼ å…¥å½“å‰è¦è®¿é—®çš„å•†å“ IDã€‚ å¦‚æžœ Sentinel èƒ½æ‰¾åˆ° Resource å¯¹åº”çš„ Ruleï¼Œåˆ™æ ¹æ® Rule è¿›è¡Œé™æµã€‚Rule ä¸­å¦‚æžœæ‰¾åˆ° arg å¯¹åº”çš„çƒ­ç‚¹å‚æ•°é…ç½®ï¼Œåˆ™ä½¿ç”¨çƒ­ç‚¹å‚æ•°çš„é˜ˆå€¼è¿›è¡Œé™æµã€‚æ‰¾ä¸åˆ°çš„è¯ï¼Œåˆ™ä½¿ç”¨ Rule ä¸­çš„é˜ˆå€¼ã€‚ å®žçŽ°åŽŸç†Sentinel æ•´ä½“é‡‡ç”¨äº†è´£ä»»é“¾çš„è®¾è®¡æ¨¡å¼ï¼ˆç±»ä¼¼ Servlet Filterï¼‰ï¼Œæ¯æ¬¡è°ƒç”¨ SphU.entry æ—¶ï¼Œéƒ½ä¼šç»åŽ†ä¸€ç³»åˆ—åŠŸèƒ½æ’æ§½ï¼ˆslot chainï¼‰ã€‚ä¸åŒçš„ Slot èŒè´£ä¸åŒï¼Œæœ‰çš„æ˜¯è´Ÿè´£æ”¶é›†ä¿¡æ¯ï¼Œæœ‰çš„æ˜¯è´Ÿè´£æ ¹æ®ä¸åŒçš„ç®—æ³•ç­–ç•¥è¿›è¡Œç†”æ–­é™æµæ“ä½œï¼Œå…³äºŽæ•´ä½“æµç¨‹å¤§å®¶å¯ä»¥é˜…è¯»ä¸‹ å®˜ç½‘ ä¸­å¯¹ Sentinel å·¥ä½œæµç¨‹çš„ä»‹ç»ã€‚ ParamFlowSlotå…³äºŽçƒ­ç‚¹å‚æ•°é™æµçš„é€»è¾‘åœ¨ com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowSlot ä¸­ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162public class ParamFlowSlot extends AbstractLinkedProcessorSlot&lt;DefaultNode&gt; &#123; @Override public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args) throws Throwable &#123; // ParamFlowManager ä¸­æ²¡æœ‰å¯¹åº”çš„ Ruleï¼Œåˆ™æ‰§è¡Œä¸‹ä¸€ä¸ªSlot if (!ParamFlowRuleManager.hasRules(resourceWrapper.getName())) &#123; fireEntry(context, resourceWrapper, node, count, prioritized, args); return; &#125; // é™æµæ£€æŸ¥ checkFlow(resourceWrapper, count, args); // æ‰§è¡Œä¸‹ä¸€ä¸ªSlot fireEntry(context, resourceWrapper, node, count, prioritized, args); &#125; @Override public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) &#123; // æ‰§è¡Œä¸‹ä¸€ä¸ªSlot fireExit(context, resourceWrapper, count, args); &#125; void applyRealParamIdx(/*@NonNull*/ ParamFlowRule rule, int length) &#123; int paramIdx = rule.getParamIdx(); if (paramIdx &lt; 0) &#123; if (-paramIdx &lt;= length) &#123; rule.setParamIdx(length + paramIdx); &#125; else &#123; // Illegal index, give it a illegal positive value, latter rule checking will pass. rule.setParamIdx(-paramIdx); &#125; &#125; &#125; void checkFlow(ResourceWrapper resourceWrapper, int count, Object... args) throws BlockException &#123; if (args == null) &#123; return; &#125; if (!ParamFlowRuleManager.hasRules(resourceWrapper.getName())) &#123; return; &#125; // èŽ·å– resource å¯¹åº”çš„å…¨éƒ¨ ParamFlowRule List&lt;ParamFlowRule&gt; rules = ParamFlowRuleManager.getRulesOfResource(resourceWrapper.getName()); for (ParamFlowRule rule : rules) &#123; applyRealParamIdx(rule, args.length); // åˆå§‹åŒ–è¯¥ Rule éœ€è¦çš„é™æµæŒ‡æ ‡æ•°æ® ParameterMetricStorage.initParamMetricsFor(resourceWrapper, rule); // å¦‚æžœä¸æ»¡è¶³æŸä¸ª Rule åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä»£è¡¨å½“å‰è¯·æ±‚è¢«é™æµ if (!ParamFlowChecker.passCheck(resourceWrapper, rule, count, args)) &#123; String triggeredParam = ""; if (args.length &gt; rule.getParamIdx()) &#123; Object value = args[rule.getParamIdx()]; triggeredParam = String.valueOf(value); &#125; throw new ParamFlowException(resourceWrapper.getName(), triggeredParam, rule); &#125; &#125; &#125;&#125; ParamFlowSlot ä¸­ä»£ç ä¸å¤šï¼Œä¹Ÿæ²¡åšä»€ä¹ˆäº‹ã€‚å‚è€ƒæ³¨é‡Šçš„è¯åº”è¯¥å¾ˆå¥½ç†è§£ã€‚å’±ä»¬ç›´æŽ¥æŒ‘å¹²çš„è®²ï¼Œæ¥çœ‹ä¸‹ ParamFlowChecker ä¸­æ˜¯å¦‚ä½•å®žçŽ°é™æµçš„ ParamFlowChecker æ•°æ®ç»“æž„çƒ­ç‚¹å‚æ•°é™æµä½¿ç”¨çš„ç®—æ³•ä¸ºä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œé¦–å…ˆæ¥çœ‹ä¸€ä¸‹æ•°æ®ç»“æž„æ˜¯å¦‚ä½•å­˜å‚¨çš„ 1234567891011121314151617181920public class ParameterMetric &#123; /** * Format: (rule, (value, timeRecorder)) * * @since 1.6.0 */ private final Map&lt;ParamFlowRule, CacheMap&lt;Object, AtomicLong&gt;&gt; ruleTimeCounters = new HashMap&lt;&gt;(); /** * Format: (rule, (value, tokenCounter)) * * @since 1.6.0 */ private final Map&lt;ParamFlowRule, CacheMap&lt;Object, AtomicLong&gt;&gt; ruleTokenCounter = new HashMap&lt;&gt;(); private final Map&lt;Integer, CacheMap&lt;Object, AtomicInteger&gt;&gt; threadCountMap = new HashMap&lt;&gt;(); // çœç•¥... &#125; Sentinel ä¸­ Resource ä»£è¡¨å½“å‰è¦è®¿é—®çš„èµ„æºï¼ˆæ–¹æ³•æˆ–è€…apiæŽ¥å£ï¼‰ï¼Œä¸€ä¸ª Resource å¯ä»¥å¯¹åº”å¤šä¸ª Ruleï¼Œè¿™äº› Rule å¯ä»¥æ˜¯ç›¸åŒçš„ classã€‚ çŽ°åœ¨å†æ¥çœ‹ ParameterMetric çš„ç»“æž„ï¼Œæ¯ä¸ª Resource å¯¹åº”ä¸€ä¸ª ParameterMetric å¯¹è±¡ï¼Œä¸Šè¿° CacheMap&lt;Object, AtomicLong&gt; çš„ Key ä»£è¡¨çƒ­ç‚¹å‚æ•°çš„å€¼ï¼ŒValue åˆ™æ˜¯å¯¹åº”çš„è®¡æ•°å™¨ã€‚ æ‰€ä»¥è¿™é‡Œæ•°æ®ç»“æž„çš„å…³ç³»æ˜¯è¿™æ ·çš„ ä¸€ä¸ª Resource æœ‰ä¸€ä¸ª ParameterMetric ä¸€ä¸ª ParameterMetric ç»Ÿè®¡äº†å¤šä¸ª Rule æ‰€éœ€è¦çš„é™æµæŒ‡æ ‡æ•°æ® æ¯ä¸ª Rule åˆå¯ä»¥é…ç½®å¤šä¸ªçƒ­ç‚¹å‚æ•° CacheMap çš„é»˜è®¤å®žçŽ°ï¼ŒåŒ…è£…äº† com.googlecode.concurrentlinkedhashmap.ConcurrentLinkedHashMap ä½¿ç”¨è¯¥ç±»çš„ä¸»è¦åŽŸå› æ˜¯ä¸ºäº†å®žçŽ°çƒ­ç‚¹å‚æ•°çš„ LRU è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼Œè¿™ä¸‰ä¸ªå˜é‡ ruleTimeCounters ï¼šè®°å½•ä»¤ç‰Œæ¡¶çš„æœ€åŽæ·»åŠ æ—¶é—´ï¼Œç”¨äºŽ QPS é™æµ ruleTokenCounter ï¼šè®°å½•ä»¤ç‰Œæ¡¶çš„ä»¤ç‰Œæ•°é‡ï¼Œç”¨äºŽ QPS é™æµ threadCountMap ï¼šç”¨äºŽçº¿ç¨‹çº§åˆ«é™æµï¼Œè¿™ä¸ªå…¶å®žå’Œä»¤ç‰Œæ¡¶ç®—æ³•æ²¡æœ‰å…³ç³»äº†ï¼Œçº¿ç¨‹é™æµåªæ˜¯åœ¨ Rule ä¸­å®šä¹‰äº†æœ€å¤§çº¿ç¨‹æ•°ï¼Œè¯·æ±‚æ—¶åˆ¤æ–­ä¸€ä¸‹å½“å‰çš„çº¿ç¨‹æ•°æ˜¯å¦å¤§äºŽæœ€å¤§çº¿ç¨‹ï¼Œå…·ä½“çš„åº”ç”¨åœ¨ ParamFlowChecker#passSingleValueCheck å®žé™…ä½¿ç”¨ ParameterMetric æ—¶ï¼Œä½¿ç”¨ ParameterMetricStorage èŽ·å– Resource å¯¹åº”çš„ ParameterMetric 12345public final class ParameterMetricStorage &#123; // Format (Resource, ParameterMetric) private static final Map&lt;String, ParameterMetric&gt; metricsMap = new ConcurrentHashMap&lt;&gt;(); // çœç•¥ç›¸å…³ä»£ç  &#125; ParamFlowChecker æ‰§è¡Œé€»è¾‘ParamFlowChecker ä¸­ QPS çº§é™æµæ”¯æŒä¸¤ç§ç­–ç•¥ CONTROL_BEHAVIOR_RATE_LIMITER ï¼šè¯·æ±‚é€ŸçŽ‡é™åˆ¶ï¼Œå¯¹åº”çš„æ–¹æ³•ParamFlowChecker#passThrottleLocalCheck DEFAULT ï¼šåªè¦æ¡¶ä¸­è¿˜æœ‰ä»¤ç‰Œï¼Œå°±å¯ä»¥é€šè¿‡ï¼Œå¯¹åº”çš„æ–¹æ³•ParamFlowChecker#passDefaultLocalCheck æŽ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»¥ passDefaultLocalCheck ä¸ºä¾‹ï¼Œè¿›è¡Œåˆ†æžã€‚ä½†æ˜¯åœ¨è¿™ä¹‹å‰ï¼Œå…ˆæ¥æ‹ä¸€ä¸‹ï¼Œä»Ž ParamFlowSlot#checkFlow åˆ° ParamFlowChecker#passDefaultLocalCheck è¿™ä¸­é—´éƒ½ç»åŽ†äº†ä»€ä¹ˆï¼Œè¯¦è§ðŸ‘‡ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859// ä¼ªä»£ç ï¼Œå¿½ç•¥äº†ä¸€äº›å‚æ•°ä¼ é€’checkFlow() &#123; // if æ²¡æœ‰å¯¹åº”çš„ ruleï¼Œè·³å‡º ParamFlowSlot é€»è¾‘ // if args == nullï¼Œè·³å‡º ParamFlowSlot é€»è¾‘ List&lt;ParamFlowRule&gt; rules = ParamFlowRuleManager.getRulesOfResource(resourceWrapper.getName()); rules.forEach(r -&gt; &#123; // åˆå§‹åŒ–è¯¥ Rule éœ€è¦çš„é™æµæŒ‡æ ‡æ•°æ® ParameterMetricStorage.initParamMetricsFor(resourceWrapper, rule); if (!ParamFlowChecker.passCheck(resourceWrapper, rule, count, args)) &#123; // æŠ›å‡ºé™æµå¼‚å¸¸ &#125; &#125;)&#125;passCheck() &#123; // ä»Ž args ä¸­èŽ·å–æœ¬æ¬¡é™æµéœ€è¦ä½¿ç”¨çš„ value int paramIdx = rule.getParamIdx(); Object value = args[paramIdx]; // æ ¹æ® rule åˆ¤æ–­æ˜¯è¯¥è¯·æ±‚ä½¿ç”¨é›†ç¾¤é™æµè¿˜æ˜¯æœ¬åœ°é™æµ if (rule.isClusterMode() &amp;&amp; rule.getGrade() == RuleConstant.FLOW_GRADE_QPS) &#123; return passClusterCheck(resourceWrapper, rule, count, value); &#125; return passLocalCheck(resourceWrapper, rule, count, value);&#125;passLocalCheck() &#123; // å¦‚æžœ value æ˜¯ Collection æˆ–è€… Array // Sentinel è®¤ä¸ºè¿™ä¸€ç»„æ•°æ®éƒ½éœ€è¦ç»è¿‡çƒ­ç‚¹å‚æ•°é™æµæ ¡éªŒ // éåŽ†æ‰€æœ‰å€¼è°ƒç”¨çƒ­ç‚¹å‚æ•°é™æµæ ¡éªŒ if (isCollectionOrArray(value)) &#123; value.forEach(v -&gt; &#123; // å½“æ•°ç»„ä¸­æŸä¸ª value æ— æ³•é€šè¿‡é™æµæ ¡éªŒæ—¶ï¼Œreturn false å¤–éƒ¨ä¼šæŠ›å‡ºé™æµå¼‚å¸¸ if (!passSingleValueCheck(resourceWrapper, rule, count, param)) &#123; return false; &#125; &#125;) &#125;&#125;passSingleValueCheck() &#123; if (rule.getGrade() == RuleConstant.FLOW_GRADE_QPS) &#123; if (rule.getControlBehavior() == RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER) &#123; // é€ŸçŽ‡é™åˆ¶ return passThrottleLocalCheck(resourceWrapper, rule, acquireCount, value); &#125; else &#123; // é»˜è®¤é™æµ return passDefaultLocalCheck(resourceWrapper, rule, acquireCount, value); &#125; &#125; else if (rule.getGrade() == RuleConstant.FLOW_GRADE_THREAD) &#123; // çº¿ç¨‹çº§é™æµé€»è¾‘ &#125;&#125; ä¸Šé¢æåˆ°äº†ä¸€ä¸ªé›†ç¾¤é™æµï¼Œå’Œä¸Šä¸€ç¯‡ä¸­è¯´åˆ°çš„é›†ç¾¤é™æµå®žçŽ°åŽŸç†æ˜¯ä¸€æ ·çš„ï¼Œé€‰å‡ºä¸€å° Server æ¥åšé™æµå†³ç­–ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯çš„é™æµè¯·æ±‚éƒ½å’¨è¯¢ Serverï¼Œç”± Server æ¥å†³å®šã€‚ç”±äºŽä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œå°±ä¸å¤šè¯´äº†ã€‚ ParamFlowChecker é™æµæ ¸å¿ƒä»£ç é“ºåž«äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºŽè¿Žæ¥äº†æˆ‘ä»¬çš„ä¸»è§’ ParamFlowChecker#passDefaultLocalCheckï¼Œè¯¥æ–¹æ³•ä¸­å®žçŽ°äº†ç®€å•çš„ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œç”¨äºŽçƒ­ç‚¹å‚æ•°é™æµ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586static boolean passDefaultLocalCheck(ResourceWrapper resourceWrapper, ParamFlowRule rule, int acquireCount, Object value) &#123; // æ ¹æ® resource èŽ·å– ParameterMetric ParameterMetric metric = getParameterMetric(resourceWrapper); // æ ¹æ® rule ä»Ž metric ä¸­èŽ·å–å½“å‰ rule çš„è®¡æ•°å™¨ CacheMap&lt;Object, AtomicLong&gt; tokenCounters = metric == null ? null : metric.getRuleTokenCounter(rule); CacheMap&lt;Object, AtomicLong&gt; timeCounters = metric == null ? null : metric.getRuleTimeCounter(rule); if (tokenCounters == null || timeCounters == null) &#123; return true; &#125; // Calculate max token count (threshold) Set&lt;Object&gt; exclusionItems = rule.getParsedHotItems().keySet(); long tokenCount = (long)rule.getCount(); // å¦‚æžœçƒ­ç‚¹å‚æ•°ä¸­åŒ…å«å½“å‰ valueï¼Œåˆ™ä½¿ç”¨çƒ­ç‚¹å‚æ•°é…ç½®çš„countï¼Œå¦åˆ™ä½¿ç”¨ rule ä¸­å®šä¹‰çš„ count if (exclusionItems.contains(value)) &#123; tokenCount = rule.getParsedHotItems().get(value); &#125; if (tokenCount == 0) &#123; return false; &#125; long maxCount = tokenCount + rule.getBurstCount(); // å½“å‰ç”³è¯·çš„æµé‡ å’Œ æœ€å¤§æµé‡æ¯”è¾ƒ if (acquireCount &gt; maxCount) &#123; return false; &#125; while (true) &#123; long currentTime = TimeUtil.currentTimeMillis(); // è¿™é‡Œç›¸å½“äºŽå¯¹å½“å‰ value å¯¹åº”çš„ä»¤ç‰Œæ¡¶è¿›è¡Œåˆå§‹åŒ– AtomicLong lastAddTokenTime = timeCounters.putIfAbsent(value, new AtomicLong(currentTime)); if (lastAddTokenTime == null) &#123; // Token never added, just replenish the tokens and consume &#123;@code acquireCount&#125; immediately. tokenCounters.putIfAbsent(value, new AtomicLong(maxCount - acquireCount)); return true; &#125; // Calculate the time duration since last token was added. long passTime = currentTime - lastAddTokenTime.get(); // A simplified token bucket algorithm that will replenish the tokens only when statistic window has passed. if (passTime &gt; rule.getDurationInSec() * 1000) &#123; // è¡¥å…… token AtomicLong oldQps = tokenCounters.putIfAbsent(value, new AtomicLong(maxCount - acquireCount)); if (oldQps == null) &#123; // Might not be accurate here. lastAddTokenTime.set(currentTime); return true; &#125; else &#123; long restQps = oldQps.get(); // æ¯æ¯«ç§’åº”è¯¥ç”Ÿæˆçš„ token = tokenCount / (rule.getDurationInSec() * 1000) // å† * passTime å³ç­‰äºŽåº”è¯¥è¡¥å……çš„ token long toAddCount = (passTime * tokenCount) / (rule.getDurationInSec() * 1000); // è¡¥å……çš„ token ä¸ä¼šè¶…è¿‡æœ€å¤§å€¼ long newQps = toAddCount + restQps &gt; maxCount ? (maxCount - acquireCount) : (restQps + toAddCount - acquireCount); if (newQps &lt; 0) &#123; return false; &#125; if (oldQps.compareAndSet(restQps, newQps)) &#123; lastAddTokenTime.set(currentTime); return true; &#125; Thread.yield(); &#125; &#125; else &#123; // ç›´æŽ¥æ“ä½œè®¡æ•°å™¨æ‰£å‡å³å¯ AtomicLong oldQps = tokenCounters.get(value); if (oldQps != null) &#123; long oldQpsValue = oldQps.get(); if (oldQpsValue - acquireCount &gt;= 0) &#123; if (oldQps.compareAndSet(oldQpsValue, oldQpsValue - acquireCount)) &#123; return true; &#125; &#125; else &#123; return false; &#125; &#125; Thread.yield(); &#125; &#125;&#125; ä»¤ç‰Œæ¡¶ç®—æ³•æ ¸å¿ƒæ€æƒ³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç»“åˆè¿™ä¸ªå›¾å’±ä»¬å†æ¥ç†è§£ç†è§£ä»£ç  æ ¸å¿ƒé€»è¾‘åœ¨ while å¾ªçŽ¯ä¸­ï¼Œå’±ä»¬ç›´æŽ¥æŒ‘å¹²çš„è®² å…ˆå›žé¡¾ä¸€ä¸‹ä¸Šé¢è¯´è¿‡ tokenCounters å’Œ timeCountersï¼Œåœ¨é»˜è®¤é™æµå®žçŽ°ä¸­ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨æœ€åŽæ·»åŠ ä»¤ç‰Œæ—¶é—´ï¼Œä»¤ç‰Œå‰©ä½™æ•°é‡ while é€»è¾‘ï¼š é¦–å…ˆå¦‚æžœå½“å‰ value å¯¹åº”çš„ä»¤ç‰Œæ¡¶ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œåˆå§‹åŒ– è®¡ç®—å½“å‰æ—¶é—´åˆ°ä¸Šæ¬¡æ·»åŠ  token æ—¶é—´ç»åŽ†äº†å¤šä¹…ï¼Œå³ passTime = currentTime - lastAddTokenTime.get() ç”¨äºŽåˆ¤æ–­æ˜¯å¦éœ€è¦æ·»åŠ  token 2.1) if (pass &gt; rule ä¸­è®¾å®šçš„é™æµå•ä½æ—¶é—´) ï¼Œåˆ™ä½¿ç”¨åŽŸå­æ“ä½œä¸ºä»¤ç‰Œæ¡¶è¡¥å…… tokenï¼ˆå…·ä½“è¡¥å…… token çš„é€»è¾‘è¯¦è§ä¸Šé¢ä»£ç æ³¨é‡Šï¼‰ 2.2) else ä¸éœ€è¦è¡¥å…… tokenï¼Œä½¿ç”¨åŽŸå­æ“ä½œæ‰£å‡ä»¤ç‰Œ å¯ä»¥çœ‹åˆ°å…³äºŽ token çš„æ“ä½œå…¨æ˜¯ä½¿ç”¨åŽŸå­æ“ä½œï¼ˆCASï¼‰ï¼Œä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚å¦‚æžœåŽŸå­æ“ä½œæ›´æ–°å¤±è´¥ï¼Œåˆ™ä¼šç»§ç»­æ‰§è¡Œã€‚ é€ŸçŽ‡é™åˆ¶çš„å®žçŽ°å†é¡ºä¾¿å¨å’•ä¸‹ä¸Šé¢è¯´è¿‡CONTROL_BEHAVIOR_RATE_LIMITER é€ŸçŽ‡é™åˆ¶ç­–ç•¥æ˜¯å¦‚ä½•å®žçŽ°çš„ï¼Œåªç®€å•è¯´è¯´æ€è·¯ï¼Œå…·ä½“ç»†èŠ‚å¤§å®¶å¯ä»¥è‡ªå·±çœ‹ä¸‹æºç  è¯¥ç­–ç•¥ä¸­ï¼Œä»…ä½¿ç”¨ timeCountersï¼Œè¯¥å‚æ•°å­˜å‚¨çš„æ•°æ®å˜æˆäº† lastPassTimeï¼ˆæœ€åŽé€šè¿‡æ—¶é—´ï¼‰ï¼Œæ‰€ä»¥è¿™ä¸ªå®žçŽ°å’Œä»¤ç‰Œæ¡¶ä¹Ÿæ²¡å•¥å…³ç³»äº† æ–°çš„è¯·æ±‚åˆ°æ¥æ—¶ï¼Œé¦–å…ˆæ ¹æ® Rule ä¸­å®šä¹‰æ—¶é—´èŒƒå›´ï¼Œcount è®¡ç®— costTimeï¼Œä»£è¡¨æ¯éš”å¤šä¹…æ‰èƒ½é€šè¿‡ä¸€ä¸ªè¯·æ±‚1long costTime = Math.round(1.0 * 1000 * acquireCount * rule.getDurationInSec() / tokenCount); åªæœ‰ lastPassTime + costTime &lt;= currentTime ï¼Œè¯·æ±‚æ‰æœ‰å¯èƒ½æˆåŠŸé€šè¿‡ï¼ŒlastPassTime + costTime è¿‡å¤§ä¼šå¯¼è‡´é™æµã€‚ æœ€åŽ å¦‚æžœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼ŒåŠ¨åŠ¨å°æ‰‹ç‚¹ä¸‹å…³æ³¨ï¼Œä½ çš„æ”¯æŒæ˜¯å¯¹æˆ‘æœ€å¤§çš„å¸®åŠ©]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>æºç </tag>
        <tag>åˆ†å¸ƒå¼</tag>
        <tag>Sentinel</tag>
        <tag>é™æµ</tag>
        <tag>å¾®æœåŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æƒé‡éšæœºï¼ˆWeight randomï¼‰ç®—æ³•è¯¦è§£]]></title>
    <url>%2Fpost%2F25a528d8.html</url>
    <content type="text"><![CDATA[åº”ç”¨åœºæ™¯ å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œä¾‹å¦‚ Nacos æä¾›çš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å°±æ˜¯ä½¿ç”¨äº†è¯¥ç®—æ³• æ¸¸æˆæŠ½å¥–ï¼ˆæ™®é€šé“å…·çš„æƒé‡å¾ˆé«˜ï¼Œç¨€æœ‰é“å…·çš„æƒé‡å¾ˆä½Žï¼‰ æœ¬æ–‡ç›®æ ‡Java å®žçŽ°æƒé‡éšæœºç®—æ³• ç®—æ³•è¯¦è§£æ¯”å¦‚æˆ‘ä»¬çŽ°åœ¨æœ‰ä¸‰å° Serverï¼Œæƒé‡åˆ†åˆ«ä¸º1ï¼Œ3ï¼Œ2ã€‚çŽ°åœ¨æƒ³å¯¹ä¸‰å° Server åšè´Ÿè½½å‡è¡¡ 1234Server1 Server2 Server3 weight weight weight 1 3 2 æƒé‡æ¯”ä¾‹ æˆ‘ä»¬ç®—å‡ºæ¯å° Server çš„æƒé‡æ¯”ä¾‹ï¼Œæƒé‡æ¯”ä¾‹ = è‡ªå·±çš„æƒé‡ / æ€»æƒé‡ 1234567server1 server2 server3 weight weight weight 1 3 2 radio radio radio 1/6 3/6 2/6 æ ¹æ®æƒé‡æ¯”ä¾‹è®¡ç®—è¦†ç›–åŒºåŸŸ 123456 server1 server2 server3 ^ ^ ^|---------||---------|---------|---------||---------|---------||0 1/6 4/6 6/6 ^ ^ ^ 0.16666667 0.66666667 1.0 æ ¹æ®æƒé‡è´Ÿè½½å‡è¡¡ å¦‚æ­¥éª¤2æ‰€ç¤ºï¼Œæ¯ä¸ª server éƒ½æœ‰è‡ªå·±çš„èŒƒå›´ï¼ŒæŠŠæ¯ä¸€ä¸ªæ ¼å­ä½œä¸ºå•ä½æ¥çœ‹çš„è¯ server1 (0,1] server2 (1,4] server3 (4,6] ä½¿ç”¨éšæœºæ•°å‡½æ•°ï¼Œå– (0,6] ä¹‹é—´çš„éšæœºæ•°ï¼Œæ ¹æ®éšæœºæ•°è½åœ¨å“ªä¸ªèŒƒå›´å†³å®šå¦‚ä½•é€‰æ‹©ã€‚ä¾‹å¦‚éšæœºæ•°ä¸º 2ï¼Œå¤„äºŽ (1,4] èŒƒå›´ï¼Œé‚£ä¹ˆå°±é€‰æ‹© server2ã€‚ æ€è·¯å¤§æ¦‚å°±æ˜¯è¿™æ ·ï¼Œè½å®žåˆ°ä»£ç ä¸Šï¼Œç”¨ä¸€ä¸ªæ•°ç»„ [0.16666667, 0.66666667, 1] æ¥è¡¨ç¤ºè¿™ä¸‰ä¸ª server çš„è¦†ç›–èŒƒå›´ï¼Œä½¿ç”¨ ThreadLocalRandom æˆ–è€… Random èŽ·å– [0,1) å†…çš„éšæœºæ•°ã€‚ç„¶åŽä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ³•å¿«é€Ÿå®šä½éšæœºæ•°å¤„äºŽå“ªä¸ªåŒºé—´ Java å®žçŽ°ä»£ç åŸºæœ¬ä¸Šä¸Ž com.alibaba.nacos.client.naming.utils.Chooser ä¸€è‡´ï¼Œåœ¨å¯è¯»æ€§æ–¹é¢åšäº†ä¸‹ä¼˜åŒ–ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134import java.util.*;import java.util.concurrent.ThreadLocalRandom;import java.util.concurrent.atomic.AtomicInteger;public class WeightRandom&lt;T&gt; &#123; private final List&lt;T&gt; items = new ArrayList&lt;&gt;(); private double[] weights; public WeightRandom(List&lt;ItemWithWeight&lt;T&gt;&gt; itemsWithWeight) &#123; this.calWeights(itemsWithWeight); &#125; /** * è®¡ç®—æƒé‡ï¼Œåˆå§‹åŒ–æˆ–è€…é‡æ–°å®šä¹‰æƒé‡æ—¶ä½¿ç”¨ * */ public void calWeights(List&lt;ItemWithWeight&lt;T&gt;&gt; itemsWithWeight) &#123; items.clear(); // è®¡ç®—æƒé‡æ€»å’Œ double originWeightSum = 0; for (ItemWithWeight&lt;T&gt; itemWithWeight : itemsWithWeight) &#123; double weight = itemWithWeight.getWeight(); if (weight &lt;= 0) &#123; continue; &#125; items.add(itemWithWeight.getItem()); if (Double.isInfinite(weight)) &#123; weight = 10000.0D; &#125; if (Double.isNaN(weight)) &#123; weight = 1.0D; &#125; originWeightSum += weight; &#125; // è®¡ç®—æ¯ä¸ªitemçš„å®žé™…æƒé‡æ¯”ä¾‹ double[] actualWeightRatios = new double[items.size()]; int index = 0; for (ItemWithWeight&lt;T&gt; itemWithWeight : itemsWithWeight) &#123; double weight = itemWithWeight.getWeight(); if (weight &lt;= 0) &#123; continue; &#125; actualWeightRatios[index++] = weight / originWeightSum; &#125; // è®¡ç®—æ¯ä¸ªitemçš„æƒé‡èŒƒå›´ // æƒé‡èŒƒå›´èµ·å§‹ä½ç½® weights = new double[items.size()]; double weightRangeStartPos = 0; for (int i = 0; i &lt; index; i++) &#123; weights[i] = weightRangeStartPos + actualWeightRatios[i]; weightRangeStartPos += actualWeightRatios[i]; &#125; &#125; /** * åŸºäºŽæƒé‡éšæœºç®—æ³•é€‰æ‹© * */ public T choose() &#123; double random = ThreadLocalRandom.current().nextDouble(); int index = Arrays.binarySearch(weights, random); if (index &lt; 0) &#123; index = -index - 1; &#125; else &#123; return items.get(index); &#125; if (index &lt; weights.length &amp;&amp; random &lt; weights[index]) &#123; return items.get(index); &#125; // é€šå¸¸ä¸ä¼šèµ°åˆ°è¿™é‡Œï¼Œä¸ºäº†ä¿è¯èƒ½å¾—åˆ°æ­£ç¡®çš„è¿”å›žï¼Œè¿™é‡Œéšä¾¿è¿”å›žä¸€ä¸ª return items.get(0); &#125; public static class ItemWithWeight&lt;T&gt; &#123; T item; double weight; public ItemWithWeight() &#123; &#125; public ItemWithWeight(T item, double weight) &#123; this.item = item; this.weight = weight; &#125; public T getItem() &#123; return item; &#125; public void setItem(T item) &#123; this.item = item; &#125; public double getWeight() &#123; return weight; &#125; public void setWeight(double weight) &#123; this.weight = weight; &#125; &#125; public static void main(String[] args) &#123; // for test int sampleCount = 1_000_000; ItemWithWeight&lt;String&gt; server1 = new ItemWithWeight&lt;&gt;("server1", 1.0); ItemWithWeight&lt;String&gt; server2 = new ItemWithWeight&lt;&gt;("server2", 3.0); ItemWithWeight&lt;String&gt; server3 = new ItemWithWeight&lt;&gt;("server3", 2.0); WeightRandom&lt;String&gt; weightRandom = new WeightRandom&lt;&gt;(Arrays.asList(server1, server2, server3)); // ç»Ÿè®¡ (è¿™é‡Œç”¨ AtomicInteger ä»…ä»…æ˜¯å› ä¸ºå†™èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ï¼Œè¿™æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æµ‹è¯•) Map&lt;String, AtomicInteger&gt; statistics = new HashMap&lt;&gt;(); for (int i = 0; i &lt; sampleCount; i++) &#123; statistics .computeIfAbsent(weightRandom.choose(), (k) -&gt; new AtomicInteger()) .incrementAndGet(); &#125; statistics.forEach((k, v) -&gt; &#123; double hit = (double) v.get() / sampleCount; System.out.println(k + ", hit:" + hit); &#125;); &#125;&#125; è¿™é‡Œé‡ç‚¹è¯´ä¸€ä¸‹ Arrays.binarySearch(weights, random)ï¼Œè¿™ä¸ª API æˆ‘ä¹‹å‰æ²¡æœ‰ç”¨è¿‡å¯¼è‡´æˆ‘åœ¨è¯» Nacos æºç æ—¶ï¼Œå¯¹è¿™å—çš„æ“ä½œååˆ†è´¹è§£ æ¥çœ‹ä¸€ä¸‹ java API æ–‡æ¡£å¯¹è¯¥æ–¹æ³•è¿”å›žå€¼çš„è§£é‡Š Returns:index of the search key, if it is contained in the array; otherwise, (-(insertion point) - 1). The insertion point is defined as the point at which the key would be inserted into the array: the index of the first element greater than the key, or a.length if all elements in the array are less than the specified key. Note that this guarantees that the return value will be &gt;= 0 if and only if the key is found. è§£é‡Šä¸‹ï¼Œé¦–å…ˆè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯é€šè¿‡æŒ‡å®šçš„ key æœç´¢æ•°ç»„ã€‚ï¼ˆå‰ææ¡ä»¶æ˜¯è¦ä¿è¯æ•°ç»„çš„é¡ºåºæ˜¯ä»Žå°åˆ°å¤§æŽ’åºè¿‡çš„ï¼‰ å¦‚æžœæ•°ç»„ä¸­åŒ…å«è¯¥ keyï¼Œåˆ™è¿”å›žå¯¹åº”çš„ç´¢å¼• å¦‚æžœä¸åŒ…å«è¯¥ keyï¼Œåˆ™è¿”å›žè¯¥ key çš„ (-(insertion point)-1) insertion pointï¼ˆæ’å…¥ç‚¹ï¼‰ï¼šè¯¥ key åº”è¯¥åœ¨æ•°ç»„çš„å“ªä¸ªä½ç½®ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ•°ç»„ [1,3,5]ï¼Œæˆ‘çš„æœç´¢ key ä¸º 2ï¼ŒæŒ‰ç…§é¡ºåºæŽ’çš„è¯ 2 åº”è¯¥åœ¨æ•°ç»„çš„ index = 1 çš„ä½ç½®ï¼Œæ‰€ä»¥æ­¤æ—¶ insertion point = 1ã€‚ ï¼ˆè¿™é‡Œ jdk å°†èƒ½æŸ¥åˆ° key å’Œ æŸ¥ä¸åˆ° key ä¸¤ç§æƒ…å†µåšäº†åŒºåˆ†ã€‚ä¸ºäº†å°†æœªæ‰¾åˆ°çš„æƒ…å†µå…¨éƒ¨è¿”å›žè´Ÿæ•°ï¼Œæ‰€ä»¥åšäº† (-(insertion point)-1) è¿™æ ·çš„æ“ä½œï¼‰ çœ‹åˆ°è¿™ï¼Œæˆ‘ä»¬å°±æ‡‚äº†ï¼Œinsertion point å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼ŒçŽ°åœ¨æˆ‘ä»¬ç”¨å°å­¦æ•°å­¦æ¥æŽ¨å¯¼ä¸€ä¸‹å¦‚ä½•è®¡ç®— insertion point 12345678// å°å­¦æ•°å­¦æŽ¨å¯¼ä¸€ä¸‹ insertion point å¦‚ä½•è®¡ç®—returnValue = (- (insertionPoint) - 1)insertionPoint = (- (returnValue + 1) )// æ‰€ä»¥å°±æœ‰äº†ä¸Šè¾¹ä»£ç ä¸­çš„if (index &lt; 0) &#123; index = -index - 1;&#125; å‚è€ƒhttps://github.com/alibaba/nacos/blob/develop/client/src/main/java/com/alibaba/nacos/client/naming/utils/Chooser.java]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>ç®—æ³•</tag>
        <tag>è´Ÿè½½å‡è¡¡</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ·±å…¥ç†è§£ Sentinel ä¸­çš„é™æµç®—æ³•]]></title>
    <url>%2Fpost%2F690c857.html</url>
    <content type="text"><![CDATA[æœ€è¿‘åœ¨å­¦ä¹  Sentinelï¼Œæ·±å…¥å­¦ä¹ äº†æºç ä¹‹åŽåˆ†äº«ä¸€ä¸‹å¿ƒå¾— Sentinel ç‰ˆæœ¬1.8.0 å›ºå®šçª—å£ç®—æ³•å…ˆä»‹ç»ä¸€ä¸‹æœ€ç®€å•çš„é™æµç®—æ³• æ¯ä¸ªçª—å£éƒ½æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼ˆcounterï¼‰ç”¨äºŽç»Ÿè®¡æµé‡ï¼Œå¦‚æžœ counter + æœ¬æ¬¡ç”³è¯·çš„è¯·æ±‚æ•° &gt; é¢„è®¾çš„ QPSï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚ å›ºå®šçª—å£å¾ˆç®€å•ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¾ˆå¤§çš„é—®é¢˜ å‡è®¾æˆ‘ä»¬è§„å®š QPS ä¸èƒ½è¶…è¿‡ 100ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤º r1 å’Œ r2 ä¸¤ä¸ªæ—¶é—´ç‚¹åˆ†åˆ«æ¥äº† 60 ä¸ªè¯·æ±‚ï¼Œ QPS å·²ç»å¤§äºŽ 100 äº†ã€‚æ­¤æ—¶åº”è¯¥è§¦å‘é™æµäº†ï¼Œä½†æ˜¯å›ºå®šçª—å£ç®—æ³•å‚»å‚»çš„åªå…³æ³¨è‡ªå·±çª—å£çš„æµé‡ï¼Œæ„ŸçŸ¥ä¸åˆ° QPS å·²ç»è¶…äº† æ»‘åŠ¨çª—å£ç®—æ³• è¯¥ç®—æ³•å°†å•ä½æ—¶é—´åˆ‡æˆäº†å¤šä¸ªçª—å£ï¼Œæ¯æ¬¡è®¡ç®— QPS æ—¶ï¼Œè®¡ç®— å½“å‰çª—å£ + è¿‡åŽ»å‡ ä¸ªçª—å£ çš„æµé‡æ€»å’Œï¼Œè¿™æ ·å°±é¿å…äº†å›ºå®šçª—å£çš„é—®é¢˜ï¼ˆå…·ä½“ä½¿ç”¨å‡ ä¸ªçª—å£ï¼Œå–å†³äºŽçª—å£å¤§å°å’Œå•ä½æ—¶é—´å¤§å°ã€‚ä¾‹å¦‚ä¸Šå›¾ï¼Œæ¯ä¸ªçª—å£å¤§å°ä¸º 500 msï¼Œä»¥ 1 s ä¸ºå•ä½æ—¶é—´åšé™æµï¼Œæ¯æ¬¡ä½¿ç”¨ current + last å³å¯ï¼‰ ç®—æ³•å®žçŽ°ç»†èŠ‚æ€è€ƒç†è§£ç®—æ³•æ€è·¯ä¹‹åŽï¼ŒæŽ¥ä¸‹æ¥è¦æ€è€ƒå¦‚ä½•å®žçŽ°è¿™ä¸ªç®—æ³•äº† é¦–å…ˆæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªä¸Šå›¾ä¸­çš„æ—¶é—´è½´ï¼Œæ¥è®°å½•æ—¶é—´çª—å£ï¼Œå¯ä»¥é€šè¿‡æ•°ç»„æ¥å®žçŽ°è¿™ä¸ªæ—¶é—´è½´ã€‚ æ—¶é—´è½´æœ‰äº†ï¼Œæˆ‘ä»¬å†æ¥è€ƒè™‘ä¸€ä¸‹æ—¶é—´çª—å£ã€‚ æ¯ä¸ªæ—¶é—´çª—å£è‚¯å®šè¦æœ‰ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨ä»¥åŠå½“å‰çª—å£å¯¹åº”çš„æ—¶é—´ 12345678910// æ—¶é—´è½´List&lt;Window&gt; timeline = new ArrayList&lt;&gt;();// æ¯ä¸ªçª—å£çš„å¤§å°int windowTime;// æ—¶é—´çª—å£class Window &#123; Timestamp startTime; AtomicInteger counter;&#125; ä½†æ˜¯å¦‚æžœä»”ç»†ä¸€æƒ³ï¼Œè¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜çš„ ç”±äºŽæ—¶é—´æ˜¯ä¼šä¸€ç›´å¢žé•¿çš„ï¼Œé‚£æˆ‘ä»¬çš„æ•°ç»„æ€Žä¹ˆåŠžï¼Ÿä¹Ÿè¦è·Ÿç€æ—¶é—´æ— é™çš„å¢žå¤§å—ï¼Ÿ æ—§çš„æ—¶é—´çª—å£ï¼ˆä¾‹å¦‚å‡ ç§’ä¹‹å‰çš„ï¼‰åœ¨ä¹‹åŽçš„è®¡ç®—ä¸ä¼šå†ç”¨åˆ°äº†ï¼Œå¦‚ä½•æ¸…ç†è¿™äº›æ— ç”¨çš„çª—å£ï¼Ÿ Sentinel ä¸­æ»‘åŠ¨çª—å£ç®—æ³•å¦‚ä½•å®žçŽ°çš„å¸¦ç€ä¸Šè¿°çš„é—®é¢˜ä¸Žæ€è€ƒæ¥çœ‹ä¸‹ Sentinel ä¸­æ˜¯å¦‚ä½•å®žçŽ°çš„ LeapArraySentinel ä¸­æ»‘åŠ¨çª—å£ç®—æ³•çš„æ ¸å¿ƒç±»ï¼Œé¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ä»–çš„æ ¸å¿ƒæˆå‘˜å˜é‡ 123456789101112131415161718192021222324public abstract class LeapArray&lt;T&gt; &#123; // è¦ç»Ÿè®¡çš„å•ä½æ—¶é—´å¤§å°ï¼Œä¾‹å¦‚è®¡ç®—QPSæ—¶ï¼Œä¸º1000 protected int intervalInMs; // æ ·æœ¬æ•°é‡ protected int sampleCount; // çª—å£å¤§å° è¯¥å€¼ = intervalInMs / sampleCount protected int windowLengthInMs; // å­˜å‚¨æ—¶é—´çª—å£çš„æ•°ç»„ protected final AtomicReferenceArray&lt;WindowWrap&lt;T&gt;&gt; array; public LeapArray(int sampleCount, int intervalInMs) &#123; AssertUtil.isTrue(sampleCount &gt; 0, "bucket count is invalid: " + sampleCount); AssertUtil.isTrue(intervalInMs &gt; 0, "total time interval of the sliding window should be positive"); AssertUtil.isTrue(intervalInMs % sampleCount == 0, "time span needs to be evenly divided"); this.windowLengthInMs = intervalInMs / sampleCount; this.intervalInMs = intervalInMs; this.sampleCount = sampleCount; this.array = new AtomicReferenceArray&lt;&gt;(sampleCount); &#125; &#125; å•æœºé™æµåœ¨ç»Ÿè®¡ QPS æ—¶ï¼Œé»˜è®¤ sampleCount = 2ï¼ŒintervalInMs = 1000ï¼ŒwindowLengthInMs = 500 LeapArray#calculateTimeIdxå¤§ä½“æ€è·¯ç›¸åŒï¼ŒåŒæ ·æ˜¯åˆ©ç”¨ä¸€ä¸ªæ•°ç»„å®žçŽ°æ—¶é—´è½´ï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ªæ—¶é—´çª—å£ Sentinel ä¸­ æ•°ç»„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œé€šè¿‡æ–¹æ³• LeapArray#calculateTimeIdx æ¥ ç¡®å®šæ—¶é—´æˆ³åœ¨æ•°ç»„ ä¸­çš„ä½ç½® ï¼ˆæ‰¾åˆ°æ—¶é—´æˆ³å¯¹åº”çš„çª—å£ä½ç½®ï¼‰ æ€Žä¹ˆç†è§£è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿ æˆ‘ä»¬æŠŠæ•°æ®å¸¦å…¥è¿›åŽ»ï¼Œå‡è®¾ windowLengthInMs = 500 ms ï¼ˆæ¯ä¸ªæ—¶é—´çª—å£å¤§å°æ˜¯ 500 msï¼‰ å¦‚æžœ timestamp ä»Ž 0 å¼€å§‹çš„è¯ï¼Œæ¯ä¸ªæ—¶é—´çª—å£ä¸º [0,500) [500,1000) [1000,1500) â€¦ è¿™æ—¶å€™å…ˆä¸è€ƒè™‘ timeId % array.length() ï¼Œä¹Ÿä¸è€ƒè™‘æ•°ç»„é•¿åº¦ã€‚å‡è®¾å½“å‰ timeMillis = 601ï¼Œå°†æ•°å€¼ä»£å…¥åˆ° timeMillis / windowLengthInMs å…¶å®žå°±å¯ä»¥ç¡®å®šå‡ºå½“å‰çš„ timestamp å¯¹åº”çš„æ—¶é—´çª—å£åœ¨æ•°ç»„ä¸­çš„ä½ç½®äº† ç”±äºŽæ•°ç»„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥å†åŠ ä¸Šæ±‚ä½™æ•°å–æ¨¡æ¥ç¡®å®šæ—¶é—´çª—åœ¨æ•°ç»„ä¸­çš„ä½ç½® LeapArray#currentWindowå…ˆæ¥çœ‹ä¸€ä¸‹ Sentinel ä¸­ Window çš„ç»“æž„ï¼ŒåŸºæœ¬å’Œæˆ‘ä»¬ä¸Šé¢æƒ³çš„ä¸€è‡´ï¼Œè®¡æ•°å™¨ä½¿ç”¨äº†æ³›åž‹ï¼Œå¯ä»¥æ›´çµæ´»12345678910111213141516171819public class WindowWrap&lt;T&gt; &#123; /** * Time length of a single window bucket in milliseconds. */ private final long windowLengthInMs; /** * Start timestamp of the window in milliseconds. */ private long windowStart; /** * Statistic data. */ private T value; // çœç•¥ã€‚ã€‚ã€‚&#125; ç»§ç»­è¯´ currentWindowï¼Œè¯¥æ–¹æ³•æ ¹æ®ä¼ å…¥çš„ timestamp æ‰¾åˆ° æˆ–è€… åˆ›å»º è¿™ä¸ªæ—¶é—´æˆ³å¯¹åº”çš„ Window è¿™ä¸ªæ–¹æ³•æºç ä¸­æ³¨é‡Šå¾ˆå¤šï¼Œæˆ‘åˆ é™¤äº†éƒ¨åˆ†æ³¨é‡Š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public WindowWrap&lt;T&gt; currentWindow(long timeMillis) &#123; if (timeMillis &lt; 0) &#123; return null; &#125; int idx = calculateTimeIdx(timeMillis); // Calculate current bucket start time. long windowStart = calculateWindowStart(timeMillis); /* * Get bucket item at given time from the array. * * (1) Bucket is absent, then just create a new bucket and CAS update to circular array. * (2) Bucket is up-to-date, then just return the bucket. * (3) Bucket is deprecated, then reset current bucket and clean all deprecated buckets. */ while (true) &#123; WindowWrap&lt;T&gt; old = array.get(idx); if (old == null) &#123; WindowWrap&lt;T&gt; window = new WindowWrap&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis)); if (array.compareAndSet(idx, null, window)) &#123; // Successfully updated, return the created bucket. return window; &#125; else &#123; // Contention failed, the thread will yield its time slice to wait for bucket available. Thread.yield(); &#125; &#125; else if (windowStart == old.windowStart()) &#123; return old; &#125; else if (windowStart &gt; old.windowStart()) &#123; if (updateLock.tryLock()) &#123; try &#123; // Successfully get the update lock, now we reset the bucket. return resetWindowTo(old, windowStart); &#125; finally &#123; updateLock.unlock(); &#125; &#125; else &#123; // Contention failed, the thread will yield its time slice to wait for bucket available. Thread.yield(); &#125; &#125; else if (windowStart &lt; old.windowStart()) &#123; // Should not go through here, as the provided time is already behind. return new WindowWrap&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis)); &#125; &#125;&#125; æ–¹æ³•é€»è¾‘åˆ†æžå¦‚ä¸‹ï¼š é¦–å…ˆè¦åšçš„ä¸¤ä»¶äº‹ è®¡ç®— timestamp åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡è¯´çš„ calculateTimeIdx è®¡ç®— timestamp çš„ windowStartï¼ˆçª—å£å¼€å§‹æ—¶é—´ï¼‰ï¼Œé€šè¿‡ timeMillis - timeMillis % windowLengthInMsï¼Œè¿™ä¸ªå€¼åœ¨åŽè¾¹ä¼šç”¨åˆ° ç„¶åŽè¿›å…¥ä¸€ä¸ª while(true) å¾ªçŽ¯ï¼Œ é€šè¿‡ WindowWrap&lt;T&gt; old = array.get(idx) æ‰¾å‡ºå¯¹åº”çš„çª—å£ï¼ŒæŽ¥ä¸‹æ¥å°±æ˜¯ä¸‰ç§æƒ…å†µäº† old == null è¿™ä¸ªæ—¶å€™ä»£è¡¨æ•°ç»„ä¸­è¿˜æ²¡æœ‰è¿™ä¸ª windowï¼Œåˆ›å»ºè¿™ä¸ª window åŠ å…¥åˆ°æ•°ç»„ä¸­ï¼ˆç”±äºŽæ­¤æ—¶å¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ·»åŠ æ•°ç»„å…ƒç´ ï¼Œæ‰€ä»¥ä¸€å®šè¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„æ•°ç»„ä¸º AtomicReferenceArrayï¼‰ï¼Œæ·»åŠ æˆåŠŸåŽè¿”å›žæ–°å»ºçš„ window windowStart == old.windowStart() window å·²ç»å­˜åœ¨äº†ï¼Œç›´æŽ¥è¿”å›žå³å¯ windowStart &gt; old.windowStart() ä»£è¡¨æ•°ç»„ä¸­çš„å…ƒç´ å·²ç»è‡³å°‘æ˜¯ 25s ä¹‹å‰çš„äº†ï¼Œé‡ç½®å½“å‰çª—å£çš„ windowStart å’Œ è®¡æ•°å™¨ï¼Œè¿™ä¸ªæ“ä½œåŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨äº† updateLock.tryLock()ã€‚ ä»”ç»†çœ‹äº†ä»£ç åŽï¼Œæˆ‘æå‡ºäº†ä¸€ä¸ªé—®é¢˜ã€‚æˆ‘è§‰å¾—è¿™ä¸ªåœ°æ–¹å¹¶ä¸èƒ½ä¸€å®šä¿è¯èƒ½é”ä½ã€‚ä¼šä¸ä¼šå‡ºçŽ°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åˆ¤æ–­éœ€è¦æ›´æ–°ï¼Œç”±äºŽä¸€ä¸ªçº¿ç¨‹å¾ˆå¿«æ‰§è¡ŒæˆåŠŸå¹¶é‡Šæ”¾äº†é”ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ä¹ŸæˆåŠŸèŽ·å–åˆ° Lockï¼Œä¼šæ‰§è¡Œå¤šæ¬¡ resetWindowã€‚æˆ‘è®¤ä¸ºéœ€è¦å† tryLock ä¹‹åŽå†åˆ¤æ–­ä¸€ä¸‹æ‰§è¡Œæ¡ä»¶ï¼Œç›®å‰å·²ç»ç»™ Sentinel æäº¤äº† Issue windowStart &lt; old.windowStart() é€šå¸¸æƒ…å†µä¸‹ä¸ä¼šèµ°åˆ°è¿™ä¸ªé€»è¾‘åˆ†æ”¯ï¼Œä¸Šé¢æºç çš„æ³¨é‡Šä¹Ÿæ˜¯è¿™æ ·è§£é‡Šçš„ LeapArray#valuesä¸Šæ–‡ä¸­æåˆ°è¿‡ï¼Œè®¡ç®—æµé‡æ—¶å…·ä½“ä½¿ç”¨å‡ ä¸ªçª—å£ï¼Œå–å†³äºŽçª—å£å¤§å°å’Œå•ä½æ—¶é—´å¤§å° è¯¥æ–¹æ³•çš„ä½œç”¨é€šè¿‡ä¼ å…¥ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œæ‰¾å‡ºæœ¬æ¬¡è®¡ç®—æ‰€éœ€çš„æ‰€æœ‰æ—¶é—´çª—å£ 123456789101112131415161718192021 public List&lt;T&gt; values(long timeMillis) &#123; if (timeMillis &lt; 0) &#123; return new ArrayList&lt;T&gt;(); &#125; int size = array.length(); List&lt;T&gt; result = new ArrayList&lt;T&gt;(size); for (int i = 0; i &lt; size; i++) &#123; WindowWrap&lt;T&gt; windowWrap = array.get(i); if (windowWrap == null || isWindowDeprecated(timeMillis, windowWrap)) &#123; continue; &#125; result.add(windowWrap.value()); &#125; return result; &#125; public boolean isWindowDeprecated(long time, WindowWrap&lt;T&gt; windowWrap) &#123;// intervalInMs åœ¨å•æœºé™æµè®¡ç®—QPSæ—¶é»˜è®¤ä¸º 1000(ms) return time - windowWrap.windowStart() &gt; intervalInMs; &#125; values çš„é€»è¾‘æ²¡ä»€ä¹ˆå¯è¯´çš„ï¼ŒéåŽ†æ•°ç»„å°†æ—¶é—´ç¬¦åˆçš„çª—å£åŠ å…¥åˆ° List ä¸­ é‡ç‚¹çœ‹ä¸€ä¸‹ isWindowDeprecated è¿™ä¸ªæ–¹æ³• è¿˜æ˜¯åƒä¸Šé¢é‚£æ ·æŠŠæ•°å€¼å¸¦è¿›åŽ»ã€‚æ¯ä¸ªçª—å£å¤§å°ä¸º 500 msï¼Œä¾‹å¦‚ timestamp ä¸º 1601ï¼Œè¿™ä¸ª timestamp å¯¹åº”çš„ windowStart ä¸º 1500ï¼Œæ­¤æ—¶ (1601 - 1500 &gt; 1000) = false å³è¿™ä¸ªçª—å£æ˜¯æœ‰æ•ˆçš„ï¼Œå†å¾€å‰æŽ¨ç®—ï¼Œä¸Šä¸€ä¸ªçª—å£ windowStart ä¸º 1000 ä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚å†å¾€å‰æŽ¨ç®—ï¼Œæˆ–è€…å‘åŽæŽ¨ç®—éƒ½æ˜¯æ— æ•ˆçš„çª—å£ã€‚ intervalInMs æˆ‘æ˜¯è¿™æ ·ç†è§£çš„ï¼Œä»¥å¤šé•¿çš„æ—¶é—´æ®µä½œä¸ºå•ä½æ—¶é—´æ¥é™æµã€‚å³å¯ä»¥ä»¥ 1s ä¸ºä¸€ä¸ªæ—¶é—´æ®µæ¥åšé™æµï¼Œä¹Ÿå¯ä»¥ä»¥ 60s ä¸ºä¸€ä¸ªæ—¶é—´æ®µæ¥é™æµã€‚ Sentinel é™æµæ€è·¯åœ¨ç†è§£äº† LeapArray#currentWindow å’Œ LeapArray#values æ–¹æ³•çš„ç»†èŠ‚ä¹‹åŽï¼Œå…¶å®žæˆ‘ä»¬å°±å¯ä»¥ç¢ç£¨å‡ºé™æµçš„å®žçŽ°æ€è·¯äº† é¦–å…ˆæ ¹æ®å½“å‰æ—¶é—´æˆ³ï¼Œæ‰¾åˆ°å¯¹åº”çš„å‡ ä¸ª windowï¼Œæ ¹æ® æ‰€æœ‰ window ä¸­çš„æµé‡æ€»å’Œ + å½“å‰ç”³è¯·çš„æµé‡æ•° å†³å®šèƒ½å¦é€šè¿‡ å¦‚æžœä¸èƒ½é€šè¿‡ï¼ŒæŠ›å‡ºå¼‚å¸¸ å¦‚æžœèƒ½é€šè¿‡ï¼Œåˆ™å¯¹åº”çš„çª—å£åŠ ä¸Šæœ¬æ¬¡é€šè¿‡çš„æµé‡æ•° Sentinel é™æµå®žçŽ°Sentinel åŸºæœ¬ä¹Ÿæ˜¯è¿™ä¸ªæ€è·¯ï¼Œåªä¸è¿‡é€»è¾‘å¤æ‚ä¸€äº›ï¼Œè¿™é‡Œè´´å‡ºå‡ å¤„ä»£ç ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·± debug ä¸€ä¸‹ Sentinel é™æµæ£€æŸ¥æ ¹æ® Sentinel æ–‡æ¡£ä¸­çš„è§£é‡Šï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è´Ÿè´£é™æµçš„ç±»ä¸º FlowSlotï¼ŒFlowSlot ä¼šä½¿ç”¨ FlowRuleChecker æ¥æ£€æŸ¥å½“å‰èµ„æºæ˜¯å¦éœ€è¦é™æµ FlowSlot#entry FlowRuleChecker#checkFlow æ ¹æ® FlowRule çš„è®¾å®šæ¥åšé™æµæ£€æŸ¥ï¼Œè¿™ä¸­é—´æˆ‘çœç•¥äº†å‡ æ®µä»£ç ï¼Œé»˜è®¤æƒ…å†µæ²¡æœ‰è®¾ç½® ControlBehavior ä¼šä½¿ç”¨ DefaultController#canPass åšé™æµæ£€æŸ¥ã€‚å¦‚ä¸‹å›¾ï¼Œé€šè¿‡åˆ¤æ–­ å½“å‰æµé‡æ•° + ç”³è¯·çš„æ•°é‡ æ˜¯å¦å¤§äºŽé¢„è®¾çš„æ•°é‡ï¼Œæ¥å†³å®šæ˜¯å¦é™æµ æ³¨ï¼šå½“ä½¿ç”¨ SphU.entry æ—¶ prioritized = falseï¼Œä½¿ç”¨ SphU.entryWithPriority æ—¶ prioritized = trueã€‚node.tryOccupyNext çš„å«ä¹‰ï¼šå¦‚æžœæƒ³å ç”¨æœªæ¥çš„æ—¶é—´çª—å£ä»¤ç‰Œï¼Œéœ€è¦ç­‰å¾…å¤šä¹…ï¼ˆä¸Šå›¾ä¸­çš„waitInMsï¼‰ã€‚å¦‚æžœå°äºŽè§„å®šçš„è¶…æ—¶æ—¶é—´ï¼Œåˆ™è®°å½•æ­£åœ¨ç­‰å¾…çš„è¯·æ±‚æ•°ï¼Œç„¶åŽæ‰§è¡Œ sleep(waitInMs)ï¼Œå¤–å±‚æ•èŽ·åˆ° PriorityWaitException ä¼šè‡ªå·±å¤„ç†æŽ‰ï¼Œç„¶åŽæ‰§è¡Œç”¨æˆ·é€»è¾‘ï¼Œç”¨æˆ·å®Œå…¨æ— æ„ŸçŸ¥ã€‚ é€šè¿‡ä¸Šå›¾ avgUsedTokens å¯ä»¥çœ‹åˆ°ï¼Œå½“ Rule çš„ grade ä¸º FLOW_GRADE_QPS æ—¶ï¼Œä¼šè°ƒç”¨ node.pass()ã€‚è¿™é‡Œè°ƒç”¨çš„å…·ä½“å®žçŽ°ä¸º StatisticNode#passQpsï¼Œå¦‚ä¸‹å›¾ rollingCounterInSecond.getWindowIntervalInSec() è®¡ç®— QPS æ—¶ä¸º 1 ç§’ rollingCounterInSecond.pass() è®¡ç®— QPS æ—¶ï¼Œæœ€å¤šè¿”å›žä¸¤ä¸ªçª—å£çš„é€šè¿‡è¯·æ±‚æ•°ï¼ˆcurrentWindow + lastWindowï¼‰ rollingCounterInSecond#pass é¦–å…ˆå…ˆå°è¯•æ˜¯å¦éœ€è¦åˆ›å»ºå½“å‰çš„æ—¶é—´çª—å£ï¼Œç„¶åŽæ‰¾åˆ°ç›¸å…³çš„çª—å£ï¼Œè®¡ç®—æµé‡æ€»å’Œã€‚ Sentinel è¯·æ±‚è®°å½•ä»£ç ä½ç½® StatisticSlot#entryï¼ŒfireEntry ä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„è§„åˆ™è¿›è¡Œæ£€æŸ¥ï¼ˆä¾‹å¦‚ä¸Šè¿°çš„é™æµï¼‰ã€‚ å¦‚æžœæ£€æŸ¥æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™è®°å½•çº¿ç¨‹æ•°å’Œç”³è¯·çš„è¯·æ±‚æ•°ï¼ˆé™æµæ£€æŸ¥ä¾èµ–çš„æ•°æ®å°±æ˜¯è¿™é‡Œè®°å½•çš„ï¼‰ã€‚ é›†ç¾¤é™æµé›†ç¾¤é™æµæœ‰ä»€ä¹ˆç”¨åœ¨æ²¡æœ‰é›†ç¾¤é™æµä¹‹å‰ï¼Œå¦‚æžœæƒ³æŠŠæ•´ä¸ªæœåŠ¡çš„ QPS é™åˆ¶åœ¨æŸä¸ªå€¼ã€‚ä¸¾ä¸ªä¾‹å­çŽ°åœ¨æŸ Server æœ‰åä¸ªå®žä¾‹ï¼Œæˆ‘ä»¬å¸Œæœ›æ€» QPS ä¸è¶…è¿‡ 100ï¼Œè¿™æ—¶æˆ‘ä»¬çš„åšæ³•æ˜¯æŠŠæ¯ä¸ªå®žä¾‹çš„ QPS è®¾ç½®ä¸º 10ã€‚ åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™æ ·åšå¯ä»¥å°† QPS æŽ§åˆ¶åœ¨ 100ã€‚ä½†æ˜¯å¦‚æžœæ¯å° Server åˆ†é…åˆ°çš„æµé‡ä¸å‡åŒ€ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´æ€»é‡åœ¨æ²¡è¾¾åˆ° 100 çš„æ—¶å€™ï¼ŒæŸäº› Server å°±å¼€å§‹é™æµäº†ã€‚ è¿™ç§æƒ…å†µå°±éœ€è¦ Sentinel çš„é›†ç¾¤é™æµå‡ºåœºäº†ã€‚ é›†ç¾¤é™æµåŽŸç†ç”±äºŽç¯‡å¹…é™åˆ¶ï¼Œæˆ‘ä»¬è¿™é‡Œä¸è®¨è®ºå¦‚ä½•æ­å»ºé›†ç¾¤é™æµï¼Œåªæ˜¯æ¥è¯´è¯´ Sentinel å¦‚ä½•åœ¨è¿™ä¸€åŸºç¡€ä¸Šåšçš„é›†ç¾¤é™æµã€‚ æ€è·¯å¾ˆç®€å•ï¼Œé€‰å‡ºä¸€ä¸ª Token Serverã€‚åœ¨å¼€å¯é›†ç¾¤é™æµåŽï¼Œæ‰€æœ‰çš„ Client åœ¨éœ€è¦é™æµæ—¶ï¼Œè¯¢é—® Token Serverï¼ŒServer å†³å®šå½“å‰è¯·æ±‚æ˜¯å¦é™æµã€‚å…·ä½“çš„å®žçŽ°ç»†èŠ‚ä¸Žå•æœºé™æµç•¥æœ‰ä¸åŒï¼Œä½†æ˜¯æ ¸å¿ƒçš„ç®—æ³•è¿˜æ˜¯ä½¿ç”¨çš„ LeapArray è¿™é‡Œä¹Ÿæ˜¯ç»™å‡ºå‡ å¤„æºç ä½ç½®ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è‡ªè¡Œé˜…è¯»ä¸€ä¸‹ Client ç«¯æ ¹æ® Rule å†³å®šæœ¬æ¬¡ä½¿ç”¨æœ¬åœ°é™æµè¿˜æ˜¯é›†ç¾¤é™æµï¼ŒFlowRuleChecker#canPassCheck Server ç«¯ï¼ŒDefaultTokenService#requestToken å¹¶å‘ä¸‹é™æµçš„é—®é¢˜åœ¨å®Œæ•´çš„é˜…è¯»å®Œå•æœºå’Œé›†ç¾¤çš„é™æµä»£ç ä¹‹åŽï¼Œå‘çŽ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œé™æµæµç¨‹å¯ä»¥ç®€åŒ–ä¸ºå¦‚ä¸‹1234567891011121314// ä¼ªä»£ç // æœ€å¤§QPSint maxCount;// å½“å‰ç”³è¯·çš„æµé‡æ•°int aquireCount;int passQps = getPassQPS();if (passQps + aquireCount &lt;= maxCount) &#123; addPass(aquireCount);&#125; else &#123; // é™æµå¤„ç†&#125; ç”±äºŽæ²¡æœ‰å¹¶å‘æŽ§åˆ¶ï¼Œå¹¶å‘åœºæ™¯ä¸‹ä¼šå‡ºçŽ°ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶æ»¡è¶³ passQps + aquireCount &lt;= maxCountï¼Œç„¶åŽå¢žåŠ æµé‡ç»Ÿè®¡ï¼Œè¿™æ ·çš„è¯ï¼Œæ²¡æ³•ä¿è¯ä¸€å®šå°† QPS æŽ§åˆ¶åœ¨ maxCountï¼Œå¹¶å‘çš„æƒ…å†µä¸‹ä¼šå‡ºçŽ°å®žé™…æµé‡è¶…å‡ºé¢„è®¾ QPS çš„æƒ…å†µã€‚ è¿™è‚¯å®šä¸æ˜¯ä¸ªBugã€‚è¿™é‡Œæ²¡æœ‰å¹¶å‘æŽ§åˆ¶å¯èƒ½æ˜¯å‡ºäºŽæ€§èƒ½è€ƒè™‘ï¼Œåœ¨æ€§èƒ½å’Œå‡†ç¡®åº¦å¯ä»¥æŽ¥å—çš„æƒ…å†µä¸‹åšäº†ä¸€ä¸ªæŠ˜ä¸­ æ‰€ä»¥åœ¨ä½¿ç”¨æ—¶ï¼Œå¦‚æžœå®žé™… QPS é«˜äºŽé¢„è®¾å€¼ï¼Œå¯èƒ½æ˜¯å¹¶å‘å¯¼è‡´çš„ demo å•æœºé™æµï¼š https://github.com/TavenYin/taven-springcloud-learning/blob/master/sentinel-example/src/main/java/com/github/taven/limit/SentinelExample.java é›†ç¾¤é™æµï¼šhttps://github.com/TavenYin/taven-springcloud-learning/blob/master/sentinel-example/src/main/java/com/github/taven/limit/SentinelClusterEmbedded.java]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>æºç </tag>
        <tag>åˆ†å¸ƒå¼</tag>
        <tag>Sentinel</tag>
        <tag>é™æµ</tag>
        <tag>å¾®æœåŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[èŠèŠ Java GC ç®—æ³•]]></title>
    <url>%2Fpost%2F1e4a5faa.html</url>
    <content type="text"><![CDATA[Java å’Œ C++ ä¹‹é—´æœ‰ä¸€å µç”±å†…å­˜åŠ¨æ€åˆ†é…å’Œåžƒåœ¾å›žæ”¶æŠ€æœ¯æ‰€å›´æˆçš„é«˜å¢™ï¼Œå¢™å¤–é¢çš„äººæƒ³è¿›åŽ»ï¼Œå¢™é‡Œé¢çš„äººå´æƒ³å‡ºæ¥ ä»Šå¤©æ¥èŠèŠ Java GCï¼ˆGarbage Collectionï¼Œåžƒåœ¾å›žæ”¶ï¼‰ä¸­çš„å¸¸è§ç®—æ³• å¼•ç”¨ä¸ŽGCçš„å…³ç³»æ­£é¢˜å¼€å§‹å‰ï¼Œå…ˆæ¥äº†è§£ä¸€ä¸‹ Java ä¸­çš„å¼•ç”¨ã€‚å¯¹è±¡ä½¿ç”¨ä¸åŒçš„å¼•ç”¨ç±»åž‹ï¼Œå†³å®š GC å‘ç”Ÿæ—¶æ˜¯å¦ä¼šå›žæ”¶å®ƒ å¼•ç”¨ç±»åž‹ ç‰¹ç‚¹ å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰ Javaä¸­çš„é»˜è®¤å¼•ç”¨ç±»åž‹ã€‚ä¾‹å¦‚Object obj = new Object()ï¼Œåªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡æ°¸è¿œä¸ä¼šè¢«å›žæ”¶ è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰ å†…å­˜è¶³å¤Ÿæ—¶ï¼Œè½¯å¼•ç”¨ä¸ä¼šè¢«å›žæ”¶ã€‚åªæœ‰å½“ç³»ç»Ÿè¦å‘ç”Ÿå†…å­˜æº¢å‡ºæ—¶ï¼Œæ‰ä¼šè¢«å›žæ”¶ã€‚é€‚åˆç”¨äºŽç¼“å­˜åœºæ™¯ å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰ åªè¦å‘ç”Ÿåžƒåœ¾å›žæ”¶ï¼Œå¼±å¼•ç”¨çš„å¯¹è±¡å°±ä¼šè¢«å›žæ”¶ è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰ ä¸€ä¸ªå¯¹è±¡æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ä¸ä¼šå¯¹ç”Ÿå­˜æ—¶é—´éƒ½æž„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥èŽ·å–å¯¹ä¸€ä¸ªå¯¹è±¡çš„çœŸå®žå¼•ç”¨ã€‚å”¯ä¸€çš„ç”¨å¤„ï¼šèƒ½åœ¨å¯¹è±¡è¢«GCæ—¶æ”¶åˆ°ç³»ç»Ÿé€šçŸ¥ å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›žæ”¶ï¼Ÿåœ¨GCå¼€å§‹ä¹‹å‰ï¼Œé¦–å…ˆè¦åšçš„äº‹å°±æ˜¯ç¡®å®šå“ªäº›å¯¹è±¡ã€Žæ´»ç€ã€ï¼Œå“ªäº›å¯¹è±¡ã€Žå·²æ­»ã€ å¸¸è§çš„ä¸¤ç§ç®—æ³•ç”¨äºŽåˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›žæ”¶ å¼•ç”¨è®¡æ•°ç®—æ³•ï¼šæ¯ä¸ªå¯¹è±¡ä¸­æ·»åŠ å¼•ç”¨è®¡æ•°å™¨ã€‚æ¯å½“å¯¹è±¡è¢«å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°å™¨å°±ä¼šåŠ  1ï¼›æ¯å½“å¼•ç”¨å¤±æ•ˆï¼Œè®¡æ•°å™¨å°±ä¼šå‡ 1ã€‚å½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨çš„å€¼ä¸º 0 æ—¶ï¼Œå°±è¯´æ˜Žè¯¥å¯¹è±¡ä¸å†è¢«å¼•ç”¨ï¼Œå¯ä»¥è¢«å›žæ”¶äº†ã€‚å¼ºè°ƒä¸€ç‚¹ï¼Œè™½ç„¶å¼•ç”¨è®¡æ•°ç®—æ³•çš„å®žçŽ°ç®€å•ï¼Œåˆ¤æ–­æ•ˆçŽ‡ä¹Ÿå¾ˆé«˜ï¼Œä½†å®ƒå­˜åœ¨ç€å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªçŽ¯å¼•ç”¨çš„é—®é¢˜ï¼ˆæ‰€ä»¥åœ¨åŽæ¥çš„JVMç‰ˆæœ¬ä¸­å·²ç»ä¸é‡‡ç”¨è¿™ç§ç®—æ³•äº†ï¼‰ã€‚ å¯è¾¾æ€§åˆ†æžç®—æ³•ï¼šGC Roots æ˜¯è¯¥ç®—æ³•çš„åŸºç¡€ï¼ŒGC Roots æ˜¯æ‰€æœ‰å¯¹è±¡çš„æ ¹å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡ä½œä¸ºæ­£å¸¸å¯¹è±¡çš„èµ·å§‹ç‚¹ï¼Œåœ¨åžƒåœ¾å›žæ”¶æ—¶ï¼Œä¼šä»Žè¿™äº› GC Roots å¼€å§‹å‘ä¸‹æœç´¢ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ° GC Roots æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿žæ—¶ï¼Œå°±è¯æ˜Žæ­¤å¯¹è±¡ä¸å†è¢«å¼•ç”¨ã€‚ç›®å‰ HotSpot è™šæ‹Ÿæœºé‡‡ç”¨çš„å°±æ˜¯è¿™ç§ç®—æ³•ã€‚ å¯ä»¥ä½œä¸º GC Roots çš„å¯¹è±¡ï¼š è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­ç±»é™æ€å±žæ€§å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNIï¼ˆNative æ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡ Java è™šæ‹Ÿæœºä¸­å†…éƒ¨çš„å¼•ç”¨ synchronized æŒæœ‰çš„å¯¹è±¡ JMXBeanã€JVMTI ä¸­æ³¨å†Œçš„å›žè°ƒã€æœ¬åœ°ä»£ç ç¼“å­˜ é™¤æ­¤ä¹‹å¤–ï¼Œä¸åŒçš„åžƒåœ¾å›žæ”¶å™¨å¯èƒ½è¿˜ä¼šåŠ å…¥ä¸€äº›ã€Žä¸´æ—¶çš„ã€å¯¹è±¡å…±åŒæž„å»º GC Roots åŸºç¡€çš„ GC ç®—æ³•æ ‡è®°-æ¸…é™¤ç®—æ³• ï¼ˆmark-sweepï¼‰å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¯¥ç®—æ³•åˆ†ä¸ºã€Žæ ‡è®°ã€å’Œã€Žæ¸…é™¤ã€ä¸¤ä¸ªé˜¶æ®µ ä»Ž GC Roots å‡ºå‘æ ‡è®°å‡ºå­˜æ´»çš„å¯¹è±¡ï¼Œç„¶åŽéåŽ†å †æ¸…é™¤æœªè¢«æ ‡è®°çš„å¯¹è±¡ æœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•ï¼Œæ ‡è®°-æ¸…é™¤çš„æ•ˆçŽ‡ä¸­ç­‰ï¼Œç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜Žæ˜¾ï¼šä¼šäº§ç”Ÿå†…å­˜ç¢Žç‰‡ å¤åˆ¶ç®—æ³•ï¼ˆcopyingï¼‰å°†å¯ç”¨å†…å­˜æŒ‰å®¹é‡åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚å½“è¿™ä¸€å—å†…å­˜ç”¨å®Œï¼Œéœ€è¦è¿›è¡Œåžƒåœ¾æ”¶é›†æ—¶ï¼Œå°±å°†å­˜æ´»è€…çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—ä¸Šé¢ï¼Œç„¶åŽå°†ç¬¬ä¸€å—å†…å­˜å…¨éƒ¨æ¸…é™¤ ç›¸æ¯”è¾ƒã€Žæ ‡è®°-æ¸…é™¤ã€ä¸ä¼šæœ‰å†…å­˜ç¢Žç‰‡çš„é—®é¢˜ï¼Œä½†æ¯æ¬¡åªä½¿ç”¨ä¸€åŠçš„å†…å­˜ï¼Œå†…å­˜åˆ©ç”¨çŽ‡å¾ˆä½Žã€‚å½“å†…å­˜ä¸­å­˜æ´»çš„å¯¹è±¡è¾ƒå¤šæ—¶ï¼Œä¼šè¿›è¡Œå¤§é‡çš„å¤åˆ¶æ“ä½œï¼Œæ•ˆçŽ‡ä¼šè¾ƒä½Žï¼ˆå¯¹è±¡çš„å¤åˆ¶ä¹Ÿæ˜¯æœ‰æˆæœ¬çš„ï¼Œéœ€è¦å¤åˆ¶çš„å¯¹è±¡è¶Šå¤šã€è¶Šå¤§ï¼Œå¤åˆ¶å¸¦æ¥çš„ä»£ä»·ä¹Ÿå°±è¶Šå¤§ï¼‰ã€‚é€‚ç”¨äºŽå­˜æ´»çŽ‡ä½Žçš„æƒ…å†µ æ ‡è®°-æ•´ç†ç®—æ³•ï¼ˆmark-compactï¼‰å’Œã€Žæ ‡è®°-æ¸…é™¤ã€ç®—æ³•æœ‰ç‚¹ç±»ä¼¼ï¼Œä»Ž GC Roots å‡ºå‘æ ‡è®°å‡ºå­˜æ´»çš„å¯¹è±¡ï¼Œç„¶åŽæ˜¯æ•´ç†é˜¶æ®µï¼Œå°†å­˜æ´»ç§»åŠ¨åˆ°ä¸€ç«¯ã€‚æ•´ç†é˜¶æ®µç»“æŸåŽæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸€ä¸ªä¸´ç•Œç‚¹ï¼Œå¦ä¸€ç«¯çš„å†…å­˜ç©ºé—´å°±å¯ä»¥è¢«é‡æ–°åˆ†é…äº† è¯¥ç®—æ³•çš„ä¼˜ç‚¹ï¼šä¸åƒå¤åˆ¶ç®—æ³•é‚£æ ·ä¼šæµªè´¹å†…å­˜ç©ºé—´ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿå†…å­˜ç¢Žç‰‡ã€‚ å†™åˆ°è¿™æ—¶ï¼Œæˆ‘å¾ˆæƒ³çŸ¥é“ã€Žæ ‡è®°-æ•´ç†ã€çš„æ•ˆçŽ‡å¦‚ä½•ã€‚ä¸€ç•ªæœç´¢åŽï¼Œå‘çŽ°è¯¥ç®—æ³•æ˜¯è¿™ä¸‰ç§ç®—æ³•ä¸­æ•ˆçŽ‡æœ€ä½Žçš„ï¼Œå› ä¸ºã€Žæ•´ç†ã€è¿™ä¸ªè¿‡ç¨‹ä¼šéåŽ†æ•´ä¸ªå †ä¸‰æ¬¡ï¼Œå…·ä½“å®žçŽ°æ€è·¯å¦‚ä¸‹ ã€Žæ ‡è®°-æ•´ç†ã€ä»¥ lisp2 ç®—æ³•ä¸ºä¾‹ï¼Œå®žçŽ°æ€è·¯å¦‚ä¸‹ æ ‡è®°é˜¶æ®µï¼šé¦–å…ˆä»Ž GC Roots å‡ºå‘ï¼Œæ ‡è®°å‡ºæ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ è®¾ç½® forwarding æŒ‡é’ˆï¼šæ¯ä¸ªå¯¹è±¡å¤´ä¸­éƒ½æœ‰ä¸€ä¸ªforwardingæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥å¯¹è±¡æ•´ç†åŽçš„ä½ç½®ã€‚éåŽ†æ•´ä¸ªå †è®¡ç®—å­˜æ´»å¯¹è±¡çš„ forwarding æ›´æ–°æŒ‡é’ˆï¼šéåŽ†æ•´ä¸ªå †ï¼Œæ ¹æ® forwarding æ›´æ–° GC Roots æŒ‡é’ˆä»¥åŠæ‰€æœ‰å­˜æ´»å¯¹è±¡çš„å­å¯¹è±¡çš„æŒ‡é’ˆï¼Œå°†æŒ‡é’ˆæŒ‡å‘æ–°çš„ä½ç½® ç§»åŠ¨å¯¹è±¡ï¼šéåŽ†æ•´ä¸ªå †ï¼Œæ ¹æ® forwarding ç§»åŠ¨å¯¹è±¡å¹¶ä¸”æ¸…é™¤å¯¹è±¡ä¸­çš„æ ‡è®° èŠèŠæˆ‘ä¸ªäººçš„ç†è§£ï¼Œä¸ºä»€ä¹ˆ2,3,4ä¸€å®šè¦éåŽ†æ•´ä¸ªå †ï¼Ÿéƒ½æ˜¯é’ˆå¯¹å­˜æ´»å¯¹è±¡çš„æ“ä½œï¼Œç›´æŽ¥éåŽ† GC Roots ä¸è¡Œå—ï¼Ÿ è®¾ç½® forwarding é˜¶æ®µï¼šä¸€å®šè¦é¡ºåºéåŽ†æ•´ä¸ªå †ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æžœä»…æ˜¯éåŽ† GC Roots çš„è¯ï¼Œä½ æ²¡æ³•çŸ¥é“Aè¿™ä¸ªåŒºåŸŸæ˜¯å¦å¯ä»¥è¦†ç›– æ›´æ–°æŒ‡é’ˆé˜¶æ®µï¼šæˆ‘è§‰å¾—è¿™ä¸ªé˜¶æ®µä»…éåŽ† GC Roots çš„è¯ï¼Œç¡®å®žå¯è¡Œ ç§»åŠ¨å¯¹è±¡é˜¶æ®µï¼šç”±äºŽ GC Roots æŒ‡é’ˆå·²ç»å…¨éƒ¨æŒ‡å‘æ–°çš„ä½ç½®äº†ï¼Œåªèƒ½éåŽ†æ•´ä¸ªå † å†™åˆ°è¿™ï¼Œæˆ‘åˆæƒ³ä¸ºä»€ä¹ˆä¸€å®šè¦ä¸‰ä¸ªæ­¥éª¤æžè¿™ä¹ˆå¤æ‚ï¼Œç›´æŽ¥ç§»åŠ¨å¯¹è±¡ä¸è¡Œå—ï¼Ÿ æ ¹æ®ä¸Šé¢çš„ç†è§£ï¼Œä¸€å®šè¦éåŽ†æ•´ä¸ªå †æ¥ç¡®å®šå­˜æ´»çš„å¯¹è±¡è¯¥ç§»åŠ¨åˆ°å“ªã€‚å°±çŽ°æœ‰çš„ç»“æž„æ¥çœ‹ï¼Œå¦‚æžœç›´æŽ¥ç§»åŠ¨ï¼Œå­å¯¹è±¡çš„æŒ‡é’ˆè¿˜å¥½è¯´å¯ä»¥å¤„ç†ï¼ŒGC Roots ä¸­çš„æŒ‡é’ˆå°±æ²¡æ³•æ›´æ–°äº† å…³äºŽlisp2 å®žçŽ°çš„æ›´å¤šç»†èŠ‚å¯ä»¥å‚è€ƒä¸‹è¿™ç¯‡Blog ã€Žgc-æ ‡è®°æ•´ç†ç®—æ³•çš„ä¸¤ç§å®žçŽ°ã€ å°ç»“æ€»ç»“ä¸‹ä¸Šè¿°ä¸‰ç§åŸºç¡€GCç®—æ³•çš„ä¼˜ç¼ºç‚¹ ç»´åº¦ æ ‡è®°-æ¸…é™¤ æ ‡è®°-æ•´ç† å¤åˆ¶ç®—æ³• é€Ÿåº¦ ä¸­ç­‰ æœ€æ…¢ æœ€å¿« æ—¶é—´å¼€é”€ marké˜¶æ®µä¸Žå­˜æ´»å¯¹è±¡çš„æ•°é‡æˆæ­£æ¯”ï¼Œsweepé˜¶æ®µä¸Žæ•´å †å¤§å°æˆæ­£æ¯” marké˜¶æ®µä¸Žå­˜æ´»å¯¹è±¡çš„æ•°é‡æˆæ­£æ¯”ï¼Œcompacté˜¶æ®µä¸Žæ•´å †å¤§å°æˆæ­£æ¯”ï¼Œä¸Žå­˜æ´»å¯¹è±¡çš„å¤§å°æˆæ­£æ¯” ä¸Žå­˜æ´»å¯¹è±¡å¤§å°æˆæ­£æ¯” ç©ºé—´å¼€é”€ å°‘ï¼ˆä½†ä¼šå †ç§¯ç¢Žç‰‡ï¼‰ å°‘ï¼ˆä¸å †ç§¯ç¢Žç‰‡ï¼‰ é€šå¸¸éœ€è¦å­˜æ´»å¯¹è±¡çš„2å€å¤§å°ï¼ˆä¸å †ç§¯ç¢Žç‰‡ï¼‰ ç§»åŠ¨å¯¹è±¡ å¦ æ˜¯ æ˜¯ åˆ†ä»£å›žæ”¶ç†è®ºåžƒåœ¾å›žæ”¶å™¨éƒ½ä¸ä¼šåªé€‰æ‹©ä¸€ç§ç®—æ³•ï¼ŒJVMæ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒï¼Œå°†å†…å­˜åˆ’åˆ†ä¸ºå‡ å—ã€‚ä¸€èˆ¬æ˜¯æŠŠå †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œæ ¹æ®å¹´ä»£çš„ç‰¹ç‚¹æ¥é€‰æ‹©æœ€ä½³çš„æ”¶é›†ç®—æ³•ã€‚ HotSpot ä¸­å¤§éƒ¨åˆ†åžƒåœ¾å›žæ”¶å™¨éƒ½é‡‡ç”¨åˆ†ä»£å›žæ”¶çš„æ€æƒ³ æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³• è€å¹´ä»£ï¼šæ ‡è®°-æ¸…é™¤ / æ ‡è®°-æ•´ç† / æˆ–è€…ä¸¤è€…åŒæ—¶ä½¿ç”¨ å †å¤§å°=æ–°ç”Ÿä»£+è€å¹´ä»£ï¼ˆé»˜è®¤åˆ†åˆ«å å †ç©ºé—´ä¸º1/3ã€2/3ï¼‰ï¼Œæ–°ç”Ÿä»£åˆè¢«åˆ†ä¸ºEdenã€from survivor (S0)ã€to survivor (S1)ï¼Œé»˜è®¤åˆ†é…æ¯”ä¾‹ä¸º 8:1:1 å¯¹è±¡çš„åˆ†é…å¯¹è±¡çš„åˆ†é…é€šå¸¸åœ¨ Eden ä¸­ï¼ˆéœ€è¦å¤§é‡è¿žç»­å†…å­˜ç©ºé—´çš„ Java å¯¹è±¡ï¼Œå¦‚å¾ˆé•¿çš„å­—ç¬¦ä¸²æˆ–æ•°æ®å¯ä»¥ç›´æŽ¥è¿›å…¥è€å¹´ä»£ï¼Œç”± -XX:PretenureSizeThreshold å†³å®šï¼‰ æ–°ç”Ÿä»£çš„å›žæ”¶å½“ Eden åŒºæ»¡åŽï¼Œä¼šè§¦å‘ Young GCï¼ˆæ–°ç”Ÿä»£å›žæ”¶ï¼‰ï¼Œå¤åˆ¶ Eden åŒºå’Œ S0 åŒºä¸­å­˜æ´»çš„å¯¹è±¡åˆ° S1 æˆ–è€…è€å¹´ä»£ï¼ˆå…¶ä¸­åˆ°è¾¾å¹´é¾„çš„ä¼šè¢«æ”¾å…¥è€å¹´ä»£ï¼Œæœªåˆ°è¾¾å¹´é¾„çš„æ”¾å…¥ S1 åŒºï¼‰ æ¯ç»åŽ†ä¸€æ¬¡ Young GCï¼Œsurvivor åŒºä¸­å¯¹è±¡å¹´é¾„ +1 ç„¶åŽæ¸…ç©º Eden åŒºå’Œ S0 åŒºï¼Œäº¤æ¢ S0 ä¸Ž S1 çš„åå­— è‹¥å­˜æ´»å¯¹è±¡å¤§äºŽ S1 åŒºå®¹é‡ï¼Œåˆ™ä¼šè¢«ç›´æŽ¥æ”¾å…¥è€å¹´ä»£ã€‚è‹¥æ‰“å¼€äº†è‡ªé€‚åº”ï¼ˆ-XX:+AdaptiveSizePolicyï¼‰ï¼ŒGCä¼šè‡ªåŠ¨é‡æ–°è°ƒæ•´æ–°ç”Ÿä»£å¤§å° è€å¹´ä»£çš„å›žæ”¶åœ¨å‘ç”Ÿ Full GC æˆ–è€… Old GC æ—¶ï¼Œä¼šæ ¹æ®ä¸åŒçš„åžƒåœ¾å›žæ”¶å™¨æˆ–è€…æƒ…å†µé€‰æ‹©ä½¿ç”¨ æ ‡è®°-æ¸…é™¤ / æ ‡è®°-æ•´ç† æ¥è¿›è¡Œå›žæ”¶ é™¤äº† Young GC ä¹‹å¤–ï¼Œå¸¸è§çš„è¿˜æœ‰ Full GCï¼ˆæ–°ç”Ÿä»£ã€è€ç”Ÿä»£ã€å…ƒç©ºé—´æˆ–æ°¸ä¹…ä»£çš„å›žæ”¶ï¼‰ Old GCï¼ˆåªæœ‰ CMS æœ‰è¿™ä¸ªæ¨¡å¼ï¼‰ Mixed GCï¼ˆåªæœ‰ G1 æœ‰è¿™ä¸ªæ¨¡å¼ï¼‰ é€šå¸¸æƒ…å†µä¸‹ Full GC çš„è§¦å‘æ¡ä»¶ï¼Œå½“å‡†å¤‡è¦è§¦å‘ä¸€æ¬¡ Young GCæ—¶ï¼Œå¦‚æžœå‘çŽ°ç»Ÿè®¡æ•°æ®è¯´ä¹‹å‰ Young GC çš„å¹³å‡æ™‹å‡å¤§å°æ¯”ç›®å‰è€å¹´ä»£å‰©ä½™çš„ç©ºé—´å¤§ï¼Œåˆ™ä¸ä¼šè§¦å‘ Young GC è€Œæ˜¯è½¬ä¸ºè§¦å‘ Full GC å°ç»“ç”±äºŽæ–°ç”Ÿä»£çš„ç‰¹ç‚¹æ˜¯å¤§å¤šæ•°å¯¹è±¡éƒ½æ˜¯ã€Œæœç”Ÿå¤•æ­»ã€çš„ï¼Œå­˜æ´»çŽ‡ä½Žï¼Œæ‰€ä»¥éžå¸¸é€‚åˆå¤åˆ¶ç®—æ³•ã€‚è€Œ survivor åŒºå­˜åœ¨çš„æ„ä¹‰æ˜¯ä¸ºäº†ç¡®ä¿ã€Œæœç”Ÿå¤•æ­»ã€çš„å¯¹è±¡ä¸ä¼šè½»æ˜“è¿›å…¥è€å¹´ä»£ï¼Œå½“å¯¹è±¡çš„å¹´é¾„æ»¡è¶³ï¼ˆç»åŽ†äº†å¤šæ¬¡ Young GCï¼‰æ‰ä¼šè¿›å…¥è€å¹´ä»£ã€‚ åˆåˆ°äº†æé—®çŽ¯èŠ‚ï¼Œä¸ºä»€ä¹ˆåˆ†ä»£å›žæ”¶ä¸­éœ€è¦æœ‰ä¸¤ä¸ª survivor åŒºï¼Œä¸€ä¸ªä¸è¡Œå—ï¼Ÿ ç­”æ¡ˆæ˜¯ä¸è¡Œã€‚å‡è®¾åªæœ‰ä¸€ä¸ª survivorï¼ŒEden å›žæ”¶åŽå­˜æ´»çš„å¯¹è±¡è¿›å…¥äº† survivorã€‚é‚£ä¹ˆ survivor åŒºå¯ä»¥è¢«å›žæ”¶çš„å¯¹è±¡è¯¥æ€Žä¹ˆå¤„ç†ï¼Ÿéš¾é“è¦ç”¨æ ‡è®°æ¸…é™¤å’Œæ ‡è®°æ•´ç†ï¼Ÿé‚£å¯å¤ªæ²¡æœ‰å¿…è¦äº†ï¼Œæ‰€ä»¥åˆ’åˆ†å‡ºä¸¤ä¸ª survivor åŒºï¼Œå°†æ–°ç”Ÿä»£çš„å¤åˆ¶ç®—æ³•è´¯å½»åˆ°åº• å‚è€ƒã€Žæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€ ã€Žæžå®¢æ—¶é—´ - Javaæ€§èƒ½è°ƒä¼˜å®žæˆ˜ã€ ã€ŽJava-GC åžƒåœ¾æ”¶é›†ç®—æ³•ã€ ã€Žgc-æ ‡è®°æ•´ç†ç®—æ³•çš„ä¸¤ç§å®žçŽ°ã€ ã€ŽMark-compact algorithm - Wikipediaã€ ã€Žä¸ºä»€ä¹ˆæ–°ç”Ÿä»£å†…å­˜éœ€è¦æœ‰ä¸¤ä¸ªSurvivoråŒºã€ ã€ŽMajor GCå’ŒFull GCçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿè§¦å‘æ¡ä»¶å‘¢ï¼Ÿ - RednaxelaFXçš„å›žç­” - çŸ¥ä¹Žã€ ã€Žå…³äºŽJVMåžƒåœ¾æœé›†ç®—æ³•ï¼ˆæ ‡è®°-æ•´ç†ç®—æ³•ä¸Žå¤åˆ¶ç®—æ³•ï¼‰çš„æ•ˆçŽ‡ï¼Ÿ - RednaxelaFXçš„å›žç­” - çŸ¥ä¹Žã€]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>JVM</tag>
        <tag>GC</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Oracle LogMiner æ•°æ®è¿ç§»å®žæˆ˜]]></title>
    <url>%2Fpost%2F82cb4508.html</url>
    <content type="text"><![CDATA[LogMiner æ˜¯ä»€ä¹ˆLogMiner æ˜¯Oracleå®˜æ–¹æä¾›çš„å·¥å…·ï¼Œå¯ä»¥è§£æž Redo log å’Œ Archived Redo log LogMiner å¯ä»¥åšä»€ä¹ˆï¼Ÿå®˜æ–¹æ–‡æ¡£ä¸­åˆ—ä¸¾äº†å¾ˆå¤šï¼Œå¤§å®¶å¯ä»¥è‡ªå·±åŽ»çœ‹ä¸‹ã€‚ æˆ‘ä»¬ç›®å‰çš„é¡¹ç›®åœ¨ä½¿ç”¨åŸºäºŽLogMiner çš„ Debezium Oracle Connector åšæ•°æ®è¿ç§» Oracle LogMiner æ•°æ®è¿ç§»çš„åŽŸç†æ˜¯ä»€ä¹ˆï¼Ÿé¦–å…ˆéœ€è¦äº†è§£å‡ ä¸ªæ¦‚å¿µï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹ Redo logï¼šRedoä¸­è®°å½•äº†æ‰€æœ‰å¯¹æ•°æ®å—çš„æ›´æ”¹ï¼ŒOralce è¦æ±‚è‡³å°‘æœ‰ä¸¤ä¸ªä»¥ä¸Šçš„Redo Log Group Archived Redo logï¼šå½“ä¸€ä¸ªRedo Log å†™æ»¡ä¹‹åŽï¼Œä¼šå‘ç”Ÿæ—¥å¿—åˆ‡æ¢ï¼Œæ•°æ®çš„æ›´æ”¹ä¼šè®°å½•åˆ°ä¸‹ä¸€ä¸ªRedo Logä¸­ï¼ˆæ‰€ä»¥ä¸€å®šè¦æœ‰ä¸¤ä¸ªä»¥ä¸Šçš„Redoï¼‰ã€‚å¦‚æžœå¼€å¯äº†å½’æ¡£æ¨¡å¼ï¼ŒOracle ä¼šå°†å†™æ»¡çš„Redo Log å½’æ¡£ã€‚ SCN (System Change Number)ï¼šOracle å†…éƒ¨é€»è¾‘æ—¶é—´æˆ³ Flashbackï¼šé€šè¿‡é—ªå›žæŸ¥è¯¢ SELECT ... AS OF SCN å¯ä»¥æŸ¥è¯¢OracleæŸä¸ªæ—¶é—´ç‚¹çš„å…¨é‡æ•°æ® æ€è·¯å¦‚ä¸‹ï¼š é¦–å…ˆæŸ¥è¯¢å‡ºä¸€ä¸‹å½“å‰çš„SCN æ ¹æ®SCN æŸ¥è¯¢å‡ºè¿™ä¸€æ—¶åˆ»çš„å…¨é‡æ•°æ® é€šè¿‡Logminer æŒ‡å®šStart_SCNï¼ŒèŽ·å–å¢žé‡æ•°æ® å®‰è£…ä¸Žé…ç½®æƒ³å°è¯•å´ä¸å¤ªç†Ÿæ‚‰Oracleçš„åŒå­¦ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹æˆ‘æ•´ç†çš„æ–‡æ¡£ Oralce Install (docker)ï¼š https://github.com/TavenYin/database-cdc/blob/master/doc/oracle/oracle-install.md Logminerï¼šhttps://github.com/TavenYin/database-cdc/blob/master/doc/oracle/oracle12c-logminer.md å°è¯•ç‰›åˆ€åœ¨å‡†å¤‡å¥½äº†çŽ¯å¢ƒä¹‹åŽï¼Œæˆ‘ä»¬æ¥å¼€ç®±ä½“éªŒä¸€ä¸‹Logminer logminer ç”¨æˆ·ç™»å½• conn c##logminer/password 1. æž„å»ºæ•°æ®å­—å…¸LogMinerä½¿ç”¨æ•°æ®å­—å…¸å°†å†…éƒ¨å¯¹è±¡æ ‡è¯†ç¬¦å’Œæ•°æ®ç±»åž‹è½¬æ¢ä¸ºæ­£å¸¸å­—æ®µå’Œæ•°æ®æ ¼å¼ 12345# è¿™æ˜¯ä¸€æ¡å¸¸è§„çš„SQL INSERT INTO HR.JOBS(JOB_ID, JOB_TITLE, MIN_SALARY, MAX_SALARY) VALUES(&apos;IT_WT&apos;,&apos;Technical Writer&apos;, 4000, 11000);# å¦‚æžœæ²¡æœ‰æ•°æ®å­—å…¸ï¼Œæ•°æ®ä¼šæ˜¯è¿™æ ·çš„insert into &quot;UNKNOWN&quot;.&quot;OBJ# 45522&quot;(&quot;COL 1&quot;,&quot;COL 2&quot;,&quot;COL 3&quot;,&quot;COL 4&quot;) values (HEXTORAW(&apos;45465f4748&apos;),HEXTORAW(&apos;546563686e6963616c20577269746572&apos;),HEXTORAW(&apos;c229&apos;),HEXTORAW(&apos;c3020b&apos;)); å®˜æ–¹æ–‡æ¡£ä¸­æåˆ°ä¸‰ç§æ–¹å¼ï¼š åœ¨çº¿æ•°æ®å­—å…¸ï¼šå½“ä½ å¯ä»¥è®¿é—®åˆ›å»ºRedoçš„æºæ•°æ®åº“å¹¶ä¸”è¡¨ç»“æž„ä¸ä¼šå‘ç”Ÿä»»ä½•å˜åŠ¨æ—¶ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨åœ¨çº¿æ•°æ®å­—å…¸ã€‚è¿™æ˜¯æœ€ç®€å•æœ‰æ•ˆçš„ï¼Œä¹Ÿæ˜¯Oracleçš„æŽ¨èé€‰é¡¹ç”±äºŽåœ¨çº¿æ•°æ®å­—å…¸æ°¸è¿œå­˜å‚¨çš„æ˜¯æœ€æ–°çš„ç»“æž„ã€‚å¦‚æžœå‘ç”Ÿäº†è¡¨ç»“æž„å˜åŠ¨ï¼ŒLogminer æ•èŽ·åˆ°æ—§ç‰ˆæœ¬çš„æ•°æ®ï¼ŒSQLå°†ä¼šå¦‚ä¸Šè¿°ä»£ç å—ä¸­é‚£æ · æå–æ•°æ®å­—å…¸åˆ°redoä¸­ï¼šéœ€è¦æ‰§è¡Œå‘½ä»¤BEGIN DBMS_LOGMNR_D.BUILD (options =&gt; DBMS_LOGMNR_D.STORE_IN_REDO_LOGS); END;è¯¥æ“ä½œä¼šå ç”¨ä¸€å®šæ•°æ®åº“èµ„æº æå–æ•°æ®å­—å…¸åˆ°Flat Fileï¼šOracleç»´æŠ¤è¯¥é€‰é¡¹æ˜¯ä¸ºäº†å…¼å®¹åŽ†å²ç‰ˆæœ¬ï¼Œæœ¬æ–‡å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°è¯¥æ–¹å¼ï¼Œä¸å¤šåšä»‹ç» LogMiner åœ¨å¯åŠ¨æ—¶ä¼šé€šè¿‡æŒ‡å®šçš„æ•°æ®å­—å…¸é€‰é¡¹ç»´æŠ¤ä¸€ä¸ªå†…éƒ¨æ•°æ®å­—å…¸ï¼Œå½“å¯åŠ¨LogMineræ—¶æŒ‡å®š DBMS_LOGMNR.DDL_DICT_TRACKINGï¼ŒLogMinerä¼šè‡ªåŠ¨æ•èŽ·DDLæ¥æ›´æ–°å†…éƒ¨å­—å…¸ï¼Œè¿™æ ·å³ä½¿å‘ç”Ÿäº†è¡¨ç»“æž„å˜åŠ¨æ—¶ï¼Œä¹Ÿå¯ä»¥æ­£ç¡®çš„è§£æžDDLã€‚æ³¨æ„ï¼šè¯¥é€‰é¡¹ä¸èƒ½å’Œåœ¨çº¿æ•°æ®å­—å…¸åŒæ—¶ä½¿ç”¨æ›´å¤šè§£é‡Šå‚è€ƒOracleæ–‡æ¡£ï¼šhttps://docs.oracle.com/en/database/oracle/oracle-database/12.2/sutil/oracle-logminer-utility.html#GUID-56743517-A0C0-4CCD-9D20-2883AFB5683B è¿™ä¸€æ­¥æˆ‘é€‰æ‹©åœ¨çº¿æ•°æ®å­—å…¸ï¼Œä»€ä¹ˆéƒ½ä¸ç”¨åšï¼Œç›´æŽ¥è¿›å…¥ä¸‹ä¸€æ­¥ 2. æ·»åŠ æ—¥å¿—æ–‡ä»¶12345678910111213141516171819# æŸ¥è¯¢ç›®å‰çš„redol ogSQL&gt; select member from v$logfile;MEMBER--------------------------------------------------------------------------------/opt/oracle/oradata/ORCLCDB/redo03.log/opt/oracle/oradata/ORCLCDB/redo02.log/opt/oracle/oradata/ORCLCDB/redo01.log# æ·»åŠ redo logSQL&gt; EXECUTE DBMS_LOGMNR.ADD_LOGFILE( - LOGFILENAME =&gt; &apos;/opt/oracle/oradata/ORCLCDB/redo03.log&apos;, - OPTIONS =&gt; DBMS_LOGMNR.NEW);EXECUTE DBMS_LOGMNR.ADD_LOGFILE( - LOGFILENAME =&gt; &apos;/opt/oracle/oradata/ORCLCDB/redo02.log&apos;, - OPTIONS =&gt; DBMS_LOGMNR.ADDFILE);EXECUTE DBMS_LOGMNR.ADD_LOGFILE( - LOGFILENAME =&gt; &apos;/opt/oracle/oradata/ORCLCDB/redo01.log&apos;, - OPTIONS =&gt; DBMS_LOGMNR.ADDFILE); 3. START_LOGMNR123# ä½¿ç”¨åœ¨çº¿æ•°æ®å­—å…¸è¿›è¡Œlogè§£æžSQL&gt; EXECUTE DBMS_LOGMNR.START_LOGMNR(-OPTIONS =&gt; DBMS_LOGMNR.DICT_FROM_ONLINE_CATALOG); ç„¶åŽæ‰§è¡Œä¸€æ¡INSERT 4. æŸ¥è¯¢ç»“æžœé€šè¿‡æŸ¥è¯¢V$LOGMNR_CONTENTS èŽ·å–LogMineræ•èŽ·çš„ç»“æžœã€‚å½“æ‰§è¡Œè¯¥è§†å›¾æŸ¥è¯¢æ—¶ï¼ŒLogMinerä¼šæŒ‰ç…§é¡ºåºè§£æžRedoå’ŒArchived Logï¼Œæ‰€æœ‰æ‰§è¡Œæ—¶é—´ä¼šæœ‰ä¸€ç‚¹æ…¢123SELECT OPERATION, SQL_REDO, SQL_UNDOFROM V$LOGMNR_CONTENTSWHERE table_name='TEST_TAB'; ç»“æžœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšåˆšINSERTçš„SQL å®žæˆ˜æˆ‘ä»¬å·²ç»çŸ¥é“äº†è¿ç§»çš„æ€è·¯å’ŒLogminerå¦‚ä½•ä½¿ç”¨ï¼ŒçŽ°åœ¨å¯ä»¥åŠ¨æ‰‹æžä¸€ä¸ªdemoäº†ã€‚ ç”±äºŽç¯‡å¹…é—®é¢˜ï¼Œè¿™é‡Œæˆ‘åªè®¨è®ºæ€è·¯å’Œæˆ‘çš„ä¸€äº›æƒ³æ³•ã€‚ å®Œæ•´ä»£ç å‚è€ƒðŸ‘‰ https://github.com/TavenYin/database-cdc/tree/master/oracle-logminer 1. æ•´ä½“æ€è·¯ç›¸å…³å®žçŽ°æ€è·¯å‚è€ƒè‡ªDebezium éœ€è¦è§£é‡Šä¸€ä¸‹ç¬¬å››æ­¥ä¸ºä»€ä¹ˆï¼Œå‘ç”ŸRedoå‘ç”Ÿåˆ‡æ¢æ—¶ï¼Œéœ€è¦é‡å¯Logmineræµç¨‹ï¼Œä¸¤ç‚¹åŽŸå›  Redo Log åˆ‡æ¢åŽï¼Œä¼šç”Ÿæˆæ–°çš„å½’æ¡£ï¼Œæˆ‘ä»¬éœ€è¦Addæ–°çš„å½’æ¡£æ—¥å¿— é•¿æ—¶é—´å¼€å¯LogMinerä¼šè¯ï¼Œä¼šå¯¼è‡´PGAä½¿ç”¨é‡ä¸€ç›´ä¸Šå‡æ— æ³•é‡Šæ”¾ï¼ŒEnd LogMiner å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ‰€ä»¥ä»£ç é€»è¾‘ä¸­éœ€è¦æ‰¾ä¸€ä¸ªæ—¶æœºåŽ»é‡å¯LogMinerï¼Œè€ŒRedo åˆ‡æ¢è¿™ä¸ªæ—¶é—´ç‚¹ç¡®å®žä¹ŸæŒºåˆé€‚çš„ã€‚ å†™åˆ°è¿™çš„æ—¶å€™ï¼Œæˆ‘çªç„¶æœ‰äº†ä¸€ä¸ªç–‘é—® æˆ‘ä»¬åˆšåˆšå·²ç»è¯´è¿‡äº†ï¼Œåªæœ‰åœ¨æŸ¥è¯¢ V$LOGMNR_CONTENTS æ—¶ï¼ŒLogMineræ‰ä¼šåŽ»è§£æžRedo Logï¼Œç„¶åŽåŠ¨æ€çš„ç”Ÿæˆè§†å›¾ã€‚ å‚è€ƒä¸Šå›¾ã€‚å¦‚æžœåœ¨ç¬¬å››æ­¥å’Œç¬¬å…­æ­¥ä¹‹é—´ï¼Œç¨‹åºæ£€æŸ¥åˆ°æ²¡æœ‰RedoLogåˆ‡æ¢å‡†å¤‡ç»§ç»­æ‰§è¡Œã€‚çªç„¶æ’å…¥äº†å¤§é‡æ•°æ®å¯¼è‡´Current Redo Log è¢«è¦†ç›–ï¼ˆæ³¨æ„å¿…é¡»æ˜¯å·²ç»è¢«è¦†ç›–è€Œä¸æ˜¯åˆ‡æ¢ï¼‰äº†ï¼Œæ­¤æ—¶æ˜¯ä¸æ˜¯æˆ‘ä»¬å†æŸ¥è¯¢ V$LOGMNR_CONTENTS å²‚ä¸æ˜¯ä¼šä¸¢å¤±ä¸€éƒ¨åˆ†æ•°æ®ï¼Ÿ ç”±äºŽstart_logmineræ—¶ä¼šæŒ‡å®šï¼Œèµ·å§‹å’Œç»“æŸSCNï¼Œæ‰€ä»¥å³ä½¿ä¸‹æ¬¡æ‰§è¡Œæ—¶æ·»åŠ äº†æ–°çš„Archived Logï¼Œç”±äºŽSCNå·²ç»è¢«è·¨è¿‡åŽ»äº†ï¼Œæ‰€ä»¥ä¸€å®šä¸ä¼šè¯»è¿™éƒ¨åˆ†æ•°æ® åœ¨æˆ‘åšäº†æµ‹è¯•ä¹‹åŽå‘çŽ°ï¼Œå¦‚æžœæƒ…å†µçœŸçš„å¦‚æ­¤æžç«¯ï¼Œç¡®å®žä¼šè¿™æ ·ã€‚ é‚£ä¹ˆDebeziumä¸ºä»€ä¹ˆæ²¡æœ‰è€ƒè™‘è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ ä¸ªäººç†è§£ï¼Œåœ¨ç”Ÿäº§çŽ¯å¢ƒé€šå¸¸Redo Log ä¸ä¼šé¢‘ç¹åˆ‡æ¢ï¼Œå¹¶ä¸”ä¸€å®šä¼šæœ‰å¤šä¸ªRedo Groupã€‚è¿™ä¹ˆçŸ­æ—¶é—´å†…è¢«è¦†ç›–çš„æƒ…å†µå‡ ä¹Žä¸å¯èƒ½å‘ç”Ÿã€‚ 2. å¤„ç† V$LOGMNR_CONTENTS ç»“æžœé›†æœ€å¼€å§‹åœ¨çœ‹Debeziumæºç çš„æ—¶å€™ï¼Œæ²¡ä»”ç»†æ³¨æ„è¿™ä¸ªåœ°æ–¹ï¼Œåœ¨è‡ªå·±åŠ¨æ‰‹æžä¸€éä¹‹åŽï¼Œå‘çŽ°è¿™ä¸ªåœ°æ–¹çš„é€»è¾‘æœ‰ç‚¹éº»çƒ¦ V$LOGMNR_CONTENTS æ¯ä¸€è¡Œå¯èƒ½æ˜¯äº‹åŠ¡çš„æäº¤ã€å›žæ»šï¼ŒDDLï¼ŒDML ä¸Šé¢æåˆ°äº†ä¸€ä¸ª TransactionalBufferæ˜¯ä»€ä¹ˆï¼Ÿ æˆ‘ä»¬åœ¨è¯»å– V$LOGMNR_CONTENTS ä¼šå‘ç”Ÿå¦‚ä¸‹å›¾çš„æƒ…å†µï¼Œå› ä¸ºæ¯æ¬¡åªä»ŽstartScn è¯»å–åˆ° å½“å‰Scnã€‚è€Œè¿™ä¸­é—´å¯èƒ½å‘ç”Ÿçš„æƒ…å†µæ˜¯ï¼Œäº‹åŠ¡å¹¶æ²¡æœ‰Commitï¼Œä½†æ˜¯æˆ‘ä»¬æ‹¿åˆ°äº†å…¶ä¸­ä¸€éƒ¨åˆ†çš„DMLï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç¡®å®šè¿™äº›DMLæ˜¯ä¸æ˜¯è¦Commitï¼Œæ‰€ä»¥éœ€è¦å°†è¿™äº›â€œä¸€åŠâ€çš„äº‹åŠ¡æš‚æ—¶ç¼“å­˜åœ¨å†…å­˜ä¸­ å…¶å®žåœ¨è°ƒç”¨ DBMS_LOGMNR.START_LOGMNR æ—¶ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªé€‰é¡¹ COMMITTED_DATA_ONLYï¼Œä»…è¯»å‡ºå·²æäº¤çš„äº‹åŠ¡ã€‚è¿™æ ·å°±ä¸å¿…è¦è¿™ä¹ˆéº»çƒ¦çš„å¤„ç†ç»“æžœé›†äº†ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆä¸é€‰æ‹© COMMITTED_DATA_ONLYï¼Ÿä½¿ç”¨è¯¥ç­–ç•¥ä¼šä¸€ç›´ç­‰å¾…äº‹åŠ¡æäº¤æ‰ä¼šå“åº”å®¢æˆ·ç«¯ï¼Œè¿™å¾ˆå®¹æ˜“é€ æˆ â€œOut of Memoryâ€ï¼Œæ‰€ä»¥è¿™ä¸ªç­–ç•¥ä¸é€‚åˆæˆ‘ä»¬çš„ç¨‹åºã€‚ 3. è¿ç§»è¿›ç¨‹å®•æœºå¤„ç†æ•°æ®è¿ç§»å¿…å®šæ˜¯ä¸€ä¸ªæ¼«é•¿çš„è¿‡ç¨‹ï¼Œå¦‚æžœåœ¨æ‰§è¡Œä¸­é‡åˆ°ä»€ä¹ˆæ„å¤–ï¼Œå¯¼è‡´Javaè¿›ç¨‹æŒ‚äº†ï¼Œé‚£ä¹ˆä¸€åˆ‡éƒ½è¦ä»Žå¤´å¼€å§‹å—ï¼Ÿ å¦‚æžœæˆ‘ä»¬èƒ½ç¡®å®šæŸä¸ªSCNä¹‹å‰çš„æ‰€æœ‰è®°å½•éƒ½å·²ç»è¢«å¤„ç†äº†ï¼Œé‚£ä¹ˆä¸‹æ¬¡é‡å¯æ—¶ä»Žè¿™ä¸ªSCNå¼€å§‹å¤„ç†å³å¯ ä¸¤å¤„å¯ä»¥ç¡®å®šä¹‹å‰SCNå·²ç»è¢«å…¨éƒ¨å¤„ç†çš„åœ°æ–¹ï¼Œä»£ç å¦‚ä¸‹ï¼š a. å½“å‰TransactionalBufferä¸­æ²¡æœ‰æ•°æ®ï¼Œä»£è¡¨END_SCNä¹‹å‰æ‰€æœ‰çš„äº‹åŠ¡éƒ½å·²ç»è¢«æäº¤äº† b. æäº¤äº‹åŠ¡æ—¶ï¼Œå¦‚æžœå½“å‰è¦æäº¤çš„äº‹åŠ¡çš„Start_SCN æ—©äºŽTransactionalBufferä¸­çš„æ‰€æœ‰äº‹åŠ¡ 4. SQLè§£æžå¦‚æžœä½ æƒ³å°†Oracleçš„æ•°æ®åŒæ­¥åˆ°å…¶ä»–æ•°æ®åº“ï¼ˆåŒ…å«NoSQLï¼‰çš„è¯ï¼Œæœ€å¥½çš„åŠžæ³•æ˜¯å°†SQLè§£æžæˆç»“æž„åŒ–çš„å¯¹è±¡ï¼Œè®©ä¸‹æ¸¸æœåŠ¡åŽ»æ¶ˆè´¹è¿™äº›å¯¹è±¡ã€‚ Debeziumçš„åšæ³•ï¼Œæˆ‘è¿˜æ²¡æŠ½å‡ºç©ºç ”ç©¶ã€‚ç›®å‰çš„è§£å†³æ–¹æ³•æ˜¯ç”¨com.alibaba.druid.sql.SQLUtilsï¼Œè¿™ä¸ªç±»å¯ä»¥å°†SQLè§£æžæˆç»“æž„åŒ–å¯¹è±¡ï¼Œæˆ‘ä»¬å†å¯¹è¿™äº›å¯¹è±¡è¿›è¡Œä¸€äº›å¤„ç†ï¼Œå³å¯è®©ä¸‹æ¸¸æœåŠ¡æ¶ˆè´¹äº†ã€‚ DEMOè¿è¡Œæ•ˆæžœå¦‚ä¸‹ GitHub ðŸ‘‰ https://github.com/TavenYin/database-cdc/tree/master/oracle-logminer å‚è€ƒ Oracle Redo : https://docs.oracle.com/cd/B28359_01/server.111/b28310/onlineredo001.htm Oracle Archived : https://docs.oracle.com/cd/B28359_01/server.111/b28310/archredo001.htm Oracle Flashback : https://docs.oracle.com/cd/E11882_01/appdev.112/e41502/adfns_flashback.htm LogMiner : https://docs.oracle.com/en/database/oracle/oracle-database/12.2/sutil/oracle-logminer-utility.html Debezium Oracle Connector : https://debezium.io/documentation/reference/connectors/oracle.html]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>LogMiner</tag>
        <tag>æ•°æ®åº“è¿ç§»æŠ€æœ¯</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Kafka Connect-å…¥é—¨]]></title>
    <url>%2Fpost%2F7ec53704.html</url>
    <content type="text"><![CDATA[å‰æé¦–å…ˆä½ éœ€è¦äº†è§£MQ / Kafkaç›¸å…³çš„çŸ¥è¯† æœ¬æ–‡ç›®æ ‡äº†è§£ Kafka Connect åŸºæœ¬æ¦‚å¿µä¸ŽåŠŸèƒ½ ä»€ä¹ˆæ˜¯Kafka Connect Kafka Connect æ˜¯ä¸€æ¬¾å¯æ‰©å±•å¹¶ä¸”å¯é åœ°åœ¨ Apache Kafka å’Œå…¶ä»–ç³»ç»Ÿä¹‹é—´è¿›è¡Œæ•°æ®ä¼ è¾“çš„å·¥å…·ã€‚ å¯ä»¥å¾ˆç®€å•çš„å®šä¹‰ connectorsï¼ˆè¿žæŽ¥å™¨ï¼‰ å°†å¤§é‡æ•°æ®è¿å…¥ã€è¿å‡ºKafkaã€‚ ä¾‹å¦‚æˆ‘çŽ°åœ¨æƒ³è¦æŠŠæ•°æ®ä»ŽMySQLè¿ç§»åˆ°ElasticSearchï¼Œä¸ºäº†ä¿è¯é«˜æ•ˆå’Œæ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œæˆ‘ä»¬é€‰æ‹©MQä½œä¸ºä¸­é—´ä»¶ä¿å­˜æ•°æ®ã€‚è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹ï¼Œä¸æ–­çš„ä»ŽMySQLä¸­è¯»å–æ•°æ®å¹¶å‘é€åˆ°MQï¼Œè¿˜éœ€è¦ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹æ¶ˆè´¹MQçš„æ•°æ®å†™åˆ°ElasticSearchï¼Œè¿™ä»¶äº‹æƒ…ä¼¼ä¹Žå¾ˆç®€å•ï¼Œä¸éœ€è¦ä»»ä½•æ¡†æž¶ã€‚ ä½†æ˜¯å¦‚æžœæˆ‘ä»¬æƒ³è¦ä¿è¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æœåŠ¡çš„é«˜å¯ç”¨æ€§ï¼Œä¾‹å¦‚é‡å¯åŽç”Ÿäº§è€…æ¢å¤åˆ°ä¹‹å‰è¯»å–çš„ä½ç½®ï¼Œåˆ†å¸ƒå¼éƒ¨ç½²å¹¶ä¸”èŠ‚ç‚¹å®•æœºåŽå°†ä»»åŠ¡è½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚å¦‚æžœè¦åŠ ä¸Šè¿™äº›çš„è¯ï¼Œè¿™ä»¶äº‹å°±å˜å¾—å¤æ‚èµ·æ¥äº†ï¼Œè€ŒKafka Connect å·²ç»ä¸ºæˆ‘ä»¬é€ å¥½è¿™äº›è½®å­ã€‚ Kafka Connect å¦‚ä½•å·¥ä½œï¼Ÿ Kafka Connect ç‰¹æ€§å¦‚ä¸‹ï¼š Kafka è¿žæŽ¥å™¨çš„é€šç”¨æ¡†æž¶ï¼šKafka Connect æ ‡å‡†åŒ–äº†å…¶ä»–æ•°æ®ç³»ç»Ÿä¸ŽKafkaçš„é›†æˆï¼Œä»Žè€Œç®€åŒ–äº†è¿žæŽ¥å™¨çš„å¼€å‘ï¼Œéƒ¨ç½²å’Œç®¡ç† æ”¯æŒåˆ†å¸ƒå¼æ¨¡å¼å’Œå•æœºæ¨¡å¼éƒ¨ç½² Rest APIï¼šé€šè¿‡ç®€å•çš„Rest APIç®¡ç†è¿žæŽ¥å™¨ åç§»é‡ç®¡ç†ï¼šé’ˆå¯¹Sourceå’ŒSinkéƒ½æœ‰ç›¸åº”çš„åç§»é‡ï¼ˆOffsetï¼‰ç®¡ç†æ–¹æ¡ˆï¼Œç¨‹åºå‘˜æ— é¡»å…³å¿ƒOffset çš„æäº¤ åˆ†å¸ƒå¼æ¨¡å¼å¯æ‰©å±•çš„ï¼Œæ”¯æŒæ•…éšœè½¬ç§» Kafka Connect Conceptsè¿™é‡Œç®€å•ä»‹ç»ä¸‹Kafka Connect çš„æ¦‚å¿µä¸Žç»„æˆæ›´å¤šç»†èŠ‚è¯·å‚è€ƒ ðŸ‘‰ https://docs.confluent.io/platform/current/connect/concepts.html Connectorsè¿žæŽ¥å™¨ï¼Œåˆ†ä¸ºä¸¤ç§ Sourceï¼ˆä»Žæºæ•°æ®åº“æ‹‰å–æ•°æ®å†™å…¥Kafkaï¼‰ï¼ŒSinkï¼ˆä»ŽKafkaæ¶ˆè´¹æ•°æ®å†™å…¥ç›®æ ‡æ•°æ®ï¼‰ è¿žæŽ¥å™¨å…¶å®žå¹¶ä¸å‚ä¸Žå®žé™…çš„æ•°æ®copyï¼Œè¿žæŽ¥å™¨è´Ÿè´£ç®¡ç†Taskã€‚è¿žæŽ¥å™¨ä¸­å®šä¹‰äº†å¯¹åº”Taskçš„ç±»åž‹ï¼Œå¯¹å¤–æä¾›é…ç½®é€‰é¡¹ï¼ˆç”¨æˆ·åˆ›å»ºè¿žæŽ¥å™¨æ—¶éœ€è¦æä¾›å¯¹åº”çš„é…ç½®ä¿¡æ¯ï¼‰ã€‚å¹¶ä¸”è¿žæŽ¥å™¨è¿˜å¯ä»¥å†³å®šå¯åŠ¨å¤šå°‘ä¸ªTaskçº¿ç¨‹ã€‚ ç”¨æˆ·å¯ä»¥é€šè¿‡Rest API å¯åœè¿žæŽ¥å™¨ï¼ŒæŸ¥çœ‹è¿žæŽ¥å™¨çŠ¶æ€ Confluent å·²ç»æä¾›äº†è®¸å¤šæˆç†Ÿçš„è¿žæŽ¥å™¨ï¼Œä¼ é€é—¨ðŸ‘‰ https://www.confluent.io/product/connectors/ Taskå®žé™…è¿›è¡Œæ•°æ®ä¼ è¾“çš„å•å…ƒï¼Œå’Œè¿žæŽ¥å™¨ä¸€æ ·åŒæ ·åˆ†ä¸º Sourceå’ŒSink Taskçš„é…ç½®å’ŒçŠ¶æ€å­˜å‚¨åœ¨Kafkaçš„Topicä¸­ï¼Œconfig.storage.topicå’Œstatus.storage.topicã€‚æˆ‘ä»¬å¯ä»¥éšæ—¶å¯åŠ¨ï¼Œåœæ­¢ä»»åŠ¡ï¼Œä»¥æä¾›å¼¹æ€§ã€å¯æ‰©å±•çš„æ•°æ®ç®¡é“ Workeråˆšåˆšæˆ‘ä»¬è®²çš„Connectors å’ŒTask å±žäºŽé€»è¾‘å•å…ƒï¼Œè€ŒWorker æ˜¯å®žé™…è¿è¡Œé€»è¾‘å•å…ƒçš„è¿›ç¨‹ï¼ŒWorker åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼Œå•æœºæ¨¡å¼å’Œåˆ†å¸ƒå¼æ¨¡å¼ å•æœºæ¨¡å¼ï¼šæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯åŠŸèƒ½ä¹Ÿå—é™ï¼Œåªæœ‰ä¸€äº›ç‰¹æ®Šçš„åœºæ™¯ä¼šä½¿ç”¨åˆ°ï¼Œä¾‹å¦‚æ”¶é›†ä¸»æœºçš„æ—¥å¿—ï¼Œé€šå¸¸æ¥è¯´æ›´å¤šçš„æ˜¯ä½¿ç”¨åˆ†å¸ƒå¼æ¨¡å¼ åˆ†å¸ƒå¼æ¨¡å¼ï¼šä¸ºKafka Connectæä¾›äº†å¯æ‰©å±•å’Œæ•…éšœè½¬ç§»ã€‚ç›¸åŒgroup.idçš„Workerï¼Œä¼šè‡ªåŠ¨ç»„æˆé›†ç¾¤ã€‚å½“æ–°å¢žWorkerï¼Œæˆ–è€…æœ‰WorkeræŒ‚æŽ‰æ—¶ï¼Œé›†ç¾¤ä¼šè‡ªåŠ¨åè°ƒåˆ†é…æ‰€æœ‰çš„Connector å’Œ Taskï¼ˆè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºRebalanceï¼‰ å½“ä½¿ç”¨Workeré›†ç¾¤æ—¶ï¼Œåˆ›å»ºè¿žæŽ¥å™¨ï¼Œæˆ–è€…è¿žæŽ¥å™¨Taskæ•°é‡å˜åŠ¨æ—¶ï¼Œéƒ½ä¼šè§¦å‘Rebalance ä»¥ä¿è¯é›†ç¾¤å„ä¸ªWorkerèŠ‚ç‚¹è´Ÿè½½å‡è¡¡ã€‚ä½†æ˜¯å½“Task è¿›å…¥FailçŠ¶æ€çš„æ—¶å€™å¹¶ä¸ä¼šè§¦å‘ Rebalanceï¼Œåªèƒ½é€šè¿‡Rest Api å¯¹Taskè¿›è¡Œé‡å¯ ConvertersKafka Connect é€šè¿‡ Converter å°†æ•°æ®åœ¨Kafkaï¼ˆå­—èŠ‚æ•°ç»„ï¼‰ä¸ŽTaskï¼ˆObjectï¼‰ä¹‹é—´è¿›è¡Œè½¬æ¢ é»˜è®¤æ”¯æŒä»¥ä¸‹Converter AvroConverter io.confluent.connect.avro.AvroConverter: éœ€è¦ä½¿ç”¨ Schema Registry ProtobufConverter io.confluent.connect.protobuf.ProtobufConverter: éœ€è¦ä½¿ç”¨ Schema Registry JsonSchemaConverter io.confluent.connect.json.JsonSchemaConverter: éœ€è¦ä½¿ç”¨ Schema Registry JsonConverter org.apache.kafka.connect.json.JsonConverter (æ— éœ€ Schema Registry): è½¬æ¢ä¸ºjsonç»“æž„ StringConverter org.apache.kafka.connect.storage.StringConverter: ç®€å•çš„å­—ç¬¦ä¸²æ ¼å¼ ByteArrayConverter org.apache.kafka.connect.converters.ByteArrayConverter: ä¸åšä»»ä½•è½¬æ¢ Converters ä¸Ž Connector æ˜¯è§£è€¦çš„ï¼Œä¸‹å›¾å±•ç¤ºäº†åœ¨Kafka Connectä¸­ï¼ŒConverter åœ¨ä½•æ—¶è¿›è¡Œæ•°æ®è½¬æ¢ Transformsè¿žæŽ¥å™¨å¯ä»¥é€šè¿‡é…ç½®Transform å®žçŽ°å¯¹å•ä¸ªæ¶ˆæ¯ï¼ˆå¯¹åº”ä»£ç ä¸­çš„Recordï¼‰çš„è½¬æ¢å’Œä¿®æ”¹ï¼Œå¯ä»¥é…ç½®å¤šä¸ªTransform ç»„æˆä¸€ä¸ªé“¾ã€‚ä¾‹å¦‚è®©æ‰€æœ‰æ¶ˆæ¯çš„topicåŠ ä¸€ä¸ªå‰ç¼€ã€sinkæ— æ³•æ¶ˆè´¹source å†™å…¥çš„æ•°æ®æ ¼å¼ï¼Œè¿™äº›åœºæ™¯éƒ½å¯ä»¥ä½¿ç”¨Transform è§£å†³ Transform å¦‚æžœé…ç½®åœ¨Source åˆ™åœ¨Taskä¹‹åŽæ‰§è¡Œï¼Œå¦‚æžœé…ç½®åœ¨Sink åˆ™åœ¨Taskä¹‹å‰æ‰§è¡Œ Dead Letter Queueä¸Žå…¶ä»–MQä¸åŒï¼ŒKafka å¹¶æ²¡æœ‰æ­»ä¿¡é˜Ÿåˆ—è¿™ä¸ªåŠŸèƒ½ã€‚ä½†æ˜¯Kafka Connectæä¾›äº†è¿™ä¸€åŠŸèƒ½ã€‚ å½“Sink Taské‡åˆ°æ— æ³•å¤„ç†çš„æ¶ˆæ¯ï¼Œä¼šæ ¹æ®errors.toleranceé…ç½®é¡¹å†³å®šå¦‚ä½•å¤„ç†ï¼Œé»˜è®¤æƒ…å†µä¸‹(errors.tolerance=none) Sink é‡åˆ°æ— æ³•å¤„ç†çš„è®°å½•ä¼šç›´æŽ¥æŠ›å‡ºå¼‚å¸¸ï¼ŒTaskè¿›å…¥Fail çŠ¶æ€ã€‚å¼€å‘äººå‘˜éœ€è¦æ ¹æ®Workerçš„é”™è¯¯æ—¥å¿—è§£å†³é—®é¢˜ï¼Œç„¶åŽé‡å¯Taskï¼Œæ‰èƒ½ç»§ç»­æ¶ˆè´¹æ•°æ® è®¾ç½® errors.tolerance=allï¼ŒSink Task ä¼šå¿½ç•¥æ‰€æœ‰çš„é”™è¯¯ï¼Œç»§ç»­å¤„ç†ã€‚Workerä¸­ä¸ä¼šæœ‰ä»»ä½•é”™è¯¯æ—¥å¿—ã€‚å¯ä»¥é€šè¿‡é…ç½®errors.deadletterqueue.topic.name = &lt;dead-letter-topic-name&gt; è®©æ— æ³•å¤„ç†çš„æ¶ˆæ¯è·¯ç”±åˆ° Dead Letter Topic å¿«é€Ÿä¸Šæ‰‹ä¸‹é¢æˆ‘æ¥å®žæˆ˜ä¸€ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨Kafka Connectï¼Œæˆ‘ä»¬å…ˆå®šä¸€ä¸ªå°ç›®æ ‡ å°†MySQLä¸­çš„å…¨é‡æ•°æ®åŒæ­¥åˆ°Redis æ–°å»ºæ–‡ä»¶ docker-compose.yaml123456789101112131415161718192021version: &apos;3.7&apos;services: zookeeper: image: wurstmeister/zookeeper container_name: zk ports: - 2182:2181 kafka: image: wurstmeister/kafka:2.13-2.7.0 container_name: kafka ports: - 9092:9092 environment: KAFKA_BROKER_ID: 0 # å®¿ä¸»æœºip KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://192.168.3.21:9092 KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092 depends_on: - zookeeper åœ¨ç»ˆç«¯ä¸Šæ‰§è¡Œ docker-compose -f docker-compose.yaml up -d å¯åŠ¨dockerå®¹å™¨ å‡†å¤‡è¿žæŽ¥å™¨ï¼Œè¿™é‡Œæˆ‘æ˜¯è‡ªå·±å†™äº†ä¸€ä¸ªç®€å•çš„è¿žæŽ¥å™¨ðŸ˜„ã€‚ä¸‹è½½åœ°å€ï¼šhttps://github.com/TavenYin/kafka-connect-example/blob/master/release/kafka-connector-example-bin.jar 12# å°†è¿žæŽ¥å™¨ä¸Šä¼ åˆ°kafka å®¹å™¨ä¸­docker cp kafka-connector-example-bin.jar kafka:/opt/connectors ä¿®æ”¹é…ç½®å¹¶å¯åŠ¨Worker 12345#åœ¨é…ç½®æ–‡ä»¶æœ«å°¾è¿½åŠ  plugin.path=/opt/connectorsvi /opt/kafka/config/connect-distributed.properties# å¯åŠ¨Workerbin/connect-distributed.sh -daemon config/connect-distributed.properties å‡†å¤‡MySQL ç”±äºŽæˆ‘å®¿ä¸»æœºé‡Œå·²ç»å®‰è£…äº†MySQLï¼Œæˆ‘å°±ç›´æŽ¥ä½¿ç”¨äº†ï¼Œä½¿ç”¨å¦‚ä¸‹Sqlåˆ›å»ºè¡¨ã€‚åˆ›å»ºä¹‹åŽéšä¾¿é€ å‡ æ¡æ•°æ®12345CREATE TABLE `test_user` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `name` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`)) ; åˆ›å»ºè¿žæŽ¥å™¨ æ–°å»º source.json1234567891011&#123; &quot;name&quot; : &quot;example-source&quot;, &quot;config&quot; : &#123; &quot;connector.class&quot; : &quot;com.github.taven.source.ExampleSourceConnector&quot;, &quot;tasks.max&quot; : &quot;1&quot;, &quot;database.url&quot; : &quot;jdbc:mysql://192.168.3.21:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;useSSL=false&amp;zeroDateTimeBehavior=convertToNull&amp;serverTimezone=UTC&amp;rewriteBatchedStatements=true&quot;, &quot;database.username&quot; : &quot;root&quot;, &quot;database.password&quot; : &quot;root&quot;, &quot;database.tables&quot; : &quot;test_user&quot; &#125;&#125; å‘Worker å‘é€è¯·æ±‚ï¼Œåˆ›å»ºè¿žæŽ¥å™¨curl -i -X POST -H &quot;Accept:application/json&quot; -H &quot;Content-Type:application/json&quot; http://localhost:8083/connectors/ -d @source.json source.json ä¸­ï¼Œæœ‰ä¸€äº›å±žæ€§æ˜¯Kafka Connect æä¾›çš„ï¼Œä¾‹å¦‚ä¸Šè¿°æ–‡ä»¶ä¸­ name, connector.class, tasks.maxï¼Œå‰©ä¸‹çš„å±žæ€§å¯ä»¥åœ¨å¼€å‘Connector æ—¶è‡ªå®šä¹‰ã€‚å…³äºŽKafka Connect Configuration ç›¸å…³è¯·é˜…è¯»è¿™é‡Œ ðŸ‘‰ https://docs.confluent.io/platform/current/installation/configuration/connect/index.html ç¡®è®¤æ•°æ®æ˜¯å¦å†™å…¥Kafka é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹Workerä¸­çš„è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æžœTaskçš„state = RUNNINGï¼Œä»£è¡¨Taskæ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼Œå¹³ç¨³è¿è¡Œ123bash-4.4# curl -X GET localhost:8083/connectors/example-source/status&#123;&quot;name&quot;:&quot;example-source&quot;,&quot;connector&quot;:&#123;&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;,&quot;tasks&quot;:[&#123;&quot;id&quot;:0,&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;],&quot;type&quot;:&quot;source&quot;&#125; æŸ¥çœ‹kafka ä¸­Topic æ˜¯å¦åˆ›å»º123456bash-4.4# bin/kafka-topics.sh --list --zookeeper zookeeper:2181__consumer_offsetsconnect-configsconnect-offsetsconnect-statustest_user è¿™äº›Topic éƒ½å­˜å‚¨äº†ä»€ä¹ˆï¼Ÿ __consumer_offsets: è®°å½•æ‰€æœ‰Kafka Consumer Groupçš„Offset connect-configs: å­˜å‚¨è¿žæŽ¥å™¨çš„é…ç½®ï¼Œå¯¹åº”Connect é…ç½®æ–‡ä»¶ä¸­config.storage.topic connect-offsets: å­˜å‚¨Source çš„Offsetï¼Œå¯¹åº”Connect é…ç½®æ–‡ä»¶ä¸­offset.storage.topic connect-status: è¿žæŽ¥å™¨ä¸ŽTaskçš„çŠ¶æ€ï¼Œå¯¹åº”Connect é…ç½®æ–‡ä»¶ä¸­status.storage.topic æŸ¥çœ‹topicä¸­æ•°æ®ï¼Œæ­¤æ—¶è¯´æ˜ŽMySQLæ•°æ®å·²ç»æˆåŠŸå†™å…¥Kafka1234bash-4.4# bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test_user --from-beginning&#123;&quot;schema&quot;:&#123;&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[&#123;&quot;type&quot;:&quot;int64&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;id&quot;&#125;,&#123;&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;name&quot;&#125;],&quot;optional&quot;:false,&quot;name&quot;:&quot;test_user&quot;&#125;,&quot;payload&quot;:&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;yyyyyy&quot;&#125;&#125;&#123;&quot;schema&quot;:&#123;&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[&#123;&quot;type&quot;:&quot;int64&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;id&quot;&#125;,&#123;&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;name&quot;&#125;],&quot;optional&quot;:false,&quot;name&quot;:&quot;test_user&quot;&#125;,&quot;payload&quot;:&#123;&quot;id&quot;:2,&quot;name&quot;:&quot;qqqq&quot;&#125;&#125;&#123;&quot;schema&quot;:&#123;&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[&#123;&quot;type&quot;:&quot;int64&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;id&quot;&#125;,&#123;&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;name&quot;&#125;],&quot;optional&quot;:false,&quot;name&quot;:&quot;test_user&quot;&#125;,&quot;payload&quot;:&#123;&quot;id&quot;:3,&quot;name&quot;:&quot;eeee&quot;&#125;&#125; æ•°æ®ç»“æž„ä¸ºJsonï¼Œå¯ä»¥å›žé¡¾ä¸€ä¸‹ä¸Šé¢æˆ‘ä»¬ä¿®æ”¹çš„connect-distributed.propertiesï¼Œé»˜è®¤æä¾›çš„Converter ä¸ºJsonConverterï¼Œæ‰€æœ‰çš„æ•°æ®åŒ…å«schema å’Œ payload ä¸¤é¡¹æ˜¯å› ä¸ºé…ç½®æ–‡ä»¶ä¸­é»˜è®¤å¯åŠ¨äº†key.converter.schemas.enable=trueå’Œvalue.converter.schemas.enable=trueä¸¤ä¸ªé€‰é¡¹ å¯åŠ¨ Sink æ–°å»ºsink.json123456789101112&#123; &quot;name&quot; : &quot;example-sink&quot;, &quot;config&quot; : &#123; &quot;connector.class&quot; : &quot;com.github.taven.sink.ExampleSinkConnector&quot;, &quot;topics&quot; : &quot;test_user, test_order&quot;, &quot;tasks.max&quot; : &quot;1&quot;, &quot;redis.host&quot; : &quot;192.168.3.21&quot;, &quot;redis.port&quot; : &quot;6379&quot;, &quot;redis.password&quot; : &quot;&quot;, &quot;redis.database&quot; : &quot;0&quot; &#125;&#125; åˆ›å»ºSink Connectorcurl -i -X POST -H &quot;Accept:application/json&quot; -H &quot;Content-Type:application/json&quot; http://localhost:8083/connectors/ -d @sink.json ç„¶åŽæŸ¥çœ‹Sink Connector Statusï¼Œè¿™é‡Œæˆ‘å‘çŽ°ç”±äºŽæˆ‘çš„Redisç«¯å£åªå¯¹localhostå¼€å‘ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘çš„Task Failäº†ï¼Œä¿®æ”¹äº†Redisé…ç½®ä¹‹åŽï¼Œé‡å¯Task curl -X POST localhost:8083/connectors/example-sink/tasks/0/restart åœ¨ç¡®è®¤äº†Sink Status ä¸ºRUNNING åŽï¼Œå¯ä»¥ç¡®è®¤ä¸‹Redisä¸­æ˜¯å¦æœ‰æ•°æ® å…³äºŽKafka Connect Rest api æ–‡æ¡£ï¼Œè¯·å‚è€ƒðŸ‘‰https://docs.confluent.io/platform/current/connect/references/restapi.html å¦‚ä½•æŸ¥çœ‹Sink Offsetæ¶ˆè´¹æƒ…å†µ ä½¿ç”¨å‘½ä»¤bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group connect-example-sink ä¸‹å›¾ä»£è¡¨ test_user topic ä¸‰æ¡æ•°æ®å·²ç»å…¨éƒ¨æ¶ˆè´¹ Kafka Connect é«˜çº§åŠŸèƒ½æˆ‘ä»¬çš„å°ç›®æ ‡å·²ç»è¾¾æˆäº†ã€‚çŽ°åœ¨ä¸¤ä¸ªTaskæ— äº‹å¯åšï¼Œæ­£å¥½å€Ÿæ­¤æœºä¼šæˆ‘ä»¬æ¥ä½“éªŒä¸€ä¸‹å¯æ‰©å±•å’Œæ•…éšœè½¬ç§» é›†ç¾¤æ‰©å±•æˆ‘å¯åŠ¨äº†å¼€å‘çŽ¯å¢ƒä¸­çš„Kafka Connect Workerï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£æ‰€ç¤ºé€šè¿‡æ³¨å†ŒåŒä¸€ä¸ªKafka å¹¶ä¸”ä½¿ç”¨ç›¸åŒçš„ group.id=connect-cluster å¯ä»¥è‡ªåŠ¨ç»„æˆé›†ç¾¤ å¯åŠ¨æˆ‘å¼€å‘çŽ¯å¢ƒä¸­çš„Kafka Connectï¼Œä¹‹åŽæ£€æŸ¥ä¸¤ä¸ªè¿žæŽ¥å™¨çŠ¶æ€ 12345bash-4.4# curl -X GET localhost:8083/connectors/example-source/status&#123;&quot;name&quot;:&quot;example-source&quot;,&quot;connector&quot;:&#123;&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.23.176.1:8083&quot;&#125;,&quot;tasks&quot;:[&#123;&quot;id&quot;:0,&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.23.176.1:8083&quot;&#125;],&quot;type&quot;:&quot;source&quot;&#125;bash-4.4#bash-4.4# curl -X GET localhost:8083/connectors/example-sink/status&#123;&quot;name&quot;:&quot;example-sink&quot;,&quot;connector&quot;:&#123;&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;,&quot;tasks&quot;:[&#123;&quot;id&quot;:0,&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;],&quot;type&quot;:&quot;sink&quot;&#125; è§‚å¯Ÿworker_id å¯ä»¥å‘çŽ°ï¼Œä¸¤ä¸ªConnectors å·²ç»åˆ†åˆ«è¿è¡Œåœ¨ä¸¤ä¸ªWorkerä¸Šäº† æ•…éšœè½¬ç§»æ­¤æ—¶æˆ‘ä»¬é€šè¿‡kill pidç»“æŸdockerä¸­çš„Workerè¿›ç¨‹è§‚å¯Ÿæ˜¯å¦å®•æœºä¹‹åŽè‡ªåŠ¨è½¬ç§»ï¼Œä½†æ˜¯å‘çŽ°Taskå¹¶æ²¡æœ‰è½¬ç§»åˆ°ä»…å­˜çš„Workerä¸­ï¼ŒTask çŠ¶æ€å˜ä¸ºUNASSIGNEDï¼Œè¿™æ˜¯ä¸ºå•¥å‘¢ï¼Ÿéš¾é“æ˜¯æœ‰ä»€ä¹ˆæ“ä½œé”™äº†ï¼Ÿ åœ¨ç½‘ä¸ŠæŸ¥é˜…äº†ä¸€ç•ªå¾—çŸ¥ï¼ŒKafka Connect çš„é›†ç¾¤æ‰©å±•ä¸Žæ•…éšœè½¬ç§»æœºåˆ¶æ˜¯é€šè¿‡Kafka Rebalance åè®®å®žçŽ°çš„ï¼ˆConsumerä¹Ÿæ˜¯è¯¥åè®®ï¼‰ï¼Œå½“WorkerèŠ‚ç‚¹å®•æœºæ—¶é—´è¶…è¿‡ scheduled.rebalance.max.delay.ms æ—¶ï¼ŒKafkaæ‰ä¼šå°†å…¶è¸¢å‡ºé›†ç¾¤ã€‚è¸¢å‡ºåŽå°†è¯¥èŠ‚ç‚¹çš„è¿žæŽ¥å™¨å’Œä»»åŠ¡åˆ†é…ç»™å…¶ä»–Workerï¼Œscheduled.rebalance.max.delay.msé»˜è®¤å€¼ä¸ºäº”åˆ†é’Ÿã€‚ åŽæ¥ç»æµ‹è¯•å‘çŽ°ï¼Œäº”åˆ†é’Ÿä¹‹åŽæŸ¥çœ‹è¿žæŽ¥å™¨ä¿¡æ¯ï¼Œå·²ç»è½¬ç§»åˆ°å­˜æ´»çš„WorkerèŠ‚ç‚¹äº† æœ¬æ¥è¿˜è®¡åˆ’å†™ä¸€ä¸‹å¦‚ä½•å¼€å‘è¿žæŽ¥å™¨å’ŒKafka Rebalanceï¼Œä½†æ˜¯è¿™ç¯‡å·²ç»å¤Ÿé•¿äº†ï¼Œæ‰€ä»¥è®¡åˆ’åŽç»­æ›´æ–°è¿™ä¸¤ç¯‡æ–‡ç« ]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
        <tag>Kafka Connect</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é—®é¢˜åˆ†æžï¼šKafka Connect å¼•å…¥äº†FastjsonåŽï¼ŒRest APIå“åº”ä¸º{}]]></title>
    <url>%2Fpost%2F11f7961b.html</url>
    <content type="text"><![CDATA[å‰è¨€æœ€è¿‘åœ¨å­¦ä¹ Kafka Connectï¼Œå†™äº†ä¸ªè¿žæŽ¥å™¨çš„demoã€‚åœ¨demoæäº¤äº†å‡ ä¸ªç‰ˆæœ¬ä¹‹åŽï¼Œçªç„¶å‘çŽ°Kafka Connect Rest API æ— æ³•æ­£å¸¸å“åº”äº†ï¼Œæ˜Žæ˜Žæœ‰æ­£åœ¨è¿è¡Œçš„è¿žæŽ¥å™¨ï¼ŒæŸ¥è¯¢statusï¼Œå±…ç„¶è¿”å›ž{} é—®é¢˜åˆ†æžå¯¹ Rest API è¿›è¡ŒdebugåŽï¼Œç¡®è®¤æ˜¯æœ‰æ•°æ®çš„ï¼Œä½†æ˜¯æ•°æ®è¿”å›žä¸åˆ°å®¢æˆ·ç«¯ï¼Œå¾ˆå¥‡æ€ªã€‚å› ä¸ºæˆ‘è®°å¾—ä¹‹å‰æ˜¯å¥½ç”¨çš„ï¼Œæ‰€ä»¥æˆ‘å›žæ»šäº†ä»£ç ç‰ˆæœ¬ï¼Œé€ä¸€æŽ’æŸ¥ä¹‹åŽå‘çŽ°å½“å¼•å…¥Fastjson ä¾èµ–ä¹‹åŽï¼Œä¼šå¯¼è‡´Connect Rest API ä¸å¯ç”¨ å¦‚æžœæ‡’ä¸€ç‚¹çš„è¯ï¼Œåˆ°è¿™é‡Œå°±å·²ç»ç»“æŸäº†ï¼Œç›´æŽ¥åˆ é™¤Fastjsonä¾èµ–ï¼Œä½¿ç”¨å…¶ä»–JsonåŒ…ã€‚ä½†æ˜¯æˆ‘å¾ˆå¥½å¥‡ï¼Œåœ¨æˆ‘çš„ç†è§£é‡Œï¼ŒFastjson è¿™ç§åº“å°±æ˜¯ä¸ªå·¥å…·åŒ…ï¼Œå¦‚æžœæˆ‘ä»¬ç¨‹åºæ²¡æœ‰ä¸»åŠ¨è°ƒç”¨çš„æ—¶å€™ï¼Œæ˜¯ä¸ä¼šå¯¹æˆ‘ä»¬äº§ç”Ÿä»»ä½•å½±å“çš„ã€‚ ç™¾åº¦è°·æ­Œä¸€é€šä¹‹åŽï¼Œä¸€ç­¹èŽ«å±•ä¹‹é™…ï¼Œç‚¹å¼€äº†Fastjsonçš„æºç åŒ…ï¼Œåœ¨è¿™é‡Œå‘çŽ°äº†Fastjsonä¸ºJAXRSæä¾›çš„SPIæ‰©å±• JAXRSï¼šJava API for RESTful Web Servicesï¼ŒJavaEEæä¾›çš„WebæœåŠ¡æŽ¥å£ã€‚Jersey å®žçŽ°äº†JAXRSï¼Œè€ŒKafka Connect å¼•ç”¨äº†Jersey ã€‚SPIï¼šService Provider Interface ï¼Œæ˜¯JDKå†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘çŽ°æœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ Java SPI å®žæˆ˜ æ‰“å¼€javax.ws.rs.ext.MessageBodyWriter æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æä¾›çš„å®žçŽ°ç±»æ˜¯com.alibaba.fastjson.support.jaxrs.FastJsonProviderï¼Œå®šä½åˆ°FastJsonProviderä¸‹writeToæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæŠŠobjectå†™å…¥åˆ°OutputStreamä¸­ï¼Œçœ‹èµ·æ¥å¾ˆé è°±ï¼Œdebugè¯•ä¸€ä¸‹ æžœç„¶ï¼Œè¯´æ˜ŽFastjsonæžœç„¶å‚ä¸Žäº†Rest APIçš„å“åº”ã€‚ä¸ºä»€ä¹ˆä½¿ç”¨Fastjsonå°±å“åº”ä¸äº†æ•°æ®å‘¢ï¼Œçœ‹äº†ä¸‹æºç ï¼Œè¿™é‡Œè¦æ±‚è¢«åºåˆ—åŒ–çš„Beanå¿…é¡»æ ‡è®°Fastjsonç›¸å…³çš„æ³¨è§£ï¼Œè€Œå®žé™…çš„Beanä½¿ç”¨çš„æ˜¯Jacksonçš„æ³¨è§£ï¼Œæ‰€ä»¥Fastjsonæ— æ³•åºåˆ—åŒ–æ•°æ®ã€‚ æŽ¥ä¸‹æ¥å¯ä»¥æ ¹æ®è°ƒç”¨æ ˆå’Œå…¨å±€æœç´¢æ‰¾ä¸€ä¸‹ï¼Œçœ‹çœ‹FastJsonProvideræ˜¯åœ¨ä»€ä¹ˆæ—¶æœºåŠ è½½çš„ï¼Œèƒ½å¦å¹²æŽ‰ä»–ã€‚ è°ƒç”¨æ ˆå¹¶æ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆæœ‰ç”¨çš„ä¿¡æ¯ï¼Œé€šè¿‡å…¨å±€æœç´¢MessageBodyWriteræ‰¾åˆ°äº†FastJsonProviderçš„åŠ è½½ä½ç½®ï¼ŒMessageBodyFactory::initialize ä¸Šå›¾å­—é¢æ„æ€ç†è§£ï¼Œä½¿ç”¨ injectionManager (æ³¨å…¥ç®¡ç†å™¨)ï¼Œæ‰¾åˆ°MessageBodyWriterçš„å¯ç”¨å®žçŽ° è¿™é‡Œçš„ customMbws size = 2ï¼Œåˆ†åˆ«æ˜¯FastJsonå’ŒJacksonçš„å®žçŽ°ã€‚ä½†æ˜¯FastJsonåœ¨å‰ï¼Œè€Œæ¯æ¬¡éœ€è¦åšJSONåºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šéåŽ†writersï¼Œå¦‚æžœæ‰¾åˆ°æ”¯æŒapplication/jsonçš„MessageBodyWriteråˆ™ç›´æŽ¥è¿”å›žï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨çš„éƒ½æ˜¯FastJsonçš„å®žçŽ°ã€‚ è‡³æ­¤å·²ç»æ˜Žç™½äº†ï¼Œä¸ºä»€ä¹ˆFastjson ä¼šå½±å“Kafka Connectäº†ï¼ŒæŽ¥ä¸‹æ¥å°±æ˜¯æƒ³åŠžæ³•è§£å†³äº† è¿™ä¸ªæ—¶å€™è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°Fastjsonæ˜¯åœ¨å“ªåŠ è½½çš„ï¼Œåœ¨Fastjsonçš„ wiki ä¸­æ‰¾åˆ°äº†äº›çµæ„Ÿï¼Œå‘çŽ°Fastjson åœ¨Jersey ä¸­å¹¶ä¸æ˜¯é€šè¿‡SPIçš„æ–¹å¼è¿›è¡Œçš„æ‰©å±•ï¼Œè€Œæ˜¯é€šè¿‡FastJsonAutoDiscoverableï¼Œå‘Jersey çš„ contextä¸­æ³¨å†ŒFastJsonProvider æœ€åŽï¼Œæˆ‘ä»¬åœ¨java è¿›ç¨‹å¯åŠ¨æ—¶æŒ‡å®šå‚æ•° -Dfastjson.auto.discoverable=falseï¼Œç¦ç”¨ FastJsonProvider å‚è€ƒhttps://github.com/alibaba/fastjson/wiki/Integrate-Fastjson-in-JAXRS]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆ†å¸ƒå¼äº‹åŠ¡ Seata ATæ¨¡å¼åŽŸç†ä¸Žå®žæˆ˜]]></title>
    <url>%2Fpost%2F6fe3d525.html</url>
    <content type="text"><![CDATA[Seata æ˜¯é˜¿é‡Œå¼€æºçš„åŸºäºŽJavaçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ ATï¼ŒXAï¼ŒTCCï¼ŒSagaSeata æä¾›å››ç§æ¨¡å¼è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯ï¼ŒATï¼ŒXAï¼ŒTCCï¼ŒSagaã€‚ç®€å•å¨å’•å¨å’•æˆ‘å¯¹è¿™å‡ ç§æ¨¡å¼çš„ç†è§£ AT è¿™æ˜¯Seataçš„ä¸€å¤§ç‰¹è‰²ï¼ŒATå¯¹ä¸šåŠ¡ä»£ç å®Œå…¨æ— ä¾µå…¥æ€§ï¼Œä½¿ç”¨éžå¸¸ç®€å•ï¼Œæ”¹é€ æˆæœ¬ä½Žã€‚æˆ‘ä»¬åªéœ€è¦å…³æ³¨è‡ªå·±çš„ä¸šåŠ¡SQLï¼ŒSeataä¼šé€šè¿‡åˆ†æžæˆ‘ä»¬ä¸šåŠ¡SQLï¼Œåå‘ç”Ÿæˆå›žæ»šæ•°æ® AT åŒ…å«ä¸¤ä¸ªé˜¶æ®µ ä¸€é˜¶æ®µï¼Œæ‰€æœ‰å‚ä¸Žäº‹åŠ¡çš„åˆ†æ”¯ï¼Œæœ¬åœ°äº‹åŠ¡Commit ä¸šåŠ¡æ•°æ®å’Œå›žæ»šæ—¥å¿—ï¼ˆundoLogï¼‰ äºŒé˜¶æ®µï¼Œäº‹åŠ¡åè°ƒè€…æ ¹æ®æ‰€æœ‰åˆ†æ”¯çš„æƒ…å†µï¼Œå†³å®šæœ¬æ¬¡å…¨å±€äº‹åŠ¡æ˜¯Commit è¿˜æ˜¯ Rollbackï¼ˆäºŒé˜¶æ®µæ˜¯å®Œå…¨å¼‚æ­¥ï¼‰ XAä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è¯´çš„äºŒé˜¶æ®µæäº¤ï¼ŒXAè¦æ±‚æ•°æ®åº“æœ¬èº«æä¾›å¯¹è§„èŒƒå’Œåè®®çš„æ”¯æŒã€‚XAç”¨èµ·æ¥çš„è¯ï¼Œä¹Ÿæ˜¯å¯¹ä¸šåŠ¡ä»£ç æ— ä¾µå…¥æ€§çš„ã€‚ ä¸Šè¿°å…¶ä»–ä¸‰ç§æ¨¡å¼ï¼Œéƒ½æ˜¯å±žäºŽè¡¥å¿åž‹ï¼Œæ— æ³•ä¿è¯å…¨å±€ä¸€è‡´æ€§ã€‚å•¥æ„æ€å‘¢ï¼Œä¾‹å¦‚åˆšåˆšè¯´çš„ATæ¨¡å¼ï¼Œæˆ‘ä»¬æ˜¯å¯èƒ½è¯»åˆ°è¿™ä¸€æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸­é—´çŠ¶æ€ï¼Œè€ŒXAæ¨¡å¼ä¸ä¼šã€‚ è¡¥å¿åž‹ äº‹åŠ¡å¤„ç†æœºåˆ¶æž„å»ºåœ¨ äº‹åŠ¡èµ„æºï¼ˆæ•°æ®åº“ï¼‰ ä¹‹ä¸Šï¼ˆè¦ä¹ˆåœ¨ä¸­é—´ä»¶å±‚é¢ï¼Œè¦ä¹ˆåœ¨åº”ç”¨å±‚é¢ï¼‰ï¼Œäº‹åŠ¡èµ„æº æœ¬èº«å¯¹åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†è¡¥å¿åž‹äº‹åŠ¡æ— æ³•åšåˆ°çœŸæ­£çš„ å…¨å±€ä¸€è‡´æ€§ ã€‚æ¯”å¦‚ï¼Œä¸€æ¡åº“å­˜è®°å½•ï¼Œå¤„åœ¨ è¡¥å¿åž‹ äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œç”± 100 æ‰£å‡ä¸º 50ã€‚æ­¤æ—¶ï¼Œä»“åº“ç®¡ç†å‘˜è¿žæŽ¥æ•°æ®åº“ï¼ŒæŸ¥è¯¢ç»Ÿè®¡åº“å­˜ï¼Œå°±çœ‹åˆ°å½“å‰çš„ 50ã€‚ä¹‹åŽï¼Œäº‹åŠ¡å› ä¸ºæ„å¤–å›žæ»šï¼Œåº“å­˜ä¼šè¢«è¡¥å¿å›žæ»šä¸º 100ã€‚æ˜¾ç„¶ï¼Œä»“åº“ç®¡ç†å‘˜æŸ¥è¯¢ç»Ÿè®¡åˆ°çš„ 50 å°±æ˜¯ è„ æ•°æ®ã€‚å¦‚æžœæ˜¯XAçš„è¯ï¼Œä¸­é—´æ€æ•°æ®åº“å­˜ 50 ç”±æ•°æ®åº“æœ¬èº«ä¿è¯ï¼Œä¸ä¼šè¢«ä»“åº“ç®¡ç†å‘˜è¯»åˆ°ï¼ˆå½“ç„¶éš”ç¦»çº§åˆ«éœ€è¦ è¯»å·²æäº¤ ä»¥ä¸Šï¼‰ ä½†æ˜¯å…¨å±€ä¸€è‡´æ€§å¸¦æ¥çš„ç»“æžœå°±æ˜¯æ•°æ®çš„é”å®šï¼ˆATæ¨¡å¼ä¹Ÿæ˜¯å­˜åœ¨å…¨å±€é”çš„ï¼Œä½†æ˜¯éš”ç¦»çº§åˆ«æ— æ³•ä¿è¯ï¼ŒåŽè¾¹æˆ‘ä»¬ä¼šè¯¦ç»†è¯´ï¼‰ï¼Œä¾‹å¦‚å…¨å±€äº‹åŠ¡ä¸­æœ‰ä¸€æ¡updateè¯­å¥ï¼Œå…¶ä»–äº‹åŠ¡æƒ³è¦æ›´æ–°åŒä¸€æ¡æ•°æ®çš„è¯ï¼Œåªèƒ½ç­‰å¾…å…¨å±€äº‹åŠ¡ç»“æŸ ä¼ ç»ŸXAæ¨¡å¼æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜çš„ï¼ŒSeataä¹Ÿæ˜¯åšäº†ç›¸å…³çš„ä¼˜åŒ–ï¼Œæ›´å¤šå…³äºŽSeata XAçš„å†…å®¹ï¼Œä¼ é€é—¨ðŸ‘‰http://seata.io/zh-cn/blog/seata-xa-introduce.html TCC TCC æ¨¡å¼åŒæ ·åŒ…å«ä¸¤ä¸ªé˜¶æ®µ Try é˜¶æ®µ ï¼šæ‰€æœ‰å‚ä¸Žåˆ†å¸ƒå¼äº‹åŠ¡çš„åˆ†æ”¯ï¼Œå¯¹ä¸šåŠ¡èµ„æºè¿›è¡Œæ£€æŸ¥å’Œé¢„ç•™ äºŒé˜¶æ®µ Confirmï¼šæ‰€æœ‰åˆ†æ”¯çš„Tryå…¨éƒ¨æˆåŠŸåŽï¼Œæ‰§è¡Œä¸šåŠ¡æäº¤ äºŒé˜¶æ®µ Cancelï¼šå–æ¶ˆTryé˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº å¯¹æ¯”ATæˆ–è€…XAæ¨¡å¼æ¥è¯´ï¼ŒTCCæ¨¡å¼éœ€è¦æˆ‘ä»¬è‡ªå·±æŠ½è±¡å¹¶å®žçŽ°Tryï¼ŒConfirmï¼ŒCancelä¸‰ä¸ªæŽ¥å£ï¼Œç¼–ç é‡ä¼šå¤§ä¸€äº›ï¼Œä½†æ˜¯ç”±äºŽäº‹åŠ¡çš„æ¯ä¸€ä¸ªé˜¶æ®µéƒ½ç”±å¼€å‘äººå‘˜è‡ªè¡Œå®žçŽ°ã€‚è€Œä¸”ç›¸è¾ƒäºŽATæ¨¡å¼æ¥è¯´ï¼Œå‡å°‘äº†SQLè§£æžçš„è¿‡ç¨‹ï¼Œä¹Ÿæ²¡æœ‰å…¨å±€é”çš„é™åˆ¶ï¼Œæ‰€ä»¥TCCæ¨¡å¼çš„æ€§èƒ½æ˜¯ä¼˜äºŽAT ã€XAæ¨¡å¼ã€‚PSï¼šæžœç„¶ç®€å•å’Œé«˜æ•ˆéš¾ä»¥ä¸¤å…¨çš„ Saga Saga æ˜¯é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œæ¯ä¸ªå‚ä¸Žè€…éœ€è¦å®žçŽ°äº‹åŠ¡çš„æ­£å‘æ“ä½œå’Œè¡¥å¿æ“ä½œã€‚å½“å‚ä¸Žè€…æ­£å‘æ“ä½œæ‰§è¡Œå¤±è´¥æ—¶ï¼Œå›žæ»šæœ¬åœ°äº‹åŠ¡çš„åŒæ—¶ï¼Œä¼šè°ƒç”¨ä¸Šä¸€é˜¶æ®µçš„è¡¥å¿æ“ä½œï¼Œåœ¨ä¸šåŠ¡å¤±è´¥æ—¶æœ€ç»ˆä¼šä½¿äº‹åŠ¡å›žåˆ°åˆå§‹çŠ¶æ€ Sagaä¸ŽTCCç±»ä¼¼ï¼ŒåŒæ ·æ²¡æœ‰å…¨å±€é”ã€‚ç”±äºŽç›¸æ¯”ç¼ºå°‘é”å®šèµ„æºè¿™ä¸€æ­¥ï¼Œåœ¨æŸäº›é€‚åˆçš„åœºæ™¯ï¼ŒSagaè¦æ¯”TCCå®žçŽ°èµ·æ¥æ›´ç®€å•ã€‚ç”±äºŽSagaå’ŒTCCéƒ½éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ç¼–ç å®žçŽ°ï¼Œæ‰€ä»¥åœ¨å¼€å‘æ—¶æˆ‘ä»¬éœ€è¦å‚è€ƒä¸€äº›è®¾è®¡ä¸Šçš„è§„èŒƒï¼Œç”±äºŽä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œå¯ä»¥å‚è€ƒåˆ†å¸ƒå¼äº‹åŠ¡ Seata åŠå…¶ä¸‰ç§æ¨¡å¼è¯¦è§£ åœ¨æˆ‘ä»¬äº†è§£å®Œå››ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„åŽŸç†ä¹‹åŽï¼Œæˆ‘ä»¬å›žåˆ°æœ¬æ–‡é‡ç‚¹ATæ¨¡å¼ AT å¦‚ä½•ä½¿ç”¨æ¨¡æ‹Ÿéœ€æ±‚ï¼šä»¥ä¸‹è®¢å•ä¸ºä¾‹ï¼Œåœ¨åˆ†å¸ƒå¼çš„ç”µå•†åœºæ™¯ä¸­ï¼Œè®¢å•æœåŠ¡å’Œåº“å­˜æœåŠ¡å¯èƒ½æ˜¯ä¸¤ä¸ªæ•°æ®åº“ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ATæ¨¡å¼ä¸‹çš„ä»£ç æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œè¿™é‡Œå¿½ç•¥äº†Seataçš„ç›¸å…³é…ç½®ï¼Œåªçœ‹ä¸šåŠ¡éƒ¨åˆ† åœ¨éœ€è¦å¼€å¯åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ³•ä¸Šæ ‡è®°@GlobalTransactionalï¼Œç„¶åŽæ‰§è¡Œåˆ†åˆ«æ‰§è¡Œæ‰£å‡åº“å­˜å’Œåˆ›å»ºè®¢å•æ“ä½œï¼Œäº‹åŠ¡çš„å‚ä¸Žè€…å¯ä»¥æ˜¯æœ¬åœ°çš„æ•°æ®æºï¼Œæˆ–è€…RPCçš„è¿œç¨‹è°ƒç”¨ï¼ˆè¿œç¨‹è°ƒç”¨çš„è¯éœ€è¦æºå¸¦å…¨å±€äº‹åŠ¡IDï¼Œä¹Ÿå°±æ˜¯ä¸Šå›¾çš„xidï¼‰ AT ä¸€é˜¶æ®µä¹‹å‰è¯´è¿‡ATæ¨¡å¼åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µåŒ…æ‹¬æäº¤ä¸šåŠ¡æ•°æ®å’Œå›žæ»šæ—¥å¿—ï¼ˆundoLogï¼‰ï¼Œç¬¬ä¸€é˜¶æ®µå…·ä½“æµç¨‹å¦‚ä¸‹å›¾ GlobalTransactional åˆ‡é¢æ ‡è®°@GlobalTransactionalçš„æ–¹æ³•é€šè¿‡AOPå®žçŽ°äº†ï¼Œå¼€å¯å…¨å±€äº‹åŠ¡å’Œæäº¤å…¨å±€äº‹åŠ¡ä¸¤ä¸ªæ“ä½œï¼Œä¸ŽSpring äº‹åŠ¡æœºåˆ¶ç±»ä¼¼ï¼Œå½“ GlobalTransactionalInterceptor åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ•èŽ·åˆ°Throwableæ—¶ï¼Œä¼šå‘èµ·å…¨å±€äº‹åŠ¡å›žæ»š 0.1 æ­¥éª¤ä¸­ä¼šç”Ÿæˆä¸€ä¸ªå…¨å±€äº‹åŠ¡ID 0.2 æ‰€æœ‰äº‹åŠ¡å‚ä¸Žè€…æ‰§è¡Œç»“æŸåŽï¼Œä¸€é˜¶æ®µäº‹åŠ¡æäº¤ undoLogæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Seata undoLog çš„ç»“æž„1234567891011// çœç•¥äº†ç›¸å…³æ–¹æ³•public class SQLUndoLog &#123; // insert, update ... private SQLType sqlType; private String tableName; private TableRecords beforeImage; private TableRecords afterImage;&#125; Seata åœ¨æ‰§è¡Œä¸šåŠ¡SQLå‰åŽï¼Œä¼šç”ŸæˆbeforeImageå’ŒafterImageï¼Œåœ¨éœ€è¦å›žæ»šæ—¶ï¼Œæ ¹æ®SQLTypeï¼Œå†³å®šå…·ä½“çš„å›žæ»šç­–ç•¥ï¼Œä¾‹å¦‚SQLType=updateæ—¶ï¼Œå°†æ•°æ®å›žæ»šåˆ°beforeImageçš„çŠ¶æ€ï¼Œå¦‚æžœSQLType=insertï¼Œåˆ™æ ¹æ®afterImageåˆ é™¤æ•°æ® å¦‚2.4æ‰€ç¤ºï¼Œæ¯æ¡ä¸šåŠ¡SQLï¼Œæ‰§è¡ŒæˆåŠŸåŽï¼Œä¼šä¸ºè¿™æ¡SQLç”ŸæˆLockKeyï¼Œæ ¼å¼ä¸ºtableName:PrimaryKey æ³¨å†Œåˆ†æ”¯äº‹åŠ¡åœ¨3.1æ­¥éª¤æ³¨å†Œåˆ†æ”¯äº‹åŠ¡æ—¶ï¼Œclientä¼šæŠŠæ‰€æœ‰çš„LockKey æ‹¼åˆ°ä¸€èµ·ä½œä¸ºå…¨å±€é”å‘é€ç»™Seata-serverã€‚å¦‚æžœæ³¨å†ŒæˆåŠŸï¼Œå†™å…¥undoLogï¼Œå¹¶æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œä¸€é˜¶æ®µç»“æŸï¼Œç­‰å¾…äºŒé˜¶æ®µåé¦ˆ å¦‚æžœå½“å‰æœ‰å…¶ä»–åˆ†æ”¯äº‹åŠ¡å·²ç»æŒæœ‰äº†ç›¸åŒçš„é”ï¼ˆå³å…¶ä»–äº‹åŠ¡ä¹Ÿåœ¨å¤„ç†ç›¸åŒè¡¨çš„åŒä¸€è¡Œï¼‰ï¼Œåˆ™client æ³¨å†Œäº‹åŠ¡åˆ†æ”¯å¤±è´¥ã€‚clientä¼šæ ¹æ®å®¢æˆ·ç«¯å®šä¹‰çš„é‡å‘æ—¶é—´å’Œé‡å‘æ¬¡æ•°è¿›è¡Œä¸æ–­çš„å°è¯•ï¼Œå¦‚æžœé‡è¯•ç»“æŸä»ç„¶æ²¡æœ‰èŽ·å¾—é”ï¼Œåˆ™ä¸€é˜¶æ®µå¤±è´¥ï¼Œæœ¬åœ°äº‹åŠ¡å›žæ»šã€‚å¦‚æžœè¯¥å…¨å±€äº‹åŠ¡å­˜åœ¨å·²ç»æ³¨å†ŒæˆåŠŸåˆ†æ”¯äº‹åŠ¡ï¼ŒSeata-server è¿›è¡ŒäºŒé˜¶æ®µå›žæ»š å…¨å±€é”ä¼šåœ¨åˆ†æ”¯äº‹åŠ¡äºŒé˜¶æ®µç»“æŸåŽé‡Šæ”¾ Seata å…¨å±€é”çš„è®¾è®¡æ˜¯ä¸ºäº†ä»€ä¹ˆï¼Ÿä»¥æ‰£å‡åº“å­˜åœºæ™¯ä¸ºä¾‹ï¼ŒTX1 å®Œæˆåº“å­˜æ‰£å‡çš„ä¸€é˜¶æ®µï¼Œåº“å­˜ä»Ž100æ‰£å‡ä¸º99ï¼Œæ­£åœ¨ç­‰å¾…äºŒé˜¶æ®µçš„é€šçŸ¥ã€‚TX2ä¹Ÿè¦æ‰£å‡åŒä¸€å•†å“çš„åº“å­˜ï¼Œå¦‚æžœæ²¡æœ‰å…¨å±€é”çš„é™åˆ¶ï¼ŒTX2åº“å­˜ä»Ž99æ‰£å‡ä¸º98ï¼Œè¿™æ—¶å¦‚æžœTX1æŽ¥æ”¶åˆ°å›žæ»šé€šçŸ¥ï¼Œè¿›è¡Œå›žæ»šæŠŠåº“å­˜ä»Ž98å›žæ»šåˆ°100ã€‚å› ä¸ºæ²¡æœ‰å…¨å±€é”ï¼Œé€ æˆäº†è„å†™ AT äºŒé˜¶æ®µäºŒé˜¶æ®µæ˜¯å®Œå…¨å¼‚æ­¥åŒ–çš„å¹¶ä¸”å®Œå…¨ç”±SeataæŽ§åˆ¶ï¼ŒSeataæ ¹æ®æ‰€æœ‰äº‹åŠ¡å‚ä¸Žè€…çš„æäº¤æƒ…å†µå†³å®šäºŒé˜¶æ®µå¦‚ä½•å¤„ç† å¦‚æžœæ‰€æœ‰äº‹åŠ¡æäº¤æˆåŠŸï¼Œåˆ™äºŒé˜¶æ®µçš„ä»»åŠ¡å°±æ˜¯åˆ é™¤ä¸€é˜¶æ®µç”Ÿæˆ çš„undoLogï¼Œå¹¶é‡Šæ”¾å…¨å±€é” å¦‚æžœéƒ¨åˆ†äº‹åŠ¡å‚ä¸Žè€…æäº¤å¤±è´¥ï¼Œåˆ™éœ€è¦æ ¹æ®undoLogå¯¹å·²ç»æ³¨å†Œçš„äº‹åŠ¡åˆ†æ”¯è¿›è¡Œå›žæ»šï¼Œå¹¶é‡Šæ”¾å…¨å±€é” å¯¹Seataæå‡ºçš„ç–‘é—®è‡³æ­¤æˆ‘ä»¬å·²ç»åˆæ­¥äº†è§£äº†Seataçš„ATæ¨¡å¼æ˜¯å¦‚ä½•å®žçŽ°çš„äº† å¦‚æžœä½ ä¹Ÿå’Œæˆ‘ä¸€æ ·ï¼Œä»”ç»†æ€è€ƒäº†ä¸Šè¿°è¿‡ç¨‹ï¼Œå¯èƒ½ä¼šæå‡ºä¸€äº›é—®é¢˜ï¼Œè¿™è¾¹æˆ‘åˆ—ä¸¾ä¸€ä¸‹æˆ‘åœ¨å­¦ä¹ Seataæ—¶ï¼Œé‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠæˆ‘å¾—å‡ºçš„ç»“è®º é—®é¢˜1. Seataå¦‚ä½•åšåˆ°æ— ä¾µå…¥çš„åˆ†æžä¸šåŠ¡SQLç”ŸæˆundoLogï¼Œæ³¨å†Œäº‹åŠ¡åˆ†æ”¯ç­‰æ“ä½œï¼Ÿ Seata ä»£ç†äº†DataSourceï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä»£ç æ³¨å…¥ä¸€ä¸ªDataSourceæ¥éªŒè¯æˆ‘çš„è¯´æ³•ï¼Œç›®å‰çš„DataSource æ˜¯ io.seata.rm.datasource.DataSourceProxy æ‰€æœ‰çš„JavaæŒä¹…åŒ–æ¡†æž¶ï¼Œæœ€ç»ˆåœ¨æ“ä½œæ•°æ®åº“æ—¶éƒ½ä¼šé€šè¿‡DataSourceæŽ¥å£èŽ·å–Connectionï¼Œé€šè¿‡Connection å®žçŽ°å¯¹æ•°æ®åº“çš„å¢žåˆ æ”¹æŸ¥ï¼Œäº‹åŠ¡æŽ§åˆ¶ã€‚ Seata é€šè¿‡ä»£ç†Connectionçš„æ–¹å¼ï¼Œåšåˆ°äº†æ— ä¾µå…¥çš„ç”ŸæˆundoLogï¼Œæ³¨å†Œäº‹åŠ¡åˆ†æ”¯ï¼Œå…·ä½“æºç å¯ä»¥æŸ¥çœ‹io.seata.rm.datasource.ConnectionProxy é—®é¢˜2. ConnectionProxy å¦‚ä½•åˆ¤æ–­å½“å‰äº‹åŠ¡æ˜¯å…¨å±€äº‹åŠ¡ï¼Œè¿˜æ˜¯æœ¬åœ°äº‹åŠ¡ï¼Ÿ é€šè¿‡å½“å‰çº¿ç¨‹æ˜¯å¦ç»‘å®šäº†å…¨å±€äº‹åŠ¡idï¼Œåœ¨è¿›è¡Œå…¨å±€äº‹åŠ¡ä¹‹å‰ï¼Œéœ€è¦è°ƒç”¨RootContext.bind(xid); é—®é¢˜3. å…¨å±€äº‹åŠ¡å¹¶å‘æ›´æ–° è¿˜æ˜¯ä»¥ä¸‹è®¢å•æ‰£å‡åº“å­˜çš„åœºæ™¯ä¸ºä¾‹ï¼Œå¦‚æžœTX1å’ŒTX2åŒæ—¶æ‰£å‡product_idä¸º1çš„åº“å­˜ï¼Œè¿™æ—¶Seataä¼šä¸ä¼šç”Ÿæˆç›¸åŒçš„beforeImageï¼Ÿ ä¸¾ä¸ªä¾‹å­ï¼ŒTX1è¯»åº“å­˜ä¸º100ï¼ŒTX1æ‰£å‡åº“å­˜1ï¼Œæ­¤æ—¶BeforeImageä¸º100ç´§æŽ¥ç€ å¦‚æžœTX2è¯»åº“å­˜ä¹Ÿä¸º100ï¼Œé‚£ä¹ˆå°±æœ‰é—®é¢˜äº†ï¼Œä¸ç®¡TX2æ‰£å‡å¤šå°‘åº“å­˜ï¼Œå¦‚æžœTX1å›žæ»šé‚£ä¹ˆç›¸å½“äºŽè¦†ç›–äº†TX2æ‰£å‡çš„åº“å­˜ï¼Œå‡ºçŽ°äº†è„å†™ Seataæ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Ÿ æºç ä½ç½®ï¼šio.seata.rm.datasource.exec.AbstractDMLBaseExecutor::executeAutoCommitFalse å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„é€»è¾‘å’Œæˆ‘ä¸Šé¢ç”»çš„å›¾ä¸€è‡´ï¼Œè¯æ˜Žæˆ‘æ²¡æœ‰çžŽè¯´ ðŸ˜„ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹beforeImage()ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹ä»–çš„å­ç±»UpdateExecutoræ˜¯å¦‚ä½•å®žçŽ°çš„ é€šè¿‡Debugï¼Œå¯ä»¥çœ‹å‡ºSeataè¿™è¾¹ä¹Ÿæ˜¯ç¡®å®žè€ƒè™‘äº†è¿™ä¸ªé—®é¢˜ï¼Œç›´æŽ¥ç®€å•è€Œæœ‰æ•ˆçš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ å›žåˆ°æˆ‘ä»¬çš„ä¾‹å­ï¼Œç”±äºŽSELECT FOR UPDATEçš„å­˜åœ¨ï¼ŒTX2å¦‚æžœä¹Ÿæƒ³è¯»åŒä¸€æ¡æ•°æ®çš„è¯ï¼Œåªèƒ½ç­‰åˆ°TX1 æäº¤äº‹åŠ¡åŽï¼Œæ‰èƒ½è¯»åˆ°ã€‚æ‰€ä»¥é—®é¢˜è§£å†³ é—®é¢˜4. å…¨å±€äº‹åŠ¡å¤–çš„æ›´æ–° æˆ‘ä»¬çŽ°åœ¨å¯ä»¥ç¡®è®¤åœ¨Seataçš„ä¿è¯ä¸‹ï¼Œå…¨å±€äº‹åŠ¡ï¼Œä¸ä¼šé€ æˆæ•°æ®çš„è„å†™ï¼Œä½†æ˜¯å…¨å±€äº‹åŠ¡å¤–ä¼šï¼ ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ è¿˜ä»¥åº“å­˜ä¸ºä¾‹ ç”¨æˆ·æ­£åœ¨æŠ¢è´­ï¼Œç”¨æˆ·Aå®Œæˆäº†1é˜¶æ®µçš„åº“å­˜æ‰£å‡ï¼Œè¿™ä¸ªæ—¶å€™åº“å­˜ä¸º99ã€‚ æ­¤æ—¶åº“å­˜ç®¡ç†å‘˜ä¸Šçº¿äº†ï¼Œä»–æŸ¥äº†ä¸€ä¸‹åº“å­˜ä¸º99ã€‚å—¯â€¦å¤ªå°‘äº†ï¼Œæˆ‘åŠ 100ä¸ªï¼Œåº“å­˜ç®¡ç†å‘˜æŠŠåº“å­˜æ›´æ–°ä¸º200ã€‚ è€Œæ­¤æ—¶seataç»™ç”¨æˆ·Aç”ŸæˆbeforeImageä¸º100ï¼Œå¦‚æžœæ­¤æ—¶ç”¨æˆ·Açš„å…¨å±€äº‹åŠ¡å¤±è´¥äº†ï¼Œå‘ç”Ÿäº†å›žæ»šï¼Œå†æ¬¡å°†åº“å­˜æ›´æ–°ä¸º100â€¦ å†æ¬¡å‡ºçŽ°è„å†™ Seata é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæä¾›äº†@GlobalLockæ³¨è§£ï¼Œæ ‡è®°è¯¥æ³¨è§£æ—¶ï¼Œä¼šåƒå…¨å±€äº‹åŠ¡ä¸€æ ·è¿›è¡ŒSQLåˆ†æžï¼Œç«žäº‰å…¨å±€é”ï¼Œå°±ä¸ä¼šå‡ºçŽ°ä¸Šè¿°é—®é¢˜äº† å…³äºŽè¿™ä¸ªé—®é¢˜å¯ä»¥å‚è€ƒSeataçš„FAQæ–‡æ¡£ http://seata.io/zh-cn/docs/overview/faq.html é—®é¢˜5. @GlobalTransactional å’Œ @Transactional åŒæ—¶ä½¿ç”¨ä¼šæ€Žä¹ˆæ · æˆ‘ä»¬ä¸Šæ–‡ä¸­å·²ç»è¯´è¿‡äº† @GlobalTransactional çš„ä½œç”¨äº†ï¼Œä»–æ˜¯è´Ÿè´£å¼€å¯å…¨å±€äº‹åŠ¡/æäº¤äº‹åŠ¡1é˜¶æ®µï¼Œè¯´ç™½äº†@GlobalTransactional åªå’ŒSeata-server äº¤äº’ï¼Œè€Œ @Transactional ç®¡ç†çš„æ˜¯æœ¬åœ°æ•°æ®åº“çš„äº‹åŠ¡ï¼Œæ‰€ä»¥äºŒè€…ä¸å‘ç”Ÿå†²çªã€‚ ä½†æ˜¯éœ€è¦æ³¨æ„ @GlobalTransactional AOP è¦†ç›–èŒƒå›´ä¸€å®šè¦å¤§äºŽ @Transactional é—®é¢˜6. å¦‚æžœå…¶ä¸­æŸä¸€ä¸ªäº‹åŠ¡åˆ†æ”¯è¶…æ—¶æœªæäº¤ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆ è¿™ä¸ªæˆ‘å¹¶æ²¡æœ‰çœ‹æºç ï¼Œè€Œæ˜¯é€šè¿‡è·‘demoï¼ŒéªŒè¯çš„ ä¾‹å¦‚çŽ°åœ¨æœ‰Aï¼ŒBä¸¤ä¸ªäº‹åŠ¡åˆ†æ”¯ A æ­£å¸¸æäº¤ï¼Œå¹¶å‘Seataæ³¨å†Œåˆ†æ”¯æˆåŠŸ B 2åˆ†é’ŸåŽæäº¤äº‹åŠ¡ï¼Œå¹¶å‘Seataå‘èµ·æ³¨å†Œ Seataçš„å…¨å±€äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯1åˆ†é’Ÿï¼ŒSeata-server åœ¨æ£€æµ‹åˆ°æœ‰è¶…æ—¶çš„å…¨å±€äº‹åŠ¡æ—¶ï¼Œä¼šå‘æ‰€æœ‰å·²æäº¤çš„åˆ†æ”¯ï¼Œå‘èµ·å›žæ»šã€‚è€Œè¶…æ—¶æäº¤çš„äº‹åŠ¡ï¼Œå‘Seata-serverå‘èµ·åˆ†æ”¯æ³¨å†Œæ—¶ï¼Œå“åº”ç»“æžœä¸ºäº‹åŠ¡å·²è¶…æ—¶ï¼Œæˆ–è€…äº‹åŠ¡ä¸å­˜åœ¨ï¼Œä¹Ÿä¼šå›žæ»šæœ¬åœ°äº‹åŠ¡ é—®é¢˜7. Seata-client å¦‚ä½•æŽ¥æ”¶Seata-serverå‘èµ·çš„é€šçŸ¥ Seata-client åŒ…å«äº†NettyæœåŠ¡ï¼Œåœ¨å¯åŠ¨æ—¶Nettyä¼šç›‘å¬ç«¯å£ï¼Œå¹¶å‘Seata-server å‘èµ·æ³¨å†Œã€‚serverä¸­å­˜å‚¨äº†client çš„è°ƒç”¨åœ°å€ã€‚ æ€»ç»“æˆ‘ä»¬å­¦ä¹ äº†Seataçš„ATæ¨¡å¼æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå¯ä»¥çœ‹å‡ºSeataæ¨¡å¼åœ¨å¼€å‘ä¸Šæ˜¯éžå¸¸ç®€å•çš„ï¼Œä½†æ˜¯Seataçš„èƒŒåŽä¸ºäº†ç»´æŒåˆ†å¸ƒå¼äº‹åŠ¡çš„æ•°æ®ä¸€è‡´æ€§ï¼Œåšäº†å¤§é‡çš„å·¥ä½œï¼ŒATæ¨¡å¼éžå¸¸é€‚åˆçŽ°æœ‰çš„ä¸šåŠ¡æ¨¡åž‹ç›´æŽ¥è¿ç§»ã€‚ ä½†æ˜¯ä»–çš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜Žæ˜¾ï¼Œæ€§èƒ½å¹¶ä¸æ˜¯é‚£ä¹ˆçš„ä¼˜ç§€ã€‚ä¾‹å¦‚æˆ‘ä»¬åˆšåˆšçœ‹åˆ°çš„å…¨å±€é”çš„é—®é¢˜ï¼Œä¸ºäº†æ•°æ®ä¸ä¼šå‘ç”Ÿè„å†™ï¼ŒSeataç‰ºç‰²äº†ä¸šåŠ¡çš„å¹¶å‘èƒ½åŠ›ã€‚åœ¨éžå¸¸è¦æ±‚æ€§èƒ½çš„åœºæ™¯ï¼Œå¯èƒ½è¿˜æ˜¯éœ€è¦è€ƒè™‘TCCï¼ŒSAGAï¼Œå¯é æ¶ˆæ¯ç­‰æ–¹æ¡ˆ åœ¨ä½¿ç”¨Seataå¼€å‘å‰ï¼Œå»ºè®®å¤§å®¶å…ˆåŽ»é˜…è¯»ä¸€ä¸‹FAQæ–‡æ¡£ï¼Œé¿å…è¸©å‘ https://seata.io/zh-cn/docs/overview/faq.html DEMOhttps://github.com/TavenYin/taven-springboot-learning/tree/master/springboot-seata å‚è€ƒSeataæ˜¯ä»€ä¹ˆ - http://seata.io/zh-cn/docs/overview/what-is-seata.htmlSeataå¸¸è§é—®é¢˜ - http://seata.io/zh-cn/docs/overview/faq.htmlåˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶ Seata çš„è®¾è®¡åŽŸç† - http://seata.io/zh-cn/blog/seata-at-mode-design.htmlåˆ†å¸ƒå¼äº‹åŠ¡ Seata åŠå…¶ä¸‰ç§æ¨¡å¼è¯¦è§£ - http://seata.io/zh-cn/blog/seata-at-tcc-saga.htmlåˆ†å¸ƒå¼äº‹åŠ¡å¦‚ä½•å®žçŽ°ï¼Ÿæ·±å…¥è§£è¯» Seata çš„ XA æ¨¡å¼ - http://seata.io/zh-cn/blog/seata-xa-introduce.html]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>Seata</tag>
        <tag>åˆ†å¸ƒå¼äº‹åŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…å…¥æµ…å‡º Spring äº‹åŠ¡ä¼ æ’­å®žçŽ°åŽŸç†]]></title>
    <url>%2Fpost%2Fbef5c7fd.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡å’Œå¤§å®¶ä¸€èµ·åˆ¨æž Spring äº‹åŠ¡çš„ç›¸å…³æºç ï¼Œç¯‡å¹…è¾ƒé•¿ï¼Œä»£ç ç‰‡æ®µè¾ƒå¤šï¼Œå»ºè®®ä½¿ç”¨ç”µè„‘é˜…è¯» æœ¬æ–‡ç›®æ ‡ ç†è§£Springäº‹åŠ¡ç®¡ç†æ ¸å¿ƒæŽ¥å£ ç†è§£Springäº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒé€»è¾‘ ç†è§£äº‹åŠ¡çš„ä¼ æ’­ç±»åž‹åŠå…¶å®žçŽ°åŽŸç† ç‰ˆæœ¬SpringBoot 2.3.3.RELEASE ä»€ä¹ˆæ˜¯äº‹åŠ¡çš„ä¼ æ’­ï¼ŸSpring é™¤äº†å°è£…äº†äº‹åŠ¡æŽ§åˆ¶ä¹‹å¤–ï¼Œè¿˜æŠ½è±¡å‡ºäº† äº‹åŠ¡çš„ä¼ æ’­ è¿™ä¸ªæ¦‚å¿µï¼Œäº‹åŠ¡çš„ä¼ æ’­å¹¶ä¸æ˜¯å…³ç³»åž‹æ•°æ®åº“æ‰€å®šä¹‰çš„ï¼Œè€Œæ˜¯Springåœ¨å°è£…äº‹åŠ¡æ—¶åšçš„å¢žå¼ºæ‰©å±•ï¼Œå¯ä»¥é€šè¿‡@Transactional æŒ‡å®šäº‹åŠ¡çš„ä¼ æ’­ï¼Œå…·ä½“ç±»åž‹å¦‚ä¸‹ äº‹åŠ¡ä¼ æ’­è¡Œä¸ºç±»åž‹ è¯´æ˜Ž PROPAGATION_REQUIRED å¦‚æžœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ï¼Œå¦‚æžœå·²ç»å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼ŒåŠ å…¥åˆ°è¿™ä¸ªäº‹åŠ¡ä¸­ã€‚Springçš„é»˜è®¤äº‹åŠ¡ä¼ æ’­ç±»åž‹ PROPAGATION_SUPPORTS æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æžœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éžäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚ PROPAGATION_MANDATORY ä½¿ç”¨å½“å‰çš„äº‹åŠ¡ï¼Œå¦‚æžœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ã€‚ PROPAGATION_REQUIRES_NEW æ–°å»ºäº‹åŠ¡ï¼Œå¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ï¼ˆæš‚åœï¼‰ã€‚ PROPAGATION_NOT_SUPPORTED ä»¥éžäº‹åŠ¡æ–¹å¼æ‰§è¡Œæ“ä½œï¼Œå¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œå°±æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚ PROPAGATION_NEVER ä»¥éžäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ PROPAGATION_NESTED å¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œã€‚å¦‚æžœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æ‰§è¡Œä¸ŽPROPAGATION_REQUIREDç±»ä¼¼çš„æ“ä½œã€‚ ä¸¾ä¸ªæ —å­ä»¥åµŒå¥—äº‹åŠ¡ä¸ºä¾‹123456789101112131415161718192021222324252627282930313233343536@Servicepublic class DemoServiceImpl implements DemoService &#123; @Autowired private JdbcTemplate jdbcTemplate; @Autowired private DemoServiceImpl self; @Transactional @Override public void insertDB() &#123; String sql = "INSERT INTO sys_user(`id`, `username`) VALUES (?, ?)"; jdbcTemplate.update(sql, uuid(), "taven"); try &#123; // å†…åµŒäº‹åŠ¡å°†ä¼šå›žæ»šï¼Œè€Œå¤–éƒ¨äº‹åŠ¡ä¸ä¼šå—åˆ°å½±å“ self.nested(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; @Transactional(propagation = Propagation.NESTED) @Override public void nested() &#123; String sql = "INSERT INTO sys_user(`id`, `username`) VALUES (?, ?)"; jdbcTemplate.update(sql, uuid(), "nested"); throw new RuntimeException("rollback nested"); &#125; private String uuid() &#123; return UUID.randomUUID().toString(); &#125;&#125; ä¸Šè¿°ä»£ç ä¸­ï¼Œnested()æ–¹æ³•æ ‡è®°äº†äº‹åŠ¡ä¼ æ’­ç±»åž‹ä¸ºåµŒå¥—ï¼Œå¦‚æžœnested()ä¸­æŠ›å‡ºå¼‚å¸¸ä»…ä¼šå›žæ»šnested()æ–¹æ³•ä¸­çš„sqlï¼Œä¸ä¼šå½±å“åˆ°insertDB()æ–¹æ³•ä¸­å·²ç»æ‰§è¡Œçš„sql æ³¨æ„ï¼šservice è°ƒç”¨å†…éƒ¨æ–¹æ³•æ—¶ï¼Œå¦‚æžœç›´æŽ¥ä½¿ç”¨thisè°ƒç”¨ï¼Œäº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆã€‚å› æ­¤ä½¿ç”¨thisè°ƒç”¨ç›¸å½“äºŽè·³è¿‡äº†å¤–éƒ¨çš„ä»£ç†ç±»ï¼Œæ‰€ä»¥AOPä¸ä¼šç”Ÿæ•ˆï¼Œæ— æ³•ä½¿ç”¨äº‹åŠ¡ æ€è€ƒä¼—æ‰€å‘¨çŸ¥ï¼ŒSpring äº‹åŠ¡æ˜¯é€šè¿‡AOPå®žçŽ°çš„ï¼Œå¦‚æžœæ˜¯æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªAOPæŽ§åˆ¶äº‹åŠ¡ï¼Œè¯¥æ€Žä¹ˆåšå‘¢ï¼Ÿ1234567891011121314151617// ä¼ªä»£ç public Object invokeWithinTransaction() &#123; // å¼€å¯äº‹åŠ¡ connection.beginTransaction(); try &#123; // åå°„æ‰§è¡Œæ–¹æ³• Object result = invoke(); // æäº¤äº‹åŠ¡ connection.commit(); return result; &#125; catch(Exception e) &#123; // å‘ç”Ÿå¼‚å¸¸æ—¶å›žæ»š connection.rollback(); throw e; &#125; &#125; åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹å¦‚æžœæ˜¯æˆ‘ä»¬è‡ªå·±åšçš„è¯ï¼Œäº‹åŠ¡çš„ä¼ æ’­è¯¥å¦‚ä½•å®žçŽ° ä»¥PROPAGATION_REQUIREDä¸ºä¾‹ï¼Œè¿™ä¸ªä¼¼ä¹Žå¾ˆç®€å•ï¼Œæˆ‘ä»¬åˆ¤æ–­ä¸€ä¸‹å½“å‰æ˜¯å¦æœ‰äº‹åŠ¡ï¼ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ThreadLocalå­˜å‚¨å·²å­˜åœ¨çš„äº‹åŠ¡å¯¹è±¡ï¼‰ï¼Œå¦‚æžœæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå°±ä¸å¼€å¯æ–°çš„äº‹åŠ¡ã€‚åä¹‹ï¼Œæ²¡æœ‰äº‹åŠ¡ï¼Œæˆ‘ä»¬å°±åˆ›å»ºæ–°çš„äº‹åŠ¡ å¦‚æžœäº‹åŠ¡æ˜¯ç”±å½“å‰åˆ‡é¢å¼€å¯çš„ï¼Œåˆ™æäº¤/å›žæ»šäº‹åŠ¡ï¼Œåä¹‹ä¸åšå¤„ç† é‚£ä¹ˆäº‹åŠ¡ä¼ æ’­ä¸­æè¿°çš„æŒ‚èµ·ï¼ˆæš‚åœï¼‰å½“å‰äº‹åŠ¡ï¼Œå’Œå†…åµŒäº‹åŠ¡æ˜¯å¦‚ä½•å®žçŽ°çš„ï¼Ÿ æºç å…¥æ‰‹è¦é˜…è¯»äº‹åŠ¡ä¼ æ’­ç›¸å…³çš„æºç ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹Spring äº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒæŽ¥å£ä¸Žç±» TransactionDefinitionè¯¥æŽ¥å£å®šä¹‰äº†äº‹åŠ¡çš„æ‰€æœ‰å±žæ€§ï¼ˆéš”ç¦»çº§åˆ«ï¼Œä¼ æ’­ç±»åž‹ï¼Œè¶…æ—¶æ—¶é—´ç­‰ç­‰ï¼‰ï¼Œæˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨çš„ @Transactional å…¶å®žæœ€ç»ˆä¼šè¢«è½¬åŒ–ä¸º TransactionDefinition TransactionStatusäº‹åŠ¡çš„çŠ¶æ€ï¼Œä»¥æœ€å¸¸ç”¨çš„å®žçŽ° DefaultTransactionStatus ä¸ºä¾‹ï¼Œè¯¥ç±»å­˜å‚¨äº†å½“å‰çš„äº‹åŠ¡å¯¹è±¡ï¼Œsavepointï¼Œå½“å‰æŒ‚èµ·çš„äº‹åŠ¡ï¼Œæ˜¯å¦å®Œæˆï¼Œæ˜¯å¦ä»…å›žæ»šç­‰ç­‰ TransactionManagerè¿™æ˜¯ä¸€ä¸ªç©ºæŽ¥å£ï¼Œç›´æŽ¥ç»§æ‰¿ä»–çš„ interface æœ‰ PlatformTransactionManagerï¼ˆæˆ‘ä»¬å¹³æ—¶ç”¨çš„å°±æ˜¯è¿™ä¸ªï¼Œé»˜è®¤çš„å®žçŽ°ç±»DataSourceTransactionManagerï¼‰ä»¥åŠReactiveTransactionManagerï¼ˆå“åº”å¼äº‹åŠ¡ç®¡ç†å™¨ï¼Œç”±äºŽä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œæˆ‘ä»¬ä¸å¤šè¯´ï¼‰ ä»Žä¸Šè¿°ä¸¤ä¸ªæŽ¥å£æ¥çœ‹ï¼ŒTransactionManager çš„ä¸»è¦ä½œç”¨ é€šè¿‡TransactionDefinitionå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿”å›žTransactionStatus é€šè¿‡TransactionStatus æäº¤ã€å›žæ»šäº‹åŠ¡ï¼ˆå®žé™…å¼€å¯äº‹åŠ¡çš„Connectioné€šå¸¸å­˜å‚¨åœ¨TransactionStatusä¸­ï¼‰ 123456789101112public interface PlatformTransactionManager extends TransactionManager &#123; TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException; void commit(TransactionStatus status) throws TransactionException; void rollback(TransactionStatus status) throws TransactionException;&#125; TransactionInterceptoräº‹åŠ¡æ‹¦æˆªå™¨ï¼Œäº‹åŠ¡AOPçš„æ ¸å¿ƒç±»ï¼ˆæ”¯æŒå“åº”å¼äº‹åŠ¡ï¼Œç¼–ç¨‹å¼äº‹åŠ¡ï¼Œä»¥åŠæˆ‘ä»¬å¸¸ç”¨çš„æ ‡å‡†äº‹åŠ¡ï¼‰ï¼Œç”±äºŽç¯‡å¹…åŽŸå› ï¼Œæœ¬æ–‡åªè®¨è®ºæ ‡å‡†äº‹åŠ¡çš„ç›¸å…³å®žçŽ° ä¸‹é¢æˆ‘ä»¬ä»Žäº‹åŠ¡é€»è¾‘çš„å…¥å£ TransactionInterceptor å…¥æ‰‹ï¼Œæ¥çœ‹ä¸‹Springäº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒé€»è¾‘ä»¥åŠäº‹åŠ¡ä¼ æ’­çš„å®žçŽ° TransactionInterceptorTransactionInterceptor å®žçŽ°äº†MethodInvocationï¼ˆè¿™æ˜¯å®žçŽ°AOPçš„ä¸€ç§æ–¹å¼ï¼‰ï¼Œå…¶æ ¸å¿ƒé€»è¾‘åœ¨çˆ¶ç±»TransactionAspectSupport ä¸­ï¼Œæ–¹æ³•ä½ç½®ï¼šTransactionInterceptor::invokeWithinTransaction 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950protected Object invokeWithinTransaction(Method method, @Nullable Class&lt;?&gt; targetClass, final InvocationCallback invocation) throws Throwable &#123; // If the transaction attribute is null, the method is non-transactional. TransactionAttributeSource tas = getTransactionAttributeSource(); // å½“å‰äº‹åŠ¡çš„å±žæ€§ TransactionAttribute extends TransactionDefinition final TransactionAttribute txAttr = (tas != null ? tas.getTransactionAttribute(method, targetClass) : null); // äº‹åŠ¡å±žæ€§ä¸­å¯ä»¥å®šä¹‰å½“å‰ä½¿ç”¨å“ªä¸ªäº‹åŠ¡ç®¡ç†å™¨ // å¦‚æžœæ²¡æœ‰å®šä¹‰å°±åŽ»Springä¸Šä¸‹æ–‡æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ TransactionManager final TransactionManager tm = determineTransactionManager(txAttr); // çœç•¥äº†å“åº”å¼äº‹åŠ¡çš„å¤„ç† ... PlatformTransactionManager ptm = asPlatformTransactionManager(tm); final String joinpointIdentification = methodIdentification(method, targetClass, txAttr); if (txAttr == null || !(ptm instanceof CallbackPreferringPlatformTransactionManager)) &#123; // Standard transaction demarcation with getTransaction and commit/rollback calls. TransactionInfo txInfo = createTransactionIfNecessary(ptm, txAttr, joinpointIdentification); Object retVal; try &#123; // This is an around advice: Invoke the next interceptor in the chain. // This will normally result in a target object being invoked. // å¦‚æžœæœ‰ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨åˆ™æ‰§è¡Œï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°ç›®æ ‡æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç  retVal = invocation.proceedWithInvocation(); &#125; catch (Throwable ex) &#123; // target invocation exception // å½“æ•èŽ·åˆ°å¼‚å¸¸æ—¶å®Œæˆå½“å‰äº‹åŠ¡ ï¼ˆæäº¤æˆ–è€…å›žæ»šï¼‰ completeTransactionAfterThrowing(txInfo, ex); throw ex; &#125; finally &#123; cleanupTransactionInfo(txInfo); &#125; if (retVal != null &amp;&amp; vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) &#123; // Set rollback-only in case of Vavr failure matching our rollback rules... TransactionStatus status = txInfo.getTransactionStatus(); if (status != null &amp;&amp; txAttr != null) &#123; retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status); &#125; &#125; // æ ¹æ®äº‹åŠ¡çš„çŠ¶æ€æäº¤æˆ–è€…å›žæ»š commitTransactionAfterReturning(txInfo); return retVal; &#125; // çœç•¥äº†ç¼–ç¨‹å¼äº‹åŠ¡çš„å¤„ç† ...&#125; è¿™é‡Œä»£ç å¾ˆå¤šï¼Œæ ¹æ®æ³¨é‡Šçš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ ¸å¿ƒé€»è¾‘æ¢³ç†å‡ºæ¥ èŽ·å–å½“å‰äº‹åŠ¡å±žæ€§ï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼ˆä»¥æ³¨è§£äº‹åŠ¡ä¸ºä¾‹ï¼Œè¿™äº›éƒ½å¯ä»¥é€šè¿‡@Transactionalæ¥å®šä¹‰ï¼‰ createTransactionIfNecessaryï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¿…è¦åˆ›å»ºäº‹åŠ¡ invocation.proceedWithInvocation æ‰§è¡Œæ‹¦æˆªå™¨é“¾ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°ç›®æ ‡æ–¹æ³• completeTransactionAfterThrowingå½“æŠ›å‡ºå¼‚å¸¸åŽï¼Œå®Œæˆè¿™ä¸ªäº‹åŠ¡ï¼Œæäº¤æˆ–è€…å›žæ»šï¼Œå¹¶æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ commitTransactionAfterReturning ä»Žæ–¹æ³•å‘½åæ¥çœ‹ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæäº¤äº‹åŠ¡ã€‚ä½†æ˜¯æ·±å…¥æºç ä¸­ä¼šå‘çŽ°ï¼Œè¯¥æ–¹æ³•ä¸­ä¹ŸåŒ…å«å›žæ»šé€»è¾‘ï¼Œå…·ä½“è¡Œä¸ºä¼šæ ¹æ®å½“å‰TransactionStatusçš„ä¸€äº›çŠ¶æ€æ¥å†³å®šï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®å½“å‰TransactionStatusï¼Œæ¥æŽ§åˆ¶äº‹åŠ¡å›žæ»šï¼Œå¹¶ä¸ä¸€å®šåªèƒ½é€šè¿‡æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œè¯¦è§AbstractPlatformTransactionManager::commit æˆ‘ä»¬ç»§ç»­ï¼Œæ¥çœ‹çœ‹createTransactionIfNecessaryåšäº†ä»€ä¹ˆ TransactionAspectSupport::createTransactionIfNecessary1234567891011121314151617181920212223242526272829protected TransactionInfo createTransactionIfNecessary(@Nullable PlatformTransactionManager tm, @Nullable TransactionAttribute txAttr, final String joinpointIdentification) &#123; // If no name specified, apply method identification as transaction name. if (txAttr != null &amp;&amp; txAttr.getName() == null) &#123; txAttr = new DelegatingTransactionAttribute(txAttr) &#123; @Override public String getName() &#123; return joinpointIdentification; &#125; &#125;; &#125; TransactionStatus status = null; if (txAttr != null) &#123; if (tm != null) &#123; // é€šè¿‡äº‹åŠ¡ç®¡ç†å™¨å¼€å¯äº‹åŠ¡ status = tm.getTransaction(txAttr); &#125; else &#123; if (logger.isDebugEnabled()) &#123; logger.debug("Skipping transactional joinpoint [" + joinpointIdentification + "] because no transaction manager has been configured"); &#125; &#125; &#125; return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);&#125; createTransactionIfNecessaryä¸­çš„æ ¸å¿ƒé€»è¾‘ é€šè¿‡PlatformTransactionManagerï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰å¼€å¯äº‹åŠ¡ prepareTransactionInfo å‡†å¤‡äº‹åŠ¡ä¿¡æ¯ï¼Œè¿™ä¸ªå…·ä½“åšäº†ä»€ä¹ˆæˆ‘ä»¬ç¨åŽå†è®² ç»§ç»­æ¥çœ‹PlatformTransactionManager::getTransactionï¼Œè¯¥æ–¹æ³•åªæœ‰ä¸€ä¸ªå®žçŽ° AbstractPlatformTransactionManager::getTransaction 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException &#123; // Use defaults if no transaction definition given. TransactionDefinition def = (definition != null ? definition : TransactionDefinition.withDefaults()); // èŽ·å–å½“å‰äº‹åŠ¡ï¼Œè¯¥æ–¹æ³•æœ‰ç»§æ‰¿ AbstractPlatformTransactionManager çš„å­ç±»è‡ªè¡Œå®žçŽ° Object transaction = doGetTransaction(); boolean debugEnabled = logger.isDebugEnabled(); // å¦‚æžœç›®å‰å­˜åœ¨äº‹åŠ¡ if (isExistingTransaction(transaction)) &#123; // Existing transaction found -&gt; check propagation behavior to find out how to behave. return handleExistingTransaction(def, transaction, debugEnabled); &#125; // Check definition settings for new transaction. if (def.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123; throw new InvalidTimeoutException("Invalid transaction timeout", def.getTimeout()); &#125; // ä¼ æ’­ç±»åž‹PROPAGATION_MANDATORY, è¦æ±‚å½“å‰å¿…é¡»æœ‰äº‹åŠ¡ // No existing transaction found -&gt; check propagation behavior to find out how to proceed. if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123; throw new IllegalTransactionStateException( "No existing transaction found for transaction marked with propagation 'mandatory'"); &#125; // PROPAGATION_REQUIRED, PROPAGATION_REQUIRES_NEW, PROPAGATION_NESTED ä¸å­˜åœ¨äº‹åŠ¡æ—¶åˆ›å»ºäº‹åŠ¡ else if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED || def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW || def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123; SuspendedResourcesHolder suspendedResources = suspend(null); if (debugEnabled) &#123; logger.debug("Creating new transaction with name [" + def.getName() + "]: " + def); &#125; try &#123; // å¼€å¯äº‹åŠ¡ return startTransaction(def, transaction, debugEnabled, suspendedResources); &#125; catch (RuntimeException | Error ex) &#123; resume(null, suspendedResources); throw ex; &#125; &#125; else &#123; // Create "empty" transaction: no actual transaction, but potentially synchronization. if (def.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123; logger.warn("Custom isolation level specified but no actual transaction initiated; " + "isolation level will effectively be ignored: " + def); &#125; boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); return prepareTransactionStatus(def, null, true, newSynchronization, debugEnabled, null); &#125;&#125; ä»£ç å¾ˆå¤šï¼Œé‡ç‚¹å…³æ³¨æ³¨é‡Šéƒ¨åˆ†å³å¯ doGetTransactionèŽ·å–å½“å‰äº‹åŠ¡ å¦‚æžœå­˜åœ¨äº‹åŠ¡ï¼Œåˆ™è°ƒç”¨handleExistingTransactionå¤„ç†ï¼Œè¿™ä¸ªæˆ‘ä»¬ç¨åŽä¼šè®²åˆ° æŽ¥ä¸‹æ¥ï¼Œä¼šæ ¹æ®äº‹åŠ¡çš„ä¼ æ’­å†³å®šæ˜¯å¦å¼€å¯äº‹åŠ¡ å¦‚æžœäº‹åŠ¡ä¼ æ’­ç±»åž‹ä¸ºPROPAGATION_MANDATORYï¼Œä¸”ä¸å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ å¦‚æžœä¼ æ’­ç±»åž‹ä¸º PROPAGATION_REQUIRED, PROPAGATION_REQUIRES_NEW, PROPAGATION_NESTEDï¼Œä¸”å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™è°ƒç”¨startTransactionåˆ›å»ºäº‹åŠ¡ å½“ä¸æ»¡è¶³ 3ã€4æ—¶ï¼Œä¾‹å¦‚ PROPAGATION_NOT_SUPPORTEDï¼Œæ­¤æ—¶ä¼šæ‰§è¡Œäº‹åŠ¡åŒæ­¥ï¼Œä½†æ˜¯ä¸ä¼šåˆ›å»ºçœŸæ­£çš„äº‹åŠ¡ Spring äº‹åŠ¡åŒæ­¥åœ¨ä¹‹å‰ä¸€ç¯‡åšå®¢ä¸­æœ‰è®²åˆ°ï¼Œä¼ é€é—¨ðŸ‘‰https://www.jianshu.com/p/7880d9a98a5f Spring å¦‚ä½•ç®¡ç†å½“å‰çš„äº‹åŠ¡æŽ¥ä¸‹æ¥è®²è®²ä¸Šé¢æåˆ°çš„doGetTransactionã€handleExistingTransactionï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯ç”±ä¸åŒçš„TransactionManagerè‡ªè¡Œå®žçŽ°çš„ æˆ‘ä»¬ä»¥SpringBooté»˜è®¤çš„TransactionManagerï¼ŒDataSourceTransactionManagerä¸ºä¾‹123456789101112131415@Overrideprotected Object doGetTransaction() &#123; DataSourceTransactionObject txObject = new DataSourceTransactionObject(); txObject.setSavepointAllowed(isNestedTransactionAllowed()); ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(obtainDataSource()); txObject.setConnectionHolder(conHolder, false); return txObject;&#125;@Overrideprotected boolean isExistingTransaction(Object transaction) &#123; DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction; return (txObject.hasConnectionHolder() &amp;&amp; txObject.getConnectionHolder().isTransactionActive());&#125; ç»“åˆ AbstractPlatformTransactionManager::getTransaction ä¸€èµ·æ¥çœ‹ï¼ŒdoGetTransaction å…¶å®žèŽ·å–çš„æ˜¯å½“å‰çš„Connectionã€‚åˆ¤æ–­å½“å‰æ˜¯å¦å­˜åœ¨äº‹åŠ¡ï¼Œæ˜¯åˆ¤æ–­DataSourceTransactionObject å¯¹è±¡ä¸­æ˜¯å¦åŒ…å«connectionï¼Œä»¥åŠconnectionæ˜¯å¦å¼€å¯äº†äº‹åŠ¡ã€‚ æˆ‘ä»¬ç»§ç»­æ¥çœ‹ä¸‹TransactionSynchronizationManager.getResource(obtainDataSource())èŽ·å–å½“å‰connectionçš„é€»è¾‘ TransactionSynchronizationManager::getResource12345678910111213141516171819202122232425262728293031323334353637383940private static final ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources = new NamedThreadLocal&lt;&gt;("Transactional resources");@Nullable// TransactionSynchronizationManager::getResourcepublic static Object getResource(Object key) &#123; // DataSourceTransactionManager è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œä»¥æ•°æ®æºä½œä¸ºkey // TransactionSynchronizationUtils::unwrapResourceIfNecessary å¦‚æžœkeyä¸ºåŒ…è£…ç±»ï¼Œåˆ™èŽ·å–è¢«åŒ…è£…çš„å¯¹è±¡ // æˆ‘ä»¬å¯ä»¥å¿½ç•¥è¯¥é€»è¾‘ Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key); Object value = doGetResource(actualKey); if (value != null &amp;&amp; logger.isTraceEnabled()) &#123; logger.trace("Retrieved value [" + value + "] for key [" + actualKey + "] bound to thread [" + Thread.currentThread().getName() + "]"); &#125; return value;&#125;/** * Actually check the value of the resource that is bound for the given key. */@Nullableprivate static Object doGetResource(Object actualKey) &#123; Map&lt;Object, Object&gt; map = resources.get(); if (map == null) &#123; return null; &#125; Object value = map.get(actualKey); // Transparently remove ResourceHolder that was marked as void... if (value instanceof ResourceHolder &amp;&amp; ((ResourceHolder) value).isVoid()) &#123; map.remove(actualKey); // Remove entire ThreadLocal if empty... if (map.isEmpty()) &#123; resources.remove(); &#125; value = null; &#125; return value;&#125; çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬èƒ½æ˜Žç™½DataSourceTransactionManageræ˜¯å¦‚ä½•ç®¡ç†çº¿ç¨‹ä¹‹é—´çš„Connectionï¼ŒThreadLocal ä¸­å­˜å‚¨ä¸€ä¸ªMapï¼Œkeyä¸ºæ•°æ®æºå¯¹è±¡ï¼Œvalueä¸ºè¯¥æ•°æ®æºåœ¨å½“å‰çº¿ç¨‹çš„Connection DataSourceTransactionManager åœ¨å¼€å¯äº‹åŠ¡åŽï¼Œä¼šè°ƒç”¨TransactionSynchronizationManager::bindResourceå°†æŒ‡å®šæ•°æ®æºçš„Connectionç»‘å®šåˆ°å½“å‰çº¿ç¨‹ AbstractPlatformTransactionManager::handleExistingTransactionæˆ‘ä»¬ç»§ç»­å›žå¤´çœ‹ï¼Œå¦‚æžœå­˜åœ¨äº‹åŠ¡çš„æƒ…å†µï¼Œå¦‚ä½•å¤„ç†123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899private TransactionStatus handleExistingTransaction( TransactionDefinition definition, Object transaction, boolean debugEnabled) throws TransactionException &#123; // å¦‚æžœäº‹åŠ¡çš„ä¼ æ’­è¦æ±‚ä»¥éžäº‹åŠ¡æ–¹å¼æ‰§è¡Œ æŠ›å‡ºå¼‚å¸¸ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) &#123; throw new IllegalTransactionStateException( "Existing transaction found for transaction marked with propagation 'never'"); &#125; // PROPAGATION_NOT_SUPPORTED å¦‚æžœå­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·å½“å‰äº‹åŠ¡ï¼Œä»¥éžäº‹åŠ¡æ–¹å¼æ‰§è¡Œ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) &#123; if (debugEnabled) &#123; logger.debug("Suspending current transaction"); &#125; // æŒ‚èµ·å½“å‰äº‹åŠ¡ Object suspendedResources = suspend(transaction); boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); // æž„å»ºä¸€ä¸ªæ— äº‹åŠ¡çš„TransactionStatus return prepareTransactionStatus( definition, null, false, newSynchronization, debugEnabled, suspendedResources); &#125; // PROPAGATION_REQUIRES_NEW å¦‚æžœå­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·å½“å‰äº‹åŠ¡ï¼Œæ–°å»ºä¸€ä¸ªäº‹åŠ¡ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) &#123; if (debugEnabled) &#123; logger.debug("Suspending current transaction, creating new transaction with name [" + definition.getName() + "]"); &#125; SuspendedResourcesHolder suspendedResources = suspend(transaction); try &#123; return startTransaction(definition, transaction, debugEnabled, suspendedResources); &#125; catch (RuntimeException | Error beginEx) &#123; resumeAfterBeginException(transaction, suspendedResources, beginEx); throw beginEx; &#125; &#125; // PROPAGATION_NESTED å†…åµŒäº‹åŠ¡ï¼Œå°±æ˜¯æˆ‘ä»¬å¼€å¤´ä¸¾å¾—ä¾‹å­ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123; if (!isNestedTransactionAllowed()) &#123; throw new NestedTransactionNotSupportedException( "Transaction manager does not allow nested transactions by default - " + "specify 'nestedTransactionAllowed' property with value 'true'"); &#125; if (debugEnabled) &#123; logger.debug("Creating nested transaction with name [" + definition.getName() + "]"); &#125; // éžJTAäº‹åŠ¡ç®¡ç†å™¨éƒ½æ˜¯é€šè¿‡savePointå®žçŽ°çš„å†…åµŒäº‹åŠ¡ // savePointï¼šå…³ç³»åž‹æ•°æ®åº“ä¸­äº‹åŠ¡å¯ä»¥åˆ›å»ºè¿˜åŽŸç‚¹ï¼Œå¹¶ä¸”å¯ä»¥å›žæ»šåˆ°è¿˜åŽŸç‚¹ if (useSavepointForNestedTransaction()) &#123; // Create savepoint within existing Spring-managed transaction, // through the SavepointManager API implemented by TransactionStatus. // Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization. DefaultTransactionStatus status = prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null); // åˆ›å»ºè¿˜åŽŸç‚¹ status.createAndHoldSavepoint(); return status; &#125; else &#123; // Nested transaction through nested begin and commit/rollback calls. // Usually only for JTA: Spring synchronization might get activated here // in case of a pre-existing JTA transaction. return startTransaction(definition, transaction, debugEnabled, null); &#125; &#125; // å¦‚æžœæ‰§è¡Œåˆ°è¿™ä¸€æ­¥ä¼ æ’­ç±»åž‹ä¸€å®šæ˜¯ï¼ŒPROPAGATION_SUPPORTS æˆ–è€… PROPAGATION_REQUIRED // Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED. if (debugEnabled) &#123; logger.debug("Participating in existing transaction"); &#125; // æ ¡éªŒç›®å‰æ–¹æ³•ä¸­çš„äº‹åŠ¡å®šä¹‰å’Œå·²å­˜åœ¨çš„äº‹åŠ¡å®šä¹‰æ˜¯å¦ä¸€è‡´ if (isValidateExistingTransaction()) &#123; if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT) &#123; Integer currentIsolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel(); if (currentIsolationLevel == null || currentIsolationLevel != definition.getIsolationLevel()) &#123; Constants isoConstants = DefaultTransactionDefinition.constants; throw new IllegalTransactionStateException("Participating transaction with definition [" + definition + "] specifies isolation level which is incompatible with existing transaction: " + (currentIsolationLevel != null ? isoConstants.toCode(currentIsolationLevel, DefaultTransactionDefinition.PREFIX_ISOLATION) : "(unknown)")); &#125; &#125; if (!definition.isReadOnly()) &#123; if (TransactionSynchronizationManager.isCurrentTransactionReadOnly()) &#123; throw new IllegalTransactionStateException("Participating transaction with definition [" + definition + "] is not marked as read-only but existing transaction is"); &#125; &#125; &#125; boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER); // æž„å»ºä¸€ä¸ªTransactionStatusï¼Œä½†ä¸å¼€å¯äº‹åŠ¡ return prepareTransactionStatus(definition, transaction, false, newSynchronization, debugEnabled, null);&#125; è¿™é‡Œä»£ç å¾ˆå¤šï¼Œé€»è¾‘çœ‹ä¸Šè¿°æ³¨é‡Šå³å¯ã€‚è¿™é‡Œç»ˆäºŽçœ‹åˆ°äº†æœŸå¾…å·²ä¹…çš„æŒ‚èµ·äº‹åŠ¡å’Œå†…åµŒäº‹åŠ¡äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯çœ‹ä¸€ä¸‹DataSourceTransactionManagerçš„å®žçŽ° æŒ‚èµ·äº‹åŠ¡ï¼šé€šè¿‡TransactionSynchronizationManager::unbindResource æ ¹æ®æ•°æ®æºèŽ·å–å½“å‰çš„Connectionï¼Œå¹¶åœ¨resourceä¸­ç§»é™¤è¯¥Connectionã€‚ä¹‹åŽä¼šå°†è¯¥Connectionå­˜å‚¨åˆ°TransactionStatuså¯¹è±¡ä¸­ 1234567// DataSourceTransactionManager::doSuspend@Overrideprotected Object doSuspend(Object transaction) &#123; DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction; txObject.setConnectionHolder(null); return TransactionSynchronizationManager.unbindResource(obtainDataSource());&#125; åœ¨äº‹åŠ¡æäº¤æˆ–è€…å›žæ»šåŽï¼Œè°ƒç”¨ AbstractPlatformTransactionManager::cleanupAfterCompletionä¼šå°†TransactionStatus ä¸­ç¼“å­˜çš„Connectioné‡æ–°ç»‘å®šåˆ°resourceä¸­ å†…åµŒäº‹åŠ¡ï¼šé€šè¿‡å…³ç³»åž‹æ•°æ®åº“çš„savePointå®žçŽ°ï¼Œæäº¤æˆ–å›žæ»šçš„æ—¶å€™ä¼šåˆ¤æ–­å¦‚æžœå½“å‰äº‹åŠ¡ä¸ºsavePointåˆ™é‡Šæ”¾savePointæˆ–è€…å›žæ»šåˆ°savePointï¼Œå…·ä½“é€»è¾‘å‚è€ƒAbstractPlatformTransactionManager::processRollback å’Œ AbstractPlatformTransactionManager::processCommit è‡³æ­¤ï¼Œäº‹åŠ¡çš„ä¼ æ’­æºç åˆ†æžç»“æŸ prepareTransactionInfoä¸Šæ–‡ç•™ä¸‹äº†ä¸€ä¸ªé—®é¢˜ï¼ŒprepareTransactionInfo æ–¹æ³•åšäº†ä»€ä¹ˆï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹TransactionInfoçš„ç»“æž„123456789101112131415161718protected static final class TransactionInfo &#123; @Nullable private final PlatformTransactionManager transactionManager; @Nullable private final TransactionAttribute transactionAttribute; private final String joinpointIdentification; @Nullable private TransactionStatus transactionStatus; @Nullable private TransactionInfo oldTransactionInfo; // ...&#125; è¯¥ç±»åœ¨Springä¸­çš„ä½œç”¨ï¼Œæ˜¯ä¸ºäº†å†…éƒ¨ä¼ é€’å¯¹è±¡ã€‚ThreadLocalä¸­å­˜å‚¨äº†æœ€æ–°çš„TransactionInfoï¼Œé€šè¿‡å½“å‰TransactionInfoå¯ä»¥æ‰¾åˆ°ä»–çš„oldTransactionInfoã€‚æ¯æ¬¡åˆ›å»ºäº‹åŠ¡æ—¶ä¼šæ–°å»ºä¸€ä¸ªTransactionInfoï¼ˆæ— è®ºæœ‰æ²¡æœ‰çœŸæ­£çš„äº‹åŠ¡è¢«åˆ›å»ºï¼‰å­˜å‚¨åˆ°ThreadLocalä¸­ï¼Œåœ¨æ¯æ¬¡äº‹åŠ¡ç»“æŸåŽï¼Œä¼šå°†å½“å‰ThreadLocalä¸­çš„TransactionInfoé‡ç½®ä¸ºoldTransactionInfoï¼Œè¿™æ ·çš„ç»“æž„å½¢æˆäº†ä¸€ä¸ªé“¾è¡¨ï¼Œä½¿å¾—Springäº‹åŠ¡åœ¨é€»è¾‘ä¸Šå¯ä»¥æ— é™åµŒå¥—ä¸‹åŽ» å¦‚æžœè§‰å¾—æœ‰æ”¶èŽ·ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Œä½ çš„ç‚¹èµžå’Œå…³æ³¨å°±æ˜¯å¯¹æˆ‘æœ€å¤§çš„æ”¯æŒ]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>æºç </tag>
        <tag>SpringBoot</tag>
        <tag>äº‹åŠ¡ä¼ æ’­</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java SPI å®žæˆ˜]]></title>
    <url>%2Fpost%2Fe971632b.html</url>
    <content type="text"><![CDATA[SPI å…¨ç§°ä¸º (Service Provider Interface) ï¼Œæ˜¯JDKå†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘çŽ°æœºåˆ¶ï¼Œå¯ä»¥è½»æ¾å®žçŽ°é¢å‘æœåŠ¡çš„æ³¨å†Œä¸Žå‘çŽ°ï¼Œå®ŒæˆæœåŠ¡æä¾›ä¸Žä½¿ç”¨çš„è§£è€¦ï¼Œå¹¶ä¸”å¯ä»¥å®žçŽ°åŠ¨æ€åŠ è½½ SPI èƒ½åšä»€ä¹ˆåˆ©ç”¨SPIæœºåˆ¶ï¼Œsdkçš„å¼€å‘è€…å¯ä»¥ä¸ºä½¿ç”¨è€…æä¾›æ‰©å±•ç‚¹ï¼Œä½¿ç”¨è€…æ— éœ€ä¿®æ”¹æºç ï¼Œæœ‰ç‚¹ç±»ä¼¼Spring @ConditionalOnMissingBean çš„æ„æ€ åŠ¨æ‰‹å®žçŽ°ä¸€ä¸ªSPIä¾‹å¦‚æˆ‘ä»¬è¦æ­£åœ¨å¼€å‘ä¸€ä¸ªsdkå…¶ä¸­æœ‰ä¸€ä¸ªç¼“å­˜çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç”¨æˆ·å¾ˆå¯èƒ½ä¸æƒ³ä½¿ç”¨æˆ‘ä»¬çš„ç¼“å­˜å®žçŽ°ï¼Œç”¨æˆ·æƒ³è¦è‡ªå®šä¹‰ç¼“å­˜çš„å®žçŽ°ï¼Œæ­¤æ—¶ä½¿ç”¨spiå°±éžå¸¸çš„åˆé€‚äº† æ–°å»ºä¸€ä¸ªmavenå·¥ç¨‹å‘½åä¸ºsdk Cache æŽ¥å£12345678910111213import java.util.ServiceLoader;public interface Cache &#123; String getName(); static Cache load() &#123; // ServiceLoader å®žçŽ°äº† Iterableï¼Œå¯ä»¥åŠ è½½åˆ°CacheæŽ¥å£çš„å¤šä¸ªå®žçŽ°ç±» ServiceLoader&lt;Cache&gt; cacheServiceLoader = ServiceLoader.load(Cache.class); return cacheServiceLoader.iterator().next(); &#125;&#125; ServiceLoader æ˜¯Javaæä¾›æœåŠ¡å‘çŽ°å·¥å…·ç±»ï¼Œè¿™æ˜¯æˆ‘ä»¬å®žçŽ°SPIçš„å…³é”® CacheDefaultImpl12345public class CacheDefaultImpl implements Cache &#123; public String getName() &#123; return &quot;defaultImpl&quot;; &#125;&#125; é™¤æ­¤ä¹‹å¤–ï¼ŒServiceLoader è¿˜éœ€è¦åœ¨classpath:META-INF/services ä¸‹æ‰¾åˆ°ä»¥è¯¥æŽ¥å£å…¨åå‘½åçš„æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æŽ¥åœ¨resource ç›®å½•ä¸‹åˆ›å»ºMETA-INF/services/ com.github.tavenyin.Cacheæ–‡ä»¶å³å¯ï¼Œæ–‡ä»¶ä¸­æŒ‡å®šCacheçš„å®žçŽ°ç±» 12# æ­¤å¤„å¯ä»¥æŒ‡å®šå¤šä¸ªå®žçŽ°ç±»com.github.tavenyin.CacheDefaultImpl Runæˆ‘ä»¬å»ºç«‹ä¸€ä¸ªæ–°çš„mavenå­å·¥ç¨‹ï¼Œå¹¶å¼•å…¥sdkæ¨¡å—ï¼Œæ‰§è¡Œæµ‹è¯•ä»£ç 12System.out.println(Cache.load().getName()) # è¾“å‡ºç»“æžœä¸º defaultImpl ä½¿ç”¨è€…å®šåˆ¶åŒ–é‚£ä¹ˆå¦‚æžœsdkçš„ä½¿ç”¨è€…ä¸æƒ³ä½¿ç”¨æˆ‘ä»¬çš„CacheDefaultImpläº†æ€Žä¹ˆåŠžï¼Œæ²¡å…³ç³»ä½¿ç”¨è€…åªéœ€è¦è¦†ç›– classpath:META-INF/services/com.github.tavenyin.Cache å°±å¯ä»¥äº† ï¼ˆä½¿ç”¨è€…åœ¨åŒæ ·åœ¨resourceä¸‹åˆ›å»ºå³å¯è¦†ç›–ï¼‰ æˆ‘ä»¬å†æ¥è¿è¡Œä¸€ä¸‹æµ‹è¯•ä»£ç ï¼Œè¾“å‡ºç»“æžœä¸º newImpl ServiceLoader å®žçŽ°åŽŸç†ServiceLoader çš„å®žçŽ°åŽŸç†è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æžœæˆ‘ä»¬è‡ªå·±å®žçŽ°ä¸€ä¸ªServiceLoaderï¼Œæˆ‘ä»¬ä¼šæ€Žä¹ˆåšï¼Ÿ é€šè¿‡æŒ‡å®šçš„æ–‡ä»¶åŠ è½½å‡ºæ‰€æœ‰çš„ç±»å é€šè¿‡åå°„æž„å»ºè¿™äº›å¯¹è±¡ æ²¡é”™ï¼ŒServiceLoader å°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œæˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹æºç  å…¥å£ ServiceLoader::iterator::next 1234567891011121314151617181920212223242526272829303132// Cached providers, in instantiation orderprivate LinkedHashMap&lt;String,S&gt; providers = new LinkedHashMap&lt;&gt;();// The current lazy-lookup iteratorprivate LazyIterator lookupIterator; // ServiceLoader::iteratorpublic Iterator&lt;S&gt; iterator() &#123; return new Iterator&lt;S&gt;() &#123; Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders = providers.entrySet().iterator(); public boolean hasNext() &#123; if (knownProviders.hasNext()) return true; return lookupIterator.hasNext(); &#125; // ServiceLoader::iterator::next public S next() &#123; if (knownProviders.hasNext()) return knownProviders.next().getValue(); return lookupIterator.next(); &#125; public void remove() &#123; throw new UnsupportedOperationException(); &#125; &#125;;&#125; ä»Žproviders åˆå§‹ä¸ºä¸€ä¸ªç©ºçš„LinkedHashMapï¼Œæˆ‘ä»¬æ— éœ€å…³æ³¨ï¼Œæ‰€ä»¥knownProviders::hasNext ä¸€å®šè¿”å›žfalseï¼Œæˆ‘ä»¬ç›´å¥”knownProviders::next knownProviders::next ä¸­æ ¸å¿ƒé€»è¾‘åœ¨nextService() ä¸­1234567891011121314151617181920212223242526272829303132private S nextService() &#123; // hasNextService ä¸­åšäº†ä¸¤ä»¶äº‹ // 1. åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æœåŠ¡çš„æä¾›è€… // 2. é€šè¿‡ &quot;META-INF/services/&quot; + æŽ¥å£å…¨å åŠ è½½æ‰€æœ‰æä¾›è€…ClassName if (!hasNextService()) throw new NoSuchElementException(); String cn = nextName; nextName = null; Class&lt;?&gt; c = null; try &#123; // é€šè¿‡ClassName åˆ›å»ºClass c = Class.forName(cn, false, loader); &#125; catch (ClassNotFoundException x) &#123; fail(service, &quot;Provider &quot; + cn + &quot; not found&quot;); &#125; if (!service.isAssignableFrom(c)) &#123; fail(service, &quot;Provider &quot; + cn + &quot; not a subtype&quot;); &#125; try &#123; // åå°„åˆ›å»ºå®žçŽ°ç±»å®žä¾‹ S p = service.cast(c.newInstance()); providers.put(cn, p); return p; &#125; catch (Throwable x) &#123; fail(service, &quot;Provider &quot; + cn + &quot; could not be instantiated&quot;, x); &#125; throw new Error(); // This cannot happen&#125; ä¸Žæˆ‘ä»¬ä¸Šè¿°åˆ†æžçš„å®žçŽ°è¿‡ç¨‹ä¸€è‡´ï¼Œæ›´å¤šç»†èŠ‚æ„Ÿå…´è¶£çš„ç«¥éž‹å¯è‡ªè¡Œé˜…è¯» ServiceLoader å¦‚ä½•å®žçŽ°åŠ¨æ€åŠ è½½åŒä¸€ä¸ª ServiceLoader å¯¹è±¡çš„è¯ï¼Œä¸ä¼šé‡æ–°åŠ è½½META-INF/services/ä¸‹çš„ä¿¡æ¯ã€‚å¦‚æžœæˆ‘ä»¬éœ€è¦åŠ¨æ€åŠ è½½çš„è¯ï¼Œå¯ä»¥è€ƒè™‘æ¯æ¬¡é‡æ–°åˆ›å»ºæ–°çš„ServiceLoader å¯¹è±¡ï¼Œæˆ–è€…è°ƒç”¨ ServiceLoader::reload demo åœ°å€https://github.com/TavenYin/java-spi.git å¦‚æžœè§‰å¾—æœ‰æ”¶èŽ·ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€æ®·å¤©æ–‡ã€‘ï¼Œä½ çš„ç‚¹èµžå’Œå…³æ³¨å°±æ˜¯å¯¹æˆ‘æœ€å¤§çš„æ”¯æŒ]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SPI</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot Websocket å®žæˆ˜]]></title>
    <url>%2Fpost%2Fa77ef6c7.html</url>
    <content type="text"><![CDATA[Websocket æ˜¯ä¸€ç§åœ¨å•ä¸ªTCPè¿žæŽ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®ã€‚WebSocketè¿žæŽ¥æˆåŠŸåŽï¼ŒæœåŠ¡ç«¯ä¸Žå®¢æˆ·ç«¯å¯ä»¥åŒå‘é€šä¿¡ã€‚åœ¨éœ€è¦æ¶ˆæ¯æŽ¨é€çš„åœºæ™¯ï¼ŒWebsocket ç›¸å¯¹äºŽè½®è¯¢èƒ½æ›´å¥½çš„èŠ‚çœæœåŠ¡å™¨èµ„æºå’Œå¸¦å®½ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ›´å®žæ—¶åœ°è¿›è¡Œé€šè®¯ã€‚ ä¸Ž HTTP åè®®æœ‰ç€è‰¯å¥½çš„å…¼å®¹æ€§ã€‚é»˜è®¤ç«¯å£ä¹Ÿæ˜¯80å’Œ443ï¼Œå¹¶ä¸”æ¡æ‰‹é˜¶æ®µé‡‡ç”¨ HTTP åè®®ï¼Œå› æ­¤æ¡æ‰‹æ—¶ä¸å®¹æ˜“å±è”½ï¼Œèƒ½é€šè¿‡å„ç§ HTTP ä»£ç†æœåŠ¡å™¨ã€‚ ä¾èµ–äºŽTCPåè®® æ•°æ®æ ¼å¼æ¯”è¾ƒè½»é‡ï¼Œæ€§èƒ½å¼€é”€å°ï¼Œé€šä¿¡é«˜æ•ˆã€‚ å¯ä»¥å‘é€æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥å‘é€äºŒè¿›åˆ¶æ•°æ®ã€‚ æ²¡æœ‰åŒæºé™åˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä¸Žä»»æ„æœåŠ¡å™¨é€šä¿¡ã€‚ åè®®æ ‡è¯†ç¬¦æ˜¯wsï¼ˆå¦‚æžœåŠ å¯†ï¼Œåˆ™ä¸ºwssï¼‰ï¼ŒæœåŠ¡å™¨ç½‘å€å°±æ˜¯ URLã€‚ SpringBoot ä¸­ä½¿ç”¨ Websocketåœ¨ç®€å•äº†è§£Websocket ä¹‹åŽï¼Œæˆ‘ä»¬æ¥åŠ¨æ‰‹å®žè·µä¸€ä¸‹ã€‚SpringBoot ä¸­æœ‰å¤šç§æ–¹å¼å¯ä»¥å®žçŽ°Websocket Serverï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨Tomcat ä¸­ javax.websocket.server çš„apiæ¥å®žçŽ°ï¼Œç»“å°¾ä¼šç»™å‡ºdemoåœ°å€ å¼•å…¥Mavenä¾èµ– 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;&lt;/dependency&gt; åˆ›å»ºä¸€ä¸ªBeanç”¨äºŽå¤„ç†Websocket è¯·æ±‚ï¼Œé€šè¿‡ServerEndpoint å£°æ˜Žå½“å‰Bean æŽ¥å—çš„Websocket URL è¿™é‡Œä¸ºä»€ä¹ˆå£°æ˜Žçš„æ˜¯ @Controllerï¼ŒåŽæ–‡ä¼šè§£é‡Š 1234567891011121314151617181920212223242526272829303132333435363738394041import org.springframework.stereotype.Controller;import javax.websocket.*;import javax.websocket.server.ServerEndpoint;@ServerEndpoint(value = &quot;/message_websocket&quot;)@Controllerpublic class MsgWebsocketController &#123; @OnOpen public void onOpen(Session session) &#123; // å…ˆé‰´æƒï¼Œå¦‚æžœé‰´æƒé€šè¿‡åˆ™å­˜å‚¨WebsocketSessionï¼Œå¦åˆ™å…³é—­è¿žæŽ¥ï¼Œè¿™é‡Œçœç•¥äº†é‰´æƒçš„ä»£ç  WebSocketSupport.storageSession(session); System.out.println(&quot;session open. ID:&quot; + session.getId()); &#125; /** * è¿žæŽ¥å…³é—­è°ƒç”¨çš„æ–¹æ³• */ @OnClose public void onClose(Session session) &#123; System.out.println(&quot;session close. ID:&quot; + session.getId()); &#125; /** * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åŽè°ƒç”¨çš„æ–¹æ³• */ @OnMessage public void onMessage(String message, Session session) &#123; System.out.println(&quot;get client msg. ID:&quot; + session.getId() + &quot;. msg:&quot; + message); &#125; /** * å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”¨ */ @OnError public void onError(Session session, Throwable error) &#123; error.printStackTrace(); &#125;&#125; å£°æ˜Ž ServerEndpointExporter 123456789@Configurationpublic class WebsocketConfig &#123; @Bean public ServerEndpointExporter serverEndpointExporter() &#123; return new ServerEndpointExporter(); &#125;&#125; è‡³æ­¤ï¼ŒWebsocket Server å·²ç»æ­å»ºå®Œæˆï¼Œå®¢æˆ·ç«¯å·²ç»å¯ä»¥å’ŒæœåŠ¡ç«¯é€šä¿¡äº† æœåŠ¡ç«¯ å‘å®¢æˆ·ç«¯æŽ¨é€æ¶ˆæ¯ é€šè¿‡ session.getBasicRemote().sendText(message); å³å¯ æºç æµ…æžæˆ‘ä»¬æ¥çœ‹ä¸‹ä¸Šè¿°çš„çŸ­çŸ­å‡ è¡Œä»£ç æ˜¯å¦‚ä½•ä¸ºæˆ‘ä»¬æž„å»º Websocket Server ServerEndpointExporter é‡ç‚¹å…³æ³¨ä¸‹çº¢æ¡†ä¸­çš„å†…å®¹ ServerEndpointExporter å®žçŽ°äº† SmartInitializingSingletonï¼Œä¼šåœ¨bean å®žä¾‹åŒ–ç»“æŸåŽè°ƒç”¨ afterSingletonsInstantiated ä»ŽSpringä¸Šä¸‹æ–‡ä¸­èŽ·å–æ‰€æœ‰æ ‡è®°@ServerEndpointçš„Beançš„name å…¶å®ž æˆ‘ä»¬å£°æ˜Žçš„ MsgWebsocketController ä¸­å¹¶ä¸æ˜¯åªèƒ½æ ‡è®°@Controllerï¼Œåªæ˜¯ä¸ºäº†å°†å…¶æ³¨å†Œåˆ°Springå®¹å™¨ä¸­ï¼Œæ–¹ä¾¿ServerEndpointçš„æ³¨å†Œè€Œå·²ï¼Œæ ‡è®° @Controller æ›´ç¬¦åˆSpringçš„å¼€å‘è§„èŒƒ é€šè¿‡ServerContainer å°†æ‰€æœ‰æ ‡è®°@ServerEndpointçš„Bean æ³¨å†Œ ServerContainer é»˜è®¤çš„å®žçŽ°ç±»ä¸º WsServerContainerï¼Œä¼šå¯¹æˆ‘ä»¬çš„ServerEndpointåšä¸€ä¸ªæ˜ å°„ï¼ŒURL =&gt; å¯¹åº”çš„classï¼Œç„¶åŽé’ˆå¯¹ä¸åŒçš„äº‹ä»¶è°ƒç”¨æŒ‡å®šçš„æ–¹æ³•ï¼ˆä¾‹å¦‚å»ºç«‹è¿žæŽ¥æ—¶è°ƒç”¨æ ‡è®°@Onopençš„æ–¹æ³•ï¼‰ï¼Œè¿™æœ‰ç‚¹Spring DispatcherServlet é‚£å‘³ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±çœ‹ä¸‹ åœ¨äº†è§£äº† Spring ä¸ºæˆ‘ä»¬åšäº†ä»€ä¹ˆåŽï¼Œæˆ‘ä»¬æ¥å®Œå–„ä¸€ä¸‹æˆ‘ä»¬çš„Demo å»ºç«‹ä¸€ä¸ªSessionManagerå½“æˆ‘ä»¬æƒ³å‘å®¢æˆ·ç«¯æŽ¨é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯å»ºç«‹çš„è¿žæŽ¥ï¼Œä¹Ÿå°±æ˜¯WebscoketSession WsServerContainer ä¸­è™½ç„¶å·²ç»å­˜å‚¨äº† WebscoketSessionï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åŠžæ³•ç›´æŽ¥é€šè¿‡SessionIdï¼Œæˆ–è€…æˆ‘ä»¬çš„ä¸šåŠ¡Id ç›´æŽ¥å®šä½åˆ°æŒ‡å®šçš„Sessionï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®žçŽ°ä¸€ä¸ªè‡ªå·±çš„SessionManager 1final ConcurrentHashMap&lt;Object, Session&gt; sessionPool = new ConcurrentHashMap&lt;&gt;(); ä½¿ç”¨ ConcurrentHashMap ç®¡ç†å³å¯ åˆ†å¸ƒå¼æŽ¨é€è§£å†³ å¦‚å›¾ï¼Œç”¨æˆ·1ä¸ŽæœåŠ¡å™¨Aå»ºç«‹Webscoketï¼Œç”¨æˆ·2ä¸ŽæœåŠ¡å™¨Bå»ºç«‹Webscoketï¼Œé‚£ä¹ˆç”¨æˆ·1å¦‚æžœæƒ³å‘ç”¨æˆ·2æŽ¨é€ä¸€æ¡æ¶ˆæ¯ï¼Œè¯¥å¦‚ä½•å®žçŽ°ï¼Ÿ WebscoketSession å®žé™…ä¸Šæ˜¯ç½‘ç»œè¿žæŽ¥ï¼Œå¹¶ä¸åƒæˆ‘ä»¬ä¼ ç»Ÿåº”ç”¨çš„Sessionå¯ä»¥åºåˆ—åŒ–åˆ°Redisï¼Œåªèƒ½æ¯ä¸ªæœåŠ¡å™¨ç®¡ç†è‡ªå·±çš„WebscoketSessionï¼Œæ‰€ä»¥æ­¤æ—¶æœåŠ¡å™¨Aé€šçŸ¥æœåŠ¡å™¨Bï¼Œä½ è¦ç»™ç”¨æˆ·2æŽ¨é€ä¸€æ¡æ¶ˆæ¯ã€‚ ä¸€ä¸ªæ¯”è¾ƒç®€å•æœ‰æ•ˆçš„å®žçŽ°æ–¹æ³•ï¼Œåˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚ä¸‹å›¾ è¿™ä¸ªæ–¹æ¡ˆä¼˜ç‚¹æ˜¯å®žçŽ°ç®€å•ï¼Œç¼ºç‚¹æ˜¯æ¯å°æœåŠ¡å™¨éƒ½éœ€è¦åˆ¤æ–­ä¸€éå½“å‰æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„WebscoketSession ï¼Œæ–¹æ¡ˆç»†åŒ–çš„è¯åˆ™éœ€è¦ç»´æŠ¤ç”¨æˆ·Sessionä¸Žæ¯å°æœåŠ¡å™¨çš„å…³ç³»ï¼Œè¿™æ ·ç›´æŽ¥å°†æ¶ˆæ¯æŽ¨é€ç»™æŒ‡å®šæœåŠ¡å™¨å³å¯ å…¶ä»–é—®é¢˜æµ‹è¯•æ—¶å‘çŽ°ï¼Œå½“å®¢æˆ·ç«¯æ–­ç½‘åŽï¼ŒæœåŠ¡ç«¯æ£€æµ‹ä¸åˆ°å®¢æˆ·ç«¯å¤±åŽ»è¿žæŽ¥çš„æƒ…å†µï¼Œä¾ç„¶å¯ä»¥è°ƒç”¨Sessionçš„æŽ¨é€æ–¹æ³•ï¼ŒæœåŠ¡ç«¯ä¼šä¸€ç›´æŒæœ‰è¿™ä¸ªæ— æ•ˆçš„Session ç›®å‰æƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®WebsocketSessionçš„æœ€å¤§ç©ºé—²æ—¶é—´ï¼ˆsession.setMaxIdleTimeout(milliseconds);ï¼‰ï¼Œå½“è¶…è¿‡è¿™ä¸ªæ—¶é—´æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šå…³é—­Sessionã€‚å‰ç«¯å®šæœŸå‘é€ä¸€æ¡å¿ƒè·³åŒ…ï¼Œç”¨äºŽç»´æŒSessionï¼Œå½“å‡ºçŽ°ä¸Šè¿°æƒ…å†µæ—¶ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸ä¼šä¸€ç›´æŒæœ‰Sessionäº† å®Œæ•´demoåœ°å€å…³äºŽdemoçš„ç»†èŠ‚å‚è€ƒé¡¹ç›®åœ°å€ä¸­Readme Github ðŸ‘‰ https://github.com/TavenYin/taven-springboot-learning/tree/master/sp-websocket Gitee ðŸ‘‰ https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/sp-websocket å‚è€ƒhttp://www.ruanyifeng.com/blog/2017/05/websocket.html éƒ¨åˆ†ä»£ç å‚è€ƒäº†ä¸€ä½å…„å¼Ÿçš„åšå®¢ï¼Œä½†æ˜¯ç”±äºŽæ—¶é—´æœ‰ç‚¹é•¿ï¼Œæ‰¾ä¸åˆ°äº†ï¼Œåœ¨æ­¤è¯´ä¸€å£°æŠ±æ­‰ å¦‚æžœè§‰å¾—æœ‰æ”¶èŽ·ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€æ®·å¤©æ–‡ã€‘ï¼Œç¬¬ä¸€æ—¶é—´æŽ¥æ”¶åˆ°æˆ‘çš„æ›´æ–°]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Websocket</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Redisèƒ½å¦ä¿è¯æ•°æ®é«˜å¯é æ€§]]></title>
    <url>%2Fpost%2Ff4cc44a4.html</url>
    <content type="text"><![CDATA[è®°å½•ä¸‹å·¥ä½œä¸­å…³äºŽRedisçš„ä¸€äº›æ€è€ƒï¼Œä¸»è¦å…³äºŽRedisçš„äº‹åŠ¡ï¼Œè„šæœ¬ï¼ŒæŒä¹…åŒ– æœ¬æ–‡è®¨è®ºçš„é—®é¢˜ï¼š Redisçš„äº‹åŠ¡æˆ–è€…æ‰§è¡Œluaè„šæœ¬å¯ä»¥åƒå…³ç³»åž‹æ•°æ®åº“äº‹åŠ¡é‚£æ ·ï¼Œè¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›žæ»šå—ï¼Ÿ å½“è„šæœ¬æˆ–è€…äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå®•æœºRedisä¸­çš„æ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ åŽŸå­æ€§åœ¨Redisçš„å¼€å‘æ–‡æ¡£ä¸­å¯ä»¥äº†è§£åˆ°ï¼ŒRedisçš„äº‹åŠ¡ä»¥åŠRedisæ‰§è¡Œluaè„šæœ¬éƒ½å¯ä»¥ä¿è¯åŽŸå­æ€§ï¼ˆRedisçš„æ¯æ¡å‘½ä»¤ä¹Ÿæ˜¯åŽŸå­çš„ï¼‰ï¼Œé‚£ä¹ˆåŽŸå­æ€§å¯ä»¥ä¿è¯ä»€ä¹ˆï¼Ÿèƒ½å¦è§£å†³æˆ‘ä»¬çš„é—®é¢˜ï¼Ÿå…ˆæ¥çœ‹ä¸‹åŽŸå­æ€§çš„å®šä¹‰ æ¥è‡ªç»´åŸºç™¾ç§‘å¯¹å…³ç³»åž‹æ•°æ®åº“äº‹åŠ¡åŽŸå­æ€§çš„å®šä¹‰ äº‹åŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«æ‰§è¡Œï¼ŒåŒ…å«åœ¨å…¶ä¸­çš„å¯¹æ•°æ®åº“çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ æ¥è‡ªç™¾åº¦ç™¾ç§‘åŽŸå­æ“ä½œçš„å®šä¹‰ åŽŸå­æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œåœ¨æ‰§è¡Œå®Œæ¯•ä¹‹å‰ä¸ä¼šè¢«ä»»ä½•å…¶å®ƒä»»åŠ¡æˆ–äº‹ä»¶ä¸­æ–­ Redis æ‰€ä¿è¯çš„åŽŸå­æ€§æ­£æ˜¯å¦‚æ­¤ ä¸å¯åˆ†å‰²ï¼Œä¿è¯äº‹åŠ¡å’Œè„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤æ‰“æ–­ äº‹åŠ¡å’Œè„šæœ¬ä¸­çš„å‘½ä»¤ï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ Redis Transactionså¦‚ä½•ä½¿ç”¨Redis äº‹åŠ¡12345&gt; MULTI // å¼€å¯äº‹åŠ¡OK&gt; SET KEY VALUE // æ‰§è¡Œå‘½ä»¤ï¼Œæ­¤æ—¶çš„å‘½ä»¤åªæ˜¯å…¥é˜Ÿï¼Œä¼šåœ¨ EXEC ä¹‹åŽåŽŸå­æ€§çš„æ‰§è¡Œäº‹åŠ¡ä¸­æ‰€æœ‰å‘½ä»¤QUEUED&gt; EXEC / DISCARD // æ‰§è¡Œæˆ–è€…å–æ¶ˆäº‹åŠ¡ Redisçš„äº‹åŠ¡ä¿è¯ åœ¨Redisäº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ°¸è¿œä¸ä¼šæ‰§è¡Œå¦ä¸€ä¸ªå®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚ æ‰€æœ‰å‘½ä»¤éƒ½ä¼šæ‰§è¡Œï¼Œæˆ–è€…ä¸æ‰§è¡Œã€‚å¦‚æžœåœ¨æ‰§è¡Œ EXEC ä¹‹å‰ï¼Œå®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯å¤±åŽ»å“åº”ï¼Œé‚£ä¹ˆäº‹åŠ¡ä¸­æ‰€æœ‰çš„å‘½ä»¤éƒ½ä¸ä¼šæ‰§è¡Œï¼Œç›¸åå¦‚æžœæ‰§è¡Œ EXEC ä¿è¯æ‰€æœ‰çš„å‘½ä»¤éƒ½æ‰§è¡Œã€‚ äº‹åŠ¡ä¸­å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ EXEC ä¹‹å‰ï¼šå‘½ä»¤æ— æ³•Queuedï¼Œä¾‹å¦‚è¯­æ³•é”™è¯¯ï¼ˆé”™è¯¯çš„å‚æ•°æ•°é‡ï¼Œé”™è¯¯çš„å‘½ä»¤ï¼‰ï¼Œæˆ–è€…ä¸€äº›å…¶ä»–é”™è¯¯ï¼Œä¾‹å¦‚å†…å­˜ä¸è¶³ï¼ˆRedisä½¿ç”¨äº†maxmemory é™åˆ¶æœ€å¤§å†…å­˜ï¼‰ EXEC ä¹‹åŽï¼šå‘½ä»¤ä¹Ÿå¯èƒ½ä¼šå¤±è´¥ï¼Œä¾‹å¦‚é’ˆå¯¹stringç±»åž‹ä½¿ç”¨listçš„å‘½ä»¤ EXEC ä¹‹å‰çš„é”™è¯¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æ£€æŸ¥æœåŠ¡ç«¯çš„å“åº”æ¥è§£å†³ï¼Œå½“å‘ç”Ÿå…¥é˜Ÿå¤±è´¥æ—¶ï¼ˆRediså“åº”å€¼éžQUEUEDï¼‰ï¼Œå®¢æˆ·ç«¯DISCARDå½“å‰äº‹åŠ¡ ä»ŽRedis 2.6.5å¼€å§‹ï¼ŒRedis ä¼šè®°å½•äº‹åŠ¡æœŸé—´å‘ç”Ÿçš„é”™è¯¯ï¼Œå¹¶æ‹’ç»æ‰§è¡Œäº‹åŠ¡ï¼Œåœ¨æ‰§è¡ŒEXECæ—¶è¿”å›žé”™è¯¯ä¿¡æ¯å¹¶è‡ªåŠ¨ä¸¢å¼ƒè¯¥äº‹åŠ¡ ä½†æ˜¯EXEC ä¹‹åŽçš„é”™è¯¯ï¼Œå³ä½¿å¯¼è‡´éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼ŒRedisè¿˜æ˜¯ä¼šæ‰§è¡Œå…¶ä»–çš„å‰©ä½™å‘½ä»¤ Redis äº‹åŠ¡çš„ä¸å›žæ»šæœºåˆ¶è™½ç„¶Redisä¿è¯äº†åŽŸå­æ€§ï¼Œä½†æ˜¯ä»–çš„äº‹åŠ¡å¹¶ä¸ä¼šåƒå…³ç³»åž‹æ•°æ®åº“é‚£æ ·ï¼Œåœ¨Redisäº‹åŠ¡ä¸­å¦‚æžœæŸæ¡å‘½ä»¤å‘ç”Ÿäº†é”™è¯¯ï¼Œå…¶ä»–çš„å‘½ä»¤ä¼šä¾æ—§æ‰§è¡Œï¼Œè¿™ç‚¹ç›¸æ¯”è¾ƒå…³ç³»åž‹æ•°æ®åº“æ¥è¯´ä¸å…æœ‰äº›â€å¥‡æ€ªâ€äº† Rediså¼€å‘æ–‡æ¡£ä¸­ç»™å‡ºçš„è§£é‡Šå¦‚ä¸‹ åªæœ‰è¯­æ³•é”™è¯¯æ‰å¯èƒ½å¯¼è‡´å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå¤§å¤šæ•°æƒ…å†µéƒ½æ˜¯ç¼–ç¨‹é”™è¯¯å¯¼è‡´çš„ å› ä¸ºä¸éœ€è¦å›žæ»šï¼Œä½¿å¾— Redis æ›´ç®€å• æ›´é«˜æ•ˆ å…³äºŽäº‹åŠ¡çš„æ›´å¤šå†…å®¹ðŸ‘‰ https://redis.io/topics/transactions Redis lua2.6.0 ç‰ˆæœ¬åŽï¼ŒRedis å¢žåŠ äº†å¯¹luaè„šæœ¬çš„æ”¯æŒï¼Œè„šæœ¬å’ŒRedisäº‹åŠ¡ä¸€æ ·ä¿è¯äº†åŽŸå­æ€§ï¼Œæ‰§è¡Œè„šæœ¬æ—¶ä¸ä¼šæ‰§è¡Œå…¶ä»–è„šæœ¬æˆ–Rediså‘½ä»¤ï¼ˆæ‰€ä»¥ä¸è¦è®©è„šæœ¬è¿è¡Œæ—¶é—´è¿‡é•¿ï¼‰ï¼ŒåŒæ ·è„šæœ¬ä¹Ÿæ²¡æœ‰å›žæ»šæœºåˆ¶ï¼Œå½“è„šæœ¬ä¸­å‡ºçŽ°luaçš„å¼‚å¸¸ï¼Œæˆ–è€…Rediså‘½ä»¤é”™è¯¯ï¼Œä¹Ÿæ— æ³•ä¿è¯å…¨éƒ¨æ‰§è¡ŒæˆåŠŸ Redis lua å’Œäº‹åŠ¡æœ‰ç‚¹ç±»ä¼¼ï¼Œä½†æ˜¯æœ‰äº›åœºæ™¯ä½¿ç”¨äº‹åŠ¡æ˜¯æ— æ³•åšåˆ°çš„ï¼Œä¾‹å¦‚æˆ‘æƒ³å¯¹Redisä¸­çš„æ•°æ®å…ˆè¯»ï¼Œç„¶åŽæ ¹æ®åŽŸæœ‰æ•°æ®å˜æ›´ï¼Œæ•´ä¸ªè¿‡ç¨‹æƒ³è¦ä¿è¯åŽŸå­æ€§ï¼Œç”±äºŽäº‹åŠ¡åœ¨EXECä¹‹å‰æ— æ³•èŽ·å–è¿”å›žå€¼ï¼Œä½¿ç”¨lua å°±éžå¸¸åˆé€‚ å…³äºŽRedis lua æ›´å¤šå†…å®¹ ðŸ‘‰ https://redis.io/commands/eval Redis æ‰§è¡Œå‘½ä»¤æ—¶å®•æœºæ•°æ®ä¼šä¸¢å¤±å—çœ‹åˆ°äº†è¿™ï¼Œç¬¬ä¸€ä¸ªé—®é¢˜æˆ‘ä»¬å·²ç»æ¸…æ¥šäº†ï¼ŒRediså¹¶æ²¡æœ‰å›žæ»šçš„èƒ½åŠ›ï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™äº›éœ€è¦å›žæ»šçš„åœºæ™¯éƒ½æ˜¯ç¼–ç é”™è¯¯ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥é¿å…çš„ã€‚æˆ‘ä»¬ç»§ç»­æŽ¢å¯»ç¬¬äºŒä¸ªé—®é¢˜çš„ç­”æ¡ˆ Redisæ˜¯åŸºäºŽå†…å­˜çš„æ•°æ®åº“ï¼Œæ‰€ä»¥å½“å‘ç”Ÿå®•æœºæˆ–è€…åœæ­¢åŽé‡æ–°å¯åŠ¨æ—¶ï¼ŒRedisä¼šä½¿ç”¨ç£ç›˜ä¸Šçš„æŒä¹…åŒ–æ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œæ‰€ä»¥æ˜¯å¦èƒ½æ¢å¤æ•°æ®ï¼Œèƒ½æ¢å¤å¤šå°‘æ•°æ®ï¼Œå–å†³äºŽä½¿ç”¨å“ªä¸€ç§æŒä¹…åŒ–ç­–ç•¥ ç®€å•è¯´ä¸‹ä¸¤ç§æŒä¹…åŒ–ç­–ç•¥ RDBæŒ‰æŒ‡å®šçš„æ—¶é—´é—´éš”å°†å†…å­˜ä¸­æ•°æ®é›†å†™å…¥å¿«ç…§ AOFAOFä¼šè®°å½•æœåŠ¡å™¨æŽ¥æ”¶çš„æ¯ä¸ªå†™å…¥æ“ä½œã€‚å½“Rediså‘½ä»¤æ‰§è¡ŒæˆåŠŸåŽï¼Œå‘½ä»¤ä¼šè¢«ä¼ æ’­åˆ°AOFç¨‹åºä¸­ã€‚AOF çš„ä¸‰ç§åŒæ­¥ç­–ç•¥ appendfsync always ï¼šæ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šåŒæ­¥åˆ°AOFæ–‡ä»¶ appendfsync everysec ï¼šæ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼ŒAOFçš„é»˜è®¤ç­–ç•¥ appendfsync no ï¼šå°†æ•°æ®åŒæ­¥å°†ç»™æ“ä½œç³»ç»Ÿç®¡ç†ï¼Œé€šå¸¸linuxç³»ç»Ÿ30sä¼šåŒæ­¥ä¸€æ¬¡æ•°æ®ï¼Œä½†è¿™å–å†³äºŽæ“ä½œç³»ç»Ÿ å³ä½¿ä½¿ç”¨always ä¹Ÿæ— æ³•ä¿è¯å†™å…¥çš„æ¯ä¸€æ¡å‘½ä»¤éƒ½è¢«æŒä¹…åŒ–ï¼Œä»Žå‘½ä»¤æ‰§è¡ŒæˆåŠŸåˆ°æ•°æ®ä¿å­˜åˆ°ç¡¬ç›˜ä¹‹é—´ï¼Œè¿˜æ˜¯æœ‰ä¸€æ®µéžå¸¸å°çš„é—´éš” å›žåˆ°æˆ‘ä»¬çš„é—®é¢˜ä¸Šï¼Œå¦‚æžœä½¿ç”¨RDBï¼Œæ¯«æ— ç–‘é—®ï¼Œæ•°æ®åªèƒ½æ¢å¤åˆ°ä¸Šæ¬¡çš„å¤‡ä»½ å³ä½¿ä½¿ç”¨AOFçš„è¯ï¼Œå¦‚æžœåœ¨Redisäº‹åŠ¡æ‰§è¡ŒæœŸé—´å®•æœºï¼Œé‚£ä¹ˆè¿™æ¬¡äº‹åŠ¡è¿˜æ˜¯ç›¸å½“äºŽâ€æ²¡æœ‰æ‰§è¡Œâ€ï¼Œç”±äºŽå‘½ä»¤è¿˜æ²¡æ¥åŠå†™å…¥AOFï¼Œåœ¨æœåŠ¡æ¢å¤åŽæ›´ä¸å¯èƒ½æ¢å¤æ•°æ®ã€‚å¯¹äºŽRediså®¢æˆ·ç«¯è€Œè¨€ï¼Œä¼šæ”¶åˆ°æœåŠ¡ç«¯çš„å¼‚å¸¸å“åº” å†™å…¥AOFçš„è¿‡ç¨‹ä¹Ÿæ˜¯ä¼šè¢«æ‰“æ–­çš„ï¼ŒRedis æ–‡æ¡£ä¸­æåˆ°ï¼Œå¦‚æžœRedisæœåŠ¡å™¨çªç„¶å´©æºƒï¼Œå¯¼è‡´å‡ºçŽ°äº†â€åŠå†™çŠ¶æ€â€çš„AOFæ–‡ä»¶æ—¶ï¼ŒæœåŠ¡å™¨é‡æ–°å¯åŠ¨æ—¶ï¼Œä¼šæ£€æµ‹åˆ°è¿™ç§æƒ…å†µï¼Œå¹¶ä¸”é€€å‡ºæç¤ºç”¨æˆ·ä½¿ç”¨ redis-check-aof ä¿®å¤ AOF æ–‡ä»¶ã€‚â€åŠå†™çŠ¶æ€â€çš„äº‹åŠ¡æˆ–è€…å‘½ä»¤ä¼šè¢«åˆ é™¤ï¼ŒæœåŠ¡å™¨å¯ä»¥é‡æ–°å¯åŠ¨ã€‚ å¦‚æžœå†™å…¥AOFè¿‡ç¨‹è¢«æ‰“æ–­ï¼Œå¯¹äºŽå®¢æˆ·ç«¯è€Œè¨€å¯èƒ½æ˜¯æ¯«æ— æ„ŸçŸ¥çš„ï¼ˆçœ‹äº†ä¸‹Rediså‘½ä»¤æ‰§è¡Œç›¸å…³ï¼ŒAOFåº”è¯¥æ˜¯å‘ç”Ÿåœ¨å“åº”å®¢æˆ·ç«¯ä¹‹åŽï¼‰ æ‰€ä»¥ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿæ¸…æ¥šäº†ï¼ŒRedis å¹¶ä¸èƒ½ä¿è¯æˆ‘ä»¬å†™å…¥çš„æ•°æ®éƒ½å®‰å…¨çš„æŒä¹…åŒ– å…³äºŽæŒä¹…åŒ–çš„æ›´å¤šå†…å®¹ðŸ‘‰ https://redis.io/topics/persistence æ‰©å±•ï¼šè„šæœ¬å¦‚ä½•æŒä¹…åŒ–è¿™é‡Œè¯´çš„æ˜¯AOFçš„æƒ…å†µ åœ¨Redis 5 ä¹‹å‰ï¼Œé»˜è®¤æ˜¯å°†è„šæœ¬æœ¬èº«ä¼ æ’­åˆ°AOFä¸­ã€‚è¿™ç§ä¼ æ’­æ–¹å¼çš„å¥½å¤„ï¼Œä¸éœ€è¦å°†è„šæœ¬è½¬æˆRediså‘½ä»¤ï¼Œåœ¨å†™å…¥AOFæˆ–è€…å…¶ä»–Rediså®žä¾‹æ—¶ä¸ä¼šå ç”¨è¿‡å¤šçš„å¸¦å®½å’ŒCPU å¤åˆ¶è„šæœ¬ä¸å…è®¸è„šæœ¬ä¸­å‡ºçŽ°éšæœºæ€§çš„å†™å…¥ï¼Œå› ä¸ºè¿™ä¼šå¯¼è‡´é€šè¿‡AOFæ¢å¤æ•°æ®æ—¶ï¼Œæ•°æ®ä¸ä¸€è‡´ï¼Œåœ¨è¿™ç‚¹ä¸ŠRedisåšäº†ä¸€äº›é™åˆ¶ï¼Œç”±äºŽä¸æ˜¯æœ¬æ–‡é‡ç‚¹å°±ä¸å¤šè¯´äº†ï¼Œå¯ä»¥å‚è€ƒRediså¼€å‘æ–‡æ¡£ ä»ŽRedis 3.2 å¼€å§‹æ–°å¢žäº†ä¸€ç§è„šæœ¬å¤åˆ¶æ–¹å¼ script effects replicationï¼ˆRedis 5 å¼€å§‹é»˜è®¤ä½¿ç”¨è¿™ç§æ–¹å¼å¤„ç†è„šæœ¬ï¼‰ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼ŒRedis ä¼šæ”¶é›†è„šæœ¬ä¸­æ‰€æœ‰ä¿®æ”¹æ•°æ®çš„å‘½ä»¤ã€‚å½“è„šæœ¬æ‰§è¡Œå®ŒæˆåŽï¼Œè¿™äº›å‘½ä»¤è¢«åŒ…è£…æˆä¸€ä¸ªäº‹åŠ¡ï¼Œä¼ æ’­åˆ°AOF å’Œå…¶ä»–å®žä¾‹ã€‚ è¿™ç§æ–¹å¼çš„å¥½å¤„ å½“è„šæœ¬æ‰§è¡Œå¾ˆæ…¢çš„æ—¶å€™ï¼Œä¼šå½±å“åŠ è½½AOFé‡å»ºæ•°æ®çš„æ—¶é—´ï¼Œè¿™ç§æƒ…å†µä½¿ç”¨ script effects replication æ•ˆçŽ‡æ›´é«˜ è¿™ç§æ–¹å¼ä¼šå…è®¸è„šæœ¬ä¸­å­˜åœ¨éšæœºæ€§çš„å†™å…¥ ä½¿ç”¨æ–¹å¼12-- åœ¨æ‰§è¡ŒRediså‘½ä»¤å‰è°ƒç”¨ï¼ŒæˆåŠŸå¯ç”¨ script effects replication è¿”å›žtrueredis.replicate_commands() æ€»ç»“æ‰€ä»¥è¯´Redisæ— è®ºæ˜¯äº‹åŠ¡è¿˜æ˜¯è„šæœ¬ï¼Œå¹¶ä¸èƒ½åšåˆ°åƒå…³ç³»åž‹æ•°æ®äº‹åŠ¡ä¸€æ ·ï¼Œæ‰€ä»¥é’ˆå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¹¶ä¸é€‚åˆä½¿ç”¨Redis è€Œä¸”ä»ŽæŒä¹…åŒ–æ–¹é¢æ¥è€ƒè™‘ï¼Œè¿™ä¹Ÿä¸æ˜¯Redisçš„å¼ºé¡¹ï¼ŒRedisçš„ä¼˜åŠ¿æ­£æ˜¯åŸºäºŽå†…å­˜ï¼Œæ‰€ä»¥è¯»å†™æ€§èƒ½é«˜ã€‚è™½ç„¶å®•æœºçš„å¯èƒ½æ€§çœ‹ä¼¼å¾ˆæžç«¯ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨äº†æŸä¸ªæœåŠ¡åŽï¼Œæˆ‘ä»¬ä¼šå°½å¯èƒ½çš„ä¿è¯å®ƒçš„é«˜å¯ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦çŸ¥é“Redisçš„â€æŒä¹…åŒ–â€å¹¶ä¸èƒ½ä¿è¯æˆ‘ä»¬çš„æ•°æ®ç»å¯¹å®‰å…¨ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯å¯¹æ•°æ®ä¸€è‡´æ€§ï¼ŒæŒä¹…åŒ–è¦æ±‚å¾ˆé«˜çš„æ—¶å€™ï¼Œå…³ç³»åž‹æ•°æ®åº“ä¾æ—§æ˜¯å¾ˆå¥½çš„é€‰æ‹© å‚è€ƒRedis è®¾è®¡ä¸Žå®žçŽ° AOFRedis è®¾è®¡ä¸Žå®žçŽ° äº‹åŠ¡Redis å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹(ä¸Š)Redis å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹(ä¸‹)]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java ThreadLocal å®žçŽ°åŽŸç†]]></title>
    <url>%2Fpost%2F764a84a5.html</url>
    <content type="text"><![CDATA[ThreadLocal çº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œç®—æ˜¯Javaå¼€å‘ä¸­æ¯”è¾ƒå¸¸ç”¨çš„APIäº†ï¼Œä»Šå¤©æˆ‘ä»¬æ¥ä¸€æŽ¢ç©¶ç«Ÿ ä½¿ç”¨åœºæ™¯ThreadLocal é€‚ç”¨äºŽæ¯ä¸ªçº¿ç¨‹éœ€è¦è‡ªå·±ç‹¬ç«‹çš„å®žä¾‹ä¸”è¯¥å®žä¾‹éœ€è¦åœ¨å¤šä¸ªæ–¹æ³•ä¸­è¢«ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯å˜é‡åœ¨çº¿ç¨‹é—´éš”ç¦»ï¼Œè€Œåœ¨åŒä¸€çº¿ç¨‹å…±äº«çš„åœºæ™¯ã€‚ä¾‹å¦‚ç®¡ç†Connectionï¼Œæˆ‘ä»¬å¸Œæœ›æ¯ä¸ªçº¿ç¨‹åªä½¿ç”¨ä¸€ä¸ªConnectionå®žä¾‹ï¼Œè¿™ä¸ªæ—¶å€™ç”¨ThreadLocalå°±å¾ˆåˆé€‚ã€‚ 12345678910111213141516public class ThreadLocalDemo &#123; private static final ThreadLocal&lt;Object&gt; threadLocal = new ThreadLocal&lt;&gt;(); public static void main(String[] args) &#123; threadLocal.set(new Object()); someMethod(); &#125; static void someMethod() &#123; // èŽ·å–åœ¨threadLocalä¸­å­˜å‚¨çš„å¯¹è±¡ threadLocal.get(); // æ¸…é™¤ThreadLocalä¸­æ•°æ® threadLocal.remove(); &#125;&#125; è¿˜æœ‰ä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡åŠ¨æ€åˆ‡æ¢æ•°æ®æº https://www.jianshu.com/p/0a485c965b8bï¼ŒAOP é€šè¿‡ ThreadLocal ä¿å­˜å½“å‰çº¿ç¨‹éœ€è¦è®¿é—®çš„æ•°æ®æºçš„keyï¼ŒAbstractRoutingDataSource å†é€šè¿‡ ThreadLocal ä¸­çš„æ•°æ®åˆ‡æ¢åˆ°æŒ‡å®šçš„æ•°æ®æºï¼Œå¯¹ä¸šåŠ¡ä»£ç æ¯«æ— å…¥ä¾µ åŽŸç†åœ¨æˆ‘ä»¬äº†è§£äº†å¦‚ä½•ä½¿ç”¨ä¹‹åŽï¼Œæ¥çœ‹ä¸‹ ThreadLocal æ˜¯å¦‚ä½•å®žçŽ°çš„ ThreadLocal.get()æˆ‘ä»¬ä»Žgetæ–¹æ³•æ¥åˆ†æžï¼Œå¯ä»¥çœ‹åˆ°æ–¹æ³•ä¸­èŽ·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶é€šè¿‡å½“å‰çº¿ç¨‹å¾—åˆ°ä¸€ä¸ª ThreadLocalMapï¼Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶æŠŠè¿™ä¸ªThreadLocalMap ç†è§£ä¸ºæˆ‘ä»¬ç†Ÿæ‚‰çš„HashMapï¼Œç„¶åŽé€šè¿‡ thisï¼ˆå½“å‰ThreadLocalå¯¹è±¡ï¼‰ä½œä¸ºkeyï¼Œä»ŽMapä¸­èŽ·å–Entry æˆ‘ä»¬å†æ¥çœ‹ä¸‹ï¼ŒThreadLocalMap ä»¥åŠThreadLocalMap.Entry ä¸­çš„æ ¸å¿ƒæˆå‘˜å˜é‡ï¼ŒThreadLocalMap ä¸­å®žçŽ°äº†ä¸€ä¸ªç®€å•çš„hashè¡¨ çœ‹åˆ°è¿™é‡Œä½ å¯èƒ½è¿˜ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œç»“åˆä¸‹é¢è¿™å¼ å›¾ç†è§£ä¸€ä¸‹ï¼Œæ¯ä¸ªçº¿ç¨‹ï¼ˆThreadå¯¹è±¡ï¼‰ä¸­æœ‰ä¸€ä¸ªThreadLocalMapï¼Œä½¿çº¿ç¨‹ä¹‹é—´çš„æ•°æ®å¤©ç„¶éš”ç¦»ï¼ŒThreadLocalMap æœ‰ä¸€å¼ hashè¡¨ Entry[]ï¼Œæ¯ä¸ª Entry ä¸­å¯¹åº”å­˜å‚¨ç€ä¸€ä¸ªThreadLocalå®žä¾‹ - valueï¼Œè¿™æ ·ä½¿å¾—ä¸åŒçš„ThreadLocal å¯¹è±¡ä¹‹é—´ä¹Ÿå½¢æˆäº†éš”ç¦» ThreadLocalMap ä¸­çš„hashè¡¨æˆ‘ä»¬é€šè¿‡ ThreadLocalMap.set() æ¥äº†è§£ä¸‹å†…éƒ¨çš„hashè¡¨æ˜¯å¦‚ä½•å®žçŽ°çš„ çº¿æ€§æŽ¢æµ‹æ˜¯æŒ‡å½“å‘ç”Ÿhashå†²çªæ—¶ï¼Œåˆ©ç”¨å›ºå®šçš„ç®—æ³•å¯»æ‰¾ä¸€å®šæ­¥é•¿çš„ä¸‹ä¸ªä½ç½®ï¼ˆThreadLocalä¸­å‘ç”Ÿhashå†²çªæ—¶ï¼Œindex+1ï¼‰ï¼Œä¾æ¬¡åˆ¤æ–­ï¼Œç›´è‡³æ‰¾åˆ°èƒ½å¤Ÿå­˜æ”¾çš„ä½ç½® å¦‚æžœçº¿ç¨‹ä¸­æ“ä½œäº†å¤§é‡çš„ ThreadLocal å¯¹è±¡ï¼ŒåŠ¿å¿…ä¼šé€ æˆhashå†²çªï¼Œè¿™æ˜¯æ²¡æœ‰å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼Œå¦‚æžœå¯ä»¥çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åªä¿ç•™ä¸€ä¸ªThreadLocalå¯¹è±¡ å…³äºŽ ThreadLocal çš„ä¸€äº›æ€è€ƒ ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¼±å¼•ç”¨ å›¾3ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°hashè¡¨ä¸­ä¼šå‡ºçŽ° key == nullçš„Entryï¼Œè¿™æ˜¯å› ä¸º ThreadLocalMap.Entry çš„key ï¼ˆEntry å¯¹ThreadLocalè®¾ç½®äº†å¼±å¼•ç”¨ï¼Œå¯ä»¥å›žé¡¾ä¸€ä¸‹å›¾2ï¼‰ å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨GCæ—¶ï¼Œä¸€æ—¦å‘çŽ°äº†å¯¹è±¡åªå…·æœ‰å¼±å¼•ç”¨ï¼Œè¿™ä¸ªå¯¹è±¡ä¸€å®šè¢«å›žæ”¶ è¿™ä¹ˆåšçš„åŽŸå› ï¼šå¦‚æžœThreadLocal å¯¹è±¡éœ€è¦è¢«å›žæ”¶æ—¶ï¼ˆæ­¤æ—¶å¹¶æ²¡æœ‰è°ƒç”¨ThreadLocal.removeï¼‰ï¼Œçº¿ç¨‹ä¸­çš„ThreadLocalMap ä¸€ç›´å¼ºå¼•ç”¨ç€ ThreadLocalå¯¹è±¡ï¼Œè¿™ä¼šè®© ThreadLocalå¯¹è±¡ ä»¥åŠå¯¹åº”çš„valueå¯¹è±¡å†…å­˜æ— æ³•é‡Šæ”¾ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚è¿™ç®—æ˜¯ThreadLocalçš„ä¸€ç§å®¹é”™æœºåˆ¶ï¼Œè¿™æ ·åšä½¿å¾—äº†ThreadLocalå¯¹è±¡å¾—åˆ°äº†å›žæ”¶ï¼Œä½†æ˜¯valueçš„å†…å­˜å¹¶æ²¡æœ‰é‡Šæ”¾ï¼Œæ‰€ä»¥ThreadLocalMap çš„getã€setæ–¹æ³•ä¸­éƒ½ä¼šåŽ»å°è¯•æ¸…ç†ThreadLocalå·²ç»è¢«å›žæ”¶çš„entryã€‚ ä½¿ç”¨è¿‡åŽä¸åŠæ—¶removeä¼šæ€Žä¹ˆæ · å¾ˆå¤šåšå®¢ä¸­éƒ½å¼ºè°ƒäº†ï¼ŒThreadLocal.removeçš„é‡è¦æ€§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æ–°å¯äº†ä¸€ä¸ªçº¿ç¨‹åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨äº†ThreadLocalï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è°ƒç”¨removeï¼Œè¿™ä¼šå¯¼è‡´å­˜å‚¨çš„valueå¯¹è±¡ä¸€ç›´æ²¡æœ‰åŠžæ³•è¢«å›žæ”¶ï¼Œç›´åˆ°çº¿ç¨‹è¢«é”€æ¯ çº¿ç¨‹æ± ä¸­ä¹Ÿéœ€è¦removeå— ä»¥webçº¿ç¨‹æ± ä¸ºä¾‹ï¼Œå¦‚æžœæ¯æ¬¡éƒ½åœ¨è¿‡æ»¤å™¨ä¸­æ“ä½œåŒä¸€ä¸ªThreadLocal.setï¼Œç„¶åŽä¸šåŠ¡ä»£ç ä¸­getï¼Œä¼¼ä¹Žæ²¡ä»€ä¹ˆé—®é¢˜ã€‚è®¡ç®—å‡ºçš„hashå€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ§½ä½ä¹Ÿæ˜¯ä¸€æ ·çš„ä¼šè¦†ç›–ä¸Šä¸€æ¬¡çš„å€¼ã€‚ç¡®å®žä¸šåŠ¡ä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯æŽ¨èå¤§å®¶åœ¨ä½¿ç”¨å®Œä¹‹åŽremoveï¼Œå› ä¸ºè¿™æ ·ä¼šè®©æ— ç”¨çš„valueå¯¹è±¡æ—©ç‚¹è¢«å›žæ”¶ï¼Œåœ¨å¾ˆå¤šjavaæºç ä¸­éƒ½ä¼šçœ‹åˆ°ï¼Œå¯¹ä¸€äº›ä¸å†ä½¿ç”¨çš„å¯¹è±¡è¿›è¡Œå¦‚ä¸‹çš„help GCæ“ä½œ1object = null // help GC æ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦è®©æ— ç”¨çš„å¯¹è±¡å¤±åŽ»å¼•ç”¨ï¼Œå¸®åŠ©GC ç»¼ä¸Šæ‰€è¿° ThreadLocal ä½¿ç”¨è¿‡åŽè¦åŠæ—¶removeï¼Œå¸®åŠ©JVMé‡Šæ”¾å†…å­˜ å‚è€ƒhttps://www.jianshu.com/p/98b68c97df9b]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>æºç </tag>
        <tag>Thread</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”µå•†æŠ€æœ¯--åº“å­˜è®¾è®¡æŒ‡åŒ—]]></title>
    <url>%2Fpost%2Fc4f13c61.html</url>
    <content type="text"><![CDATA[å‰è¨€æœ€è¿‘åœ¨è§£å†³ä¸€å¥—è€ç”µå•†ç³»ç»Ÿçš„åº“å­˜â€è¶…å–â€é—®é¢˜ã€‚ä¸€ç›´ä»¥ä¸ºè¶…å–é—®é¢˜ï¼Œæœ€éš¾è§£å†³çš„æ˜¯åº“å­˜æ‰£å‡ï¼Œå®žåˆ™ä¸ç„¶ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿåœ¨è§£å†³äº†åº“å­˜æ‰£å‡é—®é¢˜ä¹‹åŽï¼Œè¿˜ä¼šä¸€ç›´æœ‰â€œè¶…å–â€çŽ°è±¡ï¼Ÿè¿™ä¸€åˆ‡çš„èƒŒåŽåˆ°åº•æ˜¯é“å¾·çš„æ²¦ä¸§ï¼Œè¿˜æ˜¯äººæ€§çš„æ‰­æ›²ï¼Œæ¬¢è¿Žæ”¶çœ‹æœ¬æœŸèµ°è¿‘ç§‘å­¦ æœ¬æ–‡å¸¦ä½ è§£å†³ä»¥ä¸‹ç”µå•†åœºæ™¯é—®é¢˜ ä¿è¯åº“å­˜çº¿ç¨‹å®‰å…¨çš„æ‰£å‡ é˜²æ­¢åº“å­˜çš„å¤šæ¬¡æ‰£å‡ã€å›žæ»š è¶…æ—¶æœªæ”¯ä»˜è¢«å–æ¶ˆçš„è®¢å•ï¼ˆå–æ¶ˆä¼šå›žæ»šåº“å­˜ï¼‰ï¼Œ å¦‚æžœæ”¶åˆ°äº†æ”¯ä»˜å›žè°ƒæ€Žä¹ˆåŠž å¦‚ä½•çº¿ç¨‹å®‰å…¨çš„æ‰£å‡åº“å­˜å…ˆæ¥è¯´è¯´åº“å­˜æ‰£å‡çš„é—®é¢˜ï¼Œè¿™æ˜¯æˆ‘ä»¬åŽŸæ¥è€ç³»ç»Ÿçš„é€»è¾‘ï¼Œæ³¨æ„ï¼è¿™é‡Œæ˜¯é”™è¯¯çš„ç¤ºä¾‹ 123456789// ä»¥ä¸‹æ˜¯ä¼ªä»£ç ï¼Œé”™è¯¯çš„ç¤ºä¾‹// æŸ¥è¯¢å‡ºGoodså¯¹è±¡$goods = selectGoodsById($id);if ($goods-&gt;num - $order_num &gt; 0) &#123; // è®¡ç®—å‡ºæ‰£å‡åŽçš„åº“å­˜ $goods-&gt;num = $goods-&gt;num - $order_num; // ä¿å­˜ save($goods);&#125; ä¸Šè¿°ä»£ç çŠ¯äº†å¤§å¿Œï¼Œå¹¶å‘æƒ…å†µä¼šå¯¼è‡´å¤šä¸ªçº¿ç¨‹è¯»åˆ°ç›¸åŒçš„åº“å­˜æ•°ï¼Œç„¶åŽæ‰£å‡ï¼Œç„¶åŽä¿å­˜åˆ°DBï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¯´ä¸‹æ­£ç¡®çš„å§¿åŠ¿ æ­£ç¡®çš„åšæ³•åˆ©ç”¨MySQL update ä¼šæŒæœ‰å½“å‰è®°å½•é”çš„ç‰¹ç‚¹ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨çš„æ‰£å‡ SQL ç¤ºä¾‹ï¼š1update kucun set num = num - ? where id = ? and num - ? &gt;= 0 æˆ‘ä»¬çš„è¿™æ¡è®°å½•æ ¹æ®ä¸»é”®æ›´æ–°ï¼Œå½“äº‹åŠ¡A update è¿™æ¡è®°å½•æ—¶ï¼Œä¼šæŒæœ‰å½“å‰è®°å½•çš„é”ï¼Œå½“äº‹åŠ¡Aæœªæäº¤æ—¶ï¼Œå…¶ä»–æƒ³è¦æ›´æ–°è¿™æ¡è®°å½•çš„äº‹åŠ¡åªèƒ½ç­‰å¾…é”é‡Šæ”¾ å…³äºŽMySQL update é”çš„ç»†èŠ‚ï¼Œæœ¬æ–‡ä¸è®¨è®ºï¼Œå¯ä»¥å‚è€ƒMySQLæ–‡æ¡£ https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.htmlhttps://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.htmlhttps://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html è™½ç„¶MySQLå¯ä»¥ä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ï¼Œä½†æ˜¯å¤§å¹¶å‘é‡åœºæ™¯ä¸‹ï¼Œå¤§é‡çš„é”ç«žäº‰ï¼Œå¯¼è‡´åº“å­˜çš„æ‰£å‡å¯èƒ½æˆä¸ºç³»ç»Ÿæ€§èƒ½çš„ç“¶é¢ˆ ä½¿ç”¨ Redis åº“å­˜æ‰£å‡ä½¿ç”¨Redisçš„ä¼˜åŠ¿å¾ˆå¤šï¼Œå•çº¿ç¨‹çš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä¿è¯äº†å¹¶å‘ä¸‹å¯ä»¥çº¿ç¨‹çš„å®‰å…¨æ‰£å‡ã€å›žæ»šåº“å­˜ï¼Œ ä»¥åŠRedisé«˜æ€§èƒ½ã€‚ è™½ç„¶Redisè§£å†³äº†çº¿ç¨‹å®‰å…¨å’Œæ€§èƒ½çš„é—®é¢˜ï¼Œä½†æ˜¯Rediså¹¶ä¸èƒ½åšåˆ°åƒMySQLé‚£æ ·ä¸€æ¡SQLå‘½ä»¤å®Œæˆåº“å­˜æ‰£å‡ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè¯»å‡ºå·²æœ‰åº“å­˜ï¼Œå†å’Œå½“å‰ä¸‹å•åº“å­˜åšä¸€ä¸ªåˆ¤æ–­æ˜¯å¦å¯ä»¥åº“å­˜æ‰£å‡ã€‚æ‰€ä»¥æœ€ä½³çš„å®žçŽ°æ–¹æ¡ˆæ˜¯é€šè¿‡Redis æ‰§è¡Œluaè„šæœ¬ï¼Œä¿è¯æ•´ä¸ªé€»è¾‘å¤„ç†æœŸé—´ï¼Œä¸ä¼šæœ‰å…¶ä»–å®¢æˆ·ç«¯æ’è¿›æ¥ 12345678910111213141516171819202122232425262728293031/** * * æ‰£å‡åº“å­˜Luaè„šæœ¬ * åº“å­˜ï¼ˆstockï¼‰-1ï¼šè¡¨ç¤ºä¸é™åº“å­˜ * åº“å­˜ï¼ˆstockï¼‰0ï¼šè¡¨ç¤ºæ²¡æœ‰åº“å­˜ * åº“å­˜ï¼ˆstockï¼‰å¤§äºŽ0ï¼šè¡¨ç¤ºå‰©ä½™åº“å­˜ * * @params åº“å­˜key * @return * -3:åº“å­˜æœªåˆå§‹åŒ– * -2:åº“å­˜ä¸è¶³ * -1:ä¸é™åº“å­˜ * å¤§äºŽç­‰äºŽ0:å‰©ä½™åº“å­˜ï¼ˆæ‰£å‡ä¹‹åŽå‰©ä½™çš„åº“å­˜ï¼‰ */const SUB_STOCK_LUA = &quot; if (redis.call(&apos;exists&apos;, KEYS[1]) == 1) then local stock = tonumber(redis.call(&apos;get&apos;, KEYS[1])); local num = tonumber(ARGV[1]); if (stock == -1) then return -1; end; if (stock &gt;= num) then return redis.call(&apos;incrby&apos;, KEYS[1], 0 - num); end; return -2; end; return -3;&quot;; æ³¨æ„ï¼šå½“å¯¹ä¸€ä¸ªè®¢å•ä¸­çš„ good_list æ‰£å‡åº“å­˜çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„ï¼Œå½“æŸä¸€ä¸ªå•†å“åº“å­˜æ‰£å‡å¤±è´¥æ—¶ï¼Œä¹‹å‰çš„æ‰£å‡çš„å•†å“åº“å­˜éœ€è¦å›žæ»šã€‚è¿™ä¼šæ¶‰åŠåˆ°å¯¹redisçš„å¤šæ¬¡æ“ä½œï¼Œä½ å¯ä»¥æŠŠæ•´ä½“é€»è¾‘å†™åˆ°ä¸€ä¸ªluaè„šæœ¬ä¸­ ä½¿ç”¨Redis åšåº“å­˜æ‰£å‡ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼ˆä¼ªä»£ç å¦‚ä¸‹ï¼‰ï¼ŒRedisæ•°æ®å’ŒMySQLæ•°æ®å¹¶ä¸èƒ½ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œå› ä¸ºRedisçš„æ•°æ®ç›¸å½“äºŽç›´æŽ¥å†™è¿›åŽ»äº†ï¼Œå¦‚æžœåœ¨éœ€è¦å›žæ»šçš„æ—¶å€™ï¼ŒRedisä¸å¯ç”¨äº†å¯¼è‡´æ•°æ®æ— æ³•å›žæ»šï¼Œæœ€ç»ˆä¼šé€ æˆMySQLæ²¡æœ‰å†™å…¥è®¢å•æ•°æ®ï¼ŒRediså´æ‰£å‡äº†åº“å­˜ 123456789101112try &#123; $db-&gt;beginTransaction(); $db-&gt;saveOrder(); $redis-&gt;reduceStock(); $db-&gt;commit(); &#125; catch (Exception $e) &#123; $db-&gt;rollback(); $redis-&gt;rollbackStock();&#125; è¿™ç§æƒ…å†µå¹¶æ²¡æœ‰ä»€ä¹ˆå¥½çš„è§£å†³åŠžæ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡ çŽ‡éžå¸¸å°çš„æ•…éšœï¼Œé¦–å…ˆæˆ‘ä»¬è‚¯å®šè¦å°½å¯èƒ½çš„ä¿è¯Redisçš„é«˜å¯ç”¨æ€§ï¼Œå…¶æ¬¡åœ¨å‘ç”Ÿè¿™ç§æƒ…å†µåŽï¼Œæˆ‘ä»¬è¦æƒ³åŠžæ³•æ¢å¤Redisä¸­çš„æ•°æ®ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥åœ¨æ•´ä¸ªé€»è¾‘ä¹‹åŽï¼Œé€‰æ‹©å¼‚æ­¥çš„æ–¹å¼ï¼ˆä¾‹å¦‚MQï¼‰å‘MySQLä¸­åŒæ­¥åº“å­˜ï¼Œå½“å‘ç”Ÿæ•…éšœåŽï¼Œä»¥MySQLæ•°æ®ä¸ºå‡†æ¢å¤æ•°æ® æ‰€ä»¥Redisæ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œæå‡æ€§èƒ½çš„åŒæ—¶ï¼Œä¹Ÿå¸¦æ¥äº†é—®é¢˜ AliSQLè¿™æ˜¯åŽæ¥æˆ‘åœ¨ç½‘ä¸Šçœ‹åˆ°çš„æ–¹æ¡ˆï¼ŒAliSQL æ˜¯é˜¿é‡Œè‡ªç ” MySQL åˆ†æ”¯ï¼ŒAliSQL é’ˆå¯¹å¹¶å‘ä¿®æ”¹åŒä¸€è®°å½•çš„æƒ…å†µï¼Œä½¿ç”¨æ•°æ®åº“å±‚é¢çš„ç¼“å†²é˜Ÿåˆ—ï¼Œé¿å…å¤§é‡äº‰é”çš„ä»£ä»·ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è¯•ä¸‹ï¼ˆé˜¿é‡Œäº‘MySQL 8.0 é›†æˆäº†è¿™ä¸€åŠŸèƒ½ï¼‰ï¼Œå¦‚æžœAliSQLè§£å†³äº†æ€§èƒ½é—®é¢˜çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ¡ˆç›¸æ¯”Redisè¦æ›´å¥½ å…³äºŽåº“å­˜å¤šæ¬¡æ‰£å‡çš„é—®é¢˜å½“è®¢å•çš„æäº¤å’Œåº“å­˜çš„æ‰£å‡åŒæ­¥è¿›è¡Œçš„æ—¶å€™ï¼Œä¸éœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ã€‚ ä¸¾ä¾‹ï¼šè®¢å•ç³»ç»Ÿç”Ÿæˆè®¢å•ä¹‹åŽï¼Œé€šè¿‡MQé€šçŸ¥åº“å­˜ç³»ç»Ÿï¼Œåº“å­˜ç³»ç»Ÿå¼‚æ­¥æ‰£å‡åº“å­˜ï¼Œè¿™ä¸ªæ—¶å€™åº“å­˜ç³»ç»Ÿå¯èƒ½ä¼šå¤šæ¬¡æ¶ˆè´¹ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜äº†ã€‚ æˆ–è€…æˆ‘ä»¬ä¸Šé¢è¯´çš„é€šè¿‡MQåŒæ­¥MySQLåº“å­˜ä¹Ÿéœ€è¦è€ƒè™‘å¯èƒ½å‘ç”Ÿå¤šæ¬¡æ‰£å‡ è§£å†³æ–¹æ¡ˆå¦‚å›¾ï¼Œé€šè¿‡è®¢å•åšä¸ºå”¯ä¸€ç´¢å¼•ä¿è¯æµæ°´è®°å½•çš„å”¯ä¸€æ€§ï¼Œä»Žè€Œä¿è¯åªèƒ½æœ‰ä¸€æ¬¡æˆåŠŸçš„æ‰£å‡ åº“å­˜å›žæ»šé—®é¢˜å¤šæ•°åšå®¢å¯¹äºŽè¶…å–çš„è®²è§£åªåœ¨äºŽåº“å­˜çš„æ‰£å‡ï¼Œä½†æ˜¯åº“å­˜æ‰£å‡å®‰å…¨äº†ï¼ŒçœŸçš„å°±å¯ä»¥ä¿è¯ä¸è¶…å–å—ï¼Ÿæˆ‘ä»¬çš„ç³»ç»Ÿåœ¨è§£å†³äº†åº“å­˜æ‰£å‡é—®é¢˜åŽï¼Œè¿˜æ˜¯å‡ºçŽ°æˆäº¤è®¢å• &gt; åº“å­˜çš„é—®é¢˜ï¼Œä¸ºæ­¤æˆ‘ä¹Ÿæ˜¯ç»žå°½è„‘æ±ï¼ŒæŠ“ç ´äº†å¤´ åœ¨å¯¹ä¸‹å•è¿›è¡ŒåŽ‹åŠ›æµ‹è¯•ä¹‹åŽï¼Œæˆ‘åšä¿¡ä¸‹å•ä¸ä¼šå‡ºçŽ°è¶…å–çš„é—®é¢˜ï¼ŒåŽæ¥æˆ‘æ€€ç–‘é—®é¢˜å‡ºåœ¨äº†åº“å­˜å›žæ»šï¼Œå¦‚æžœä¸€ä¸ªè®¢å•å›žæ»šäº†ä¸¤æ¬¡åº“å­˜ï¼ˆå–æ¶ˆè¶…æ—¶æœªæ”¯ä»˜è®¢å•çš„çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹åŒæ—¶å–æ¶ˆä¸€ä¸ªè®¢å•ï¼‰ï¼ŒåŒæ ·ä¹Ÿä¼šå‡ºçŽ°è¶…å–çš„çŽ°è±¡ã€‚ è§£å†³æ–¹æ³•ï¼šå’Œé˜²æ­¢å¤šæ¬¡æ‰£å‡ä¸€æ ·ï¼Œé‡‡ç”¨å†™å…¥è®¢å•å›žæ»šæµæ°´çš„æ–¹å¼ï¼Œä¸ªäººè®¤ä¸ºè¿™ç§æ–¹æ³•æ¯”è¾ƒåŠ é”è¦å¥½ï¼Œæ•°æ®æœ‰è¿¹å¯å¾ª è¶…æ—¶æœªæ”¯ä»˜è¢«å–æ¶ˆçš„è®¢å•æ”¶åˆ°äº†æ”¯ä»˜å›žè°ƒåœ¨è§£å†³äº†åº“å­˜å›žæ»šé—®é¢˜ä¹‹åŽï¼Œè¶…å–é—®é¢˜è¿˜æ²¡æœ‰è§£å†³ï¼Œæœ€åŽé€šè¿‡æ—¥å¿—å®šä½åˆ°äº†è¿™ä¸ªé—®é¢˜ã€‚ é—®é¢˜æè¿°ï¼šç”¨æˆ·åœ¨ç³»ç»Ÿå³å°†è‡ªåŠ¨å–æ¶ˆè®¢å•çš„å‰ä¸€çž¬é—´å®Œæˆäº†æ”¯ä»˜ï¼Œç³»ç»Ÿå–æ¶ˆäº†è¯¥è®¢å•å¹¶å›žæ»šäº†åº“å­˜ï¼ŒåŒæ—¶ç³»ç»Ÿæ”¶åˆ°äº†è¯¥è®¢å•çš„æ”¯ä»˜å›žè°ƒï¼Œè¯¥è®¢å•çš„çŠ¶æ€æ›´æ”¹ä¸ºå·²æ”¯ä»˜ï¼Œå› ä¸ºä¸è¯¥å‡ºçŽ°çš„åº“å­˜å›žæ»šå¯¼è‡´äº†â€œè¶…å–â€ ä¸‹é¢è¯´ä¸‹æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆï¼Œä»¥å¾®ä¿¡æ”¯ä»˜ä¸ºä¾‹ æˆ‘ä»¬çš„ç³»ç»Ÿåœ¨æäº¤è®¢å•ä¹‹åŽï¼Œä¼šè°ƒç”¨å¾®ä¿¡çš„ç»Ÿä¸€ä¸‹å•æŽ¥å£ï¼Œè¿™æ—¶å€™å¾®ä¿¡æ”¶åˆ°äº†æˆ‘ä»¬çš„å•†æˆ·è®¢å•å·ï¼ˆå¾®ä¿¡å·²ç»ç”Ÿæˆè®¢å•ï¼‰ï¼Œç”¨æˆ·é€‰æ‹©ä¸æ”¯ä»˜ã€‚è¶…æ—¶è‡ªåŠ¨å–æ¶ˆé€»è¾‘å¤„ç†ä¹‹å‰ï¼Œå…ˆè°ƒç”¨å¾®ä¿¡çš„å…³é—­è®¢å•æŽ¥å£ï¼Œå¦‚æžœå…³é—­æˆåŠŸï¼Œåˆ™è¿™ä¸ªæ—¶å€™ç”¨æˆ·åŽç»­æ— æ³•å¯¹è¯¥è®¢å•å‘èµ·æ”¯ä»˜ã€‚å¦‚æžœè¿”å›žè®¢å•å·²æ”¯ä»˜ï¼Œåˆ™æ— éœ€å¤„ç†è¯¥è®¢å•ï¼Œè¯¥è®¢å•ä¼šæ”¶åˆ°å¾®ä¿¡æ”¯ä»˜çš„å›žè°ƒ å‚è€ƒhttps://www.jianshu.com/p/76bc0e963172https://www.zhihu.com/question/268937734https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_3 å¦‚æžœè§‰å¾—æ–‡ç« æœ‰å¸®åŠ©ï¼Œæ¬¢è¿Žç‚¹èµžã€è½¬å‘ã€å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Œä½ çš„æ”¯æŒå°±æ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›]]></content>
      <categories>
        <category>ç”µå•†æŠ€æœ¯</category>
      </categories>
      <tags>
        <tag>ç”µå•†</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ•™ä½ å¦‚ä½•ä½¿ç”¨MySQL8é€’å½’.]]></title>
    <url>%2Fpost%2F2e0c1b4e.html</url>
    <content type="text"><![CDATA[ä¹‹å‰å†™è¿‡ä¸€ç¯‡ MySQLé€šè¿‡è‡ªå®šä¹‰å‡½æ•°çš„æ–¹å¼ï¼Œé€’å½’æŸ¥è¯¢æ ‘ç»“æž„ï¼Œä»ŽMySQL 8.0 å¼€å§‹ç»ˆäºŽæ”¯æŒäº†é€’å½’æŸ¥è¯¢çš„è¯­æ³• CTEé¦–å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ CTEï¼Œå…¨å Common Table Expressions12345WITH cte1 AS (SELECT a, b FROM table1), cte2 AS (SELECT c, d FROM table2)SELECT b, d FROM cte1 JOIN cte2WHERE cte1.a = cte2.c; cte1, cte2 ä¸ºæˆ‘ä»¬å®šä¹‰çš„CTEï¼Œå¯ä»¥åœ¨å½“å‰æŸ¥è¯¢ä¸­å¼•ç”¨ å¯ä»¥çœ‹å‡º CTE å°±æ˜¯ä¸€ä¸ªä¸´æ—¶ç»“æžœé›†ï¼Œå’Œæ´¾ç”Ÿè¡¨ç±»ä¼¼ï¼ŒäºŒè€…çš„åŒºåˆ«è¿™é‡Œä¸ç»†è¯´ï¼Œå¯ä»¥å‚è€ƒä¸‹MySQLå¼€å‘æ–‡æ¡£ï¼šhttps://dev.mysql.com/doc/refman/8.0/en/with.html#common-table-expressions-recursive-examples é€’å½’æŸ¥è¯¢å…ˆæ¥çœ‹ä¸‹é€’å½’æŸ¥è¯¢çš„è¯­æ³•1234567WITH RECURSIVE cte_name AS( SELECT ... -- return initial row set UNION ALL / UNION DISTINCT SELECT ... -- return additional row sets)SELECT * FROM cte; å®šä¹‰ä¸€ä¸ªCTEï¼Œè¿™ä¸ªCTE æœ€ç»ˆçš„ç»“æžœé›†å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ â€é€’å½’å¾—åˆ°çš„æ ‘ç»“æž„â€ï¼ŒRECURSIVEä»£è¡¨å½“å‰ CTE æ˜¯é€’å½’çš„ ç¬¬ä¸€ä¸ªSELECT ä¸º â€œåˆå§‹ç»“æžœé›†â€ ç¬¬äºŒä¸ªSELECT ä¸ºé€’å½’éƒ¨åˆ†ï¼Œåˆ©ç”¨ â€œåˆå§‹ç»“æžœé›†/ä¸Šä¸€æ¬¡é€’å½’è¿”å›žçš„ç»“æžœé›†â€ è¿›è¡ŒæŸ¥è¯¢å¾—åˆ° â€œæ–°çš„ç»“æžœé›†â€ ç›´åˆ°é€’å½’éƒ¨åˆ†ç»“æžœé›†è¿”å›žä¸ºnullï¼ŒæŸ¥è¯¢ç»“æŸ æœ€ç»ˆUNION ALL ä¼šå°†ä¸Šè¿°æ­¥éª¤ä¸­çš„æ‰€æœ‰ç»“æžœé›†åˆå¹¶ï¼ˆUNION DISTINCT ä¼šè¿›è¡ŒåŽ»é‡ï¼‰ï¼Œå†é€šè¿‡ SELECT * FROM cte; æ‹¿åˆ°æ‰€æœ‰çš„ç»“æžœé›† é€’å½’éƒ¨åˆ†ä¸èƒ½åŒ…æ‹¬ï¼š èšåˆå‡½æ•°ä¾‹å¦‚ SUM() GROUP BY ORDER BY LIMIT DISTINCT ä¸Šé¢çš„è®²è§£å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œé€šè¿‡ä¾‹å­æ…¢æ…¢æ¥ç†è§£12345678910111213141516171819WITH RECURSIVE cte (n) AS -- è¿™é‡Œå®šä¹‰çš„nç›¸å½“äºŽç»“æžœé›†çš„åˆ—åï¼Œä¹Ÿå¯åœ¨ä¸‹é¢æŸ¥è¯¢ä¸­å®šä¹‰( SELECT 1 UNION ALL SELECT n + 1 FROM cte WHERE n &lt; 5)SELECT * FROM cte;-- result+------+| n |+------+| 1 || 2 || 3 || 4 || 5 |+------+ åˆå§‹ç»“æžœé›†ä¸º n =1 è¿™æ—¶å€™çœ‹é€’å½’éƒ¨åˆ†ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œ CTEç»“æžœé›†å³æ˜¯ n =1ï¼Œæ¡ä»¶å‘çŽ°å¹¶ä¸æ»¡è¶³ n &lt; 5ï¼Œè¿”å›ž n + 1 ç¬¬äºŒæ¬¡æ‰§è¡Œé€’å½’éƒ¨åˆ†ï¼ŒCTEç»“æžœé›†ä¸º n = 2ï¼Œé€’å½’â€¦ ç›´è‡³æ¡ä»¶ä¸æ»¡è¶³ æœ€åŽåˆå¹¶ç»“æžœé›† EXAMPLEæœ€åŽæ¥çœ‹ä¸€ä¸ªæ ‘ç»“æž„çš„ä¾‹å­123456CREATE TABLE `c_tree` ( `id` int(11) NOT NULL AUTO_INCREMENT, `cname` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL, `parent_id` int(11) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci; 1234567891011121314151617mysql&gt; select * from c_tree;+----+---------+-----------+| id | cname | parent_id |+----+---------+-----------+| 1 | 1 | 0 || 2 | 2 | 0 || 3 | 3 | 0 || 4 | 1-1 | 1 || 5 | 1-2 | 1 || 6 | 2-1 | 2 || 7 | 2-2 | 2 || 8 | 3-1 | 3 || 9 | 3-1-1 | 8 || 10 | 3-1-2 | 8 || 11 | 3-1-1-1 | 9 || 12 | 3-2 | 3 |+----+---------+-----------+ 1234567891011121314151617mysql&gt; WITH RECURSIVE tree_cte as( select * from c_tree where parent_id = 3 UNION ALL select t.* from c_tree t inner join tree_cte tcte on t.parent_id = tcte.id)SELECT * FROM tree_cte;+----+---------+-----------+| id | cname | parent_id |+----+---------+-----------+| 8 | 3-1 | 3 || 12 | 3-2 | 3 || 9 | 3-1-1 | 8 || 10 | 3-1-2 | 8 || 11 | 3-1-1-1 | 9 |+----+---------+-----------+ åˆå§‹ç»“æžœé›†R0 = select * from c_tree where parent_id = 3 é€’å½’éƒ¨åˆ†ï¼Œç¬¬ä¸€æ¬¡ R0 ä¸Ž c_tree inner join å¾—åˆ° R1 R1 å†ä¸Ž c_tree inner join å¾—åˆ° R2 â€¦ åˆå¹¶æ‰€æœ‰ç»“æžœé›† R0 + â€¦ + Ri æ›´å¤šä¿¡æ¯https://dev.mysql.com/doc/refman/8.0/en/with.html]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Redissonæºç è§£æžï¼Œå¦‚ä½•åˆ©ç”¨Rediså®žçŽ°åˆ†å¸ƒå¼å¯é‡å…¥é”]]></title>
    <url>%2Fpost%2Fd5899455.html</url>
    <content type="text"><![CDATA[æœ€å¼€å§‹ä½¿ç”¨Redisson çš„apiçš„æ—¶å€™ï¼Œæˆ‘è§‰å¾—å“‡ï¼Œè¿™ä¸ªapi å¤ªç‰›é€¼äº†å±…ç„¶æœ‰åˆ†å¸ƒå¼çš„å¯é‡å…¥é”ï¼Œæ­£å¥½æœ€è¿‘ç ”ç©¶äº†ä¸‹Redissonçš„æºç ï¼Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ å‰è¨€é¦–å…ˆæˆ‘ä»¬å…ˆå›žé¡¾ä¸€ä¸‹ Java ä¸­çš„ ReentrantLock æ˜¯å¦‚ä½•å®žçŽ°çš„ï¼Ÿ è¿™é‡Œæˆ‘å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ReentrantLock å®žçŽ°çš„æ€è·¯ é”æ ‡è¯†ï¼šé€šè¿‡AQSçš„stateå˜é‡ä½œä¸ºé”æ ‡è¯†ï¼Œåˆ©ç”¨Javaçš„CASä¿è¯å¤šçº¿ç¨‹ç«žäº‰é”æ—¶çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ é˜Ÿåˆ—ï¼šæœªç«žäº‰åˆ°é”çš„çº¿ç¨‹è¿›å…¥AQSçš„é˜Ÿåˆ—å¹¶æŒ‚èµ·ï¼Œç­‰å¾…è§£é”æ—¶è¢«å”¤é†’ï¼ˆæˆ–è€…è¶…æ—¶ï¼‰ å¦‚ä½•è®¾è®¡åˆ†å¸ƒå¼å¯é‡å…¥é”é¦–å…ˆé”æ ‡è¯†ï¼Œè¿™ä¸ªåœ¨Redisä¸­å¾ˆå®¹æ˜“å®žçŽ°ï¼Œå¯ä»¥ç”¨lock name ä½œä¸ºkeyï¼Œå½“å‰çº¿ç¨‹ç”Ÿæˆä¸€ä¸ªuuidï¼Œä½œä¸ºvalueï¼ŒåŠ ä¸ŠRedis å•çº¿ç¨‹æ¨¡åž‹ï¼Œå®žçŽ°çº¿ç¨‹å®‰å…¨çš„é”ç«žäº‰ è¿™ç§æ–¹å¼åœ¨ä¹‹å‰çš„åšå®¢é‡Œä¹Ÿæåˆ°è¿‡ï¼Œå¯ä»¥å‚è€ƒä¸‹ Redisåˆ†å¸ƒå¼é”çš„æ­£ç¡®å®žçŽ°æ–¹å¼ ä½†æ˜¯å¦‚ä½•åŸºäºŽRedis åšä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåƒJavaé‚£æ ·å¯ä»¥æŒ‚èµ·å”¤é†’çº¿ç¨‹å‘¢ï¼Ÿè¿™ç‚¹æˆ‘åœ¨çœ‹æºç ä¹‹å‰ä¸€ç›´æ²¡æœ‰æƒ³åˆ°â€¦ é‚£ä¹ˆRedisson æ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿ ç­”æ¡ˆï¼šåˆ©ç”¨Redisçš„å‘å¸ƒè®¢é˜…ï¼ŒåŠ ä¸ŠJavaçš„Semaphoreï¼ˆä¿¡å·é‡ï¼Œä¸äº†è§£Semaphoreçš„å°ä¼™ä¼´å¯ä»¥Googleä¸€ä¸‹ï¼‰ Redisson åˆ†å¸ƒå¼é”å®žçŽ°æ€è·¯é”æ ‡è¯†ï¼šHash æ•°æ®ç»“æž„ï¼Œkey ä¸ºé”çš„åå­—ï¼Œfiled å½“å‰ç«žäº‰é”æˆåŠŸçº¿ç¨‹çš„â€œå”¯ä¸€æ ‡è¯†â€ï¼Œvalue é‡å…¥æ¬¡æ•° é˜Ÿåˆ—ï¼šæ‰€æœ‰ç«žäº‰é”å¤±è´¥çš„çº¿ç¨‹ï¼Œä¼šè®¢é˜…å½“å‰é”çš„è§£é”äº‹ä»¶ï¼Œåˆ©ç”¨ Semaphore å®žçŽ°çº¿ç¨‹çš„æŒ‚èµ·å’Œå”¤é†’ æºç åˆ†æžæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹tryLockæ–¹æ³•çš„æºç  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879 public boolean tryLock(long waitTime, long leaseTime, TimeUnit unit) throws InterruptedException &#123; long time = unit.toMillis(waitTime); long current = System.currentTimeMillis(); long threadId = Thread.currentThread().getId(); // å°è¯•èŽ·å–é”ï¼Œè¿”å›žnull ä»£è¡¨èŽ·å–é”æˆåŠŸï¼Œå½“èŽ·å–é”å¤±è´¥æ—¶è¿”å›žå½“å‰é”çš„é‡Šæ”¾æ—¶é—´ Long ttl = tryAcquire(leaseTime, unit, threadId); // lock acquired if (ttl == null) &#123; return true; &#125; // å¦‚æžœæ­¤æ—¶å·²ç»è¶…è¿‡ç­‰å¾…æ—¶é—´åˆ™èŽ·å–é”å¤±è´¥ time -= System.currentTimeMillis() - current; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; current = System.currentTimeMillis(); // è®¢é˜…è§£é”äº‹ä»¶ RFuture&lt;RedissonLockEntry&gt; subscribeFuture = subscribe(threadId); // ç­‰å¾…è®¢é˜…æˆåŠŸï¼ŒæˆåŠŸåŽå”¤é†’å½“å‰çº¿ç¨‹ if (!await(subscribeFuture, time, TimeUnit.MILLISECONDS)) &#123; if (!subscribeFuture.cancel(false)) &#123; subscribeFuture.onComplete((res, e) -&gt; &#123; if (e == null) &#123; unsubscribe(subscribeFuture, threadId); &#125; &#125;); &#125; acquireFailed(threadId); return false; &#125; try &#123; // å†æ¬¡åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦è¶…æ—¶ time -= System.currentTimeMillis() - current; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; while (true) &#123; long currentTime = System.currentTimeMillis(); // å°è¯•èŽ·å–é” ttl = tryAcquire(leaseTime, unit, threadId); // lock acquired if (ttl == null) &#123; return true; &#125; time -= System.currentTimeMillis() - currentTime; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; // waiting for message currentTime = System.currentTimeMillis(); if (ttl &gt;= 0 &amp;&amp; ttl &lt; time) &#123; // ç­‰å¾…è§£é”æ¶ˆæ¯ï¼Œæ­¤å¤„åˆ©ç”¨Semaphoreï¼Œé”æœªé‡Šæ”¾æ—¶ï¼Œpermits=0ï¼Œçº¿ç¨‹å¤„äºŽæŒ‚èµ·çŠ¶æ€ // å½“å‘å¸ƒè§£é”æ¶ˆæ¯æ—¶ï¼Œå½“å‰çš„Semaphoreå¯¹è±¡çš„release() permits=1 // æ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’ï¼ŒåŽ»å°è¯•ç«žäº‰é” getEntry(threadId).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS); &#125; else &#123; getEntry(threadId).getLatch().tryAcquire(time, TimeUnit.MILLISECONDS); &#125; time -= System.currentTimeMillis() - currentTime; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; &#125; &#125; finally &#123; unsubscribe(subscribeFuture, threadId); &#125;// return get(tryLockAsync(waitTime, leaseTime, unit)); &#125; tryAcquire(leaseTime, unit, threadId); è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ä¸‹é¢ä¼šåˆ†æžï¼ŒçŽ°åœ¨æˆ‘ä»¬åªéœ€è¦çŸ¥é“è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥èŽ·å–é”å°±å¯ä»¥äº† è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å·²ç»å¯ä»¥ç†æ¸…Redissonå¯é‡å…¥é”çš„æ€è·¯äº† èŽ·å–é” å¦‚æžœèŽ·å–é”å¤±è´¥ï¼Œè®¢é˜…è§£é”äº‹ä»¶ ä¹‹åŽæ˜¯ä¸€ä¸ªæ— é™å¾ªçŽ¯12345678910while(true) &#123; // å°è¯•èŽ·å–é” // åˆ¤æ–­æ˜¯å¦è¶…æ—¶ // ç­‰å¾…è§£é”æ¶ˆæ¯é‡Šæ”¾ä¿¡å·é‡ //ï¼ˆæ­¤æ—¶æ¯ä¸ªJavaå®¢æˆ·ç«¯éƒ½å¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè¢«å”¤é†’ï¼‰ // åˆ¤æ–­æ˜¯å¦è¶…æ—¶&#125; åˆ©ç”¨ä¿¡å·é‡ï¼Œåˆç†æŽ§åˆ¶çº¿ç¨‹å¯¹é”çš„ç«žäº‰ï¼Œåˆç†åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œå¯ä»¥è¯´åšçš„ç°å¸¸çš„å¥ˆæ–¯äº† éœ€è¦æ³¨æ„ï¼š!await(subscribeFuture, time, TimeUnit.MILLISECONDS) ï¼Œè¿™é‡Œå¾ˆå¤šåšå®¢éƒ½è§£é‡Šé”™äº†ï¼Œè¿™é‡Œå¹¶ä¸æ˜¯ç­‰å¾…å‘å¸ƒè§£é”æ¶ˆæ¯ï¼Œåªè¦è®¢é˜…äº‹ä»¶æˆåŠŸåŽï¼Œå°±ä¼šå¾€ä¸‹æ‰§è¡Œï¼ŒçœŸæ­£ç­‰å¾…è§£é”æ¶ˆæ¯çš„æ˜¯ getEntry(threadId).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS); è¿™é‡Œä½ å¯èƒ½ä¸ä¿¡ï¼Œä¸ºä»€ä¹ˆæˆ‘è¯´çš„å°±å¯¹å•Šï¼Œdebugä¸€ä¸‹ä½ å°±çŸ¥é“ tryLockInnerAsynctryAcquire å†…éƒ¨ä¾é  tryLockInnerAsync æ¥å®žçŽ°èŽ·å–é”çš„é€»è¾‘ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹æºç 123456789101112131415161718192021222324252627&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) &#123; internalLockLeaseTime = unit.toMillis(leaseTime); return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, command, // æ˜¯å¦å­˜åœ¨é” "if (redis.call('exists', KEYS[1]) == 0) then " + // ä¸å­˜åœ¨åˆ™åˆ›å»º "redis.call('hset', KEYS[1], ARGV[2], 1); " + // è®¾ç½®è¿‡æœŸæ—¶é—´ "redis.call('pexpire', KEYS[1], ARGV[1]); " + // ç«žäº‰é”æˆåŠŸ è¿”å›žnull "return nil; " + "end; " + // å¦‚æžœé”å·²ç»è¢«å½“å‰çº¿ç¨‹èŽ·å– "if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then " + // é‡å…¥æ¬¡æ•°åŠ 1 "redis.call('hincrby', KEYS[1], ARGV[2], 1); " + "redis.call('pexpire', KEYS[1], ARGV[1]); " + "return nil; " + "end; " + // é”è¢«å…¶ä»–çº¿ç¨‹èŽ·å–ï¼Œè¿”å›žé”çš„è¿‡æœŸæ—¶é—´ "return redis.call('pttl', KEYS[1]);", // ä¸‹é¢ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º KEYS[1], ARGV[1], ARGV[2] // å³é”çš„nameï¼Œé”é‡Šæ”¾æ—¶é—´ï¼Œå½“å‰çº¿ç¨‹å”¯ä¸€æ ‡è¯† Collections.&lt;Object&gt;singletonList(getName()), internalLockLeaseTime, getLockName(threadId));&#125; tryLockInnerAsync ä¸­åˆ©ç”¨luaè„šæœ¬ å’Œ Redis å•çº¿ç¨‹çš„ç‰¹ç‚¹æ¥å®žçŽ°é”çš„ç«žäº‰ è¿™é‡Œå¯ä»¥çœ‹åˆ°é”çš„ç»“æž„ï¼Œå’Œæˆ‘ä»¬ä¸Šæ–‡æ‰€è¯´çš„ä¸€æ ·ï¼ŒHash æ•°æ®ç»“æž„ï¼Œkey ä¸ºé”çš„nameï¼Œfiled å½“å‰ç«žäº‰é”æˆåŠŸçº¿ç¨‹çš„â€å”¯ä¸€æ ‡è¯†â€ï¼Œvalue é‡å…¥æ¬¡æ•° unlockInnerAsyncæŽ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹è§£é”çš„æ ¸å¿ƒä»£ç 123456789101112131415161718192021222324252627282930protected RFuture&lt;Boolean&gt; unlockInnerAsync(long threadId) &#123; return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN, // ç”¨é”çš„nameå’Œçº¿ç¨‹å”¯ä¸€æ ‡è¯†åŽ»åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™æ ·çš„é”®å€¼å¯¹ // è§£é“ƒè¿˜é¡»ç³»é“ƒäººï¼Œä¸å­˜åœ¨åˆ™æ— æƒè§£é”ï¼Œè¿”å›žnull "if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then " + "return nil;" + "end; " + // è§£é”é€»è¾‘ // å†²å…¥æ¬¡æ•°-1 "local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); " + // å¦‚æžœå¤§äºŽ0 ä»£è¡¨å½“å‰çº¿ç¨‹é‡å…¥é”å¤šæ¬¡æ— æ³•è§£é”ï¼Œæ›´æ–°é”çš„æœ‰æ•ˆæ—¶é—´ "if (counter &gt; 0) then " + "redis.call('pexpire', KEYS[1], ARGV[2]); " + "return 0; " + "else " + // è§£é”ï¼Œåˆ é™¤key "redis.call('del', KEYS[1]); " + // å‘å¸ƒè§£é”æ¶ˆæ¯ "redis.call('publish', KEYS[2], ARGV[1]); " + "return 1; "+ "end; " + "return nil;", // KEYS[1]ï¼ŒKEYS[2] // é”çš„nameï¼Œå‘å¸ƒè®¢é˜…çš„Channel Arrays.&lt;Object&gt;asList(getName(), getChannelName()), // ARGV[1] ~ ARGV[3] // è§£é”æ¶ˆæ¯ï¼Œé‡Šæ”¾æ—¶é—´ï¼Œå½“å‰çº¿ç¨‹å”¯ä¸€æ ‡è¯† LockPubSub.UNLOCK_MESSAGE, internalLockLeaseTime, getLockName(threadId));&#125; å‘å¸ƒè§£é”æ¶ˆæ¯åŽï¼Œä¼šè°ƒç”¨åˆ°LockPubSub çš„ onMessageï¼Œé‡Šæ”¾ä¿¡å·é‡ï¼Œå”¤é†’ç­‰å¾…é”çš„çº¿ç¨‹1234567891011121314151617181920212223242526272829303132333435363738public class LockPubSub extends PublishSubscribe&lt;RedissonLockEntry&gt; &#123; public static final Long UNLOCK_MESSAGE = 0L; public static final Long READ_UNLOCK_MESSAGE = 1L; public LockPubSub(PublishSubscribeService service) &#123; super(service); &#125; @Override protected RedissonLockEntry createEntry(RPromise&lt;RedissonLockEntry&gt; newPromise) &#123; return new RedissonLockEntry(newPromise); &#125; @Override protected void onMessage(RedissonLockEntry value, Long message) &#123; if (message.equals(UNLOCK_MESSAGE)) &#123; Runnable runnableToExecute = value.getListeners().poll(); if (runnableToExecute != null) &#123; runnableToExecute.run(); &#125; // é‡Šæ”¾ä¿¡å·é‡ value.getLatch().release(); &#125; else if (message.equals(READ_UNLOCK_MESSAGE)) &#123; while (true) &#123; Runnable runnableToExecute = value.getListeners().poll(); if (runnableToExecute == null) &#123; break; &#125; runnableToExecute.run(); &#125; value.getLatch().release(value.getLatch().getQueueLength()); &#125; &#125;&#125; å‚è€ƒ æ…¢è°ˆ Redis å®žçŽ°åˆ†å¸ƒå¼é” ä»¥åŠ Redisson æºç è§£æž https://www.programcreek.com/java-api-examples/?code=rollenholt-SourceReading/redisson/redisson-master/src/main/java/org/redisson/RedissonLock.java æ¬¢è¿Žç‚¹èµžã€è½¬å‘ã€‚ä½ çš„æ”¯æŒå°±æ˜¯å¯¹æˆ‘æœ€å¤§çš„å¸®åŠ©]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>é”</tag>
        <tag>Redis</tag>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>æºç </tag>
        <tag>Redisson</tag>
        <tag>ReentrantLock</tag>
        <tag>åˆ†å¸ƒå¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQLä¼˜åŒ–å®žæˆ˜--ç´¢å¼•ç¯‡]]></title>
    <url>%2Fpost%2F1e0091db.html</url>
    <content type="text"><![CDATA[å…³äºŽSQLä¼˜åŒ–ï¼Œè¿™ä¸ªé—®é¢˜ï¼Œç›¸ä¿¡å¤§å®¶è¿‡å¤šè¿‡å°‘éƒ½æœ‰è¿‡ä¸€äº›äº†è§£ã€‚æœ€è¿‘æˆ‘ä¹Ÿåœ¨ç ”ç©¶SQLä¼˜åŒ–æ–¹é¢çš„ä¸œè¥¿ï¼Œåˆ†äº«ä¸€äº›ç»éªŒã€‚ é¦–å…ˆç®€å•ä»‹ç»ä¸‹ç´¢å¼•ï¼Œâ€œç´¢å¼•â€ æ˜¯SQLä¼˜åŒ–ä¸­å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†ï¼ˆä½†æ˜¯ç´¢å¼•å¹¶ä¸æ˜¯ä¼˜åŒ–çš„å”¯ä¸€é€‰é¡¹ï¼‰ ç´¢å¼•åŽŸç†ç®€è¿°å¦‚ä½•ç†è§£ç´¢å¼•ï¼Ÿç´¢å¼•å…¶å®žå°±æ˜¯ä¸€ç§æ•°æ®ç»“æž„ï¼Œç”¨äºŽå¿«é€Ÿå®šä½å’Œè®¿é—®æ•°æ®åº“ä¸­çš„æ•°æ®ã€‚ é€šå¸¸æ¥è¯´ç´¢å¼•ä½¿ç”¨çš„æ•°æ®ç»“æž„æ˜¯ B-Tree / B+Treeã€‚ä»¥B-Treeä¸ºä¾‹ï¼Œå‡è®¾æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨100ä¸ªKeyï¼Œä¸‰å±‚çš„B-Tree å¯å­˜å‚¨ä¸€ç™¾ä¸‡æ•°æ®ï¼Œå¦‚æžœå°†æ ¹èŠ‚ç‚¹å­˜å…¥å†…å­˜ä¸­çš„è¯ï¼Œåªéœ€è¦è¯»å–ä¸¤æ¬¡ç£ç›˜å°±å¯ä»¥ä»Ž100ä¸‡æ•°æ®ä¸­æ‰¾åˆ°æŒ‡å®šæ•°æ® å…³äºŽB-Tree æŽ¨èé˜…è¯»è¿™ç¯‡ https://www.geeksforgeeks.org/introduction-of-b-tree-2/ åŒ…å«B-Treeçš„æŸ¥è¯¢ï¼Œæ–°å¢žï¼Œåˆ é™¤æ“ä½œå¦‚ä½•å®žçŽ° MySQL æ‰§è¡Œè®¡åˆ’SQLä¼˜åŒ–ä¸­æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’æ˜¯å¿…ä¸å¯å°‘çš„ä¸€é¡¹ï¼Œé€šè¿‡ explain å…³é”®å­—å¯ä»¥æŸ¥çœ‹MySQLä¸­çš„æ‰§è¡Œè®¡åˆ’ æ³¨ï¼š\G å«ä¹‰æ˜¯çºµå‘æ˜¾ç¤ºç»“æžœ å¦‚æžœä¹‹å‰æ²¡æœ‰äº†è§£çš„ EXPLAIN çš„åŒå­¦ï¼Œçœ‹åˆ°è¿™ä¸ªåˆ—è¡¨è‚¯å®šæ˜¯ä¸€è„¸æ‡µé€¼ã€‚æ²¡å…³ç³»æˆ‘ä»¬å…ˆæ¥æŒ‘å‡ ä¸ªé‡è¦çš„å±žæ€§è®¤è¯†ä¸€ä¸‹ã€‚ typeï¼šALL ä»£è¡¨å…¨è¡¨æ‰«æ keyï¼šä»£è¡¨ä½¿ç”¨çš„ç´¢å¼•ï¼ŒNULL ä»£è¡¨æ²¡æœ‰ä½¿ç”¨ç´¢å¼• rowsï¼šæ‰«æè¡Œæ•° å…³äºŽexplain å†æ‰©å±•ä¸€ä¸‹ï¼Œå…ˆæ‰§è¡Œ explain extended ...; ï¼Œå†æ‰§è¡Œ SHOW WARNINGS å¯ä»¥çœ‹åˆ°MySQLä¼˜åŒ–å™¨å¯¹æˆ‘ä»¬çš„SQLåšäº†ä»€ä¹ˆä¼˜åŒ–ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º åˆ©ç”¨ç´¢å¼•æ¥ä¼˜åŒ–SQL ä½¿ç”¨ç´¢å¼•çš„ä¼˜ç‚¹ï¼šå‡å°‘æœåŠ¡å™¨æ‰«æçš„æ•°æ®é‡ã€é¿å…æŽ’åºå’Œä¸´æ—¶è¡¨ã€å°†éšæœºI/Oå˜ä¸ºé¡ºåºI/O é€šè¿‡ä¸‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ·»åŠ äº†ç´¢å¼•ä¹‹åŽæ‰«æè¡Œæ•°ä»Žä¸‰åä¸‡è¡Œé™åˆ°äº†1ï¼Œæ€§èƒ½æå‡å¯æƒ³è€ŒçŸ¥ ç”Ÿäº§çŽ¯å¢ƒè¦æ³¨æ„ï¼Œåˆ›å»ºç´¢å¼•æ˜¯ä¸€ä¸ªéžå¸¸è€—æ—¶çš„æ“ä½œï¼Œå¹¶ä¸”ä¼šé˜»å¡žå…¶ä»–æ“ä½œã€‚ ç”Ÿäº§çŽ¯å¢ƒæ·»åŠ ç´¢å¼•æœ‰æ²¡æœ‰ä»€ä¹ˆå®Œç¾Žæ–¹æ¡ˆï¼Ÿæœ‰çš„ï¼Œå¦‚æžœä½ çš„MySQLä½¿ç”¨ä¸»ä»Žç­–ç•¥çš„æ—¶å€™ï¼Œå¯ä»¥åƒNginxä¸åœæœºå‡çº§webæœåŠ¡é‚£æ ·ï¼Œå…ˆç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ä¸ºè¯¥èŠ‚ç‚¹æ‰§è¡Œ ALTER TABLE æ“ä½œï¼Œç„¶åŽå·´æ‹‰å·´æ‹‰ï¼Œå› ä¸ºå…·ä½“æˆ‘ä¹Ÿæ²¡æ“ä½œè¿‡å°±ä¸ç»†è¯´äº†ï¼Œæ„Ÿå…´è¶£å¤§å®¶å¯ä»¥Googleä¸€ä¸‹ï¼ŒåŠ¨æ‰‹å°è¯•ä¸€ä¸‹ã€‚å¦‚æžœæ˜¯å•æœºéƒ¨ç½²çš„è¯ï¼Œåªèƒ½ç”¨æˆ·å°‘çš„æ—¶å€™åœ¨æ‰§è¡Œè¿™ç§æ“ä½œäº† ä½¿ç”¨ç´¢å¼•è¿žæŽ¥è¡¨ç´¢å¼•ä¹Ÿå¯ä»¥æé«˜è¡¨è¿žæŽ¥çš„æ€§èƒ½ï¼Œä¸‹é¢æ˜¯ä¸ªä¾‹å­ï¼Œç”¨æˆ·è¡¨å·¦è¿žè®¢å•è¡¨ï¼Œå¯¹user_id æ·»åŠ ç´¢å¼•çš„å‰åŽå¯¹æ¯” likeä¼˜åŒ– é€šè¿‡ä¸Šè¿°ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¦‚æžœæ¨¡ç³ŠæŸ¥è¯¢æ—¶ä»¥%å¼€å¤´çš„è¯ï¼ŒMySQLæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œä½†æ˜¯é€šå¸¸æ¥è¯´æ¨¡ç³ŠæŸ¥è¯¢æ—¶æˆ‘ä»¬çš„åŒ¹é…æ–¹å¼éƒ½ä¼šæ˜¯ %xxx%ï¼Œé‚£ä¹ˆå¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ è¿™é‡Œå¯ä»¥é€šè¿‡å­˜â€œåå€¼â€çš„æ–¹å¼å·§å¦™çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚æˆ‘çŽ°åœ¨åœ¨æ•°æ®åº“åŠ ä¸€åˆ— reverse_order_no å­˜å‚¨è®¢å•å·çš„åå€¼ï¼ˆå¹¶æ·»åŠ ç´¢å¼•ï¼‰ï¼ŒåŒ¹é…çš„æ—¶å€™å†é€šè¿‡ REVERSE(â€˜%910â€™) å‡½æ•°å°†å‚æ•°å–åã€‚ è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨ orï¼Œå¦‚ä¸‹å›¾ï¼ŒæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ä¼šå‘çŽ°Extra å±žæ€§è¿”å›ž &quot;Using sort_union(order_no,reverse_order_no); Using where&quot; è¿™é‡Œä»£è¡¨MySQLå‘ç”Ÿäº†ç´¢å¼•åˆå¹¶ï¼ŒåŽæ–‡æˆ‘ä»¬ä¼šè®²åˆ° æŽ’åºä»¥åŠå¤šåˆ—ç´¢å¼•æŽ’åºéœ€è¦åŠ ç´¢å¼•ï¼ç›¸ä¿¡å¤§å®¶å¯èƒ½çŸ¥é“è¿™ä¸ªé“ç†ï¼Œä½†æ˜¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œuser_id å’Œ addtime ä¸¤åˆ—éƒ½å»ºç«‹äº†ç´¢å¼•ï¼Œé‚£ä¹ˆä¸‹é¢è¿™æ¡æŸ¥è¯¢æŽ’åºä½¿ç”¨ç´¢å¼•äº†å—ï¼Ÿ ç­”æ¡ˆæ˜¯ï¼šå¹¶æ²¡æœ‰ï¼ä¸ºä»€ä¹ˆï¼Ÿæ³¨æ„ Extra ä¸­çš„ using filesortï¼Œä»£è¡¨MySQL ä½¿ç”¨äº†å†…éƒ¨æ–‡ä»¶æŽ’åºç®—æ³•å¯¹ç»“æžœé›†è¿›è¡Œäº†æŽ’åºã€‚MySQL é€šå¸¸åœ¨ä¸€ä¸ªè¡¨ä¸Šåªé€‰æ‹©ä¸€ä¸ªç´¢å¼•ï¼ˆæœ‰ä¾‹å¤–çš„æƒ…å†µï¼‰ï¼Œè¿™ç§æƒ…å†µå¦‚æžœæˆ‘ä»¬å¸Œæœ›æŽ’åºä½¿ç”¨ç´¢å¼•çš„è¯ï¼Œå¯ä»¥å»ºç«‹ä¸€ä¸ªå¤šåˆ—ç´¢å¼•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º è€Œä¸”å¤šåˆ—ç´¢å¼•æœ€å·¦è¾¹çš„åˆ—ï¼Œå¯ä»¥å½“ä½œå•åˆ—ç´¢å¼•æ¥ä½¿ç”¨ MySQL ä¼˜åŒ–å™¨ç‰¹æ€§æˆ‘ä»¬åˆšåˆšè¯´è¿‡ MySQL é€šå¸¸åœ¨ä¸€ä¸ªè¡¨ä¸Šåªé€‰æ‹©ä¸€ä¸ªç´¢å¼•ï¼Œå¦‚ä½•ç†è§£ï¼Ÿä¾‹å¦‚ç´¢å¼•Aå’Œç´¢å¼•B ä¸€ä¸ªéœ€è¦æ‰«æåä¸‡è¡Œï¼Œä¸€ä¸ªéœ€è¦æ‰«æäº”ä¸‡è¡Œï¼Œé‚£ä¹ˆMySQLä¸€å®šé€‰æ‹©å¼€é”€æœ€å°çš„ç´¢å¼•æ–¹å¼ã€‚ åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼ŒMySQL ä¼šé€‰æ‹© Index Mergeï¼ˆç´¢å¼•åˆå¹¶ï¼‰ï¼Œå³åœ¨ä¸€ä¸ªè¡¨ä¸Šä½¿ç”¨å¤šä¸ªç´¢å¼• Unionï¼šä¸¤ä¸ªåŸºæ•°å¾ˆé«˜çš„ç´¢å¼•æ‰§è¡ŒORæ“ä½œæ—¶ Sort-Unionï¼šä¸Žä¸Šè¿°ç±»ä¼¼ï¼Œä¸€æ—¦orçš„å·¦å³ä¸¤è¾¹å‡ºçŽ°èŒƒå›´æŸ¥è¯¢ï¼Œä¼šä½¿ç”¨è¯¥ç®—æ³•ï¼ŒåŒºåˆ«æ˜¯Sort-Unionä¼šè¿›è¡ŒæŽ’åº intersectï¼šé’ˆå¯¹å”¯ä¸€å€¼ä¸å¤šçš„ç´¢å¼•åˆ—ï¼Œä¾‹å¦‚åœ¨ is_payï¼ˆ0-æœªæ”¯ä»˜ï¼Œ1-æ”¯ä»˜ï¼‰ï¼Œis_sendï¼ˆ0-æœªå‘è´§ï¼Œ1-å‘è´§ï¼‰ ä¸¤åˆ—å»ºç«‹ç´¢å¼•ï¼ŒæŸ¥è¯¢å·²æ”¯ä»˜å¹¶ä¸”æœªå‘è´§çš„è®¢å•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º æ ¹æ®MySQL 5.7å¼€å‘æ–‡æ¡£æ‰€ç¤ºï¼Œè¿˜æœ‰ä¸€ç§ä¼šä½¿ç”¨intersectï¼ŒInnoDB ä¸»é”®ä¸Šçš„ä»»ä½•èŒƒå›´æœç´¢ å…³äºŽIndex Mergeçš„æ›´å¤šä¿¡æ¯ï¼Œå‚è€ƒMySQLå¼€å‘æ–‡æ¡£https://dev.mysql.com/doc/refman/5.7/en/index-merge-optimization.html ç´¢å¼•çš„å½±å“æ·»åŠ ç´¢å¼•è™½ç„¶å¯ä»¥æå‡æˆ‘ä»¬çš„SQLæ€§èƒ½ï¼Œä½†æ˜¯éšä¹‹è€Œæ¥ä¹Ÿä¼šå¸¦æ¥ä¸€å®šçš„å¼€é”€ æ•°æ®æ’å…¥å’Œæ›´æ–°çš„æ€§èƒ½ï¼Œå› ä¸ºéœ€è¦æž„å»ºç´¢å¼•çš„åŽŸå› ï¼Œåœ¨æ•°æ®é‡å¤§çš„æ—¶å€™ä¼šæ¯”è¾ƒæ˜Žæ˜¾ï¼Œä¸‹å›¾æ˜¯ ã€ŠEffective MySQLä¹‹SQLè¯­å¥æœ€ä¼˜åŒ–ã€‹ä¸­å¯¹æ·»åŠ ç´¢å¼•å‰åŽçš„æ’å…¥æ€§èƒ½å¯¹æ¯” ç£ç›˜ç©ºé—´çš„å½±å“ï¼ŒåŒæ ·ä¹Ÿæ˜¯æ¥è‡ªäºŽä¹¦ä¸­çš„æµ‹è¯• å¯ä»¥çœ‹åˆ°åœ¨æ·»åŠ äº†ç´¢å¼•ä¹‹åŽï¼Œç©ºé—´å ç”¨æ˜¯åŽŸæ¥çš„7å€ï¼Œåœ¨æ•°æ®é‡åºžå¤§æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªéœ€è¦å…³æ³¨çš„ç‚¹ã€‚ è¿˜æœ‰éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨MySQL Innodb ä¸­æœ‰èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•ï¼Œä¸€èˆ¬æ¥è¯´ä¸»é”®å°±æ˜¯èšç°‡ç´¢å¼•ï¼Œè€Œå…¶ä»–çš„ç´¢å¼•éƒ½æ˜¯äºŒçº§ç´¢å¼•ã€‚ äºŒçº§ç´¢å¼•æ‰€å­˜å‚¨çš„å€¼æ˜¯èšç°‡ç´¢å¼•ã€‚æ‰€ä»¥å½“ä½¿ç”¨äºŒçº§ç´¢å¼•æ¥è¿›è¡Œæ£€ç´¢æ—¶ï¼ŒMySQL ä¼šå…ˆé€šè¿‡è¯¥ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„èšç°‡ç´¢å¼•ï¼Œå†é€šè¿‡è¯¥èšç°‡ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„æ•°æ®ã€‚è¿™æ—¶ä½¿ç”¨å ç”¨å­—èŠ‚æ›´å°çš„ç±»åž‹æ¥åšä¸»é”®ä¼šæ›´å¥½ï¼Œä¼šèŠ‚çœç´¢å¼•å ç”¨ç©ºé—´ å‚è€ƒ Effective MySQLä¹‹SQLè¯­å¥æœ€ä¼˜åŒ–]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>ç´¢å¼•</tag>
        <tag>sqlä¼˜åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Securityå®žæˆ˜(äºŒ) åŠ¨æ€æƒé™]]></title>
    <url>%2Fpost%2Fb718a659.html</url>
    <content type="text"><![CDATA[å¥½æ¶ˆæ¯å¥½æ¶ˆæ¯ï¼Securityç³»åˆ—ç»ˆäºŽæœ‰äº†ç¬¬äºŒæœŸï¼Œæœ€è¿‘åœ¨çœ‹é¡¹ç›®æºç å¿ä¸ä½åˆæžèµ·æ¥Spring Securityï¼Œæ¥ç»™å¤§å®¶åˆ†äº«ä¸€ä¸‹ï¼Œè™½ç„¶å’Œä¸Šä¸€èŠ‚è¯´å¥½çš„å†…å®¹ä¸åŒðŸ¤­ å›žé¡¾ä¸ŠèŠ‚æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•è¿›è¡Œç®€å•çš„æƒé™é…ç½®ï¼ŒåŒ…æ‹¬urlæƒé™å’Œæ–¹æ³•æƒé™ï¼Œè¿˜æœ‰å¦‚ä½•æŽˆäºˆç”¨æˆ·æƒé™ã€‚12345678910111213141516171819protected void configure(HttpSecurity http) throws Exception &#123; http .authorizeRequests() .antMatchers("/", "/home").permitAll() // æµ‹è¯•é…ç½®URLæƒé™ .antMatchers("/match/**").hasAuthority("sys:match") // å¯¹æŸURLæ·»åŠ å¤šä¸ªæƒé™ï¼Œå¯ä»¥å¤šæ¬¡é…ç½® .antMatchers("/match/**").hasAuthority("sys:mm") .anyRequest().authenticated() .and() .formLogin() .loginPage("/login") .permitAll() .and() .logout() .permitAll() .and() ;&#125; ä½†æ˜¯å¦‚æžœçŽ°åœ¨ä½ çš„ä¸šåŠ¡ç³»ç»Ÿè¦æ±‚åŠ¨æ€æƒé™å‘¢ï¼Ÿ æ¯”å¦‚ç”¨æˆ·æƒé™å˜æ›´äº†ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°æž„å»ºSecurityä¸Šä¸‹æ–‡ä¸­Authentication å¯¹è±¡ï¼Œè¿™è¿˜å¥½è¯´ã€‚å¦‚æžœè¯´æŸä¸ªæŽ¥å£çš„æƒé™ä¿®æ”¹äº†ï¼Œå¦‚æžœæŒ‰ç…§ä¸Šè¿°çš„æ–¹æ³•æ¥åšçš„è¯ï¼Œæ˜¯ä¸å¯èƒ½å®žçŽ°åŠ¨æ€ä¿®æ”¹çš„ã€‚ æœ¬èŠ‚æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹Spring Security å¦‚ä½•å®žçŽ°åŠ¨æ€æƒé™ å®žçŽ°åŽŸç†FilterSecurityInterceptor è´Ÿè´£ Securityä¸­çš„æƒé™æŽ§åˆ¶ï¼Œå…¶æ ¸å¿ƒä»£ç åœ¨çˆ¶ç±»AbstractSecurityInterceptorä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ è¿™é‡Œæˆ‘åˆ äº†ä¸€äº›ä¸Žæ ¸å¿ƒé€»è¾‘æ— å…³çš„ä»£ç ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨çº¢æ¡†é‡Œçš„å†…å®¹ è¿™æ—¶å€™èªæ˜Žçš„ä½ åº”è¯¥å·²ç»æ˜Žç™½äº†FilterSecurityInterceptoræ˜¯å¦‚ä½•ç®¡ç†æƒé™çš„ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥è‡ªå·±å®žçŽ°ä¸Šé¢çš„AccessDecisionManagerå’ŒSecurityMetadataSourceæ¥å®žçŽ°æˆ‘ä»¬çš„åŠ¨æ€æƒé™ ä½†æ˜¯å…ˆåˆ«æ€¥ï¼Œå…ˆçœ‹çœ‹AccessDecisionManagerçš„é»˜è®¤å®žçŽ°AffirmativeBased è¿™ä»£ç å†™çš„æœ‰æ„æ€äº†ï¼Œé€šè¿‡éåŽ†æ‰€æœ‰çš„Voterï¼Œæ¯ä¸ªVoterå®žçŽ°å…·ä½“çš„åˆ¤æ–­é€»è¾‘ï¼Œè¿”å›ž 1ï¼Œ0ï¼Œ-1ï¼ˆåˆ†åˆ«ä»£è¡¨åŒæ„ã€å¼ƒæƒã€æ‹’ç»ï¼‰ï¼Œå½“å­˜åœ¨æ‹’ç»æ—¶ç›´æŽ¥æŠ›å‡ºAccessDeniedException éžå¸¸çš„æ°‘ä¸»ï¼Œæˆ‘ä»¬åªéœ€è¦å®žçŽ°ä¸€ä¸ªVoterå³å¯ æ³¨ï¼šAccessDecisionManager è¿˜æœ‰å…¶ä»–çš„é»˜è®¤å®žçŽ°ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç  CodingOKï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆæ‹ä¸€ä¸‹æ€è·¯ å®žçŽ°SecurityMetadataSourceï¼Œæä¾›å½“å‰èµ„æºè¦æ±‚çš„æƒé™ å®žçŽ°AccessDecisionVoterï¼Œç”¨äºŽåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—® å°†æˆ‘ä»¬è‡ªå·±çš„å®žçŽ°æ³¨å†Œåˆ°FilterSecurityInterceptorä¸­ OKï¼Œå¯ä»¥å¼€æžäº† SecurityServiceå®žçŽ°ä¸€ä¸ªServiceï¼Œç”¨äºŽä»Žæ•°æ®åº“åŠ è½½æ•°æ®1234567891011121314151617181920212223242526@Servicepublic class SecurityService &#123; @Autowired private JdbcTemplate jdbcTemplate; /** * åŠ è½½èµ„æºè¦æ±‚çš„æƒé™ * * @param resource * @return */ public List&lt;String&gt; getPermByResource(String resource) &#123; return jdbcTemplate.queryForList(Sql.getPermByResource, String.class, resource); &#125; /** * å½“å‰ç”¨æˆ·çš„æƒé™ * * @param username * @return */ public List&lt;String&gt; getPermByUsername(String username) &#123; return jdbcTemplate.queryForList(Sql.getPermByUsername, String.class, username); &#125;&#125; æ³¨ï¼šè¿™é‡Œä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥åŠ ä¸Šç¼“å­˜ï¼Œç”±äºŽdemoæ¼”ç¤ºï¼Œæˆ‘å°±æ²¡æœ‰è¿™ä¹ˆåš å®žçŽ°SecurityMetadataSourceMySecurityMetadataSource å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡SecurityServiceåŠ è½½ä¸€ä¸‹æ•°æ®12345678910111213141516171819202122232425262728public class MySecurityMetadataSource implements FilterInvocationSecurityMetadataSource &#123; private SecurityService securityService; public MySecurityMetadataSource(SecurityService securityService) &#123; this.securityService = securityService; &#125; @Override public Collection&lt;ConfigAttribute&gt; getAttributes(Object object) throws IllegalArgumentException &#123; String uri = ((FilterInvocation) object).getHttpRequest().getRequestURI(); List&lt;String&gt; list = securityService.getPermByResource(uri); if (list != null &amp;&amp; list.size() != 0) &#123; return SecurityConfig.createList(list.toArray(new String[0])); &#125; return null; &#125; @Override public Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() &#123; return null; &#125; @Override public boolean supports(Class&lt;?&gt; clazz) &#123; return FilterInvocation.class.isAssignableFrom(clazz); &#125;&#125; å®žçŽ°AccessDecisionVoterè¿™é‡ŒåŠ è½½ä¸€ä¸‹å½“å‰ç”¨æˆ·çš„æƒé™ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ»¡è¶³å½“å‰èµ„æºæ‰€è¦æ±‚çš„æƒé™12345678910111213141516171819202122232425262728293031323334public class MyAccessDecisionVoter implements AccessDecisionVoter&lt;Object&gt; &#123; private SecurityService securityService; public MyAccessDecisionVoter(SecurityService securityService) &#123; this.securityService = securityService; &#125; @Override public boolean supports(ConfigAttribute attribute) &#123; return true; &#125; @Override public boolean supports(Class&lt;?&gt; clazz) &#123; return true; &#125; @Override public int vote(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; attributes) &#123; Object principal = authentication.getPrincipal(); if ("anonymousUser".equals(principal)) &#123; // å½“å‰ç”¨æˆ·æœªç™»å½•ï¼Œå¦‚æžœä¸è¦æ±‚æƒé™-&gt;å…è®¸è®¿é—®ï¼Œå¦åˆ™æ‹’ç»è®¿é—® return CollectionUtils.isEmpty(attributes) ? ACCESS_GRANTED : ACCESS_DENIED; &#125; else &#123; // è¿™é‡Œæˆ‘çš„é€»è¾‘æ˜¯ï¼Œå½“å‰èµ„æºçš„è¦æ±‚æƒé™ï¼Œç”¨æˆ·å¿…é¡»å…¨éƒ¨æ»¡è¶³æ—¶æ‰å¯ä»¥è®¿é—® User user = (User) principal; List&lt;String&gt; permitList = securityService.getPermByUsername(user.getUsername()); List&lt;String&gt; stringAttributes = attributes.stream().map(ConfigAttribute::getAttribute).collect(Collectors.toList()); return permitList.containsAll(stringAttributes) ? ACCESS_GRANTED : ACCESS_DENIED; &#125; &#125;&#125; æ³¨å†Œåˆ°FilterSecurityInterceptoræˆ‘ä»¬æ ¸å¿ƒçš„ä¸šåŠ¡å·²ç»å®žçŽ°å®Œäº†ï¼ŒçŽ°åœ¨éœ€è¦æŠŠMySecurityMetadataSourceå’ŒMyAccessDecisionVoteræ³¨å†Œåˆ°FilterSecurityInterceptorä¸­ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒFilterSecurityInterceptorå¹¶ä¸å¯ä»¥é€šè¿‡@Beançš„æ–¹å¼æ¥å£°æ˜Žï¼Œè¯¥å¯¹è±¡æ˜¯åœ¨WebSecurityConfigurerAdapterçš„åˆå§‹åŒ–æ–¹æ³•ä¸­é»˜è®¤åˆ›å»ºçš„ ä½†æ˜¯Spring Securityä¸ºæˆ‘ä»¬æä¾›äº†ObjectPostProcessorï¼Œç”¨äºŽè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå…·ä½“ç”¨æ³•å¦‚ä¸‹12345678910111213http .authorizeRequests() .antMatchers("/", "/home", "/403").permitAll() .anyRequest().authenticated() .withObjectPostProcessor(new ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() &#123; @Override public &lt;O extends FilterSecurityInterceptor&gt; O postProcess( O fsi) &#123; fsi.setSecurityMetadataSource(new MySecurityMetadataSource(securityService)); fsi.setAccessDecisionManager(new AffirmativeBased(getDecisionVoters())); return fsi; &#125; &#125;) å®Œæ•´DemoGithub ðŸ‘‰ https://github.com/TavenYin/security-example/tree/master/dynamic-permissions]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Spring Security</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨ Spring Cloud åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ]]></title>
    <url>%2Fpost%2Fbca00fad.html</url>
    <content type="text"><![CDATA[Spring Cloud Config èƒ½åšä»€ä¹ˆï¼Ÿæˆ‘ä»¬å¯ä»¥å°†åˆ†å¸ƒå¼ç³»ç»Ÿçš„é…ç½®æ–‡ä»¶æ‰˜ç®¡åœ¨Gitä»“åº“æˆ–è€…æ•°æ®åº“ä¸­ï¼ŒConfig Server è´Ÿè´£ç®¡ç†é…ç½®æ–‡ä»¶ï¼Œä»¥Restfulçš„å½¢å¼æä¾›ç»™å…¶ä»–æœåŠ¡ï¼Œå¯ä»¥åœ¨ä»»ä½•å…¶ä»–è¯­è¨€çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ï¼Œä¸ä¾èµ–Spring Cloudå…¨å®¶æ¡¶ã€‚ æœ¬èŠ‚ç›®æ ‡ä½¿ç”¨Spring Cloud åŸºäºŽGitä»“åº“æ­å»ºåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ ç‰ˆæœ¬Spring Cloud Greenwich.SR2Spring Boot 2.1.7.RELEASE Gitä»“åº“åœ¨ä½ å–œæ¬¢çš„Gitå¹³å°ä¸Šå»ºç«‹ä¸€ä¸ªä»“åº“ï¼Œåˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œå¹¶å»ºç«‹å‡ ä¸ªé…ç½®æ–‡ä»¶ï¼ˆå»ºè®®ç½‘ç»œè¾ƒæ…¢çš„åŒå­¦é€‰æ‹©Giteeï¼‰ æ­å»ºConfig Serverpom.xml1234567891011121314151617181920212223&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; ...&lt;/dependencies&gt;&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;Greenwich.SR2&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt; application.properties12345678910server.port = 9001spring.application.name = config-server#è¡¨ç¤ºé…ç½®ä¸­å¿ƒæ‰€åœ¨ä»“åº“çš„ä½ç½®spring.cloud.config.server.git.uri = https://gitee.com/yintianwen7/cloud-config.git#ä»“åº“è·¯å¾„ä¸‹çš„çš„ç›¸å¯¹æœç´¢ä½ç½®ï¼Œå¯ä»¥é…ç½®å¤šä¸ªspring.cloud.config.server.git.search-paths = demo#gitçš„ç”¨æˆ·åspring.cloud.config.server.git.username = yourusername#gitçš„å¯†ç spring.cloud.config.server.git.password = yourpassword ConfigServerApplication.java123456789@EnableConfigServer@SpringBootApplicationpublic class ConfigServerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfigServerApplication.class, args); &#125;&#125; è‡³æ­¤ï¼ŒConfigServer æ­å»ºå®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®ConfigServer æŸ¥çœ‹ cloud-config/demo ä¸‹çš„é…ç½®æ–‡ä»¶ è®¿é—®æ–¹å¼å¦‚ä¸‹: /{application}/{profile}[/{label}] /{application}-{profile}.yml /{label}/{application}-{profile}.yml /{application}-{profile}.properties /{label}/{application}-{profile}.properties è¿™é‡Œ label ä¸ºgit åˆ†æ”¯ï¼Œé»˜è®¤master ä¾‹å¦‚è®¿é—® application-dev.ymlï¼Œç›´æŽ¥è¯·æ±‚ localhost:9001/application/devå³å¯ å¯ä»¥å°è¯•ä¿®æ”¹ä¸€ä¸‹Gitä»“åº“ä¸­çš„é…ç½®æ–‡ä»¶ï¼Œå†è®¿é—®Config Serverï¼Œè¿™æ—¶ä½ ä¼šå‘çŽ°Config Serverä¸­çš„æ•°æ®æ˜¯å®žæ—¶çš„ã€‚ æ­å»º Client åº”ç”¨è®¿é—®Config Serverpom.xml1234567891011121314151617181920212223&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; ...&lt;/dependencies&gt;&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;Greenwich.SR2&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt; bootstrap.propertiesï¼Œæ³¨æ„è¿™é‡Œæ˜¯ bootstrap.propertiesï¼Œä¸ç„¶ä½ ä¼šå‘çŽ°ä½ è¯·æ±‚çš„URIä¸€ç›´æ˜¯localhost:888812345spring.profiles.active=simplespring.application.name=applicationspring.cloud.config.label=master# æ‹¼æŽ¥è§„åˆ™: uri/name/profile/labelspring.cloud.config.uri=http://localhost:9001 CloudConfig.java é…ç½®æ–‡ä»¶çš„æ˜ å°„å®žä½“ï¼ŒåŒç†ä¹Ÿå¯ä»¥@Value æˆ–è€… Environment å¯¹è±¡è¯»å–å±žæ€§12345678@ConfigurationProperties("cloud.config")public class CloudConfig &#123; private String a; private String b; private String c; // çœç•¥ get set&#125; ClientApplication.java123456789101112131415161718@RestController@SpringBootApplication@EnableConfigurationProperties(CloudConfig.class)public class ClientApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ClientApplication.class, args); &#125; @Autowired private CloudConfig cloudConfig; // åˆ·æ–°é…ç½®æ—¶ POST /actuator/refresh @GetMapping("config") public Object config() &#123; return cloudConfig; &#125;&#125; å¯åŠ¨ Clientï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°è¯·æ±‚é…ç½®ä¸­å¿ƒçš„URL è¯·æ±‚ localhost:8080/config ï¼ŒéªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦è¯»å–æˆåŠŸ åˆ·æ–°å®¢æˆ·ç«¯é…ç½®Client ä¸­è¯»å–çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸æ˜¯å®žæ—¶çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹Gitä»“åº“ä¸­çš„æ–‡ä»¶æ¥éªŒè¯è¿™ç‚¹ã€‚é‚£ä¹ˆå¦‚ä½•åˆ·æ–°é…ç½®å‘¢ï¼Ÿ pom.xml å¼•å…¥1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt; bootstrap.properties è¿½åŠ 1management.endpoints.web.exposure.include=* å¯¹éœ€è¦åˆ·æ–°çš„Beanï¼Œæ·»åŠ æ³¨è§£@RefreshScope1234@RefreshScope@ConfigurationProperties("cloud.config")public class CloudConfig &#123;&#125; POST /actuator/refreshï¼Œå³å¯åˆ·æ–°é…ç½® Config Server åŠ å¯†è§£å¯†å…è®¸æ•°æ®ä»¥åŠ å¯†å½¢å¼å­˜å‚¨åœ¨Gitä»“åº“ï¼Œé…ç½®ä¸­å¿ƒè´Ÿè´£å¯¹åŠ å¯†çš„æ•°æ®è¿›è¡Œè§£å¯†ï¼Œç„¶åŽæä¾›ç»™å®¢æˆ·ç«¯åº”ç”¨ã€‚ç”±äºŽç¯‡å¹…é—®é¢˜ï¼Œè¿™é‡Œä¸è®²äº†ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å‚è€ƒ Spring Cloudæž„å»ºå¾®æœåŠ¡æž¶æž„ï¼šåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼ˆåŠ å¯†è§£å¯†ï¼‰ é…ç½®ä¸­å¿ƒé«˜å¯ç”¨æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¼ ç»Ÿè´Ÿè½½å‡è¡¡å™¨ æ–¹æ¡ˆ2ï¼šå°†clientã€config server æ³¨å†Œåˆ°Spring Cloudæ³¨å†Œä¸­å¿ƒï¼Œé€šè¿‡æ³¨å†Œä¸­å¿ƒè®¿é—®é…ç½®ä¸­å¿ƒï¼Œå…·ä½“ä»£ç å‚è€ƒðŸ‘‡ Demoæœ¬æ–‡demoðŸ‘‰ï¼šGithubï¼Œ Gitee å‚è€ƒhttp://blog.didispace.com/spring-cloud-starter-dalston-3-2/https://segmentfault.com/a/1190000012908853]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>Spring Cloud</tag>
        <tag>åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RabbitMQ é›†ç¾¤æ­å»º]]></title>
    <url>%2Fpost%2F4c62e394.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡è®°å½•RabbitMQé›†ç¾¤æ­å»ºè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ çŽ¯å¢ƒ vmware12 è™šæ‹Ÿæœºï¼ŒCentOS7æœ¬æ–‡ä»¥ä¸¤å°CentOS ä¸ºä¾‹ï¼ŒIP 192.168.32.128ï¼Œ192.168.32.129 ç£ç›˜èŠ‚ç‚¹å’Œå†…å­˜èŠ‚ç‚¹é›†ç¾¤ä¸­ï¼Œæ¯ä¸€ä¸ªRabbitMQå®žä¾‹éƒ½æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€ŒèŠ‚ç‚¹åˆ†ä¸ºç£ç›˜èŠ‚ç‚¹å’Œå†…å­˜èŠ‚ç‚¹ å†…å­˜èŠ‚ç‚¹ï¼šå°†Rabbitä¸­çš„å…ƒæ•°æ®ï¼ˆQueue, Exchange, binding, vhostç­‰ï¼‰å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒæŒä¹…åŒ–çš„ Message ä¾æ—§ä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œå†…å­˜èŠ‚ç‚¹çš„æ€§èƒ½åªèƒ½ä½“çŽ°åœ¨èµ„æºç®¡ç†ä¸Šï¼Œæ¶ˆæ¯çš„å‘é€å’ŒæŽ¥æ”¶å’Œç£ç›˜èŠ‚ç‚¹æ²¡æœ‰åŒºåˆ« ç£ç›˜èŠ‚ç‚¹ï¼šå…ƒæ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸­ï¼Œä¸€ä¸ªRabbité›†ç¾¤è¦æ±‚è‡³å°‘æœ‰ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ï¼Œå› ä¸ºå†…å­˜èŠ‚ç‚¹ä¸­ä¸å­˜å‚¨å…ƒæ•°æ®ï¼Œæ‰€ä»¥æ¯æ¬¡å†…å­˜èŠ‚ç‚¹å¯åŠ¨ï¼Œéƒ½ä¼šä»Žå…¶ä»–èŠ‚ç‚¹ä¸­åŒæ­¥å…ƒæ•°æ® å¦å¤–å¦‚æžœå”¯ä¸€ç£ç›˜çš„ç£ç›˜èŠ‚ç‚¹å´©æºƒäº†ï¼Œä¸èƒ½è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š ä¸èƒ½åˆ›å»ºé˜Ÿåˆ— ä¸èƒ½åˆ›å»ºäº¤æ¢å™¨ ä¸èƒ½åˆ›å»ºç»‘å®š ä¸èƒ½æ·»åŠ ç”¨æˆ· ä¸èƒ½æ›´æ”¹æƒé™ ä¸èƒ½æ·»åŠ å’Œåˆ é™¤é›†ç¾¤å‡ ç‚¹ RabbitMQé›†ç¾¤çš„å‡ ç§ç±»åž‹ å•ä¸€æ¨¡å¼ï¼šä»…æœ‰ä¸€ä¸ªrabbitå®žä¾‹ æ™®é€šæ¨¡å¼ï¼šé»˜è®¤é›†ç¾¤æ¨¡å¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹å„è‡ªç»´æŠ¤è‡ªå·±çš„æ•°æ®ï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä»…å­˜æœ‰ç›¸åŒçš„å…ƒæ•°æ®ã€‚ä¾‹å¦‚RabbitA å’Œ RabbitBï¼ŒAä¸­å­˜åœ¨ QueueAï¼Œæ¶ˆè´¹è€…å¯ä»¥ä»ŽRabbitBå®žä¾‹ä¸­ï¼Œè¯»å–QueueAçš„æ¶ˆæ¯ï¼Œè¿™æ—¶RabbitBä¼šä»ŽAä¸­è¯»å–æ¶ˆæ¯ï¼Œè¿”å›žç»™æ¶ˆè´¹è€…ã€‚ä½†æ˜¯å¦‚æžœRabbitA å®•æœºï¼Œè¿™æ—¶å°±æ— æ³•èŽ·å–QueueAçš„æ•°æ®äº† é•œåƒæ¨¡å¼ï¼šRabbit ä¼šå°†æ•°æ®åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ä¸­ï¼Œè¿™å›ºç„¶æé«˜äº†å¯ç”¨æ€§ï¼Œä½†æ˜¯éšä¹‹è€Œæ¥çš„é—®é¢˜æ˜¯ï¼Œç³»ç»Ÿçš„æ€§èƒ½ä¼šé™ä½Žã€‚èŠ‚ç‚¹ä¹‹é—´æ¶ˆæ¯çš„ä¼ é€’ä¼šå ç”¨å¸¦å®½ï¼Œè€Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®é‡ä¼šå˜å¤§ æ™®é€šæ¨¡å¼æˆ‘ä»¬å…ˆæ¥æ­å»ºæ™®é€šæ¨¡å¼çš„é›†ç¾¤ï¼Œåœ¨RabbitMQä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åå¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œé»˜è®¤ä»¥ rabbit@hostnameä¸ºèŠ‚ç‚¹name è€Œæ¯å°è™šæ‹Ÿæœºä¸­é»˜è®¤çš„hostæ˜¯localhostï¼Œè¿™å°±å¯¼è‡´äº†æ¯ä¸ªèŠ‚ç‚¹çš„nameéƒ½æ˜¯ rabbit@localhost 1. ä¿®æ”¹hostsä¿®æ”¹ä¸¤å°ä¸»æœºçš„hostsæ–‡ä»¶ï¼Œä»¥ä¸‹æ˜¯129çš„é…ç½®ï¼Œæˆ‘ä»¬æŠŠ128å®šä¹‰ä¸ºFï¼Œ129å®šä¹‰ä¸ºG 123456cat /etc/hosts127.0.0.1 G::1 G192.168.32.129 G192.168.32.128 F ä¿è¯Få’ŒGå¯ä»¥pingé€š 2. å®‰è£…RabbitMQå¯ä»¥å‚è€ƒ https://www.linuxprobe.com/install-rabbitmq-on-centos-7.html å½“æ—¶å®‰è£…å®Œä¸€ç›´å‘çŽ°æ— æ³•è®¿é—® Rabbitçš„webæŽ§åˆ¶å°ï¼Œé™¤äº†å¼€å¯æ’ä»¶ï¼Œå’Œæ·»åŠ ä¸€ä¸ªç”¨æˆ·ä¹‹å¤–ï¼Œè¿˜éœ€è¦æ”¾å¼€é˜²ç«å¢™çš„ç«¯å£12345678firewall-cmd --add-port=4369/tcp --permanentfirewall-cmd --add-port=25672/tcp --permanentfirewall-cmd --add-port=5671-5672/tcp --permanentfirewall-cmd --add-port=15672/tcp --permanentfirewall-cmd --add-port=61613-61614/tcp --permanentfirewall-cmd --add-port=1883/tcp --permanentfirewall-cmd --add-port=8883/tcp --permanentfirewall-cmd --reload # é‡è½½é…ç½® 3. åŒæ­¥Erlang cookieErlang VMå°†å°è¯•åœ¨RabbitMQæœåŠ¡å™¨å¯åŠ¨æ—¶åˆ›å»ºä¸€ä¸ªéšæœºç”Ÿæˆçš„å€¼ï¼ˆErlang Cookieï¼‰ã€‚é›†ç¾¤çŽ¯å¢ƒä¸­ï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„Erlang Cookieå¿…é¡»ä¸€è‡´ã€‚ .erlang.cookie é€šå¸¸åœ¨ $HOMEä¸‹æˆ–è€…/var/lib/rabbitmqä¸‹1234567# æ‰¾åˆ°å…¶ä¸­ä¸€å°ä¸»æœºçš„ .erlang.cookie# ä¿®æ”¹æƒé™chmod 777 /var/lib/rabbitmq/.erlang.cookie# æ‹·è´åˆ°å¦ä¸€å°ä¸»æœºscp /var/lib/rabbitmq/.erlang.cookie G:/var/lib/rabbitmq/# å†æŠŠæƒé™ä¿®æ”¹å›žæ¥chmod 400 /var/lib/rabbitmq/.erlang.cookie 4. æ£€æŸ¥èŠ‚ç‚¹å å¦‚æžœä¸¤ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ rabbit@localhostï¼Œè¿™æ˜¯æ— æ³•å»ºç«‹é›†ç¾¤çš„ æˆ‘å½“æ—¶å°±æ˜¯é‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ä¿®æ”¹èŠ‚ç‚¹nameï¼Œå‚è€ƒ https://ubuntuqa.com/article/6619.html æˆ‘é‡‡å–çš„æ–¹æ³•ï¼š1234567vi /etc/rabbitmq/rabbitmq-env.conf# æ·»åŠ å¦‚ä¸‹é…ç½®NODENAME=rabbit@G# ä¿å­˜åŽï¼Œé‡å¯rabbitmq ç”Ÿæ•ˆservice rabbitmq-server restart 5. ç»„æˆé›†ç¾¤ä¸Šè¿°æ­¥éª¤éƒ½æˆåŠŸåŽï¼Œæˆ‘ä»¬å¯ä»¥ç»„æˆé›†ç¾¤äº† è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å…ˆå¯åŠ¨rabbitmq@Fï¼Œç„¶åŽrabbit@Gæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼ŒåŠ å…¥Fï¼Œç»„æˆé›†ç¾¤1234rabbitmqctl stop_app # åœæ­¢rabbitmqæœåŠ¡rabbitmqctl reset # æ¸…ç©ºèŠ‚ç‚¹çŠ¶æ€rabbitmqctl join_cluster rabbit@F # åŠ å…¥Fï¼Œç»„æˆé›†ç¾¤rabbitmqctl start_app é›†ç¾¤ä¸­ï¼Œä»»æ„èŠ‚ç‚¹åœæœºåŽï¼Œæ‰§è¡Œ rabbitmqctl start_app å³å¯å†æ¬¡åŠ å…¥é›†ç¾¤ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ rabbitmqctl cluster_status é•œåƒæ¨¡å¼ä»»æ„rabbitèŠ‚ç‚¹è¾“å…¥å‘½ä»¤ï¼Œå°†æ‰€æœ‰é˜Ÿåˆ—ï¼ŒåŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹ä¸­1rabbitmqctl set_policy ha-all "^" '&#123;"ha-mode":"all"&#125;' 12345678910111213rabbitmqctl set_policy [-p Vhost] Name Pattern Definition [Priority]-p Vhostï¼š å¯é€‰å‚æ•°ï¼Œé’ˆå¯¹æŒ‡å®švhostä¸‹çš„queueè¿›è¡Œè®¾ç½®Name: policyçš„åç§°Pattern: queueçš„åŒ¹é…æ¨¡å¼(æ­£åˆ™è¡¨è¾¾å¼)Definitionï¼šé•œåƒå®šä¹‰ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ha-mode, ha-params, ha-sync-mode ha-mode:æŒ‡æ˜Žé•œåƒé˜Ÿåˆ—çš„æ¨¡å¼ï¼Œæœ‰æ•ˆå€¼ä¸º all/exactly/nodes allï¼šè¡¨ç¤ºåœ¨é›†ç¾¤ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒ exactlyï¼šè¡¨ç¤ºåœ¨æŒ‡å®šä¸ªæ•°çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒï¼ŒèŠ‚ç‚¹çš„ä¸ªæ•°ç”±ha-paramsæŒ‡å®š nodesï¼šè¡¨ç¤ºåœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒï¼ŒèŠ‚ç‚¹åç§°é€šè¿‡ha-paramsæŒ‡å®š ha-paramsï¼šha-modeæ¨¡å¼éœ€è¦ç”¨åˆ°çš„å‚æ•° ha-sync-modeï¼šè¿›è¡Œé˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„åŒæ­¥æ–¹å¼ï¼Œæœ‰æ•ˆå€¼ä¸ºautomaticå’Œmanualpriorityï¼šå¯é€‰å‚æ•°ï¼Œpolicyçš„ä¼˜å…ˆçº§ å…³äºŽé•œåƒæ¨¡å¼ç­–ç•¥çš„æ›´å¤šè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.rabbitmq.com/ha.html é›†ç¾¤çš„è´Ÿè½½å‡è¡¡ä¸ºä»€ä¹ˆæœ‰äº†é›†ç¾¤è¿˜éœ€è¦è´Ÿè½½å‡è¡¡ï¼Ÿ è¿™é‡Œæˆ‘çº ç»“äº†å¥½å‡ å¤©ï¼ŒåŽŸå› æ˜¯ï¼Œåœ¨æˆ‘çš„ç†è§£é‡Œ é›†ç¾¤ == è´Ÿè½½å‡è¡¡ï¼Œè¿™æ ·çš„ç†è§£æ˜¯æœ‰é—®é¢˜çš„ã€‚æ­£è§£ï¼šåˆ†å¸ƒå¼é›†ç¾¤ä¿è¯çš„æ˜¯é«˜å¯ç”¨ï¼Œè€Œå¹¶ä¸æ˜¯è´Ÿè½½å‡è¡¡ã€‚ rabbitmqæ–‡æ¡£ä¸­ï¼Œä¹Ÿå»ºè®®æˆ‘ä»¬ä½¿ç”¨TCPè´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™æ ·ä¹Ÿä¸éœ€è¦åœ¨æˆ‘ä»¬åº”ç”¨ç¨‹åºé‡Œç®¡ç†é›†ç¾¤çš„åœ°å€ Connecting to Clusters from ClientsA client can connect as normal to any node within a cluster. If that node should fail, and the rest of the cluster survives, then the client should notice the closed connection, and should be able to reconnect to some surviving member of the cluster. Generally, itâ€™s not advisable to bake in node hostnames or IP addresses into client applications: this introduces inflexibility and will require client applications to be edited, recompiled and redeployed should the configuration of the cluster change or the number of nodes in the cluster change. Instead, we recommend a more abstracted approach: this could be a dynamic DNS service which has a very short TTL configuration, or a plain TCP load balancer, or some sort of mobile IP achieved with pacemaker or similar technologies. In general, this aspect of managing the connection to nodes within a cluster is beyond the scope of RabbitMQ itself, and we recommend the use of other technologies designed specifically to solve these problems. ç½‘ä¸Šæ¯”è¾ƒå¤šçš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨ HAProxy ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™é‡Œå¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ä¸€ç¯‡ HAProxyä»Žé›¶å¼€å§‹åˆ°æŽŒæ¡ å…·ä½“å®‰è£…é…ç½®çš„ç»†èŠ‚æœ¬æ–‡å°±ä¸è¯´äº† è¿™é‡Œæˆ‘åˆæ·»åŠ äº†ä¸€å° 130 çš„è™šæ‹Ÿæœºæ¥è·‘ HAProxy è´´ä¸€ä¸‹æˆ‘çš„ haproxy.cfgï¼Œä»…ä¾›å‚è€ƒ 1234567891011121314151617181920212223242526272829globaldaemonpidfile /home/ha/haproxy/conf/haproxy.pidlog 127.0.0.1 local2defaultsmode tcpmaxconn 10000timeout connect 5stimeout client 100stimeout server 100sfrontend http-in bind *:5670 maxconn 30000 default_backend default_serversbackend default_servers balance roundrobin server F 192.168.32.128:5672 check inter 2000 rise 2 fall 3 weight 1 server G 192.168.32.129:5672 check inter 2000 rise 2 fall 3 weight 1listen stats bind *:1936 mode http stats refresh 30s #æ¯30ç§’æ›´æ–°ç›‘æŽ§æ•°æ® stats uri /stats #è®¿é—®ç›‘æŽ§é¡µé¢çš„uri stats realm HAProxy\ Stats #ç›‘æŽ§é¡µé¢çš„è®¤è¯æç¤º stats auth admin:admin åšå®Œè´Ÿè½½å‡è¡¡ä¹‹åŽï¼Œå¯ä»¥è·‘ä¸€ä¸‹ç¨‹åºï¼ŒæŸ¥çœ‹ä¸€ä¸‹è´Ÿè½½å‡è¡¡çš„æ•ˆæžœï¼Œè¿™é‡Œæˆ‘çš„10ä¸ª Connection æŒ‰ç…§æƒé‡ 1:1 åˆ†é…åœ¨äº†ä¸¤å° Rabbit ä¸Š å‚è€ƒ https://www.cnblogs.com/knowledgesea/p/6535766.htmlhttps://www.rabbitmq.com/clustering.html]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
        <tag>é›†ç¾¤</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RabbitMQ ç†è§£ Exchange]]></title>
    <url>%2Fpost%2Fea1358e6.html</url>
    <content type="text"><![CDATA[æœ¬èŠ‚ç›®æ ‡ äº†è§£ AMQP æ¨¡åž‹ äº†è§£ Exchange å»ºè®®å¤§å®¶åœ¨å­¦ä¹ MQä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹ ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡åž‹ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„ä¸€ç¯‡ Java ç†è§£ç”Ÿäº§è€…-æ¶ˆè´¹è€…è®¾è®¡æ¨¡å¼ AMQP ç®€ä»‹RabbitMQ æ˜¯å®žçŽ°äº† AMQP åè®®çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ‰€ä»¥è¯´ä¸‹é¢è®²åˆ°è¿™äº›æ¦‚å¿µä¸ä»…é™äºŽRabbitMQï¼Œæ‰€æœ‰å®žçŽ°AMQP åè®®çš„æ¶ˆæ¯ä¸­é—´ä»¶éƒ½å…·å¤‡è¿™äº› AMQP æ¨¡åž‹å›¾å¦‚ä¸‹ Publisherï¼ˆå‘å¸ƒè€…ï¼‰å’Œ Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰å¯ä»¥ç†è§£ä¸ºæ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº Exchangeï¼ˆäº¤æ¢æœºï¼‰ï¼Œæˆ‘ä»¬çš„Publisher ä¼šå°†æ¶ˆæ¯å…ˆæŽ¨é€åˆ°Exchange ï¼ŒExchange ç±»ä¼¼é‚®å±€ï¼Œä»–ä¼šå°†æ¶ˆæ¯å†è·¯ç”±åˆ° Queueï¼ˆé˜Ÿåˆ—ï¼‰ä¸­ï¼ŒQueueä¼šå°†æ¶ˆæ¯æŽ¨é€ç»™Consumer Exchange å’Œ Queue ä¹‹é—´é€šè¿‡ Binding ï¼ˆç»‘å®šï¼‰å°†ä¸¤è€…å…³è”åˆ°ä¸€èµ·ï¼Œä¸€ä¸ªExchange å¯ä»¥ç»‘å®šå¤šä¸ªQueueï¼Œä¸€ä¸ªQueue å¯ä»¥ç»‘å®šå¤šä¸ªExchange Exchangeåˆšåˆšæˆ‘ä»¬è¯´Exchangeç±»ä¼¼é‚®å±€ã€‚é‚®å±€çš„è¯ï¼Œå½“ç„¶ä¼šæœ‰å¾ˆå¤šçš„é‚®é€’æ–¹å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„Exchangeæœ‰å¤šç§ç±»åž‹ï¼Œæ¯ç§ç±»åž‹éƒ½æœ‰è‡ªå·±çš„ç­–ç•¥ AMQP æä¾›å››ç§Exchangeç±»åž‹ name é»˜è®¤é¢„è®¾å Direct exchange (Empty string) and amq.direct Fanout exchange amq.fanout Topic exchange amq.topic Headers exchange amq.match (and amq.headers in RabbitMQ) Direct ExchangeRabbit æ–‡æ¡£ä¸­ç»™å‡ºçš„å®šä¹‰ç¿»è¯‘è¿‡æ¥æ˜¯è¿™æ ·çš„ Direct ExchangeåŸºäºŽRoutingKey å°†æ¶ˆæ¯ä¼ é€’åˆ°é˜Ÿåˆ— é€šä¿—ç‚¹è®²æ˜¯å•¥æ„æ€å‘¢ï¼Œç›´æŽ¥çœ‹ä»£ç å§ 12// ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºExchangeï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯RoutingKey rabbitTemplate.convertAndSend("user_exchange", "user_routingKey", message); æˆ‘ä»¬å†æ¥çœ‹ç»‘å®šçš„æ—¶å€™ï¼Œä¹Ÿä¼šå…³è”ä¸€ä¸ªRoutingKey12// ç»‘å®šçš„æ—¶å€™ ä¹Ÿä¼šå…³è”ä¸€ä¸ªRoutingKeyBindingBuilder.bind(queue()).to(userExchange()).with("user_routingKey") åƒè¨€ä¸‡è¯­éƒ½åœ¨å›¾é‡Œ Default ExchangeDefault Exchange å…¶å®žæ˜¯AMQPä¸­é¢„å…ˆå£°æ˜Žçš„ï¼Œå¹¶ä¸”å®ƒå±žäºŽ Direct Exchangeï¼Œé€šå¸¸æ¥è¯´æ¯ä¸ªExchangeéƒ½ä¼šæœ‰è‡ªå·±çš„åï¼ŒDefault Exchange çš„åæ˜¯ &quot;&quot;. ä»–æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±žæ€§ï¼Œå½“ä½ æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼ŒMQä¼šè‡ªåŠ¨å°†è¿™ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°Default Exchange ä¸Šï¼Œç»‘å®šæ—¶ RoutingKey ä¸Žé˜Ÿåˆ—åç§°ç›¸åŒ è¯´çš„å¥½åƒæŒºç»•çš„ï¼Œæ¥çœ‹ä¸€ä¸‹ä»£ç å§12345// å£°æ˜Žä¸€ä¸ª Queueï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¸ä¸»åŠ¨Bindingçš„è¯ï¼Œtest_queue ä¼šå’ŒDefault Exchange ç»‘å®šï¼Œæ­¤æ—¶ routingKey = test_queueQueue queue = new Queue("test_queue");// å‘é»˜è®¤äº¤æ¢æœºå‘å¸ƒæ¶ˆæ¯rabbitTemplate.convertAndSend("", "test_queue", message); Fanout ExchangeFanout Exchange å¾ˆç®€å•ï¼Œé€‚åˆå‘å¸ƒè®¢é˜…åœºæ™¯ã€‚ä»–ä¸ä½¿ç”¨RoutingKeyï¼Œä»–å°†æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ä¸Žå…¶ç»‘å®šçš„é˜Ÿåˆ— Topic ExchangeTopic Exchange åˆæ˜¯åŸºäºŽRoutingKeyæ¥è·¯ç”±è½¬å‘çš„ï¼Œä½†æ˜¯æœ‰äº›ä¸åŒï¼Œä¸Šå›¾ åœ¨ä½¿ç”¨ Topic çš„æ—¶å€™ï¼ŒroutingKey å¯ä»¥æ˜¯ *.orange.*,lazy.# è¿™ç§è¡¨è¾¾å¼ * (æ˜Ÿ) ä»£è¡¨ä¸€ä¸ªè¯. # (hash) ä»£è¡¨0æˆ–å¤šä¸ªè¯. åŒç†ï¼Œå½“å‘å¸ƒæ¶ˆæ¯æ—¶çš„ routingKey ä¸Žå…¶åŒ¹é…æ—¶ï¼Œä¼šè·¯ç”±åˆ°ç›¸åº”çš„é˜Ÿåˆ— Headers ExchangeåŸºäºŽHeaderä¸­çš„å±žæ€§æ¥åŒ¹é…è·¯ç”±ï¼Œç”±äºŽä¸æ˜¯å¾ˆå¸¸ç”¨ï¼Œè¿™é‡Œå°±ä¸è¯´äº† å‚è€ƒ https://www.rabbitmq.com/tutorials/amqp-concepts.html]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
        <tag>Exchange</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring æºç è§£æž åŒæ­¥äº‹åŠ¡çš„å®žçŽ°åŽŸç†]]></title>
    <url>%2Fpost%2Fff158ca0.html</url>
    <content type="text"><![CDATA[åœ¨æœ€å¼€å§‹å­¦ä¹ Spring AOPçš„æ—¶å€™ï¼Œé‚£æ—¶å€™åªçŸ¥é“äº‹åŠ¡æ˜¯åˆ©ç”¨AOPç®¡ç†çš„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç¿»çœ‹è¿‡æºç ï¼ŒåŽæ¥å‘çŽ°Springä¸å…‰å¯ä»¥ç®¡ç†å…³ç³»åž‹æ•°æ®çš„äº‹åŠ¡ã€‚ç”šè‡³å¯ä»¥åŒæ­¥ç®¡ç†Redisç­‰å…¶ä»–æ•°æ®åº“çš„äº‹åŠ¡ï¼Œè¿™æ˜¯æ€Žä¹ˆåšåˆ°çš„å‘¢ï¼Ÿæœ¬èŠ‚æˆ‘ä»¬ä¸€èµ·æŽ¢ç´¢ä¸€ä¸‹Springçš„äº‹åŠ¡ ç‰ˆæœ¬SpringBoot 2.1.6.RELEASE åˆ†æžé¦–å…ˆå¦‚æžœæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªAOPæ¥ç®¡ç†äº‹åŠ¡çš„è¯ï¼Œä¼šæ€Žä¹ˆåšï¼Ÿ æ‰§è¡Œä»£ç†æ–¹æ³•å‰å¼€å¯äº‹åŠ¡ æ‰§è¡Œä»£ç†çš„æ–¹æ³• æ‰§è¡Œä»£ç†æ–¹æ³•åŽå›žæ»šæˆ–è€…æäº¤äº‹åŠ¡ å¦‚ä½•å®žçŽ°Redisäº‹åŠ¡çš„åŒæ­¥æäº¤å’Œå›žæ»šï¼Ÿ Springä¸­å…³äºŽäº‹åŠ¡çš„ç®¡ç†è¦æ¯”æˆ‘ä»¬æƒ³è±¡çš„å¤æ‚çš„å¤šï¼Œæœ¬æ–‡åªå…³æ³¨åŒæ­¥äº‹åŠ¡çš„å®žçŽ°ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹æºç  TransactionAspectSupportåœ¨ç¿»çœ‹æºç åŽæ‰¾åˆ°è¿™ä¸ªç±»ï¼Œäº‹åŠ¡åˆ‡é¢æ”¯æŒï¼Œè¿™ä¸ªç±»å®žçŽ°äº†äº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒé€»è¾‘ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ ¸å¿ƒä»£ç  æˆ‘ä»¬é€šå¸¸åœ¨é¡¹ç›®ä¸­ä¼šä½¿ç”¨é»˜è®¤çš„DataSourceTransactionManageräº‹åŠ¡ç®¡ç†å™¨ + æ³¨è§£å¼äº‹åŠ¡ï¼ˆä¹Ÿå°±æ˜¯å£°æ˜Žå¼äº‹åŠ¡ï¼‰CallbackPreferringPlatformTransactionManager æ˜¯Springæä¾›çš„å›žè°ƒå¼äº‹åŠ¡ç®¡ç†å™¨ï¼ˆç”¨äºŽç¼–ç¨‹å¼äº‹åŠ¡ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸è®¨è®ºã€‚ å¯ä»¥çœ‹åˆ°å£°æ˜Žå¼äº‹åŠ¡çš„å¤„ç†é€»è¾‘ï¼Œå’Œæˆ‘ä»¬ä¸Šè¿°åˆ†æžçš„åŸºæœ¬ä¸€è‡´ï¼Œé‚£ä¹ˆä»–æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åŒæ­¥å¤„ç†äº†å…¶ä»–æ•°æ®çš„äº‹åŠ¡å‘¢ï¼Ÿç»§ç»­æ·±å…¥æºç  æºç è·Ÿè¸ªæˆ‘ä»¬ä»¥completeTransactionAfterThrowing() è¿™ä¸ªæ–¹æ³•ä¸ºä¾‹ï¼ˆä¸Šå›¾çº¢æ¡†æ¡†ï¼‰ï¼Œè·Ÿè¸ªä¸‹åŽ» å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬å¼‚å¸¸éœ€è¦å›žæ»šæ—¶ï¼Œä¼šè°ƒç”¨ TransactionManager.rollback()ï¼Œæˆ‘ä»¬ç»§ç»­æ¥è·Ÿè¸ªè¿™ä¸ªæ–¹æ³• è¿™é‡Œä»£ç é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œæˆ‘ä»¬åªå…³æ³¨çº¢æ¡†é‡Œçš„ä»£ç å—ï¼ŒdoRollbackä¸­åªåšäº†æ•°æ®æºçš„å›žæ»šï¼Œé‚£ä¹ˆåƒRedisäº‹åŠ¡çš„æäº¤æ˜¯åœ¨å“ªé‡Œå®žçŽ°çš„ï¼Ÿ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ triggerAfterCompletion() æ–¹æ³•ï¼Œç­”æ¡ˆé©¬ä¸Šå°±çŸ¥é“äº† åŒæ­¥äº‹åŠ¡ TransactionSynchronizationManager ä¸­ä¼šä»ŽThreadLocal ä¸­èŽ·å–å‡ºå½“å‰çº¿ç¨‹ä¸­ â€œåŒæ­¥äº‹åŠ¡â€æŽ¥å£é›†åˆ Listï¼Œç„¶åŽæŽ¥ä¸‹æ¥çš„æ“ä½œå°±æ˜¯éåŽ†æ‰€æœ‰çš„TransactionSynchronizationï¼Œæ‰§è¡Œsynchronization.afterCompletion(completionStatus); æˆ‘ä»¬å¯ä»¥åœ¨TransactionSynchronizationæŽ¥å£ä¸‹æ‰¾åˆ°ä¸€ä¸ªRedisçš„å®žçŽ° ä»£ç é€»è¾‘å¾ˆç®€å•ï¼Œäº‹åŠ¡æäº¤åˆ™Redisäº‹åŠ¡æ‰§è¡Œï¼Œå¦åˆ™å–æ¶ˆRedisäº‹åŠ¡ åŒæ­¥äº‹åŠ¡çš„æ³¨å†Œ æˆ‘ä»¬RedisTemplateå¼€å¯äº‹åŠ¡åŽï¼Œä¼šæ‰§è¡Œåˆ°ä¸Šå›¾çš„debugå¤„ï¼ŒRedisConnection å¼€å¯äº‹åŠ¡ï¼Œå¹¶å°†å½“å‰Connectionæ³¨å†Œåˆ°TransactionSynchronizationManager ä¸­ï¼Œè¿™æ ·åœ¨triggerAfterCompletion å°±å¯ä»¥åŒæ­¥çš„ç®¡ç†æˆ‘ä»¬Redisçš„äº‹åŠ¡äº†]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>æºç </tag>
        <tag>Spring</tag>
        <tag>äº‹åŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç†è§£æ¶ˆæ¯é˜Ÿåˆ— - ä½¿ç”¨åœºæ™¯ç®€ä»‹]]></title>
    <url>%2Fpost%2F81e2e5c7.html</url>
    <content type="text"><![CDATA[åœ¨ä¹‹å‰çš„ Java ç†è§£ç”Ÿäº§è€…-æ¶ˆè´¹è€…è®¾è®¡æ¨¡å¼ ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´é€šè¿‡ä¸€ä¸ªç¼“å†²é˜Ÿåˆ—è¿›è¡Œé€šè®¯ï¼Œå³åšåˆ°äº†å¼‚æ­¥æ¶ˆæ¯åžåï¼Œåˆä½¿å¾—ç¨‹åºè§£è€¦ å¯ä»¥è¯´ï¼Œä½¿ç”¨ MQï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ å¯ä»¥åœ¨åˆ†å¸ƒå¼çŽ¯å¢ƒä¸­å®žçŽ°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ é€‚åˆMQä½¿ç”¨çš„åœºæ™¯ æ¶ˆæ¯çš„å‘é€è€…å’Œæ¶ˆè´¹è€…éœ€è¦è§£è€¦çš„æƒ…å†µ å¼‚æ­¥å¤„ç† å¤šä¸ªæ¶ˆè´¹è€…ï¼ˆæ¶ˆæ¯çš„å…³æ³¨è€…ä¸æ­¢ä¸€ä¸ªï¼‰ æ¶ˆè´¹è€…çš„å¤„ç†ç»“æžœä¸è¿”å›žç»™å‘é€è€… ï¼ˆä»¥RabbitMQä¸ºä¾‹ï¼Œè™½ç„¶å¯ä»¥åšåˆ°RPCè°ƒç”¨ï¼Œä½†æ˜¯è¿™ç§è°ƒç”¨ä¼šå¸¦æ¥æ›´å¤šçš„éº»çƒ¦ï¼‰ å‰Šå³°å¡«è°· ä¸‹é¢æˆ‘è·Ÿè¯¦ç»†åˆ†æžä¸€ä¸‹å„ç§ä½¿ç”¨åœºæ™¯ è§£è€¦ å…¶å®žå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€šè¿‡MQè¿›è¡Œé€šè®¯ï¼Œå¯ä»¥è¯´ä¸¤è€…æ²¡æœ‰ä»€ä¹ˆç›´æŽ¥çš„ç“œè‘›ï¼Œå¿…ç„¶è§£è€¦ å¼‚æ­¥ &amp;&amp; å¤šä¸ªæ¶ˆè´¹è€…ç”Ÿäº§è€…åªè´Ÿè´£æŠŠæ¶ˆæ¯å‘å¸ƒï¼Œå¹¶åœ¨æ„è°å¤„ç†æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªæ¶ˆè´¹è€…å¤„ç†è¯¥æ¶ˆæ¯ ä¾‹å¦‚ç”¨æˆ·æ³¨å†Œï¼Œæˆ‘ä»¬ä¼šç»™ç”¨æˆ·å‘é€æ³¨å†Œé‚®ä»¶å’ŒçŸ­ä¿¡ï¼ˆå¯ä»¥æŠŠé‚®ä»¶å’ŒçŸ­ä¿¡ç†è§£ä¸ºå¤šä¸ªæ¶ˆè´¹è€…æœåŠ¡ï¼‰ å¯ä»¥çœ‹åˆ°åœ¨ä½¿ç”¨äº†MQï¼Œå³å¯ä»¥é€šè¿‡å¼‚æ­¥å¤„ç†çš„æ–¹å¼ï¼Œé™ä½Žå“åº”æ—¶é—´ï¼Œåˆå¯ä»¥é™ä½Žä¸šåŠ¡ä¹‹é—´çš„è€¦åˆåº¦ æ¶ˆè´¹è€…çš„å¤„ç†ç»“æžœä¸è¿”å›žç»™å‘é€è€…çº¿ç¨‹æ± å’ŒMQéƒ½å¯ä»¥çœ‹æˆ ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„å®žçŽ°ï¼Œè€Œè¿™ä¸¤è€…ä¹Ÿéƒ½å¯ä»¥èŽ·å¾—æ¶ˆè´¹è€…çš„è¿”å›žå€¼ã€‚ä½†æ˜¯å¦‚æžœä½ è¿™æ ·åšçš„è¯ï¼Œä½ çš„ç”Ÿäº§è€…çº¿ç¨‹ä¼šé˜»å¡žï¼ˆç­‰å¾…æ¶ˆè´¹è€…çš„è¿”å›žï¼‰ï¼Œæ²¡æ³•åšåˆ°å®Œå…¨å¼‚æ­¥çš„å¤„ç†ï¼Œæœ‰äº›è¿èƒŒäº†ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„åˆè¡·ã€‚è€Œä¸”è¿˜è¦è€ƒè™‘ç­‰å¾…è¶…æ—¶åŽçš„å¤„ç†ã€‚ä½†æ˜¯ä¸èƒ½è¯´è¿™ç§ç”¨æ³•æ˜¯ä¸å¯¹çš„ï¼Œå…·ä½“ä¸šåŠ¡å…·ä½“åˆ†æž å‰Šå³°å¡«è°·ä½•ä¸ºå‰Šå³°å¡«è°·ï¼Œå¯ä»¥ç†è§£ä¸ºæµé‡æŽ§åˆ¶ã€‚ä¾‹å¦‚åœ¨æŠ¢ç¥¨ï¼Œç§’æ€ç­‰ä¸šåŠ¡åœºæ™¯æ—¶ï¼Œå¯èƒ½ä¼šçªç„¶æœ‰å¤§é‡çš„è¯·æ±‚æ¶Œå…¥ã€‚ä½†æ˜¯æˆ‘ä»¬çš„æœåŠ¡å™¨èµ„æºæœ‰é™ï¼Œå¹¶ä¸èƒ½å¤„ç†è¿™ä¹ˆå¤šçš„è¯·æ±‚ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ MQè¿›è¡Œæµé‡æŽ§åˆ¶ å› ä¸ºï¼Œè¯·æ±‚éƒ½ç¼“å­˜åœ¨äº†MQä¸­ï¼Œä¸‹æ¸¸æœåŠ¡å¯ä»¥æ ¹æ®è‡ªå·±çš„é€Ÿåº¦è¿›è¡Œå¤„ç†ã€‚ å‚è€ƒ https://www.kancloud.cn/cosmicyang/rabbitmq/824050]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>MQ</tag>
        <tag>æ¶ˆæ¯é˜Ÿåˆ—</tag>
        <tag>ç”Ÿäº§è€…æ¶ˆè´¹è€…</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java ç†è§£ ThreadPoolExecutor å®žçŽ°åŽŸç†]]></title>
    <url>%2Fpost%2Fa5233273.html</url>
    <content type="text"><![CDATA[ä½¿ç”¨çº¿ç¨‹æ± ï¼ˆThreadPoolExecutorï¼‰çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€èŠ±çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºçš„å¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜ã€‚å¦‚æžœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½é€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜ã€‚ â€“ é˜¿é‡ŒJavaå¼€å‘æ‰‹å†Œ ç‰ˆæœ¬JDK 1.8 æœ¬èŠ‚ç›®æ ‡ ç†è§£çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•° ç†è§£çº¿ç¨‹æ± å·¥ä½œåŽŸç† ç†è§£çº¿ç¨‹æ± æ ¸å¿ƒæ–¹æ³• çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°å’Œæž„é€ æ–¹æ³•ctl12345678910111213141516171819202122232425262728293031323334353637// çº¿ç¨‹æ± æ ¸å¿ƒå˜é‡ï¼ŒåŒ…å«çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€å’Œæœ‰æ•ˆçº¿ç¨‹æ•°ï¼Œåˆ©ç”¨äºŒè¿›åˆ¶çš„ä½æŽ©ç å®žçŽ°private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));private static final int COUNT_BITS = Integer.SIZE - 3;private static final int CAPACITY = (1 &lt;&lt; COUNT_BITS) - 1;// runState is stored in the high-order bits// çº¿ç¨‹æ± çŠ¶æ€private static final int RUNNING = -1 &lt;&lt; COUNT_BITS;private static final int SHUTDOWN = 0 &lt;&lt; COUNT_BITS;private static final int STOP = 1 &lt;&lt; COUNT_BITS;private static final int TIDYING = 2 &lt;&lt; COUNT_BITS;private static final int TERMINATED = 3 &lt;&lt; COUNT_BITS;// Packing and unpacking ctl// èŽ·å–å½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€private static int runStateOf(int c) &#123; return c &amp; ~CAPACITY; &#125;// èŽ·å–å½“å‰çº¿ç¨‹æ± æœ‰æ•ˆçº¿ç¨‹æ•°private static int workerCountOf(int c) &#123; return c &amp; CAPACITY; &#125;// æ‰“åŒ…ctlå˜é‡private static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125;/* * Bit field accessors that don't require unpacking ctl. * These depend on the bit layout and on workerCount being never negative. */private static boolean runStateLessThan(int c, int s) &#123; return c &lt; s;&#125;private static boolean runStateAtLeast(int c, int s) &#123; return c &gt;= s;&#125;private static boolean isRunning(int c) &#123; return c &lt; SHUTDOWN;&#125; JDK7 ä»¥åŽï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€å’Œæœ‰æ•ˆçº¿ç¨‹æ•°é€šè¿‡ ctl è¿™ä¸ªå˜é‡è¡¨ç¤ºï¼ˆä½¿ç”¨äºŒè¿›åˆ¶çš„ä½æŽ©ç æ¥å®žçŽ°ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸æ·±ç©¶ï¼‰ï¼Œç†è§£ä¸Šè¿°å‡ ä¸ªæ–¹æ³•ä½œç”¨å³å¯ï¼Œä¸å½±å“ä¸‹é¢çš„æºç é˜…è¯» å…³äºŽçº¿ç¨‹æ± çš„äº”ç§çŠ¶æ€ RUNNINGï¼šæŽ¥å—æ–°ä»»åŠ¡å¹¶å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ SHUTDOWN ï¼šä¸æŽ¥å—æ–°ä»»åŠ¡ï¼Œä½†å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ STOP ï¼šä¸æŽ¥å—æ–°ä»»åŠ¡ï¼Œä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå¹¶ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼ˆä¸­æ–­å¹¶ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œåªæ˜¯ä¿®æ”¹äº†Threadçš„çŠ¶æ€ï¼Œæ˜¯å¦ä¸­æ–­å–å†³äºŽRunnable çš„å®žçŽ°é€»è¾‘ï¼‰ TIDYING ï¼šæ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»ˆæ­¢ï¼ŒworkerCountä¸º0æ—¶ï¼Œçº¿ç¨‹æ± ä¼šè¿‡åº¦åˆ°è¯¥çŠ¶æ€ï¼Œå¹¶å³å°†è°ƒç”¨ terminate() TERMINATED ï¼šterminated() è°ƒç”¨å®Œæˆï¼›çº¿ç¨‹æ± ä¸­æ­¢ çº¿ç¨‹æ± çŠ¶æ€çš„è½¬æ¢ RUNNING =&gt; SHUTDOWN ï¼šè°ƒç”¨ shutdown() RUNNING / SHUTDOWN =&gt; STOP ï¼šè°ƒç”¨ shutdownNow() ï¼ˆè¯¥æ–¹æ³•ä¼šè¿”å›žé˜Ÿåˆ—ä¸­æœªæ‰§è¡Œçš„ä»»åŠ¡ï¼‰ SHUTDOWN =&gt; TIDYINGï¼š å½“çº¿ç¨‹æ± å’Œé˜Ÿåˆ—éƒ½ä¸ºç©ºæ—¶ STOP =&gt; TIDYINGï¼šå½“çº¿ç¨‹æ± ä¸ºç©ºæ—¶ TIDYING =&gt; TERMINATEDï¼šå½“ terminated() è°ƒç”¨å®Œæˆæ—¶ æž„é€ æ–¹æ³•çº¿ç¨‹æ± æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨å¦‚ä¸‹æž„é€ æ–¹æ³•123456789public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) &#123; // çœç•¥&#125; æ ¸å¿ƒå‚æ•°æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹çº¿ç¨‹æ± ä¸­çš„æ ¸å¿ƒå‚æ•°éƒ½æ˜¯ä»€ä¹ˆä½œç”¨123456789101112131415161718192021222324private final BlockingQueue&lt;Runnable&gt; workQueue; // é˜»å¡žé˜Ÿåˆ—ï¼Œç”¨äºŽç¼“å­˜ä»»åŠ¡private final ReentrantLock mainLock = new ReentrantLock(); // çº¿ç¨‹æ± ä¸»é”private final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;(); // å·¥ä½œçº¿ç¨‹é›†åˆprivate final Condition termination = mainLock.newCondition(); // awaitTermination() æ–¹æ³•çš„ç­‰å¾…æ¡ä»¶private int largestPoolSize; // è®°å½•æœ€å¤§çº¿ç¨‹æ± å¤§å°private long completedTaskCount; //ç”¨æ¥è®°å½•çº¿ç¨‹æ± ä¸­æ›¾ç»å‡ºçŽ°è¿‡çš„æœ€å¤§çº¿ç¨‹æ•°private volatile ThreadFactory threadFactory; // çº¿ç¨‹å·¥åŽ‚ï¼Œç”¨äºŽåˆ›å»ºçº¿ç¨‹private volatile RejectedExecutionHandler handler; // ä»»åŠ¡æ‹’ç»æ—¶çš„ç­–ç•¥private volatile long keepAliveTime; // çº¿ç¨‹å­˜æ´»æ—¶é—´ // å½“çº¿ç¨‹æ•°è¶…è¿‡æ ¸å¿ƒæ± æ•°æ—¶ï¼Œæˆ–å…è®¸æ ¸å¿ƒæ± çº¿ç¨‹è¶…æ—¶ï¼Œè¯¥å‚æ•°ä¼šèµ·ä½œç”¨ã€‚å¦åˆ™ä¸€ç›´ä¼šç­‰å¾…æ–°çš„ä»»åŠ¡private volatile boolean allowCoreThreadTimeOut; // æ˜¯å¦å…è®¸æ ¸å¿ƒæ± çº¿ç¨‹è¶…æ—¶private volatile int corePoolSize; // æ ¸å¿ƒçº¿ç¨‹æ± æ•°é‡private volatile int maximumPoolSize; // æœ€å¤§çº¿ç¨‹æ± æ•°é‡ workQueueè¿™ä¸ªé˜Ÿåˆ—çš„ä½œç”¨ï¼Œå’Œä¹‹å‰çš„ Java ç†è§£ç”Ÿäº§è€…-æ¶ˆè´¹è€…è®¾è®¡æ¨¡å¼ ä¸­è®²åˆ°çš„ç¼“å†²é˜Ÿåˆ—ï¼Œä½œç”¨å¾ˆç›¸ä¼¼ï¼Œæˆ–è€…è¯´çº¿ç¨‹æ± å°±æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„ä¸€ç§å®žçŽ°ã€‚ å…³äºŽ handler ThreadPoolExecutor.AbortPolicy:ä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸ã€‚ ThreadPoolExecutor.DiscardPolicyï¼šä¹Ÿæ˜¯ä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚ ThreadPoolExecutor.DiscardOldestPolicyï¼šä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åŽé‡æ–°å°è¯•æ‰§è¡Œä»»åŠ¡ï¼ˆé‡å¤æ­¤è¿‡ç¨‹ï¼‰ ThreadPoolExecutor.CallerRunsPolicyï¼šå½“å‰ä»»åŠ¡è‡ªå·±å†³å®š corePoolSize å’Œ maximumPoolSizeå¦‚æžœä½ å¯¹è¿™ä¸¤ä¸ªå‚æ•°æœ‰ç–‘é—®ï¼Œçœ‹å®Œä¸‹é¢çš„æ —å­ä½ ä¼šæ¸…æ™°å¾ˆå¤š ä¸‹é¢æˆ‘ä»¬æ¥ä¸¾ä¸ªæ —å­æ¥æ›´å¥½çš„ç†è§£ä¸€ä¸‹çº¿ç¨‹æ±  ç†è§£çº¿ç¨‹æ± å·¥ä½œåŽŸç†å‡å¦‚æœ‰ä¸€ä¸ªå·¥åŽ‚ï¼Œå·¥åŽ‚é‡Œé¢æœ‰10ä¸ªå·¥äººï¼Œæ¯ä¸ªå·¥äººåŒæ—¶åªèƒ½åšä¸€ä»¶ä»»åŠ¡ã€‚ å› æ­¤åªè¦å½“10ä¸ªå·¥äººä¸­æœ‰å·¥äººæ˜¯ç©ºé—²çš„ï¼Œæ¥äº†ä»»åŠ¡å°±åˆ†é…ç»™ç©ºé—²çš„å·¥äººåšï¼› å½“10ä¸ªå·¥äººéƒ½æœ‰ä»»åŠ¡åœ¨åšæ—¶ï¼Œå¦‚æžœè¿˜æ¥äº†ä»»åŠ¡ï¼Œå°±æŠŠä»»åŠ¡è¿›è¡ŒæŽ’é˜Ÿç­‰å¾…ï¼› æ¯ä¸ªå·¥äººåšå®Œè‡ªå·±çš„ä»»åŠ¡åŽï¼Œä¼šåŽ»ä»»åŠ¡é˜Ÿåˆ—ä¸­é¢†å–æ–°çš„ä»»åŠ¡ï¼› å¦‚æžœè¯´æ–°ä»»åŠ¡æ•°ç›®å¢žé•¿çš„é€Ÿåº¦è¿œè¿œå¤§äºŽå·¥äººåšä»»åŠ¡çš„é€Ÿåº¦ï¼ˆä»»åŠ¡ç´¯ç§¯è¿‡å¤šæ—¶ï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶å·¥åŽ‚ä¸»ç®¡å¯èƒ½ä¼šæƒ³è¡¥æ•‘æŽªæ–½ï¼Œæ¯”å¦‚é‡æ–°æ‹›4ä¸ªä¸´æ—¶å·¥äººè¿›æ¥ï¼› ç„¶åŽå°±å°†ä»»åŠ¡ä¹Ÿåˆ†é…ç»™è¿™4ä¸ªä¸´æ—¶å·¥äººåšï¼› å¦‚æžœè¯´ç€14ä¸ªå·¥äººåšä»»åŠ¡çš„é€Ÿåº¦è¿˜æ˜¯ä¸å¤Ÿï¼Œæ­¤æ—¶å·¥åŽ‚ä¸»ç®¡å¯èƒ½å°±è¦è€ƒè™‘ä¸å†æŽ¥æ”¶æ–°çš„ä»»åŠ¡æˆ–è€…æŠ›å¼ƒå‰é¢çš„ä¸€äº›ä»»åŠ¡äº†ã€‚ å½“è¿™14ä¸ªå·¥äººå½“ä¸­æœ‰äººç©ºé—²æ—¶ï¼Œè€Œæ–°ä»»åŠ¡å¢žé•¿çš„é€Ÿåº¦åˆæ¯”è¾ƒç¼“æ…¢ï¼Œå·¥åŽ‚ä¸»ç®¡å¯èƒ½å°±è€ƒè™‘è¾žæŽ‰4ä¸ªä¸´æ—¶å·¥äº†ï¼Œåªä¿æŒåŽŸæ¥çš„10ä¸ªå·¥äººï¼Œæ¯•ç«Ÿè¯·é¢å¤–çš„å·¥äººæ˜¯è¦èŠ±é’±çš„ã€‚ å¼€å§‹å·¥åŽ‚çš„10ä¸ªå·¥äººï¼Œå°±æ˜¯ corePoolSize (æ ¸å¿ƒæ± æ•°é‡)ï¼› å½“10ä¸ªäººéƒ½åœ¨å·¥ä½œæ—¶ (æ ¸å¿ƒæ± è¾¾åˆ° corePoolSize)ï¼Œä»»åŠ¡æŽ’é˜Ÿç­‰å¾…æ—¶ï¼Œä¼šç¼“å­˜åˆ° workQueue ä¸­ï¼› å½“ä»»åŠ¡ç´¯ç§¯è¿‡å¤šæ—¶(è¾¾åˆ° workQueue æœ€å¤§å€¼æ—¶)ï¼Œæ‰¾ä¸´æ—¶å·¥ï¼› 14ä¸ªä¸´æ—¶å·¥ï¼Œå°±æ˜¯ maximumPoolSize (æ•°é‡)ï¼› å¦‚æžœæ­¤æ—¶å·¥ä½œé€Ÿåº¦è¿˜æ˜¯ä¸å¤Ÿï¼Œçº¿ç¨‹æ± è¿™æ—¶ä¼šè€ƒè™‘æ‹’ç»ä»»åŠ¡ï¼Œå…·ä½“ç”±æ‹’ç»ç­–ç•¥å†³å®š ç†è§£çº¿ç¨‹æ± æ ¸å¿ƒæ–¹æ³•execute()çº¿ç¨‹æ± ä¸­æ‰€æœ‰æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•æœ‰å…³çš„æ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨ execute()ã€‚å¦‚æžœä½ ç†è§£äº†ä¸Šè¿°çš„å°ä¾‹å­ï¼Œå†æ¥çœ‹è¿™ä¸ªä¼šæ¸…æ™°å¾ˆå¤š123456789101112131415161718192021222324252627282930313233343536373839public void execute(Runnable command) &#123; if (command == null) throw new NullPointerException(); /* * Proceed in 3 steps: * * 1. If fewer than corePoolSize threads are running, try to * start a new thread with the given command as its first * task. The call to addWorker atomically checks runState and * workerCount, and so prevents false alarms that would add * threads when it shouldn't, by returning false. * * 2. If a task can be successfully queued, then we still need * to double-check whether we should have added a thread * (because existing ones died since last checking) or that * the pool shut down since entry into this method. So we * recheck state and if necessary roll back the enqueuing if * stopped, or start a new thread if there are none. * * 3. If we cannot queue task, then we try to add a new * thread. If it fails, we know we are shut down or saturated * and so reject the task. */ int c = ctl.get(); if (workerCountOf(c) &lt; corePoolSize) &#123; if (addWorker(command, true)) return; c = ctl.get(); &#125; if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; int recheck = ctl.get(); if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); else if (workerCountOf(recheck) == 0) addWorker(null, false); &#125; else if (!addWorker(command, false)) reject(command);&#125; åˆ†æžexecute() step 1 1ï¼‰é¦–å…ˆæ£€æŸ¥å½“å‰æœ‰æ•ˆçº¿ç¨‹æ•° æ˜¯å¦å°äºŽ æ ¸å¿ƒæ± æ•°é‡if (workerCountOf(c) &lt; corePoolSize) 2ï¼‰å¦‚æžœæ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œåˆ™å°è¯•å‘æ ¸å¿ƒæ± æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ ï¼ˆaddWorker() ç¬¬äºŒä¸ªå‚æ•°å†³å®šäº†æ˜¯æ·»åŠ æ ¸å¿ƒæ± ï¼Œè¿˜æ˜¯æœ€å¤§æ± ï¼‰if (addWorker(command, true)) 3ï¼‰å¦‚æžœæˆåŠŸåˆ™é€€å‡ºæ–¹æ³•ï¼Œå¦åˆ™å°†æ‰§è¡Œ step2 step 2 1ï¼‰å¦‚æžœå½“å‰çº¿ç¨‹æ± å¤„äºŽè¿è¡ŒçŠ¶æ€ &amp;&amp; å°è¯•å‘ç¼“å†²é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡if (isRunning(c) &amp;&amp; workQueue.offer(command)) 2ï¼‰å¦‚æžœçº¿ç¨‹æ± æ­£åœ¨è¿è¡Œå¹¶ä¸”ç¼“å†²é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡æˆåŠŸï¼Œè¿›è¡Œ double checkï¼ˆå†æ¬¡æ£€æŸ¥ï¼‰ 3ï¼‰å¦‚æžœæ­¤æ—¶çº¿ç¨‹æ± éžè¿è¡ŒçŠ¶æ€ =&gt; ç§»é™¤é˜Ÿåˆ— =&gt; æ‹’ç»å½“å‰ä»»åŠ¡ï¼Œé€€å‡ºæ–¹æ³•ï¼ˆè¿™ä¹ˆåšæ˜¯ä¸ºäº†ï¼Œå½“çº¿ç¨‹æ± ä¸å¯ç”¨æ—¶åŠæ—¶å›žæ»šï¼‰ 12if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); 4ï¼‰å¦‚æžœå½“å‰æœ‰æ•ˆçº¿ç¨‹æ•°ä¸º0ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ— ä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹ï¼ˆæ­¤æ—¶è¿™ä¸ªçº¿ç¨‹ä¼šåŽ»é˜Ÿåˆ—ä¸­èŽ·å–ä»»åŠ¡ï¼‰ step 3 1ï¼‰å½“æ— æ³•æ— æ³•å‘æ ¸å¿ƒæ± å’Œé˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šå†å°è¯•å‘æœ€å¤§æ± ä¸­æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå¦‚æžœå¤±è´¥åˆ™æ‹’ç»è¯¥ä»»åŠ¡ 12else if (!addWorker(command, false)) reject(command); å›¾è§£execute()æ ¹æ®ä¸Šè¿°çš„æ­¥éª¤ç”»äº†å¦‚ä¸‹çš„è¿™ä¸ªå›¾ï¼Œå¸Œæœ›èƒ½å¸®åŠ©å¤§å®¶æ›´å¥½çš„ç†è§£ addWorker()åœ¨åˆ†æžexecute() æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† addWorker() çš„ä½œç”¨äº†ï¼Œå¯ä»¥å‘æ ¸å¿ƒæ± æˆ–è€…æœ€å¤§æ± æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•éƒ½åšäº†ä»€ä¹ˆ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566private boolean addWorker(Runnable firstTask, boolean core) &#123; retry: for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; for (;;) &#123; int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125; &#125; boolean workerStarted = false; boolean workerAdded = false; Worker w = null; try &#123; w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); workers.add(w); int s = workers.size(); if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; t.start(); workerStarted = true; &#125; &#125; &#125; finally &#123; if (! workerStarted) addWorkerFailed(w); &#125; return workerStarted;&#125; è¿™ä¸ªæ–¹æ³•ä»£ç çœ‹ä¼¼å¾ˆå¤æ‚ï¼Œæ²¡å…³ç³»ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥åˆ†æž step 1å…ˆçœ‹ç¬¬ä¸€éƒ¨åˆ† 12345678910111213141516171819202122232425retry:for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; for (;;) &#123; int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125;&#125; è¿™ä¸€éƒ¨åˆ†ä»£ç ï¼Œä¸»è¦æ˜¯åˆ¤æ–­ï¼Œæ˜¯å¦å¯ä»¥æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚ åœ¨execute()ä¸­å·²ç»åˆ¤æ–­è¿‡if (workerCountOf(c) &lt; corePoolSize)äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å†åˆ¤æ–­ï¼Ÿ å› ä¸ºåœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸­ï¼Œå½“ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œå¯èƒ½çº¿ç¨‹æ± å·²ç»å…³é—­äº†ï¼Œæˆ–è€…å…¶ä»–çº¿ç¨‹æäº¤äº†ä»»åŠ¡ï¼Œå¯¼è‡´workerCountOf(c) &gt; corePoolSize 1ï¼‰é¦–å…ˆè¿›å…¥ç¬¬ä¸€ä¸ªæ— é™forå¾ªçŽ¯ï¼ŒèŽ·å–ctlå¯¹è±¡ï¼ŒèŽ·å–å½“å‰çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼Œç„¶åŽåˆ¤æ–­12345if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; è¿™ä¸ªåˆ¤æ–­çš„æ„ä¹‰ä¸ºï¼Œå½“çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ &gt;= SHUTDOWN æ—¶ï¼Œå‘æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¿…é¡»åŒæ—¶æ»¡è¶³ rs == SHUTDOWN firstTask == null ! workQueue.isEmpty()ä¸‰ä¸ªæ¡ä»¶ï¼Œå¦åˆ™æ·»åŠ çº¿ç¨‹å¤±è´¥ æ‰€ä»¥å½“çº¿ç¨‹çŠ¶æ€ä¸ºSHUTDOWNæ—¶ï¼Œçº¿ç¨‹æ± å…è®¸æ·»åŠ ä¸€ä¸ªæ— ä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹åŽ»æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚ 2ï¼‰è¿›å…¥ç¬¬äºŒä¸ªæ— é™forå¾ªçŽ¯ 123456789101112for (;;) &#123; int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop&#125; èŽ·å–å½“å‰æœ‰æ•ˆçº¿ç¨‹æ•°ï¼Œif æœ‰æ•ˆçº¿ç¨‹æ•° &gt;= å®¹é‡ || æœ‰æ•ˆçº¿ç¨‹æ•° &gt;= æ ¸å¿ƒæ± æ•°é‡/æœ€å¤§æ± æ•°é‡ï¼Œåˆ™return false; æ·»åŠ çº¿ç¨‹å¤±è´¥ å¦‚æžœæœ‰æ•ˆçº¿ç¨‹æ•°åœ¨åˆç†èŒƒå›´ä¹‹å†…ï¼Œå°è¯•ä½¿ç”¨ CAS è‡ªå¢žæœ‰æ•ˆçº¿ç¨‹æ•° ï¼ˆCAS æ˜¯Javaä¸­çš„ä¹è§‚é”ï¼Œä¸äº†è§£çš„å°ä¼™ä¼´å¯ä»¥Googleä¸€ä¸‹ï¼‰ï¼Œä¹è§‚é”è‡ªå¢žæˆåŠŸï¼Œä»£è¡¨å½“å‰æ— å…¶ä»–çº¿ç¨‹ç«žäº‰ï¼Œç›¸å½“äºŽèŽ·å–åˆ°é”äº† å¦‚æžœè‡ªå¢žæˆåŠŸï¼Œbreak retry; è·³å‡ºè¿™ä¸¤ä¸ªå¾ªçŽ¯ï¼Œæ‰§è¡Œä¸‹é¢çš„ä»£ç  è‡ªå¢žå¤±è´¥ï¼Œæ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æžœçº¿ç¨‹æ± çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå›žåˆ°ç¬¬ä¸€ä¸ªfor ç»§ç»­æ‰§è¡Œï¼›å¦åˆ™ç»§ç»­åœ¨ç¬¬äºŒä¸ªfor ä¸­ï¼› step 2ä¸‹é¢è¿™éƒ¨åˆ†å°±æ¯”è¾ƒç®€å•äº† 1234567891011121314151617181920212223242526272829303132333435363738boolean workerStarted = false;boolean workerAdded = false;Worker w = null;try &#123; w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); workers.add(w); int s = workers.size(); if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; t.start(); workerStarted = true; &#125; &#125;&#125; finally &#123; if (! workerStarted) addWorkerFailed(w);&#125;return workerStarted; 1ï¼‰åˆ›å»ºå·¥ä½œçº¿ç¨‹å¯¹è±¡Workerï¼› 2ï¼‰åŠ é”ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦å…è®¸å¯åŠ¨çº¿ç¨‹ï¼›å¦‚æžœå¯ä»¥ï¼Œå°†çº¿ç¨‹åŠ å…¥workersï¼ˆè¿™ä¸ªå˜é‡åœ¨éœ€è¦éåŽ†æ‰€æœ‰å·¥ä½œçº¿ç¨‹æ—¶ä¼šç”¨åˆ°ï¼‰ï¼Œè®°å½•æœ€å¤§å€¼ï¼Œå¯åŠ¨çº¿ç¨‹ï¼› 3ï¼‰å¦‚æžœçº¿ç¨‹å¯åŠ¨å¤±è´¥ï¼Œæ‰§è¡ŒaddWorkerFailedï¼ˆä»Žworkersä¸­ç§»é™¤è¯¥å¯¹è±¡ï¼Œæœ‰æ•ˆçº¿ç¨‹æ•°å‡ä¸€ï¼Œå°è¯•ä¸­æ­¢çº¿ç¨‹æ± ï¼‰ WorkerWorkerå¯¹è±¡æ˜¯çº¿ç¨‹æ± ä¸­çš„å†…éƒ¨ç±»ï¼Œçº¿ç¨‹çš„å¤ç”¨ã€çº¿ç¨‹è¶…æ—¶éƒ½æ˜¯åœ¨è¿™å®žçŽ°çš„ 123456789private final class Worker extends AbstractQueuedSynchronizer implements Runnable&#123; // è¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒRun()ï¼Œçœç•¥äº†å…¶ä»–æºç ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±çœ‹ä¸€ä¸‹æºç  public void run() &#123; runWorker(this); &#125;&#125; Worker å®žçŽ°äº† Runnableï¼Œæˆ‘ä»¬è¿™é‡Œåªå…³å¿ƒ Worker çš„runæ–¹æ³•ä¸­åšäº†ä»€ä¹ˆï¼Œå…³äºŽ AbstractQueuedSynchronizer æœ‰å…³çš„ä¸åœ¨æœ¬æ–‡è®¨è®º ä¸‹é¢æˆ‘ä»¬åˆ†æžä¸€ä¸‹runWorker()1234567891011121314151617181920212223242526272829303132333435363738394041424344final void runWorker(Worker w) &#123; Thread wt = Thread.currentThread(); Runnable task = w.firstTask; w.firstTask = null; w.unlock(); // allow interrupts boolean completedAbruptly = true; try &#123; while (task != null || (task = getTask()) != null) &#123; w.lock(); // If pool is stopping, ensure thread is interrupted; // if not, ensure thread is not interrupted. This // requires a recheck in second case to deal with // shutdownNow race while clearing interrupt if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); try &#123; beforeExecute(wt, task); Throwable thrown = null; try &#123; task.run(); &#125; catch (RuntimeException x) &#123; thrown = x; throw x; &#125; catch (Error x) &#123; thrown = x; throw x; &#125; catch (Throwable x) &#123; thrown = x; throw new Error(x); &#125; finally &#123; afterExecute(task, thrown); &#125; &#125; finally &#123; task = null; w.completedTasks++; w.unlock(); &#125; &#125; // é€šè¿‡è¯¥å˜é‡åˆ¤æ–­æ˜¯ç”¨æˆ·ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸ç»“æŸï¼Œè¿˜æ˜¯çº¿ç¨‹æ± è‡ªç„¶ç»“æŸ completedAbruptly = false; &#125; finally &#123; processWorkerExit(w, completedAbruptly); &#125;&#125; 1ï¼‰123 while (task != null || (task = getTask()) != null) &#123;// ...&#125; ä¸å¯¹åœ°é€šè¿‡getTask() ä»Žé˜Ÿåˆ—ä¸­èŽ·å–ä»»åŠ¡ï¼Œå¯ä»¥é—´æŽ¥é€šè¿‡getTask()çš„è¿”å›žå€¼æŽ§åˆ¶çº¿ç¨‹çš„ç»“æŸ 2ï¼‰123456789// If pool is stopping, ensure thread is interrupted;// if not, ensure thread is not interrupted. This// requires a recheck in second case to deal with// shutdownNow race while clearing interruptif ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); æŽ¥ä¸‹æ¥è¿™ä¸ªåˆ¤æ–­ï¼Œå…¶å®žæˆ‘æ˜¯æ²¡æœ‰å¤ªç†è§£çš„ï¼Œæš‚ä¸”è®¤ä¸ºæ˜¯ä¿è¯å½“çº¿ç¨‹æ± STOPæ—¶ï¼Œçº¿ç¨‹ä¸€å®šä¼šè¢«æ‰“æ–­ 3ï¼‰æ‰§è¡ŒRunnable12345678910111213141516171819try &#123; beforeExecute(wt, task); Throwable thrown = null; try &#123; task.run(); &#125; catch (RuntimeException x) &#123; thrown = x; throw x; &#125; catch (Error x) &#123; thrown = x; throw x; &#125; catch (Throwable x) &#123; thrown = x; throw new Error(x); &#125; finally &#123; afterExecute(task, thrown); &#125;&#125; finally &#123; task = null; w.completedTasks++; w.unlock();&#125; beforeExecute(wt, task); å’Œ afterExecute(task, thrown); é»˜è®¤æ˜¯æ²¡æœ‰å®žçŽ°çš„ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ‰©å±• 4ï¼‰æœ€åŽæ˜¯å½“è·³å‡ºwhileå¾ªçŽ¯åŽï¼ˆgetTask() == nullæˆ–è€…ç”¨æˆ·ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œä¼šåŽ»æ‰§è¡ŒprocessWorkerExit(w, completedAbruptly);çº¿ç¨‹é€€å‡ºå·¥ä½œï¼ˆè¯¥æ–¹æ³•ä¼šæ ¹æ®çº¿ç¨‹æ± çŠ¶æ€ï¼Œå°è¯•ä¸­æ­¢çº¿ç¨‹æ± ã€‚ç„¶åŽä¼šè€ƒè™‘æ˜¯ç»“æŸå½“å‰çº¿ç¨‹ï¼Œè¿˜æ˜¯å†æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œè¿™é‡Œå°±ä¸ç»†è¯´äº†ï¼‰ æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ getTask() æ–¹æ³•12345678910111213141516171819202122232425262728293031323334353637private Runnable getTask() &#123; boolean timedOut = false; // Did the last poll() time out? for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123; decrementWorkerCount(); return null; &#125; int wc = workerCountOf(c); // Are workers subject to culling? boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize; if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123; if (compareAndDecrementWorkerCount(c)) return null; continue; &#125; try &#123; Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take(); if (r != null) return r; timedOut = true; &#125; catch (InterruptedException retry) &#123; timedOut = false; &#125; &#125;&#125; 1ï¼‰ ç¬¬ä¸€æ®µä¸åšè§£é‡Šï¼Œæ»¡è¶³è¯¥æ¡ä»¶æ—¶ï¼Œreturn null; é€€å‡ºçº¿ç¨‹12345// Check if queue empty only if necessary.if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123; decrementWorkerCount(); return null;&#125; 2ï¼‰ ä¸‹é¢è¿™æ®µå¾ˆæœ‰æ„æ€12345678910111213141516int wc = workerCountOf(c);// Are workers subject to culling?// æ˜¯å¦å…è®¸çº¿ç¨‹è¶…æ—¶// å½“æˆ‘ä»¬è®¾ç½®äº†å…è®¸æ ¸å¿ƒæ± è¶…æ—¶ æˆ–è€… æœ‰æ•ˆçº¿ç¨‹æ•° &gt; æ ¸å¿ƒæ± æ•°é‡çš„æ—¶å€™// çº¿ç¨‹æ± ä¼šè€ƒè™‘ä¸ºæˆ‘ä»¬æ¸…é™¤æŽ‰ä¸€äº›çº¿ç¨‹boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;// (æœ‰æ•ˆçº¿ç¨‹æ•° &gt; æœ€å¤§çº¿ç¨‹æ± æ•°é‡ || (å…è®¸è¶…æ—¶ &amp;&amp; è¶…æ—¶) ) // &amp;&amp; (æœ‰æ•ˆçº¿ç¨‹æ•° &gt; 1 || æˆ–è€…é˜Ÿåˆ—ä¸ºç©ºæ—¶)if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) // timedOut è¡¨ç¤ºå½“å‰çº¿ç¨‹è¶…æ—¶ï¼Œä¸‹æ–‡ä¼šè¯´åˆ° &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123; if (compareAndDecrementWorkerCount(c)) return null; continue;&#125; æˆ‘åœ¨ç¬¬ä¸€æ¬¡çœ‹è¿™æ®µä»£ç çš„æ—¶å€™ï¼Œå‚»å‚»çš„ä»¥ä¸º timedOut ä¸æ˜¯æ°¸è¿œä¸ºfalseå—ï¼Œæˆ‘ä»¥ä¸ºJDKæºç æ€Žä¹ˆå†™å‡ºè¿™ä¹ˆä¸ªBugã€‚åˆ«å¿˜äº†å½“å‰çš„getTask()æ–¹æ³•ä¹Ÿæ˜¯åœ¨ä¸€ä¸ªæ— é™å¾ªçŽ¯é‡Œ 3ï¼‰12345678910try &#123; Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take(); if (r != null) return r; timedOut = true;&#125; catch (InterruptedException retry) &#123; timedOut = false;&#125; æ ¹æ® timedï¼Œå†³å®šè°ƒç”¨ä½¿ç”¨poll() æˆ–è€… take()ã€‚ poll åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ä¼šç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œå¦‚æžœè¿™æœŸé—´æ²¡æœ‰èŽ·å–åˆ°å…ƒç´ ï¼Œåˆ™return null take åˆ™åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´è‡³é˜Ÿåˆ—ä¸­è¢«æ·»åŠ æ–°çš„ä»»åŠ¡ï¼Œæˆ–è€…è¢«æ‰“æ–­ï¼›è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè¢«shutdown() æˆ–è€… shutdownNowçš„ thread.interrupt()æ‰“æ–­ï¼›å¦‚æžœè¢«æ‰“æ–­åˆ™å›žåˆ°ç¬¬ä¸€æ­¥ è‡³æ­¤ execute() æ–¹æ³•æ‰€æ¶‰åŠçš„é€»è¾‘æˆ‘ä»¬å·®ä¸å¤šåˆ†æžå®Œäº† å¤‡æ³¨çº¿ç¨‹æ± ä½¿ç”¨1234567891011121314public class Test &#123; public static void main(String[] args) &#123; ThreadPoolExecutor executor = new ThreadPoolExecutor(5, 10, 60, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(5)); executor.execute(() -&gt; &#123; // ä¸šåŠ¡é€»è¾‘ &#125;); executor.shutdown(); &#125;&#125; åˆç†é…ç½®çº¿ç¨‹æ± çš„å¤§å°ä¸€èˆ¬éœ€è¦æ ¹æ®ä»»åŠ¡çš„ç±»åž‹æ¥é…ç½®çº¿ç¨‹æ± å¤§å°ï¼š å¦‚æžœæ˜¯CPUå¯†é›†åž‹ä»»åŠ¡ï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ä¸º N+1 ï¼ˆN ä¸ºCPUæ ¸å¿ƒæ•°ï¼‰ å¦‚æžœæ˜¯IOå¯†é›†åž‹ä»»åŠ¡ï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ç½®ä¸º2*N å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå‚è€ƒå€¼ï¼Œå…·ä½“çš„è®¾ç½®è¿˜éœ€è¦æ ¹æ®å®žé™…æƒ…å†µè¿›è¡Œè°ƒæ•´ï¼Œæ¯”å¦‚å¯ä»¥å…ˆå°†çº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸ºå‚è€ƒå€¼ï¼Œå†è§‚å¯Ÿä»»åŠ¡è¿è¡Œæƒ…å†µå’Œç³»ç»Ÿè´Ÿè½½ã€èµ„æºåˆ©ç”¨çŽ‡æ¥è¿›è¡Œé€‚å½“è°ƒæ•´ã€‚ å‚è€ƒ JDK1.8 https://www.cnblogs.com/dolphin0520/p/3932921.html]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>ThreadPoolExecutor</tag>
        <tag>çº¿ç¨‹æ± </tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring æºç è§£æž @RequestBody @ResponseBody çš„æ¥é¾™åŽ»è„‰]]></title>
    <url>%2Fpost%2Fb75109d6.html</url>
    <content type="text"><![CDATA[@RequestBody å’Œ @ResponseBody æ˜¯å®žé™…å¼€å‘ä¸­å¾ˆå¸¸ç”¨çš„ä¸¤ä¸ªæ³¨è§£ï¼Œé€šå¸¸ç”¨æ¥è§£æžå’Œå“åº”JSONï¼Œç”¨èµ·æ¥ååˆ†çš„æ–¹ä¾¿ï¼Œè¿™ä¸¤ä¸ªæ³¨è§£çš„èƒŒåŽæ˜¯å¦‚ä½•å®žçŽ°çš„ï¼Ÿ æºç ç‰ˆæœ¬SpringBoot 2.1.3.RELEASE RequestResponseBodyMethodProcessor Resolves method arguments annotated with @RequestBody and handles return values from methods annotated with @ResponseBody by reading and writing to the body of the request or response with an HttpMessageConverter.An @RequestBody method argument is also validated if it is annotated with @javax.validation.Valid. In case of validation failure, MethodArgumentNotValidException is raised and results in an HTTP 400 response status code if DefaultHandlerExceptionResolver is configured. ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªç±»ç”¨æ¥è§£æž@RequestBodyçš„å‚æ•°å’Œå¤„ç† @ResponseBodyè¿”å›žå€¼ï¼Œé€šè¿‡ HttpMessageConverter è¿™ä¸ªæŽ¥å£æ¥å®žçŽ°ã€‚ å¦‚æžœ@RequestBodyæ ‡è®°çš„å‚æ•°åŒ…å«@Validï¼Œè¿˜ä¼šå¯¹è¿™ä¸ªå‚æ•°è¿›è¡Œæ ¡éªŒã€‚ ç»§æ‰¿å…³ç³» HandlerMethodArgumentResolver å’Œ HandlerMethodReturnValueHandler åˆ†åˆ«æ˜¯Springçš„å‚æ•°å¤„ç†å™¨å’Œè¿”å›žå€¼å¤„ç†å™¨ HandlerMethodArgumentResolver 12345678public interface HandlerMethodArgumentResolver &#123; boolean supportsParameter(MethodParameter parameter); Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer, NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception;&#125; Springçš„å‚æ•°è§£æžå™¨æŽ¥å£ï¼ŒsupportsParameter() æ–¹æ³•ç”¨äºŽåˆ¤æ–­è§£æžå™¨æ˜¯å¦æ”¯æŒå½“å‰Controlleræ–¹æ³•çš„å‚æ•°ï¼ŒresolveArgument() åˆ™æ˜¯å°†Requestè§£æžä¸ºControlleræ–¹æ³•å¯¹åº”çš„å‚æ•°Bean HandlerMethodReturnValueHandler 12345678public interface HandlerMethodReturnValueHandler &#123; boolean supportsReturnType(MethodParameter returnType); void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception;&#125; åŒç†è¿™ä¸ªæŽ¥å£å°†Controlleræ–¹æ³•è¿”å›žçš„å¯¹è±¡ï¼Œå°è£…ä¸ºResponse æˆ‘ä»¬åœ¨å®žé™…å¼€å‘æ—¶ï¼Œä¹Ÿå¯ä»¥å®žçŽ°è¿™ä¸¤ä¸ªæŽ¥å£è‡ªå®šä¹‰è‡ªå·±çš„å‚æ•°è§£æžå’Œå“åº”å¤„ç†ï¼ŒRequestResponseBodyMethodProcessor å®žçŽ°äº†è¿™ä¸¤ä¸ªæŽ¥å£ï¼Œæ—¢åšäº†å‚æ•°è§£æžå™¨ä¹Ÿåšäº†å“åº”å¤„ç†å™¨ã€‚ RequestResponseBodyMethodProcessor æºç åˆ†æžæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ RequestResponseBodyMethodProcessor æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»¥è§£æžå‚æ•°ä¸ºä¾‹ resolveArgument 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647@Overridepublic boolean supportsParameter(MethodParameter parameter) &#123; // æ”¯æŒæ ‡è®°@RequestBodyçš„å‚æ•° return parameter.hasParameterAnnotation(RequestBody.class);&#125;@Overridepublic Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer, NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception &#123; parameter = parameter.nestedIfOptional(); // é€šè¿‡HttpMessageConverters å°†è¯·æ±‚ä½“, å°è£…ä¸º@RequestBodyæ‰€æ ‡è®°çš„XXBean Object arg = readWithMessageConverters(webRequest, parameter, parameter.getNestedGenericParameterType()); String name = Conventions.getVariableNameForParameter(parameter); if (binderFactory != null) &#123; WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name); if (arg != null) &#123; // å¦‚æžœå­˜åœ¨@Valid å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒ validateIfApplicable(binder, parameter); if (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123; throw new MethodArgumentNotValidException(parameter, binder.getBindingResult()); &#125; &#125; if (mavContainer != null) &#123; mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult()); &#125; &#125; return adaptArgumentIfNecessary(arg, parameter);&#125;@Overrideprotected &lt;T&gt; Object readWithMessageConverters(NativeWebRequest webRequest, MethodParameter parameter, Type paramType) throws IOException, HttpMediaTypeNotSupportedException, HttpMessageNotReadableException &#123; HttpServletRequest servletRequest = webRequest.getNativeRequest(HttpServletRequest.class); Assert.state(servletRequest != null, "No HttpServletRequest"); ServletServerHttpRequest inputMessage = new ServletServerHttpRequest(servletRequest); Object arg = readWithMessageConverters(inputMessage, parameter, paramType); if (arg == null &amp;&amp; checkRequired(parameter)) &#123; throw new HttpMessageNotReadableException("Required request body is missing: " + parameter.getExecutable().toGenericString(), inputMessage); &#125; return arg;&#125; ä½œä¸ºå‚æ•°è§£æžå™¨ï¼ŒRequestResponseBodyMethodProcessor æ”¯æŒæ‰€æœ‰æ ‡è®°@RequestBodyçš„å‚æ•°ã€‚åœ¨resolveArgument()æ–¹æ³•ä¸­ï¼Œé€šè¿‡è°ƒç”¨readWithMessageConverters() å°† Request è½¬ä¸ºå¯¹åº” argã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ readWithMessageConverters() åˆ°åº•åšäº†ä»€ä¹ˆ readWithMessageConverters 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980protected &lt;T&gt; Object readWithMessageConverters(HttpInputMessage inputMessage, MethodParameter parameter, Type targetType) throws IOException, HttpMediaTypeNotSupportedException, HttpMessageNotReadableException &#123; // å½“å‰è¯·æ±‚çš„contentType MediaType contentType; boolean noContentType = false; try &#123; contentType = inputMessage.getHeaders().getContentType(); &#125; catch (InvalidMediaTypeException ex) &#123; throw new HttpMediaTypeNotSupportedException(ex.getMessage()); &#125; if (contentType == null) &#123; noContentType = true; contentType = MediaType.APPLICATION_OCTET_STREAM; &#125; // Controllerå‚æ•°çš„Class Class&lt;?&gt; contextClass = parameter.getContainingClass(); Class&lt;T&gt; targetClass = (targetType instanceof Class ? (Class&lt;T&gt;) targetType : null); if (targetClass == null) &#123; ResolvableType resolvableType = ResolvableType.forMethodParameter(parameter); targetClass = (Class&lt;T&gt;) resolvableType.resolve(); &#125; // å½“å‰è¯·æ±‚æ–¹å¼ HttpMethod httpMethod = (inputMessage instanceof HttpRequest ? ((HttpRequest) inputMessage).getMethod() : null); Object body = NO_VALUE; EmptyBodyCheckingHttpInputMessage message; try &#123; message = new EmptyBodyCheckingHttpInputMessage(inputMessage); // éåŽ†æ‰€æœ‰çš„HttpMessageConverterï¼Œ for (HttpMessageConverter&lt;?&gt; converter : this.messageConverters) &#123; Class&lt;HttpMessageConverter&lt;?&gt;&gt; converterType = (Class&lt;HttpMessageConverter&lt;?&gt;&gt;) converter.getClass(); GenericHttpMessageConverter&lt;?&gt; genericConverter = (converter instanceof GenericHttpMessageConverter ? (GenericHttpMessageConverter&lt;?&gt;) converter : null); // å¦‚æžœå½“å‰çš„HttpMessageConverterå¯ä»¥è§£æžå¯¹åº”çš„ classå’ŒcontentType if (genericConverter != null ? genericConverter.canRead(targetType, contextClass, contentType) : (targetClass != null &amp;&amp; converter.canRead(targetClass, contentType))) &#123; if (message.hasBody()) &#123; HttpInputMessage msgToUse = getAdvice().beforeBodyRead(message, parameter, targetType, converterType); // å°†HttpæŠ¥æ–‡è½¬æ¢ä¸ºå¯¹åº”çš„class body = (genericConverter != null ? genericConverter.read(targetType, contextClass, msgToUse) : ((HttpMessageConverter&lt;T&gt;) converter).read(targetClass, msgToUse)); body = getAdvice().afterBodyRead(body, msgToUse, parameter, targetType, converterType); &#125; else &#123; body = getAdvice().handleEmptyBody(null, message, parameter, targetType, converterType); &#125; break; &#125; &#125; &#125; catch (IOException ex) &#123; throw new HttpMessageNotReadableException("I/O error while reading input message", ex, inputMessage); &#125; if (body == NO_VALUE) &#123; if (httpMethod == null || !SUPPORTED_METHODS.contains(httpMethod) || (noContentType &amp;&amp; !message.hasBody())) &#123; return null; &#125; throw new HttpMediaTypeNotSupportedException(contentType, this.allSupportedMediaTypes); &#125; MediaType selectedContentType = contentType; Object theBody = body; LogFormatUtils.traceDebug(logger, traceOn -&gt; &#123; String formatted = LogFormatUtils.formatValue(theBody, !traceOn); return "Read \"" + selectedContentType + "\" to [" + formatted + "]"; &#125;); return body;&#125; ä¸Šè¿°ä»£ç æ ¸å¿ƒé€»è¾‘å°±æ˜¯éåŽ†å½“å‰è§£æžä¸­é…ç½®çš„æ‰€æœ‰ HttpMessageConverterï¼Œå¦‚æžœæŸä¸ªConverterå¯ä»¥è§£æžå½“å‰çš„ contentTypeï¼Œå°±æŠŠè½¬æ¢å·¥ä½œäº¤ç»™ä»–åŽ»è¿›è¡Œã€‚ ä¹‹å‰åšè¿‡å°†é»˜è®¤è§£æžæ›¿æ¢ä¸ºfastjsonï¼Œå½“æ—¶å°±æ˜¯æ·»åŠ ä¸€ä¸ªFastJsonå®žçŽ°çš„HttpMessageConverterï¼Œä½†æ˜¯é‚£æ—¶å€™å¹¶ä¸ç†è§£è¿™ä¹ˆåšæ˜¯ä¸ºäº†ä»€ä¹ˆï¼ŒçŽ°åœ¨æ‰æç„¶å¤§æ‚Ÿâ€¦ handleReturnValue RequestResponseBodyMethodProcessor çš„Responseå¤„ç†é€»è¾‘å’Œè§£æžé€»è¾‘ç±»ä¼¼ï¼Œæ‰¾åˆ°ä¸€ä¸ªæ”¯æŒçš„HttpMessageConverterï¼ŒæŠŠå“åº”å·¥ä½œäº¤ç»™ä»–ï¼Œæ„Ÿå…´è¶£çš„ç«¥éž‹å¯ä»¥è‡ªå·±æ‰¾ä¸‹æºç ã€‚ RequestResponseBodyMethodProcessor æ˜¯æ€Žä¹ˆè¢«è°ƒç”¨çš„ä¸Šé¢è®²äº† RequestResponseBodyMethodProcessor åšäº†å‚æ•°è§£æžå’Œå“åº”å¤„ç†çš„å·¥ä½œï¼Œé‚£ä¹ˆä»–åœ¨Springæ¡†æž¶ä¸­æ˜¯æ€Žä¹ˆè¢«è°ƒç”¨çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ å¦‚å›¾ï¼ŒRequestMappingHandlerAdapter çš„resolversï¼ˆRequestè§£æžå™¨ï¼‰ã€handlersï¼ˆResponseå¤„ç†å™¨ï¼‰è¿˜æœ‰ ExceptionHandlerExceptionResolver çš„handlers è°ƒç”¨äº† RequestResponseBodyMethodProcessor RequestMappingHandlerAdapteræˆ‘ä»¬åªåˆ†æžä¸€ä¸‹ RequestMappingHandlerAdapter ï¼Œè¯¥ç±»å¯¹æ‰€æœ‰æ ‡è®° @RequestMappingçš„æ³¨è§£è¿›è¡Œè§£æžå’Œå“åº” åœ¨WebMvcConfigurationSupportä¸­ï¼Œé…ç½®äº†è¯¥Beanï¼Œå°†å…¶åŠ å…¥åˆ°Springå®¹å™¨ä¸­ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„å‚æ•°è§£æžã€å“åº”è§£æžã€å’ŒHttpMessageConvert é€šè¿‡ä¸Šå›¾çš„æ–¹æ³•setåˆ° RequestMappingHandlerAdapter ä¸­ã€‚ 123456789101112131415161718192021222324252627282930@Beanpublic RequestMappingHandlerAdapter requestMappingHandlerAdapter() &#123; RequestMappingHandlerAdapter adapter = createRequestMappingHandlerAdapter(); adapter.setContentNegotiationManager(mvcContentNegotiationManager()); // èŽ·å–æ‰€æœ‰HttpMessageConverterï¼ŒåŒ…æ‹¬æˆ‘ä»¬è‡ªå®šä¹‰çš„é…ç½® adapter.setMessageConverters(getMessageConverters()); adapter.setWebBindingInitializer(getConfigurableWebBindingInitializer()); // è‡ªå®šä¹‰çš„å‚æ•°è§£æžå™¨ adapter.setCustomArgumentResolvers(getArgumentResolvers()); // è‡ªå®šä¹‰çš„å“åº”å¤„ç†å™¨ adapter.setCustomReturnValueHandlers(getReturnValueHandlers()); if (jackson2Present) &#123; adapter.setRequestBodyAdvice(Collections.singletonList(new JsonViewRequestBodyAdvice())); adapter.setResponseBodyAdvice(Collections.singletonList(new JsonViewResponseBodyAdvice())); &#125; AsyncSupportConfigurer configurer = new AsyncSupportConfigurer(); configureAsyncSupport(configurer); if (configurer.getTaskExecutor() != null) &#123; adapter.setTaskExecutor(configurer.getTaskExecutor()); &#125; if (configurer.getTimeout() != null) &#123; adapter.setAsyncRequestTimeout(configurer.getTimeout()); &#125; adapter.setCallableInterceptors(configurer.getCallableInterceptors()); adapter.setDeferredResultInterceptors(configurer.getDeferredResultInterceptors()); return adapter;&#125; ç»§ç»­è¯´ RequestMappingHandlerAdapter ï¼ŒgetDefaultArgumentResolvers() å°è£…äº†SpringBootä¸­çš„é»˜è®¤å‚æ•°è§£æžå™¨ï¼Œå…¶ä¸­å°±æœ‰æˆ‘ä»¬çš„æœ¬èŠ‚æ‰€è®²çš„ RequestResponseBodyMethodProcessor ï¼Œåœ¨afterPropertiesSet() æ–¹æ³•ä¸­è°ƒç”¨äº†è¯¥æ–¹æ³• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667@Overridepublic void afterPropertiesSet() &#123; // Do this first, it may add ResponseBody advice beans initControllerAdviceCache(); if (this.argumentResolvers == null) &#123; List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers(); this.argumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers); &#125; if (this.initBinderArgumentResolvers == null) &#123; List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultInitBinderArgumentResolvers(); this.initBinderArgumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers); &#125; if (this.returnValueHandlers == null) &#123; List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers(); this.returnValueHandlers = new HandlerMethodReturnValueHandlerComposite().addHandlers(handlers); &#125;&#125;private List&lt;HandlerMethodArgumentResolver&gt; getDefaultArgumentResolvers() &#123; List&lt;HandlerMethodArgumentResolver&gt; resolvers = new ArrayList&lt;&gt;(); // Annotation-based argument resolution resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), false)); resolvers.add(new RequestParamMapMethodArgumentResolver()); resolvers.add(new PathVariableMethodArgumentResolver()); resolvers.add(new PathVariableMapMethodArgumentResolver()); resolvers.add(new MatrixVariableMethodArgumentResolver()); resolvers.add(new MatrixVariableMapMethodArgumentResolver()); resolvers.add(new ServletModelAttributeMethodProcessor(false)); // æ·»åŠ RequestResponseBodyMethodProcessor resolvers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice)); // çœç•¥ï¼Œè¯¦è§æºç ... return resolvers;&#125;private List&lt;HandlerMethodReturnValueHandler&gt; getDefaultReturnValueHandlers() &#123; List&lt;HandlerMethodReturnValueHandler&gt; handlers = new ArrayList&lt;&gt;(); // Single-purpose return value types handlers.add(new ModelAndViewMethodReturnValueHandler()); handlers.add(new ModelMethodProcessor()); handlers.add(new ViewMethodReturnValueHandler()); handlers.add(new ResponseBodyEmitterReturnValueHandler(getMessageConverters(), this.reactiveAdapterRegistry, this.taskExecutor, this.contentNegotiationManager)); handlers.add(new StreamingResponseBodyReturnValueHandler()); handlers.add(new HttpEntityMethodProcessor(getMessageConverters(), this.contentNegotiationManager, this.requestResponseBodyAdvice)); handlers.add(new HttpHeadersReturnValueHandler()); handlers.add(new CallableMethodReturnValueHandler()); handlers.add(new DeferredResultMethodReturnValueHandler()); handlers.add(new AsyncTaskMethodReturnValueHandler(this.beanFactory)); // Annotation-based return value types handlers.add(new ModelAttributeMethodProcessor(false)); // æ·»åŠ RequestResponseBodyMethodProcessor handlers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(), this.contentNegotiationManager, this.requestResponseBodyAdvice)); // çœç•¥ï¼Œè¯¦è§æºç ... return handlers;&#125; RequestResponseBodyMethodProcessor ä½•æ—¶è¢«è°ƒç”¨ä¸Šé¢é“ºåž«äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºŽæ¥äº† RequestMappingHandlerAdapter çš„ invokeHandlerMethod ä¸­ æž„å»ºäº† invocableMethod å¯¹è±¡å¹¶å°†æ‰€æœ‰çš„è§£æžå™¨å’Œå¤„ç†å™¨å°è£…åˆ°è¯¥å¯¹è±¡ï¼Œé€šè¿‡invocableMethod.invokeAndHandle() è¿›è¡Œå¯¹è¯·æ±‚çš„è§£æžï¼Œå¯¹controllerçš„è°ƒç”¨ï¼Œä»¥åŠå“åº”çš„å¤„ç† invocableMethod.invokeAndHandle() ä¸­æ˜¯æ€Žä¹ˆæ ·å®žçŽ°çš„123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687public void invokeAndHandle(ServletWebRequest webRequest, ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123; // å‚æ•°è§£æžï¼Œå¹¶åå°„è°ƒç”¨controlleræ–¹æ³•ï¼ŒèŽ·å–æ–¹æ³•è¿”å›žå€¼ Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs); // ä¸‹é¢å°±æ˜¯å¯¹Responseçš„å¤„ç† setResponseStatus(webRequest); if (returnValue == null) &#123; if (isRequestNotModified(webRequest) || getResponseStatus() != null || mavContainer.isRequestHandled()) &#123; mavContainer.setRequestHandled(true); return; &#125; &#125; else if (StringUtils.hasText(getResponseStatusReason())) &#123; mavContainer.setRequestHandled(true); return; &#125; mavContainer.setRequestHandled(false); Assert.state(this.returnValueHandlers != null, "No return value handlers"); try &#123; this.returnValueHandlers.handleReturnValue( returnValue, getReturnValueType(returnValue), mavContainer, webRequest); &#125; catch (Exception ex) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(formatErrorForReturnValue(returnValue), ex); &#125; throw ex; &#125;&#125;public Object invokeForRequest(NativeWebRequest request, @Nullable ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123; // è°ƒç”¨å‚æ•°è§£æžå™¨èŽ·å–è°ƒç”¨controller æ‰€éœ€çš„å‚æ•° Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs); if (logger.isTraceEnabled()) &#123; logger.trace("Arguments: " + Arrays.toString(args)); &#125; // åå°„è°ƒç”¨ controller return doInvoke(args);&#125;protected Object[] getMethodArgumentValues(NativeWebRequest request, @Nullable ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123; if (ObjectUtils.isEmpty(getMethodParameters())) &#123; return EMPTY_ARGS; &#125; MethodParameter[] parameters = getMethodParameters(); Object[] args = new Object[parameters.length]; // éåŽ†è§£æžå‚æ•° for (int i = 0; i &lt; parameters.length; i++) &#123; MethodParameter parameter = parameters[i]; parameter.initParameterNameDiscovery(this.parameterNameDiscoverer); args[i] = findProvidedArgument(parameter, providedArgs); if (args[i] != null) &#123; continue; &#125; // è¿™é‡Œçš„ resolvers æ˜¯ä¸€ä¸ªå°è£…äº†æ‰€æœ‰å‚æ•°è§£æžå™¨çš„åŒ…è£…ç±»ï¼ŒéåŽ†æ‰€æœ‰è§£æžå™¨ï¼Œå¦‚æžœä¸èƒ½æ‰¾åˆ°æ”¯æŒå½“å‰å‚æ•°çš„ï¼ŒæŠ›å‡ºå¼‚å¸¸ // å¦‚æžœæ‰¾åˆ°å½“å‰å‚æ•°å¯¹åº”çš„è§£æžå™¨ï¼Œåˆ™ç¼“å­˜èµ·æ¥ï¼Œåœ¨ä¸‹é¢çš„ resolvers.resolveArgument æ—¶ï¼Œç›´æŽ¥ä½¿ç”¨ if (!this.resolvers.supportsParameter(parameter)) &#123; throw new IllegalStateException(formatArgumentError(parameter, "No suitable resolver")); &#125; try &#123; // è°ƒç”¨å‚æ•°è§£æžå™¨ args[i] = this.resolvers.resolveArgument(parameter, mavContainer, request, this.dataBinderFactory); &#125; catch (Exception ex) &#123; // Leave stack trace for later, exception may actually be resolved and handled.. if (logger.isDebugEnabled()) &#123; String error = ex.getMessage(); if (error != null &amp;&amp; !error.contains(parameter.getExecutable().toGenericString())) &#123; logger.debug(formatArgumentError(parameter, error)); &#125; &#125; throw ex; &#125; &#125; return args;&#125; invokeAndHandle() é‡Œåšäº†ä¸‰ä»¶äº‹ å°†è¯·æ±‚ä¸­è§£æžä¸ºControllerä¸­æŒ‡å®šçš„å‚æ•° ç”¨è§£æžå¥½çš„å‚æ•°åå°„è°ƒç”¨ Controller æ–¹æ³• å¤„ç†å“åº” ä¸€æ¬¡Httpè¯·æ±‚ç»åŽ†äº†ä»€ä¹ˆå›žè¿‡å¤´æ¥å†çœ‹ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å‘ä¸€ä¸ªè¯·æ±‚ï¼Œåœ¨ RequestMappingHandlerAdapter çš„ invokeHandlerMethod()ä¸­ debugä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹çº¿ç¨‹æ ˆæ˜¯ä»€ä¹ˆæ ·çš„ ç®€å•ç”»ä¸€å¼ å›¾æ¥è¡¨ç¤ºä¸€ä¸‹ END æ¬¢è¿Žå„ä½ç»™å‡ºæ„è§å’ŒæŒ‡æ­£]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>æºç </tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaå¹¶å‘ç¼–ç¨‹-volatile]]></title>
    <url>%2Fpost%2Feb0b8344.html</url>
    <content type="text"><![CDATA[åŽŸæ–‡ï¼šJavaå¹¶å‘ç¼–ç¨‹ï¼švolatileå…³é”®å­—è§£æž åŽŸæ–‡è®²è§£äº†å¾ˆå¤šä¸œè¥¿ä½œä¸ºé“ºåž«ï¼Œåœ¨åŽŸæ–‡å†…å®¹æœ‰äº›åˆ å‡å’Œæ›´æ”¹ã€‚å¦‚è¯»è€…è§‰å¾—ä¸å¦¥ï¼Œæˆ–è€…ç†è§£ä¸åˆ°ä½ï¼Œå»ºè®®é˜…è¯»åŽŸæ–‡ã€‚ å†…å­˜æ¨¡åž‹ç›¸å…³æ¦‚å¿µå¤§å®¶éƒ½çŸ¥é“ï¼Œè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½æ˜¯åœ¨CPUä¸­æ‰§è¡Œçš„ï¼Œè€Œæ‰§è¡ŒæŒ‡ä»¤è¿‡ç¨‹ä¸­ï¼ŒåŠ¿å¿…æ¶‰åŠåˆ°æ•°æ®çš„è¯»å–å’Œå†™å…¥ã€‚ç”±äºŽç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ•°æ®æ˜¯å­˜æ”¾åœ¨ä¸»å­˜ï¼ˆç‰©ç†å†…å­˜ï¼‰å½“ä¸­çš„ï¼Œè¿™æ—¶å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºŽCPUæ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ï¼Œè€Œä»Žå†…å­˜è¯»å–æ•°æ®å’Œå‘å†…å­˜å†™å…¥æ•°æ®çš„è¿‡ç¨‹è·ŸCPUæ‰§è¡ŒæŒ‡ä»¤çš„é€Ÿåº¦æ¯”èµ·æ¥è¦æ…¢çš„å¤šï¼Œå› æ­¤å¦‚æžœä»»ä½•æ—¶å€™å¯¹æ•°æ®çš„æ“ä½œéƒ½è¦é€šè¿‡å’Œå†…å­˜çš„äº¤äº’æ¥è¿›è¡Œï¼Œä¼šå¤§å¤§é™ä½ŽæŒ‡ä»¤æ‰§è¡Œçš„é€Ÿåº¦ã€‚å› æ­¤åœ¨CPUé‡Œé¢å°±æœ‰äº†é«˜é€Ÿç¼“å­˜ã€‚ ä¹Ÿå°±æ˜¯ï¼Œå½“ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå°†è¿ç®—éœ€è¦çš„æ•°æ®ä»Žä¸»å­˜å¤åˆ¶ä¸€ä»½åˆ°CPUçš„é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œé‚£ä¹ˆCPUè¿›è¡Œè®¡ç®—æ—¶å°±å¯ä»¥ç›´æŽ¥ä»Žå®ƒçš„é«˜é€Ÿç¼“å­˜è¯»å–æ•°æ®å’Œå‘å…¶ä¸­å†™å…¥æ•°æ®ï¼Œå½“è¿ç®—ç»“æŸä¹‹åŽï¼Œå†å°†é«˜é€Ÿç¼“å­˜ä¸­çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚ä¸‹é¢çš„è¿™æ®µä»£ç ï¼š 1i = i + 1; å½“çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªè¯­å¥æ—¶ï¼Œä¼šå…ˆä»Žä¸»å­˜å½“ä¸­è¯»å–içš„å€¼ï¼Œç„¶åŽå¤åˆ¶ä¸€ä»½åˆ°é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œç„¶åŽCPUæ‰§è¡ŒæŒ‡ä»¤å¯¹iè¿›è¡ŒåŠ 1æ“ä½œï¼Œç„¶åŽå°†æ•°æ®å†™å…¥é«˜é€Ÿç¼“å­˜ï¼Œæœ€åŽå°†é«˜é€Ÿç¼“å­˜ä¸­iæœ€æ–°çš„å€¼åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚ è¿™ä¸ªä»£ç åœ¨å•çº¿ç¨‹ä¸­è¿è¡Œæ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸­è¿è¡Œå°±ä¼šæœ‰é—®é¢˜äº†ã€‚åœ¨å¤šæ ¸CPUä¸­ï¼Œæ¯æ¡çº¿ç¨‹å¯èƒ½è¿è¡ŒäºŽä¸åŒçš„CPUä¸­ï¼Œå› æ­¤æ¯ä¸ªçº¿ç¨‹è¿è¡Œæ—¶æœ‰è‡ªå·±çš„é«˜é€Ÿç¼“å­˜ï¼ˆå¯¹å•æ ¸CPUæ¥è¯´ï¼Œå…¶å®žä¹Ÿä¼šå‡ºçŽ°è¿™ç§é—®é¢˜ï¼Œåªä¸è¿‡æ˜¯ä»¥çº¿ç¨‹è°ƒåº¦çš„å½¢å¼æ¥åˆ†åˆ«æ‰§è¡Œçš„ï¼‰ã€‚æœ¬æ–‡æˆ‘ä»¬ä»¥å¤šæ ¸CPUä¸ºä¾‹ã€‚ æ¯”å¦‚åŒæ—¶æœ‰2ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™æ®µä»£ç ï¼Œå‡å¦‚åˆå§‹æ—¶içš„å€¼ä¸º0ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä¹‹åŽiçš„å€¼å˜ä¸º2ã€‚ä½†æ˜¯äº‹å®žä¼šæ˜¯è¿™æ ·å—ï¼Ÿ å¯èƒ½å­˜åœ¨ä¸‹é¢ä¸€ç§æƒ…å†µï¼šåˆå§‹æ—¶ï¼Œä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è¯»å–içš„å€¼å­˜å…¥å„è‡ªæ‰€åœ¨çš„CPUçš„é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œç„¶åŽçº¿ç¨‹1è¿›è¡ŒåŠ 1æ“ä½œï¼Œç„¶åŽæŠŠiçš„æœ€æ–°å€¼1å†™å…¥åˆ°å†…å­˜ã€‚æ­¤æ—¶çº¿ç¨‹2çš„é«˜é€Ÿç¼“å­˜å½“ä¸­içš„å€¼è¿˜æ˜¯0ï¼Œè¿›è¡ŒåŠ 1æ“ä½œä¹‹åŽï¼Œiçš„å€¼ä¸º1ï¼Œç„¶åŽçº¿ç¨‹2æŠŠiçš„å€¼å†™å…¥å†…å­˜ã€‚ æœ€ç»ˆç»“æžœiçš„å€¼æ˜¯1ï¼Œè€Œä¸æ˜¯2ã€‚è¿™å°±æ˜¯è‘—åçš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚é€šå¸¸ç§°è¿™ç§è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®çš„å˜é‡ä¸ºå…±äº«å˜é‡ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æžœä¸€ä¸ªå˜é‡åœ¨å¤šä¸ªCPUä¸­éƒ½å­˜åœ¨ç¼“å­˜ï¼ˆä¸€èˆ¬åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶æ‰ä¼šå‡ºçŽ°ï¼‰ï¼Œé‚£ä¹ˆå°±å¯èƒ½å­˜åœ¨ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ ä¸ºäº†è§£å†³ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜ï¼Œé€šå¸¸æ¥è¯´æœ‰ä»¥ä¸‹2ç§è§£å†³æ–¹æ³•ï¼š 1ï¼‰é€šè¿‡åœ¨æ€»çº¿åŠ LOCK#é”çš„æ–¹å¼ 2ï¼‰é€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®® è¿™2ç§æ–¹å¼éƒ½æ˜¯ç¡¬ä»¶å±‚é¢ä¸Šæä¾›çš„æ–¹å¼ã€‚ åœ¨æ—©æœŸçš„CPUå½“ä¸­ï¼Œæ˜¯é€šè¿‡åœ¨æ€»çº¿ä¸ŠåŠ LOCK#é”çš„å½¢å¼æ¥è§£å†³ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚å› ä¸ºCPUå’Œå…¶ä»–éƒ¨ä»¶è¿›è¡Œé€šä¿¡éƒ½æ˜¯é€šè¿‡æ€»çº¿æ¥è¿›è¡Œçš„ï¼Œå¦‚æžœå¯¹æ€»çº¿åŠ LOCK#é”çš„è¯ï¼Œä¹Ÿå°±æ˜¯è¯´é˜»å¡žäº†å…¶ä»–CPUå¯¹å…¶ä»–éƒ¨ä»¶è®¿é—®ï¼ˆå¦‚å†…å­˜ï¼‰ï¼Œä»Žè€Œä½¿å¾—åªèƒ½æœ‰ä¸€ä¸ªCPUèƒ½ä½¿ç”¨è¿™ä¸ªå˜é‡çš„å†…å­˜ã€‚æ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­ å¦‚æžœä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œ i = i +1ï¼Œå¦‚æžœåœ¨æ‰§è¡Œè¿™æ®µä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨æ€»çº¿ä¸Šå‘å‡ºäº†LCOK#é”çš„ä¿¡å·ï¼Œé‚£ä¹ˆåªæœ‰ç­‰å¾…è¿™æ®µä»£ç å®Œå…¨æ‰§è¡Œå®Œæ¯•ä¹‹åŽï¼Œå…¶ä»–CPUæ‰èƒ½ä»Žå˜é‡iæ‰€åœ¨çš„å†…å­˜è¯»å–å˜é‡ï¼Œç„¶åŽè¿›è¡Œç›¸åº”çš„æ“ä½œã€‚è¿™æ ·å°±è§£å†³äº†ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ ä½†æ˜¯ä¸Šé¢çš„æ–¹å¼ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºŽåœ¨é”ä½æ€»çº¿æœŸé—´ï¼Œå…¶ä»–CPUæ— æ³•è®¿é—®å†…å­˜ï¼Œå¯¼è‡´æ•ˆçŽ‡ä½Žä¸‹ã€‚ æ‰€ä»¥å°±å‡ºçŽ°äº†ç¼“å­˜ä¸€è‡´æ€§åè®®ã€‚æœ€å‡ºåçš„å°±æ˜¯Intel çš„MESIåè®®ï¼ŒMESIåè®®ä¿è¯äº†æ¯ä¸ªç¼“å­˜ä¸­ä½¿ç”¨çš„å…±äº«å˜é‡çš„å‰¯æœ¬æ˜¯ä¸€è‡´çš„ã€‚å®ƒæ ¸å¿ƒçš„æ€æƒ³æ˜¯ï¼šå½“CPUå†™æ•°æ®æ—¶ï¼Œå¦‚æžœå‘çŽ°æ“ä½œçš„å˜é‡æ˜¯å…±äº«å˜é‡ï¼Œå³åœ¨å…¶ä»–CPUä¸­ä¹Ÿå­˜åœ¨è¯¥å˜é‡çš„å‰¯æœ¬ï¼Œä¼šå‘å‡ºä¿¡å·é€šçŸ¥å…¶ä»–CPUå°†è¯¥å˜é‡çš„ç¼“å­˜è¡Œç½®ä¸ºæ— æ•ˆçŠ¶æ€ï¼Œå› æ­¤å½“å…¶ä»–CPUéœ€è¦è¯»å–è¿™ä¸ªå˜é‡æ—¶ï¼Œå‘çŽ°è‡ªå·±ç¼“å­˜ä¸­ç¼“å­˜è¯¥å˜é‡çš„ç¼“å­˜è¡Œæ˜¯æ— æ•ˆçš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šä»Žå†…å­˜é‡æ–°è¯»å–ã€‚ ä»€ä¹ˆæ˜¯Java å†…å­˜æ¨¡åž‹åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­è¯•å›¾å®šä¹‰ä¸€ç§Javaå†…å­˜æ¨¡åž‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰æ¥å±è”½å„ä¸ªç¡¬ä»¶å¹³å°å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®žçŽ°è®©Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæžœã€‚é‚£ä¹ˆJavaå†…å­˜æ¨¡åž‹è§„å®šäº†å“ªäº›ä¸œè¥¿å‘¢ï¼Œå®ƒå®šä¹‰äº†ç¨‹åºä¸­å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œå¾€å¤§ä¸€ç‚¹è¯´æ˜¯å®šä¹‰äº†ç¨‹åºæ‰§è¡Œçš„æ¬¡åºã€‚æ³¨æ„ï¼Œä¸ºäº†èŽ·å¾—è¾ƒå¥½çš„æ‰§è¡Œæ€§èƒ½ï¼ŒJavaå†…å­˜æ¨¡åž‹å¹¶æ²¡æœ‰é™åˆ¶æ‰§è¡Œå¼•æ“Žä½¿ç”¨å¤„ç†å™¨çš„å¯„å­˜å™¨æˆ–è€…é«˜é€Ÿç¼“å­˜æ¥æå‡æŒ‡ä»¤æ‰§è¡Œé€Ÿåº¦ï¼Œä¹Ÿæ²¡æœ‰é™åˆ¶ç¼–è¯‘å™¨å¯¹æŒ‡ä»¤è¿›è¡Œé‡æŽ’åºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨javaå†…å­˜æ¨¡åž‹ä¸­ï¼Œä¹Ÿä¼šå­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜å’ŒæŒ‡ä»¤é‡æŽ’åºçš„é—®é¢˜ã€‚ Javaå†…å­˜æ¨¡åž‹è§„å®šæ‰€æœ‰çš„å˜é‡éƒ½æ˜¯å­˜åœ¨ä¸»å­˜å½“ä¸­ï¼ˆç±»ä¼¼äºŽå‰é¢è¯´çš„ç‰©ç†å†…å­˜ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼ˆç±»ä¼¼äºŽå‰é¢çš„é«˜é€Ÿç¼“å­˜ï¼‰ã€‚çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æŽ¥å¯¹ä¸»å­˜è¿›è¡Œæ“ä½œã€‚å¹¶ä¸”æ¯ä¸ªçº¿ç¨‹ä¸èƒ½è®¿é—®å…¶ä»–çº¿ç¨‹çš„å·¥ä½œå†…å­˜ã€‚ å¤šçº¿ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„é—®é¢˜å†…å­˜ä¸å¯è§12345678//çº¿ç¨‹1boolean stop = false;while(!stop)&#123; doSomething();&#125; //çº¿ç¨‹2stop = true; çº¿ç¨‹2é€šè¿‡stop = true å°è¯•åœæ­¢çº¿ç¨‹1ï¼Œçº¿ç¨‹1ä¸€å®šä¼šä¸­æ–­å—ï¼Ÿä¸ä¸€å®š å› ä¸ºä¸Šæ–‡è¯´è¿‡äº†ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹1è¿è¡Œæ—¶ï¼Œåœ¨å°†stopå˜é‡æ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­ã€‚çº¿ç¨‹2è¿™æ—¶å€™ä¿®æ”¹äº†stopï¼Œç„¶åŽæ²¡æ¥å¾—åŠåŒæ­¥åˆ°ä¸»å­˜ï¼Œè¿™æ—¶å€™çº¿ç¨‹2åŽ»åšåˆ«çš„å·¥ä½œäº†ï¼Œçº¿ç¨‹1ä¸çŸ¥é“çº¿ç¨‹2ä¿®æ”¹äº†å˜é‡ï¼Œä¸€ç›´å¾ªçŽ¯ä¸‹åŽ»ã€‚ é‡æŽ’åº ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æŽ’åºï¼Ÿ ä¸€èˆ¬æ¥è¯´ï¼Œå¤„ç†å™¨ä¸ºäº†æé«˜ç¨‹åºè¿è¡Œæ•ˆçŽ‡ï¼Œå¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥çš„æ‰§è¡Œå…ˆåŽé¡ºåºåŒä»£ç ä¸­çš„é¡ºåºä¸€è‡´ï¼Œä½†æ˜¯å®ƒä¼šä¿è¯ç¨‹åºæœ€ç»ˆæ‰§è¡Œç»“æžœå’Œä»£ç é¡ºåºæ‰§è¡Œçš„ç»“æžœæ˜¯ä¸€è‡´çš„ã€‚ ä¾‹å¦‚ä¸‹é¢ä»£ç 1234int a = 10; //è¯­å¥1int r = 2; //è¯­å¥2a = a + 3; //è¯­å¥3r = a*a; //è¯­å¥4 å¯èƒ½çš„é¡ºåº ä½†æ˜¯ç»ä¸å¯èƒ½å‡ºçŽ° è¯­å¥2 -&gt; è¯­å¥1 -&gt; è¯­å¥4 -&gt; è¯­å¥3 ä¸Šè¿°é¡ºåºæ”¹å˜æ•°æ®ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¤„ç†å™¨ä¼šè€ƒè™‘è¯­å¥ä¹‹é—´çš„ä¾èµ–å…³ç³» é‡æŽ’åºé€ æˆçš„å½±å“ 123456789//çº¿ç¨‹1:context = loadContext(); //è¯­å¥1inited = true; //è¯­å¥2 //çº¿ç¨‹2:while(!inited )&#123; sleep()&#125;doSomethingwithconfig(context); çº¿ç¨‹1çš„ä»£ç æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¦‚æžœé¡ºåºå˜ä¸ºäº† è¯­å¥2 -&gt; è¯­å¥1ï¼Œçº¿ç¨‹2å¯èƒ½å°±ä¼šæ‹¿åˆ°ä¸€ä¸ªæ²¡æœ‰åˆå§‹åŒ–çš„ contextå¯¹è±¡ä»Žè€Œå¯¼è‡´ç¨‹åºå¼‚å¸¸ï¼Œè€Œè¿™ç§å¼‚å¸¸æ˜¯å¾ˆéš¾æŽ’æŸ¥çš„ volatileä½œç”¨volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªå˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”ŸäºŽåŽé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œ ä¸€æ—¦ä¸€ä¸ªå…±äº«å˜é‡ï¼ˆç±»çš„æˆå‘˜å˜é‡ã€ç±»çš„é™æ€æˆå‘˜å˜é‡ï¼‰è¢«volatileä¿®é¥°ä¹‹åŽï¼Œé‚£ä¹ˆå°±å…·å¤‡äº†ä¸¤å±‚è¯­ä¹‰ï¼š 1ï¼‰ä¿è¯äº†ä¸åŒçº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œè¿™æ–°å€¼å¯¹å…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯ç«‹å³å¯è§çš„ã€‚ 2ï¼‰ç¦æ­¢è¿›è¡ŒæŒ‡ä»¤é‡æŽ’åºã€‚ 1. å†…å­˜å¯è§æ€§å˜é‡ä½¿ç”¨äº†volatileä¹‹åŽï¼Œæ‰€æœ‰è¯»å–æ“ä½œå…¨éƒ¨å‘ç”Ÿåœ¨ä¸»å­˜ä¸­ï¼Œä¹Ÿå°±é¿å…äº†ä¸Šè¿°çš„å†…å­˜ä¸å¯è§çš„é—®é¢˜äº† 2. é˜²æ­¢é‡æŽ’åºvolatileå…³é”®å­—ç¦æ­¢æŒ‡ä»¤é‡æŽ’åºæœ‰ä¸¤å±‚æ„æ€ï¼š 1ï¼‰å½“ç¨‹åºæ‰§è¡Œåˆ°volatileå˜é‡çš„è¯»æ“ä½œæˆ–è€…å†™æ“ä½œæ—¶ï¼Œåœ¨å…¶å‰é¢çš„æ“ä½œçš„æ›´æ”¹è‚¯å®šå…¨éƒ¨å·²ç»è¿›è¡Œï¼Œä¸”ç»“æžœå·²ç»å¯¹åŽé¢çš„æ“ä½œå¯è§ï¼›åœ¨å…¶åŽé¢çš„æ“ä½œè‚¯å®šè¿˜æ²¡æœ‰è¿›è¡Œï¼› 2ï¼‰åœ¨è¿›è¡ŒæŒ‡ä»¤ä¼˜åŒ–æ—¶ï¼Œä¸èƒ½å°†åœ¨å¯¹volatileå˜é‡è®¿é—®çš„è¯­å¥æ”¾åœ¨å…¶åŽé¢æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½æŠŠvolatileå˜é‡åŽé¢çš„è¯­å¥æ”¾åˆ°å…¶å‰é¢æ‰§è¡Œã€‚ volidate åº”ç”¨åœºæ™¯1.çŠ¶æ€æ ‡è®°123456789volatile boolean flag = false; while(!flag)&#123; doSomething();&#125; public void setFlag() &#123; flag = true;&#125; 12345678910volatile boolean inited = false;//çº¿ç¨‹1:context = loadContext(); inited = true; //çº¿ç¨‹2:while(!inited )&#123;sleep()&#125;doSomethingwithconfig(context); 2.åŒé‡æ£€æŸ¥é” ï¼ˆdouble checkï¼‰1234567891011121314151617class Singleton &#123; private volatile static Singleton instance = null; private Singleton() &#123; &#125; public static Singleton getInstance() &#123; if(instance==null) &#123; synchronized (Singleton.class) &#123; if(instance==null) instance = new Singleton(); &#125; &#125; return instance; &#125;&#125; å…³äºŽåŒé‡æ£€æŸ¥é”volatile çš„ä¸¤ä¸ªä½œç”¨ å¯è§æ€§ é˜²æ­¢new Singleton()æ—¶é‡æŽ’åº åˆ›å»ºå¯¹è±¡å¯ä»¥ç®€å•åˆ†è§£ä¸ºä¸‰æ­¥ 1.åˆ†é…å†…å­˜ç©ºé—´ 2.åˆå§‹åŒ–å¯¹è±¡ 3.å°†å¯¹è±¡æŒ‡å‘åˆšåˆ†é…çš„å†…å­˜ç©ºé—´ å¤„ç†å™¨åœ¨ä¼˜åŒ–æ€§èƒ½æ—¶ï¼Œå¯èƒ½ä¼šå°†ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥è¿›è¡Œé‡æŽ’åºï¼Œè¿™æ ·ä¼šå¯¼è‡´ç¬¬äºŒä¸ªçº¿ç¨‹èŽ·å–åˆ°æœªåˆå§‹åŒ–å®Œæˆçš„å¯¹è±¡ï¼Œå¯¼è‡´ç¨‹åºå¼‚å¸¸ã€‚]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot å¹¶å‘ç™»å½•äººæ•°æŽ§åˆ¶]]></title>
    <url>%2Fpost%2F5f58dc01.html</url>
    <content type="text"><![CDATA[é€šå¸¸ç³»ç»Ÿéƒ½ä¼šé™åˆ¶åŒä¸€ä¸ªè´¦å·çš„ç™»å½•äººæ•°ï¼Œå¤šäººç™»å½•è¦ä¹ˆé™åˆ¶åŽè€…ç™»å½•ï¼Œè¦ä¹ˆè¸¢å‡ºå‰è€…ï¼ŒSpring Security æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œæœ¬æ–‡è®²è§£ä¸€ä¸‹åœ¨æ²¡æœ‰ä½¿ç”¨Securityçš„æ—¶å€™å¦‚ä½•æ‰‹åŠ¨å®žçŽ°è¿™ä¸ªåŠŸèƒ½ æœ¬æ–‡å€Ÿé‰´äº† https://jinnianshilongnian.iteye.com/blog/2039760, å¦‚æžœä½ æ˜¯ä½¿ç”¨ Shiro + Session çš„æ¨¡å¼ï¼ŒæŽ¨èé˜…è¯»æ­¤æ–‡ demo æŠ€æœ¯é€‰åž‹ SpringBoot JWT Filter Redis + Redisson JWTï¼ˆtokenï¼‰å­˜å‚¨åœ¨Redisä¸­ï¼Œç±»ä¼¼ JSessionId-Sessionçš„å…³ç³»ï¼Œç”¨æˆ·ç™»å½•åŽæ¯æ¬¡è¯·æ±‚åœ¨Headerä¸­æºå¸¦jwt å¦‚æžœä½ æ˜¯ä½¿ç”¨sessionçš„è¯ï¼Œä¹Ÿå®Œå…¨å¯ä»¥å€Ÿé‰´æœ¬æ–‡çš„æ€è·¯ï¼Œåªæ˜¯ä»£ç ä¸Šéœ€è¦åŠ äº›æ”¹åŠ¨ ä¸¤ç§å®žçŽ°æ€è·¯æ¯”è¾ƒæ—¶é—´æˆ³ç»´æŠ¤ä¸€ä¸ª username: jwtToken è¿™æ ·çš„ä¸€ä¸ª key-value åœ¨Reidsä¸­, Filteré€»è¾‘å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142public class CompareKickOutFilter extends KickOutFilter &#123; @Autowired private UserService userService; @Override public boolean isAccessAllowed(HttpServletRequest request, HttpServletResponse response) &#123; String token = request.getHeader("Authorization"); String username = JWTUtil.getUsername(token); String userKey = PREFIX + username; RBucket&lt;String&gt; bucket = redissonClient.getBucket(userKey); String redisToken = bucket.get(); if (token.equals(redisToken)) &#123; return true; &#125; else if (StringUtils.isBlank(redisToken)) &#123; bucket.set(token); &#125; else &#123; Long redisTokenUnixTime = JWTUtil.getClaim(redisToken, "createTime").asLong(); Long tokenUnixTime = JWTUtil.getClaim(token, "createTime").asLong(); // token &gt; redisToken åˆ™è¦†ç›– if (tokenUnixTime.compareTo(redisTokenUnixTime) &gt; 0) &#123; bucket.set(token); &#125; else &#123; // æ³¨é”€å½“å‰token userService.logout(token); sendJsonResponse(response, 4001, "æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"); return false; &#125; &#125; return true; &#125;&#125; é˜Ÿåˆ—è¸¢å‡º 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192public class QueueKickOutFilter extends KickOutFilter &#123; /** * è¸¢å‡ºä¹‹å‰ç™»å½•çš„/ä¹‹åŽç™»å½•çš„ç”¨æˆ· é»˜è®¤è¸¢å‡ºä¹‹å‰ç™»å½•çš„ç”¨æˆ· */ private boolean kickoutAfter = false; /** * åŒä¸€ä¸ªå¸å·æœ€å¤§ä¼šè¯æ•° é»˜è®¤1 */ private int maxSession = 1; public void setKickoutAfter(boolean kickoutAfter) &#123; this.kickoutAfter = kickoutAfter; &#125; public void setMaxSession(int maxSession) &#123; this.maxSession = maxSession; &#125; @Override public boolean isAccessAllowed(HttpServletRequest request, HttpServletResponse response) throws Exception &#123; String token = request.getHeader("Authorization"); UserBO currentSession = CurrentUser.get(); Assert.notNull(currentSession, "currentSession cannot null"); String username = currentSession.getUsername(); String userKey = PREFIX + "deque_" + username; String lockKey = PREFIX_LOCK + username; RLock lock = redissonClient.getLock(lockKey); lock.lock(2, TimeUnit.SECONDS); try &#123; RDeque&lt;String&gt; deque = redissonClient.getDeque(userKey); // å¦‚æžœé˜Ÿåˆ—é‡Œæ²¡æœ‰æ­¤tokenï¼Œä¸”ç”¨æˆ·æ²¡æœ‰è¢«è¸¢å‡ºï¼›æ”¾å…¥é˜Ÿåˆ— if (!deque.contains(token) &amp;&amp; currentSession.isKickout() == false) &#123; deque.push(token); &#125; // å¦‚æžœé˜Ÿåˆ—é‡Œçš„sessionIdæ•°è¶…å‡ºæœ€å¤§ä¼šè¯æ•°ï¼Œå¼€å§‹è¸¢äºº while (deque.size() &gt; maxSession) &#123; String kickoutSessionId; if (kickoutAfter) &#123; // å¦‚æžœè¸¢å‡ºåŽè€… kickoutSessionId = deque.removeFirst(); &#125; else &#123; // å¦åˆ™è¸¢å‡ºå‰è€… kickoutSessionId = deque.removeLast(); &#125; try &#123; RBucket&lt;UserBO&gt; bucket = redissonClient.getBucket(kickoutSessionId); UserBO kickoutSession = bucket.get(); if (kickoutSession != null) &#123; // è®¾ç½®ä¼šè¯çš„kickoutå±žæ€§è¡¨ç¤ºè¸¢å‡ºäº† kickoutSession.setKickout(true); bucket.set(kickoutSession); &#125; &#125; catch (Exception e) &#123; &#125; &#125; // å¦‚æžœè¢«è¸¢å‡ºäº†ï¼Œç›´æŽ¥é€€å‡ºï¼Œé‡å®šå‘åˆ°è¸¢å‡ºåŽçš„åœ°å€ if (currentSession.isKickout()) &#123; // ä¼šè¯è¢«è¸¢å‡ºäº† try &#123; // æ³¨é”€ userService.logout(token); sendJsonResponse(response, 4001, "æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"); &#125; catch (Exception e) &#123; &#125; return false; &#125; &#125; finally &#123; if (lock.isHeldByCurrentThread()) &#123; lock.unlock(); LOGGER.info(Thread.currentThread().getName() + " unlock"); &#125; else &#123; LOGGER.info(Thread.currentThread().getName() + " already automatically release lock"); &#125; &#125; return true; &#125;&#125; æ¯”è¾ƒä¸¤ç§æ–¹æ³• ç¬¬ä¸€ç§æ–¹æ³•é€»è¾‘ç®€å•ç²—æš´, åªç»´æŠ¤ä¸€ä¸ªkey-value ä¸éœ€è¦ä½¿ç”¨é”ï¼Œéžè¦è¯´ç¼ºç‚¹çš„è¯æ²¡æœ‰ç¬¬äºŒç§æ–¹æ³•çµæ´»ã€‚ ç¬¬äºŒç§æ–¹æ³•æˆ‘å¾ˆå–œæ¬¢ï¼Œä»£ç å¾ˆä¼˜é›…çµæ´»ï¼Œä½†æ˜¯é€»è¾‘ç›¸å¯¹éº»çƒ¦ä¸€äº›ï¼Œè€Œä¸”ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨åœ°æ“ä½œé˜Ÿåˆ—ï¼Œè¦ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚ç›®å‰æˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹æ³• æ¼”ç¤ºä¸‹è½½åœ°å€: https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/login-control è¿è¡Œé¡¹ç›®ï¼Œè®¿é—®localhost:8887 demoä¸­æ²¡æœ‰å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œéšæ„è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œç”¨æˆ·åç›¸åŒåˆ™è¢«è¸¢å‡º è®¿é—® localhost:8887/index.html å¼¹å‡ºç”¨æˆ·ä¿¡æ¯, ä»£è¡¨å½“å‰ç”¨æˆ·æœ‰æ•ˆ å¦ä¸€ä¸ªæµè§ˆå™¨ç™»å½•ç›¸åŒç”¨æˆ·åï¼Œå›žåˆ°ç¬¬ä¸€ä¸ªæµè§ˆå™¨åˆ·æ–°é¡µé¢ï¼Œæç¤ºè¢«è¸¢å‡º application.propertiesä¸­é€‰æ‹©å¼€å¯å“ªç§è¿‡æ»¤å™¨æ¨¡å¼ï¼Œé»˜è®¤æ˜¯æ¯”è¾ƒæ—¶é—´æˆ³è¸¢å‡ºï¼Œå¼€å¯é˜Ÿåˆ—è¸¢å‡º queue-filter.enabled=true]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>Redis</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaç†è§£ç”Ÿäº§è€…-æ¶ˆè´¹è€…è®¾è®¡æ¨¡å¼]]></title>
    <url>%2Fpost%2F5b860a98.html</url>
    <content type="text"><![CDATA[åœ¨å®žé™…çš„è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°å¦‚ä¸‹åœºæ™¯ï¼šæŸä¸ªæ¨¡å—è´Ÿè´£äº§ç”Ÿæ•°æ®ï¼Œè¿™äº›æ•°æ®ç”±å¦ä¸€ä¸ªæ¨¡å—æ¥è´Ÿè´£å¤„ç†ï¼ˆæ­¤å¤„çš„æ¨¡å—æ˜¯å¹¿ä¹‰çš„ï¼Œå¯ä»¥æ˜¯ç±»ã€å‡½æ•°ã€çº¿ç¨‹ã€è¿›ç¨‹ç­‰ï¼‰ã€‚äº§ç”Ÿæ•°æ®çš„æ¨¡å—ï¼Œå°±å½¢è±¡åœ°ç§°ä¸ºç”Ÿäº§è€…ï¼›è€Œå¤„ç†æ•°æ®çš„æ¨¡å—ï¼Œå°±ç§°ä¸ºæ¶ˆè´¹è€…ï¼› ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´é€šè¿‡ç¼“å†²åŒº(é€šå¸¸æ˜¯ä¸€ä¸ªé˜»å¡žé˜Ÿåˆ—)å®žçŽ°é€šè®¯, ç”Ÿäº§è€…å°†äº§ç”Ÿçš„æ•°æ®æ”¾å…¥ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…ä»Žç¼“å†²åŒºä¸­èŽ·å–æ•°æ®ã€‚ ä¸¾ä¸ªæ —å­åŽ»é£Ÿå ‚åƒé¥­ï¼Œé£Ÿå ‚çš„å”å”é˜¿å§¨ä¼šå…ˆå°†é¥­åšå¥½ï¼Œæ”¾åˆ°é£Ÿå ‚çª—å£ï¼ŒåŒå­¦ä»¬ä¼šåŽ»é£Ÿå ‚æ‰“é¥­ã€‚ ç”Ÿäº§è€…(é£Ÿå ‚çš„å”å”é˜¿å§¨) -&gt; ç”Ÿäº§æ•°æ®(åšé¥­) -&gt; ç¼“å†²åŒº(é£Ÿå ‚çª—å£) -&gt; æ¶ˆè´¹æ•°æ®(æ‰“é¥­) -&gt; æ¶ˆè´¹è€…(åŒå­¦) ç”Ÿäº§è€…æ¶ˆè´¹è€…å®žçŽ°æ€è·¯ ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä»»åŠ¡å¾ˆæ˜Žç¡®ï¼Œç”Ÿäº§è€…åªç®¡ç”Ÿäº§æ•°æ®ï¼Œç„¶åŽæ·»åŠ åˆ°ç¼“å†²é˜Ÿåˆ—ã€‚è€Œæ¶ˆè´¹è€…åªç®¡ä»Žç¼“å†²é˜Ÿåˆ—ä¸­èŽ·å–æ•°æ® å¯ä»¥è¯´ç”Ÿäº§è€…æ¶ˆè´¹è€…éƒ½å¾ˆæ— è„‘ï¼Œè€Œç¼“å†²é˜Ÿåˆ—åˆ™è¦å¿™ä¸€äº›ï¼Œä»–èµ·åˆ°äº†ä¸€ä¸ªå¹³è¡¡ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä½œç”¨ã€‚ å¦‚æžœç”Ÿäº§è€…ç”Ÿäº§é€Ÿåº¦è¿‡å¿«ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹çš„å¾ˆæ…¢ï¼Œå¹¶ä¸”ç¼“å†²é˜Ÿåˆ—è¾¾åˆ°äº†æœ€å¤§é•¿åº¦æ—¶ã€‚ç¼“å†²é˜Ÿåˆ—ä¼šé˜»å¡žç”Ÿäº§è€…ï¼Œè®©ç”Ÿäº§è€…åœæ­¢ç”Ÿäº§ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ•°æ®åŽï¼Œå†å”¤é†’ç”Ÿäº§è€… åŒç†ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹é€Ÿåº¦è¿‡å¿«æ—¶ï¼Œé˜Ÿåˆ—ä¸ºç©ºæ—¶ã€‚ç¼“å†²é˜Ÿåˆ—åˆ™ä¼šé˜»å¡žæ¶ˆè´¹è€…ï¼Œå¾…ç”Ÿäº§è€…å‘é˜Ÿåˆ—æ·»åŠ æ•°æ®åŽï¼Œå†å”¤é†’æ¶ˆè´¹è€… å®žçŽ°é€šè¿‡ä¸Šè¿°çš„åˆ†æžåŽï¼Œæˆ‘ä»¬æ¥ç”¨æœ€åŸºæœ¬çš„Javaä»£ç å®žçŽ°ä¸€ä¸‹ æˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸‹Consumer å’ŒProducer ï¼Œä»–ä»¬çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬åªå¾ªçŽ¯åæ¬¡æ¨¡æ‹Ÿä¸€ä¸‹ç”Ÿäº§æ¶ˆè´¹çš„åœºæ™¯ã€‚Buffer ä¸ºç¼“å†²åŒºï¼Œæˆ‘ä»¬å¾…ä¼šå†çœ‹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/** * æ¶ˆè´¹è€… */class Consumer extends Thread &#123; private Buffer buffer; private int number; public Consumer(Buffer b, int number) &#123; buffer = b; this.number = number; &#125; public void run() &#123; int value; for (int i = 0; i &lt; 10; i++) &#123; // ä»Žç¼“å†²åŒºä¸­èŽ·å–æ•°æ® value = buffer.get(); try &#123; // æ¨¡æ‹Ÿæ¶ˆè´¹æ•°æ® sleep(1000); &#125; catch (InterruptedException e) &#123; &#125; System.out.println("æ¶ˆè´¹è€… #" + this.number + " got: " + value); &#125; &#125;&#125;/** * ç”Ÿäº§è€… */class Producer extends Thread &#123; private Buffer buffer; private int number; public Producer(Buffer b, int number) &#123; buffer = b; this.number = number; &#125; public void run() &#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; // æ¨¡æ‹Ÿç”Ÿäº§æ•°æ® sleep(500); &#125; catch (InterruptedException e) &#123; &#125; // å°†æ•°æ®æ”¾å…¥ç¼“å†²åŒº buffer.put(i); System.out.println("ç”Ÿäº§è€… #" + this.number + " put: " + i); &#125; &#125;&#125; å¯ä»¥çœ‹åˆ° Consumer å’ŒProducer æ²¡æœ‰ä»€ä¹ˆé€»è¾‘ï¼Œåªæ˜¯å¯¹ç¼“å†²åŒºçš„è¯»å†™æ“ä½œï¼Œä¸‹é¢æˆ‘ä»¬æ¥é‡ç‚¹çœ‹ä¸€ä¸‹ Bufferçš„å®žçŽ° 12345678910111213141516171819202122232425262728293031/** * ç¼“å†²åŒº */class Buffer &#123; private List&lt;Integer&gt; data = new ArrayList&lt;&gt;(); private static final int MAX = 10; private static final int MIN = 0; public synchronized int get() &#123; while (MIN == data.size()) &#123; try &#123; wait(); &#125; catch (InterruptedException e) &#123; &#125; &#125; Integer i = data.remove(0); notifyAll(); return i; &#125; public synchronized void put(int value) &#123; while (MAX == data.size()) &#123; try &#123; wait(); &#125; catch (InterruptedException e) &#123; &#125; &#125; data.add(value); notifyAll(); &#125;&#125; åˆ†æžput(): ç”Ÿäº§è€…å‘ç¼“å†²åŒºå†™å…¥æ•°æ®çš„æ“ä½œï¼Œå½“MAX == data.size()æ—¶ï¼Œå°±æ˜¯æˆ‘ä»¬åˆšåˆšæ‰€è¯´çš„ç”Ÿäº§è€…é€Ÿåº¦è¿‡å¿«ï¼Œæ¶ˆè´¹è€…é€Ÿåº¦è¿‡æ…¢çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™èº«ä¸º â€œç¼“å†²åŒºâ€ è¦å¹³è¡¡ä¸€ä¸‹ï¼Œè°ƒç”¨ Object.wait()ï¼Œè®©å½“å‰ç”Ÿäº§è€…çº¿ç¨‹è¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®åŽå°†å…¶å”¤é†’ å½“MAX &gt; data.size()æ—¶ï¼Œå‘ArrayListä¸­æ·»åŠ æ•°æ®ï¼Œå¹¶å°è¯•å”¤é†’æ­£åœ¨ç­‰å¾…çš„æ¶ˆè´¹è€…ï¼ˆè¿™ä¸€æ­¥æ˜¯å¿…é¡»çš„ï¼‰ get(): æ¶ˆè´¹è€…å‘ç¼“å†²åŒºè¯»æ•°æ®çš„æ“ä½œï¼Œå’Œä¸Šè¿°é€»è¾‘ç›¸åï¼Œå½“MIN == data.size()æ—¶ï¼Œè¿™æ—¶æ¶ˆè´¹è€…é€Ÿåº¦å¤ªå¿«ï¼Œç”Ÿäº§è€…å¤ªæ…¢ï¼Œé˜Ÿåˆ—ä¸­å·²ç»æ²¡æœ‰æ•°æ®äº†ã€‚â€ç¼“å†²åŒºâ€ å†ä¸€æ¬¡ç«™äº†å‡ºæ¥ï¼Œé€šè¿‡wait()ï¼Œè®©å½“å‰æ¶ˆè´¹è€…çº¿ç¨‹è¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œç­‰å¾…ç”Ÿäº§è€…ç”Ÿäº§æ•°æ®åŽå°†å…¶å”¤é†’ å½“MIN &lt; data.size()æ—¶ï¼Œå–å‡ºArrayListä¸­ç¬¬ä¸€æ¡æ•°æ®ï¼Œå¹¶å°è¯•å”¤é†’æ­£åœ¨ç­‰å¾…çš„ç”Ÿäº§è€… ä¸Šè¿°æ¡ˆä¾‹å®Œæ•´ä»£ç  ProducerConsumer.java ä¸Šè¿°ä½¿ç”¨æœ€åŸºæœ¬çš„Javaä»£ç å®žçŽ°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå®žé™…å¼€å‘ä¸­æˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨BlockingQueueã€ReentrantLockã€ThreadPoolExecutorè¿™äº›æ›´æˆç†Ÿçš„è½®å­ï¼Œä½†æ˜¯ä¸€é€šç™¾é€š å…³äºŽä¸Šè¿°æ¡ˆä¾‹çš„æ€è€ƒ ä¸ºä»€ä¹ˆç¼“å†²åŒºçš„åˆ¤æ–­æ¡ä»¶æ˜¯ while(condition) è€Œä¸æ˜¯ if(condition)ï¼Ÿç­”ï¼šé˜²æ­¢çº¿ç¨‹è¢«é”™è¯¯çš„å”¤é†’ä¸¾ä¾‹ï¼šå½“æœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹wait() æ—¶ï¼Œæ­¤æ—¶ç”Ÿäº§è€…åœ¨é˜Ÿåˆ—é‡Œæ”¾å…¥äº†ä¸€æ¡æ•°æ®ï¼Œå¹¶è°ƒç”¨notifyAll(), ä¸¤ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹è¢«å”¤é†’ï¼Œç¬¬ä¸€ä¸ªæ¶ˆè´¹è€…æˆåŠŸå–å‡ºé˜Ÿåˆ—ä¸­æ•°æ®ï¼Œè€Œç¬¬äºŒä¸ªæ¶ˆè´¹è€…æ­¤æ—¶å°±æ˜¯è¢«é”™è¯¯çš„å”¤é†’äº†ï¼Œç¨‹åºæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥æ­¤å¤„ä½¿ç”¨ while(condition)å¾ªçŽ¯æ£€æŸ¥ Javaä¸­è¦æ±‚wait()æ–¹æ³•ä¸ºä»€ä¹ˆè¦æ”¾åœ¨åŒæ­¥å—ä¸­ï¼Ÿç­”ï¼šé˜²æ­¢å‡ºçŽ°Lost Wake-Upä¸¾ä¾‹ï¼šå¦‚æžœé˜Ÿåˆ—æ²¡æœ‰åŒæ­¥é™åˆ¶ï¼Œæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…å¹¶å‘æ‰§è¡Œï¼Œå¾ˆå¯èƒ½å‡ºçŽ°è¿™ç§æƒ…å†µï¼Œæ¶ˆè´¹è€…è¿™æ—¶å€™æ£€æŸ¥äº†æ¡ä»¶æ­£å‡†å¤‡wait(),è¿™æ—¶å€™ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°äº†ç”Ÿäº§è€…ï¼Œç”Ÿäº§è€…å’”å’”ä¸€é¡¿æ“ä½œå‘é˜Ÿåˆ—ä¸­æ·»åŠ äº†æ•°æ®ï¼Œå¹¶å”¤é†’äº†æ¶ˆè´¹è€…ï¼Œè€Œæ­¤æ—¶æ¶ˆè´¹è€…å¹¶æ²¡æœ‰wait()ï¼Œè¿™ä¸ªé€šçŸ¥å°±ä¸¢æŽ‰äº†ï¼Œç„¶åŽæ¶ˆè´¹è€…wait() å°±è¿™æ ·ç¡åŽ»äº†â€¦ ä¸ºä»€ä¹ˆç¼“å†²åŒºä¸€å®šè¦ä½¿ç”¨é˜»å¡žé˜Ÿåˆ—å®žçŽ°ï¼ŸåŒç†å°±æ˜¯ä¸ºäº†é˜²æ­¢å‡ºçŽ°Lost Wake-Up ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼é¡ºåºæ‰§è¡Œä¸å°±å¯ä»¥äº†å—ï¼Ÿç”Ÿäº§è€…æ¶ˆè´¹è€…åˆ°åº•æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿ å¹¶å‘ ï¼ˆå¼‚æ­¥ï¼‰ç”Ÿäº§è€…ç›´æŽ¥è°ƒç”¨æ¶ˆè´¹è€…ï¼Œä¸¤è€…æ˜¯åŒæ­¥ï¼ˆé˜»å¡žï¼‰çš„ï¼Œå¦‚æžœæ¶ˆè´¹è€…åžåæ•°æ®å¾ˆæ…¢ï¼Œè¿™æ—¶å€™ç”Ÿäº§è€…ç™½ç™½æµªè´¹å¤§å¥½æ—¶å…‰ã€‚è€Œä½¿ç”¨è¿™ç§æ¨¡å¼ä¹‹åŽï¼Œç”Ÿäº§è€…å°†æ•°æ®ä¸¢åˆ°ç¼“å†²åŒºï¼Œç»§ç»­ç”Ÿäº§ï¼Œå®Œå…¨ä¸ä¾èµ–æ¶ˆè´¹è€…ï¼Œç¨‹åºæ‰§è¡Œæ•ˆçŽ‡ä¼šå¤§å¤§æé«˜ã€‚ è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¸ç›´æŽ¥ä¾èµ–ï¼Œé€šè¿‡ç¼“å†²åŒºé€šè®¯ï¼Œå°†ä¸¤ä¸ªç±»ä¹‹é—´çš„è€¦åˆåº¦é™åˆ°æœ€ä½Žã€‚ å‚è€ƒhttps://blog.csdn.net/u011109589/article/details/80519863]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Boot ä½¿ç”¨ AOP é˜²æ­¢é‡å¤æäº¤]]></title>
    <url>%2Fpost%2F8398a16a.html</url>
    <content type="text"><![CDATA[åœ¨ä¼ ç»Ÿçš„webé¡¹ç›®ä¸­ï¼Œé˜²æ­¢é‡å¤æäº¤ï¼Œé€šå¸¸åšæ³•æ˜¯ï¼šåŽç«¯ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æäº¤ä»¤ç‰Œï¼ˆuuidï¼‰ï¼Œå¹¶å­˜å‚¨åœ¨æœåŠ¡ç«¯ã€‚é¡µé¢æäº¤è¯·æ±‚æºå¸¦è¿™ä¸ªæäº¤ä»¤ç‰Œï¼ŒåŽç«¯éªŒè¯å¹¶åœ¨ç¬¬ä¸€æ¬¡éªŒè¯åŽåˆ é™¤è¯¥ä»¤ç‰Œï¼Œä¿è¯æäº¤è¯·æ±‚çš„å”¯ä¸€æ€§ã€‚ ä¸Šè¿°çš„æ€è·¯å…¶å®žæ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯éœ€è¦å‰åŽç«¯éƒ½ç¨åŠ æ”¹åŠ¨ï¼Œå¦‚æžœåœ¨ä¸šåŠ¡å¼€å‘å®Œåœ¨åŠ è¿™ä¸ªçš„è¯ï¼Œæ”¹åŠ¨é‡æœªå…æœ‰äº›å¤§äº†ï¼Œæœ¬èŠ‚çš„å®žçŽ°æ–¹æ¡ˆæ— éœ€å‰ç«¯é…åˆï¼Œçº¯åŽç«¯å¤„ç†ã€‚ æ€è·¯ è‡ªå®šä¹‰æ³¨è§£ @NoRepeatSubmit æ ‡è®°æ‰€æœ‰Controllerä¸­çš„æäº¤è¯·æ±‚ é€šè¿‡AOP å¯¹æ‰€æœ‰æ ‡è®°äº† @NoRepeatSubmit çš„æ–¹æ³•æ‹¦æˆª åœ¨ä¸šåŠ¡æ–¹æ³•æ‰§è¡Œå‰ï¼ŒèŽ·å–å½“å‰ç”¨æˆ·çš„ tokenï¼ˆæˆ–è€…JSessionIdï¼‰+ å½“å‰è¯·æ±‚åœ°å€ï¼Œä½œä¸ºä¸€ä¸ªå”¯ä¸€ KEYï¼ŒåŽ»èŽ·å– Redis åˆ†å¸ƒå¼é”ï¼ˆå¦‚æžœæ­¤æ—¶å¹¶å‘èŽ·å–ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šæˆåŠŸèŽ·å–é”ï¼‰ ä¸šåŠ¡æ–¹æ³•æ‰§è¡ŒåŽï¼Œé‡Šæ”¾é” å…³äºŽRedis åˆ†å¸ƒå¼é” ä¸äº†è§£çš„åŒå­¦æˆ³è¿™é‡Œ ==&gt; Redisåˆ†å¸ƒå¼é”çš„æ­£ç¡®å®žçŽ°æ–¹å¼ ä½¿ç”¨Redis æ˜¯ä¸ºäº†åœ¨è´Ÿè½½å‡è¡¡éƒ¨ç½²ï¼Œå¦‚æžœæ˜¯å•æœºçš„éƒ¨ç½²çš„é¡¹ç›®å¯ä»¥ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æœ¬åœ°Cache æ›¿ä»£ Redis Codeè¿™é‡Œåªè´´å‡º AOP ç±»å’Œæµ‹è¯•ç±»ï¼Œå®Œæ•´ä»£ç è§ ==&gt; Gitee12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061@Aspect@Componentpublic class RepeatSubmitAspect &#123; private final static Logger LOGGER = LoggerFactory.getLogger(RepeatSubmitAspect.class); @Autowired private RedisLock redisLock; @Pointcut("@annotation(noRepeatSubmit)") public void pointCut(NoRepeatSubmit noRepeatSubmit) &#123; &#125; @Around("pointCut(noRepeatSubmit)") public Object around(ProceedingJoinPoint pjp, NoRepeatSubmit noRepeatSubmit) throws Throwable &#123; int lockSeconds = noRepeatSubmit.lockTime(); HttpServletRequest request = RequestUtils.getRequest(); Assert.notNull(request, "request can not null"); // æ­¤å¤„å¯ä»¥ç”¨tokenæˆ–è€…JSessionId String token = request.getHeader("Authorization"); String path = request.getServletPath(); String key = getKey(token, path); String clientId = getClientId(); boolean isSuccess = redisLock.tryLock(key, clientId, lockSeconds); if (isSuccess) &#123; LOGGER.info("tryLock success, key = [&#123;&#125;], clientId = [&#123;&#125;]", key, clientId); // èŽ·å–é”æˆåŠŸ, æ‰§è¡Œè¿›ç¨‹ Object result; try &#123; result = pjp.proceed(); &#125; finally &#123; // è§£é” redisLock.releaseLock(key, clientId); LOGGER.info("releaseLock success, key = [&#123;&#125;], clientId = [&#123;&#125;]", key, clientId); &#125; return result; &#125; else &#123; // èŽ·å–é”å¤±è´¥ï¼Œè®¤ä¸ºæ˜¯é‡å¤æäº¤çš„è¯·æ±‚ LOGGER.info("tryLock fail, key = [&#123;&#125;]", key); return new ResultBean(ResultBean.FAIL, "é‡å¤è¯·æ±‚ï¼Œè¯·ç¨åŽå†è¯•", null); &#125; &#125; private String getKey(String token, String path) &#123; return token + path; &#125; private String getClientId() &#123; return UUID.randomUUID().toString(); &#125;&#125; å¤šçº¿ç¨‹æµ‹è¯•æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼Œæ¨¡æ‹Ÿåä¸ªè¯·æ±‚å¹¶å‘åŒæ—¶æäº¤1234567891011121314151617181920212223242526272829303132333435363738394041424344@Componentpublic class RunTest implements ApplicationRunner &#123; private static final Logger LOGGER = LoggerFactory.getLogger(RunTest.class); @Autowired private RestTemplate restTemplate; @Override public void run(ApplicationArguments args) throws Exception &#123; System.out.println("æ‰§è¡Œå¤šçº¿ç¨‹æµ‹è¯•"); String url="http://localhost:8000/submit"; CountDownLatch countDownLatch = new CountDownLatch(1); ExecutorService executorService = Executors.newFixedThreadPool(10); for(int i=0; i&lt;10; i++)&#123; String userId = "userId" + i; HttpEntity request = buildRequest(userId); executorService.submit(() -&gt; &#123; try &#123; countDownLatch.await(); System.out.println("Thread:"+Thread.currentThread().getName()+", time:"+System.currentTimeMillis()); ResponseEntity&lt;String&gt; response = restTemplate.postForEntity(url, request, String.class); System.out.println("Thread:"+Thread.currentThread().getName() + "," + response.getBody()); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;); &#125; countDownLatch.countDown(); &#125; private HttpEntity buildRequest(String userId) &#123; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); headers.set("Authorization", "yourToken"); Map&lt;String, Object&gt; body = new HashMap&lt;&gt;(); body.put("userId", userId); return new HttpEntity&lt;&gt;(body, headers); &#125;&#125; æˆåŠŸé˜²æ­¢é‡å¤æäº¤ï¼ŒæŽ§åˆ¶å°æ—¥å¿—å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°åä¸ªçº¿ç¨‹çš„å¯åŠ¨æ—¶é—´å‡ ä¹ŽåŒæ—¶å‘èµ·ï¼Œåªæœ‰ä¸€ä¸ªè¯·æ±‚æäº¤æˆåŠŸäº† æœ¬èŠ‚demoæˆ³è¿™é‡Œ ==&gt; Giteebuildé¡¹ç›®ä¹‹åŽï¼Œå¯åŠ¨æœ¬åœ°redisï¼Œè¿è¡Œé¡¹ç›®è‡ªåŠ¨æ‰§è¡Œæµ‹è¯•æ–¹æ³• å‚è€ƒhttps://www.jianshu.com/p/09c6b05b670a]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>SpringBoot</tag>
        <tag>AOP</tag>
        <tag>åˆ†å¸ƒå¼é”</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-å¹¶å‘æŽ§åˆ¶----è¯»é”ã€å†™é”ã€ä¹è§‚é”]]></title>
    <url>%2Fpost%2Fe708def4.html</url>
    <content type="text"><![CDATA[å¹¶å‘æ˜¯ä¸€ä¸ªè®©äººå¾ˆå¤´ç–¼çš„é—®é¢˜ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåœ¨æœåŠ¡ç«¯æˆ–è€…æ•°æ®åº“ç«¯åšå¤„ç†ï¼Œä¿è¯åœ¨å¹¶å‘ä¸‹æ•°æ®çš„å‡†ç¡®æ€§ï¼Œä»Šå¤©æˆ‘ä»¬ç®€è¦çš„è®¨è®ºä¸€ä¸‹MySQLä¸­å¦‚ä½•é€šè¿‡é”è§£å†³å¹¶å‘é—®é¢˜ è¯»é” ä¹Ÿå«å…±äº«é” ï¼ˆshared lockï¼‰ å¦‚ä½•ä½¿ç”¨SELECT * FROM table_name WHERE ... LOCK IN SHARE MODE è¯¦è§£å³äº‹åŠ¡A ä½¿ç”¨å…±äº«é” èŽ·å–äº†æŸæ¡ï¼ˆæˆ–è€…æŸäº›ï¼‰è®°å½•æ—¶ï¼Œäº‹åŠ¡B å¯ä»¥è¯»å–è¿™äº›è®°å½•ï¼Œå¯ä»¥ç»§ç»­æ·»åŠ å…±äº«é”ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹æˆ–åˆ é™¤è¿™äº›è®°å½•ï¼ˆå½“äº‹åŠ¡B å¯¹è¿™äº›æ•°æ®ä¿®æ”¹æˆ–åˆ é™¤æ—¶ä¼šè¿›å…¥é˜»å¡žçŠ¶æ€ï¼Œç›´è‡³é”ç­‰å¾…è¶…æ—¶æˆ–è€…äº‹åŠ¡Aæäº¤ï¼‰ ä½¿ç”¨åœºæ™¯è¯»å–ç»“æžœé›†çš„æœ€æ–°ç‰ˆæœ¬ï¼ŒåŒæ—¶é˜²æ­¢å…¶ä»–äº‹åŠ¡äº§ç”Ÿæ›´æ–°è¯¥ç»“æžœé›†ä¸»è¦ç”¨åœ¨éœ€è¦æ•°æ®ä¾å­˜å…³ç³»æ—¶ç¡®è®¤æŸè¡Œè®°å½•æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ç¡®ä¿æ²¡æœ‰äººå¯¹è¿™ä¸ªè®°å½•è¿›è¡ŒUPDATEæˆ–è€…DELETEæ“ä½œ æ³¨æ„äº‹é¡¹å½“ä½¿ç”¨è¯»é”æ—¶ï¼Œé¿å…äº§ç”Ÿå¦‚ä¸‹æ“ä½œ 123456äº‹åŠ¡1BEGIN;select * from sys_user where id = 1 LOCK IN SHARE MODE; (æ­¥éª¤1)update sys_user set username = &quot;taven&quot; where id = 1; (æ­¥éª¤3ï¼Œå‘ç”Ÿé˜»å¡ž)COMMIT; 123456äº‹åŠ¡2BEGIN;select * from sys_user where id = 1 LOCK IN SHARE MODE; (æ­¥éª¤2)update sys_user set username = &quot;taven&quot; where id = 1; (æ­¥éª¤4ï¼Œæ­»é”)COMMIT; åˆ†æžæ ¹æ®æˆ‘ä»¬ä¹‹å‰å¯¹è¯»é”å®šä¹‰å¯çŸ¥ï¼Œå½“æœ‰äº‹åŠ¡æ‹¿åˆ°ä¸€ä¸ªç»“æžœé›†çš„è¯»é”æ—¶ï¼Œå…¶ä»–äº‹åŠ¡æƒ³è¦æ›´æ–°è¯¥ç»“æžœé›†ï¼Œéœ€è¦æ‹¿åˆ°è¯»é”çš„äº‹åŠ¡æäº¤ï¼ˆé‡Šæ”¾é”ï¼‰ã€‚è€Œä¸Šè¿°æƒ…å†µä¸¤ä¸ªäº‹åŠ¡åˆ†åˆ«æ‹¿åˆ°äº†è¯»é”ï¼Œè€Œä¸”éƒ½æœ‰update æ“ä½œï¼Œä¸¤ä¸ªäº‹åŠ¡äº’ç›¸ç­‰å¾…é€ æˆæ­»é”ï¼ˆéƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾è¯»é”ï¼‰ å†™é” ä¹Ÿå«æŽ’å®ƒé”ï¼ˆexclusive lockï¼‰ å¦‚ä½•ä½¿ç”¨SELECT * FROM table_name WHERE ... FOR UPDATE è¯¦è§£ä¸€ä¸ªå†™é”ä¼šé˜»å¡žå…¶ä»–çš„è¯»é”å’Œå†™é”å³äº‹åŠ¡A å¯¹æŸäº›è®°å½•æ·»åŠ å†™é”æ—¶ï¼Œäº‹åŠ¡B æ— æ³•å‘è¿™äº›è®°å½•æ·»åŠ å†™é”æˆ–è€…è¯»é”ï¼ˆä¸æ·»åŠ é”çš„è¯»å–æ˜¯å¯ä»¥çš„ï¼‰ï¼Œäº‹åŠ¡B ä¹Ÿæ— æ³•æ‰§è¡Œå¯¹ é”ä½çš„æ•°æ® update delete ä½¿ç”¨åœºæ™¯è¯»å–ç»“æžœé›†çš„æœ€æ–°ç‰ˆæœ¬ï¼ŒåŒæ—¶é˜²æ­¢å…¶ä»–äº‹åŠ¡äº§ç”Ÿè¯»å–æˆ–è€…æ›´æ–°è¯¥ç»“æžœé›†ã€‚ä¾‹å¦‚ï¼šå¹¶å‘ä¸‹å¯¹å•†å“åº“å­˜çš„æ“ä½œ æ³¨æ„äº‹é¡¹åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½éœ€è¦æ³¨æ„ï¼Œè¯»é”ã€å†™é”å±žäºŽè¡Œçº§é”ã€‚å³äº‹åŠ¡1 å¯¹å•†å“A èŽ·å–å†™é”ï¼Œå’Œäº‹åŠ¡2 å¯¹å•†å“B èŽ·å–å†™é”äº’ç›¸ä¸ä¼šé˜»å¡žçš„ã€‚éœ€è¦æˆ‘ä»¬æ³¨æ„çš„æ˜¯æˆ‘ä»¬çš„SQLè¦åˆç†ä½¿ç”¨ç´¢å¼•ï¼Œå½“æˆ‘ä»¬çš„SQL å…¨è¡¨æ‰«æçš„æ—¶å€™ï¼Œè¡Œçº§é”ä¼šå˜æˆè¡¨é”ã€‚ä½¿ç”¨EXPLAINæŸ¥çœ‹ SQLæ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•ï¼Œæ‰«æäº†å¤šå°‘è¡Œ ä¹è§‚é” ä¸Šè¿°ä»‹ç»çš„æ˜¯è¡Œçº§é”ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦åœ°æ”¯æŒå¹¶å‘å¤„ç†ï¼ˆåŒæ—¶ä¹Ÿå¸¦æ¥äº†æœ€å¤§çš„é”å¼€é”€ï¼‰ä¹è§‚é”æ˜¯ä¸€ç§é€»è¾‘é”ï¼Œé€šè¿‡æ•°æ®çš„ç‰ˆæœ¬å·ï¼ˆvesionï¼‰çš„æœºåˆ¶æ¥å®žçŽ°ï¼Œæžå¤§é™ä½Žäº†æ•°æ®åº“çš„æ€§èƒ½å¼€é”€ã€‚ æˆ‘ä»¬ä¸ºè¡¨æ·»åŠ ä¸€ä¸ªå­—æ®µ versionï¼Œè¯»å–æ•°æ®æ—¶å°†æ­¤ç‰ˆæœ¬å·ä¸€åŒè¯»å‡ºï¼Œä¹‹åŽæ›´æ–°æ—¶ï¼Œå¯¹æ­¤ç‰ˆæœ¬å·+1ï¼ŒåŒæ—¶å°†æäº¤æ•°æ®çš„version ä¸Žæ•°æ®åº“ä¸­å¯¹åº”è®°å½•çš„å½“å‰version è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æžœæäº¤çš„æ•°æ®ç‰ˆæœ¬å·å¤§äºŽæ•°æ®åº“è¡¨å½“å‰ç‰ˆæœ¬å·ï¼Œåˆ™äºˆä»¥æ›´æ–°ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯è¿‡æœŸæ•°æ® 123update t_goods set status=2,version=version+1where id=#&#123;id&#125; and version &lt; #&#123;version&#125;; // æ›´æ–°å‰å°†versionè‡ªå¢ž æˆ–è€…123update t_goods set status=2,version=version+1where id=#&#123;id&#125; and version = #&#123;version&#125;; // æ›´æ–°å‰version ä¸è‡ªå¢ž]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>å¹¶å‘</tag>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-ç†è§£äº‹åŠ¡éš”ç¦»çº§åˆ«]]></title>
    <url>%2Fpost%2Feca98c0.html</url>
    <content type="text"><![CDATA[åœ¨SQLæ ‡å‡†ä¸­å®šä¹‰äº†å››ç§éš”ç¦»çº§åˆ«ï¼Œæ¯ä¸€ç§çº§åˆ«éƒ½è§„å®šäº†ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰€åšçš„ä¿®æ”¹ï¼Œå“ªäº›åœ¨äº‹åŠ¡å†…å’Œäº‹åŠ¡é—´æ˜¯å¯è§çš„ï¼Œå“ªäº›æ˜¯ä¸å¯è§ï¼Œè¾ƒä½Žçš„éš”ç¦»çº§åˆ«é€šå¸¸å¯ä»¥æ‰§è¡Œæ›´é«˜çš„å¹¶å‘ï¼Œç³»ç»Ÿçš„å¼€é”€ä¹Ÿæ›´ä½Ž äº‹åŠ¡çš„ACID åŽŸå­æ€§ï¼ˆatomicityï¼‰ä¸€ä¸ªäº‹åŠ¡å¿…é¡»è§†ä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æœ€å°å·¥ä½œå•å…ƒï¼Œæ•´ä¸ªäº‹åŠ¡çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æäº¤æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›žæ»š ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰æ•°æ®åº“æ€»æ˜¯ä»Žä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚ éš”ç¦»æ€§ï¼ˆisolationï¼‰é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰€ä½œçš„ä¿®æ”¹åœ¨æœ€ç»ˆæäº¤ä»¥å‰ï¼Œå¯¹å…¶ä»–äº‹åŠ¡æ˜¯ä¸å¯è§çš„ï¼Œåœ¨è®¨è®ºéš”ç¦»çº§åˆ«çš„æ—¶å€™ï¼Œä¼šç†è§£ä¸ºä»€ä¹ˆè¯´æ˜¯ â€œé€šå¸¸æ¥è¯´â€ æ˜¯ä¸å¯è§çš„ æŒä¹…æ€§ï¼ˆdurabilityï¼‰ä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œåˆ™æ‰€åšçš„ä¿®æ”¹å°±ä¼šæ°¸ä¹…çš„ä¿å­˜åˆ°æ•°æ®åº“ä¸­ éš”ç¦»çº§åˆ«1.READ UNCOMMITTED ï¼ˆæœªæäº¤è¯»ï¼‰ å³åœ¨è¯¥çº§åˆ«ï¼Œäº‹åŠ¡ä¸­çš„å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„ã€‚è¿™ç§æƒ…å†µè¢«ç§°ä¸ºè„è¯»ï¼ˆDirty Readï¼‰ï¼Œè¿™ä¸ªçº§åˆ«ä¼šå¯¼è‡´å¾ˆå¤šé—®é¢˜ï¼Œè€Œä¸”æ€§èƒ½ç›¸æ¯”å…¶ä»–çº§åˆ«ä¸ä¼šå¥½å¤ªå¤šï¼Œå®žé™…å¾ˆå°‘ä½¿ç”¨ã€‚ 2.READ COMMITTED ï¼ˆæäº¤è¯»ï¼‰ å¤§å¤šæ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆä½†MySQLä¸æ˜¯ï¼‰ï¼Œè¯¥çº§åˆ«è§£å†³äº†è„è¯»çš„é—®é¢˜ã€‚ä½†æ˜¯äº‹åŠ¡ä¸­ä¼šè¯»åˆ°å…¶ä»–äº‹åŠ¡å·²æäº¤çš„æ•°æ®ï¼Œæ— æ³•ä¿è¯è¯»ä¸€è‡´æ€§ï¼Œä¼šé€ æˆä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚å¦‚ä¸‹äº‹åŠ¡çš„ä¸¤æ¬¡è¯»å–æ˜¯ä¸ä¸€è‡´çš„ 3.REPEATABLE READ ï¼ˆå¯é‡å¤è¯»ï¼‰ è¯¥éš”ç¦»çº§åˆ«ï¼Œè§£å†³äº†è„è¯»ï¼Œä¸å¯é‡å¤è¯»ã€‚InnoDB ä½¿ç”¨ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ä¸‹æ–‡ä¼šè®²åˆ°ï¼‰ ä¿è¯äº†äº‹åŠ¡ä¸­çš„è¯»ä¸€è‡´æ€§ã€‚ä½†è¿˜æ˜¯ä¼šå‡ºçŽ°ä¸€ä¸ªå¹»è¯»çš„æƒ…å†µ å¦‚ä¸‹å›¾ï¼ˆå·¦ä¸ºäº‹åŠ¡Aï¼Œå³ä¸ºäº‹åŠ¡Bï¼‰äº‹åŠ¡æ‰§è¡Œè¿™æ ·çš„é€»è¾‘ï¼šæŸ¥æ‰¾æ˜¯å¦æœ‰æŸæ¡è®°å½•ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™æ–°å¢žã€‚ äº‹åŠ¡A æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ id=&quot;1&quot;è¿™æ¡æ•°æ®ï¼Œå‘çŽ°ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ‰§è¡Œinsert æ­¤æ—¶äº‹åŠ¡B insertäº†è¿™æ¡æ•°æ®ï¼Œå¹¶æäº¤äº†äº‹åŠ¡ã€‚ äº‹åŠ¡A æ‰§è¡Œinsert å‘ç”Ÿä¸»é”®å†²çªï¼Œå†æ¬¡æ‰§è¡Œäº† select * from where id = &quot;1&quot;ï¼Œå‘çŽ°ä¾æ—§ä¸å­˜åœ¨å½“å‰ç»“æžœé›† RR çº§åˆ«ä¸‹å¦‚ä½•é˜²æ­¢å¹»è¯»12# ç”¨ Xé”SELECT i` FROM `users` WHERE `id` = &quot;1&quot; FOR UPDATE; å¦‚æžœ id = 1 çš„è®°å½•å­˜åœ¨åˆ™ä¼šè¢«åŠ è¡Œï¼ˆXï¼‰é”ï¼Œå¦‚æžœä¸å­˜åœ¨ï¼Œåˆ™ä¼šåŠ  next-lock key / gap é”ï¼ˆèŒƒå›´è¡Œé”ï¼‰ï¼Œå³è®°å½•å­˜åœ¨ä¸Žå¦ï¼Œmysql éƒ½ä¼šå¯¹è®°å½•åº”è¯¥å¯¹åº”çš„ç´¢å¼•åŠ é”ï¼Œå…¶ä»–äº‹åŠ¡æ˜¯æ— æ³•å†èŽ·å¾—åšæ“ä½œçš„ã€‚ 4.SERIALIZABLE ï¼ˆä¸²è¡ŒåŒ–ï¼‰åœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¯»å–çš„æ¯ä¸€è¡Œéƒ½ä¼šè¢«æ·»åŠ é”ï¼ˆä¸ªäººç†è§£æ˜¯è¯»é”å’Œgapé”ï¼‰ï¼Œå¯¼è‡´å¤§é‡çš„è¶…æ—¶å’Œé”äº‰ç”¨é—®é¢˜ï¼Œå®žé™…åº”ç”¨ä¸­å¾ˆå°‘ä½¿ç”¨ï¼Œåªæœ‰åœ¨éžå¸¸éœ€è¦ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ä¸”å¯ä»¥æŽ¥å—æ²¡æœ‰å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæ‰è€ƒè™‘è¯¥çº§åˆ«ã€‚ åœ¨ SERIALIZABLE çº§åˆ«ä¸‹å†è¿è¡Œä¸€ä¸‹ ä¸Šè¿°çš„demo å¯ä»¥çœ‹åˆ°æ­¥éª¤2çš„ insert è¢«é˜»å¡žäº†ï¼Œä¸Šè¿°â€œå¹»è¯»â€çš„æƒ…å†µ MVCCMVCC æ˜¯ä»€ä¹ˆ MVVC (Multi-Version Concurrency Control, å¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶)ï¼Œåœ¨InnoDBå¼•æ“Žä¸‹ï¼ŒMVCCæ˜¯ä¸ºäº†å®žçŽ°äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œé€šè¿‡ç‰ˆæœ¬å·ï¼Œé¿å…åŒä¸€æ•°æ®åœ¨ä¸åŒäº‹åŠ¡é—´çš„ç«žäº‰ï¼Œä½ å¯ä»¥æŠŠå®ƒå½“æˆåŸºäºŽå¤šç‰ˆæœ¬å·çš„ä¸€ç§ä¹è§‚é”ï¼Œè¯»ä¸åŠ é”ï¼Œè¯»å†™ä¸å†²çªMVCC å®žçŽ°æœºåˆ¶ InnoDBåœ¨æ¯è¡Œæ•°æ®éƒ½å¢žåŠ ä¸¤ä¸ªéšè—å­—æ®µï¼Œä¸€ä¸ªè®°å½•åˆ›å»ºçš„ç‰ˆæœ¬å·ï¼Œä¸€ä¸ªè®°å½•åˆ é™¤çš„ç‰ˆæœ¬å·ã€‚ åœ¨MVVC ä¸­ï¼Œä¸ºäº†ä¿è¯æ•°æ®æ“ä½œåœ¨å¤šçº¿ç¨‹è¿‡ç¨‹ä¸­ï¼Œä¿è¯äº‹åŠ¡éš”ç¦»çš„æœºåˆ¶ï¼Œé™ä½Žé”ç«žäº‰çš„åŽ‹åŠ›ï¼Œä¿è¯è¾ƒé«˜çš„å¹¶å‘é‡ã€‚åœ¨æ¯å¼€å¯ä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªäº‹åŠ¡çš„ç‰ˆæœ¬å·ï¼Œè¢«æ“ä½œçš„æ•°æ®ä¼šç”Ÿæˆä¸€æ¡æ–°çš„æ•°æ®è¡Œï¼ˆä¸´æ—¶ï¼‰ï¼Œä½†æ˜¯åœ¨æäº¤å‰å¯¹å…¶ä»–äº‹åŠ¡æ˜¯ä¸å¯è§çš„ï¼Œå¯¹äºŽæ•°æ®çš„æ›´æ–°ï¼ˆåŒ…æ‹¬å¢žåˆ æ”¹ï¼‰æ“ä½œæˆåŠŸï¼Œä¼šå°†è¿™ä¸ªç‰ˆæœ¬å·æ›´æ–°åˆ°æ•°æ®çš„è¡Œä¸­ï¼Œäº‹åŠ¡æäº¤æˆåŠŸï¼Œå°†æ–°çš„ç‰ˆæœ¬å·æ›´æ–°åˆ°æ­¤æ•°æ®è¡Œä¸­ï¼Œè¿™æ ·ä¿è¯äº†æ¯ä¸ªäº‹åŠ¡æ“ä½œçš„æ•°æ®ï¼Œéƒ½æ˜¯äº’ä¸å½±å“çš„ï¼Œä¹Ÿä¸å­˜åœ¨é”çš„é—®é¢˜ã€‚ MVVCä¸‹çš„CRUD ï¼ˆREPEATABLE READä¸‹ï¼‰ SELECTï¼š InnoDB æŸ¥è¯¢çš„æ¯è¡Œæ•°æ®å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ç‚¹ 1ã€InnoDBå¿…é¡»æ‰¾åˆ°ä¸€ä¸ªè¡Œçš„ç‰ˆæœ¬ï¼Œå®ƒè‡³å°‘è¦å’Œäº‹åŠ¡çš„ç‰ˆæœ¬ä¸€æ ·è€(å³å®ƒçš„ç‰ˆæœ¬å·ä¸å¤§äºŽäº‹åŠ¡çš„ç‰ˆæœ¬å·)ã€‚è¿™ä¿è¯äº†ä¸ç®¡æ˜¯äº‹åŠ¡å¼€å§‹ä¹‹å‰ï¼Œæˆ–è€…äº‹åŠ¡åˆ›å»ºæ—¶ï¼Œæˆ–è€…ä¿®æ”¹äº†è¿™è¡Œæ•°æ®çš„æ—¶å€™ï¼Œè¿™è¡Œæ•°æ®æ˜¯å­˜åœ¨çš„ã€‚ 2ã€è¿™è¡Œæ•°æ®çš„åˆ é™¤ç‰ˆæœ¬å¿…é¡»æ˜¯æœªå®šä¹‰çš„æˆ–è€…æ¯”äº‹åŠ¡ç‰ˆæœ¬è¦å¤§ã€‚è¿™å¯ä»¥ä¿è¯åœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰è¿™è¡Œæ•°æ®æ²¡æœ‰è¢«åˆ é™¤ã€‚ç¬¦åˆè¿™ä¸¤ä¸ªæ¡ä»¶çš„è¡Œå¯èƒ½ä¼šè¢«å½“ä½œæŸ¥è¯¢ç»“æžœè€Œè¿”å›žã€‚ INSERTï¼š InnoDBä¸ºè¿™ä¸ªæ–°è¡Œè®°å½•å½“å‰çš„ç³»ç»Ÿç‰ˆæœ¬å·ã€‚ DELETEï¼š InnoDBå°†å½“å‰çš„ç³»ç»Ÿç‰ˆæœ¬å·è®¾ç½®ä¸ºè¿™ä¸€è¡Œçš„åˆ é™¤IDã€‚ UPDATEï¼š InnoDBä¼šå†™ä¸€ä¸ªè¿™è¡Œæ•°æ®çš„æ–°æ‹·è´ï¼Œè¿™ä¸ªæ‹·è´çš„ç‰ˆæœ¬ä¸ºå½“å‰çš„ç³»ç»Ÿç‰ˆæœ¬å·ã€‚å®ƒåŒæ—¶ä¹Ÿä¼šå°†è¿™ä¸ªç‰ˆæœ¬å·å†™åˆ°æ—§è¡Œçš„åˆ é™¤ç‰ˆæœ¬é‡Œã€‚ å‚è€ƒ MySQLä¹‹MVVCç®€ä»‹ mysql å¹»è¯»çš„è¯¦è§£ã€å®žä¾‹åŠè§£å†³åŠžæ³• ã€Šé«˜æ€§èƒ½MySQL ç¬¬ä¸‰ç‰ˆã€‹]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-10w+æ•°æ®-insert-ä¼˜åŒ–]]></title>
    <url>%2Fpost%2F5c987bd6.html</url>
    <content type="text"><![CDATA[ç”±äºŽä¸šåŠ¡åŽŸå› ï¼Œé‡åˆ°äº†å¦‚é¢˜æ‰€è¿°çš„ä¸šåŠ¡é—®é¢˜ï¼Œäº‹åŠ¡æ‰§è¡Œæ—¶é—´åœ¨30s~50s ä¸ç­‰ï¼Œæ•ˆæžœéžå¸¸ä¸ç†æƒ³ æ–¹æ¡ˆ1. jdbcæ‰¹å¤„ç†5w+ æ•°æ®æµ‹è¯•ï¼Œåˆ†åˆ«ä½¿ç”¨äº†mybatis insert()()ï¼ˆæ‹¼æŽ¥xmlï¼‰, mybatisçš„æ‰¹å¤„ç†å’Œ jdbcçš„æ‰¹å¤„ç†ã€‚å¯ä»¥çœ‹åˆ°åœ¨jdbcæ‰§è¡Œæ—¶é—´æ–¹é¢æ˜¯å·®ä¸å¤šçš„ï¼Œä½†æ˜¯åœ¨æ–¹æ³•æ‰§è¡Œæ—¶é—´ä¸Šï¼Œæ‰¹å¤„ç†è¦ç¨å¾®å¿«äº†ä¸€äº›ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸ç†æƒ³ æ–¹æ¡ˆ2. ä¼˜åŒ–MySQL å‚æ•°ä¿®æ”¹ my.ini innodb_buffer_pool_size : InnoDB, unlike MyISAM, uses a buffer pool to cache both indexes androw data. The bigger you set this the less disk I/O is needed toaccess data in tables. On a dedicated database server you may set thisparameter up to 80% of the machine physical memory size. Do not set ittoo large, though, because competition of the physical memory maycause paging in the operating system. Note that on 32bit systems youmight be limited to 2-3.5G of user level memory per process, so do notset it too high. Innodbçš„ç¼“å†²æ± ä¼šç¼“å­˜æ•°æ®å’Œç´¢å¼•ï¼Œè®¾ç½®çš„è¶Šå¤§è®¿é—®è¡¨ä¸­çš„æ•°æ®æ‰€éœ€çš„ç£ç›˜I/Oå°±è¶Šå°‘ã€‚ ä¿®æ”¹innodb_buffer_pool_size = 512Mæµ‹è¯•ä¸€ä¸‹æ•ˆçŽ‡ï¼Œè¿™é€Ÿåº¦ç®€ç›´æ„Ÿäººï¼ innodb_log_buffer_size : The size of the buffer InnoDB uses for buffering log data. As soon asit is full, InnoDB will have to flush it to disk. As it is flushed once per second anyway, it does not make sense to have it very large(even with long transactions). è¡¨ç¤ºInnoDBå†™å…¥åˆ°ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶æ—¶ä½¿ç”¨çš„ç¼“å†²åŒºçš„å­—èŠ‚æ•°ï¼Œé»˜è®¤å€¼ä¸º8Mã€‚å½“ç¼“å†²åŒºå……æ»¡æ—¶ï¼ŒInnoDBå°†åˆ·æ–°æ•°æ®åˆ°ç£ç›˜ã€‚ç”±äºŽå®ƒæ¯ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œæ‰€ä»¥å°†å®ƒè®¾ç½®å¾—éžå¸¸å¤§æ˜¯æ²¡æœ‰æ„ä¹‰çš„ (å³ä½¿æ˜¯é•¿äº‹åŠ¡)ã€‚ innodb_log_file_size : Size of each log file in a log group. You should set the combined sizeof log files to about 25%-100% of your buffer pool size to avoidunneeded buffer pool flush activity on log file overwrite. However,note that a larger logfile size will increase the time needed for therecovery process. è¯¥å€¼è¶Šå¤§ï¼Œç¼“å†²æ± ä¸­å¿…è¦çš„æ£€æŸ¥ç‚¹åˆ·æ–°æ´»åŠ¨å°±ä¼šè¶Šå°‘ï¼ŒèŠ‚çœç£ç›˜I/ Oã€‚ä½†æ˜¯è¶Šå¤§çš„æ—¥å¿—æ–‡ä»¶ï¼Œmysqlçš„å´©æºƒæ¢å¤å°±è¶Šæ…¢ è®¾ç½®ä¸Šè¿°ä¸¤ä¸ªå‚æ•°innodb_log_file_size=64M innodb_log_buffer_size=16Mï¼Œæ•ˆçŽ‡æå‡çš„å¹¶ä¸æ˜Žæ˜¾ã€‚ æ€»ç»“ æ•°æ®é‡å¤§æ—¶ï¼Œæ‰¹å¤„ç†åœ¨æ–¹æ³•æ‰§è¡Œæ—¶é—´ä¸Šè¦æ¯” mybatis xmlæ‹¼æŽ¥å¿«ä¸€ç‚¹ ï¼ˆæ‰¹å¤„ç†åªç¼–è¯‘ä¸€æ¡SQLï¼Œè€Œæ‹¼æŽ¥çš„æ–¹å¼SQLä¼šå¾ˆé•¿ï¼‰ æ€§èƒ½ç“¶é¢ˆä¼˜åŒ–è¿˜æ˜¯è¦ä»Žæ•°æ®åº“ä¸‹æ‰‹ï¼Œç›®å‰æ¥çœ‹MySQL å¤§æ•°æ®é‡æ—¶å¾ˆä¾èµ– innodb_buffer_pool_size ï¼ˆç¼“å†²æ± ï¼‰å‚è€ƒ https://my.oschina.net/realfighter/blog/368225]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>ä¼˜åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaæ‰“åŒ…æˆexe åœ¨æ²¡æœ‰JREçŽ¯å¢ƒçš„ç”µè„‘ä¸Šè¿è¡Œ]]></title>
    <url>%2Fpost%2F33eaa3e0.html</url>
    <content type="text"><![CDATA[å…¬å¸ä¸šåŠ¡éœ€æ±‚åŽŸå› ï¼Œéœ€è¦ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªæ¡Œé¢åº”ç”¨ç¨‹åºã€‚ç”±äºŽæ—¶é—´å…³ç³»ï¼Œæ²¡æœ‰è€ƒè™‘.netï¼Œä½¿ç”¨äº†æ±Ÿæ¹–ä¸Šå¤±ä¼ å·²ä¹…çš„Java Swing å‡†å¤‡å·¥ä½œ å°†ä½ çš„Javaé¡¹ç›®æ‰“åŒ…ä¸º å¯æ‰§è¡ŒJar ä½¿ç”¨ exe4j ç”Ÿæˆ.exe æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå°†ä½ çš„ JREï¼ˆä¸ŽJDKåŒçº§åˆ«çš„é‚£ä¸ªJREï¼‰ï¼Œå¯æ‰§è¡Œjar éƒ½å¤åˆ¶è¿‡æ¥ï¼Œä¸‹å›¾é™¤çº¢åœˆä»¥å¤–çš„Jar ä¸ºé¡¹ç›®çš„ä¾èµ–Jar åŒ… æ‰“å¼€ exe4j ï¼ŒNext é€‰æ‹© JAR IN EXE é€‰æ‹©åˆšåˆšæˆ‘ä»¬æ–°å»ºçš„æ–‡ä»¶å¤¹ ï¼ˆåŒ…å«JREï¼Œå’Œé¡¹ç›®å¯æ‰§è¡ŒJARï¼‰ è¿™é‡Œæ˜¯è®¾ç½®æ–‡ä»¶åï¼Œå›¾æ ‡ï¼Œæ˜¯å¦ä»…å…è®¸ä¸€ä¸ªåº”ç”¨å®žä¾‹ç­‰ç­‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ64ä½çš„ jdkæ˜¯éœ€è¦è®¾ç½®ä¸€ä¸‹çš„ï¼Œå¦‚å›¾ è¿™é‡Œæ˜¯å°†é¡¹ç›®çš„ï¼Œå¯æ‰§è¡ŒJARï¼Œè¿˜æœ‰ä¾èµ–JAR å…¨éƒ¨æ·»åŠ è¿›æ¥ï¼Œæ³¨æ„ä¸€å®šè¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ŒMain class from é€‰æ‹©ä¸€ä¸ªé¡¹ç›®çš„å¯åŠ¨ç±»ã€‚ è®¾ç½® Search sequence æ¸…é™¤é»˜è®¤é…ç½®ï¼Œè®¾ç½®JREï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„ åŽå‡ æ­¥é»˜è®¤é…ç½®ï¼Œä¸‹ä¸€æ­¥å³å¯ã€‚ å¤‡æ³¨ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJARå’ŒJRE ä¸€å®šè¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„æ— æ³•ä¿è¯ä½ çš„è·¯å¾„å’Œç”¨æˆ·ç”µè„‘ä¸€è‡´ï¼‰ exe4jï¼Œæ²¡æœ‰æ¿€æ´»ä¹‹å‰ç”Ÿæˆçš„exeï¼Œå¯åŠ¨ä¹‹å‰ä¼šè·³ä¸ªå¯¹è¯æ¡†ï¼Œæ¿€æ´»å³å¯ ç”Ÿæˆçš„exe ä¸ä¾èµ–ä¹‹å‰çš„JARï¼Œåªä¾èµ–JRE å‚è€ƒï¼šhttps://www.cnblogs.com/lsy-blogs/p/7668425.html]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>swing</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨Spring Cache + Redis ä½œä¸ºç¼“å­˜]]></title>
    <url>%2Fpost%2Fef257646.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ spring-cacheï¼Œä»¥åŠé›†æˆ Redis ä½œä¸ºç¼“å­˜å®žçŽ°ã€‚è¡¨æ ¼è¿‡é•¿ï¼ŒæŽ¨èè¯»è€…ä½¿ç”¨ç”µè„‘é˜…è¯» å‡†å¤‡å·¥ä½œRedis windows å®‰è£… å¦‚ä½•é…ç½®mavenå®Œæ•´ä¾èµ–è¯¦è§ ==&gt; Gitee123456789101112131415161718&lt;!-- ä½¿ç”¨spring cache --&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;&lt;/dependency&gt;&lt;!-- redis --&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;&lt;/dependency&gt;&lt;!-- ä¸ºäº†è§£å†³ ClassNotFoundException: org.apache.commons.poolimpl.GenericObjectPoolConfig --&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.commons&lt;/groupId&gt; &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt; &lt;version&gt;0&lt;/version&gt;&lt;/dependency&gt; application.properties1234567891011121314151617181920212223# Redisæ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰spring.redis.database=0 # RedisæœåŠ¡å™¨åœ°å€spring.redis.host=localhost# RedisæœåŠ¡å™¨è¿žæŽ¥ç«¯å£spring.redis.port=6379 # RedisæœåŠ¡å™¨è¿žæŽ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰#spring.redis.password=yourpwd# è¿žæŽ¥æ± æœ€å¤§è¿žæŽ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰spring.redis.lettuce.pool.max-active=8 # è¿žæŽ¥æ± æœ€å¤§é˜»å¡žç­‰å¾…æ—¶é—´ spring.redis.lettuce.pool.max-wait=-1ms# è¿žæŽ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿žæŽ¥spring.redis.lettuce.pool.max-idle=8 # è¿žæŽ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿žæŽ¥spring.redis.lettuce.pool.min-idle=0 # è¿žæŽ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰spring.redis.timeout=5000ms#é…ç½®ç¼“å­˜ç›¸å…³cache.default.expire-time=200cache.user.expire-time=180cache.user.name=test @EnableCachingæ ‡è®°æ³¨è§£ @EnableCachingï¼Œå¼€å¯ç¼“å­˜ï¼Œå¹¶é…ç½®Redisç¼“å­˜ç®¡ç†å™¨ï¼Œéœ€è¦åˆå§‹åŒ–ä¸€ä¸ªç¼“å­˜ç©ºé—´ã€‚åœ¨ç¼“å­˜çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦æ ‡è®°ä½¿ç”¨å“ªä¸€ä¸ªç¼“å­˜ç©ºé—´123456789101112131415161718192021222324252627282930313233343536373839404142434445@Configuration@EnableCachingpublic class RedisConfig &#123; @Value("$&#123;cache.default.expire-time&#125;") private int defaultExpireTime; @Value("$&#123;cache.user.expire-time&#125;") private int userCacheExpireTime; @Value("$&#123;cache.user.name&#125;") private String userCacheName; /** * ç¼“å­˜ç®¡ç†å™¨ * * @param lettuceConnectionFactory * @return */ @Bean public CacheManager cacheManager(RedisConnectionFactory lettuceConnectionFactory) &#123; RedisCacheConfiguration defaultCacheConfig = RedisCacheConfiguration.defaultCacheConfig(); // è®¾ç½®ç¼“å­˜ç®¡ç†å™¨ç®¡ç†çš„ç¼“å­˜çš„é»˜è®¤è¿‡æœŸæ—¶é—´ defaultCacheConfig = defaultCacheConfig.entryTtl(Duration.ofSeconds(defaultExpireTime)) // è®¾ç½® keyä¸ºstringåºåˆ—åŒ– .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer())) // è®¾ç½®valueä¸ºjsonåºåˆ—åŒ– .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer())) // ä¸ç¼“å­˜ç©ºå€¼ .disableCachingNullValues(); Set&lt;String&gt; cacheNames = new HashSet&lt;&gt;(); cacheNames.add(userCacheName); // å¯¹æ¯ä¸ªç¼“å­˜ç©ºé—´åº”ç”¨ä¸åŒçš„é…ç½® Map&lt;String, RedisCacheConfiguration&gt; configMap = new HashMap&lt;&gt;(); configMap.put(userCacheName, defaultCacheConfig.entryTtl(Duration.ofSeconds(userCacheExpireTime))); RedisCacheManager cacheManager = RedisCacheManager.builder(lettuceConnectionFactory) .cacheDefaults(defaultCacheConfig) .initialCacheNames(cacheNames) .withInitialCacheConfigurations(configMap) .build(); return cacheManager; &#125;&#125; åˆ°æ­¤é…ç½®å·¥ä½œå·²ç»ç»“æŸäº† Spring Cache ä½¿ç”¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748@Service@CacheConfig(cacheNames="user")// cacheName æ˜¯ä¸€å®šè¦æŒ‡å®šçš„å±žæ€§ï¼Œå¯ä»¥é€šè¿‡ @CacheConfig å£°æ˜Žè¯¥ç±»çš„é€šç”¨é…ç½®public class UserService &#123; /** * å°†ç»“æžœç¼“å­˜ï¼Œå½“å‚æ•°ç›¸åŒæ—¶ï¼Œä¸ä¼šæ‰§è¡Œæ–¹æ³•ï¼Œä»Žç¼“å­˜ä¸­å– * * @param id * @return */ @Cacheable(key = "#id") public User findUserById(Integer id) &#123; System.out.println("===&gt; findUserById(id), id = " + id); return new User(id, "taven"); &#125; /** * å°†ç»“æžœç¼“å­˜ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•ä¸ç®¡ç¼“å­˜æ˜¯å¦å­˜åœ¨ï¼Œæ¯æ¬¡éƒ½ä¼šæ‰§è¡Œ * * @param user * @return */ @CachePut(key = "#user.id") public User update(User user) &#123; System.out.println("===&gt; update(user), user = " + user); return user; &#125; /** * ç§»é™¤ç¼“å­˜ï¼Œæ ¹æ®æŒ‡å®škey * * @param user */ @CacheEvict(key = "#user.id") public void deleteById(User user) &#123; System.out.println("===&gt; deleteById(), user = " + user); &#125; /** * ç§»é™¤å½“å‰ cacheNameä¸‹æ‰€æœ‰ç¼“å­˜ * */ @CacheEvict(allEntries = true) public void deleteAll() &#123; System.out.println("===&gt; deleteAll()"); &#125;&#125; æ³¨è§£ ä½œç”¨ @Cacheable | å°†æ–¹æ³•çš„ç»“æžœç¼“å­˜èµ·æ¥ï¼Œä¸‹ä¸€æ¬¡æ–¹æ³•æ‰§è¡Œå‚æ•°ç›¸åŒæ—¶ï¼Œå°†ä¸æ‰§è¡Œæ–¹æ³•ï¼Œè¿”å›žç¼“å­˜ä¸­çš„ç»“æžœ@CacheEvict | ç§»é™¤æŒ‡å®šç¼“å­˜@CachePut | æ ‡è®°è¯¥æ³¨è§£çš„æ–¹æ³•æ€»ä¼šæ‰§è¡Œï¼Œæ ¹æ®æ³¨è§£çš„é…ç½®å°†ç»“æžœç¼“å­˜@Caching | å¯ä»¥æŒ‡å®šç›¸åŒç±»åž‹çš„å¤šä¸ªç¼“å­˜æ³¨è§£ï¼Œä¾‹å¦‚æ ¹æ®ä¸åŒçš„æ¡ä»¶@CacheConfig | ç±»çº§åˆ«æ³¨è§£ï¼Œå¯ä»¥è®¾ç½®ä¸€äº›å…±é€šçš„é…ç½®ï¼Œ@CacheConfig(cacheNames=&quot;user&quot;), ä»£è¡¨è¯¥ç±»ä¸‹çš„æ–¹æ³•å‡ä½¿ç”¨è¿™ä¸ªcacheNames ä¸‹é¢è¯¦ç»†è®²ä¸€ä¸‹æ¯ä¸ªæ³¨è§£çš„ä½œç”¨å’Œå¯é€‰é¡¹ã€‚ Spring Cache æ³¨è§£@EnableCaching åšäº†ä»€ä¹ˆ @EnableCaching æ³¨é‡Šè§¦å‘åŽç½®å¤„ç†å™¨, æ£€æŸ¥æ¯ä¸€ä¸ªSpring bean çš„ public æ–¹æ³•æ˜¯å¦å­˜åœ¨ç¼“å­˜æ³¨è§£ã€‚å¦‚æžœæ‰¾åˆ°è¿™æ ·çš„ä¸€ä¸ªæ³¨é‡Š, è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä»£ç†æ‹¦æˆªæ–¹æ³•è°ƒç”¨å’Œå¤„ç†ç›¸åº”çš„ç¼“å­˜è¡Œä¸ºã€‚ å¸¸ç”¨ç¼“å­˜æ³¨è§£ç®€è¿°@Cacheableå°†æ–¹æ³•çš„ç»“æžœç¼“å­˜ï¼Œå¿…é¡»è¦æŒ‡å®šä¸€ä¸ª cacheNameï¼ˆç¼“å­˜ç©ºé—´ï¼‰12@Cacheable(&quot;books&quot;)public Book findBook(ISBN isbn) &#123;...&#125; é»˜è®¤ cache keyç¼“å­˜çš„æœ¬è´¨è¿˜æ˜¯ä»¥ key-value çš„å½¢å¼å­˜å‚¨çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹æˆ‘ä»¬ä¸æŒ‡å®škeyçš„æ—¶å€™ ï¼Œä½¿ç”¨ SimpleKeyGenerator ä½œä¸ºkeyçš„ç”Ÿæˆç­–ç•¥ å¦‚æžœæ²¡æœ‰ç»™å‡ºå‚æ•°ï¼Œåˆ™è¿”å›žSimpleKey.EMPTYã€‚ å¦‚æžœåªç»™å‡ºä¸€ä¸ªParamï¼Œåˆ™è¿”å›žè¯¥å®žä¾‹ã€‚ å¦‚æžœç»™å‡ºäº†æ›´å¤šçš„Paramï¼Œåˆ™è¿”å›žåŒ…å«æ‰€æœ‰å‚æ•°çš„SimpleKeyã€‚ æ³¨æ„ï¼šå½“ä½¿ç”¨é»˜è®¤ç­–ç•¥æ—¶ï¼Œæˆ‘ä»¬çš„å‚æ•°éœ€è¦æœ‰ æœ‰æ•ˆçš„hashCode()å’Œequals()æ–¹æ³• è‡ªå®šä¹‰ cache key12345678@Cacheable(cacheNames=&quot;books&quot;, key=&quot;#isbn&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed)@Cacheable(cacheNames=&quot;books&quot;, key=&quot;#isbn.rawNumber&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed)@Cacheable(cacheNames=&quot;books&quot;, key=&quot;T(someType).hash(#isbn)&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed) å¦‚ä¸Šï¼Œé…åˆSpring EL ä½¿ç”¨ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç» Spring EL å¯¹ Cache çš„æ”¯æŒ æŒ‡å®šå¯¹è±¡ æŒ‡å®šå¯¹è±¡ä¸­çš„å±žæ€§ æŸä¸ªç±»çš„æŸä¸ªé™æ€æ–¹æ³• è‡ªå®šä¹‰ keyGenerator12@Cacheable(cacheNames=&quot;books&quot;, keyGenerator=&quot;myKeyGenerator&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed) å®žçŽ° KeyGeneratoræŽ¥å£å¯ä»¥è‡ªå®šä¹‰ cache key çš„ç”Ÿæˆç­–ç•¥ è‡ªå®šä¹‰ cacheManager12@Cacheable(cacheNames=&quot;books&quot;, cacheManager=&quot;anotherCacheManager&quot;) public Book findBook(ISBN isbn) &#123;...&#125; å½“æˆ‘ä»¬çš„é¡¹ç›®åŒ…å«å¤šä¸ªç¼“å­˜ç®¡ç†å™¨æ—¶ï¼Œå¯ä»¥æŒ‡å®šå…·ä½“çš„ç¼“å­˜ç®¡ç†å™¨ï¼Œä½œä¸ºç¼“å­˜è§£æž åŒæ­¥ç¼“å­˜åœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸­ï¼Œå¯èƒ½ä¼šå‡ºçŽ°ç›¸åŒçš„å‚æ•°çš„è¯·æ±‚å¹¶å‘è°ƒç”¨æ–¹æ³•çš„æ“ä½œï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œspring cache ä¸ä¼šé”å®šä»»ä½•ä¸œè¥¿ï¼Œç›¸åŒçš„å€¼å¯èƒ½ä¼šè¢«è®¡ç®—å‡ æ¬¡ï¼Œè¿™å°±è¿èƒŒäº†ç¼“å­˜çš„ç›®çš„ å¯¹äºŽè¿™äº›ç‰¹æ®Šæƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨syncå±žæ€§ã€‚æ­¤æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å¤„äºŽè®¡ç®—ï¼Œè€Œå…¶ä»–çº¿ç¨‹åˆ™è¢«é˜»å¡žï¼Œç›´åˆ°åœ¨ç¼“å­˜ä¸­æ›´æ–°æ¡ç›®ä¸ºæ­¢ã€‚12@Cacheable(cacheNames=&quot;foos&quot;, sync=true) public Foo executeExpensiveOperation(String id) &#123;...&#125; æ¡ä»¶ç¼“å­˜ condition: ä»€ä¹ˆæƒ…å†µç¼“å­˜ï¼Œcondition = true æ—¶ç¼“å­˜ï¼Œåä¹‹ä¸ç¼“å­˜ unless: ä»€ä¹ˆæƒ…å†µä¸ç¼“å­˜ï¼Œunless = true æ—¶ä¸ç¼“å­˜ï¼Œåä¹‹ç¼“å­˜12345@Cacheable(cacheNames=&quot;book&quot;, condition=&quot;#name.length() &lt; 32&quot;) public Book findBook(String name)@Cacheable(cacheNames=&quot;book&quot;, condition=&quot;#name.length() &lt; 32&quot;, unless=&quot;#result?.hardback&quot;)public Optional&lt;Book&gt; findBook(String name) Spring EL å¯¹ Cache çš„æ”¯æŒ Name Location Description Example methodName Root object è¢«è°ƒç”¨çš„æ–¹æ³•çš„åç§° #root.methodName method Root object è¢«è°ƒç”¨çš„æ–¹æ³• #root.method.name target Root object å½“å‰è°ƒç”¨æ–¹æ³•çš„å¯¹è±¡ #root.target targetClass Root object å½“å‰è°ƒç”¨æ–¹æ³•çš„ç±» #root.targetClass args Root object å½“å‰æ–¹æ³•çš„å‚æ•° #root.args[0] caches Root object å½“å‰æ–¹æ³•çš„ç¼“å­˜é›†åˆ #root.caches[0].name Argument name Evaluation context å½“å‰æ–¹æ³•çš„å‚æ•°åç§° #iban or #a0 (you can also use #p0 or #p&lt;#arg&gt; notation as an alias). result Evaluation context æ–¹æ³•è¿”å›žçš„ç»“æžœ(è¦ç¼“å­˜çš„å€¼)ã€‚åªæœ‰åœ¨ unless ã€@CachePut(ç”¨äºŽè®¡ç®—é”®)æˆ–@CacheEvict(beforeInvocation=false)ä¸­æ‰å¯ç”¨.å¯¹äºŽæ”¯æŒçš„åŒ…è£…å™¨(ä¾‹å¦‚Optional)ï¼Œ#resultå¼•ç”¨çš„æ˜¯å®žé™…å¯¹è±¡ï¼Œè€Œä¸æ˜¯åŒ…è£…å™¨ #result @CachePutè¿™ä¸ªæ³¨è§£å’Œ @Cacheable æœ‰ç‚¹ç±»ä¼¼ï¼Œéƒ½ä¼šå°†ç»“æžœç¼“å­˜ï¼Œä½†æ˜¯æ ‡è®° @CachePut çš„æ–¹æ³•æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œï¼Œç›®çš„åœ¨äºŽæ›´æ–°ç¼“å­˜ï¼Œæ‰€ä»¥ä¸¤ä¸ªæ³¨è§£çš„ä½¿ç”¨åœºæ™¯å®Œå…¨ä¸åŒã€‚@Cacheable æ”¯æŒçš„æ‰€æœ‰é…ç½®é€‰é¡¹ï¼ŒåŒæ ·é€‚ç”¨äºŽ@CachePut 12@CachePut(cacheNames=&quot;book&quot;, key=&quot;#isbn&quot;)public Book updateBook(ISBN isbn, BookDescriptor descriptor) éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸è¦åœ¨ä¸€ä¸ªæ–¹æ³•ä¸ŠåŒæ—¶ä½¿ç”¨@Cacheable å’Œ @CachePut @CacheEvictç”¨äºŽç§»é™¤ç¼“å­˜ å¯ä»¥ç§»é™¤æŒ‡å®škey å£°æ˜Ž allEntries=trueç§»é™¤è¯¥CacheNameä¸‹æ‰€æœ‰ç¼“å­˜ å£°æ˜ŽbeforeInvocation=true åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æ¸…é™¤ç¼“å­˜ï¼Œæ— è®ºæ–¹æ³•æ‰§è¡Œæ˜¯å¦æˆåŠŸ12345@CacheEvict(cacheNames=&quot;book&quot;, key=&quot;#isbn&quot;)public Book updateBook(ISBN isbn, BookDescriptor descriptor)@CacheEvict(cacheNames=&quot;books&quot;, allEntries=true) public void loadBooks(InputStream batch) @Cachingå¯ä»¥è®©ä½ åœ¨ä¸€ä¸ªæ–¹æ³•ä¸ŠåµŒå¥—å¤šä¸ªç›¸åŒçš„Cache æ³¨è§£ï¼ˆ@Cacheable, @CachePut, @CacheEvictï¼‰ï¼Œåˆ†åˆ«æŒ‡å®šä¸åŒçš„æ¡ä»¶12@Caching(evict = &#123; @CacheEvict(&quot;primary&quot;), @CacheEvict(cacheNames=&quot;secondary&quot;, key=&quot;#p0&quot;) &#125;)public Book importBooks(String deposit, Date date) @CacheConfigç±»çº§åˆ«æ³¨è§£ï¼Œç”¨äºŽé…ç½®ä¸€äº›å…±åŒçš„é€‰é¡¹ï¼ˆå½“æ–¹æ³•æ³¨è§£å£°æ˜Žçš„æ—¶å€™ä¼šè¢«è¦†ç›–ï¼‰ï¼Œä¾‹å¦‚ CacheNameã€‚ æ”¯æŒçš„é€‰é¡¹å¦‚ä¸‹ï¼š123456789101112@Target(&#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface CacheConfig &#123; String[] cacheNames() default &#123;&#125;; String keyGenerator() default &quot;&quot;; String cacheManager() default &quot;&quot;; String cacheResolver() default &quot;&quot;;&#125; å‚è€ƒï¼š https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#cache-annotations-cacheable https://spring.io/guides/gs/caching/ æœ¬æ–‡demoï¼š https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-redis]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>SpringBoot</tag>
        <tag>Cache</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ã€ŠShiro ä¸€ã€‹SpringBoot+Shiro æž„å»ºWebå·¥ç¨‹]]></title>
    <url>%2Fpost%2F9d0d6a3a.html</url>
    <content type="text"><![CDATA[Shiro ä¸€æ¬¾ç®€å•æ˜“ç”¨ï¼ŒåŠŸèƒ½å¼ºå¤§çš„å®‰å…¨æ¡†æž¶ï¼Œå¸®åŠ©æˆ‘ä»¬å®‰å…¨é«˜æ•ˆçš„æž„å»ºä¼ä¸šçº§åº”ç”¨ã€‚ä¹‹å‰å‡ ä¸ªé¡¹ç›®éƒ½ç”¨åˆ°è¿‡ Shiroï¼Œæœ€è¿‘æŠ½ç©ºæ¢³ç†äº†ä¸€ä¸‹ï¼Œåˆ†äº«ä¸€äº›ç»éªŒã€‚ æœ¬æ–‡demoï¼šæˆ³è¿™é‡Œæœ¬æ–‡demoé€‰åž‹ï¼šthymeleaf, springboot 2, shiro, ehcachePS:å¦‚æžœæˆ‘ä¸æ‹–å»¶çš„è¯ï¼Œä¼°è®¡è¿˜æ˜¯ä¼šæœ‰åŽç»­çš„ :ï¼‰ Shiro èƒ½åšä»€ä¹ˆ è®¤è¯ï¼šç™»å½•ç”¨æˆ·çš„è®¤è¯ æƒé™ï¼šåŸºäºŽè§’è‰²å’Œæƒé™çš„è®¿é—®æƒé™ï¼ˆurlæƒé™ï¼‰ï¼Œä»¥åŠé¢—ç²’åŒ–æƒé™æŽ§åˆ¶ï¼ˆæŒ‰é’®æƒé™ï¼‰ åŠ å¯†æŠ€æœ¯ï¼šShiroçš„cryptoåŒ…ä¸­åŒ…å«äº†ä¸€ç³»åˆ—çš„æ˜“äºŽç†è§£å’Œä½¿ç”¨çš„åŠ å¯†ã€å“ˆå¸Œï¼ˆakaæ‘˜è¦ï¼‰è¾…åŠ©ç±» sessionç®¡ç†ï¼šå¯åœ¨webå®¹å™¨ä»¥åŠ EJBå®¹å™¨ä¸­ä½¿ç”¨ sessionï¼Œå¯æ‰©å±• ï¼ˆä¾‹å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™ sessionDao å°† session å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼‰ RememberMeï¼šåŸºäºŽcookieçš„è®°ä½æˆ‘æœåŠ¡ Shiro å¸¸ç”¨ç»„ä»¶ä»‹ç» Subjectï¼šSubjectå…¶å®žä»£è¡¨çš„å°±æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œæ“ä½œçš„ç”¨æˆ·ï¼Œåªä¸è¿‡å› ä¸ºâ€œUserâ€ä¸€èˆ¬æŒ‡ä»£äººï¼Œä½†æ˜¯ä¸€ä¸ªâ€œSubjectâ€å¯ä»¥æ˜¯äººï¼Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•çš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼ŒæœåŠ¡è´¦å·ç­‰ä»»ä½•å…¶ä»–æ­£åœ¨å’Œå½“å‰ç³»ç»Ÿäº¤äº’çš„ç¬¬ä¸‰æ–¹è½¯ä»¶ç³»ç»Ÿã€‚ æ‰€æœ‰çš„Subjectå®žä¾‹éƒ½è¢«ç»‘å®šåˆ°ä¸€ä¸ªSecurityManagerï¼Œå¦‚æžœä½ å’Œä¸€ä¸ªSubjectäº¤äº’ï¼Œæ‰€æœ‰çš„äº¤äº’åŠ¨ä½œéƒ½ä¼šè¢«è½¬æ¢æˆSubjectä¸ŽSecurityManagerçš„äº¤äº’ SecurityManagerï¼šShiroçš„æ ¸å¿ƒï¼Œä»–ä¸»è¦ç”¨äºŽåè°ƒShiroå†…éƒ¨å„ç§å®‰å…¨ç»„ä»¶ï¼Œä¸è¿‡æˆ‘ä»¬ä¸€èˆ¬ä¸ç”¨å¤ªå…³å¿ƒSecurityManagerï¼Œå¯¹äºŽåº”ç”¨ç¨‹åºå¼€å‘è€…æ¥è¯´ï¼Œä¸»è¦è¿˜æ˜¯ä½¿ç”¨Subjectçš„APIæ¥å¤„ç†å„ç§å®‰å…¨éªŒè¯é€»è¾‘ Realmï¼šè¿™æ˜¯ç”¨äºŽè¿žæŽ¥Shiroå’Œå®¢æˆ·ç³»ç»Ÿçš„ç”¨æˆ·æ•°æ®çš„æ¡¥æ¢ã€‚ä¸€æ—¦ShiroçœŸæ­£éœ€è¦è®¿é—®å„ç§å®‰å…¨ç›¸å…³çš„æ•°æ®ï¼ˆæ¯”å¦‚ä½¿ç”¨ç”¨æˆ·è´¦æˆ·æ¥åšç”¨æˆ·èº«ä»½éªŒè¯ä»¥åŠæƒé™éªŒè¯ï¼‰æ—¶ï¼Œä»–æ€»æ˜¯é€šè¿‡è°ƒç”¨ç³»ç»Ÿé…ç½®çš„å„ç§Realmæ¥è¯»å–æ•°æ® å…³äºŽShiro çš„å…¶ä½™æ ¸å¿ƒç»„ä»¶å‚è€ƒ Shiro å®˜ç½‘ æˆ–è€… Shiroçš„æž¶æž„ æœ¬æ–‡ä¸åšè¿‡å¤šçš„é˜è¿° Shiro æ˜¯å¦‚ä½•å·¥ä½œçš„ç®€å•æ¥è®²çš„è¯ï¼Œåœ¨Springé¡¹ç›®ä¸­ Shiro ä¼šå°†ä»–çš„æ‰€æœ‰ç»„ä»¶æ³¨å†Œåˆ° SecurityManagerä¸­ å†é€šè¿‡å°† SecurityManager æ³¨å†Œåˆ° ShiroFilterFactoryBeanï¼ˆè¿™ä¸ªç±»å®žçŽ°äº†Spring çš„BeanPostProcessorä¼šé¢„å…ˆåŠ è½½ï¼‰ ä¸­ï¼Œ æœ€åŽä»¥ filter çš„å½¢å¼æ³¨å†Œåˆ°Springå®¹å™¨ï¼ˆå®žçŽ°äº†Springçš„FactoryBeanï¼Œæž„é€ ä¸€ä¸ª filter æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ï¼‰ï¼Œå®žçŽ°ç”¨æˆ·æƒé™çš„ç®¡ç†ã€‚ Shiro å¦‚ä½•é›†æˆ shiro æ‰€éœ€ä¾èµ–ï¼Œå®Œæ•´è§demoæºç  12345678910111213141516171819202122&lt;!--shiro--&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt; &lt;artifactId&gt;shiro-core&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt; &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt; &lt;artifactId&gt;shiro-ehcache&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt;&lt;/dependency&gt;&lt;!-- åŸºäºŽthymeleafçš„shiroæ‰©å±• --&gt;&lt;dependency&gt; &lt;groupId&gt;com.github.theborakompanioni&lt;/groupId&gt; &lt;artifactId&gt;thymeleaf-extras-shiro&lt;/artifactId&gt; &lt;version&gt;2.0.0&lt;/version&gt;&lt;/dependency&gt; ShiroConfig 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117@Configurationpublic class ShiroConfig &#123; private static final Logger log = LoggerFactory.getLogger(ShiroConfig.class); @Bean public ShiroFilterFactoryBean shiroFilterFactoryBean(DefaultWebSecurityManager securityManager) &#123; ShiroFilterFactoryBean shiroFilter = new ShiroFilterFactoryBean(); shiroFilter.setSecurityManager(securityManager); Map&lt;String, String&gt; chainDefinition = new LinkedHashMap&lt;&gt;(); // é™æ€èµ„æºä¸Žç™»å½•è¯·æ±‚ä¸æ‹¦æˆª chainDefinition.put("/js/**", "anon"); chainDefinition.put("/css/**", "anon"); chainDefinition.put("/img/**", "anon"); chainDefinition.put("/layui/**", "anon"); chainDefinition.put("/login", "anon"); chainDefinition.put("/login.html", "anon"); // ç”¨æˆ·ä¸ºæŽˆæƒé€šè¿‡è®¤è¯ &amp;&amp; åŒ…å«'admin'è§’è‰² chainDefinition.put("/admin/**", "authc, roles[super_admin]"); // ç”¨æˆ·ä¸ºæŽˆæƒé€šè¿‡è®¤è¯æˆ–è€…RememberMe &amp;&amp; åŒ…å«'document:read'æƒé™ chainDefinition.put("/docs/**", "user, perms[document:read]"); // ç”¨æˆ·è®¿é—®æ‰€æœ‰è¯·æ±‚ æŽˆæƒé€šè¿‡ || RememberMe chainDefinition.put("/**", "user"); shiroFilter.setFilterChainDefinitionMap(chainDefinition); // å½“ ç”¨æˆ·èº«ä»½å¤±æ•ˆæ—¶é‡å®šå‘åˆ° loginUrl shiroFilter.setLoginUrl("/login.html"); // ç”¨æˆ·ç™»å½•åŽé»˜è®¤é‡å®šå‘è¯·æ±‚ shiroFilter.setSuccessUrl("/index.html"); return shiroFilter; &#125; @Bean public Realm realm() &#123; ShiroRealm realm = new ShiroRealm(); realm.setCredentialsMatcher(credentialsMatcher()); realm.setCacheManager(ehCacheManager()); return realm; &#125; @Bean public CacheManager ehCacheManager() &#123; EhCacheManager cacheManager = new EhCacheManager(); cacheManager.setCacheManagerConfigFile("classpath:ehcache.xml"); return cacheManager; &#125; @Bean public CredentialsMatcher credentialsMatcher() &#123; AuthCredentialsMatcher credentialsMatcher = new AuthCredentialsMatcher(ehCacheManager()); credentialsMatcher.setHashAlgorithmName(AuthCredentialsMatcher.HASH_ALGORITHM_NAME); credentialsMatcher.setHashIterations(AuthCredentialsMatcher.HASH_ITERATIONS); credentialsMatcher.setStoredCredentialsHexEncoded(true); return credentialsMatcher; &#125; @Bean public DefaultWebSecurityManager securityManager() &#123; log.debug("--------------shiroå·²ç»åŠ è½½----------------"); DefaultWebSecurityManager manager = new DefaultWebSecurityManager(); manager.setCacheManager(ehCacheManager()); manager.setRealm(realm()); manager.setRememberMeManager(rememberMeManager()); return manager; &#125; @Bean public RememberMeManager rememberMeManager() &#123; CookieRememberMeManager cookieRememberMeManager = new CookieRememberMeManager(); //rememberMe cookieåŠ å¯†çš„å¯†é’¥ å»ºè®®æ¯ä¸ªé¡¹ç›®éƒ½ä¸ä¸€æ · é»˜è®¤AESç®—æ³• å¯†é’¥é•¿åº¦(128 256 512 ä½) cookieRememberMeManager.setCipherKey(Base64.decode("2AvVhdsgUs0FSA3SDFAdag==")); cookieRememberMeManager.setCookie(rememberMeCookie()); return cookieRememberMeManager; &#125; @Bean public SimpleCookie rememberMeCookie()&#123; //è¿™ä¸ªå‚æ•°æ˜¯cookieçš„åç§°ï¼Œå¯¹åº”å‰ç«¯çš„checkboxçš„name = rememberMe SimpleCookie simpleCookie = new SimpleCookie("rememberMe"); //&lt;!-- è®°ä½æˆ‘cookieç”Ÿæ•ˆæ—¶é—´30å¤© ,å•ä½ç§’;--&gt; simpleCookie.setMaxAge(259200); return simpleCookie; &#125; /** * Shiroç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨: * ç”¨äºŽåœ¨å®žçŽ°äº†InitializableæŽ¥å£çš„Shiro beanåˆå§‹åŒ–æ—¶è°ƒç”¨InitializableæŽ¥å£å›žè°ƒ(ä¾‹å¦‚:UserRealm) * åœ¨å®žçŽ°äº†DestroyableæŽ¥å£çš„Shiro beané”€æ¯æ—¶è°ƒç”¨ DestroyableæŽ¥å£å›žè°ƒ(ä¾‹å¦‚:DefaultSecurityManager) */ @Bean public LifecycleBeanPostProcessor lifecycleBeanPostProcessor() &#123; return new LifecycleBeanPostProcessor(); &#125; /** * å¯ç”¨shrioæŽˆæƒæ³¨è§£æ‹¦æˆªæ–¹å¼ï¼ŒAOPå¼æ–¹æ³•çº§æƒé™æ£€æŸ¥ */ @Bean public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(DefaultWebSecurityManager securityManager) &#123; AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = new AuthorizationAttributeSourceAdvisor(); authorizationAttributeSourceAdvisor.setSecurityManager(securityManager); return authorizationAttributeSourceAdvisor; &#125; /** * thymeleafçš„shiroæ‰©å±• * * @return */ @Bean public ShiroDialect shiroDialect() &#123; return new ShiroDialect(); &#125;&#125; ä»¥ä¸ŠåŸºæœ¬æ˜¯Springé¡¹ç›®é›†æˆ Shiro çš„é€šç”¨é…ç½®ï¼Œä¸‹é¢é’ˆå¯¹ä¸Šè¿°çš„å‡ ä¸ªBean èŠä¸€èŠ1. ShiroFilterFactoryBeanï¼šç”¨äºŽå®šä¹‰ è¯·æ±‚çš„æ‹¦æˆªè§„åˆ™, Shiroä¸ºæˆ‘ä»¬é»˜è®¤æä¾›äº†ä¸€äº›é€‰é¡¹ï¼Œå¸¸ç”¨å¦‚ä¸‹ anon: è¯·æ±‚ä¸æ‹¦æˆª authc: è¦æ±‚ç”¨æˆ·å¿…é¡»è®¤è¯é€šè¿‡ user: è¦æ±‚ç”¨æˆ·ä¸ºè®°ä½æˆ‘çŠ¶æ€ roles[xxx]: è¦æ±‚ç”¨æˆ·å¿…é¡»æ»¡è¶³ xxx è§’è‰² perms[xxx]: è¦æ±‚ç”¨æˆ·å¿…é¡»æ»¡è¶³ xxx æƒé™å…¶å®žä¸Šè¿°æ¯ä¸€ä¸ªéƒ½å¯¹åº”äº†ä¸€ä¸ª Shiro è¿‡æ»¤å™¨ Filter Name Class anon org.apache.shiro.web.filter.authc.AnonymousFilter authc org.apache.shiro.web.filter.authc.FormAuthenticationFilter authcBasic org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter logout org.apache.shiro.web.filter.authc.LogoutFilter noSessionCreation org.apache.shiro.web.filter.session.NoSessionCreationFilter perms | org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilterport| org.apache.shiro.web.filter.authz.PortFilterrest| org.apache.shiro.web.filter.authz.HttpMethodPermissionFilterroles| org.apache.shiro.web.filter.authz.RolesAuthorizationFilterssl| org.apache.shiro.web.filter.authz.SslFilteruser| org.apache.shiro.web.filter.authc.UserFilter æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ è¿‡æ»¤å™¨æ¥å®žçŽ°æ‹¦æˆª 2. Realmï¼šä¸Šé¢æåˆ°è¿‡Realmæ˜¯ç”¨äºŽè¿žæŽ¥Shiroå’Œå®¢æˆ·ç³»ç»Ÿçš„ç”¨æˆ·æ•°æ®çš„æ¡¥æ¢, æˆ‘ä»¬é€šè¿‡å®žçŽ°AuthorizingRealm æ¥æä¾›ç”¨æˆ·è®¤è¯å’ŒæŽˆæƒä¸¤ä¸ªAPI 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778public class ShiroRealm extends AuthorizingRealm &#123; private static final Logger log = LoggerFactory.getLogger(AuthorizingRealm.class); @Autowired @Lazy // è¿™é‡Œlazy æ˜¯æœ‰å¿…è¦çš„, shiroç»„ä»¶ä¼šé¢„å…ˆåŠ è½½ï¼Œå¯¼è‡´ä¾èµ–çš„bean æ²¡æœ‰ç”Ÿæˆä»£ç†å¯¹è±¡ï¼ˆAOPå¤±æ•ˆï¼‰ private UserService userService; /** * è®¤è¯ * * @param authenticationToken * @return * @throws AuthenticationException */ @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException &#123; String username = (String) authenticationToken.getPrincipal(); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executing doGetAuthenticationInfo", username)); &#125; User user = userService.getUserByUsername(username); if (user == null) &#123; throw new UnknownAccountException(); &#125; if (Constant.IS_LOCK.equals(user.getIsLock())) &#123; throw new LockedAccountException(); &#125; // ShiroUser ä½œä¸ºå®žé™…çš„ principal ShiroUser shiroUser = new ShiroUser(); BeanUtils.copyProperties(user, shiroUser); // SimpleAuthenticationInfo(Object principal, Object credentials, String realmName) // principal ä¼šè¢«å°è£…åˆ° subject ä¸­ // shiro é»˜è®¤ä¼šæŠŠæˆ‘ä»¬çš„ credentials (ä¹Ÿå°±æ˜¯password) å’Œ token ä¸­çš„ä½œå¯¹æ¯”ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸ç”¨åšå¯†ç æ ¡éªŒ ByteSource salt = ByteSource.Util.bytes(user.getUsername()); SimpleAuthenticationInfo info = new SimpleAuthenticationInfo(shiroUser, user.getPassword(), salt, getName()); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executed doGetAuthenticationInfo", username)); &#125; return info; &#125; /** * æŽˆæƒ * * @param principalCollection * @return */ @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) &#123; ShiroUser shiroUser = (ShiroUser) principalCollection.getPrimaryPrincipal(); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executing doGetAuthorizationInfo", shiroUser.getUsername())); &#125; AuthorizationDTO authorizationDTO = userService.getRolesAndPermissions(shiroUser.getId()); SimpleAuthorizationInfo info = new SimpleAuthorizationInfo(); info.addRoles(authorizationDTO.getRoleCodeSet()); info.addStringPermissions(authorizationDTO.getPermissionCodeSet()); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executed doGetAuthorizationInfo", shiroUser.getUsername())); &#125; return info; &#125;&#125; doGetAuthenticationInfo : è®¤è¯æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œ subject.login(token);åŽï¼ŒShiroè®¤è¯å™¨ä¼šè¯»å– Realm ä¸­çš„è¯¥æ–¹æ³•èŽ·å– AuthenticationInfoå¯¹è±¡ï¼ˆè®¤è¯ä¿¡æ¯ï¼‰ï¼ŒåŒ…å«principalï¼ˆæˆ‘ä»¬å­˜å‚¨åœ¨shiro subjectä¸­çš„å¯¹è±¡ï¼‰ï¼Œcredentials ï¼ˆå¯†ç ï¼‰ã€‚ doGetAuthorizationInfo: æŽˆæƒæ–¹æ³•ï¼Œåœ¨éœ€è¦æ ¡éªŒç”¨æˆ·è®¿é—®æƒé™çš„æ—¶å€™ï¼ŒShiroæŽˆæƒå™¨ä¼šè¯»å– Realm ä¸­çš„è¯¥æ–¹æ³•èŽ·å– AuthorizationInfoå¯¹è±¡ï¼ˆæŽˆæƒä¿¡æ¯ï¼‰è¯»å–DBåŽï¼Œå¯ä»¥é€šè¿‡ addRoles(roleCollection) å’Œ addStringPermissions(permCollection) è®¾ç½®å½“å‰ç”¨æˆ·çš„è§’è‰²å’Œæƒé™ã€‚Shiro åœ¨æ‹¿åˆ°è¿™ä¸ªæƒé™ä¿¡æ¯åŽï¼Œä¼šåŽ»æ‰¾ç¼“å­˜ç®¡ç†å™¨ï¼Œä»¥å½“å‰ subject çš„ principal ä½œä¸ºkey ç¼“å­˜èµ·æ¥ã€‚ 3. CredentialsMatcher: å¯†ç åŒ¹é…å™¨ï¼Œç”¨äºŽåŒ¹é… doGetAuthenticationInfo æ–¹æ³•è¿”å›žçš„ credentials å’Œ subject.login(token);æ—¶çš„ token ä¸­çš„ passwordæ˜¯å¦ä¸€è‡´ã€‚å¸¸ç”¨çš„å®žçŽ°æœ‰ SimpleCredentialsMatcherï¼ˆé»˜è®¤æ˜¯è¯¥å®žçŽ°ï¼‰ã€HashedCredentialsMatcher ï¼ˆè¯¥å®žçŽ°å¯ä»¥è¿›è¡ŒåŠ å¯†åŒ¹é…ï¼‰ 4. DefaultWebSecurityManagerï¼šå¦‚ä¸Šè¿°ï¼Œç”¨äºŽåè°ƒShiroå†…éƒ¨å„ç§å®‰å…¨ç»„ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬æ‰©å±•çš„bean æ³¨å†Œåˆ° SecurityManager ä¸­ 5. RememberMeManagerï¼šå¼€å¯è¯¥ç»„ä»¶åŽä½¿ç”¨è®°ä½æˆ‘æœåŠ¡ï¼Œ token ä¸­ rememberMe ä¸º true æ—¶ï¼Œç™»å½•æˆåŠŸä¹‹åŽä¼šåˆ›å»ºRememberMe cookieã€‚ å…¶ä½™å‚è€ƒä¸Šæ–‡ä»£ç æ³¨é‡Š å…³äºŽ thymeleaf-extras-shiroShiro é»˜è®¤æ”¯æŒåœ¨ jsp ä¸­ä½¿ç”¨ shiroæ ‡ç­¾ã€‚ä½†æ˜¯æƒ³åœ¨ thymeleaf ä¸­ä½¿ç”¨ Shiro æ ‡ç­¾å‘¢ï¼Ÿ ä½¿ç”¨ thymeleaf-extras-shiro å®Œç¾Žè§£å†³ thymeleaf é¢—ç²’åŒ–æƒé™æŽ§åˆ¶1234567891011ä½ å¥½, &lt;span th:text=&quot;$&#123;principal&#125;&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;p shiro:hasRole=&quot;super_admin&quot;&gt;å½“å‰è§’è‰²è¶…çº§ç®¡ç†å‘˜&lt;/p&gt;&lt;button shiro:hasPermission=&quot;&apos;sys:user:add&apos;&quot;&gt;æ·»åŠ &lt;/button&gt;&lt;button shiro:hasPermission=&quot;&apos;sys:user:update&apos;&quot;&gt;ç¼–è¾‘&lt;/button&gt;&lt;button shiro:hasPermission=&quot;&apos;sys:user:lock&apos;&quot;&gt;å†»ç»“&lt;/button&gt;&lt;div shiro:hasAllPermissions=&quot;&apos;sys:user:add, sys:user:update, sys:user:lock&apos;&quot;&gt; &lt;span&gt;æ»¡è¶³æ‰€æœ‰æƒé™æ—¶æ˜¾ç¤º&lt;/span&gt;&lt;/div&gt;&lt;div shiro:hasAnyPermissions=&quot;&apos;sys:user:add, sys:user:update, sys:user:lock&apos;&quot;&gt; &lt;span&gt;æ»¡è¶³ä¸€ä¸ªæƒé™å³å¯æ˜¾ç¤º&lt;/span&gt;&lt;/div&gt; æ›´å¤šç”¨æ³•å‚è€ƒGithub æ–‡æ¡£ï¼šhttps://github.com/theborakompanioni/thymeleaf-extras-shiro æœ¬æ–‡demohttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-shiroå¦‚æžœä½ å‘çŽ°æˆ‘çš„æ–‡ç« æˆ–è€…demoä¸­å­˜åœ¨é—®é¢˜ï¼Œè¯·è”ç³»æˆ‘]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Shiro</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring-åˆä¸€æ¬¡äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„æŽ’æŸ¥]]></title>
    <url>%2Fpost%2F836297d7.html</url>
    <content type="text"><![CDATA[ä¸Šä¸€ç¯‡å…³äºŽäº‹åŠ¡çš„ è§£å†³ spring service è°ƒç”¨å½“å‰ç±»æ–¹æ³•äº‹åŠ¡ä¸ç”Ÿæ•ˆ æ­£æ–‡ä»Šå¤©åœ¨å·¥ä½œä¸­çªç„¶å‘çŽ°æ ‡è®°äº† @Transactional çš„æ–¹æ³•ï¼Œäº‹åŠ¡å¹¶æ²¡æœ‰ç”Ÿæ•ˆã€‚åœ¨æ£€æŸ¥äº†ä¸šåŠ¡å±‚æ˜¯å¦ try catchå¼‚å¸¸ï¼ŒMySQLå­˜å‚¨å¼•æ“Žä¹‹åŽã€‚å¿ƒæ€å·²è¿‘å´©æºƒçš„è¾¹ç¼˜ï¼š)è¿™ä¸ªæ—¶å€™çªç„¶å‘çŽ°äº†ä¸€ä¸ªç¥žå¥‡çš„çŽ°è±¡ï¼ä¸¤ä¸ª@Service éƒ½æ ‡è®°äº† @Transactionalï¼ŒuserService å¹¶æ²¡æœ‰ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œä¹Ÿå°±å¯¼è‡´äº†äº‹åŠ¡ä¸ç”Ÿæ•ˆã€‚ ç»§ç»­æŽ’æŸ¥ï¼Œæœ€åŽé”å®šäº†å‡¶æ‰‹ â€” BeanPostProcessor å…ˆçœ‹ä¸€ä¸‹å®˜æ–¹æè¿°1234567891011121314/** * Factory hook that allows for custom modification of new bean instances, * e.g. checking for marker interfaces or wrapping them with proxies. * * &lt;p&gt;ApplicationContexts can autodetect BeanPostProcessor beans in their * bean definitions and apply them to any beans subsequently created. * Plain bean factories allow for programmatic registration of post-processors, * applying to all beans created through this factory. * * &lt;p&gt;Typically, post-processors that populate beans via marker interfaces * or the like will implement &#123;@link #postProcessBeforeInitialization&#125;, * while post-processors that wrap beans with proxies will normally * implement &#123;@link #postProcessAfterInitialization&#125;. * ç®€å•çš„æ¥è¯´ï¼ŒBeanPostProcessoræ˜¯Spring ç»™æˆ‘ä»¬æä¾›çš„ä¸€ä¸ªæ‰©å±•æŽ¥å£1234567public interface BeanPostProcessor &#123; // beanå®žä¾‹åŒ–æ–¹æ³•è°ƒç”¨å‰è¢«è°ƒç”¨ Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException; // beanå®žä¾‹åŒ–æ–¹æ³•è°ƒç”¨åŽè¢«è°ƒç”¨ Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException;&#125; åˆ†æž ApplicationContexts æ£€æµ‹åˆ° BeanPostProcessor ä¹‹åŽä¼šå°†ä»–åº”ç”¨äºŽéšåŽåˆ›å»ºçš„æ‰€æœ‰ beanï¼Œæ‰€ä»¥ BeanPostProcessor ä¼šåœ¨å…¶ä»–Beançš„ä¹‹å‰åŠ è½½ï¼Œä½†æ˜¯éšä¹‹å¼•å‘çš„é—®é¢˜çš„å°±æ˜¯ BeanPostProcessor å®žçŽ°ç±»æ‰€å¼•ç”¨çš„Bean æ²¡æœ‰è¢«ä»£ç†ï¼Œåªæ˜¯è¢«æ‰˜ç®¡åˆ° IOC å®¹å™¨ä¸­ã€‚ æˆ‘çš„é¡¹ç›®é‡Œå¼•ç”¨äº† Shiroï¼Œè€Œ Shiro çš„æ‰€æœ‰ç»„ä»¶æœ€ç»ˆä¼šè¢«å°è£…åˆ° ShiroFilterFactoryBean ï¼ˆè¯¥ç±»å®žçŽ°äº† BeanPostProcessorï¼‰ä¸­ï¼Œè€Œ Shiro çš„ Realm ä¸­åˆä¾èµ–äº†æˆ‘ä»¬çš„ Serviceï¼Œè¯¥ Service é¢„å…ˆåŠ è½½ï¼Œå¯¼è‡´æ²¡æœ‰è¢«ä»£ç† è§£å†³æ–¹æ¡ˆ1234567public class AuthRealm extends AuthorizingRealm &#123; @Autowired @Lazy // å»¶è¿ŸåŠ è½½ private UserService userService;&#125; æ€»ç»“è¿™é‡Œç»™å¤§å®¶ç®€å•ä»‹ç»å¼•èµ·äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„å‡ ä¸ªåŽŸå›  try catch æ•èŽ· Service è¿è¡Œæ—¶å¼‚å¸¸ï¼Œå› ä¸º Spring é»˜è®¤åœ¨æ•èŽ·åˆ° RuntimeException æ—¶å›žæ»š MySQLå­˜å‚¨å¼•æ“Ž InnoDB æ˜¯æ”¯æŒäº‹åŠ¡çš„ï¼Œè€Œ MyISAM ä¸æ”¯æŒ ç”±äºŽå„ç§åŽŸå› æ²¡æœ‰ä½¿ç”¨æˆ–è€… Spring æ²¡æœ‰ç”Ÿæˆä»£ç†å¯¹è±¡]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>AOP</tag>
        <tag>Shiro</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-insert-or-update]]></title>
    <url>%2Fpost%2F73b0b9b2.html</url>
    <content type="text"><![CDATA[æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ç±»ä¼¼çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ’å…¥ä¸€æ¡æ•°æ®å¦‚æžœä»–ä¸å­˜åœ¨åˆ™æ‰§è¡Œ insert ï¼Œå½“è¿™æ¡è®°å½•å­˜åœ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬åŽ» update ä»–çš„ä¸€äº›å±žæ€§ï¼ˆæˆ–è€…ä»€ä¹ˆéƒ½ä¸åšï¼‰ã€‚ è§£å†³æ–¹æ¡ˆï¼š ä½¿ç”¨ ON DUPLICATE KEY UPDATEåœ¨ ä¸»é”® æˆ–è€… å”¯ä¸€çº¦æŸ é‡å¤æ—¶ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œã€‚ ä½¿ç”¨ REPLACE INTOåœ¨ ä¸»é”® æˆ–è€… å”¯ä¸€çº¦æŸ é‡å¤æ—¶ï¼Œå…ˆ delete å† insertã€‚ ON DUPLICATE KEY UPDATE åˆ›å»ºè¡¨ï¼Œå»ºç«‹å”¯ä¸€çº¦æŸï¼Œå‡†å¤‡ä¸€æ¡æ•°æ®123456789101112CREATE TABLE `stu_class_ref` ( `id` varchar(30) NOT NULL, `stu_id` varchar(30) DEFAULT NULL, `class_id` varchar(30) DEFAULT NULL, `note` varchar(100) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `stu_id` (`stu_id`,`class_id`) USING BTREE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;INSERT INTO `test`.`stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (&apos;001&apos;, &apos;zhangsan&apos;, &apos;yuwen&apos;, NULL); ä½¿ç”¨ ON DUPLICATE KEY UPDATE 123456INSERT INTO `test`.`stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (UUID_SHORT(), &apos;zhangsan&apos;, &apos;yuwen&apos;, &apos;æˆ‘å–œæ¬¢è¯­æ–‡:)&apos;)ON DUPLICATE KEY UPDATE note = &apos;æˆ‘å–œæ¬¢è¯­æ–‡:)&apos;&gt; Affected rows: 2&gt; æ—¶é—´: 0.042s Affected rows: 2ï¼ŒMySQL æ£€æŸ¥æ’å…¥çš„è¡Œæ˜¯å¦ä¼šäº§ç”Ÿé‡å¤é”®é”™è¯¯ï¼Œå¦‚æžœä¼šåˆ™æ‰§è¡Œupdate å¦‚æžœæƒ³è¦å¼•ç”¨ VALUES ä¸­çš„å€¼ï¼Œå‚è€ƒå¦‚ä¸‹123456INSERT INTO `test`.`stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (UUID_SHORT(), &apos;zhangsan&apos;, &apos;yuwen&apos;, NULL)ON DUPLICATE KEY UPDATE note = VALUES(class_id)&gt; Affected rows: 2&gt; æ—¶é—´: 0.006s REPLACE INTO MySQL ä¸­ è¿˜æœ‰ä¸€ä¸ªé»‘ç§‘æŠ€è¯­æ³• REPLACE INTO1234REPLACE INTO `stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (UUID_SHORT(), &apos;zhangsan&apos;, &apos;yuwen&apos;, NULL)&gt; Affected rows: 2&gt; æ—¶é—´: 0.004s REPLACE INTO å°±æ¯”è¾ƒç®€å•ç²—æš´äº†ï¼Œä»–ä¼šå…ˆæ‰§è¡Œdelete æ“ä½œï¼Œç„¶åŽinsert ON DUPLICATE KEY UPDATE ä¸Ž REPLACE INTO å†æ¥åˆ›å»ºä¸€å¼ è¡¨, åˆ›å»ºä¸‰ä¸ªå”¯ä¸€çº¦æŸ, æ’å…¥ä¸‰æ¡æ•°æ®123456789101112131415161718CREATE TABLE `interesting` ( `id` varchar(30) NOT NULL, `uni_a` varchar(30) DEFAULT NULL, `uni_b` varchar(30) DEFAULT NULL, `uni_c` varchar(30) DEFAULT NULL, `version` int(11) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `uni_a` (`uni_a`) USING BTREE, UNIQUE KEY `uni_b` (`uni_b`) USING BTREE, UNIQUE KEY `uni_c` (`uni_c`) USING BTREE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;INSERT INTO `test`.`interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (&apos;1&apos;, &apos;a&apos;, &apos;a&apos;, &apos;a&apos;, NULL);INSERT INTO `test`.`interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (&apos;2&apos;, &apos;b&apos;, &apos;b&apos;, &apos;b&apos;, NULL);INSERT INTO `test`.`interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (&apos;3&apos;, &apos;c&apos;, &apos;c&apos;, &apos;c&apos;, NULL); æ‰§è¡Œ ON DUPLICATE KEY UPDATE12345INSERT INTO `interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (UUID_SHORT(), &apos;a&apos;, &apos;b&apos;, &apos;c&apos;, NULL)ON DUPLICATE KEY UPDATE version = 666&gt; Affected rows: 2&gt; æ—¶é—´: 0.049s Affected rows: 2 ä½†æ˜¯å…¶å®žä¸‰æ¡ä¸»é”®éƒ½æœ‰å†²çªäº† å†çœ‹ä¸€ä¸‹ REPLACE INTO1234REPLACE INTO `interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (UUID_SHORT(), &apos;a&apos;, &apos;b&apos;, &apos;c&apos;, NULL)&gt; Affected rows: 4&gt; æ—¶é—´: 0.026s Affected rows: 4 REPLACE INTO å°†ä¸‰æ¡æœ‰å†²çªçš„å…¨éƒ¨delete ç„¶åŽ insert ####æ€»ç»“ï¼š ON DUPLICATE KEY UPDATE åªä¼šå¯¹æ‰€åŒ¹é…çš„ç¬¬ä¸€è¡Œè¿›è¡Œupdate, REPLACE INTO ä¼šå¯¹æ‰€æœ‰åŒ¹é…è¡Œè¿›è¡Œdelete, insert æ‰€ä»¥åº”é¿å…å¯¹æœ‰å¤šä¸ªå”¯ä¸€ç´¢å¼•çš„è¡¨ä½¿ç”¨]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot ä½¿ç”¨ hibernate validator]]></title>
    <url>%2Fpost%2F81ef5d67.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡å°†å…¨é¢çš„ä»‹ç»å¦‚ä½•ä½¿ç”¨ validator è¿›è¡Œæ•°æ®æ ¡éªŒ æœ¬æ–‡æºç ï¼šhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-validate å‡†å¤‡å·¥ä½œæˆ‘ä»¬åªéœ€è¦å¼•å…¥ spring-boot-starter-webåŒ…å³å¯ä½¿ç”¨ å¸¸ç”¨æ³¨è§£ æ³¨è§£ é‡Šä¹‰ @Valid è¢«æ³¨é‡Šçš„å…ƒç´ æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦æ£€æŸ¥æ­¤å¯¹è±¡çš„æ‰€æœ‰å­—æ®µå€¼ @Null è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º null @NotNull è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸ä¸º null @NotEmpty è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¿…é¡»éžç©º, å³ä¸ä¸ºnull, â€œâ€ @NotBlank è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¿…é¡»éžç©º, å³ä¸ä¸ºnull, â€œâ€, â€œ â€œ @AssertTrue è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º true @AssertFalse è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º false @Min(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºŽç­‰äºŽæŒ‡å®šçš„æœ€å°å€¼ @Max(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºŽç­‰äºŽæŒ‡å®šçš„æœ€å¤§å€¼ @DecimalMin(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºŽç­‰äºŽæŒ‡å®šçš„æœ€å°å€¼ @DecimalMax(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºŽç­‰äºŽæŒ‡å®šçš„æœ€å¤§å€¼ @Size(max, min) è¢«æ³¨é‡Šçš„å…ƒç´ çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†… @Digits (integer, fraction) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»åœ¨å¯æŽ¥å—çš„èŒƒå›´å†… @Past è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªè¿‡åŽ»çš„æ—¥æœŸ @Future è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªå°†æ¥çš„æ—¥æœŸ @Pattern(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼ @Email è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ç”µå­é‚®ç®±åœ°å€ @Length(min=, max=) è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†… @Range(min=, max=) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»åœ¨åˆé€‚çš„èŒƒå›´ ç®€å•çš„å®žä½“æ ¡éªŒ123456789101112131415161718public class CardDTO &#123; @NotBlank private String cardId; @Size(min = 10, max = 10) @NotNull private String cardNum; // å¡å· @Past @NotNull private Date createDate; @Range(max = 3) private String cardType; // çœç•¥get set&#125; 123456789@RestControllerpublic class UserController &#123; @PostMapping(&quot;simple&quot;) public Object simple(@RequestBody @Valid CardDTO cardDTO) &#123; return cardDTO; &#125;&#125; å®žä½“å±žæ€§ä¸Šæ·»åŠ æ ¡éªŒæ³¨è§£ controller æ–¹æ³• å‚æ•°å‰ ä½¿ç”¨@Valid å³å¯ å¤æ‚çš„å®žä½“æ ¡éªŒåµŒå¥—å®žä½“æ ¡éªŒ123456789101112131415public class UserDTO &#123; @NotBlank private String userId; @NotBlank private String username; private String password; @Valid private List&lt;CardDTO&gt; cardList; //çœç•¥ get set&#125; controller å†™æ³• åŒä¸Šï¼Œåªæ˜¯åœ¨ UserDTO cardList å±žæ€§ä¸Šæ ‡è®°@Valid æ³¨è§£ å³å¯ã€‚ List æ ¡éªŒ æˆ‘ä»¬éœ€è¦åƒ åµŒå¥—æ ¡éªŒ æ—¶ä¸€æ ·ï¼Œå¯¹List&lt;CardDTO&gt; åšä¸€å±‚å°è£… 123456789101112131415public class ValidList&lt;E&gt; implements List&lt;E&gt; &#123; @Valid private List&lt;E&gt; list = new ArrayList&lt;&gt;(); public List&lt;E&gt; getList() &#123; return list; &#125; public void setList(List&lt;E&gt; list) &#123; this.list = list; &#125; // çœç•¥äº† å®žçŽ°æ–¹æ³•&#125; é‡å†™å®žçŽ°æ–¹æ³•å®Œå…¨ä½¿ç”¨ this.list.xxx()Gitee:spring ä¼šå°†æ•°æ®å°è£…åˆ°æˆ‘ä»¬å®šä¹‰çš„ list å±žæ€§ä¸­ï¼Œåˆå°†å±žæ€§å£°æ˜Žäº† @Valid ä½¿å¾— hibernate validator å¯ä»¥ä¸ºæˆ‘ä»¬åšæ ¡éªŒï¼ ä½¿ç”¨ @Validated åˆ†ç»„æ ¡éªŒ12345public interface Insert &#123;&#125;public interface Update &#123;&#125; å®šä¹‰ä¸¤ä¸ªæŽ¥å£ 12345678910111213public class GroupCardDTO &#123; @NotBlank(groups = &#123;Update.class&#125;) private String id; @NotBlank(groups = &#123;Insert.class&#125;) private String cardNum; @NotNull(groups = &#123;Insert.class, Update.class&#125;) private Integer cardType; //çœç•¥ get set&#125; å®žä½“æ ‡è®°çš„æ³¨è§£ä¸­æ·»åŠ  group å±žæ€§ 1234@PostMapping(&quot;insert_card&quot;)public Object insert_card(@RequestBody @Validated(Insert.class) GroupCardDTO card)&#123; return card;&#125; ä½¿ç”¨ @Validated(xxx.class) æ ‡è®°å‚æ•°ï¼Œå®Œæˆåˆ†ç»„æ ¡éªŒï¼ è‡ªå®šä¹‰æ³¨è§£æ ¡éªŒå½“ validator æä¾›çš„æ³¨è§£æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„æ–¹å¼æ¥å®žçŽ°æ ¡éªŒã€‚ éœ€æ±‚ï¼šæ ¡éªŒæŸå­—ç¬¦ä¸²å¿…é¡»ä¸ºå¤§å†™æˆ–è€…å°å†™1234public enum CaseMode &#123; UPPER, LOWER&#125; å®šä¹‰ä¸€ä¸ªæžšä¸¾ç±» 12345678910111213141516171819import javax.validation.Constraint;import javax.validation.Payload;import java.lang.annotation.*;@Target( &#123; ElementType.FIELD &#125;)@Retention(RetentionPolicy.RUNTIME)@Constraint(validatedBy = CheckCaseValidator.class)@Documentedpublic @interface CheckCase &#123; String message() default ""; Class&lt;?&gt;[] groups() default &#123;&#125;; Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;; CaseMode value() default CaseMode.LOWER;&#125; å®šä¹‰æ³¨è§£ @Constraint æŒ‡å®šæˆ‘ä»¬çš„æ ¡éªŒé€»è¾‘å®žçŽ°ç±» 12345678910111213141516171819202122232425262728293031import javax.validation.ConstraintValidator;import javax.validation.ConstraintValidatorContext;public class CheckCaseValidator implements ConstraintValidator&lt;CheckCase, String&gt; &#123; private CaseMode caseMode; @Override public void initialize(CheckCase constraintAnnotation) &#123; this.caseMode = constraintAnnotation.value(); &#125; @Override public boolean isValid(String value, ConstraintValidatorContext context) &#123; if (value == null || "".equals(value.trim())) &#123; return false; &#125; switch (this.caseMode) &#123; case LOWER: return value.equals(value.toLowerCase()); case UPPER: return value.equals(value.toUpperCase()); default: return false; &#125; &#125;&#125; initialize() åˆå§‹åŒ–æ—¶æ‰§è¡Œï¼Œå¯ä»¥ç”¨æ¥èŽ·å–æ³¨è§£ä¸­çš„å±žæ€§ isValid() å®žçŽ°æˆ‘ä»¬çš„æ ¡éªŒé€»è¾‘ å¤‡æ³¨ æˆ‘ä»¬è‡ªå®šä¹‰çš„æ³¨è§£ä¾ç„¶æ”¯æŒ @Validated group åˆ†ç»„ æ‰‹åŠ¨ä½¿ç”¨ validator æ ¡éªŒ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869import org.hibernate.validator.internal.engine.path.PathImpl;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;import java.util.Set;import javax.validation.ConstraintViolation;import javax.validation.Validation;import javax.validation.Validator;import javax.validation.ValidatorFactory;public class ValidateUtil &#123; /** * æ ¡éªŒå®žä½“ç±» * * @param t * @return */ public static &lt;T&gt; List&lt;Map&gt; validate(T t) &#123; //å®šä¹‰è¿”å›žé”™è¯¯List List&lt;Map&gt; errList = new ArrayList&lt;&gt;(); Map&lt;String, String&gt; errorMap; ValidatorFactory factory = Validation.buildDefaultValidatorFactory(); Validator validator = factory.getValidator(); Set&lt;ConstraintViolation&lt;T&gt;&gt; errorSet = validator.validate(t); for (ConstraintViolation&lt;T&gt; c : errorSet) &#123; errorMap = new HashMap&lt;&gt;(); errorMap.put("field", c.getPropertyPath().toString()); //èŽ·å–å‘ç”Ÿé”™è¯¯çš„å­—æ®µ errorMap.put("msg", c.getMessage()); //èŽ·å–æ ¡éªŒä¿¡æ¯ errList.add(errorMap); &#125; return errList; &#125; /** * ä½¿ç”¨ ValidList æ ¡éªŒList, è¿”å›žå¯¹åº”ç´¢å¼•å’Œé”™è¯¯æ¶ˆæ¯ * * @param t * @param &lt;T&gt; * @return */ public static &lt;T&gt; List&lt;Map&gt; validateList(T t) &#123; //å®šä¹‰è¿”å›žé”™è¯¯List List&lt;Map&gt; errList = new ArrayList&lt;&gt;(); Map&lt;String, Object&gt; errorMap; ValidatorFactory factory = Validation.buildDefaultValidatorFactory(); Validator validator = factory.getValidator(); Set&lt;ConstraintViolation&lt;T&gt;&gt; errorSet = validator.validate(t); for (ConstraintViolation&lt;T&gt; c : errorSet) &#123; errorMap = new HashMap&lt;&gt;(); int index = ((PathImpl) c.getPropertyPath()).getLeafNode().getIndex(); errorMap.put("index", index); // å½“å‰ç´¢å¼• errorMap.put("field", c.getPropertyPath().toString()); //èŽ·å–å‘ç”Ÿé”™è¯¯çš„å­—æ®µ errorMap.put("msg", c.getMessage()); //èŽ·å–æ ¡éªŒä¿¡æ¯ errList.add(errorMap); &#125; return errList; &#125;&#125; æœ¬èŠ‚æºç https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-validate]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JWT é‰´æƒ]]></title>
    <url>%2Fpost%2F606cdcbb.html</url>
    <content type="text"><![CDATA[JWT æ˜¯ä»€ä¹ˆ JSON Web Tokenï¼ˆJWTï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾å¼æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘ä¸”è‡ªåŒ…å«çš„æ–¹å¼ï¼Œç”¨äºŽåœ¨å„æ–¹ä¹‹é—´ä»¥JSONå¯¹è±¡å®‰å…¨ä¼ è¾“ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥é€šè¿‡æ•°å­—ç­¾åè¿›è¡ŒéªŒè¯å’Œä¿¡ä»»ã€‚ JWT çš„ç»„æˆJWT çš„æ ¼å¼ä¸º xxx.yyy.zzzã€‚åŒ…å« Headerï¼ˆå¤´éƒ¨ï¼‰ï¼ŒPayloadï¼ˆè´Ÿè½½ï¼‰ï¼ŒSignatureï¼ˆç­¾åï¼‰ä¸‰éƒ¨åˆ†ã€‚ Headeré€šå¸¸ä¼šå£°æ˜Žä½¿ç”¨çš„åŠ å¯†ç®—æ³•å’Œtokenç±»åž‹ 1234&#123; &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot;&#125; PayloadPayload åŒ…å« Claimsï¼ŒClaimæ˜¯ä¸€äº›å®žä½“ï¼ˆä¸€èˆ¬éƒ½æ˜¯ç”¨æˆ·ï¼‰çš„çŠ¶æ€å’Œé¢å¤–çš„æ•°æ®ç»„æˆã€‚JWT ä¸ºæˆ‘ä»¬é¢„å®šä¹‰äº†ä¸€äº› Claimsï¼Œä¾‹å¦‚ï¼šiss (issuer), exp (expiration time), sub (subject), aud (audience), and others.ä½†æ˜¯å¹¶ä¸è¦æ±‚æˆ‘ä»¬å¼ºåˆ¶ä½¿ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰ Claim 12345&#123; &quot;sub&quot;: &quot;1234567890&quot;, &quot;name&quot;: &quot;Taven&quot;, &quot;admin&quot;: true&#125; Signature 1234HMACSHA256( base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), secret) è¿™æ®µä¼ªä»£ç å·²ç»å¾ˆå¥½çš„è®²è§£äº†ï¼Œç­¾åæ˜¯å¦‚ä½•è®¡ç®—çš„ã€‚æœåŠ¡ç«¯æä¾›ä¸€ä¸ªsecretï¼Œå°†headerã€payload è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åŽä½¿ç”¨headerä¸­å£°æ˜Žçš„ç®—æ³•è®¡ç®—ç­¾åã€‚ JWT ä¸Ž session å¯¹æ¯” æ€§èƒ½ï¼šJWT è½»é‡çº§ï¼Œè€Œsession ä¼šå ç”¨å¤§é‡æœåŠ¡ç«¯å†…å­˜ï¼› éƒ¨ç½²ï¼šä½¿ç”¨sessionçš„ç³»ç»Ÿ è´Ÿè½½å‡è¡¡éœ€è¦è€ƒè™‘ session å…±äº«ï¼Œè€ŒJWT ä¸éœ€è¦ï¼› å®‰å…¨ï¼šå®‰å…¨æ€§çš„è¯ï¼Œå°å¼Ÿä¸æ•¢å¤šè¯´ï¼Œæˆ‘è§‰å¾—äº”äº”å¼€å§ï¼Œæœ‰äººè¯´ JWT æ³„éœ²çš„è¯ï¼Œç›´æŽ¥å°±å¯ä»¥ç™»å½•äº†ã€‚ä½†æ˜¯ä½¿ç”¨ session å¦‚æžœè¯·æ±‚è¢«æ‹¦æˆªäº†éƒ½æ˜¯ä¸€æ ·çš„ï¼› åœºæ™¯ï¼šAPP ä¸­ç”±äºŽæ²¡æœ‰cookieå§ï¼Œå¤šæ˜¯ä½¿ç”¨tokenã€‚è€Œ web åº”ç”¨çš„è¯ï¼Œä½¿ç”¨ token å’Œ session éƒ½æ˜¯å¯ä»¥çš„ã€‚ å®žçŽ°æ€è·¯ç®€å•ä¸€å¥è¯å°±æ˜¯ï¼Œç™»å½•ä¹‹åŽæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯é¢å‘JWTï¼Œå®¢æˆ·ç«¯å°† JWT æ”¾åœ¨è¯·æ±‚å¤´ä¸­ï¼ŒæœåŠ¡ç«¯ filter æ ¡éªŒhttp headerä¸­çš„JWTã€‚ æŸ¥é˜…äº†ä¸€äº›èµ„æ–™åŽå‘çŽ°ä¸€äº›åˆ†æ­§ æ–¹æ¡ˆ1ï¼š æœ‰çš„æœ‹å‹è®¤ä¸ºæœåŠ¡ç«¯ä¸éœ€è¦å­˜å‚¨ JWTï¼Œåªåœ¨ filter æ ¡éªŒçš„æ—¶å€™è§£æžæ— è¯¯ï¼Œå³è®¤ä¸º JWT æ˜¯å¯ç”¨çš„ã€‚åœ¨éœ€è¦é‡ç½® JWT çš„æ—¶å€™ï¼ˆä¾‹å¦‚æ³¨é”€ï¼‰ï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨åˆ é™¤JWTã€‚è¿™ç§åšæ³•å¼•å‘çš„é—®é¢˜ï¼Œä¾‹å¦‚åœ¨æ³¨é”€äº†ä¹‹åŽï¼Œtoken ä¾ç„¶å¯ç”¨ï¼Œç”±äºŽæœåŠ¡ç«¯æ²¡æœ‰å­˜å‚¨ tokenï¼Œæ— æ³•åŽ»æ ¡éªŒã€‚äºŽæ˜¯ä¹Žæœ‰äº†æ–¹æ¡ˆ2 æ–¹æ¡ˆ2ï¼šæœåŠ¡ç«¯æ•°æ®åº“ä¸­å­˜å‚¨ JWTï¼Œfilter æ¯æ¬¡æ ¡éªŒ token ä¸Žæ•°æ®åº“ä¸­æ˜¯å¦ä¸€è‡´ï¼Œè¿™ç§åšæ³•è™½ç„¶ç¨³å¦¥ï¼Œä½†æ˜¯åœ¨æ€§èƒ½ä¸Šä¸€å®šæ˜¯ä¸å¦‚æ–¹æ¡ˆ1çš„ã€‚ demohttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-boot-jwt]]></content>
      <categories>
        <category>æŠ€æœ¯</category>
      </categories>
      <tags>
        <tag>JWT</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot Atomikos å¤šæ•°æ®æºåˆ†å¸ƒå¼äº‹åŠ¡]]></title>
    <url>%2Fpost%2F2727b3ac.html</url>
    <content type="text"><![CDATA[ä¹‹å‰çš„ ã€Šspring åŠ¨æ€åˆ‡æ¢ã€æ·»åŠ æ•°æ®æºå®žçŽ°ä»¥åŠæºç æµ…æžã€‹ ä¸­ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ spring æä¾›çš„ AbstractRoutingDataSource é…ç½®å¤šæ•°æ®æºï¼Œæœ‰äº†å¤šæ•°æ®æºè‡ªç„¶è¦ç®¡ç†äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚ä¸Šç¯‡æ–‡ç« ä¸­æåˆ°è¿‡é…ç½®å¤šæ•°æ®æºçš„ä¸¤ç§æ–¹å¼ ä½¿ç”¨AbstractRoutingDataSource é…ç½®å¤šä¸ª SqlSessionFactory å‰è¨€ç²—ç•¥é˜…è¯»äº†ä¸€ä¸‹springçš„æºç ï¼Œç”±äºŽ spring äº‹åŠ¡çš„æœºåˆ¶ï¼Œåœ¨å¼€å¯äº‹åŠ¡ä¹‹å‰spring ä¼šåŽ»åˆ›å»ºå½“å‰æ•°æ®æºçš„ äº‹åŠ¡objectï¼Œç›´åˆ°äº‹åŠ¡æäº¤ï¼Œspring éƒ½ä¸ä¼šåœ¨ä¹Žä½ æ˜¯å¦åˆ‡æ¢äº†æ•°æ®æºã€‚è¿™å°±å¯¼è‡´äº†ï¼Œä½¿ç”¨ AbstractRouting DataSource æ–¹å¼å¼€å¯äº‹åŠ¡æ—¶ï¼Œåˆ‡æ¢æ•°æ®æºä¸ç”Ÿæ•ˆã€‚å…³äºŽå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥åŽ»é˜…è¯»ä¸€ä¸‹ï¼šhttps://www.jianshu.com/p/61e8961c6154 æœ¬æ–‡åªè®¨è®ºä¸Šè¿°ç¬¬äºŒç§æ–¹å¼ç»“åˆ atomikos ç®¡ç†å¤šæ•°æ®æºäº‹åŠ¡ã€‚ Atomikosæ¥è‡ªï¼šhttp://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-jta.html Atomikos is a popular open source transaction manager which can be embedded into your Spring Boot application. You can use thespring-boot-starter-jta-atomikos Starter to pull in the appropriate Atomikos libraries. Spring Boot auto-configures Atomikos and ensures that appropriate depends-on settings are applied to your Spring beans for correct startup and shutdown ordering. By default, Atomikos transaction logs are written to a transaction-logs directory in your applicationâ€™s home directory (the directory in which your application jar file resides). You can customize the location of this directory by setting a spring.jta.log-dir property in your application.properties file. Properties starting with spring.jta.atomikos.properties can also be used to customize the Atomikos UserTransactionServiceImp. See the AtomikosProperties Javadoc for complete details. å¼•å…¥spring-boot-starter-jta-atomikosï¼Œspring boot ä¸ºæˆ‘ä»¬è‡ªåŠ¨é…ç½®Atomikosï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ spring.jta.xxx ä¿®æ”¹é»˜è®¤é…ç½®ã€‚ Talk is cheap. Show me the code demoæºç ï¼šhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-atomikos æ·»åŠ  maven ä¾èµ– 12345678910&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jta-atomikos&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;1.1.1&lt;/version&gt;&lt;/dependency&gt; application.properties 1234567891011121314151617181920212223242526272829303132333435363738394041424344#spring.jta.log-dir=classpath:tx-logsspring.jta.transaction-manager-id=txManagerspring.datasource.druid.system-db.name=system-dbspring.datasource.druid.system-db.url=jdbc:mysql://localhost:3306/test1?useSSL=falsespring.datasource.druid.system-db.username=rootspring.datasource.druid.system-db.password=taven753spring.datasource.druid.system-db.initialSize=5spring.datasource.druid.system-db.minIdle=5spring.datasource.druid.system-db.maxActive=20spring.datasource.druid.system-db.maxWait=60000spring.datasource.druid.system-db.timeBetweenEvictionRunsMillis=60000spring.datasource.druid.system-db.minEvictableIdleTimeMillis=30000spring.datasource.druid.system-db.validationQuery=SELECT 1spring.datasource.druid.system-db.validationQueryTimeout=10000spring.datasource.druid.system-db.testWhileIdle=truespring.datasource.druid.system-db.testOnBorrow=falsespring.datasource.druid.system-db.testOnReturn=falsespring.datasource.druid.system-db.poolPreparedStatements=truespring.datasource.druid.system-db.maxPoolPreparedStatementPerConnectionSize=20spring.datasource.druid.system-db.filters=stat,wallspring.datasource.druid.system-db.connectionProperties=druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000spring.datasource.druid.system-db.useGlobalDataSourceStat=truespring.datasource.druid.business-db.name=business-dbspring.datasource.druid.business-db.url=jdbc:mysql://localhost:3306/test2?useSSL=falsespring.datasource.druid.business-db.username=rootspring.datasource.druid.business-db.password=taven753spring.datasource.druid.business-db.initialSize=5spring.datasource.druid.business-db.minIdle=5spring.datasource.druid.business-db.maxActive=20spring.datasource.druid.business-db.maxWait=60000spring.datasource.druid.business-db.timeBetweenEvictionRunsMillis=60000spring.datasource.druid.business-db.minEvictableIdleTimeMillis=30000spring.datasource.druid.business-db.validationQuery=SELECT 1spring.datasource.druid.business-db.validationQueryTimeout=10000spring.datasource.druid.business-db.testWhileIdle=truespring.datasource.druid.business-db.testOnBorrow=falsespring.datasource.druid.business-db.testOnReturn=falsespring.datasource.druid.business-db.poolPreparedStatements=truespring.datasource.druid.business-db.maxPoolPreparedStatementPerConnectionSize=20spring.datasource.druid.business-db.filters=stat,wallspring.datasource.druid.business-db.connectionProperties=druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000spring.datasource.druid.business-db.useGlobalDataSourceStat=true system æ•°æ®æºçš„é…ç½®ç±» 12345678910111213141516171819202122232425262728293031323334353637383940414243import javax.sql.DataSource;import org.apache.ibatis.session.SqlSessionFactory;import org.mybatis.spring.SqlSessionFactoryBean;import org.mybatis.spring.annotation.MapperScan;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.jta.atomikos.AtomikosDataSourceBean;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.context.annotation.Primary;import com.gitee.taven.config.prop.SystemProperties;import com.gitee.taven.utils.PojoUtil;@Configuration@MapperScan(basePackages = SystemDataSourceConfig.PACKAGE, sqlSessionFactoryRef = "systemSqlSessionFactory")public class SystemDataSourceConfig &#123; static final String PACKAGE = "com.gitee.taven.mapper.system"; @Autowired private SystemProperties systemProperties; @Bean(name = "systemDataSource") @Primary public DataSource systemDataSource() &#123; AtomikosDataSourceBean ds = new AtomikosDataSourceBean(); ds.setXaProperties(PojoUtil.obj2Properties(systemProperties)); ds.setXaDataSourceClassName("com.alibaba.druid.pool.xa.DruidXADataSource"); ds.setUniqueResourceName("systemDataSource"); ds.setPoolSize(5); return ds; &#125; @Bean @Primary public SqlSessionFactory systemSqlSessionFactory() throws Exception &#123; SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean(); sqlSessionFactoryBean.setDataSource(systemDataSource()); return sqlSessionFactoryBean.getObject(); &#125; &#125; business æ•°æ®æºçš„é…ç½®ç±»åŒä¸Š çœç•¥äº† mybatis ä»£ç ï¼Œé€šè¿‡service æµ‹è¯•äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸åŽï¼Œäº‹åŠ¡ä¼šå›žæ»š 1234567891011121314151617181920212223@Servicepublic class UserService &#123; @Autowired private UsersMapper usersMapper; @Autowired private UserInformationsMapper userInformationsMapper; @Transactional public void testJTA() &#123; Users u = new Users(); u.setUsername("hmj"); u.setPassword("hmjbest"); usersMapper.insertSelective(u); UserInformations ui = new UserInformations(); ui.setUserid(666l); ui.setEmail("dsb"); userInformationsMapper.insertSelective(ui); // int i = 10/0; &#125; &#125; demoæºç ï¼šhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-atomikos]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>å¤šæ•°æ®æº</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot å¤šçº¿ç¨‹å¼‚æ­¥è°ƒç”¨---æé«˜ç¨‹åºæ‰§è¡Œæ•ˆçŽ‡]]></title>
    <url>%2Fpost%2F574b9274.html</url>
    <content type="text"><![CDATA[åŽŸæ–‡ï¼šhttps://spring.io/guides/gs/async-method/ ä¸ºä»€ä¹ˆè¦ç”¨å¼‚æ­¥ï¼Ÿå½“éœ€è¦è°ƒç”¨å¤šä¸ªæœåŠ¡æ—¶ï¼Œä½¿ç”¨ä¼ ç»Ÿçš„åŒæ­¥è°ƒç”¨æ¥æ‰§è¡Œæ—¶ï¼Œæ˜¯è¿™æ ·çš„ è°ƒç”¨æœåŠ¡A ç­‰å¾…æœåŠ¡Açš„å“åº” è°ƒç”¨æœåŠ¡B ç­‰å¾…æœåŠ¡Bçš„å“åº” è°ƒç”¨æœåŠ¡C ç­‰å¾…æœåŠ¡Cçš„å“åº” æ ¹æ®ä»ŽæœåŠ¡Aã€æœåŠ¡Bå’ŒæœåŠ¡Cè¿”å›žçš„æ•°æ®å®Œæˆä¸šåŠ¡é€»è¾‘ï¼Œç„¶åŽç»“æŸ å¦‚æžœæ¯ä¸ªæœåŠ¡éœ€è¦3ç§’çš„å“åº”æ—¶é—´ï¼Œè¿™æ ·é¡ºåºæ‰§è¡Œä¸‹æ¥ï¼Œå¯èƒ½éœ€è¦9ç§’ä»¥ä¸Šæ‰èƒ½å®Œæˆä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯å¦‚æžœæˆ‘ä»¬ä½¿ç”¨å¼‚æ­¥è°ƒç”¨ è°ƒç”¨æœåŠ¡A è°ƒç”¨æœåŠ¡B è°ƒç”¨æœåŠ¡C ç„¶åŽç­‰å¾…ä»ŽæœåŠ¡Aã€Bå’ŒCçš„å“åº” æ ¹æ®ä»ŽæœåŠ¡Aã€æœåŠ¡Bå’ŒæœåŠ¡Cè¿”å›žçš„æ•°æ®å®Œæˆä¸šåŠ¡é€»è¾‘ï¼Œç„¶åŽç»“æŸ ç†è®ºä¸Š 3ç§’å·¦å³å³å¯å®ŒæˆåŒæ ·çš„ä¸šåŠ¡é€»è¾‘ Talk is cheap. Show me the code123456789101112131415161718192021222324252627public class User &#123; private String name; private String blog; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125; public String getBlog() &#123; return blog; &#125; public void setBlog(String blog) &#123; this.blog = blog; &#125; @Override public String toString() &#123; return "User [name=" + name + ", blog=" + blog + "]"; &#125;&#125; 12345678910111213141516171819202122232425262728293031import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.boot.web.client.RestTemplateBuilder;import org.springframework.scheduling.annotation.Async;import org.springframework.stereotype.Service;import org.springframework.web.client.RestTemplate;import java.util.concurrent.CompletableFuture;@Servicepublic class GitHubLookupService &#123; private static final Logger logger = LoggerFactory.getLogger(GitHubLookupService.class); private final RestTemplate restTemplate; public GitHubLookupService(RestTemplateBuilder restTemplateBuilder) &#123; this.restTemplate = restTemplateBuilder.build(); &#125; @Async public CompletableFuture&lt;User&gt; findUser(String user) throws InterruptedException &#123; logger.info("Looking up " + user); String url = String.format("https://api.github.com/users/%s", user); User results = restTemplate.getForObject(url, User.class); // Artificial delay of 3s for demonstration purposes Thread.sleep(3000L); return CompletableFuture.completedFuture(results); &#125;&#125; The findUser method is flagged with Springâ€™s @Async annotation, indicating it will run on a separate thread. The methodâ€™s return type is CompletableFuture&lt;User&gt; instead of User, a requirement for any asynchronous service. findUser æ–¹æ³•è¢«æ ‡è®°ä¸ºSpringçš„ @Async æ³¨è§£ï¼Œè¡¨ç¤ºå®ƒå°†åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸Šè¿è¡Œã€‚è¯¥æ–¹æ³•çš„è¿”å›žç±»åž‹æ˜¯ CompleetableFuture&lt;user&gt; è€Œä¸æ˜¯ Userï¼Œè¿™æ˜¯ä»»ä½•å¼‚æ­¥æœåŠ¡çš„è¦æ±‚ã€‚ 1234567891011121314151617181920212223242526272829import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.context.annotation.Bean;import org.springframework.scheduling.annotation.EnableAsync;import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;import java.util.concurrent.Executor;@SpringBootApplication@EnableAsyncpublic class App &#123; public static void main(String[] args) &#123; // close the application context to shut down the custom ExecutorService SpringApplication.run(App.class, args).close(); &#125; @Bean public Executor asyncExecutor() &#123; ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(2); executor.setMaxPoolSize(2); executor.setQueueCapacity(500); executor.setThreadNamePrefix("GithubLookup-"); executor.initialize(); return executor; &#125;&#125; The @EnableAsync annotation switches on Springâ€™s ability to run @Async methods in a background thread pool. This class also customizes the used Executor. In our case, we want to limit the number of concurrent threads to 2 and limit the size of the queue to 500. There are many more things you can tune. By default, a SimpleAsyncTaskExecutor is used. @EnableAsync æ³¨è§£å¼€å¯Springåœ¨åŽå°çº¿ç¨‹æ± ä¸­è¿è¡Œ @Async æ–¹æ³•çš„èƒ½åŠ›ã€‚è¯¥ç±»ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä½¿ç”¨çš„ Executorã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å¹¶å‘çº¿ç¨‹çš„æ•°é‡é™åˆ¶ä¸º2ï¼Œå¹¶å°†é˜Ÿåˆ—çš„å¤§å°é™åˆ¶ä¸º500ã€‚æœ‰å¾ˆå¤šä½ å¯ä»¥é…ç½®çš„ä¸œè¥¿)ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨SimpleAsyncTaskExecutorã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243import java.util.concurrent.CompletableFuture;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.boot.CommandLineRunner;import org.springframework.stereotype.Component;import com.gitee.taven.entity.User;import com.gitee.taven.service.GitHubLookupService;@Componentpublic class AppRunner implements CommandLineRunner &#123; private static final Logger logger = LoggerFactory.getLogger(AppRunner.class); private final GitHubLookupService gitHubLookupService; public AppRunner(GitHubLookupService gitHubLookupService) &#123; this.gitHubLookupService = gitHubLookupService; &#125; @Override public void run(String... args) throws Exception &#123; // Start the clock long start = System.currentTimeMillis(); // Kick of multiple, asynchronous lookups CompletableFuture&lt;User&gt; page1 = gitHubLookupService.findUser("PivotalSoftware"); CompletableFuture&lt;User&gt; page2 = gitHubLookupService.findUser("CloudFoundry"); CompletableFuture&lt;User&gt; page3 = gitHubLookupService.findUser("Spring-Projects"); // Wait until they are all done CompletableFuture.allOf(page1,page2,page3).join(); // Print results, including elapsed time float exc = (float)(System.currentTimeMillis() - start)/1000; logger.info("Elapsed time: " + exc + " seconds"); logger.info("--&gt; " + page1.get()); logger.info("--&gt; " + page2.get()); logger.info("--&gt; " + page3.get()); &#125; &#125; é€šè¿‡å®žçŽ° CommandLineRunner è°ƒç”¨ service æœåŠ¡ï¼Œæˆ‘ä»¬è®¾ç½®äº† Thread.sleep(3000L); è¿è¡Œdemoï¼Œ4.73s ç»“æŸæˆ˜æ–—ï¼ æœ¬æ–‡demohttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-async-demo]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring åŠ¨æ€åˆ‡æ¢ã€æ·»åŠ æ•°æ®æºå®žçŽ°ä»¥åŠæºç æµ…æž]]></title>
    <url>%2Fpost%2F9ffabefe.html</url>
    <content type="text"><![CDATA[å…¬å¸é¡¹ç›®éœ€æ±‚ï¼Œç”±äºŽè¦å…¼å®¹è€ç³»ç»Ÿçš„æ•°æ®åº“ç»“æž„ï¼Œéœ€è¦æ­å»ºä¸€ä¸ª å¯ä»¥åŠ¨æ€åˆ‡æ¢ã€æ·»åŠ æ•°æ®æºçš„åŽç«¯æœåŠ¡ã€‚ åˆ†æžå‚è€ƒäº†è¿‡åŽ»çš„é¡¹ç›®ï¼Œé€šè¿‡é…ç½®å¤šä¸ªSqlSessionFactory æ¥å®žçŽ°å¤šæ•°æ®æºï¼Œè¿™ä¹ˆåšçš„è¯ï¼Œæœªå…è¿‡äºŽç¬¨é‡ï¼Œè€Œä¸”æ— æ³•å®žçŽ°åŠ¨æ€æ·»åŠ æ•°æ®æºè¿™ä¸ªéœ€æ±‚é€šè¿‡ spring AbstractRoutingDataSource ä¸ºæˆ‘ä»¬æŠ½è±¡äº†ä¸€ä¸ª DynamicDataSource è§£å†³è¿™ä¸€é—®é¢˜ æºç ç®€å•åˆ†æžä¸‹ AbstractRoutingDataSource çš„æºç  targetDataSources å°±æ˜¯æˆ‘ä»¬çš„å¤šä¸ªæ•°æ®æºï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨afterPropertiesSet()ï¼ŒåŽ»è§£æžæˆ‘ä»¬çš„æ•°æ®æº ç„¶åŽ put åˆ° resolvedDataSources å®žçŽ°äº† DataSource çš„ getConnection(); æˆ‘ä»¬çœ‹çœ‹ determineTargetDataSource(); åšäº†ä»€ä¹ˆ é€šè¿‡ä¸‹é¢çš„ determineCurrentLookupKey();ï¼ˆè¿™ä¸ªæ–¹æ³•éœ€è¦æˆ‘ä»¬å®žçŽ°ï¼‰ è¿”å›žä¸€ä¸ªkeyï¼Œç„¶åŽä»Ž resolvedDataSources ï¼ˆå…¶å®žä¹Ÿå°±æ˜¯ targetDataSourcesï¼‰ ä¸­ get ä¸€ä¸ªæ•°æ®æºï¼Œå®žçŽ°äº†æ¯æ¬¡è°ƒç”¨ getConnection(); æ‰“å¼€è¿žæŽ¥ åˆ‡æ¢æ•°æ®æºï¼Œå¦‚æžœæƒ³åŠ¨æ€æ·»åŠ çš„è¯ åªéœ€è¦é‡æ–° set targetDataSources å†è°ƒç”¨ afterPropertiesSet() å³å¯ Talk is cheap. Show me the codeæˆ‘ä½¿ç”¨çš„springbootç‰ˆæœ¬ä¸º 1.5.xï¼Œä¸‹é¢æ˜¯æ ¸å¿ƒä»£ç å®Œæ•´ä»£ç ï¼šhttps://gitee.com/yintianwen7/spring-dynamic-datasource123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778/** * å¤šæ•°æ®æºé…ç½® * * @author Taven * */@Configuration@MapperScan("com.gitee.taven.mapper")public class DataSourceConfigurer &#123; /** * DataSource è‡ªåŠ¨é…ç½®å¹¶æ³¨å†Œ * * @return data source */ @Bean("db0") @Primary @ConfigurationProperties(prefix = "datasource.db0") public DataSource dataSource0() &#123; return DruidDataSourceBuilder.create().build(); &#125; /** * DataSource è‡ªåŠ¨é…ç½®å¹¶æ³¨å†Œ * * @return data source */ @Bean("db1") @ConfigurationProperties(prefix = "datasource.db1") public DataSource dataSource1() &#123; return DruidDataSourceBuilder.create().build(); &#125; /** * æ³¨å†ŒåŠ¨æ€æ•°æ®æº * * @return */ @Bean("dynamicDataSource") public DataSource dynamicDataSource() &#123; DynamicRoutingDataSource dynamicRoutingDataSource = new DynamicRoutingDataSource(); Map&lt;Object, Object&gt; dataSourceMap = new HashMap&lt;&gt;(); dataSourceMap.put("dynamic_db0", dataSource0()); dataSourceMap.put("dynamic_db1", dataSource1()); dynamicRoutingDataSource.setDefaultTargetDataSource(dataSource0());// è®¾ç½®é»˜è®¤æ•°æ®æº dynamicRoutingDataSource.setTargetDataSources(dataSourceMap); return dynamicRoutingDataSource; &#125; /** * Sql session factory bean. * Here to config datasource for SqlSessionFactory * &lt;p&gt; * You need to add @&#123;@code @ConfigurationProperties(prefix = "mybatis")&#125;, if you are using *.xml file, * the &#123;@code 'mybatis.type-aliases-package'&#125; and &#123;@code 'mybatis.mapper-locations'&#125; should be set in * &#123;@code 'application.properties'&#125; file, or there will appear invalid bond statement exception * * @return the sql session factory bean */ @Bean @ConfigurationProperties(prefix = "mybatis") public SqlSessionFactoryBean sqlSessionFactoryBean() &#123; SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean(); // å¿…é¡»å°†åŠ¨æ€æ•°æ®æºæ·»åŠ åˆ° sqlSessionFactoryBean sqlSessionFactoryBean.setDataSource(dynamicDataSource()); return sqlSessionFactoryBean; &#125; /** * äº‹åŠ¡ç®¡ç†å™¨ * * @return the platform transaction manager */ @Bean public PlatformTransactionManager transactionManager() &#123; return new DataSourceTransactionManager(dynamicDataSource()); &#125;&#125; é€šè¿‡ ThreadLocal èŽ·å–çº¿ç¨‹å®‰å…¨çš„æ•°æ®æº key12345678910111213141516171819202122232425262728293031323334353637package com.gitee.taven.config;public class DynamicDataSourceContextHolder &#123; private static final ThreadLocal&lt;String&gt; contextHolder = new ThreadLocal&lt;String&gt;() &#123; @Override protected String initialValue() &#123; return "dynamic_db0"; &#125; &#125;; /** * To switch DataSource * * @param key the key */ public static void setDataSourceKey(String key) &#123; contextHolder.set(key); &#125; /** * Get current DataSource * * @return data source key */ public static String getDataSourceKey() &#123; return contextHolder.get(); &#125; /** * To set DataSource as default */ public static void clearDataSourceKey() &#123; contextHolder.remove(); &#125;&#125; åŠ¨æ€ æ·»åŠ ã€åˆ‡æ¢æ•°æ®æº123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081/** * åŠ¨æ€æ•°æ®æº * * @author Taven * */public class DynamicRoutingDataSource extends AbstractRoutingDataSource &#123; private final Logger logger = LoggerFactory.getLogger(getClass()); private static Map&lt;Object, Object&gt; targetDataSources = new HashMap&lt;&gt;(); /** * è®¾ç½®å½“å‰æ•°æ®æº * * @return */ @Override protected Object determineCurrentLookupKey() &#123; logger.info("Current DataSource is [&#123;&#125;]", DynamicDataSourceContextHolder.getDataSourceKey()); return DynamicDataSourceContextHolder.getDataSourceKey(); &#125; @Override public void setTargetDataSources(Map&lt;Object, Object&gt; targetDataSources) &#123; super.setTargetDataSources(targetDataSources); DynamicRoutingDataSource.targetDataSources = targetDataSources; &#125; /** * æ˜¯å¦å­˜åœ¨å½“å‰keyçš„ DataSource * * @param key * @return å­˜åœ¨è¿”å›ž true, ä¸å­˜åœ¨è¿”å›ž false */ public static boolean isExistDataSource(String key) &#123; return targetDataSources.containsKey(key); &#125; /** * åŠ¨æ€å¢žåŠ æ•°æ®æº * * @param map æ•°æ®æºå±žæ€§ * @return */ public synchronized boolean addDataSource(Map&lt;String, String&gt; map) &#123; try &#123; Connection connection = null; // æŽ’é™¤è¿žæŽ¥ä¸ä¸Šçš„é”™è¯¯ try &#123; Class.forName(map.get(DruidDataSourceFactory.PROP_DRIVERCLASSNAME)); connection = DriverManager.getConnection( map.get(DruidDataSourceFactory.PROP_URL), map.get(DruidDataSourceFactory.PROP_USERNAME), map.get(DruidDataSourceFactory.PROP_PASSWORD)); System.out.println(connection.isClosed()); &#125; catch (Exception e) &#123; return false; &#125; finally &#123; if (connection != null &amp;&amp; !connection.isClosed()) connection.close(); &#125; String database = map.get("database");//èŽ·å–è¦æ·»åŠ çš„æ•°æ®åº“å if (StringUtils.isBlank(database)) return false; if (DynamicRoutingDataSource.isExistDataSource(database)) return true; DruidDataSource druidDataSource = (DruidDataSource) DruidDataSourceFactory.createDataSource(map); druidDataSource.init(); Map&lt;Object, Object&gt; targetMap = DynamicRoutingDataSource.targetDataSources; targetMap.put(database, druidDataSource); // å½“å‰ targetDataSources ä¸Ž çˆ¶ç±» targetDataSources ä¸ºåŒä¸€å¯¹è±¡ æ‰€ä»¥ä¸éœ€è¦set// this.setTargetDataSources(targetMap); this.afterPropertiesSet(); logger.info("dataSource &#123;&#125; has been added", database); &#125; catch (Exception e) &#123; logger.error(e.getMessage()); return false; &#125; return true; &#125; &#125; å¯ä»¥é€šè¿‡ AOP æˆ–è€… æ‰‹åŠ¨ DynamicDataSourceContextHolder.setDataSourceKey(String key) åˆ‡æ¢æ•°æ®æº éœ€è¦æ³¨æ„çš„ï¼šå½“æˆ‘ä»¬å¼€å¯äº†äº‹åŠ¡ä¹‹åŽï¼Œæ˜¯æ— æ³•åœ¨åŽ»åˆ‡æ¢æ•°æ®æºçš„ æœ¬æ–‡é¡¹ç›®æºç ï¼šhttps://gitee.com/yintianwen7/spring-dynamic-datasourceå‚è€ƒæ–‡çŒ®ï¼šhttps://github.com/helloworlde/SpringBoot-DynamicDataSource]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>å¤šæ•°æ®æº</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Service è°ƒç”¨å½“å‰ç±»æ–¹æ³•äº‹åŠ¡ä¸ç”Ÿæ•ˆ]]></title>
    <url>%2Fpost%2Ff2e584e4.html</url>
    <content type="text"><![CDATA[ä»Šå¤©åœ¨æµ‹è¯•æ¡†æž¶çš„æ—¶å€™ï¼Œæˆ‘æƒ³åœ¨ä¸€ä¸ªserviceç±»çš„æ–¹æ³•ä¸­è°ƒç”¨ å½“å‰ç±»çš„å¦ä¸€ä¸ªæ–¹æ³•ï¼ˆè¯¥æ–¹æ³•é€šè¿‡@Transactionalå¼€å¯äº‹åŠ¡ï¼‰ï¼Œè¿™æ—¶å€™å‘çŽ°è¢«è°ƒç”¨ç±»çš„äº‹åŠ¡å¹¶æ²¡æœ‰ç”Ÿæ•ˆã€‚ 1234567891011public boolean test1() &#123; // xxx ä¸šåŠ¡é€»è¾‘ return test2();&#125;@Transactionalpublic boolean test2() &#123; testMapper.insertSalary(&quot;test&quot;, UUID.randomUUID().toString()); int a = 10/0; return true;&#125; WHY? æœç´¢å¼•æ“Žä¸€ç•ªæŸ¥è¯¢ä¹‹åŽï¼Œäº†è§£åˆ°é—®é¢˜çš„å…³é”®ï¼š@Transactional æ˜¯åŸºäºŽaopç”Ÿçš„ä»£ç†å¯¹è±¡å¼€å¯äº‹åŠ¡çš„PS:ä¸äº†è§£ä»£ç†æ¨¡å¼çš„å°ä¼™ä¼´ï¼Œç»“å°¾æœ‰ä¼ é€é—¨ æ€è·¯ spring çš„äº‹åŠ¡æ˜¯é€šè¿‡ aop ç®¡ç†çš„ aop ä¼šé€šè¿‡åŠ¨æ€ä»£ç† ä¸ºæˆ‘ä»¬ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œaop çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚äº‹åŠ¡ï¼‰éƒ½æ˜¯åœ¨ä»£ç†å¯¹è±¡ä¸­å®žçŽ°çš„ aop ç”Ÿæˆçš„ä»£ç†ç±»åˆåœ¨ spring å®¹å™¨ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦åœ¨ spring å®¹å™¨ä¸­æ‹¿åˆ°å½“å‰è¿™ä¸ªbean å†åŽ»è°ƒç”¨ test2() å°±å¯ä»¥å¼€å¯äº‹åŠ¡äº†ã€‚ è§£å†³123456789101112131415161718192021222324252627282930313233343536373839404142import org.springframework.beans.BeansException;import org.springframework.context.ApplicationContext;import org.springframework.context.ApplicationContextAware;import org.springframework.stereotype.Component;/** * Springçš„ApplicationContextçš„æŒæœ‰è€…,å¯ä»¥ç”¨é™æ€æ–¹æ³•çš„æ–¹å¼èŽ·å–springå®¹å™¨ä¸­çš„bean * */@Componentpublic class SpringContextHolder implements ApplicationContextAware &#123; private static ApplicationContext applicationContext; @Override public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123; SpringContextHolder.applicationContext = applicationContext; &#125; public static ApplicationContext getApplicationContext() &#123; assertApplicationContext(); return applicationContext; &#125; @SuppressWarnings("unchecked") public static &lt;T&gt; T getBean(String beanName) &#123; assertApplicationContext(); return (T) applicationContext.getBean(beanName); &#125; public static &lt;T&gt; T getBean(Class&lt;T&gt; requiredType) &#123; assertApplicationContext(); return applicationContext.getBean(requiredType); &#125; private static void assertApplicationContext() &#123; if (SpringContextHolder.applicationContext == null) &#123; throw new RuntimeException("applicaitonContextå±žæ€§ä¸ºnull,è¯·æ£€æŸ¥æ˜¯å¦æ³¨å…¥äº†SpringContextHolder!"); &#125; &#125;&#125; 123456789101112public boolean test1() &#123; // xxx ä¸šåŠ¡é€»è¾‘ // åœ¨springå®¹å™¨ä¸­ èŽ·å–å½“å‰ç±»çš„ä»£ç†ç±» return SpringContextHolder.getBean(TestS.class).test2();&#125;@Transactionalpublic boolean test2() &#123; testMapper.insertSalary(&quot;test&quot;, UUID.randomUUID().toString()); int a = 10/0; return true;&#125; okï¼æžå®šï¼ ä¼ é€é—¨Spring AOPçš„å®žçŽ°åŽŸç†Java ä»£ç†æ¨¡å¼]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>AOP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[(è½¬)Java ä»£ç†æ¨¡å¼]]></title>
    <url>%2Fpost%2F4dd31fbe.html</url>
    <content type="text"><![CDATA[åŽŸæ–‡ï¼šhttps://www.cnblogs.com/cenyu/p/6289209.html ä»£ç†(Proxy)æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡è®¿é—®ç›®æ ‡å¯¹è±¡.è¿™æ ·åšçš„å¥½å¤„æ˜¯:å¯ä»¥åœ¨ç›®æ ‡å¯¹è±¡å®žçŽ°çš„åŸºç¡€ä¸Šï¼Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚ ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜Žï¼šå‡å¦‚è¯´æˆ‘çŽ°åœ¨æƒ³ä¹°ä¸€è¾†äºŒæ‰‹è½¦ï¼Œæœ€ä¾¿æ·çš„æ–¹æ³•ä¸€å®šæ˜¯æˆ‘åŽ»æ‰¾ä¸­ä»‹ï¼Œä»–ä»¬æ¥ç»™æˆ‘åšçç¢Žçš„äº‹æƒ…ï¼Œæˆ‘åªæ˜¯è´Ÿè´£é€‰æ‹©è‡ªå·±å–œæ¬¢çš„è½¦ï¼Œç„¶åŽä»˜é’±å°±å¯ä»¥äº†ã€‚ ä»£ç†å¯¹è±¡æ˜¯å¯¹ç›®æ ‡å¯¹è±¡çš„æ‰©å±•,å¹¶ä¼šè°ƒç”¨ç›®æ ‡å¯¹è±¡ é™æ€ä»£ç†12345public interface IUserDao &#123; void save(); &#125; 12345678public class UserDao implements IUserDao &#123; @Override public void save() &#123; System.out.println(&quot;----å·²ç»ä¿å­˜æ•°æ®!----&quot;); &#125;&#125; 12345678910111213141516public class UserDaoProxy implements IUserDao &#123; //ç›®æ ‡å¯¹è±¡ private IUserDao target; public UserDaoProxy(IUserDao target)&#123; this.target=target; &#125; @Override public void save() &#123; System.out.println(&quot;å¼€å§‹äº‹åŠ¡...&quot;); target.save();//æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³• System.out.println(&quot;æäº¤äº‹åŠ¡...&quot;); &#125;&#125; 12345678@Testpublic void staticProxy() &#123; //ç›®æ ‡å¯¹è±¡ UserDao target = new UserDao(); //ä»£ç†å¯¹è±¡ï¼Œå»ºç«‹ä»£ç†å…³ç³» UserDaoProxy proxy = new UserDaoProxy(target); proxy.save();//æ‰§è¡Œçš„æ˜¯ä»£ç†çš„æ–¹æ³•&#125; é™æ€ä»£ç†çš„ç¼ºç‚¹ï¼šæŽ¥å£æ–°å¢žæ–¹æ³•æ—¶ï¼Œç±»è¿‡å¤šæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ï¼Œè¿‡äºŽç¹çï¼Œä½†æ˜¯é€šè¿‡åŠ¨æ€ä»£ç†æœºåˆ¶å¯ä»¥è§£å†³è¿™ä¸€é—®é¢˜ã€‚ åŠ¨æ€ä»£ç†spring ä¸­ AOP é€šè¿‡ åŠ¨æ€ä»£ç† åœ¨è¿è¡Œæ—¶ä¸ºæˆ‘ä»¬çš„ä»£ç å¢žå¼ºï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨å¼€å‘çš„æ—¶å€™åªéœ€è¦åšä¸šåŠ¡é€»è¾‘ï¼ŒAOP é€šè¿‡åŠ¨æ€ä»£ç†å¯ä»¥ä¸ºæˆ‘ä»¬åšäº‹åŠ¡ï¼Œæ—¥å¿—ç®¡ç†ï¼Œæƒé™æ ¡éªŒç­‰ç­‰ã€‚ jdk åŠ¨æ€ä»£ç†æˆ‘ä»¬ä¸éœ€è¦å†åŽ»æ‰‹åŠ¨åˆ›å»ºä»£ç†ç±»ï¼ˆä½†æ˜¯è¦æ±‚è¢«ä»£ç†ç±»å¿…é¡»å®žçŽ°ä¸€ä¸ªæŽ¥å£ï¼‰ï¼Œåªéœ€è¦åšä¸€ä¸ªåŠ¨æ€ä»£ç†å·¥åŽ‚å³å¯ï¼Œjdké€šè¿‡åå°„ä¸ºæˆ‘ä»¬åœ¨å†…å­˜ä¸­åŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä»¥åŠåœ¨æ–¹æ³•æ‰§è¡Œçš„å‰åŽæ·»åŠ é€šçŸ¥ã€‚1234567891011121314151617181920212223242526272829303132333435import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;/** * åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡ * */public class JdkProxyFactory&#123; //ç»´æŠ¤ä¸€ä¸ªç›®æ ‡å¯¹è±¡ private Object target; public JdkProxyFactory(Object target)&#123; this.target=target; &#125; //ç»™ç›®æ ‡å¯¹è±¡ç”Ÿæˆä»£ç†å¯¹è±¡ public Object getProxyInstance()&#123; return Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), new InvocationHandler() &#123; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; System.out.println("å¼€å§‹äº‹åŠ¡2"); //æ‰§è¡Œç›®æ ‡å¯¹è±¡æ–¹æ³• Object returnValue = method.invoke(target, args); System.out.println("æäº¤äº‹åŠ¡2"); return returnValue; &#125; &#125; ); &#125;&#125; 123456789101112131415@Testpublic void jdkProxy() &#123; // ç›®æ ‡å¯¹è±¡ IUserDao target = new UserDao(); // åŽŸå§‹ç±»åž‹ System.out.println(&quot;åŽŸå§‹ç±»åž‹&quot; + target.getClass()); // ç»™ç›®æ ‡å¯¹è±¡ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡ IUserDao proxy = (IUserDao) new JdkProxyFactory(target).getProxyInstance(); // class $Proxy0 å†…å­˜ä¸­åŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ System.out.println(&quot;åŠ¨æ€ä»£ç†åŽå¯¹è±¡ç±»åž‹:&quot; + proxy.getClass()); // ä»£ç†å¯¹è±¡ æ‰§è¡Œæ–¹æ³• proxy.save();&#125; æ‰§è¡Œæµ‹è¯•æ–¹æ³•12345åŽŸå§‹ç±»åž‹class com.example.demo.original_code.UserDaoåŠ¨æ€ä»£ç†åŽå¯¹è±¡ç±»åž‹:class com.sun.proxy.$Proxy4å¼€å§‹äº‹åŠ¡2----å·²ç»ä¿å­˜æ•°æ®!----æäº¤äº‹åŠ¡2 cglib åŠ¨æ€ä»£ç†é™æ€ä»£ç† å’Œ jdkä»£ç† è¦æ±‚ç›®æ ‡å¯¹è±¡å¿…é¡»å®žçŽ°æŽ¥å£ï¼Œè€Œ cglib åŠ¨æ€ä»£ç†æ— éœ€å®žçŽ°æŽ¥å£ã€‚cglib ä¼šåŠ¨æ€ä¸ºç›®æ ‡å¯¹è±¡ åˆ›å»ºä¸€ä¸ªå­ç±»å¯¹è±¡ã€‚ä½¿ç”¨é¡»çŸ¥ï¼š1.è¢«ä»£ç†çš„ç±»ä¸èƒ½ä¸º final2.è¢«ä»£ç†ç±»çš„æ–¹æ³• ä¸èƒ½ä¸º final/staticï¼Œå¦åˆ™æ— æ³•è¢«æ‹¦æˆª12345678910111213141516171819202122232425262728293031323334353637383940414243import java.lang.reflect.Method;import org.springframework.cglib.proxy.Enhancer;import org.springframework.cglib.proxy.MethodInterceptor;import org.springframework.cglib.proxy.MethodProxy;/** * Cglibå­ç±»ä»£ç†å·¥åŽ‚ * å¯¹UserDaoåœ¨å†…å­˜ä¸­åŠ¨æ€æž„å»ºä¸€ä¸ªå­ç±»å¯¹è±¡ */public class CglibProxyFactory implements MethodInterceptor &#123; //ç»´æŠ¤ç›®æ ‡å¯¹è±¡ private Object target; public CglibProxyFactory(Object target) &#123; this.target = target; &#125; //ç»™ç›®æ ‡å¯¹è±¡åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ public Object getProxyInstance()&#123; //1.å·¥å…·ç±» Enhancer en = new Enhancer(); //2.è®¾ç½®çˆ¶ç±» en.setSuperclass(target.getClass()); //3.è®¾ç½®å›žè°ƒå‡½æ•° en.setCallback(this); //4.åˆ›å»ºå­ç±»(ä»£ç†å¯¹è±¡) return en.create(); &#125; @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable &#123; System.out.println("å¼€å§‹äº‹åŠ¡..."); //æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³• Object returnValue = method.invoke(target, args); System.out.println("æäº¤äº‹åŠ¡..."); return returnValue; &#125;&#125; 1234567891011@Testpublic void cglibProxy() &#123; //ç›®æ ‡å¯¹è±¡ UserDao target = new UserDao(); //ä»£ç†å¯¹è±¡ UserDao proxy = (UserDao) new CglibProxyFactory(target).getProxyInstance(); //æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³• proxy.save();&#125;]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-æŸ¥è¯¢æ ‘ç»“æž„]]></title>
    <url>%2Fpost%2Fa998078e.html</url>
    <content type="text"><![CDATA[åœ¨ oracle æ•°æ®åº“ä¸­ï¼Œé€šè¿‡ start with connect by prior é€’å½’å¯ä»¥ç›´æŽ¥æŸ¥å‡ºæ ‘ç»“æž„ï¼Œä½†æ˜¯åœ¨ mysql å½“ä¸­å¦‚ä½•è§£å†³æ ‘æŸ¥è¯¢é—®é¢˜å‘¢ï¼Ÿ #####æ€è·¯ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰å‡½æ•°ï¼ŒéåŽ†æ‰¾å‡ºæŸä¸€èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ ï¼ˆæˆ–è€…æŸä¸€èŠ‚ç‚¹çš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹ï¼‰çš„å­—ç¬¦ä¸²é›†åˆã€‚ç„¶åŽé€šè¿‡ FIND_IN_SET å‡½æ•°ï¼Œè¿™å°±æŸ¥å‡ºäº†æˆ‘ä»¬æƒ³è¦çš„æ ‘ #####å®žè·µï¼š1ï¼‰å»ºè¡¨ ä»¥åŠ æµ‹è¯•æ•°æ®å‡†å¤‡123456CREATE TABLE `tree` ( `id` int(11) NOT NULL, `pid` int(11) DEFAULT NULL, `name` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8; 12345678INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;1&apos;, NULL, &apos;ä¸€çº§&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;2&apos;, &apos;1&apos;, &apos;äºŒçº§1&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;3&apos;, &apos;2&apos;, &apos;ä¸‰çº§1&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;4&apos;, &apos;3&apos;, &apos;å››çº§1&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;5&apos;, &apos;4&apos;, &apos;äº”çº§&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;6&apos;, &apos;1&apos;, &apos;ä¸‰çº§2&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;7&apos;, &apos;1&apos;, &apos;äºŒçº§2&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;8&apos;, &apos;6&apos;, &apos;å››çº§2&apos;); 2ï¼‰æŸ¥è¯¢ æŸèŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹12345678910111213CREATE FUNCTION `GET_CHILD_NODE`(rootId varchar(100)) RETURNS varchar(2000) BEGIN DECLARE str varchar(2000); DECLARE cid varchar(100); SET str = &apos;$&apos;; SET cid = rootId; WHILE cid is not null DO SET str = concat(str, &apos;,&apos;, cid); SELECT group_concat(id) INTO cid FROM tree where FIND_IN_SET(pid, cid); END WHILE; RETURN str; END ç¬¬ä¸€æ¬¡è¿›å…¥å‡½æ•° cid ä¸ºæ ¹èŠ‚ç‚¹ï¼Œå¼€å§‹å¾ªçŽ¯åŽï¼Œcid ä¸ºæ¯æ¬¡æŸ¥è¯¢ç»“æžœé›† ï¼ˆä¹Ÿå°±æ˜¯å­èŠ‚ç‚¹ï¼‰ï¼Œä¸‹ä¸€æ¬¡ä¼šæŸ¥è¯¢å‡ºæ‰€æœ‰å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ â€¦ ä»¥æ­¤ç±»æŽ¨ï¼Œå½“æ²¡æœ‰å­èŠ‚ç‚¹æ—¶é€€å‡ºå¾ªçŽ¯ï¼Œä¹Ÿå°±å¾—åˆ°äº†æ‰€æœ‰çš„èŠ‚ç‚¹ã€‚12345678910mysql&gt; SELECT * from tree where FIND_IN_SET(id, GET_CHILD_NODE(2));+----+-----+-------+| id | pid | name |+----+-----+-------+| 2 | 1 | äºŒçº§1 || 3 | 2 | ä¸‰çº§1 || 4 | 3 | å››çº§1 || 5 | 4 | äº”çº§ |+----+-----+-------+4 rows in set å†é€šè¿‡è¿™äº›èŠ‚ç‚¹ ç­›é€‰ï¼Œok ! 3ï¼‰æŸ¥è¯¢ æŸèŠ‚ç‚¹çš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹1234567891011121314151617CREATE FUNCTION `GET_PARENT_NODE`(rootId varchar(100)) RETURNS varchar(1000) BEGIN DECLARE fid varchar(100) default &apos;&apos;; DECLARE str varchar(1000) default rootId; WHILE rootId is not null do SET fid =(SELECT pid FROM tree WHERE id = rootId); IF fid is not null THEN SET str = concat(str, &apos;,&apos;, fid); SET rootId = fid; ELSE SET rootId = fid; END IF; END WHILE; return str; END å’Œä¸Šä¸€ä¸ªå‡½æ•°ç±»ä¼¼ï¼Œä¸æ–­çš„éåŽ†åŽ»æ‰¾ çˆ¶idï¼Œç„¶åŽæ‹¼æŽ¥åˆ°å­—ç¬¦ä¸²ä¸­ï¼Œä¸ºç©ºé€€å‡ºå¾ªçŽ¯ã€‚1234567891011mysql&gt; select * from tree where FIND_IN_SET(id, GET_PARENT_NODE(5));+----+------+-------+| id | pid | name |+----+------+-------+| 1 | NULL | ä¸€çº§ || 2 | 1 | äºŒçº§1 || 3 | 2 | ä¸‰çº§1 || 4 | 3 | å››çº§1 || 5 | 4 | äº”çº§ |+----+------+-------+5 rows in set]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ·±å…¥ç†è§£ Dijkstra ç®—æ³•å®žçŽ°åŽŸç†]]></title>
    <url>%2Fpost%2F9186820e.html</url>
    <content type="text"><![CDATA[è¿ªæ°æ–¯ç‰¹æ‹‰(Dijkstra)ç®—æ³•æ˜¯å…¸åž‹æœ€çŸ­è·¯å¾„ç®—æ³•ï¼Œç”¨äºŽè®¡ç®—ä¸€ä¸ªèŠ‚ç‚¹åˆ°å…¶ä»–èŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„ã€‚å®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ä»¥èµ·å§‹ç‚¹ä¸ºä¸­å¿ƒå‘å¤–å±‚å±‚æ‰©å±•(å¹¿åº¦ä¼˜å…ˆæœç´¢æ€æƒ³)ï¼Œç›´åˆ°æ‰©å±•åˆ°ç»ˆç‚¹ä¸ºæ­¢ã€‚ ï¼ˆå—¯ï¼Œç¬¬ä¸€æ®µæ˜¯æŠ„çš„ï¼Œç”±äºŽæœ¬äººç®—æ³•çš„åŸºç¡€æ¯”è¾ƒè–„å¼±ï¼Œæˆ‘ä¼šå°½é‡ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€æ¥è®©å¤§å®¶ç†è§£æœ¬æ–‡ï¼‰ å‚è€ƒåšå®¢:æ•°æ®ç»“æž„â€“Dijkstraç®—æ³•æœ€æ¸…æ¥šçš„è®²è§£ å¤§æ¦‚å°±æ˜¯è¿™æ ·ä¸€ä¸ªæœ‰æƒå›¾ï¼ŒDijkstraç®—æ³•å¯ä»¥è®¡ç®—ä»»æ„èŠ‚ç‚¹åˆ°å…¶ä»–èŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„ ç®—æ³•æ€è·¯ æŒ‡å®šä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¾‹å¦‚æˆ‘ä»¬è¦è®¡ç®— â€˜Aâ€™ åˆ°å…¶ä»–èŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„ å¼•å…¥ä¸¤ä¸ªé›†åˆï¼ˆSã€Uï¼‰ï¼ŒSé›†åˆåŒ…å«å·²æ±‚å‡ºçš„æœ€çŸ­è·¯å¾„çš„ç‚¹ï¼ˆä»¥åŠç›¸åº”çš„æœ€çŸ­é•¿åº¦ï¼‰ï¼ŒUé›†åˆåŒ…å«æœªæ±‚å‡ºæœ€çŸ­è·¯å¾„çš„ç‚¹ï¼ˆä»¥åŠAåˆ°è¯¥ç‚¹çš„è·¯å¾„ï¼Œæ³¨æ„ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒA-&gt;Cç”±äºŽæ²¡æœ‰ç›´æŽ¥ç›¸è¿ž åˆå§‹æ—¶ä¸ºâˆžï¼‰ åˆå§‹åŒ–ä¸¤ä¸ªé›†åˆï¼ŒSé›†åˆåˆå§‹æ—¶ åªæœ‰å½“å‰è¦è®¡ç®—çš„èŠ‚ç‚¹ï¼ŒA-&gt;A = 0ï¼ŒUé›†åˆåˆå§‹æ—¶ä¸º A-&gt;B = 4, A-&gt;C = âˆž, A-&gt;D = 2, A-&gt;E = âˆžï¼Œæ•²é»‘æ¿ï¼ï¼ï¼æŽ¥ä¸‹æ¥è¦è¿›è¡Œæ ¸å¿ƒä¸¤æ­¥éª¤äº† ä»ŽUé›†åˆä¸­æ‰¾å‡ºè·¯å¾„æœ€çŸ­çš„ç‚¹ï¼ŒåŠ å…¥Sé›†åˆï¼Œä¾‹å¦‚ A-&gt;D = 2 æ›´æ–°Ué›†åˆè·¯å¾„ï¼Œif ( &#39;D åˆ° B,C,E çš„è·ç¦»&#39; + &#39;AD è·ç¦»&#39; &lt; &#39;A åˆ° B,C,E çš„è·ç¦»&#39; ) åˆ™æ›´æ–°U å¾ªçŽ¯æ‰§è¡Œ 4ã€5 ä¸¤æ­¥éª¤ï¼Œç›´è‡³éåŽ†ç»“æŸï¼Œå¾—åˆ°A åˆ°å…¶ä»–èŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„ç®—æ³•å›¾è§£1.é€‰å®šAèŠ‚ç‚¹å¹¶åˆå§‹åŒ–ï¼Œå¦‚ä¸Šè¿°æ­¥éª¤3æ‰€ç¤º 2.æ‰§è¡Œä¸Šè¿° 4ã€5ä¸¤æ­¥éª¤ï¼Œæ‰¾å‡ºUé›†åˆä¸­è·¯å¾„æœ€çŸ­çš„èŠ‚ç‚¹D åŠ å…¥Sé›†åˆï¼Œå¹¶æ ¹æ®æ¡ä»¶ if ( &#39;D åˆ° B,C,E çš„è·ç¦»&#39; + &#39;AD è·ç¦»&#39; &lt; &#39;A åˆ° B,C,E çš„è·ç¦»&#39; ) æ¥æ›´æ–°Ué›†åˆ 3.è¿™æ—¶å€™ A-&gt;B, A-&gt;C éƒ½ä¸º3ï¼Œæ²¡å…³ç³»ã€‚å…¶å®žè¿™æ—¶å€™ä»–ä¿©éƒ½æ˜¯æœ€çŸ­è·ç¦»ï¼Œå¦‚æžœä»Žç®—æ³•é€»è¾‘æ¥è®²çš„è¯ï¼Œä¼šå…ˆå–åˆ°Bç‚¹ã€‚è€Œè¿™ä¸ªæ—¶å€™ if æ¡ä»¶å˜æˆäº† if ( &#39;B åˆ° C,E çš„è·ç¦»&#39; + &#39;AB è·ç¦»&#39; &lt; &#39;A åˆ° C,E çš„è·ç¦»&#39; ) ï¼Œå¦‚å›¾æ‰€ç¤ºè¿™æ—¶å€™A-&gt;Bè·ç¦» å…¶å®žä¸º A-&gt;D-&gt;B æ€è·¯å°±æ˜¯è¿™æ ·ï¼Œå¾€åŽå°±æ˜¯å¤§åŒå°å¼‚äº† ç®—æ³•ç»“æŸ ä»£ç å®žçŽ°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public class Dijkstra &#123; public static final int M = 10000; // ä»£è¡¨æ­£æ— ç©· public static void main(String[] args) &#123; // äºŒç»´æ•°ç»„æ¯ä¸€è¡Œåˆ†åˆ«æ˜¯ Aã€Bã€Cã€Dã€E å„ç‚¹åˆ°å…¶ä½™ç‚¹çš„è·ç¦», // A -&gt; A è·ç¦»ä¸º0, å¸¸é‡M ä¸ºæ­£æ— ç©· int[][] weight1 = &#123; &#123;0,4,M,2,M&#125;, &#123;4,0,4,1,M&#125;, &#123;M,4,0,1,3&#125;, &#123;2,1,1,0,7&#125;, &#123;M,M,3,7,0&#125; &#125;; int start = 0; int[] shortPath = dijkstra(weight1, start); for (int i = 0; i &lt; shortPath.length; i++) System.out.println(&quot;ä»Ž&quot; + start + &quot;å‡ºå‘åˆ°&quot; + i + &quot;çš„æœ€çŸ­è·ç¦»ä¸ºï¼š&quot; + shortPath[i]); &#125; public static int[] dijkstra(int[][] weight, int start) &#123; // æŽ¥å—ä¸€ä¸ªæœ‰å‘å›¾çš„æƒé‡çŸ©é˜µï¼Œå’Œä¸€ä¸ªèµ·ç‚¹ç¼–å·startï¼ˆä»Ž0ç¼–å·ï¼Œé¡¶ç‚¹å­˜åœ¨æ•°ç»„ä¸­ï¼‰ // è¿”å›žä¸€ä¸ªint[] æ•°ç»„ï¼Œè¡¨ç¤ºä»Žstartåˆ°å®ƒçš„æœ€çŸ­è·¯å¾„é•¿åº¦ int n = weight.length; // é¡¶ç‚¹ä¸ªæ•° int[] shortPath = new int[n]; // ä¿å­˜startåˆ°å…¶ä»–å„ç‚¹çš„æœ€çŸ­è·¯å¾„ String[] path = new String[n]; // ä¿å­˜startåˆ°å…¶ä»–å„ç‚¹æœ€çŸ­è·¯å¾„çš„å­—ç¬¦ä¸²è¡¨ç¤º for (int i = 0; i &lt; n; i++) path[i] = new String(start + &quot;--&gt;&quot; + i); int[] visited = new int[n]; // æ ‡è®°å½“å‰è¯¥é¡¶ç‚¹çš„æœ€çŸ­è·¯å¾„æ˜¯å¦å·²ç»æ±‚å‡º,1è¡¨ç¤ºå·²æ±‚å‡º // åˆå§‹åŒ–ï¼Œç¬¬ä¸€ä¸ªé¡¶ç‚¹å·²ç»æ±‚å‡º shortPath[start] = 0; visited[start] = 1; for (int count = 1; count &lt; n; count++) &#123; // è¦åŠ å…¥n-1ä¸ªé¡¶ç‚¹ int k = -1; // é€‰å‡ºä¸€ä¸ªè·ç¦»åˆå§‹é¡¶ç‚¹startæœ€è¿‘çš„æœªæ ‡è®°é¡¶ç‚¹ int dmin = Integer.MAX_VALUE; for (int i = 0; i &lt; n; i++) &#123; if (visited[i] == 0 &amp;&amp; weight[start][i] &lt; dmin) &#123; dmin = weight[start][i]; k = i; &#125; &#125; // å°†æ–°é€‰å‡ºçš„é¡¶ç‚¹æ ‡è®°ä¸ºå·²æ±‚å‡ºæœ€çŸ­è·¯å¾„ï¼Œä¸”åˆ°startçš„æœ€çŸ­è·¯å¾„å°±æ˜¯dmin shortPath[k] = dmin; visited[k] = 1; // ä»¥kä¸ºä¸­é—´ç‚¹ï¼Œä¿®æ­£ä»Žstartåˆ°æœªè®¿é—®å„ç‚¹çš„è·ç¦» for (int i = 0; i &lt; n; i++) &#123; //å¦‚æžœ &apos;èµ·å§‹ç‚¹åˆ°å½“å‰ç‚¹è·ç¦»&apos; + &apos;å½“å‰ç‚¹åˆ°æŸç‚¹è·ç¦»&apos; &lt; &apos;èµ·å§‹ç‚¹åˆ°æŸç‚¹è·ç¦»&apos;, åˆ™æ›´æ–° if (visited[i] == 0 &amp;&amp; weight[start][k] + weight[k][i] &lt; weight[start][i]) &#123; weight[start][i] = weight[start][k] + weight[k][i]; path[i] = path[k] + &quot;--&gt;&quot; + i; &#125; &#125; &#125; for (int i = 0; i &lt; n; i++) &#123; System.out.println(&quot;ä»Ž&quot; + start + &quot;å‡ºå‘åˆ°&quot; + i + &quot;çš„æœ€çŸ­è·¯å¾„ä¸ºï¼š&quot; + path[i]); &#125; System.out.println(&quot;=====================================&quot;); return shortPath; &#125; &#125;]]></content>
      <categories>
        <category>æŠ€æœ¯</category>
      </categories>
      <tags>
        <tag>ç®—æ³•</tag>
        <tag>Dijkstra</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot jacksonï¼ˆDateç±»åž‹å…¥å‚ã€æ ¼å¼åŒ–ï¼Œä»¥åŠå¦‚ä½•å¤„ç†nullï¼‰]]></title>
    <url>%2Fpost%2F23d9d33.html</url>
    <content type="text"><![CDATA[é¦–å…ˆï¼Œæˆ‘ä»¬è¦çŸ¥é“ springboot é»˜è®¤ä½¿ç”¨ jackson è§£æž jsonï¼ˆå½“ç„¶è¿™é‡Œä¹Ÿæ˜¯å¯ä»¥é…ç½®ä½¿ç”¨å…¶ä»– json è§£æžæ¡†æž¶ï¼‰ã€‚åœ¨ä¸é…ç½®å…¶ä»– json è§£æžçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ spring boot æä¾›çš„æ³¨è§£å’Œé…ç½® æ¥è®© jackson å¸®åŠ©æˆ‘ä»¬æé«˜å¼€å‘æ•ˆçŽ‡ ä½¿ç”¨ @ResponseBody @RequestBodyï¼Œ Date ç±»åž‹å¯¹è±¡å…¥å‚ï¼Œè¿”å›žjsonæ ¼å¼åŒ–è§£å†³æ–¹æ³•å¦‚ä¸‹: 1. application.propertiesä¸­åŠ å…¥å¦‚ä¸‹ä»£ç 12spring.jackson.date-format=yyyy-MM-dd HH:mm:ssspring.jackson.time-zone=GMT+8 2. å¦‚æžœä¸ªåˆ«å®žä½“éœ€è¦ä½¿ç”¨å…¶ä»–æ ¼å¼çš„ patternï¼Œåœ¨å®žä½“ä¸ŠåŠ å…¥æ³¨è§£å³å¯1234567import org.springframework.format.annotation.DateTimeFormat;import com.fasterxml.jackson.annotation.JsonFormat;public class MrType &#123; @JsonFormat(timezone = "GMT+8",pattern = "yyyy-MM-dd") @DateTimeFormat(pattern="yyyy-MM-dd") private Date createdDate;&#125; å…³äºŽspring boot æ—¶é—´ç±»åž‹æ”¯æŒæˆ‘åšäº†ä»¥ä¸‹æµ‹è¯•ï¼š1) application.properties é…ç½®æ³¨é‡Šï¼Œä¸æ·»åŠ æ³¨è§£ï¼šspring æ— æ³•æŽ¥æ”¶æ—¶é—´å‚æ•°ï¼ˆ400ï¼‰ï¼Œjson è¾“å‡º &quot;2018-03-29T09:45:31.513+0000&quot;2) application.properties é…ç½®å¼€å¯ï¼Œä¸æ·»åŠ æ³¨è§£ï¼šä»…æ”¯æŒ yyyy-MM-dd HH:mm:ss çš„æ ¼å¼å‚æ•°å’Œ json è¾“å‡º3) application.properties é…ç½®å¼€å¯ï¼Œå®žä½“æ·»åŠ  @JsonFormat(pattern = &quot;yyyy-MM-dd&quot;)ï¼Œå®žä½“å¯æŽ¥å— yyyy-MM-dd HH:mm:ss å’Œ yyyy-MM-dd æ ¼å¼çš„å‚æ•°ï¼Œjsonè¾“å‡ºæ ¼å¼ä¸º yyyy-MM-ddï¼Œç”±æ­¤å¯è§@JsonFormatæ˜¯é™åˆ¶Date ç±»åž‹ json è¾“å‡ºçš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå¯¹æŽ¥å—çš„ç±»åž‹ä¹Ÿé€ æˆäº†å½±å“ï¼Ÿæœ‰å¾…è€ƒè¯4) application.properties é…ç½®å¼€å¯ï¼Œå®žä½“æ·»åŠ  @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)ï¼Œç»“æžœä¸Žç¬¬äºŒæ¡æµ‹è¯•ä¸€æ ·ï¼Ÿè²Œä¼¼@DateTimeFormat æ³¨è§£å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿæœ‰å¾…è€ƒè¯5) application.properties é…ç½®å¼€å¯ï¼Œå®žä½“æ·»åŠ  @JsonFormat å’Œ @DateTimeFormat ç»“æžœä¸Žç¬¬ä¸‰æ¡ä¸€æ · ç»“è®ºï¼šå®žé™…é¡¹ç›®ä¸­ application.propertiesè®¾ç½®é€šç”¨æ—¶é—´æ ¼å¼ï¼Œä¸ªåˆ«å±žæ€§éœ€è¦ç‰¹æ®Šå¤„ç†æ—¶ï¼Œæ·»åŠ @JsonFormatï¼ˆ@JsonFormat è‡ªå·±å¥½åƒå°±æŠŠè¿™ä»¶äº‹æžå®šäº†ï¼‰ ä½¿ç”¨ @ResponseBody æ—¶ å¿½ç•¥ json ä¸­å€¼ä¸ºnullçš„å±žæ€§1. application.propertiesä¸­åŠ å…¥å¦‚ä¸‹ä»£ç 1spring.jackson.default-property-inclusion=non-null æˆ–è€…åœ¨ç±»ä¸Šå£°æ˜Ž@JsonInclude(JsonInclude.Include.NON_NULL) 1234567import java.io.Serializable;import com.fasterxml.jackson.annotation.JsonInclude;@JsonInclude(JsonInclude.Include.NON_NULL)//è¯¥æ³¨è§£é…åˆjacksonï¼Œåºåˆ—åŒ–æ—¶å¿½ç•¥ nullå±žæ€§public class AjaxResult implements Serializable &#123;&#125;]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>jackson</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-å¹¶å‘ä¸‹ç”Ÿæˆä¸é‡å¤æµæ°´å·]]></title>
    <url>%2Fpost%2Fef3d0933.html</url>
    <content type="text"><![CDATA[æ›´æ–°äºŽ 2018-12-23 22:21:44å‰è¨€ï¼šä¸€å¹´å‰çš„å†™çš„ï¼Œå½“æ—¶çš„åšæ³•å¹¶ä¸èƒ½åœ¨å¹¶å‘ä¸‹ä¿è¯æµæ°´å·çš„å”¯ä¸€æ€§ï¼Œå› ä¸ºå½“æ—¶å¹¶æ²¡æœ‰å†™å¤šçº¿ç¨‹æµ‹è¯•è¿‡â€¦ æ€è·¯ sCode sName sQz sValue order è®¢å• DD 18120100 é¦–å…ˆæ¯ä¸ªä¸šåŠ¡çš„æµæ°´å·å¯¹åº”è¡¨ä¸­çš„ä¸€æ¡æ•°æ® æ¯ä¸ªè¦èŽ·å–æµæ°´å·çš„çº¿ç¨‹è°ƒç”¨ ä¸€ä¸ªç”¨æ¥ç”Ÿæˆæµæ°´å·çš„ å­˜å‚¨è¿‡ç¨‹ æ ¹æ®sCode æ‰¾åˆ° sValueã€‚1234if (sValue == null) åˆå§‹åŒ–å€¼ else sValue ++ æ•²é»‘æ¿ï¼åˆ’é‡ç‚¹ï¼ åˆ†æžï¼šä¸Šè¿°çš„æ€è·¯çœ‹ä¼¼æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¦‚æžœä¸¤ä¸ªçº¿ç¨‹å¹¶å‘çš„æ‰§è¡Œä¼šå‡ºçŽ°ä¸¤ä¸ªäº‹åŠ¡è¯»å–åˆ°ç›¸åŒçš„æ•°æ®ï¼ŒåŒæ—¶éƒ½æ‰§è¡Œåˆå§‹åŒ–æˆ–è€…è‡ªå¢žã€‚ æ–¹æ¡ˆï¼šä½¿ç”¨ MySQL å†™é”ï¼ˆselectâ€¦for updateï¼Œä¹Ÿå«Xé”ï¼ŒæŽ’å®ƒé”ï¼‰ æ¥è§£å†³è¿™ä¸€é—®é¢˜ ä¾‹å¦‚ï¼šäº‹åŠ¡Aå’Œäº‹åŠ¡BåŒæ—¶è¿›è¡Œï¼Œäº‹åŠ¡A æ‹¿åˆ° å½“å‰è¿™æ¡æ•°æ®çš„å†™é”ï¼Œæ­¤æ—¶å¦‚æžœäº‹åŠ¡B æƒ³è®¿é—®è¿™æ¡æ•°æ®éœ€è¦ç­‰å¾…äº‹åŠ¡Aç»“æŸã€‚å¹¶å‘æ—¶è®©ä¸¤ä¸ªäº‹åŠ¡å¯¹åŒä¸€æ¡æ•°æ®çš„æ“ä½œå˜æˆäº†ä¸²è¡ŒåŒ–ã€‚ 123456CREATE TABLE `sys_sno` ( `sCode` varchar(50) DEFAULT NULL COMMENT &apos;ç¼–ç &apos;, `sName` varchar(100) DEFAULT NULL COMMENT &apos;åç§°&apos;, `sQz` varchar(50) DEFAULT NULL COMMENT &apos;å‰ç¼€&apos;, `sValue` varchar(80) DEFAULT NULL COMMENT &apos;å€¼&apos;) ENGINE=InnoDB DEFAULT CHARSET=utf8; 123456789101112131415161718192021222324252627282930313233343536373839CREATE DEFINER=`root`@`localhost` PROCEDURE `GetSerialNo`(IN tsCode VARCHAR(50),OUT result VARCHAR(200) )BEGIN DECLARE tsValue VARCHAR(50); DECLARE tdToday VARCHAR(20); DECLARE nowdate VARCHAR(20); DECLARE tsQZ VARCHAR(50); DECLARE t_error INTEGER DEFAULT 0; DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET t_error=1; START TRANSACTION; /* UPDATE sys_sno SET sValue=sValue WHERE sCode=tsCode; */ SELECT sValue INTO tsValue FROM sys_sno WHERE sCode=tsCode for UPDATE; SELECT sQz INTO tsQZ FROM sys_sno WHERE sCode=tsCode ; -- å› å­è¡¨ä¸­æ²¡æœ‰è®°å½•ï¼Œæ’å…¥åˆå§‹å€¼ IF tsValue IS NULL THEN SELECT CONCAT(DATE_FORMAT(NOW(),&apos;%y%m&apos;),&apos;0001&apos;) INTO tsValue; UPDATE sys_sno SET sValue=tsValue WHERE sCode=tsCode ; SELECT CONCAT(tsQZ,tsValue) INTO result; ELSE SELECT SUBSTRING(tsValue,1,4) INTO tdToday; SELECT CONVERT(DATE_FORMAT(NOW(),&apos;%y%m&apos;),SIGNED) INTO nowdate; -- åˆ¤æ–­å¹´æœˆæ˜¯å¦éœ€è¦æ›´æ–° IF tdToday = nowdate THEN SET tsValue=CONVERT(tsValue,SIGNED) + 1; ELSE SELECT CONCAT(DATE_FORMAT(NOW(),&apos;%y%m&apos;) ,&apos;0001&apos;) INTO tsValue ; END IF; UPDATE sys_sno SET sValue =tsValue WHERE sCode=tsCode; SELECT CONCAT(tsQZ,tsValue) INTO result; END IF; IF t_error =1 THEN ROLLBACK; SET result = &apos;Error&apos;; ELSE COMMIT; END IF; SELECT result ; END; æµ‹è¯•ä»£ç å®Œæ•´æµ‹è¯•ä»£ç ï¼šhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/uni-number123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657import com.gitee.taven.uninumber.mapper.OrderMapper;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import java.util.HashMap;import java.util.Map;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;@Servicepublic class OrderService &#123; private static OrderMapper orderMapper; @Autowired public void setOrderMapper(OrderMapper orderMapper) &#123; this.orderMapper = orderMapper; &#125; private static final int TOTAL_THREADS = 100; public void multiThread() &#123; // åˆ›å»ºå›ºå®šé•¿åº¦çº¿ç¨‹æ±  ExecutorService fixedThreadPool = Executors.newFixedThreadPool(50); for (int i = 0; i &lt; TOTAL_THREADS; i++) &#123; Thread thread = new OrderThread(); fixedThreadPool.execute(thread); &#125; &#125; public static class OrderThread extends Thread &#123; @Override public void run() &#123; try &#123; Map&lt;String, String&gt; parameterMap = initParameterMap(); orderMapper.createOrderNum(parameterMap); String number = parameterMap.get(&quot;result&quot;); System.out.println(Thread.currentThread().getName() + &quot; : &quot; +number); &#125; catch (Exception e) &#123; System.out.println(e); &#125; &#125; public Map&lt;String, String&gt; initParameterMap() &#123; Map&lt;String, String&gt; parameterMap = new HashMap&lt;&gt;(); parameterMap.put(&quot;tsCode&quot;, &quot;order&quot;); parameterMap.put(&quot;result&quot;, &quot;-1&quot;); return parameterMap; &#125; &#125;&#125; 12345678910111213141516// mapper æŽ¥å£public interface OrderMapper &#123; int createOrderNum(Map&lt;String, String&gt; parameterMap);&#125;// xml &lt;update id=&quot;createOrderNum&quot; parameterMap=&quot;initMap&quot; statementType=&quot;CALLABLE&quot;&gt; CALL GetSerialNo(?,?) &lt;/update&gt; &lt;parameterMap type=&quot;java.util.Map&quot; id=&quot;initMap&quot;&gt; &lt;parameter property=&quot;tsCode&quot; mode=&quot;IN&quot; jdbcType=&quot;VARCHAR&quot;/&gt; &lt;parameter property=&quot;result&quot; mode=&quot;OUT&quot; jdbcType=&quot;VARCHAR&quot;/&gt; &lt;/parameterMap&gt; å¤‡æ³¨ æ‰§è¡Œäº†ä¸€ä¸ªç™¾ä¸ªçº¿ç¨‹ä¹‹åŽ å¯ä»¥çœ‹ä¸€ä¸‹æ•°æ®ï¼Œè‡ªå¢žåˆ°äº†100 è¯´æ˜ŽæˆåŠŸäº† åˆ æŽ‰ å­˜å‚¨è¿‡ç¨‹ä¸­çš„ for updateï¼Œå†æ‰§è¡Œ å¯ä»¥çœ‹å‡ºé”çš„ä½œç”¨]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
</search>
