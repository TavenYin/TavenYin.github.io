<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Kafka Connect-ÂÖ•Èó®]]></title>
    <url>%2Fpost%2F7ec53704.html</url>
    <content type="text"><![CDATA[ÂâçÊèêÈ¶ñÂÖà‰Ω†ÈúÄË¶Å‰∫ÜËß£MQ / KafkaÁõ∏ÂÖ≥ÁöÑÁü•ËØÜ Êú¨ÊñáÁõÆÊ†á‰∫ÜËß£ Kafka Connect Âü∫Êú¨Ê¶ÇÂøµ‰∏éÂäüËÉΩ ‰ªÄ‰πàÊòØKafka Connect Kafka Connect ÊòØ‰∏ÄÊ¨æÂèØÊâ©Â±ïÂπ∂‰∏îÂèØÈù†Âú∞Âú® Apache Kafka ÂíåÂÖ∂‰ªñÁ≥ªÁªü‰πãÈó¥ËøõË°åÊï∞ÊçÆ‰º†ËæìÁöÑÂ∑•ÂÖ∑„ÄÇ ÂèØ‰ª•ÂæàÁÆÄÂçïÁöÑÂÆö‰πâ connectorsÔºàËøûÊé•Âô®Ôºâ Â∞ÜÂ§ßÈáèÊï∞ÊçÆËøÅÂÖ•„ÄÅËøÅÂá∫Kafka„ÄÇ ‰æãÂ¶ÇÊàëÁé∞Âú®ÊÉ≥Ë¶ÅÊääÊï∞ÊçÆ‰ªéMySQLËøÅÁßªÂà∞ElasticSearchÔºå‰∏∫‰∫Ü‰øùËØÅÈ´òÊïàÂíåÊï∞ÊçÆ‰∏ç‰ºö‰∏¢Â§±ÔºåÊàë‰ª¨ÈÄâÊã©MQ‰Ωú‰∏∫‰∏≠Èó¥‰ª∂‰øùÂ≠òÊï∞ÊçÆ„ÄÇËøôÊó∂ÂÄôÊàë‰ª¨ÈúÄË¶Å‰∏Ä‰∏™Áîü‰∫ßËÄÖÁ∫øÁ®ãÔºå‰∏çÊñ≠ÁöÑ‰ªéMySQL‰∏≠ËØªÂèñÊï∞ÊçÆÂπ∂ÂèëÈÄÅÂà∞MQÔºåËøòÈúÄË¶Å‰∏Ä‰∏™Ê∂àË¥πËÄÖÁ∫øÁ®ãÊ∂àË¥πMQÁöÑÊï∞ÊçÆÂÜôÂà∞ElasticSearchÔºåËøô‰ª∂‰∫ãÊÉÖ‰ºº‰πéÂæàÁÆÄÂçïÔºå‰∏çÈúÄË¶Å‰ªª‰ΩïÊ°ÜÊû∂„ÄÇ ‰ΩÜÊòØÂ¶ÇÊûúÊàë‰ª¨ÊÉ≥Ë¶Å‰øùËØÅÁîü‰∫ßËÄÖÂíåÊ∂àË¥πËÄÖÊúçÂä°ÁöÑÈ´òÂèØÁî®ÊÄßÔºå‰æãÂ¶ÇÈáçÂêØÂêéÁîü‰∫ßËÄÖÊÅ¢Â§çÂà∞‰πãÂâçËØªÂèñÁöÑ‰ΩçÁΩÆÔºåÂàÜÂ∏ÉÂºèÈÉ®ÁΩ≤Âπ∂‰∏îËäÇÁÇπÂÆïÊú∫ÂêéÂ∞Ü‰ªªÂä°ËΩ¨ÁßªÂà∞ÂÖ∂‰ªñËäÇÁÇπ„ÄÇÂ¶ÇÊûúË¶ÅÂä†‰∏äËøô‰∫õÁöÑËØùÔºåËøô‰ª∂‰∫ãÂ∞±ÂèòÂæóÂ§çÊùÇËµ∑Êù•‰∫ÜÔºåËÄåKafka Connect Â∑≤Áªè‰∏∫Êàë‰ª¨ÈÄ†Â•ΩËøô‰∫õËΩÆÂ≠ê„ÄÇ Kafka Connect Â¶Ç‰ΩïÂ∑•‰ΩúÔºü Kafka Connect ÁâπÊÄßÂ¶Ç‰∏ãÔºö Kafka ËøûÊé•Âô®ÁöÑÈÄöÁî®Ê°ÜÊû∂ÔºöKafka Connect Ê†áÂáÜÂåñ‰∫ÜÂÖ∂‰ªñÊï∞ÊçÆÁ≥ªÁªü‰∏éKafkaÁöÑÈõÜÊàêÔºå‰ªéËÄåÁÆÄÂåñ‰∫ÜËøûÊé•Âô®ÁöÑÂºÄÂèëÔºåÈÉ®ÁΩ≤ÂíåÁÆ°ÁêÜ ÊîØÊåÅÂàÜÂ∏ÉÂºèÊ®°ÂºèÂíåÂçïÊú∫Ê®°ÂºèÈÉ®ÁΩ≤ Rest APIÔºöÈÄöËøáÁÆÄÂçïÁöÑRest APIÁÆ°ÁêÜËøûÊé•Âô® ÂÅèÁßªÈáèÁÆ°ÁêÜÔºöÈíàÂØπSourceÂíåSinkÈÉΩÊúâÁõ∏Â∫îÁöÑÂÅèÁßªÈáèÔºàOffsetÔºâÁÆ°ÁêÜÊñπÊ°àÔºåÁ®ãÂ∫èÂëòÊó†È°ªÂÖ≥ÂøÉOffset ÁöÑÊèê‰∫§ ÂàÜÂ∏ÉÂºèÊ®°ÂºèÂèØÊâ©Â±ïÁöÑÔºåÊîØÊåÅÊïÖÈöúËΩ¨Áßª Kafka Connect ConceptsËøôÈáåÁÆÄÂçï‰ªãÁªç‰∏ãKafka Connect ÁöÑÊ¶ÇÂøµ‰∏éÁªÑÊàêÊõ¥Â§öÁªÜËäÇËØ∑ÂèÇËÄÉ üëâ https://docs.confluent.io/platform/current/connect/concepts.html ConnectorsËøûÊé•Âô®ÔºåÂàÜ‰∏∫‰∏§Áßç SourceÔºà‰ªéÊ∫êÊï∞ÊçÆÂ∫ìÊãâÂèñÊï∞ÊçÆÂÜôÂÖ•KafkaÔºâÔºåSinkÔºà‰ªéKafkaÊ∂àË¥πÊï∞ÊçÆÂÜôÂÖ•ÁõÆÊ†áÊï∞ÊçÆÔºâ ËøûÊé•Âô®ÂÖ∂ÂÆûÂπ∂‰∏çÂèÇ‰∏éÂÆûÈôÖÁöÑÊï∞ÊçÆcopyÔºåËøûÊé•Âô®Ë¥üË¥£ÁÆ°ÁêÜTask„ÄÇËøûÊé•Âô®‰∏≠ÂÆö‰πâ‰∫ÜÂØπÂ∫îTaskÁöÑÁ±ªÂûãÔºåÂØπÂ§ñÊèê‰æõÈÖçÁΩÆÈÄâÈ°πÔºàÁî®Êà∑ÂàõÂª∫ËøûÊé•Âô®Êó∂ÈúÄË¶ÅÊèê‰æõÂØπÂ∫îÁöÑÈÖçÁΩÆ‰ø°ÊÅØÔºâ„ÄÇÂπ∂‰∏îËøûÊé•Âô®ËøòÂèØ‰ª•ÂÜ≥ÂÆöÂêØÂä®Â§öÂ∞ë‰∏™TaskÁ∫øÁ®ã„ÄÇ Áî®Êà∑ÂèØ‰ª•ÈÄöËøáRest API ÂêØÂÅúËøûÊé•Âô®ÔºåÊü•ÁúãËøûÊé•Âô®Áä∂ÊÄÅ Confluent Â∑≤ÁªèÊèê‰æõ‰∫ÜËÆ∏Â§öÊàêÁÜüÁöÑËøûÊé•Âô®Ôºå‰º†ÈÄÅÈó®üëâ https://www.confluent.io/product/connectors/ TaskÂÆûÈôÖËøõË°åÊï∞ÊçÆ‰º†ËæìÁöÑÂçïÂÖÉÔºåÂíåËøûÊé•Âô®‰∏ÄÊ†∑ÂêåÊ†∑ÂàÜ‰∏∫ SourceÂíåSink TaskÁöÑÈÖçÁΩÆÂíåÁä∂ÊÄÅÂ≠òÂÇ®Âú®KafkaÁöÑTopic‰∏≠Ôºåconfig.storage.topicÂíåstatus.storage.topic„ÄÇÊàë‰ª¨ÂèØ‰ª•ÈöèÊó∂ÂêØÂä®ÔºåÂÅúÊ≠¢‰ªªÂä°Ôºå‰ª•Êèê‰æõÂºπÊÄß„ÄÅÂèØÊâ©Â±ïÁöÑÊï∞ÊçÆÁÆ°ÈÅì WorkerÂàöÂàöÊàë‰ª¨ËÆ≤ÁöÑConnectors ÂíåTask Â±û‰∫éÈÄªËæëÂçïÂÖÉÔºåËÄåWorker ÊòØÂÆûÈôÖËøêË°åÈÄªËæëÂçïÂÖÉÁöÑËøõÁ®ãÔºåWorker ÂàÜ‰∏∫‰∏§ÁßçÊ®°ÂºèÔºåÂçïÊú∫Ê®°ÂºèÂíåÂàÜÂ∏ÉÂºèÊ®°Âºè ÂçïÊú∫Ê®°ÂºèÔºöÊØîËæÉÁÆÄÂçïÔºå‰ΩÜÊòØÂäüËÉΩ‰πüÂèóÈôêÔºåÂè™Êúâ‰∏Ä‰∫õÁâπÊÆäÁöÑÂú∫ÊôØ‰ºö‰ΩøÁî®Âà∞Ôºå‰æãÂ¶ÇÊî∂ÈõÜ‰∏ªÊú∫ÁöÑÊó•ÂøóÔºåÈÄöÂ∏∏Êù•ËØ¥Êõ¥Â§öÁöÑÊòØ‰ΩøÁî®ÂàÜÂ∏ÉÂºèÊ®°Âºè ÂàÜÂ∏ÉÂºèÊ®°ÂºèÔºö‰∏∫Kafka ConnectÊèê‰æõ‰∫ÜÂèØÊâ©Â±ïÂíåÊïÖÈöúËΩ¨Áßª„ÄÇÁõ∏Âêågroup.idÁöÑWorkerÔºå‰ºöËá™Âä®ÁªÑÊàêÈõÜÁæ§„ÄÇÂΩìÊñ∞Â¢ûWorkerÔºåÊàñËÄÖÊúâWorkerÊåÇÊéâÊó∂ÔºåÈõÜÁæ§‰ºöËá™Âä®ÂçèË∞ÉÂàÜÈÖçÊâÄÊúâÁöÑConnector Âíå TaskÔºàËøô‰∏™ËøáÁ®ãÁß∞‰∏∫RebalanceÔºâ ÂΩì‰ΩøÁî®WorkerÈõÜÁæ§Êó∂ÔºåÂàõÂª∫ËøûÊé•Âô®ÔºåÊàñËÄÖËøûÊé•Âô®TaskÊï∞ÈáèÂèòÂä®Êó∂ÔºåÈÉΩ‰ºöËß¶ÂèëRebalance ‰ª•‰øùËØÅÈõÜÁæ§ÂêÑ‰∏™WorkerËäÇÁÇπË¥üËΩΩÂùáË°°„ÄÇ‰ΩÜÊòØÂΩìTask ËøõÂÖ•FailÁä∂ÊÄÅÁöÑÊó∂ÂÄôÂπ∂‰∏ç‰ºöËß¶Âèë RebalanceÔºåÂè™ËÉΩÈÄöËøáRest Api ÂØπTaskËøõË°åÈáçÂêØ ConvertersKafka Connect ÈÄöËøá Converter Â∞ÜÊï∞ÊçÆÂú®KafkaÔºàÂ≠óËäÇÊï∞ÁªÑÔºâ‰∏éTaskÔºàObjectÔºâ‰πãÈó¥ËøõË°åËΩ¨Êç¢ ÈªòËÆ§ÊîØÊåÅ‰ª•‰∏ãConverter AvroConverter io.confluent.connect.avro.AvroConverter: ÈúÄË¶Å‰ΩøÁî® Schema Registry ProtobufConverter io.confluent.connect.protobuf.ProtobufConverter: ÈúÄË¶Å‰ΩøÁî® Schema Registry JsonSchemaConverter io.confluent.connect.json.JsonSchemaConverter: ÈúÄË¶Å‰ΩøÁî® Schema Registry JsonConverter org.apache.kafka.connect.json.JsonConverter (Êó†ÈúÄ Schema Registry): ËΩ¨Êç¢‰∏∫jsonÁªìÊûÑ StringConverter org.apache.kafka.connect.storage.StringConverter: ÁÆÄÂçïÁöÑÂ≠óÁ¨¶‰∏≤Ê†ºÂºè ByteArrayConverter org.apache.kafka.connect.converters.ByteArrayConverter: ‰∏çÂÅö‰ªª‰ΩïËΩ¨Êç¢ Converters ‰∏é Connector ÊòØËß£ËÄ¶ÁöÑÔºå‰∏ãÂõæÂ±ïÁ§∫‰∫ÜÂú®Kafka Connect‰∏≠ÔºåConverter Âú®‰ΩïÊó∂ËøõË°åÊï∞ÊçÆËΩ¨Êç¢ TransformsËøûÊé•Âô®ÂèØ‰ª•ÈÄöËøáÈÖçÁΩÆTransform ÂÆûÁé∞ÂØπÂçï‰∏™Ê∂àÊÅØÔºàÂØπÂ∫î‰ª£Á†Å‰∏≠ÁöÑRecordÔºâÁöÑËΩ¨Êç¢Âíå‰øÆÊîπÔºåÂèØ‰ª•ÈÖçÁΩÆÂ§ö‰∏™Transform ÁªÑÊàê‰∏Ä‰∏™Èìæ„ÄÇ‰æãÂ¶ÇËÆ©ÊâÄÊúâÊ∂àÊÅØÁöÑtopicÂä†‰∏Ä‰∏™ÂâçÁºÄ„ÄÅsinkÊó†Ê≥ïÊ∂àË¥πsource ÂÜôÂÖ•ÁöÑÊï∞ÊçÆÊ†ºÂºèÔºåËøô‰∫õÂú∫ÊôØÈÉΩÂèØ‰ª•‰ΩøÁî®Transform Ëß£ÂÜ≥ Transform Â¶ÇÊûúÈÖçÁΩÆÂú®Source ÂàôÂú®Task‰πãÂêéÊâßË°åÔºåÂ¶ÇÊûúÈÖçÁΩÆÂú®Sink ÂàôÂú®Task‰πãÂâçÊâßË°å Dead Letter Queue‰∏éÂÖ∂‰ªñMQ‰∏çÂêåÔºåKafka Âπ∂Ê≤°ÊúâÊ≠ª‰ø°ÈòüÂàóËøô‰∏™ÂäüËÉΩ„ÄÇ‰ΩÜÊòØKafka ConnectÊèê‰æõ‰∫ÜËøô‰∏ÄÂäüËÉΩ„ÄÇ ÂΩìSink TaskÈÅáÂà∞Êó†Ê≥ïÂ§ÑÁêÜÁöÑÊ∂àÊÅØÔºå‰ºöÊ†πÊçÆerrors.toleranceÈÖçÁΩÆÈ°πÂÜ≥ÂÆöÂ¶Ç‰ΩïÂ§ÑÁêÜÔºåÈªòËÆ§ÊÉÖÂÜµ‰∏ã(errors.tolerance=none) Sink ÈÅáÂà∞Êó†Ê≥ïÂ§ÑÁêÜÁöÑËÆ∞ÂΩï‰ºöÁõ¥Êé•ÊäõÂá∫ÂºÇÂ∏∏ÔºåTaskËøõÂÖ•Fail Áä∂ÊÄÅ„ÄÇÂºÄÂèë‰∫∫ÂëòÈúÄË¶ÅÊ†πÊçÆWorkerÁöÑÈîôËØØÊó•ÂøóËß£ÂÜ≥ÈóÆÈ¢òÔºåÁÑ∂ÂêéÈáçÂêØTaskÔºåÊâçËÉΩÁªßÁª≠Ê∂àË¥πÊï∞ÊçÆ ËÆæÁΩÆ errors.tolerance=allÔºåSink Task ‰ºöÂøΩÁï•ÊâÄÊúâÁöÑÈîôËØØÔºåÁªßÁª≠Â§ÑÁêÜ„ÄÇWorker‰∏≠‰∏ç‰ºöÊúâ‰ªª‰ΩïÈîôËØØÊó•Âøó„ÄÇÂèØ‰ª•ÈÄöËøáÈÖçÁΩÆerrors.deadletterqueue.topic.name = &lt;dead-letter-topic-name&gt; ËÆ©Êó†Ê≥ïÂ§ÑÁêÜÁöÑÊ∂àÊÅØË∑ØÁî±Âà∞ Dead Letter Topic Âø´ÈÄü‰∏äÊâã‰∏ãÈù¢ÊàëÊù•ÂÆûÊàò‰∏Ä‰∏ãÔºåÂ¶Ç‰Ωï‰ΩøÁî®Kafka ConnectÔºåÊàë‰ª¨ÂÖàÂÆö‰∏Ä‰∏™Â∞èÁõÆÊ†á Â∞ÜMySQL‰∏≠ÁöÑÂÖ®ÈáèÊï∞ÊçÆÂêåÊ≠•Âà∞Redis Êñ∞Âª∫Êñá‰ª∂ docker-compose.yaml123456789101112131415161718192021version: &apos;3.7&apos;services: zookeeper: image: wurstmeister/zookeeper container_name: zk ports: - 2182:2181 kafka: image: wurstmeister/kafka:2.13-2.7.0 container_name: kafka ports: - 9092:9092 environment: KAFKA_BROKER_ID: 0 # ÂÆø‰∏ªÊú∫ip KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://192.168.3.21:9092 KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092 depends_on: - zookeeper Âú®ÁªàÁ´Ø‰∏äÊâßË°å docker-compose -f docker-compose.yaml up -d ÂêØÂä®dockerÂÆπÂô® ÂáÜÂ§áËøûÊé•Âô®ÔºåËøôÈáåÊàëÊòØËá™Â∑±ÂÜô‰∫Ü‰∏Ä‰∏™ÁÆÄÂçïÁöÑËøûÊé•Âô®üòÑ„ÄÇ‰∏ãËΩΩÂú∞ÂùÄÔºöhttps://github.com/TavenYin/kafka-connect-example/blob/master/release/kafka-connector-example-bin.jar 12# Â∞ÜËøûÊé•Âô®‰∏ä‰º†Âà∞kafka ÂÆπÂô®‰∏≠docker cp kafka-connector-example-bin.jar kafka:/opt/connectors ‰øÆÊîπÈÖçÁΩÆÂπ∂ÂêØÂä®Worker 12345#Âú®ÈÖçÁΩÆÊñá‰ª∂Êú´Â∞æËøΩÂä† plugin.path=/opt/connectorsvi /opt/kafka/config/connect-distributed.properties# ÂêØÂä®Workerbin/connect-distributed.sh -daemon config/connect-distributed.properties ÂáÜÂ§áMySQL Áî±‰∫éÊàëÂÆø‰∏ªÊú∫ÈáåÂ∑≤ÁªèÂÆâË£Ö‰∫ÜMySQLÔºåÊàëÂ∞±Áõ¥Êé•‰ΩøÁî®‰∫ÜÔºå‰ΩøÁî®Â¶Ç‰∏ãSqlÂàõÂª∫Ë°®„ÄÇÂàõÂª∫‰πãÂêéÈöè‰æøÈÄ†Âá†Êù°Êï∞ÊçÆ12345CREATE TABLE `test_user` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `name` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`)) ; ÂàõÂª∫ËøûÊé•Âô® Êñ∞Âª∫ source.json1234567891011&#123; &quot;name&quot; : &quot;example-source&quot;, &quot;config&quot; : &#123; &quot;connector.class&quot; : &quot;com.github.taven.source.ExampleSourceConnector&quot;, &quot;tasks.max&quot; : &quot;1&quot;, &quot;database.url&quot; : &quot;jdbc:mysql://192.168.3.21:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;useSSL=false&amp;zeroDateTimeBehavior=convertToNull&amp;serverTimezone=UTC&amp;rewriteBatchedStatements=true&quot;, &quot;database.username&quot; : &quot;root&quot;, &quot;database.password&quot; : &quot;root&quot;, &quot;database.tables&quot; : &quot;test_user&quot; &#125;&#125; ÂêëWorker ÂèëÈÄÅËØ∑Ê±ÇÔºåÂàõÂª∫ËøûÊé•Âô®curl -i -X POST -H &quot;Accept:application/json&quot; -H &quot;Content-Type:application/json&quot; http://localhost:8083/connectors/ -d @source.json source.json ‰∏≠ÔºåÊúâ‰∏Ä‰∫õÂ±ûÊÄßÊòØKafka Connect Êèê‰æõÁöÑÔºå‰æãÂ¶Ç‰∏äËø∞Êñá‰ª∂‰∏≠ name, connector.class, tasks.maxÔºåÂâ©‰∏ãÁöÑÂ±ûÊÄßÂèØ‰ª•Âú®ÂºÄÂèëConnector Êó∂Ëá™ÂÆö‰πâ„ÄÇÂÖ≥‰∫éKafka Connect Configuration Áõ∏ÂÖ≥ËØ∑ÈòÖËØªËøôÈáå üëâ https://docs.confluent.io/platform/current/installation/configuration/connect/index.html Á°ÆËÆ§Êï∞ÊçÆÊòØÂê¶ÂÜôÂÖ•Kafka È¶ñÂÖàÊü•Áúã‰∏Ä‰∏ãWorker‰∏≠ÁöÑËøêË°åÁä∂ÊÄÅÔºåÂ¶ÇÊûúTaskÁöÑstate = RUNNINGÔºå‰ª£Ë°®TaskÊ≤°ÊúâÊäõÂá∫‰ªª‰ΩïÂºÇÂ∏∏ÔºåÂπ≥Á®≥ËøêË°å123bash-4.4# curl -X GET localhost:8083/connectors/example-source/status&#123;&quot;name&quot;:&quot;example-source&quot;,&quot;connector&quot;:&#123;&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;,&quot;tasks&quot;:[&#123;&quot;id&quot;:0,&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;],&quot;type&quot;:&quot;source&quot;&#125; Êü•Áúãkafka ‰∏≠Topic ÊòØÂê¶ÂàõÂª∫123456bash-4.4# bin/kafka-topics.sh --list --zookeeper zookeeper:2181__consumer_offsetsconnect-configsconnect-offsetsconnect-statustest_user Ëøô‰∫õTopic ÈÉΩÂ≠òÂÇ®‰∫Ü‰ªÄ‰πàÔºü __consumer_offsets: ËÆ∞ÂΩïÊâÄÊúâKafka Consumer GroupÁöÑOffset connect-configs: Â≠òÂÇ®ËøûÊé•Âô®ÁöÑÈÖçÁΩÆÔºåÂØπÂ∫îConnect ÈÖçÁΩÆÊñá‰ª∂‰∏≠config.storage.topic connect-offsets: Â≠òÂÇ®Source ÁöÑOffsetÔºåÂØπÂ∫îConnect ÈÖçÁΩÆÊñá‰ª∂‰∏≠offset.storage.topic connect-status: ËøûÊé•Âô®‰∏éTaskÁöÑÁä∂ÊÄÅÔºåÂØπÂ∫îConnect ÈÖçÁΩÆÊñá‰ª∂‰∏≠status.storage.topic Êü•Áúãtopic‰∏≠Êï∞ÊçÆÔºåÊ≠§Êó∂ËØ¥ÊòéMySQLÊï∞ÊçÆÂ∑≤ÁªèÊàêÂäüÂÜôÂÖ•Kafka1234bash-4.4# bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test_user --from-beginning&#123;&quot;schema&quot;:&#123;&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[&#123;&quot;type&quot;:&quot;int64&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;id&quot;&#125;,&#123;&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;name&quot;&#125;],&quot;optional&quot;:false,&quot;name&quot;:&quot;test_user&quot;&#125;,&quot;payload&quot;:&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;yyyyyy&quot;&#125;&#125;&#123;&quot;schema&quot;:&#123;&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[&#123;&quot;type&quot;:&quot;int64&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;id&quot;&#125;,&#123;&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;name&quot;&#125;],&quot;optional&quot;:false,&quot;name&quot;:&quot;test_user&quot;&#125;,&quot;payload&quot;:&#123;&quot;id&quot;:2,&quot;name&quot;:&quot;qqqq&quot;&#125;&#125;&#123;&quot;schema&quot;:&#123;&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[&#123;&quot;type&quot;:&quot;int64&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;id&quot;&#125;,&#123;&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false,&quot;field&quot;:&quot;name&quot;&#125;],&quot;optional&quot;:false,&quot;name&quot;:&quot;test_user&quot;&#125;,&quot;payload&quot;:&#123;&quot;id&quot;:3,&quot;name&quot;:&quot;eeee&quot;&#125;&#125; Êï∞ÊçÆÁªìÊûÑ‰∏∫JsonÔºåÂèØ‰ª•ÂõûÈ°æ‰∏Ä‰∏ã‰∏äÈù¢Êàë‰ª¨‰øÆÊîπÁöÑconnect-distributed.propertiesÔºåÈªòËÆ§Êèê‰æõÁöÑConverter ‰∏∫JsonConverterÔºåÊâÄÊúâÁöÑÊï∞ÊçÆÂåÖÂê´schema Âíå payload ‰∏§È°πÊòØÂõ†‰∏∫ÈÖçÁΩÆÊñá‰ª∂‰∏≠ÈªòËÆ§ÂêØÂä®‰∫Ükey.converter.schemas.enable=trueÂíåvalue.converter.schemas.enable=true‰∏§‰∏™ÈÄâÈ°π ÂêØÂä® Sink Êñ∞Âª∫sink.json123456789101112&#123; &quot;name&quot; : &quot;example-sink&quot;, &quot;config&quot; : &#123; &quot;connector.class&quot; : &quot;com.github.taven.sink.ExampleSinkConnector&quot;, &quot;topics&quot; : &quot;test_user, test_order&quot;, &quot;tasks.max&quot; : &quot;1&quot;, &quot;redis.host&quot; : &quot;192.168.3.21&quot;, &quot;redis.port&quot; : &quot;6379&quot;, &quot;redis.password&quot; : &quot;&quot;, &quot;redis.database&quot; : &quot;0&quot; &#125;&#125; ÂàõÂª∫Sink Connectorcurl -i -X POST -H &quot;Accept:application/json&quot; -H &quot;Content-Type:application/json&quot; http://localhost:8083/connectors/ -d @sink.json ÁÑ∂ÂêéÊü•ÁúãSink Connector StatusÔºåËøôÈáåÊàëÂèëÁé∞Áî±‰∫éÊàëÁöÑRedisÁ´ØÂè£Âè™ÂØπlocalhostÂºÄÂèëÔºåÊâÄ‰ª•ËøôÈáåÊàëÁöÑTask Fail‰∫ÜÔºå‰øÆÊîπ‰∫ÜRedisÈÖçÁΩÆ‰πãÂêéÔºåÈáçÂêØTask curl -X POST localhost:8083/connectors/example-sink/tasks/0/restart Âú®Á°ÆËÆ§‰∫ÜSink Status ‰∏∫RUNNING ÂêéÔºåÂèØ‰ª•Á°ÆËÆ§‰∏ãRedis‰∏≠ÊòØÂê¶ÊúâÊï∞ÊçÆ ÂÖ≥‰∫éKafka Connect Rest api ÊñáÊ°£ÔºåËØ∑ÂèÇËÄÉüëâhttps://docs.confluent.io/platform/current/connect/references/restapi.html Â¶Ç‰ΩïÊü•ÁúãSink OffsetÊ∂àË¥πÊÉÖÂÜµ ‰ΩøÁî®ÂëΩ‰ª§bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group connect-example-sink ‰∏ãÂõæ‰ª£Ë°® test_user topic ‰∏âÊù°Êï∞ÊçÆÂ∑≤ÁªèÂÖ®ÈÉ®Ê∂àË¥π Kafka Connect È´òÁ∫ßÂäüËÉΩÊàë‰ª¨ÁöÑÂ∞èÁõÆÊ†áÂ∑≤ÁªèËææÊàê‰∫Ü„ÄÇÁé∞Âú®‰∏§‰∏™TaskÊó†‰∫ãÂèØÂÅöÔºåÊ≠£Â•ΩÂÄüÊ≠§Êú∫‰ºöÊàë‰ª¨Êù•‰ΩìÈ™å‰∏Ä‰∏ãÂèØÊâ©Â±ïÂíåÊïÖÈöúËΩ¨Áßª ÈõÜÁæ§Êâ©Â±ïÊàëÂêØÂä®‰∫ÜÂºÄÂèëÁéØÂ¢É‰∏≠ÁöÑKafka Connect WorkerÔºåÊ†πÊçÆÂÆòÊñπÊñáÊ°£ÊâÄÁ§∫ÈÄöËøáÊ≥®ÂÜåÂêå‰∏Ä‰∏™Kafka Âπ∂‰∏î‰ΩøÁî®Áõ∏ÂêåÁöÑ group.id=connect-cluster ÂèØ‰ª•Ëá™Âä®ÁªÑÊàêÈõÜÁæ§ ÂêØÂä®ÊàëÂºÄÂèëÁéØÂ¢É‰∏≠ÁöÑKafka ConnectÔºå‰πãÂêéÊ£ÄÊü•‰∏§‰∏™ËøûÊé•Âô®Áä∂ÊÄÅ 12345bash-4.4# curl -X GET localhost:8083/connectors/example-source/status&#123;&quot;name&quot;:&quot;example-source&quot;,&quot;connector&quot;:&#123;&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.23.176.1:8083&quot;&#125;,&quot;tasks&quot;:[&#123;&quot;id&quot;:0,&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.23.176.1:8083&quot;&#125;],&quot;type&quot;:&quot;source&quot;&#125;bash-4.4#bash-4.4# curl -X GET localhost:8083/connectors/example-sink/status&#123;&quot;name&quot;:&quot;example-sink&quot;,&quot;connector&quot;:&#123;&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;,&quot;tasks&quot;:[&#123;&quot;id&quot;:0,&quot;state&quot;:&quot;RUNNING&quot;,&quot;worker_id&quot;:&quot;172.21.0.3:8083&quot;&#125;],&quot;type&quot;:&quot;sink&quot;&#125; ËßÇÂØüworker_id ÂèØ‰ª•ÂèëÁé∞Ôºå‰∏§‰∏™Connectors Â∑≤ÁªèÂàÜÂà´ËøêË°åÂú®‰∏§‰∏™Worker‰∏ä‰∫Ü ÊïÖÈöúËΩ¨ÁßªÊ≠§Êó∂Êàë‰ª¨ÈÄöËøákill pidÁªìÊùüdocker‰∏≠ÁöÑWorkerËøõÁ®ãËßÇÂØüÊòØÂê¶ÂÆïÊú∫‰πãÂêéËá™Âä®ËΩ¨ÁßªÔºå‰ΩÜÊòØÂèëÁé∞TaskÂπ∂Ê≤°ÊúâËΩ¨ÁßªÂà∞‰ªÖÂ≠òÁöÑWorker‰∏≠ÔºåTask Áä∂ÊÄÅÂèò‰∏∫UNASSIGNEDÔºåËøôÊòØ‰∏∫Âï•Âë¢ÔºüÈöæÈÅìÊòØÊúâ‰ªÄ‰πàÊìç‰ΩúÈîô‰∫ÜÔºü Âú®ÁΩë‰∏äÊü•ÈòÖ‰∫Ü‰∏ÄÁï™ÂæóÁü•ÔºåKafka Connect ÁöÑÈõÜÁæ§Êâ©Â±ï‰∏éÊïÖÈöúËΩ¨ÁßªÊú∫Âà∂ÊòØÈÄöËøáKafka Rebalance ÂçèËÆÆÂÆûÁé∞ÁöÑÔºàConsumer‰πüÊòØËØ•ÂçèËÆÆÔºâÔºåÂΩìWorkerËäÇÁÇπÂÆïÊú∫Êó∂Èó¥Ë∂ÖËøá scheduled.rebalance.max.delay.ms Êó∂ÔºåKafkaÊâç‰ºöÂ∞ÜÂÖ∂Ë∏¢Âá∫ÈõÜÁæ§„ÄÇË∏¢Âá∫ÂêéÂ∞ÜËØ•ËäÇÁÇπÁöÑËøûÊé•Âô®Âíå‰ªªÂä°ÂàÜÈÖçÁªôÂÖ∂‰ªñWorkerÔºåscheduled.rebalance.max.delay.msÈªòËÆ§ÂÄº‰∏∫‰∫îÂàÜÈíü„ÄÇ ÂêéÊù•ÁªèÊµãËØïÂèëÁé∞Ôºå‰∫îÂàÜÈíü‰πãÂêéÊü•ÁúãËøûÊé•Âô®‰ø°ÊÅØÔºåÂ∑≤ÁªèËΩ¨ÁßªÂà∞Â≠òÊ¥ªÁöÑWorkerËäÇÁÇπ‰∫Ü Êú¨Êù•ËøòËÆ°ÂàíÂÜô‰∏Ä‰∏ãÂ¶Ç‰ΩïÂºÄÂèëËøûÊé•Âô®ÂíåKafka RebalanceÔºå‰ΩÜÊòØËøôÁØáÂ∑≤ÁªèÂ§üÈïø‰∫ÜÔºåÊâÄ‰ª•ËÆ°ÂàíÂêéÁª≠Êõ¥Êñ∞Ëøô‰∏§ÁØáÊñáÁ´†]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
        <tag>Kafka Connect</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ÈóÆÈ¢òÂàÜÊûêÔºöKafka Connect ÂºïÂÖ•‰∫ÜFastjsonÂêéÔºåRest APIÂìçÂ∫î‰∏∫{}]]></title>
    <url>%2Fpost%2F11f7961b.html</url>
    <content type="text"><![CDATA[ÂâçË®ÄÊúÄËøëÂú®Â≠¶‰π†Kafka ConnectÔºåÂÜô‰∫Ü‰∏™ËøûÊé•Âô®ÁöÑdemo„ÄÇÂú®demoÊèê‰∫§‰∫ÜÂá†‰∏™ÁâàÊú¨‰πãÂêéÔºåÁ™ÅÁÑ∂ÂèëÁé∞Kafka Connect Rest API Êó†Ê≥ïÊ≠£Â∏∏ÂìçÂ∫î‰∫ÜÔºåÊòéÊòéÊúâÊ≠£Âú®ËøêË°åÁöÑËøûÊé•Âô®ÔºåÊü•ËØ¢statusÔºåÂ±ÖÁÑ∂ËøîÂõû{} ÈóÆÈ¢òÂàÜÊûêÂØπ Rest API ËøõË°ådebugÂêéÔºåÁ°ÆËÆ§ÊòØÊúâÊï∞ÊçÆÁöÑÔºå‰ΩÜÊòØÊï∞ÊçÆËøîÂõû‰∏çÂà∞ÂÆ¢Êà∑Á´ØÔºåÂæàÂ•áÊÄ™„ÄÇÂõ†‰∏∫ÊàëËÆ∞Âæó‰πãÂâçÊòØÂ•ΩÁî®ÁöÑÔºåÊâÄ‰ª•ÊàëÂõûÊªö‰∫Ü‰ª£Á†ÅÁâàÊú¨ÔºåÈÄê‰∏ÄÊéíÊü•‰πãÂêéÂèëÁé∞ÂΩìÂºïÂÖ•Fastjson ‰æùËµñ‰πãÂêéÔºå‰ºöÂØºËá¥Connect Rest API ‰∏çÂèØÁî® Â¶ÇÊûúÊáí‰∏ÄÁÇπÁöÑËØùÔºåÂà∞ËøôÈáåÂ∞±Â∑≤ÁªèÁªìÊùü‰∫ÜÔºåÁõ¥Êé•Âà†Èô§Fastjson‰æùËµñÔºå‰ΩøÁî®ÂÖ∂‰ªñJsonÂåÖ„ÄÇ‰ΩÜÊòØÊàëÂæàÂ•ΩÂ•áÔºåÂú®ÊàëÁöÑÁêÜËß£ÈáåÔºåFastjson ËøôÁßçÂ∫ìÂ∞±ÊòØ‰∏™Â∑•ÂÖ∑ÂåÖÔºåÂ¶ÇÊûúÊàë‰ª¨Á®ãÂ∫èÊ≤°Êúâ‰∏ªÂä®Ë∞ÉÁî®ÁöÑÊó∂ÂÄôÔºåÊòØ‰∏ç‰ºöÂØπÊàë‰ª¨‰∫ßÁîü‰ªª‰ΩïÂΩ±ÂìçÁöÑ„ÄÇ ÁôæÂ∫¶Ë∞∑Ê≠å‰∏ÄÈÄö‰πãÂêéÔºå‰∏ÄÁ≠πËé´Â±ï‰πãÈôÖÔºåÁÇπÂºÄ‰∫ÜFastjsonÁöÑÊ∫êÁ†ÅÂåÖÔºåÂú®ËøôÈáåÂèëÁé∞‰∫ÜFastjson‰∏∫JAXRSÊèê‰æõÁöÑSPIÊâ©Â±ï JAXRSÔºöJava API for RESTful Web ServicesÔºåJavaEEÊèê‰æõÁöÑWebÊúçÂä°Êé•Âè£„ÄÇJersey ÂÆûÁé∞‰∫ÜJAXRSÔºåËÄåKafka Connect ÂºïÁî®‰∫ÜJersey „ÄÇSPIÔºöService Provider Interface ÔºåÊòØJDKÂÜÖÁΩÆÁöÑ‰∏ÄÁßçÊúçÂä°Êèê‰æõÂèëÁé∞Êú∫Âà∂ÔºåÂèØ‰ª•ÂèÇËÄÉÊàë‰πãÂâçÁöÑÂçöÂÆ¢ Java SPI ÂÆûÊàò ÊâìÂºÄjavax.ws.rs.ext.MessageBodyWriter Êñá‰ª∂ÔºåÂèØ‰ª•ÁúãÂà∞Êèê‰æõÁöÑÂÆûÁé∞Á±ªÊòØcom.alibaba.fastjson.support.jaxrs.FastJsonProviderÔºåÂÆö‰ΩçÂà∞FastJsonProvider‰∏ãwriteToÊñπÊ≥ïÔºåËØ•ÊñπÊ≥ï‰ºöÊääobjectÂÜôÂÖ•Âà∞OutputStream‰∏≠ÔºåÁúãËµ∑Êù•ÂæàÈù†Ë∞±ÔºådebugËØï‰∏Ä‰∏ã ÊûúÁÑ∂ÔºåËØ¥ÊòéFastjsonÊûúÁÑ∂ÂèÇ‰∏é‰∫ÜRest APIÁöÑÂìçÂ∫î„ÄÇ‰∏∫‰ªÄ‰πà‰ΩøÁî®FastjsonÂ∞±ÂìçÂ∫î‰∏ç‰∫ÜÊï∞ÊçÆÂë¢ÔºåÁúã‰∫Ü‰∏ãÊ∫êÁ†ÅÔºåËøôÈáåË¶ÅÊ±ÇË¢´Â∫èÂàóÂåñÁöÑBeanÂøÖÈ°ªÊ†áËÆ∞FastjsonÁõ∏ÂÖ≥ÁöÑÊ≥®Ëß£ÔºåËÄåÂÆûÈôÖÁöÑBean‰ΩøÁî®ÁöÑÊòØJacksonÁöÑÊ≥®Ëß£ÔºåÊâÄ‰ª•FastjsonÊó†Ê≥ïÂ∫èÂàóÂåñÊï∞ÊçÆ„ÄÇ Êé•‰∏ãÊù•ÂèØ‰ª•Ê†πÊçÆË∞ÉÁî®Ê†àÂíåÂÖ®Â±ÄÊêúÁ¥¢Êâæ‰∏Ä‰∏ãÔºåÁúãÁúãFastJsonProviderÊòØÂú®‰ªÄ‰πàÊó∂Êú∫Âä†ËΩΩÁöÑÔºåËÉΩÂê¶Âπ≤Êéâ‰ªñ„ÄÇ Ë∞ÉÁî®Ê†àÂπ∂Ê≤°ÊúâÊâæÂà∞‰ªÄ‰πàÊúâÁî®ÁöÑ‰ø°ÊÅØÔºåÈÄöËøáÂÖ®Â±ÄÊêúÁ¥¢MessageBodyWriterÊâæÂà∞‰∫ÜFastJsonProviderÁöÑÂä†ËΩΩ‰ΩçÁΩÆÔºåMessageBodyFactory::initialize ‰∏äÂõæÂ≠óÈù¢ÊÑèÊÄùÁêÜËß£Ôºå‰ΩøÁî® injectionManager (Ê≥®ÂÖ•ÁÆ°ÁêÜÂô®)ÔºåÊâæÂà∞MessageBodyWriterÁöÑÂèØÁî®ÂÆûÁé∞ ËøôÈáåÁöÑ customMbws size = 2ÔºåÂàÜÂà´ÊòØFastJsonÂíåJacksonÁöÑÂÆûÁé∞„ÄÇ‰ΩÜÊòØFastJsonÂú®ÂâçÔºåËÄåÊØèÊ¨°ÈúÄË¶ÅÂÅöJSONÂ∫èÂàóÂåñÁöÑÊó∂ÂÄôÔºå‰ºöÈÅçÂéÜwritersÔºåÂ¶ÇÊûúÊâæÂà∞ÊîØÊåÅapplication/jsonÁöÑMessageBodyWriterÂàôÁõ¥Êé•ËøîÂõûÔºåÊâÄ‰ª•ÊØèÊ¨°‰ΩøÁî®ÁöÑÈÉΩÊòØFastJsonÁöÑÂÆûÁé∞„ÄÇ Ëá≥Ê≠§Â∑≤ÁªèÊòéÁôΩ‰∫ÜÔºå‰∏∫‰ªÄ‰πàFastjson ‰ºöÂΩ±ÂìçKafka Connect‰∫ÜÔºåÊé•‰∏ãÊù•Â∞±ÊòØÊÉ≥ÂäûÊ≥ïËß£ÂÜ≥‰∫Ü Ëøô‰∏™Êó∂ÂÄôËøòÊòØÊ≤°ÊúâÊâæÂà∞FastjsonÊòØÂú®Âì™Âä†ËΩΩÁöÑÔºåÂú®FastjsonÁöÑ wiki ‰∏≠ÊâæÂà∞‰∫Ü‰∫õÁÅµÊÑüÔºåÂèëÁé∞Fastjson Âú®Jersey ‰∏≠Âπ∂‰∏çÊòØÈÄöËøáSPIÁöÑÊñπÂºèËøõË°åÁöÑÊâ©Â±ïÔºåËÄåÊòØÈÄöËøáFastJsonAutoDiscoverableÔºåÂêëJersey ÁöÑ context‰∏≠Ê≥®ÂÜåFastJsonProvider ÊúÄÂêéÔºåÊàë‰ª¨Âú®java ËøõÁ®ãÂêØÂä®Êó∂ÊåáÂÆöÂèÇÊï∞ -Dfastjson.auto.discoverable=falseÔºåÁ¶ÅÁî® FastJsonProvider ÂèÇËÄÉhttps://github.com/alibaba/fastjson/wiki/Integrate-Fastjson-in-JAXRS]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[‰∏™‰∫∫ÁÆÄÂéÜ]]></title>
    <url>%2Fpost%2Fe860cc2d.html</url>
    <content type="text"><![CDATA[Âü∫Êú¨‰ø°ÊÅØ ÊÆ∑Â§©Êñá/Áî∑/1995 ‰∏ìÁßë/Â§ßËøûËΩØ‰ª∂ËÅå‰∏öÂ≠¶Èô¢/ËΩØ‰ª∂Â∑•Á®ã Â∑•‰ΩúÂπ¥ÈôêÔºö4Âπ¥ ÁîµÂ≠êÈÇÆÁÆ±Ôºöyintianwen7@gmail.com ÁîµËØùÔºö+86 18741555096 ÂçöÂÆ¢Ôºöhttp://blog.yintianwen.top Github: https://github.com/TavenYin ÁÆÄ‰π¶Ôºöhttps://www.jianshu.com/u/cd682de00804 ÂÖ¨‰ºóÂè∑ÔºöÊÆ∑Â§©Êñá ÊúüÊúõÂ≤ó‰ΩçÔºöÂêéÁ´ØÂºÄÂèë ‰∏ì‰∏öÊäÄËÉΩ ÊâéÂÆûÁöÑJavaÂü∫Á°ÄÔºå‰∫ÜËß£JVMÔºåÁÜüÊÇâÂ∏∏Áî®APIÂÆûÁé∞ÂéüÁêÜÔºåÁÜüÁªÉÊéåÊè°Â§öÁ∫øÁ®ãÂºÄÂèëÔºåÁÜüÊÇâIOÊäÄÊúØ ÁÜüÁªÉ‰ΩøÁî®JavaÁà¨Ëô´ÊäÄÊúØ ÁÜüÊÇâÂ∏∏Áî®ËÆæËÆ°Ê®°Âºè ÁÜüÁªÉÊéåÊè°SpringÁ≠âÂ∏∏Áî®JavaÂºÄÊ∫êÊ°ÜÊû∂ÔºåÂπ∂Ê∑±ÂÖ•ÂàÜÊûêËøáÂÖ∂ÂÆûÁé∞ÂéüÁêÜÔºåÂØπÊ∫êÁ†ÅÂ≠¶‰π†ÊúâÊµìÂéöÁöÑÂÖ¥Ë∂£ ÁÜüÁªÉ‰ΩøÁî®MySQL/Redis/Postgres/OracleÁ≠âÊï∞ÊçÆÂ∫ì ÁÜüÁªÉÊéåÊè°Seata/ÂèØÈù†Ê∂àÊÅØÁ≠âÂàÜÂ∏ÉÂºè‰∫ãÂä°Ëß£ÂÜ≥ÊñπÊ°à ÁÜüÁªÉÊéåÊè°Êï∞ÊçÆÂ∫ìÂ¢ûÈáèËøÅÁßªÊäÄÊúØ‰∏éÂéüÁêÜÔºåÊéåÊè°DebeziumÁöÑ‰ΩøÁî®‰∏éÂéüÁêÜ ÁÜüÁªÉÊéåÊè°RabbitMQ/RocketMQ/Kafka ÁÜüÊÇâMySQL‰ºòÂåñ/ÂàÜÂ∫ìÂàÜË°®Á≠âÊñπÊ°à ÁÜüÊÇâDubbo/SpringCloudÁ≠âÂæÆÊúçÂä°Ê°ÜÊû∂ ÁÜüÊÇâPHP/JavaScript/LuaÁ≠âËØ≠Ë®ÄÁöÑÂºÄÂèë ÁÜüÊÇâLinux/Shell Â∑•‰ΩúÁªèÂéÜÊÄù‰Ω∞ÁõäÂøÖÊô∫‰ø°ÊÅØÊäÄÊúØÔºàÂ§ßËøûÔºâÊúâÈôêÂÖ¨Âè∏ 2021.1 ~ Ëá≥‰ªä APP DBA Êï∞ÊçÆËøÅÁßªÁ≥ªÁªü 2021.1 ~ Ëá≥‰ªäÊäÄÊúØÔºöKafka, Kafka Connect, Debezium, Oracle, PostgresÂèÇ‰∏éÊï∞ÊçÆËøÅÁßªÁ≥ªÁªüÁöÑ‰∫åÊ¨°ÂºÄÂèëÔºåÊäÄÊúØÊñπÊ°àË∞ÉÁ†îÔºåÊµãËØïÔºåËøêÁª¥ ÊéåÊè°‰∫ÜMySQLÊï∞ÊçÆËøÅÁßªÊñπÊ°à ÊéåÊè°‰∫ÜOracleÊï∞ÊçÆËøÅÁßªÊñπÊ°àÔºàÈó™ÂõûÊü•ËØ¢ + Logminer/XStreamÔºâ ÈòÖËØªÂπ∂ÊéåÊè°‰∫ÜÈÉ®ÂàÜDebeziumÊ∫êÁ†Å ÊúüÈó¥Ëá™Â≠¶‰∫ÜKafka/Kafka Connect Â§ßËøû‰∫ëÂå†ÁßëÊäÄ 2019.8 ~ 2021.1 ÂêéÁ´ØÁ†îÂèëÂ∑•Á®ãÂ∏à IronERP 2020.8 ~ 2021.1ÊäÄÊúØÔºöJava8, SpringBoot, Mybatis, MySQL, Redis, RocketMQÂèÇ‰∏éÂπ∂‰∏ªÂØº‰∫ÜËÆ¢ÂçïÊé®ÈÄÅÊ∂àË¥πÁöÑÂºÄÂèë ÊúüÈó¥Ëá™Â≠¶Âπ∂ÊéåÊè°‰∫ÜRocketMQ Áà±ÂøÉÂä©ÂÜú 2020.1 ~ 2020.6ÊäÄÊúØÔºöPHP, YII2, MySQL, RedisÂèÇ‰∏éÂπ∂‰∏ªÂØº‰∫ÜÂ∫ìÂ≠òÁöÑÈáçÊûÑÔºåËß£ÂÜ≥Ë∂ÖÂçñÈóÆÈ¢òÔºåÂπ∂ÊÄªÁªì‰∫ÜÂÆåÊï¥ÁöÑÂ∫ìÂ≠òÂÆûÁé∞ÊñπÊ°à ÈáçÊûÑÂéüÁ≥ªÁªü‰∏≠‰∏çÂêàÁêÜÁöÑÂ∫ìÂ≠òË°®ËÆæËÆ°ÔºåÂà©Áî®RedisÂëΩ‰ª§ÂéüÂ≠êÊÄßÁöÑÁâπÁÇπÔºå‰ΩøÁî®Redis+Lua‰Ωú‰∏∫Â∫ìÂ≠òÊâ£ÂáèÁöÑÊñ∞ÊñπÊ°à ÂêéÊù•ËøòÂèëÁé∞‰∫ÜËÆ¢ÂçïÁöÑÂπ∂ÂèëÊìç‰ΩúÊÉÖÂÜµÔºà‰æãÂ¶ÇÁî®Êà∑ÂèñÊ∂àÂíåÁ≥ªÁªüËá™Âä®ÂèñÊ∂àÔºåÁ≥ªÁªüËá™Âä®ÂèñÊ∂àÂíåÊîØ‰ªòÂõûË∞ÉÔºâÂêåÊ†∑‰ºöÈÄ†ÊàêË∂ÖÂçñÁöÑÁé∞Ë±°ÔºåÂàÜÂà´ÈíàÂØπËøô‰∫õÂú∫ÊôØÂÅö‰∫Ü‰ºòÂåñ ÊúüÈó¥Ëá™Â≠¶‰∫ÜPHPÁõ∏ÂÖ≥ÊäÄÊúØ Â∞èÂ§™ÁÜä/ÁîµÂïÜSaas 2019.8 - 2020.6ÊäÄÊúØÔºöJava8, SpringBoot, JdbcTemplate, SpringCloud Config, Spring Security, ElasticSearch, Redis, MySQL, RabbitMQÂèÇ‰∏éÂπ∂‰∏ªÂØº‰∫ÜÊ†∏ÂøÉ‰∏öÂä°ÁöÑËÆæËÆ°‰∏éÂºÄÂèëÔºåÂ¶Ç‰∫§ÊòìÂäüËÉΩÔºå‰øùËØÅÈáëÁõ∏ÂÖ≥ ÊéåÊè°MQÂÆûÁé∞ÂàÜÂ∏ÉÂºè‰∫ãÂä°ÁöÑÊñπÊ°à ÊéåÊè°Â¶Ç‰ΩïÂú®Âπ∂ÂèëÂú∫ÊôØÂ¢ûÂáèÂ∫ìÂ≠ò Â≠¶‰π†Âà∞‰∫ÜÂ¶Ç‰ΩïËÆæËÆ°ÂèØÊèíÊãîÁöÑ‰∏öÂä°Êèí‰ª∂ ÂºÄÂèë‰∫ÜÂü∫‰∫éLogbackÁöÑÂàÜÂ∏ÉÂºèÊó•ÂøóÊî∂ÈõÜ Â§ßËøû‰∏úÊñπ‰πãÊòü 2018.10 ~ 2019.8 ÂõΩÂÆ∂‰πâÂä°ÊïôËÇ≤‰ºòË¥®ÂùáË°°ÂèëÂ±ïËØÑ‰º∞Á≥ªÁªü 2018/10 ~ 2019/8ÊäÄÊúØÔºöJava8, SpringBoot, Mybatis, MySQL, Druid, Shiro, JWT, RedisÂèÇ‰∏éÂπ∂‰∏ªÂØº‰∫Ü‰∫ßÂìÅÂü∫Á°ÄÊû∂ÊûÑ‰∏éÊ†∏ÂøÉ‰∏öÂä°ÁöÑËÆæËÆ°„ÄÇËøòË¥üË¥£‰∫Ü‰∏öÂä°ÂäüËÉΩÁöÑÂàÜÈÖçÔºå‰ª£Á†ÅReviewÁ≠â ÂºÄÂèë‰∫ÜÂü∫‰∫éShiro + JwtÂÆûÁé∞‰∫ÜÁî®Êà∑Èâ¥ÊùÉ‰ª•ÂèäÈ¢òÂá∫Áî®Êà∑ÂäüËÉΩ ÂºÄÂèë‰∫ÜÂü∫‰∫éSpring AOP Âíå RedisÂàÜÂ∏ÉÂºèÈîÅÁöÑÈò≤Ê≠¢Âπ∂ÂèëÊèê‰∫§ÂäüËÉΩ Â§ßËøû‰∏áÊÄùÂä®ÁßëÊäÄ 2016.9 ~ 2018.10 ÈÄö‰ø°ËøêË°åÊñπÂºèÁÆ°ÁêÜÁ≥ªÁªüÔºàÂõΩÂÆ∂ÁîµÁΩëÔºâÊäÄÊúØÔºöJava8, Springboot, Mybatis, MySQL, Ehcache, ElasticSearch, Thymeleaf, Openlayer3ÂèÇ‰∏éÂπ∂‰∏ªÂØº‰∫ÜÊï¥‰∏™ÂêéÁ´Ø‰∏öÂä°ÁöÑËÆæËÆ°‰∏éÂºÄÂèë Ëá™Â≠¶Âπ∂ÊéåÊè°‰∫ÜDijkstraÁÆóÊ≥ïÔºåÁî®‰∫éÊïÖÈöúËøÇÂõûÁÆóÊ≥ïÁöÑÂºÄÂèë Ëá™Â≠¶Âπ∂ÊéåÊè°‰∫ÜElasticSearchÁöÑ‰ΩøÁî®ÔºåÂÆûÁé∞‰∫ÜÂàÜËØçÊêúÁ¥¢ÔºåÂêå‰πâËØçÂåπÈÖçÊêúÁ¥¢Á≠âÂäüËÉΩ Êô∫ÊÉ†Âà∞ÂÆ∂ÂïÜÂüé/ÂÖ±‰∫´ÂÜúÊú∫Âπ≥Âè∞ÊäÄÊúØÔºöJava8, Springboot, Mybatis, MySQL, Ehcache, FreeMarkerÂèÇ‰∏éÂπ∂‰∏ªÂØº‰∫ÜÂêéÁ´Ø‰∏öÂä°ÁöÑËÆæËÆ°‰∏éÂºÄÂèë„ÄÇËøòË¥üË¥£‰∫Ü‰∏öÂä°Á≥ªÁªüÊó•Â∏∏ÁöÑÁª¥Êä§‰ΩøÁî®Oauth2ËßÑËåÉÂºÄÂèë‰∫ÜÊéàÊùÉÊúçÂä°ÔºåÊâìÈÄö‰∏§‰∏™Á≥ªÁªüÁöÑÁî®Êà∑ÔºåÂÆûÁé∞ÂçïÁÇπÁôªÂΩïÁöÑÁõÆÁöÑ ÊäÄÊúØÊñáÁ´† Ê∑±ÂÖ•ÁêÜËß£ Dijkstra ÁÆóÊ≥ïÂÆûÁé∞ÂéüÁêÜ ÂàÜÂ∏ÉÂºè‰∫ãÂä° Seata ATÊ®°ÂºèÂéüÁêÜ‰∏éÂÆûÊàò ÁîµÂïÜÊäÄÊúØ ‚Äì Â∫ìÂ≠òËÆæËÆ°ÊåáÂåó Spring Ê∫êÁ†ÅËß£Êûê @RequestBody @ResponseBody ÁöÑÊù•ÈæôÂéªËÑâ ÊµÖÂÖ•ÊµÖÂá∫ Spring ‰∫ãÂä°‰º†Êí≠ÂÆûÁé∞ÂéüÁêÜ Redisson Ê∫êÁ†ÅËß£ÊûêÔºåÂ¶Ç‰ΩïÂà©Áî®RedisÂÆûÁé∞ÂàÜÂ∏ÉÂºèÂèØÈáçÂÖ•ÈîÅ Ëá¥Ë∞¢ÊÑüË∞¢ÊÇ®Ëä±Êó∂Èó¥ÈòÖËØªÊàëÁöÑÁÆÄÂéÜÔºåÊúüÂæÖËÉΩÊúâÊú∫‰ºöÂíåÊÇ®ÂÖ±‰∫ã„ÄÇ]]></content>
      <categories>
        <category>resume</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[ÂàÜÂ∏ÉÂºè‰∫ãÂä° Seata ATÊ®°ÂºèÂéüÁêÜ‰∏éÂÆûÊàò]]></title>
    <url>%2Fpost%2F6fe3d525.html</url>
    <content type="text"><![CDATA[Seata ÊòØÈòøÈáåÂºÄÊ∫êÁöÑÂü∫‰∫éJavaÁöÑÂàÜÂ∏ÉÂºè‰∫ãÂä°Ëß£ÂÜ≥ÊñπÊ°à ATÔºåXAÔºåTCCÔºåSagaSeata Êèê‰æõÂõõÁßçÊ®°ÂºèËß£ÂÜ≥ÂàÜÂ∏ÉÂºè‰∫ãÂä°Âú∫ÊôØÔºåATÔºåXAÔºåTCCÔºåSaga„ÄÇÁÆÄÂçïÂè®ÂíïÂè®ÂíïÊàëÂØπËøôÂá†ÁßçÊ®°ÂºèÁöÑÁêÜËß£ AT ËøôÊòØSeataÁöÑ‰∏ÄÂ§ßÁâπËâ≤ÔºåATÂØπ‰∏öÂä°‰ª£Á†ÅÂÆåÂÖ®Êó†‰æµÂÖ•ÊÄßÔºå‰ΩøÁî®ÈùûÂ∏∏ÁÆÄÂçïÔºåÊîπÈÄ†ÊàêÊú¨‰Ωé„ÄÇÊàë‰ª¨Âè™ÈúÄË¶ÅÂÖ≥Ê≥®Ëá™Â∑±ÁöÑ‰∏öÂä°SQLÔºåSeata‰ºöÈÄöËøáÂàÜÊûêÊàë‰ª¨‰∏öÂä°SQLÔºåÂèçÂêëÁîüÊàêÂõûÊªöÊï∞ÊçÆ AT ÂåÖÂê´‰∏§‰∏™Èò∂ÊÆµ ‰∏ÄÈò∂ÊÆµÔºåÊâÄÊúâÂèÇ‰∏é‰∫ãÂä°ÁöÑÂàÜÊîØÔºåÊú¨Âú∞‰∫ãÂä°Commit ‰∏öÂä°Êï∞ÊçÆÂíåÂõûÊªöÊó•ÂøóÔºàundoLogÔºâ ‰∫åÈò∂ÊÆµÔºå‰∫ãÂä°ÂçèË∞ÉËÄÖÊ†πÊçÆÊâÄÊúâÂàÜÊîØÁöÑÊÉÖÂÜµÔºåÂÜ≥ÂÆöÊú¨Ê¨°ÂÖ®Â±Ä‰∫ãÂä°ÊòØCommit ËøòÊòØ RollbackÔºà‰∫åÈò∂ÊÆµÊòØÂÆåÂÖ®ÂºÇÊ≠•Ôºâ XA‰πüÊòØÊàë‰ª¨Â∏∏ËØ¥ÁöÑ‰∫åÈò∂ÊÆµÊèê‰∫§ÔºåXAË¶ÅÊ±ÇÊï∞ÊçÆÂ∫ìÊú¨Ë∫´Êèê‰æõÂØπËßÑËåÉÂíåÂçèËÆÆÁöÑÊîØÊåÅ„ÄÇXAÁî®Ëµ∑Êù•ÁöÑËØùÔºå‰πüÊòØÂØπ‰∏öÂä°‰ª£Á†ÅÊó†‰æµÂÖ•ÊÄßÁöÑ„ÄÇ ‰∏äËø∞ÂÖ∂‰ªñ‰∏âÁßçÊ®°ÂºèÔºåÈÉΩÊòØÂ±û‰∫éË°•ÂÅøÂûãÔºåÊó†Ê≥ï‰øùËØÅÂÖ®Â±Ä‰∏ÄËá¥ÊÄß„ÄÇÂï•ÊÑèÊÄùÂë¢Ôºå‰æãÂ¶ÇÂàöÂàöËØ¥ÁöÑATÊ®°ÂºèÔºåÊàë‰ª¨ÊòØÂèØËÉΩËØªÂà∞Ëøô‰∏ÄÊ¨°ÂàÜÂ∏ÉÂºè‰∫ãÂä°ÁöÑ‰∏≠Èó¥Áä∂ÊÄÅÔºåËÄåXAÊ®°Âºè‰∏ç‰ºö„ÄÇ Ë°•ÂÅøÂûã ‰∫ãÂä°Â§ÑÁêÜÊú∫Âà∂ÊûÑÂª∫Âú® ‰∫ãÂä°ËµÑÊ∫êÔºàÊï∞ÊçÆÂ∫ìÔºâ ‰πã‰∏äÔºàË¶Å‰πàÂú®‰∏≠Èó¥‰ª∂Â±ÇÈù¢ÔºåË¶Å‰πàÂú®Â∫îÁî®Â±ÇÈù¢ÔºâÔºå‰∫ãÂä°ËµÑÊ∫ê Êú¨Ë∫´ÂØπÂàÜÂ∏ÉÂºè‰∫ãÂä°ÊòØÊó†ÊÑüÁü•ÁöÑÔºåËøô‰πüÂ∞±ÂØºËá¥‰∫ÜË°•ÂÅøÂûã‰∫ãÂä°Êó†Ê≥ïÂÅöÂà∞ÁúüÊ≠£ÁöÑ ÂÖ®Â±Ä‰∏ÄËá¥ÊÄß „ÄÇÊØîÂ¶ÇÔºå‰∏ÄÊù°Â∫ìÂ≠òËÆ∞ÂΩïÔºåÂ§ÑÂú® Ë°•ÂÅøÂûã ‰∫ãÂä°Â§ÑÁêÜËøáÁ®ã‰∏≠ÔºåÁî± 100 Êâ£Âáè‰∏∫ 50„ÄÇÊ≠§Êó∂Ôºå‰ªìÂ∫ìÁÆ°ÁêÜÂëòËøûÊé•Êï∞ÊçÆÂ∫ìÔºåÊü•ËØ¢ÁªüËÆ°Â∫ìÂ≠òÔºåÂ∞±ÁúãÂà∞ÂΩìÂâçÁöÑ 50„ÄÇ‰πãÂêéÔºå‰∫ãÂä°Âõ†‰∏∫ÊÑèÂ§ñÂõûÊªöÔºåÂ∫ìÂ≠ò‰ºöË¢´Ë°•ÂÅøÂõûÊªö‰∏∫ 100„ÄÇÊòæÁÑ∂Ôºå‰ªìÂ∫ìÁÆ°ÁêÜÂëòÊü•ËØ¢ÁªüËÆ°Âà∞ÁöÑ 50 Â∞±ÊòØ ËÑè Êï∞ÊçÆ„ÄÇÂ¶ÇÊûúÊòØXAÁöÑËØùÔºå‰∏≠Èó¥ÊÄÅÊï∞ÊçÆÂ∫ìÂ≠ò 50 Áî±Êï∞ÊçÆÂ∫ìÊú¨Ë∫´‰øùËØÅÔºå‰∏ç‰ºöË¢´‰ªìÂ∫ìÁÆ°ÁêÜÂëòËØªÂà∞ÔºàÂΩìÁÑ∂ÈöîÁ¶ªÁ∫ßÂà´ÈúÄË¶Å ËØªÂ∑≤Êèê‰∫§ ‰ª•‰∏äÔºâ ‰ΩÜÊòØÂÖ®Â±Ä‰∏ÄËá¥ÊÄßÂ∏¶Êù•ÁöÑÁªìÊûúÂ∞±ÊòØÊï∞ÊçÆÁöÑÈîÅÂÆöÔºàATÊ®°Âºè‰πüÊòØÂ≠òÂú®ÂÖ®Â±ÄÈîÅÁöÑÔºå‰ΩÜÊòØÈöîÁ¶ªÁ∫ßÂà´Êó†Ê≥ï‰øùËØÅÔºåÂêéËæπÊàë‰ª¨‰ºöËØ¶ÁªÜËØ¥ÔºâÔºå‰æãÂ¶ÇÂÖ®Â±Ä‰∫ãÂä°‰∏≠Êúâ‰∏ÄÊù°updateËØ≠Âè•ÔºåÂÖ∂‰ªñ‰∫ãÂä°ÊÉ≥Ë¶ÅÊõ¥Êñ∞Âêå‰∏ÄÊù°Êï∞ÊçÆÁöÑËØùÔºåÂè™ËÉΩÁ≠âÂæÖÂÖ®Â±Ä‰∫ãÂä°ÁªìÊùü ‰º†ÁªüXAÊ®°ÂºèÊòØÂ≠òÂú®‰∏Ä‰∫õÈóÆÈ¢òÁöÑÔºåSeata‰πüÊòØÂÅö‰∫ÜÁõ∏ÂÖ≥ÁöÑ‰ºòÂåñÔºåÊõ¥Â§öÂÖ≥‰∫éSeata XAÁöÑÂÜÖÂÆπÔºå‰º†ÈÄÅÈó®üëâhttp://seata.io/zh-cn/blog/seata-xa-introduce.html TCC TCC Ê®°ÂºèÂêåÊ†∑ÂåÖÂê´‰∏§‰∏™Èò∂ÊÆµ Try Èò∂ÊÆµ ÔºöÊâÄÊúâÂèÇ‰∏éÂàÜÂ∏ÉÂºè‰∫ãÂä°ÁöÑÂàÜÊîØÔºåÂØπ‰∏öÂä°ËµÑÊ∫êËøõË°åÊ£ÄÊü•ÂíåÈ¢ÑÁïô ‰∫åÈò∂ÊÆµ ConfirmÔºöÊâÄÊúâÂàÜÊîØÁöÑTryÂÖ®ÈÉ®ÊàêÂäüÂêéÔºåÊâßË°å‰∏öÂä°Êèê‰∫§ ‰∫åÈò∂ÊÆµ CancelÔºöÂèñÊ∂àTryÈò∂ÊÆµÈ¢ÑÁïôÁöÑ‰∏öÂä°ËµÑÊ∫ê ÂØπÊØîATÊàñËÄÖXAÊ®°ÂºèÊù•ËØ¥ÔºåTCCÊ®°ÂºèÈúÄË¶ÅÊàë‰ª¨Ëá™Â∑±ÊäΩË±°Âπ∂ÂÆûÁé∞TryÔºåConfirmÔºåCancel‰∏â‰∏™Êé•Âè£ÔºåÁºñÁ†ÅÈáè‰ºöÂ§ß‰∏Ä‰∫õÔºå‰ΩÜÊòØÁî±‰∫é‰∫ãÂä°ÁöÑÊØè‰∏Ä‰∏™Èò∂ÊÆµÈÉΩÁî±ÂºÄÂèë‰∫∫ÂëòËá™Ë°åÂÆûÁé∞„ÄÇËÄå‰∏îÁõ∏ËæÉ‰∫éATÊ®°ÂºèÊù•ËØ¥ÔºåÂáèÂ∞ë‰∫ÜSQLËß£ÊûêÁöÑËøáÁ®ãÔºå‰πüÊ≤°ÊúâÂÖ®Â±ÄÈîÅÁöÑÈôêÂà∂ÔºåÊâÄ‰ª•TCCÊ®°ÂºèÁöÑÊÄßËÉΩÊòØ‰ºò‰∫éAT „ÄÅXAÊ®°Âºè„ÄÇPSÔºöÊûúÁÑ∂ÁÆÄÂçïÂíåÈ´òÊïàÈöæ‰ª•‰∏§ÂÖ®ÁöÑ Saga Saga ÊòØÈïø‰∫ãÂä°Ëß£ÂÜ≥ÊñπÊ°àÔºåÊØè‰∏™ÂèÇ‰∏éËÄÖÈúÄË¶ÅÂÆûÁé∞‰∫ãÂä°ÁöÑÊ≠£ÂêëÊìç‰ΩúÂíåË°•ÂÅøÊìç‰Ωú„ÄÇÂΩìÂèÇ‰∏éËÄÖÊ≠£ÂêëÊìç‰ΩúÊâßË°åÂ§±Ë¥•Êó∂ÔºåÂõûÊªöÊú¨Âú∞‰∫ãÂä°ÁöÑÂêåÊó∂Ôºå‰ºöË∞ÉÁî®‰∏ä‰∏ÄÈò∂ÊÆµÁöÑË°•ÂÅøÊìç‰ΩúÔºåÂú®‰∏öÂä°Â§±Ë¥•Êó∂ÊúÄÁªà‰ºö‰Ωø‰∫ãÂä°ÂõûÂà∞ÂàùÂßãÁä∂ÊÄÅ Saga‰∏éTCCÁ±ª‰ººÔºåÂêåÊ†∑Ê≤°ÊúâÂÖ®Â±ÄÈîÅ„ÄÇÁî±‰∫éÁõ∏ÊØîÁº∫Â∞ëÈîÅÂÆöËµÑÊ∫êËøô‰∏ÄÊ≠•ÔºåÂú®Êüê‰∫õÈÄÇÂêàÁöÑÂú∫ÊôØÔºåSagaË¶ÅÊØîTCCÂÆûÁé∞Ëµ∑Êù•Êõ¥ÁÆÄÂçï„ÄÇÁî±‰∫éSagaÂíåTCCÈÉΩÈúÄË¶ÅÊàë‰ª¨ÊâãÂä®ÁºñÁ†ÅÂÆûÁé∞ÔºåÊâÄ‰ª•Âú®ÂºÄÂèëÊó∂Êàë‰ª¨ÈúÄË¶ÅÂèÇËÄÉ‰∏Ä‰∫õËÆæËÆ°‰∏äÁöÑËßÑËåÉÔºåÁî±‰∫é‰∏çÊòØÊú¨ÊñáÈáçÁÇπÔºåËøôÈáåÂ∞±‰∏çÂ§öËØ¥‰∫ÜÔºåÂèØ‰ª•ÂèÇËÄÉÂàÜÂ∏ÉÂºè‰∫ãÂä° Seata ÂèäÂÖ∂‰∏âÁßçÊ®°ÂºèËØ¶Ëß£ Âú®Êàë‰ª¨‰∫ÜËß£ÂÆåÂõõÁßçÂàÜÂ∏ÉÂºè‰∫ãÂä°ÁöÑÂéüÁêÜ‰πãÂêéÔºåÊàë‰ª¨ÂõûÂà∞Êú¨ÊñáÈáçÁÇπATÊ®°Âºè AT Â¶Ç‰Ωï‰ΩøÁî®Ê®°ÊãüÈúÄÊ±ÇÔºö‰ª•‰∏ãËÆ¢Âçï‰∏∫‰æãÔºåÂú®ÂàÜÂ∏ÉÂºèÁöÑÁîµÂïÜÂú∫ÊôØ‰∏≠ÔºåËÆ¢ÂçïÊúçÂä°ÂíåÂ∫ìÂ≠òÊúçÂä°ÂèØËÉΩÊòØ‰∏§‰∏™Êï∞ÊçÆÂ∫ì Êàë‰ª¨ÂÖàÊù•ÁúãÁúãATÊ®°Âºè‰∏ãÁöÑ‰ª£Á†ÅÊòØ‰ªÄ‰πàÊ†∑ÁöÑÔºåËøôÈáåÂøΩÁï•‰∫ÜSeataÁöÑÁõ∏ÂÖ≥ÈÖçÁΩÆÔºåÂè™Áúã‰∏öÂä°ÈÉ®ÂàÜ Âú®ÈúÄË¶ÅÂºÄÂêØÂàÜÂ∏ÉÂºè‰∫ãÂä°ÁöÑÊñπÊ≥ï‰∏äÊ†áËÆ∞@GlobalTransactionalÔºåÁÑ∂ÂêéÊâßË°åÂàÜÂà´ÊâßË°åÊâ£ÂáèÂ∫ìÂ≠òÂíåÊâ£ÂáèÂ∫ìÂ≠òÊìç‰ΩúÁöÑÔºå‰∫ãÂä°ÁöÑÂèÇ‰∏éËÄÖÂèØ‰ª•ÊòØÊú¨Âú∞ÁöÑÊï∞ÊçÆÊ∫êÔºåÊàñËÄÖRPCÁöÑËøúÁ®ãË∞ÉÁî®ÔºàËøúÁ®ãË∞ÉÁî®ÁöÑËØùÈúÄË¶ÅÊê∫Â∏¶ÂÖ®Â±Ä‰∫ãÂä°IDÔºå‰πüÂ∞±ÊòØ‰∏äÂõæÁöÑxidÔºâ AT ‰∏ÄÈò∂ÊÆµ‰πãÂâçËØ¥ËøáATÊ®°ÂºèÂàÜ‰∏∫‰∏§‰∏™Èò∂ÊÆµÔºåÁ¨¨‰∏ÄÈò∂ÊÆµÂåÖÊã¨Êèê‰∫§‰∏öÂä°Êï∞ÊçÆÂíåÂõûÊªöÊó•ÂøóÔºàundoLogÔºâÔºåÁ¨¨‰∏ÄÈò∂ÊÆµÂÖ∑‰ΩìÊµÅÁ®ãÂ¶Ç‰∏ãÂõæ GlobalTransactional ÂàáÈù¢Ê†áËÆ∞@GlobalTransactionalÁöÑÊñπÊ≥ïÈÄöËøáAOPÂÆûÁé∞‰∫ÜÔºåÂºÄÂêØÂÖ®Â±Ä‰∫ãÂä°ÂíåÊèê‰∫§ÂÖ®Â±Ä‰∫ãÂä°‰∏§‰∏™Êìç‰ΩúÔºå‰∏éSpring ‰∫ãÂä°Êú∫Âà∂Á±ª‰ººÔºåÂΩì GlobalTransactionalInterceptor Âú®‰∫ãÂä°ÊâßË°åËøáÁ®ã‰∏≠ÊçïËé∑Âà∞ThrowableÊó∂Ôºå‰ºöÂèëËµ∑ÂÖ®Â±Ä‰∫ãÂä°ÂõûÊªö 0.1 Ê≠•È™§‰∏≠‰ºöÁîüÊàê‰∏Ä‰∏™ÂÖ®Â±Ä‰∫ãÂä°ID 0.2 ÊâÄÊúâ‰∫ãÂä°ÂèÇ‰∏éËÄÖÊâßË°åÁªìÊùüÂêéÔºå‰∏ÄÈò∂ÊÆµ‰∫ãÂä°Êèê‰∫§ undoLogÊàë‰ª¨ÂÖàÊù•ÁúãÁúã Seata undoLog ÁöÑÁªìÊûÑ1234567891011// ÁúÅÁï•‰∫ÜÁõ∏ÂÖ≥ÊñπÊ≥ïpublic class SQLUndoLog &#123; // insert, update ... private SQLType sqlType; private String tableName; private TableRecords beforeImage; private TableRecords afterImage;&#125; Seata Âú®ÊâßË°å‰∏öÂä°SQLÂâçÂêéÔºå‰ºöÁîüÊàêbeforeImageÂíåafterImageÔºåÂú®ÈúÄË¶ÅÂõûÊªöÊó∂ÔºåÊ†πÊçÆSQLTypeÔºåÂÜ≥ÂÆöÂÖ∑‰ΩìÁöÑÂõûÊªöÁ≠ñÁï•Ôºå‰æãÂ¶ÇSQLType=updateÊó∂ÔºåÂ∞ÜÊï∞ÊçÆÂõûÊªöÂà∞beforeImageÁöÑÁä∂ÊÄÅÔºåÂ¶ÇÊûúSQLType=insertÔºåÂàôÊ†πÊçÆafterImageÂà†Èô§Êï∞ÊçÆ Â¶Ç2.4ÊâÄÁ§∫ÔºåÊØèÊù°‰∏öÂä°SQLÔºåÊâßË°åÊàêÂäüÂêéÔºå‰ºö‰∏∫ËøôÊù°SQLÁîüÊàêLockKeyÔºåÊ†ºÂºè‰∏∫tableName:PrimaryKey Ê≥®ÂÜåÂàÜÊîØ‰∫ãÂä°Âú®3.1Ê≠•È™§Ê≥®ÂÜåÂàÜÊîØ‰∫ãÂä°Êó∂Ôºåclient‰ºöÊääÊâÄÊúâÁöÑLockKey ÊãºÂà∞‰∏ÄËµ∑‰Ωú‰∏∫ÂÖ®Â±ÄÈîÅÂèëÈÄÅÁªôSeata-server„ÄÇÂ¶ÇÊûúÊ≥®ÂÜåÊàêÂäüÔºåÂÜôÂÖ•undoLogÔºåÂπ∂Êèê‰∫§Êú¨Âú∞‰∫ãÂä°Ôºå‰∏ÄÈò∂ÊÆµÁªìÊùüÔºåÁ≠âÂæÖ‰∫åÈò∂ÊÆµÂèçÈ¶à Â¶ÇÊûúÂΩìÂâçÊúâÂÖ∂‰ªñÂàÜÊîØ‰∫ãÂä°Â∑≤ÁªèÊåÅÊúâ‰∫ÜÁõ∏ÂêåÁöÑÈîÅÔºàÂç≥ÂÖ∂‰ªñ‰∫ãÂä°‰πüÂú®Â§ÑÁêÜÁõ∏ÂêåË°®ÁöÑÂêå‰∏ÄË°åÔºâÔºåÂàôclient Ê≥®ÂÜå‰∫ãÂä°ÂàÜÊîØÂ§±Ë¥•„ÄÇclient‰ºöÊ†πÊçÆÂÆ¢Êà∑Á´ØÂÆö‰πâÁöÑÈáçÂèëÊó∂Èó¥ÂíåÈáçÂèëÊ¨°Êï∞ËøõË°å‰∏çÊñ≠ÁöÑÂ∞ùËØïÔºåÂ¶ÇÊûúÈáçËØïÁªìÊùü‰ªçÁÑ∂Ê≤°ÊúâËé∑ÂæóÈîÅÔºåÂàô‰∏ÄÈò∂ÊÆµÂ§±Ë¥•ÔºåÊú¨Âú∞‰∫ãÂä°ÂõûÊªö„ÄÇÂ¶ÇÊûúËØ•ÂÖ®Â±Ä‰∫ãÂä°Â≠òÂú®Â∑≤ÁªèÊ≥®ÂÜåÊàêÂäüÂàÜÊîØ‰∫ãÂä°ÔºåSeata-server ËøõË°å‰∫åÈò∂ÊÆµÂõûÊªö ÂÖ®Â±ÄÈîÅ‰ºöÂú®ÂàÜÊîØ‰∫ãÂä°‰∫åÈò∂ÊÆµÁªìÊùüÂêéÈáäÊîæ Seata ÂÖ®Â±ÄÈîÅÁöÑËÆæËÆ°ÊòØ‰∏∫‰∫Ü‰ªÄ‰πàÔºü‰ª•Êâ£ÂáèÂ∫ìÂ≠òÂú∫ÊôØ‰∏∫‰æãÔºåTX1 ÂÆåÊàêÂ∫ìÂ≠òÊâ£ÂáèÁöÑ‰∏ÄÈò∂ÊÆµÔºåÂ∫ìÂ≠ò‰ªé100Êâ£Âáè‰∏∫99ÔºåÊ≠£Âú®Á≠âÂæÖ‰∫åÈò∂ÊÆµÁöÑÈÄöÁü•„ÄÇTX2‰πüË¶ÅÊâ£ÂáèÂêå‰∏ÄÂïÜÂìÅÁöÑÂ∫ìÂ≠òÔºåÂ¶ÇÊûúÊ≤°ÊúâÂÖ®Â±ÄÈîÅÁöÑÈôêÂà∂ÔºåTX2Â∫ìÂ≠ò‰ªé99Êâ£Âáè‰∏∫98ÔºåËøôÊó∂Â¶ÇÊûúTX1Êé•Êî∂Âà∞ÂõûÊªöÈÄöÁü•ÔºåËøõË°åÂõûÊªöÊääÂ∫ìÂ≠ò‰ªé98ÂõûÊªöÂà∞100„ÄÇÂõ†‰∏∫Ê≤°ÊúâÂÖ®Â±ÄÈîÅÔºåÈÄ†Êàê‰∫ÜËÑèÂÜô AT ‰∫åÈò∂ÊÆµ‰∫åÈò∂ÊÆµÊòØÂÆåÂÖ®ÂºÇÊ≠•ÂåñÁöÑÂπ∂‰∏îÂÆåÂÖ®Áî±SeataÊéßÂà∂ÔºåSeataÊ†πÊçÆÊâÄÊúâ‰∫ãÂä°ÂèÇ‰∏éËÄÖÁöÑÊèê‰∫§ÊÉÖÂÜµÂÜ≥ÂÆö‰∫åÈò∂ÊÆµÂ¶Ç‰ΩïÂ§ÑÁêÜ Â¶ÇÊûúÊâÄÊúâ‰∫ãÂä°Êèê‰∫§ÊàêÂäüÔºåÂàô‰∫åÈò∂ÊÆµÁöÑ‰ªªÂä°Â∞±ÊòØÂà†Èô§‰∏ÄÈò∂ÊÆµÁîüÊàê ÁöÑundoLogÔºåÂπ∂ÈáäÊîæÂÖ®Â±ÄÈîÅ Â¶ÇÊûúÈÉ®ÂàÜ‰∫ãÂä°ÂèÇ‰∏éËÄÖÊèê‰∫§Â§±Ë¥•ÔºåÂàôÈúÄË¶ÅÊ†πÊçÆundoLogÂØπÂ∑≤ÁªèÊ≥®ÂÜåÁöÑ‰∫ãÂä°ÂàÜÊîØËøõË°åÂõûÊªöÔºåÂπ∂ÈáäÊîæÂÖ®Â±ÄÈîÅ ÂØπSeataÊèêÂá∫ÁöÑÁñëÈóÆËá≥Ê≠§Êàë‰ª¨Â∑≤ÁªèÂàùÊ≠•‰∫ÜËß£‰∫ÜSeataÁöÑATÊ®°ÂºèÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑ‰∫Ü Â¶ÇÊûú‰Ω†‰πüÂíåÊàë‰∏ÄÊ†∑Ôºå‰ªîÁªÜÊÄùËÄÉ‰∫Ü‰∏äËø∞ËøáÁ®ãÔºåÂèØËÉΩ‰ºöÊèêÂá∫‰∏Ä‰∫õÈóÆÈ¢òÔºåËøôËæπÊàëÂàó‰∏æ‰∏Ä‰∏ãÊàëÂú®Â≠¶‰π†SeataÊó∂ÔºåÈÅáÂà∞ÁöÑÈóÆÈ¢òÔºå‰ª•ÂèäÊàëÂæóÂá∫ÁöÑÁªìËÆ∫ ÈóÆÈ¢ò1. SeataÂ¶Ç‰ΩïÂÅöÂà∞Êó†‰æµÂÖ•ÁöÑÂàÜÊûê‰∏öÂä°SQLÁîüÊàêundoLogÔºåÊ≥®ÂÜå‰∫ãÂä°ÂàÜÊîØÁ≠âÊìç‰ΩúÔºü Seata ‰ª£ÁêÜ‰∫ÜDataSourceÔºåÊàë‰ª¨ÂèØ‰ª•ÈÄöËøáÂú®‰ª£Á†ÅÊ≥®ÂÖ•‰∏Ä‰∏™DataSourceÊù•È™åËØÅÊàëÁöÑËØ¥Ê≥ïÔºåÁõÆÂâçÁöÑDataSource ÊòØ io.seata.rm.datasource.DataSourceProxy ÊâÄÊúâÁöÑJavaÊåÅ‰πÖÂåñÊ°ÜÊû∂ÔºåÊúÄÁªàÂú®Êìç‰ΩúÊï∞ÊçÆÂ∫ìÊó∂ÈÉΩ‰ºöÈÄöËøáDataSourceÊé•Âè£Ëé∑ÂèñConnectionÔºåÈÄöËøáConnection ÂÆûÁé∞ÂØπÊï∞ÊçÆÂ∫ìÁöÑÂ¢ûÂà†ÊîπÊü•Ôºå‰∫ãÂä°ÊéßÂà∂„ÄÇ Seata ÈÄöËøá‰ª£ÁêÜConnectionÁöÑÊñπÂºèÔºåÂÅöÂà∞‰∫ÜÊó†‰æµÂÖ•ÁöÑÁîüÊàêundoLogÔºåÊ≥®ÂÜå‰∫ãÂä°ÂàÜÊîØÔºåÂÖ∑‰ΩìÊ∫êÁ†ÅÂèØ‰ª•Êü•Áúãio.seata.rm.datasource.ConnectionProxy ÈóÆÈ¢ò2. ConnectionProxy Â¶Ç‰ΩïÂà§Êñ≠ÂΩìÂâç‰∫ãÂä°ÊòØÂÖ®Â±Ä‰∫ãÂä°ÔºåËøòÊòØÊú¨Âú∞‰∫ãÂä°Ôºü ÈÄöËøáÂΩìÂâçÁ∫øÁ®ãÊòØÂê¶ÁªëÂÆö‰∫ÜÂÖ®Â±Ä‰∫ãÂä°idÔºåÂú®ËøõË°åÂÖ®Â±Ä‰∫ãÂä°‰πãÂâçÔºåÈúÄË¶ÅË∞ÉÁî®RootContext.bind(xid); ÈóÆÈ¢ò3. ÂÖ®Â±Ä‰∫ãÂä°Âπ∂ÂèëÊõ¥Êñ∞ ËøòÊòØ‰ª•‰∏ãËÆ¢ÂçïÊâ£ÂáèÂ∫ìÂ≠òÁöÑÂú∫ÊôØ‰∏∫‰æãÔºåÂ¶ÇÊûúTX1ÂíåTX2ÂêåÊó∂Êâ£Âáèproduct_id‰∏∫1ÁöÑÂ∫ìÂ≠òÔºåËøôÊó∂Seata‰ºö‰∏ç‰ºöÁîüÊàêÁõ∏ÂêåÁöÑbeforeImageÔºü ‰∏æ‰∏™‰æãÂ≠êÔºåTX1ËØªÂ∫ìÂ≠ò‰∏∫100ÔºåTX1Êâ£ÂáèÂ∫ìÂ≠ò1ÔºåÊ≠§Êó∂BeforeImage‰∏∫100Á¥ßÊé•ÁùÄ Â¶ÇÊûúTX2ËØªÂ∫ìÂ≠ò‰πü‰∏∫100ÔºåÈÇ£‰πàÂ∞±ÊúâÈóÆÈ¢ò‰∫ÜÔºå‰∏çÁÆ°TX2Êâ£ÂáèÂ§öÂ∞ëÂ∫ìÂ≠òÔºåÂ¶ÇÊûúTX1ÂõûÊªöÈÇ£‰πàÁõ∏ÂΩì‰∫éË¶ÜÁõñ‰∫ÜTX2Êâ£ÂáèÁöÑÂ∫ìÂ≠òÔºåÂá∫Áé∞‰∫ÜËÑèÂÜô SeataÊòØÂ¶Ç‰ΩïËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÁöÑÔºü Ê∫êÁ†Å‰ΩçÁΩÆÔºöio.seata.rm.datasource.exec.AbstractDMLBaseExecutor::executeAutoCommitFalse ÂèØ‰ª•ÁúãÂà∞ËøôÈáåÁöÑÈÄªËæëÂíåÊàë‰∏äÈù¢ÁîªÁöÑÂõæ‰∏ÄËá¥ÔºåËØÅÊòéÊàëÊ≤°ÊúâÁûéËØ¥ üòÑ Êàë‰ª¨Êù•Áúã‰∏Ä‰∏ãbeforeImage()ÔºåËøôÊòØ‰∏Ä‰∏™ÊäΩË±°ÊñπÊ≥ïÔºåÁúã‰∏Ä‰∏ã‰ªñÁöÑÂ≠êÁ±ªUpdateExecutorÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑ ÈÄöËøáDebugÔºåÂèØ‰ª•ÁúãÂá∫SeataËøôËæπ‰πüÊòØÁ°ÆÂÆûËÄÉËôë‰∫ÜËøô‰∏™ÈóÆÈ¢òÔºåÁõ¥Êé•ÁÆÄÂçïËÄåÊúâÊïàÁöÑËß£ÂÜ≥‰∫ÜËøô‰∏™ÈóÆÈ¢ò ÂõûÂà∞Êàë‰ª¨ÁöÑ‰æãÂ≠êÔºåÁî±‰∫éSELECT FOR UPDATEÁöÑÂ≠òÂú®ÔºåTX2Â¶ÇÊûú‰πüÊÉ≥ËØªÂêå‰∏ÄÊù°Êï∞ÊçÆÁöÑËØùÔºåÂè™ËÉΩÁ≠âÂà∞TX1 Êèê‰∫§‰∫ãÂä°ÂêéÔºåÊâçËÉΩËØªÂà∞„ÄÇÊâÄ‰ª•ÈóÆÈ¢òËß£ÂÜ≥ ÈóÆÈ¢ò4. ÂÖ®Â±Ä‰∫ãÂä°Â§ñÁöÑÊõ¥Êñ∞ Êàë‰ª¨Áé∞Âú®ÂèØ‰ª•Á°ÆËÆ§Âú®SeataÁöÑ‰øùËØÅ‰∏ãÔºåÂÖ®Â±Ä‰∫ãÂä°Ôºå‰∏ç‰ºöÈÄ†ÊàêÊï∞ÊçÆÁöÑËÑèÂÜôÔºå‰ΩÜÊòØÂÖ®Â±Ä‰∫ãÂä°Â§ñ‰ºöÔºÅ ‰ªÄ‰πàÊÑèÊÄùÂë¢Ôºü Ëøò‰ª•Â∫ìÂ≠ò‰∏∫‰æã Áî®Êà∑Ê≠£Âú®Êä¢Ë¥≠ÔºåÁî®Êà∑AÂÆåÊàê‰∫Ü1Èò∂ÊÆµÁöÑÂ∫ìÂ≠òÊâ£ÂáèÔºåËøô‰∏™Êó∂ÂÄôÂ∫ìÂ≠ò‰∏∫99„ÄÇ Ê≠§Êó∂Â∫ìÂ≠òÁÆ°ÁêÜÂëò‰∏äÁ∫ø‰∫ÜÔºå‰ªñÊü•‰∫Ü‰∏Ä‰∏ãÂ∫ìÂ≠ò‰∏∫99„ÄÇÂóØ‚Ä¶Â§™Â∞ë‰∫ÜÔºåÊàëÂä†100‰∏™ÔºåÂ∫ìÂ≠òÁÆ°ÁêÜÂëòÊääÂ∫ìÂ≠òÊõ¥Êñ∞‰∏∫200„ÄÇ ËÄåÊ≠§Êó∂seataÁªôÁî®Êà∑AÁîüÊàêbeforeImage‰∏∫100ÔºåÂ¶ÇÊûúÊ≠§Êó∂Áî®Êà∑AÁöÑÂÖ®Â±Ä‰∫ãÂä°Â§±Ë¥•‰∫ÜÔºåÂèëÁîü‰∫ÜÂõûÊªöÔºåÂÜçÊ¨°Â∞ÜÂ∫ìÂ≠òÊõ¥Êñ∞‰∏∫100‚Ä¶ ÂÜçÊ¨°Âá∫Áé∞ËÑèÂÜô Seata ÈíàÂØπËøô‰∏™ÈóÆÈ¢òÔºåÊèê‰æõ‰∫Ü@GlobalLockÊ≥®Ëß£ÔºåÊ†áËÆ∞ËØ•Ê≥®Ëß£Êó∂Ôºå‰ºöÂÉèÂÖ®Â±Ä‰∫ãÂä°‰∏ÄÊ†∑ËøõË°åSQLÂàÜÊûêÔºåÁ´û‰∫âÂÖ®Â±ÄÈîÅÔºåÂ∞±‰∏ç‰ºöÂá∫Áé∞‰∏äËø∞ÈóÆÈ¢ò‰∫Ü ÂÖ≥‰∫éËøô‰∏™ÈóÆÈ¢òÂèØ‰ª•ÂèÇËÄÉSeataÁöÑFAQÊñáÊ°£ http://seata.io/zh-cn/docs/overview/faq.html ÈóÆÈ¢ò5. @GlobalTransactional Âíå @Transactional ÂêåÊó∂‰ΩøÁî®‰ºöÊÄé‰πàÊ†∑ Êàë‰ª¨‰∏äÊñá‰∏≠Â∑≤ÁªèËØ¥Ëøá‰∫Ü @GlobalTransactional ÁöÑ‰ΩúÁî®‰∫ÜÔºå‰ªñÊòØË¥üË¥£ÂºÄÂêØÂÖ®Â±Ä‰∫ãÂä°/Êèê‰∫§‰∫ãÂä°1Èò∂ÊÆµÔºåËØ¥ÁôΩ‰∫Ü@GlobalTransactional Âè™ÂíåSeata-server ‰∫§‰∫íÔºåËÄå @Transactional ÁÆ°ÁêÜÁöÑÊòØÊú¨Âú∞Êï∞ÊçÆÂ∫ìÁöÑ‰∫ãÂä°ÔºåÊâÄ‰ª•‰∫åËÄÖ‰∏çÂèëÁîüÂÜ≤Á™Å„ÄÇ ‰ΩÜÊòØÈúÄË¶ÅÊ≥®ÊÑè @GlobalTransactional AOP Ë¶ÜÁõñËåÉÂõ¥‰∏ÄÂÆöË¶ÅÂ§ß‰∫é @Transactional ÈóÆÈ¢ò6. Â¶ÇÊûúÂÖ∂‰∏≠Êüê‰∏Ä‰∏™‰∫ãÂä°ÂàÜÊîØË∂ÖÊó∂Êú™Êèê‰∫§Ôºå‰ºöÂèëÁîü‰ªÄ‰πà Ëøô‰∏™ÊàëÂπ∂Ê≤°ÊúâÁúãÊ∫êÁ†ÅÔºåËÄåÊòØÈÄöËøáË∑ëdemoÔºåÈ™åËØÅÁöÑ ‰æãÂ¶ÇÁé∞Âú®ÊúâAÔºåB‰∏§‰∏™‰∫ãÂä°ÂàÜÊîØ A Ê≠£Â∏∏Êèê‰∫§ÔºåÂπ∂ÂêëSeataÊ≥®ÂÜåÂàÜÊîØÊàêÂäü B 2ÂàÜÈíüÂêéÊèê‰∫§‰∫ãÂä°ÔºåÂπ∂ÂêëSeataÂèëËµ∑Ê≥®ÂÜå SeataÁöÑÂÖ®Â±Ä‰∫ãÂä°Ë∂ÖÊó∂Êó∂Èó¥ÔºåÈªòËÆ§ÊòØ1ÂàÜÈíüÔºåSeata-server Âú®Ê£ÄÊµãÂà∞ÊúâË∂ÖÊó∂ÁöÑÂÖ®Â±Ä‰∫ãÂä°Êó∂Ôºå‰ºöÂêëÊâÄÊúâÂ∑≤Êèê‰∫§ÁöÑÂàÜÊîØÔºåÂèëËµ∑ÂõûÊªö„ÄÇËÄåË∂ÖÊó∂Êèê‰∫§ÁöÑ‰∫ãÂä°ÔºåÂêëSeata-serverÂèëËµ∑ÂàÜÊîØÊ≥®ÂÜåÊó∂ÔºåÂìçÂ∫îÁªìÊûú‰∏∫‰∫ãÂä°Â∑≤Ë∂ÖÊó∂ÔºåÊàñËÄÖ‰∫ãÂä°‰∏çÂ≠òÂú®Ôºå‰πü‰ºöÂõûÊªöÊú¨Âú∞‰∫ãÂä° ÈóÆÈ¢ò7. Seata-client Â¶Ç‰ΩïÊé•Êî∂Seata-serverÂèëËµ∑ÁöÑÈÄöÁü• Seata-client ÂåÖÂê´‰∫ÜNettyÊúçÂä°ÔºåÂú®ÂêØÂä®Êó∂Netty‰ºöÁõëÂê¨Á´ØÂè£ÔºåÂπ∂ÂêëSeata-server ÂèëËµ∑Ê≥®ÂÜå„ÄÇserver‰∏≠Â≠òÂÇ®‰∫Üclient ÁöÑË∞ÉÁî®Âú∞ÂùÄ„ÄÇ ÊÄªÁªìÊàë‰ª¨Â≠¶‰π†‰∫ÜSeataÁöÑATÊ®°ÂºèÊòØÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑÔºåÂèØ‰ª•ÁúãÂá∫SeataÊ®°ÂºèÂú®ÂºÄÂèë‰∏äÊòØÈùûÂ∏∏ÁÆÄÂçïÁöÑÔºå‰ΩÜÊòØSeataÁöÑËÉåÂêé‰∏∫‰∫ÜÁª¥ÊåÅÂàÜÂ∏ÉÂºè‰∫ãÂä°ÁöÑÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÔºåÂÅö‰∫ÜÂ§ßÈáèÁöÑÂ∑•‰ΩúÔºåATÊ®°ÂºèÈùûÂ∏∏ÈÄÇÂêàÁé∞ÊúâÁöÑ‰∏öÂä°Ê®°ÂûãÁõ¥Êé•ËøÅÁßª„ÄÇ ‰ΩÜÊòØ‰ªñÁöÑÁº∫ÁÇπ‰πüÂæàÊòéÊòæÔºåÊÄßËÉΩÂπ∂‰∏çÊòØÈÇ£‰πàÁöÑ‰ºòÁßÄ„ÄÇ‰æãÂ¶ÇÊàë‰ª¨ÂàöÂàöÁúãÂà∞ÁöÑÂÖ®Â±ÄÈîÅÁöÑÈóÆÈ¢òÔºå‰∏∫‰∫ÜÊï∞ÊçÆ‰∏ç‰ºöÂèëÁîüËÑèÂÜôÔºåSeataÁâ∫Áâ≤‰∫Ü‰∏öÂä°ÁöÑÂπ∂ÂèëËÉΩÂäõ„ÄÇÂú®ÈùûÂ∏∏Ë¶ÅÊ±ÇÊÄßËÉΩÁöÑÂú∫ÊôØÔºåÂèØËÉΩËøòÊòØÈúÄË¶ÅËÄÉËôëTCCÔºåSAGAÔºåÂèØÈù†Ê∂àÊÅØÁ≠âÊñπÊ°à Âú®‰ΩøÁî®SeataÂºÄÂèëÂâçÔºåÂª∫ËÆÆÂ§ßÂÆ∂ÂÖàÂéªÈòÖËØª‰∏Ä‰∏ãFAQÊñáÊ°£ÔºåÈÅøÂÖçË∏©Âùë https://seata.io/zh-cn/docs/overview/faq.html DEMOhttps://github.com/TavenYin/taven-springboot-learning/tree/master/springboot-seata ÂèÇËÄÉSeataÊòØ‰ªÄ‰πà - http://seata.io/zh-cn/docs/overview/what-is-seata.htmlSeataÂ∏∏ËßÅÈóÆÈ¢ò - http://seata.io/zh-cn/docs/overview/faq.htmlÂàÜÂ∏ÉÂºè‰∫ãÂä°‰∏≠Èó¥‰ª∂ Seata ÁöÑËÆæËÆ°ÂéüÁêÜ - http://seata.io/zh-cn/blog/seata-at-mode-design.htmlÂàÜÂ∏ÉÂºè‰∫ãÂä° Seata ÂèäÂÖ∂‰∏âÁßçÊ®°ÂºèËØ¶Ëß£ - http://seata.io/zh-cn/blog/seata-at-tcc-saga.htmlÂàÜÂ∏ÉÂºè‰∫ãÂä°Â¶Ç‰ΩïÂÆûÁé∞ÔºüÊ∑±ÂÖ•Ëß£ËØª Seata ÁöÑ XA Ê®°Âºè - http://seata.io/zh-cn/blog/seata-xa-introduce.html]]></content>
      <categories>
        <category>ÂàÜÂ∏ÉÂºè</category>
      </categories>
      <tags>
        <tag>Seata</tag>
        <tag>ÂàÜÂ∏ÉÂºè‰∫ãÂä°</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ÊµÖÂÖ•ÊµÖÂá∫ Spring ‰∫ãÂä°‰º†Êí≠ÂÆûÁé∞ÂéüÁêÜ]]></title>
    <url>%2Fpost%2Fbef5c7fd.html</url>
    <content type="text"><![CDATA[Êú¨ÊñáÂíåÂ§ßÂÆ∂‰∏ÄËµ∑Âà®Êûê Spring ‰∫ãÂä°ÁöÑÁõ∏ÂÖ≥Ê∫êÁ†ÅÔºåÁØáÂπÖËæÉÈïøÔºå‰ª£Á†ÅÁâáÊÆµËæÉÂ§öÔºåÂª∫ËÆÆ‰ΩøÁî®ÁîµËÑëÈòÖËØª Êú¨ÊñáÁõÆÊ†á ÁêÜËß£Spring‰∫ãÂä°ÁÆ°ÁêÜÊ†∏ÂøÉÊé•Âè£ ÁêÜËß£Spring‰∫ãÂä°ÁÆ°ÁêÜÁöÑÊ†∏ÂøÉÈÄªËæë ÁêÜËß£‰∫ãÂä°ÁöÑ‰º†Êí≠Á±ªÂûãÂèäÂÖ∂ÂÆûÁé∞ÂéüÁêÜ ÁâàÊú¨SpringBoot 2.3.3.RELEASE ‰ªÄ‰πàÊòØ‰∫ãÂä°ÁöÑ‰º†Êí≠ÔºüSpring Èô§‰∫ÜÂ∞ÅË£Ö‰∫Ü‰∫ãÂä°ÊéßÂà∂‰πãÂ§ñÔºåËøòÊäΩË±°Âá∫‰∫Ü ‰∫ãÂä°ÁöÑ‰º†Êí≠ Ëøô‰∏™Ê¶ÇÂøµÔºå‰∫ãÂä°ÁöÑ‰º†Êí≠Âπ∂‰∏çÊòØÂÖ≥Á≥ªÂûãÊï∞ÊçÆÂ∫ìÊâÄÂÆö‰πâÁöÑÔºåËÄåÊòØSpringÂú®Â∞ÅË£Ö‰∫ãÂä°Êó∂ÂÅöÁöÑÂ¢ûÂº∫Êâ©Â±ïÔºåÂèØ‰ª•ÈÄöËøá@Transactional ÊåáÂÆö‰∫ãÂä°ÁöÑ‰º†Êí≠ÔºåÂÖ∑‰ΩìÁ±ªÂûãÂ¶Ç‰∏ã ‰∫ãÂä°‰º†Êí≠Ë°å‰∏∫Á±ªÂûã ËØ¥Êòé PROPAGATION_REQUIRED Â¶ÇÊûúÂΩìÂâçÊ≤°Êúâ‰∫ãÂä°ÔºåÂ∞±Êñ∞Âª∫‰∏Ä‰∏™‰∫ãÂä°ÔºåÂ¶ÇÊûúÂ∑≤ÁªèÂ≠òÂú®‰∏Ä‰∏™‰∫ãÂä°‰∏≠ÔºåÂä†ÂÖ•Âà∞Ëøô‰∏™‰∫ãÂä°‰∏≠„ÄÇSpringÁöÑÈªòËÆ§‰∫ãÂä°‰º†Êí≠Á±ªÂûã PROPAGATION_SUPPORTS ÊîØÊåÅÂΩìÂâç‰∫ãÂä°ÔºåÂ¶ÇÊûúÂΩìÂâçÊ≤°Êúâ‰∫ãÂä°ÔºåÂ∞±‰ª•Èùû‰∫ãÂä°ÊñπÂºèÊâßË°å„ÄÇ PROPAGATION_MANDATORY ‰ΩøÁî®ÂΩìÂâçÁöÑ‰∫ãÂä°ÔºåÂ¶ÇÊûúÂΩìÂâçÊ≤°Êúâ‰∫ãÂä°ÔºåÂ∞±ÊäõÂá∫ÂºÇÂ∏∏„ÄÇ PROPAGATION_REQUIRES_NEW Êñ∞Âª∫‰∫ãÂä°ÔºåÂ¶ÇÊûúÂΩìÂâçÂ≠òÂú®‰∫ãÂä°ÔºåÊääÂΩìÂâç‰∫ãÂä°ÊåÇËµ∑ÔºàÊöÇÂÅúÔºâ„ÄÇ PROPAGATION_NOT_SUPPORTED ‰ª•Èùû‰∫ãÂä°ÊñπÂºèÊâßË°åÊìç‰ΩúÔºåÂ¶ÇÊûúÂΩìÂâçÂ≠òÂú®‰∫ãÂä°ÔºåÂ∞±ÊääÂΩìÂâç‰∫ãÂä°ÊåÇËµ∑„ÄÇ PROPAGATION_NEVER ‰ª•Èùû‰∫ãÂä°ÊñπÂºèÊâßË°åÔºåÂ¶ÇÊûúÂΩìÂâçÂ≠òÂú®‰∫ãÂä°ÔºåÂàôÊäõÂá∫ÂºÇÂ∏∏„ÄÇ PROPAGATION_NESTED Â¶ÇÊûúÂΩìÂâçÂ≠òÂú®‰∫ãÂä°ÔºåÂàôÂú®ÂµåÂ•ó‰∫ãÂä°ÂÜÖÊâßË°å„ÄÇÂ¶ÇÊûúÂΩìÂâçÊ≤°Êúâ‰∫ãÂä°ÔºåÂàôÊâßË°å‰∏éPROPAGATION_REQUIREDÁ±ª‰ººÁöÑÊìç‰Ωú„ÄÇ ‰∏æ‰∏™Ê†óÂ≠ê‰ª•ÂµåÂ•ó‰∫ãÂä°‰∏∫‰æã123456789101112131415161718192021222324252627282930313233343536@Servicepublic class DemoServiceImpl implements DemoService &#123; @Autowired private JdbcTemplate jdbcTemplate; @Autowired private DemoServiceImpl self; @Transactional @Override public void insertDB() &#123; String sql = "INSERT INTO sys_user(`id`, `username`) VALUES (?, ?)"; jdbcTemplate.update(sql, uuid(), "taven"); try &#123; // ÂÜÖÂµå‰∫ãÂä°Â∞Ü‰ºöÂõûÊªöÔºåËÄåÂ§ñÈÉ®‰∫ãÂä°‰∏ç‰ºöÂèóÂà∞ÂΩ±Âìç self.nested(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; @Transactional(propagation = Propagation.NESTED) @Override public void nested() &#123; String sql = "INSERT INTO sys_user(`id`, `username`) VALUES (?, ?)"; jdbcTemplate.update(sql, uuid(), "nested"); throw new RuntimeException("rollback nested"); &#125; private String uuid() &#123; return UUID.randomUUID().toString(); &#125;&#125; ‰∏äËø∞‰ª£Á†Å‰∏≠Ôºånested()ÊñπÊ≥ïÊ†áËÆ∞‰∫Ü‰∫ãÂä°‰º†Êí≠Á±ªÂûã‰∏∫ÂµåÂ•óÔºåÂ¶ÇÊûúnested()‰∏≠ÊäõÂá∫ÂºÇÂ∏∏‰ªÖ‰ºöÂõûÊªönested()ÊñπÊ≥ï‰∏≠ÁöÑsqlÔºå‰∏ç‰ºöÂΩ±ÂìçÂà∞insertDB()ÊñπÊ≥ï‰∏≠Â∑≤ÁªèÊâßË°åÁöÑsql Ê≥®ÊÑèÔºöservice Ë∞ÉÁî®ÂÜÖÈÉ®ÊñπÊ≥ïÊó∂ÔºåÂ¶ÇÊûúÁõ¥Êé•‰ΩøÁî®thisË∞ÉÁî®Ôºå‰∫ãÂä°‰∏ç‰ºöÁîüÊïà„ÄÇÂõ†Ê≠§‰ΩøÁî®thisË∞ÉÁî®Áõ∏ÂΩì‰∫éË∑≥Ëøá‰∫ÜÂ§ñÈÉ®ÁöÑ‰ª£ÁêÜÁ±ªÔºåÊâÄ‰ª•AOP‰∏ç‰ºöÁîüÊïàÔºåÊó†Ê≥ï‰ΩøÁî®‰∫ãÂä° ÊÄùËÄÉ‰ºóÊâÄÂë®Áü•ÔºåSpring ‰∫ãÂä°ÊòØÈÄöËøáAOPÂÆûÁé∞ÁöÑÔºåÂ¶ÇÊûúÊòØÊàë‰ª¨Ëá™Â∑±ÂÜô‰∏Ä‰∏™AOPÊéßÂà∂‰∫ãÂä°ÔºåËØ•ÊÄé‰πàÂÅöÂë¢Ôºü1234567891011121314151617// ‰º™‰ª£Á†Åpublic Object invokeWithinTransaction() &#123; // ÂºÄÂêØ‰∫ãÂä° connection.beginTransaction(); try &#123; // ÂèçÂ∞ÑÊâßË°åÊñπÊ≥ï Object result = invoke(); // Êèê‰∫§‰∫ãÂä° connection.commit(); return result; &#125; catch(Exception e) &#123; // ÂèëÁîüÂºÇÂ∏∏Êó∂ÂõûÊªö connection.rollback(); throw e; &#125; &#125; Âú®Ëøô‰∏™Âü∫Á°Ä‰∏äÔºåÊàë‰ª¨Êù•ÊÄùËÄÉ‰∏Ä‰∏ãÂ¶ÇÊûúÊòØÊàë‰ª¨Ëá™Â∑±ÂÅöÁöÑËØùÔºå‰∫ãÂä°ÁöÑ‰º†Êí≠ËØ•Â¶Ç‰ΩïÂÆûÁé∞ ‰ª•PROPAGATION_REQUIRED‰∏∫‰æãÔºåËøô‰∏™‰ºº‰πéÂæàÁÆÄÂçïÔºåÊàë‰ª¨Âà§Êñ≠‰∏Ä‰∏ãÂΩìÂâçÊòØÂê¶Êúâ‰∫ãÂä°ÔºàÂèØ‰ª•ËÄÉËôë‰ΩøÁî®ThreadLocalÂ≠òÂÇ®Â∑≤Â≠òÂú®ÁöÑ‰∫ãÂä°ÂØπË±°ÔºâÔºåÂ¶ÇÊûúÊúâ‰∫ãÂä°ÔºåÈÇ£‰πàÂ∞±‰∏çÂºÄÂêØÊñ∞ÁöÑ‰∫ãÂä°„ÄÇÂèç‰πãÔºåÊ≤°Êúâ‰∫ãÂä°ÔºåÊàë‰ª¨Â∞±ÂàõÂª∫Êñ∞ÁöÑ‰∫ãÂä° Â¶ÇÊûú‰∫ãÂä°ÊòØÁî±ÂΩìÂâçÂàáÈù¢ÂºÄÂêØÁöÑÔºåÂàôÊèê‰∫§/ÂõûÊªö‰∫ãÂä°ÔºåÂèç‰πã‰∏çÂÅöÂ§ÑÁêÜ ÈÇ£‰πà‰∫ãÂä°‰º†Êí≠‰∏≠ÊèèËø∞ÁöÑÊåÇËµ∑ÔºàÊöÇÂÅúÔºâÂΩìÂâç‰∫ãÂä°ÔºåÂíåÂÜÖÂµå‰∫ãÂä°ÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑÔºü Ê∫êÁ†ÅÂÖ•ÊâãË¶ÅÈòÖËØª‰∫ãÂä°‰º†Êí≠Áõ∏ÂÖ≥ÁöÑÊ∫êÁ†ÅÔºåÊàë‰ª¨ÂÖàÊù•‰∫ÜËß£‰∏ãSpring ‰∫ãÂä°ÁÆ°ÁêÜÁöÑÊ†∏ÂøÉÊé•Âè£‰∏éÁ±ª TransactionDefinitionËØ•Êé•Âè£ÂÆö‰πâ‰∫Ü‰∫ãÂä°ÁöÑÊâÄÊúâÂ±ûÊÄßÔºàÈöîÁ¶ªÁ∫ßÂà´Ôºå‰º†Êí≠Á±ªÂûãÔºåË∂ÖÊó∂Êó∂Èó¥Á≠âÁ≠âÔºâÔºåÊàë‰ª¨Êó•Â∏∏ÂºÄÂèë‰∏≠ÁªèÂ∏∏‰ΩøÁî®ÁöÑ @Transactional ÂÖ∂ÂÆûÊúÄÁªà‰ºöË¢´ËΩ¨Âåñ‰∏∫ TransactionDefinition TransactionStatus‰∫ãÂä°ÁöÑÁä∂ÊÄÅÔºå‰ª•ÊúÄÂ∏∏Áî®ÁöÑÂÆûÁé∞ DefaultTransactionStatus ‰∏∫‰æãÔºåËØ•Á±ªÂ≠òÂÇ®‰∫ÜÂΩìÂâçÁöÑ‰∫ãÂä°ÂØπË±°ÔºåsavepointÔºåÂΩìÂâçÊåÇËµ∑ÁöÑ‰∫ãÂä°ÔºåÊòØÂê¶ÂÆåÊàêÔºåÊòØÂê¶‰ªÖÂõûÊªöÁ≠âÁ≠â TransactionManagerËøôÊòØ‰∏Ä‰∏™Á©∫Êé•Âè£ÔºåÁõ¥Êé•ÁªßÊâø‰ªñÁöÑ interface Êúâ PlatformTransactionManagerÔºàÊàë‰ª¨Âπ≥Êó∂Áî®ÁöÑÂ∞±ÊòØËøô‰∏™ÔºåÈªòËÆ§ÁöÑÂÆûÁé∞Á±ªDataSourceTransactionManagerÔºâ‰ª•ÂèäReactiveTransactionManagerÔºàÂìçÂ∫îÂºè‰∫ãÂä°ÁÆ°ÁêÜÂô®ÔºåÁî±‰∫é‰∏çÊòØÊú¨ÊñáÈáçÁÇπÔºåÊàë‰ª¨‰∏çÂ§öËØ¥Ôºâ ‰ªé‰∏äËø∞‰∏§‰∏™Êé•Âè£Êù•ÁúãÔºåTransactionManager ÁöÑ‰∏ªË¶Å‰ΩúÁî® ÈÄöËøáTransactionDefinitionÂºÄÂêØ‰∏Ä‰∏™‰∫ãÂä°ÔºåËøîÂõûTransactionStatus ÈÄöËøáTransactionStatus Êèê‰∫§„ÄÅÂõûÊªö‰∫ãÂä°ÔºàÂÆûÈôÖÂºÄÂêØ‰∫ãÂä°ÁöÑConnectionÈÄöÂ∏∏Â≠òÂÇ®Âú®TransactionStatus‰∏≠Ôºâ 123456789101112public interface PlatformTransactionManager extends TransactionManager &#123; TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException; void commit(TransactionStatus status) throws TransactionException; void rollback(TransactionStatus status) throws TransactionException;&#125; TransactionInterceptor‰∫ãÂä°Êã¶Êà™Âô®Ôºå‰∫ãÂä°AOPÁöÑÊ†∏ÂøÉÁ±ªÔºàÊîØÊåÅÂìçÂ∫îÂºè‰∫ãÂä°ÔºåÁºñÁ®ãÂºè‰∫ãÂä°Ôºå‰ª•ÂèäÊàë‰ª¨Â∏∏Áî®ÁöÑÊ†áÂáÜ‰∫ãÂä°ÔºâÔºåÁî±‰∫éÁØáÂπÖÂéüÂõ†ÔºåÊú¨ÊñáÂè™ËÆ®ËÆ∫Ê†áÂáÜ‰∫ãÂä°ÁöÑÁõ∏ÂÖ≥ÂÆûÁé∞ ‰∏ãÈù¢Êàë‰ª¨‰ªé‰∫ãÂä°ÈÄªËæëÁöÑÂÖ•Âè£ TransactionInterceptor ÂÖ•ÊâãÔºåÊù•Áúã‰∏ãSpring‰∫ãÂä°ÁÆ°ÁêÜÁöÑÊ†∏ÂøÉÈÄªËæë‰ª•Âèä‰∫ãÂä°‰º†Êí≠ÁöÑÂÆûÁé∞ TransactionInterceptorTransactionInterceptor ÂÆûÁé∞‰∫ÜMethodInvocationÔºàËøôÊòØÂÆûÁé∞AOPÁöÑ‰∏ÄÁßçÊñπÂºèÔºâÔºåÂÖ∂Ê†∏ÂøÉÈÄªËæëÂú®Áà∂Á±ªTransactionAspectSupport ‰∏≠ÔºåÊñπÊ≥ï‰ΩçÁΩÆÔºöTransactionInterceptor::invokeWithinTransaction 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950protected Object invokeWithinTransaction(Method method, @Nullable Class&lt;?&gt; targetClass, final InvocationCallback invocation) throws Throwable &#123; // If the transaction attribute is null, the method is non-transactional. TransactionAttributeSource tas = getTransactionAttributeSource(); // ÂΩìÂâç‰∫ãÂä°ÁöÑÂ±ûÊÄß TransactionAttribute extends TransactionDefinition final TransactionAttribute txAttr = (tas != null ? tas.getTransactionAttribute(method, targetClass) : null); // ‰∫ãÂä°Â±ûÊÄß‰∏≠ÂèØ‰ª•ÂÆö‰πâÂΩìÂâç‰ΩøÁî®Âì™‰∏™‰∫ãÂä°ÁÆ°ÁêÜÂô® // Â¶ÇÊûúÊ≤°ÊúâÂÆö‰πâÂ∞±ÂéªSpring‰∏ä‰∏ãÊñáÊâæÂà∞‰∏Ä‰∏™ÂèØÁî®ÁöÑ TransactionManager final TransactionManager tm = determineTransactionManager(txAttr); // ÁúÅÁï•‰∫ÜÂìçÂ∫îÂºè‰∫ãÂä°ÁöÑÂ§ÑÁêÜ ... PlatformTransactionManager ptm = asPlatformTransactionManager(tm); final String joinpointIdentification = methodIdentification(method, targetClass, txAttr); if (txAttr == null || !(ptm instanceof CallbackPreferringPlatformTransactionManager)) &#123; // Standard transaction demarcation with getTransaction and commit/rollback calls. TransactionInfo txInfo = createTransactionIfNecessary(ptm, txAttr, joinpointIdentification); Object retVal; try &#123; // This is an around advice: Invoke the next interceptor in the chain. // This will normally result in a target object being invoked. // Â¶ÇÊûúÊúâ‰∏ã‰∏Ä‰∏™Êã¶Êà™Âô®ÂàôÊâßË°åÔºåÊúÄÁªà‰ºöÊâßË°åÂà∞ÁõÆÊ†áÊñπÊ≥ïÔºå‰πüÂ∞±ÊòØÊàë‰ª¨ÁöÑ‰∏öÂä°‰ª£Á†Å retVal = invocation.proceedWithInvocation(); &#125; catch (Throwable ex) &#123; // target invocation exception // ÂΩìÊçïËé∑Âà∞ÂºÇÂ∏∏Êó∂ÂÆåÊàêÂΩìÂâç‰∫ãÂä° ÔºàÊèê‰∫§ÊàñËÄÖÂõûÊªöÔºâ completeTransactionAfterThrowing(txInfo, ex); throw ex; &#125; finally &#123; cleanupTransactionInfo(txInfo); &#125; if (retVal != null &amp;&amp; vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) &#123; // Set rollback-only in case of Vavr failure matching our rollback rules... TransactionStatus status = txInfo.getTransactionStatus(); if (status != null &amp;&amp; txAttr != null) &#123; retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status); &#125; &#125; // Ê†πÊçÆ‰∫ãÂä°ÁöÑÁä∂ÊÄÅÊèê‰∫§ÊàñËÄÖÂõûÊªö commitTransactionAfterReturning(txInfo); return retVal; &#125; // ÁúÅÁï•‰∫ÜÁºñÁ®ãÂºè‰∫ãÂä°ÁöÑÂ§ÑÁêÜ ...&#125; ËøôÈáå‰ª£Á†ÅÂæàÂ§öÔºåÊ†πÊçÆÊ≥®ÈáäÁöÑ‰ΩçÁΩÆÔºåÊàë‰ª¨ÂèØ‰ª•ÊääÊ†∏ÂøÉÈÄªËæëÊ¢≥ÁêÜÂá∫Êù• Ëé∑ÂèñÂΩìÂâç‰∫ãÂä°Â±ûÊÄßÔºå‰∫ãÂä°ÁÆ°ÁêÜÂô®Ôºà‰ª•Ê≥®Ëß£‰∫ãÂä°‰∏∫‰æãÔºåËøô‰∫õÈÉΩÂèØ‰ª•ÈÄöËøá@TransactionalÊù•ÂÆö‰πâÔºâ createTransactionIfNecessaryÔºåÂà§Êñ≠ÊòØÂê¶ÊúâÂøÖË¶ÅÂàõÂª∫‰∫ãÂä° invocation.proceedWithInvocation ÊâßË°åÊã¶Êà™Âô®ÈìæÔºåÊúÄÁªà‰ºöÊâßË°åÂà∞ÁõÆÊ†áÊñπÊ≥ï completeTransactionAfterThrowingÂΩìÊäõÂá∫ÂºÇÂ∏∏ÂêéÔºåÂÆåÊàêËøô‰∏™‰∫ãÂä°ÔºåÊèê‰∫§ÊàñËÄÖÂõûÊªöÔºåÂπ∂ÊäõÂá∫Ëøô‰∏™ÂºÇÂ∏∏ commitTransactionAfterReturning ‰ªéÊñπÊ≥ïÂëΩÂêçÊù•ÁúãÔºåËøô‰∏™ÊñπÊ≥ï‰ºöÊèê‰∫§‰∫ãÂä°„ÄÇ‰ΩÜÊòØÊ∑±ÂÖ•Ê∫êÁ†Å‰∏≠‰ºöÂèëÁé∞ÔºåËØ•ÊñπÊ≥ï‰∏≠‰πüÂåÖÂê´ÂõûÊªöÈÄªËæëÔºåÂÖ∑‰ΩìË°å‰∏∫‰ºöÊ†πÊçÆÂΩìÂâçTransactionStatusÁöÑ‰∏Ä‰∫õÁä∂ÊÄÅÊù•ÂÜ≥ÂÆöÔºà‰πüÂ∞±ÊòØËØ¥ÔºåÊàë‰ª¨‰πüÂèØ‰ª•ÈÄöËøáËÆæÁΩÆÂΩìÂâçTransactionStatusÔºåÊù•ÊéßÂà∂‰∫ãÂä°ÂõûÊªöÔºåÂπ∂‰∏ç‰∏ÄÂÆöÂè™ËÉΩÈÄöËøáÊäõÂá∫ÂºÇÂ∏∏ÔºâÔºåËØ¶ËßÅAbstractPlatformTransactionManager::commit Êàë‰ª¨ÁªßÁª≠ÔºåÊù•ÁúãÁúãcreateTransactionIfNecessaryÂÅö‰∫Ü‰ªÄ‰πà TransactionAspectSupport::createTransactionIfNecessary1234567891011121314151617181920212223242526272829protected TransactionInfo createTransactionIfNecessary(@Nullable PlatformTransactionManager tm, @Nullable TransactionAttribute txAttr, final String joinpointIdentification) &#123; // If no name specified, apply method identification as transaction name. if (txAttr != null &amp;&amp; txAttr.getName() == null) &#123; txAttr = new DelegatingTransactionAttribute(txAttr) &#123; @Override public String getName() &#123; return joinpointIdentification; &#125; &#125;; &#125; TransactionStatus status = null; if (txAttr != null) &#123; if (tm != null) &#123; // ÈÄöËøá‰∫ãÂä°ÁÆ°ÁêÜÂô®ÂºÄÂêØ‰∫ãÂä° status = tm.getTransaction(txAttr); &#125; else &#123; if (logger.isDebugEnabled()) &#123; logger.debug("Skipping transactional joinpoint [" + joinpointIdentification + "] because no transaction manager has been configured"); &#125; &#125; &#125; return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);&#125; createTransactionIfNecessary‰∏≠ÁöÑÊ†∏ÂøÉÈÄªËæë ÈÄöËøáPlatformTransactionManagerÔºà‰∫ãÂä°ÁÆ°ÁêÜÂô®ÔºâÂºÄÂêØ‰∫ãÂä° prepareTransactionInfo ÂáÜÂ§á‰∫ãÂä°‰ø°ÊÅØÔºåËøô‰∏™ÂÖ∑‰ΩìÂÅö‰∫Ü‰ªÄ‰πàÊàë‰ª¨Á®çÂêéÂÜçËÆ≤ ÁªßÁª≠Êù•ÁúãPlatformTransactionManager::getTransactionÔºåËØ•ÊñπÊ≥ïÂè™Êúâ‰∏Ä‰∏™ÂÆûÁé∞ AbstractPlatformTransactionManager::getTransaction 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException &#123; // Use defaults if no transaction definition given. TransactionDefinition def = (definition != null ? definition : TransactionDefinition.withDefaults()); // Ëé∑ÂèñÂΩìÂâç‰∫ãÂä°ÔºåËØ•ÊñπÊ≥ïÊúâÁªßÊâø AbstractPlatformTransactionManager ÁöÑÂ≠êÁ±ªËá™Ë°åÂÆûÁé∞ Object transaction = doGetTransaction(); boolean debugEnabled = logger.isDebugEnabled(); // Â¶ÇÊûúÁõÆÂâçÂ≠òÂú®‰∫ãÂä° if (isExistingTransaction(transaction)) &#123; // Existing transaction found -&gt; check propagation behavior to find out how to behave. return handleExistingTransaction(def, transaction, debugEnabled); &#125; // Check definition settings for new transaction. if (def.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123; throw new InvalidTimeoutException("Invalid transaction timeout", def.getTimeout()); &#125; // ‰º†Êí≠Á±ªÂûãPROPAGATION_MANDATORY, Ë¶ÅÊ±ÇÂΩìÂâçÂøÖÈ°ªÊúâ‰∫ãÂä° // No existing transaction found -&gt; check propagation behavior to find out how to proceed. if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123; throw new IllegalTransactionStateException( "No existing transaction found for transaction marked with propagation 'mandatory'"); &#125; // PROPAGATION_REQUIRED, PROPAGATION_REQUIRES_NEW, PROPAGATION_NESTED ‰∏çÂ≠òÂú®‰∫ãÂä°Êó∂ÂàõÂª∫‰∫ãÂä° else if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED || def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW || def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123; SuspendedResourcesHolder suspendedResources = suspend(null); if (debugEnabled) &#123; logger.debug("Creating new transaction with name [" + def.getName() + "]: " + def); &#125; try &#123; // ÂºÄÂêØ‰∫ãÂä° return startTransaction(def, transaction, debugEnabled, suspendedResources); &#125; catch (RuntimeException | Error ex) &#123; resume(null, suspendedResources); throw ex; &#125; &#125; else &#123; // Create "empty" transaction: no actual transaction, but potentially synchronization. if (def.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123; logger.warn("Custom isolation level specified but no actual transaction initiated; " + "isolation level will effectively be ignored: " + def); &#125; boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); return prepareTransactionStatus(def, null, true, newSynchronization, debugEnabled, null); &#125;&#125; ‰ª£Á†ÅÂæàÂ§öÔºåÈáçÁÇπÂÖ≥Ê≥®Ê≥®ÈáäÈÉ®ÂàÜÂç≥ÂèØ doGetTransactionËé∑ÂèñÂΩìÂâç‰∫ãÂä° Â¶ÇÊûúÂ≠òÂú®‰∫ãÂä°ÔºåÂàôË∞ÉÁî®handleExistingTransactionÂ§ÑÁêÜÔºåËøô‰∏™Êàë‰ª¨Á®çÂêé‰ºöËÆ≤Âà∞ Êé•‰∏ãÊù•Ôºå‰ºöÊ†πÊçÆ‰∫ãÂä°ÁöÑ‰º†Êí≠ÂÜ≥ÂÆöÊòØÂê¶ÂºÄÂêØ‰∫ãÂä° Â¶ÇÊûú‰∫ãÂä°‰º†Êí≠Á±ªÂûã‰∏∫PROPAGATION_MANDATORYÔºå‰∏î‰∏çÂ≠òÂú®‰∫ãÂä°ÔºåÂàôÊäõÂá∫ÂºÇÂ∏∏ Â¶ÇÊûú‰º†Êí≠Á±ªÂûã‰∏∫ PROPAGATION_REQUIRED, PROPAGATION_REQUIRES_NEW, PROPAGATION_NESTEDÔºå‰∏îÂΩìÂâç‰∏çÂ≠òÂú®‰∫ãÂä°ÔºåÂàôË∞ÉÁî®startTransactionÂàõÂª∫‰∫ãÂä° ÂΩì‰∏çÊª°Ë∂≥ 3„ÄÅ4Êó∂Ôºå‰æãÂ¶Ç PROPAGATION_NOT_SUPPORTEDÔºåÊ≠§Êó∂‰ºöÊâßË°å‰∫ãÂä°ÂêåÊ≠•Ôºå‰ΩÜÊòØ‰∏ç‰ºöÂàõÂª∫ÁúüÊ≠£ÁöÑ‰∫ãÂä° Spring ‰∫ãÂä°ÂêåÊ≠•Âú®‰πãÂâç‰∏ÄÁØáÂçöÂÆ¢‰∏≠ÊúâËÆ≤Âà∞Ôºå‰º†ÈÄÅÈó®üëâhttps://www.jianshu.com/p/7880d9a98a5f Spring Â¶Ç‰ΩïÁÆ°ÁêÜÂΩìÂâçÁöÑ‰∫ãÂä°Êé•‰∏ãÊù•ËÆ≤ËÆ≤‰∏äÈù¢ÊèêÂà∞ÁöÑdoGetTransaction„ÄÅhandleExistingTransactionÔºåËøô‰∏§‰∏™ÊñπÊ≥ïÊòØÁî±‰∏çÂêåÁöÑTransactionManagerËá™Ë°åÂÆûÁé∞ÁöÑ Êàë‰ª¨‰ª•SpringBootÈªòËÆ§ÁöÑTransactionManagerÔºåDataSourceTransactionManager‰∏∫‰æã123456789101112131415@Overrideprotected Object doGetTransaction() &#123; DataSourceTransactionObject txObject = new DataSourceTransactionObject(); txObject.setSavepointAllowed(isNestedTransactionAllowed()); ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(obtainDataSource()); txObject.setConnectionHolder(conHolder, false); return txObject;&#125;@Overrideprotected boolean isExistingTransaction(Object transaction) &#123; DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction; return (txObject.hasConnectionHolder() &amp;&amp; txObject.getConnectionHolder().isTransactionActive());&#125; ÁªìÂêà AbstractPlatformTransactionManager::getTransaction ‰∏ÄËµ∑Êù•ÁúãÔºådoGetTransaction ÂÖ∂ÂÆûËé∑ÂèñÁöÑÊòØÂΩìÂâçÁöÑConnection„ÄÇÂà§Êñ≠ÂΩìÂâçÊòØÂê¶Â≠òÂú®‰∫ãÂä°ÔºåÊòØÂà§Êñ≠DataSourceTransactionObject ÂØπË±°‰∏≠ÊòØÂê¶ÂåÖÂê´connectionÔºå‰ª•ÂèäconnectionÊòØÂê¶ÂºÄÂêØ‰∫Ü‰∫ãÂä°„ÄÇ Êàë‰ª¨ÁªßÁª≠Êù•Áúã‰∏ãTransactionSynchronizationManager.getResource(obtainDataSource())Ëé∑ÂèñÂΩìÂâçconnectionÁöÑÈÄªËæë TransactionSynchronizationManager::getResource12345678910111213141516171819202122232425262728293031323334353637383940private static final ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources = new NamedThreadLocal&lt;&gt;("Transactional resources");@Nullable// TransactionSynchronizationManager::getResourcepublic static Object getResource(Object key) &#123; // DataSourceTransactionManager Ë∞ÉÁî®ËØ•ÊñπÊ≥ïÊó∂Ôºå‰ª•Êï∞ÊçÆÊ∫ê‰Ωú‰∏∫key // TransactionSynchronizationUtils::unwrapResourceIfNecessary Â¶ÇÊûúkey‰∏∫ÂåÖË£ÖÁ±ªÔºåÂàôËé∑ÂèñË¢´ÂåÖË£ÖÁöÑÂØπË±° // Êàë‰ª¨ÂèØ‰ª•ÂøΩÁï•ËØ•ÈÄªËæë Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key); Object value = doGetResource(actualKey); if (value != null &amp;&amp; logger.isTraceEnabled()) &#123; logger.trace("Retrieved value [" + value + "] for key [" + actualKey + "] bound to thread [" + Thread.currentThread().getName() + "]"); &#125; return value;&#125;/** * Actually check the value of the resource that is bound for the given key. */@Nullableprivate static Object doGetResource(Object actualKey) &#123; Map&lt;Object, Object&gt; map = resources.get(); if (map == null) &#123; return null; &#125; Object value = map.get(actualKey); // Transparently remove ResourceHolder that was marked as void... if (value instanceof ResourceHolder &amp;&amp; ((ResourceHolder) value).isVoid()) &#123; map.remove(actualKey); // Remove entire ThreadLocal if empty... if (map.isEmpty()) &#123; resources.remove(); &#125; value = null; &#125; return value;&#125; ÁúãÂà∞ËøôÈáåÔºåÊàë‰ª¨ËÉΩÊòéÁôΩDataSourceTransactionManagerÊòØÂ¶Ç‰ΩïÁÆ°ÁêÜÁ∫øÁ®ã‰πãÈó¥ÁöÑConnectionÔºåThreadLocal ‰∏≠Â≠òÂÇ®‰∏Ä‰∏™MapÔºåkey‰∏∫Êï∞ÊçÆÊ∫êÂØπË±°Ôºåvalue‰∏∫ËØ•Êï∞ÊçÆÊ∫êÂú®ÂΩìÂâçÁ∫øÁ®ãÁöÑConnection DataSourceTransactionManager Âú®ÂºÄÂêØ‰∫ãÂä°ÂêéÔºå‰ºöË∞ÉÁî®TransactionSynchronizationManager::bindResourceÂ∞ÜÊåáÂÆöÊï∞ÊçÆÊ∫êÁöÑConnectionÁªëÂÆöÂà∞ÂΩìÂâçÁ∫øÁ®ã AbstractPlatformTransactionManager::handleExistingTransactionÊàë‰ª¨ÁªßÁª≠ÂõûÂ§¥ÁúãÔºåÂ¶ÇÊûúÂ≠òÂú®‰∫ãÂä°ÁöÑÊÉÖÂÜµÔºåÂ¶Ç‰ΩïÂ§ÑÁêÜ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899private TransactionStatus handleExistingTransaction( TransactionDefinition definition, Object transaction, boolean debugEnabled) throws TransactionException &#123; // Â¶ÇÊûú‰∫ãÂä°ÁöÑ‰º†Êí≠Ë¶ÅÊ±Ç‰ª•Èùû‰∫ãÂä°ÊñπÂºèÊâßË°å ÊäõÂá∫ÂºÇÂ∏∏ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) &#123; throw new IllegalTransactionStateException( "Existing transaction found for transaction marked with propagation 'never'"); &#125; // PROPAGATION_NOT_SUPPORTED Â¶ÇÊûúÂ≠òÂú®‰∫ãÂä°ÔºåÂàôÊåÇËµ∑ÂΩìÂâç‰∫ãÂä°Ôºå‰ª•Èùû‰∫ãÂä°ÊñπÂºèÊâßË°å if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) &#123; if (debugEnabled) &#123; logger.debug("Suspending current transaction"); &#125; // ÊåÇËµ∑ÂΩìÂâç‰∫ãÂä° Object suspendedResources = suspend(transaction); boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); // ÊûÑÂª∫‰∏Ä‰∏™Êó†‰∫ãÂä°ÁöÑTransactionStatus return prepareTransactionStatus( definition, null, false, newSynchronization, debugEnabled, suspendedResources); &#125; // PROPAGATION_REQUIRES_NEW Â¶ÇÊûúÂ≠òÂú®‰∫ãÂä°ÔºåÂàôÊåÇËµ∑ÂΩìÂâç‰∫ãÂä°ÔºåÊñ∞Âª∫‰∏Ä‰∏™‰∫ãÂä° if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) &#123; if (debugEnabled) &#123; logger.debug("Suspending current transaction, creating new transaction with name [" + definition.getName() + "]"); &#125; SuspendedResourcesHolder suspendedResources = suspend(transaction); try &#123; return startTransaction(definition, transaction, debugEnabled, suspendedResources); &#125; catch (RuntimeException | Error beginEx) &#123; resumeAfterBeginException(transaction, suspendedResources, beginEx); throw beginEx; &#125; &#125; // PROPAGATION_NESTED ÂÜÖÂµå‰∫ãÂä°ÔºåÂ∞±ÊòØÊàë‰ª¨ÂºÄÂ§¥‰∏æÂæó‰æãÂ≠ê if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123; if (!isNestedTransactionAllowed()) &#123; throw new NestedTransactionNotSupportedException( "Transaction manager does not allow nested transactions by default - " + "specify 'nestedTransactionAllowed' property with value 'true'"); &#125; if (debugEnabled) &#123; logger.debug("Creating nested transaction with name [" + definition.getName() + "]"); &#125; // ÈùûJTA‰∫ãÂä°ÁÆ°ÁêÜÂô®ÈÉΩÊòØÈÄöËøásavePointÂÆûÁé∞ÁöÑÂÜÖÂµå‰∫ãÂä° // savePointÔºöÂÖ≥Á≥ªÂûãÊï∞ÊçÆÂ∫ì‰∏≠‰∫ãÂä°ÂèØ‰ª•ÂàõÂª∫ËøòÂéüÁÇπÔºåÂπ∂‰∏îÂèØ‰ª•ÂõûÊªöÂà∞ËøòÂéüÁÇπ if (useSavepointForNestedTransaction()) &#123; // Create savepoint within existing Spring-managed transaction, // through the SavepointManager API implemented by TransactionStatus. // Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization. DefaultTransactionStatus status = prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null); // ÂàõÂª∫ËøòÂéüÁÇπ status.createAndHoldSavepoint(); return status; &#125; else &#123; // Nested transaction through nested begin and commit/rollback calls. // Usually only for JTA: Spring synchronization might get activated here // in case of a pre-existing JTA transaction. return startTransaction(definition, transaction, debugEnabled, null); &#125; &#125; // Â¶ÇÊûúÊâßË°åÂà∞Ëøô‰∏ÄÊ≠•‰º†Êí≠Á±ªÂûã‰∏ÄÂÆöÊòØÔºåPROPAGATION_SUPPORTS ÊàñËÄÖ PROPAGATION_REQUIRED // Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED. if (debugEnabled) &#123; logger.debug("Participating in existing transaction"); &#125; // Ê†°È™åÁõÆÂâçÊñπÊ≥ï‰∏≠ÁöÑ‰∫ãÂä°ÂÆö‰πâÂíåÂ∑≤Â≠òÂú®ÁöÑ‰∫ãÂä°ÂÆö‰πâÊòØÂê¶‰∏ÄËá¥ if (isValidateExistingTransaction()) &#123; if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT) &#123; Integer currentIsolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel(); if (currentIsolationLevel == null || currentIsolationLevel != definition.getIsolationLevel()) &#123; Constants isoConstants = DefaultTransactionDefinition.constants; throw new IllegalTransactionStateException("Participating transaction with definition [" + definition + "] specifies isolation level which is incompatible with existing transaction: " + (currentIsolationLevel != null ? isoConstants.toCode(currentIsolationLevel, DefaultTransactionDefinition.PREFIX_ISOLATION) : "(unknown)")); &#125; &#125; if (!definition.isReadOnly()) &#123; if (TransactionSynchronizationManager.isCurrentTransactionReadOnly()) &#123; throw new IllegalTransactionStateException("Participating transaction with definition [" + definition + "] is not marked as read-only but existing transaction is"); &#125; &#125; &#125; boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER); // ÊûÑÂª∫‰∏Ä‰∏™TransactionStatusÔºå‰ΩÜ‰∏çÂºÄÂêØ‰∫ãÂä° return prepareTransactionStatus(definition, transaction, false, newSynchronization, debugEnabled, null);&#125; ËøôÈáå‰ª£Á†ÅÂæàÂ§öÔºåÈÄªËæëÁúã‰∏äËø∞Ê≥®ÈáäÂç≥ÂèØ„ÄÇËøôÈáåÁªà‰∫éÁúãÂà∞‰∫ÜÊúüÂæÖÂ∑≤‰πÖÁöÑÊåÇËµ∑‰∫ãÂä°ÂíåÂÜÖÂµå‰∫ãÂä°‰∫ÜÔºåÊàë‰ª¨ËøòÊòØÁúã‰∏Ä‰∏ãDataSourceTransactionManagerÁöÑÂÆûÁé∞ ÊåÇËµ∑‰∫ãÂä°ÔºöÈÄöËøáTransactionSynchronizationManager::unbindResource Ê†πÊçÆÊï∞ÊçÆÊ∫êËé∑ÂèñÂΩìÂâçÁöÑConnectionÔºåÂπ∂Âú®resource‰∏≠ÁßªÈô§ËØ•Connection„ÄÇ‰πãÂêé‰ºöÂ∞ÜËØ•ConnectionÂ≠òÂÇ®Âà∞TransactionStatusÂØπË±°‰∏≠ 1234567// DataSourceTransactionManager::doSuspend@Overrideprotected Object doSuspend(Object transaction) &#123; DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction; txObject.setConnectionHolder(null); return TransactionSynchronizationManager.unbindResource(obtainDataSource());&#125; Âú®‰∫ãÂä°Êèê‰∫§ÊàñËÄÖÂõûÊªöÂêéÔºåË∞ÉÁî® AbstractPlatformTransactionManager::cleanupAfterCompletion‰ºöÂ∞ÜTransactionStatus ‰∏≠ÁºìÂ≠òÁöÑConnectionÈáçÊñ∞ÁªëÂÆöÂà∞resource‰∏≠ ÂÜÖÂµå‰∫ãÂä°ÔºöÈÄöËøáÂÖ≥Á≥ªÂûãÊï∞ÊçÆÂ∫ìÁöÑsavePointÂÆûÁé∞ÔºåÊèê‰∫§ÊàñÂõûÊªöÁöÑÊó∂ÂÄô‰ºöÂà§Êñ≠Â¶ÇÊûúÂΩìÂâç‰∫ãÂä°‰∏∫savePointÂàôÈáäÊîæsavePointÊàñËÄÖÂõûÊªöÂà∞savePointÔºåÂÖ∑‰ΩìÈÄªËæëÂèÇËÄÉAbstractPlatformTransactionManager::processRollback Âíå AbstractPlatformTransactionManager::processCommit Ëá≥Ê≠§Ôºå‰∫ãÂä°ÁöÑ‰º†Êí≠Ê∫êÁ†ÅÂàÜÊûêÁªìÊùü prepareTransactionInfo‰∏äÊñáÁïô‰∏ã‰∫Ü‰∏Ä‰∏™ÈóÆÈ¢òÔºåprepareTransactionInfo ÊñπÊ≥ïÂÅö‰∫Ü‰ªÄ‰πàÔºåÊàë‰ª¨ÂÖàÊù•Áúã‰∏ãTransactionInfoÁöÑÁªìÊûÑ123456789101112131415161718protected static final class TransactionInfo &#123; @Nullable private final PlatformTransactionManager transactionManager; @Nullable private final TransactionAttribute transactionAttribute; private final String joinpointIdentification; @Nullable private TransactionStatus transactionStatus; @Nullable private TransactionInfo oldTransactionInfo; // ...&#125; ËØ•Á±ªÂú®Spring‰∏≠ÁöÑ‰ΩúÁî®ÔºåÊòØ‰∏∫‰∫ÜÂÜÖÈÉ®‰º†ÈÄíÂØπË±°„ÄÇThreadLocal‰∏≠Â≠òÂÇ®‰∫ÜÊúÄÊñ∞ÁöÑTransactionInfoÔºåÈÄöËøáÂΩìÂâçTransactionInfoÂèØ‰ª•ÊâæÂà∞‰ªñÁöÑoldTransactionInfo„ÄÇÊØèÊ¨°ÂàõÂª∫‰∫ãÂä°Êó∂‰ºöÊñ∞Âª∫‰∏Ä‰∏™TransactionInfoÔºàÊó†ËÆ∫ÊúâÊ≤°ÊúâÁúüÊ≠£ÁöÑ‰∫ãÂä°Ë¢´ÂàõÂª∫ÔºâÂ≠òÂÇ®Âà∞ThreadLocal‰∏≠ÔºåÂú®ÊØèÊ¨°‰∫ãÂä°ÁªìÊùüÂêéÔºå‰ºöÂ∞ÜÂΩìÂâçThreadLocal‰∏≠ÁöÑTransactionInfoÈáçÁΩÆ‰∏∫oldTransactionInfoÔºåËøôÊ†∑ÁöÑÁªìÊûÑÂΩ¢Êàê‰∫Ü‰∏Ä‰∏™ÈìæË°®Ôºå‰ΩøÂæóSpring‰∫ãÂä°Âú®ÈÄªËæë‰∏äÂèØ‰ª•Êó†ÈôêÂµåÂ•ó‰∏ãÂéª Â¶ÇÊûúËßâÂæóÊúâÊî∂Ëé∑ÔºåÂèØ‰ª•ÂÖ≥Ê≥®ÊàëÁöÑÂÖ¨‰ºóÂè∑Ôºå‰Ω†ÁöÑÁÇπËµûÂíåÂÖ≥Ê≥®Â∞±ÊòØÂØπÊàëÊúÄÂ§ßÁöÑÊîØÊåÅ]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Ê∫êÁ†Å</tag>
        <tag>SpringBoot</tag>
        <tag>‰∫ãÂä°‰º†Êí≠</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java SPI ÂÆûÊàò]]></title>
    <url>%2Fpost%2Fe971632b.html</url>
    <content type="text"><![CDATA[SPI ÂÖ®Áß∞‰∏∫ (Service Provider Interface) ÔºåÊòØJDKÂÜÖÁΩÆÁöÑ‰∏ÄÁßçÊúçÂä°Êèê‰æõÂèëÁé∞Êú∫Âà∂ÔºåÂèØ‰ª•ËΩªÊùæÂÆûÁé∞Èù¢ÂêëÊúçÂä°ÁöÑÊ≥®ÂÜå‰∏éÂèëÁé∞ÔºåÂÆåÊàêÊúçÂä°Êèê‰æõ‰∏é‰ΩøÁî®ÁöÑËß£ËÄ¶ÔºåÂπ∂‰∏îÂèØ‰ª•ÂÆûÁé∞Âä®ÊÄÅÂä†ËΩΩ SPI ËÉΩÂÅö‰ªÄ‰πàÂà©Áî®SPIÊú∫Âà∂ÔºåsdkÁöÑÂºÄÂèëËÄÖÂèØ‰ª•‰∏∫‰ΩøÁî®ËÄÖÊèê‰æõÊâ©Â±ïÁÇπÔºå‰ΩøÁî®ËÄÖÊó†ÈúÄ‰øÆÊîπÊ∫êÁ†ÅÔºåÊúâÁÇπÁ±ª‰ººSpring @ConditionalOnMissingBean ÁöÑÊÑèÊÄù Âä®ÊâãÂÆûÁé∞‰∏Ä‰∏™SPI‰æãÂ¶ÇÊàë‰ª¨Ë¶ÅÊ≠£Âú®ÂºÄÂèë‰∏Ä‰∏™sdkÂÖ∂‰∏≠Êúâ‰∏Ä‰∏™ÁºìÂ≠òÁöÑÂäüËÉΩÔºå‰ΩÜÊòØÁî®Êà∑ÂæàÂèØËÉΩ‰∏çÊÉ≥‰ΩøÁî®Êàë‰ª¨ÁöÑÁºìÂ≠òÂÆûÁé∞ÔºåÁî®Êà∑ÊÉ≥Ë¶ÅËá™ÂÆö‰πâÁºìÂ≠òÁöÑÂÆûÁé∞ÔºåÊ≠§Êó∂‰ΩøÁî®spiÂ∞±ÈùûÂ∏∏ÁöÑÂêàÈÄÇ‰∫Ü Êñ∞Âª∫‰∏Ä‰∏™mavenÂ∑•Á®ãÂëΩÂêç‰∏∫sdk Cache Êé•Âè£12345678910111213import java.util.ServiceLoader;public interface Cache &#123; String getName(); static Cache load() &#123; // ServiceLoader ÂÆûÁé∞‰∫Ü IterableÔºåÂèØ‰ª•Âä†ËΩΩÂà∞CacheÊé•Âè£ÁöÑÂ§ö‰∏™ÂÆûÁé∞Á±ª ServiceLoader&lt;Cache&gt; cacheServiceLoader = ServiceLoader.load(Cache.class); return cacheServiceLoader.iterator().next(); &#125;&#125; ServiceLoader ÊòØJavaÊèê‰æõÊúçÂä°ÂèëÁé∞Â∑•ÂÖ∑Á±ªÔºåËøôÊòØÊàë‰ª¨ÂÆûÁé∞SPIÁöÑÂÖ≥ÈîÆ CacheDefaultImpl12345public class CacheDefaultImpl implements Cache &#123; public String getName() &#123; return &quot;defaultImpl&quot;; &#125;&#125; Èô§Ê≠§‰πãÂ§ñÔºåServiceLoader ËøòÈúÄË¶ÅÂú®classpath:META-INF/services ‰∏ãÊâæÂà∞‰ª•ËØ•Êé•Âè£ÂÖ®ÂêçÂëΩÂêçÁöÑÊñá‰ª∂ÔºåËøôÈáåÊàë‰ª¨Áõ¥Êé•Âú®resource ÁõÆÂΩï‰∏ãÂàõÂª∫META-INF/services/ com.github.tavenyin.CacheÊñá‰ª∂Âç≥ÂèØÔºåÊñá‰ª∂‰∏≠ÊåáÂÆöCacheÁöÑÂÆûÁé∞Á±ª 12# Ê≠§Â§ÑÂèØ‰ª•ÊåáÂÆöÂ§ö‰∏™ÂÆûÁé∞Á±ªcom.github.tavenyin.CacheDefaultImpl RunÊàë‰ª¨Âª∫Á´ã‰∏Ä‰∏™Êñ∞ÁöÑmavenÂ≠êÂ∑•Á®ãÔºåÂπ∂ÂºïÂÖ•sdkÊ®°ÂùóÔºåÊâßË°åÊµãËØï‰ª£Á†Å12System.out.println(Cache.load().getName()) # ËæìÂá∫ÁªìÊûú‰∏∫ defaultImpl ‰ΩøÁî®ËÄÖÂÆöÂà∂ÂåñÈÇ£‰πàÂ¶ÇÊûúsdkÁöÑ‰ΩøÁî®ËÄÖ‰∏çÊÉ≥‰ΩøÁî®Êàë‰ª¨ÁöÑCacheDefaultImpl‰∫ÜÊÄé‰πàÂäûÔºåÊ≤°ÂÖ≥Á≥ª‰ΩøÁî®ËÄÖÂè™ÈúÄË¶ÅË¶ÜÁõñ classpath:META-INF/services/com.github.tavenyin.Cache Â∞±ÂèØ‰ª•‰∫Ü Ôºà‰ΩøÁî®ËÄÖÂú®ÂêåÊ†∑Âú®resource‰∏ãÂàõÂª∫Âç≥ÂèØË¶ÜÁõñÔºâ Êàë‰ª¨ÂÜçÊù•ËøêË°å‰∏Ä‰∏ãÊµãËØï‰ª£Á†ÅÔºåËæìÂá∫ÁªìÊûú‰∏∫ newImpl ServiceLoader ÂÆûÁé∞ÂéüÁêÜServiceLoader ÁöÑÂÆûÁé∞ÂéüÁêÜËøòÊòØÊØîËæÉÁÆÄÂçïÁöÑÔºåËØïÊÉ≥‰∏Ä‰∏ãÔºåÂ¶ÇÊûúÊàë‰ª¨Ëá™Â∑±ÂÆûÁé∞‰∏Ä‰∏™ServiceLoaderÔºåÊàë‰ª¨‰ºöÊÄé‰πàÂÅöÔºü ÈÄöËøáÊåáÂÆöÁöÑÊñá‰ª∂Âä†ËΩΩÂá∫ÊâÄÊúâÁöÑÁ±ªÂêç ÈÄöËøáÂèçÂ∞ÑÊûÑÂª∫Ëøô‰∫õÂØπË±° Ê≤°ÈîôÔºåServiceLoader Â∞±ÊòØËøô‰πàÂÅöÁöÑÔºåÊàë‰ª¨Êù•ÁÆÄÂçïÁúã‰∏Ä‰∏ãÊ∫êÁ†Å ÂÖ•Âè£ ServiceLoader::iterator::next 1234567891011121314151617181920212223242526272829303132// Cached providers, in instantiation orderprivate LinkedHashMap&lt;String,S&gt; providers = new LinkedHashMap&lt;&gt;();// The current lazy-lookup iteratorprivate LazyIterator lookupIterator; // ServiceLoader::iteratorpublic Iterator&lt;S&gt; iterator() &#123; return new Iterator&lt;S&gt;() &#123; Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders = providers.entrySet().iterator(); public boolean hasNext() &#123; if (knownProviders.hasNext()) return true; return lookupIterator.hasNext(); &#125; // ServiceLoader::iterator::next public S next() &#123; if (knownProviders.hasNext()) return knownProviders.next().getValue(); return lookupIterator.next(); &#125; public void remove() &#123; throw new UnsupportedOperationException(); &#125; &#125;;&#125; ‰ªéproviders ÂàùÂßã‰∏∫‰∏Ä‰∏™Á©∫ÁöÑLinkedHashMapÔºåÊàë‰ª¨Êó†ÈúÄÂÖ≥Ê≥®ÔºåÊâÄ‰ª•knownProviders::hasNext ‰∏ÄÂÆöËøîÂõûfalseÔºåÊàë‰ª¨Áõ¥Â•îknownProviders::next knownProviders::next ‰∏≠Ê†∏ÂøÉÈÄªËæëÂú®nextService() ‰∏≠1234567891011121314151617181920212223242526272829303132private S nextService() &#123; // hasNextService ‰∏≠ÂÅö‰∫Ü‰∏§‰ª∂‰∫ã // 1. Âà§Êñ≠ÊòØÂê¶ËøòÊúâÊúçÂä°ÁöÑÊèê‰æõËÄÖ // 2. ÈÄöËøá &quot;META-INF/services/&quot; + Êé•Âè£ÂÖ®Âêç Âä†ËΩΩÊâÄÊúâÊèê‰æõËÄÖClassName if (!hasNextService()) throw new NoSuchElementException(); String cn = nextName; nextName = null; Class&lt;?&gt; c = null; try &#123; // ÈÄöËøáClassName ÂàõÂª∫Class c = Class.forName(cn, false, loader); &#125; catch (ClassNotFoundException x) &#123; fail(service, &quot;Provider &quot; + cn + &quot; not found&quot;); &#125; if (!service.isAssignableFrom(c)) &#123; fail(service, &quot;Provider &quot; + cn + &quot; not a subtype&quot;); &#125; try &#123; // ÂèçÂ∞ÑÂàõÂª∫ÂÆûÁé∞Á±ªÂÆû‰æã S p = service.cast(c.newInstance()); providers.put(cn, p); return p; &#125; catch (Throwable x) &#123; fail(service, &quot;Provider &quot; + cn + &quot; could not be instantiated&quot;, x); &#125; throw new Error(); // This cannot happen&#125; ‰∏éÊàë‰ª¨‰∏äËø∞ÂàÜÊûêÁöÑÂÆûÁé∞ËøáÁ®ã‰∏ÄËá¥ÔºåÊõ¥Â§öÁªÜËäÇÊÑüÂÖ¥Ë∂£ÁöÑÁ´•ÈûãÂèØËá™Ë°åÈòÖËØª ServiceLoader Â¶Ç‰ΩïÂÆûÁé∞Âä®ÊÄÅÂä†ËΩΩÂêå‰∏Ä‰∏™ ServiceLoader ÂØπË±°ÁöÑËØùÔºå‰∏ç‰ºöÈáçÊñ∞Âä†ËΩΩMETA-INF/services/‰∏ãÁöÑ‰ø°ÊÅØ„ÄÇÂ¶ÇÊûúÊàë‰ª¨ÈúÄË¶ÅÂä®ÊÄÅÂä†ËΩΩÁöÑËØùÔºåÂèØ‰ª•ËÄÉËôëÊØèÊ¨°ÈáçÊñ∞ÂàõÂª∫Êñ∞ÁöÑServiceLoader ÂØπË±°ÔºåÊàñËÄÖË∞ÉÁî® ServiceLoader::reload demo Âú∞ÂùÄhttps://github.com/TavenYin/java-spi.git Â¶ÇÊûúËßâÂæóÊúâÊî∂Ëé∑ÔºåÂèØ‰ª•ÂÖ≥Ê≥®ÊàëÁöÑÂÖ¨‰ºóÂè∑„ÄêÊÆ∑Â§©Êñá„ÄëÔºå‰Ω†ÁöÑÁÇπËµûÂíåÂÖ≥Ê≥®Â∞±ÊòØÂØπÊàëÊúÄÂ§ßÁöÑÊîØÊåÅ]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SPI</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot Websocket ÂÆûÊàò]]></title>
    <url>%2Fpost%2Fa77ef6c7.html</url>
    <content type="text"><![CDATA[Websocket ÊòØ‰∏ÄÁßçÂú®Âçï‰∏™TCPËøûÊé•‰∏äËøõË°åÂÖ®ÂèåÂ∑•ÈÄö‰ø°ÁöÑÂçèËÆÆ„ÄÇWebSocketËøûÊé•ÊàêÂäüÂêéÔºåÊúçÂä°Á´Ø‰∏éÂÆ¢Êà∑Á´ØÂèØ‰ª•ÂèåÂêëÈÄö‰ø°„ÄÇÂú®ÈúÄË¶ÅÊ∂àÊÅØÊé®ÈÄÅÁöÑÂú∫ÊôØÔºåWebsocket Áõ∏ÂØπ‰∫éËΩÆËØ¢ËÉΩÊõ¥Â•ΩÁöÑËäÇÁúÅÊúçÂä°Âô®ËµÑÊ∫êÂíåÂ∏¶ÂÆΩÔºåÂπ∂‰∏îËÉΩÂ§üÊõ¥ÂÆûÊó∂Âú∞ËøõË°åÈÄöËÆØ„ÄÇ ‰∏é HTTP ÂçèËÆÆÊúâÁùÄËâØÂ•ΩÁöÑÂÖºÂÆπÊÄß„ÄÇÈªòËÆ§Á´ØÂè£‰πüÊòØ80Âíå443ÔºåÂπ∂‰∏îÊè°ÊâãÈò∂ÊÆµÈááÁî® HTTP ÂçèËÆÆÔºåÂõ†Ê≠§Êè°ÊâãÊó∂‰∏çÂÆπÊòìÂ±èËîΩÔºåËÉΩÈÄöËøáÂêÑÁßç HTTP ‰ª£ÁêÜÊúçÂä°Âô®„ÄÇ ‰æùËµñ‰∫éTCPÂçèËÆÆ Êï∞ÊçÆÊ†ºÂºèÊØîËæÉËΩªÈáèÔºåÊÄßËÉΩÂºÄÈîÄÂ∞èÔºåÈÄö‰ø°È´òÊïà„ÄÇ ÂèØ‰ª•ÂèëÈÄÅÊñáÊú¨Ôºå‰πüÂèØ‰ª•ÂèëÈÄÅ‰∫åËøõÂà∂Êï∞ÊçÆ„ÄÇ Ê≤°ÊúâÂêåÊ∫êÈôêÂà∂ÔºåÂÆ¢Êà∑Á´ØÂèØ‰ª•‰∏é‰ªªÊÑèÊúçÂä°Âô®ÈÄö‰ø°„ÄÇ ÂçèËÆÆÊ†áËØÜÁ¨¶ÊòØwsÔºàÂ¶ÇÊûúÂä†ÂØÜÔºåÂàô‰∏∫wssÔºâÔºåÊúçÂä°Âô®ÁΩëÂùÄÂ∞±ÊòØ URL„ÄÇ SpringBoot ‰∏≠‰ΩøÁî® WebsocketÂú®ÁÆÄÂçï‰∫ÜËß£Websocket ‰πãÂêéÔºåÊàë‰ª¨Êù•Âä®ÊâãÂÆûË∑µ‰∏Ä‰∏ã„ÄÇSpringBoot ‰∏≠ÊúâÂ§öÁßçÊñπÂºèÂèØ‰ª•ÂÆûÁé∞Websocket ServerÔºåËøôÈáåÊàëÈÄâÊã©‰ΩøÁî®Tomcat ‰∏≠ javax.websocket.server ÁöÑapiÊù•ÂÆûÁé∞ÔºåÁªìÂ∞æ‰ºöÁªôÂá∫demoÂú∞ÂùÄ ÂºïÂÖ•Maven‰æùËµñ 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;&lt;/dependency&gt; ÂàõÂª∫‰∏Ä‰∏™BeanÁî®‰∫éÂ§ÑÁêÜWebsocket ËØ∑Ê±ÇÔºåÈÄöËøáServerEndpoint Â£∞ÊòéÂΩìÂâçBean Êé•ÂèóÁöÑWebsocket URL ËøôÈáå‰∏∫‰ªÄ‰πàÂ£∞ÊòéÁöÑÊòØ @ControllerÔºåÂêéÊñá‰ºöËß£Èáä 1234567891011121314151617181920212223242526272829303132333435363738394041import org.springframework.stereotype.Controller;import javax.websocket.*;import javax.websocket.server.ServerEndpoint;@ServerEndpoint(value = &quot;/message_websocket&quot;)@Controllerpublic class MsgWebsocketController &#123; @OnOpen public void onOpen(Session session) &#123; // ÂÖàÈâ¥ÊùÉÔºåÂ¶ÇÊûúÈâ¥ÊùÉÈÄöËøáÂàôÂ≠òÂÇ®WebsocketSessionÔºåÂê¶ÂàôÂÖ≥Èó≠ËøûÊé•ÔºåËøôÈáåÁúÅÁï•‰∫ÜÈâ¥ÊùÉÁöÑ‰ª£Á†Å WebSocketSupport.storageSession(session); System.out.println(&quot;session open. ID:&quot; + session.getId()); &#125; /** * ËøûÊé•ÂÖ≥Èó≠Ë∞ÉÁî®ÁöÑÊñπÊ≥ï */ @OnClose public void onClose(Session session) &#123; System.out.println(&quot;session close. ID:&quot; + session.getId()); &#125; /** * Êî∂Âà∞ÂÆ¢Êà∑Á´ØÊ∂àÊÅØÂêéË∞ÉÁî®ÁöÑÊñπÊ≥ï */ @OnMessage public void onMessage(String message, Session session) &#123; System.out.println(&quot;get client msg. ID:&quot; + session.getId() + &quot;. msg:&quot; + message); &#125; /** * ÂèëÁîüÈîôËØØÊó∂Ë∞ÉÁî® */ @OnError public void onError(Session session, Throwable error) &#123; error.printStackTrace(); &#125;&#125; Â£∞Êòé ServerEndpointExporter 123456789@Configurationpublic class WebsocketConfig &#123; @Bean public ServerEndpointExporter serverEndpointExporter() &#123; return new ServerEndpointExporter(); &#125;&#125; Ëá≥Ê≠§ÔºåWebsocket Server Â∑≤ÁªèÊê≠Âª∫ÂÆåÊàêÔºåÂÆ¢Êà∑Á´ØÂ∑≤ÁªèÂèØ‰ª•ÂíåÊúçÂä°Á´ØÈÄö‰ø°‰∫Ü ÊúçÂä°Á´Ø ÂêëÂÆ¢Êà∑Á´ØÊé®ÈÄÅÊ∂àÊÅØ ÈÄöËøá session.getBasicRemote().sendText(message); Âç≥ÂèØ Ê∫êÁ†ÅÊµÖÊûêÊàë‰ª¨Êù•Áúã‰∏ã‰∏äËø∞ÁöÑÁü≠Áü≠Âá†Ë°å‰ª£Á†ÅÊòØÂ¶Ç‰Ωï‰∏∫Êàë‰ª¨ÊûÑÂª∫ Websocket Server ServerEndpointExporter ÈáçÁÇπÂÖ≥Ê≥®‰∏ãÁ∫¢Ê°Ü‰∏≠ÁöÑÂÜÖÂÆπ ServerEndpointExporter ÂÆûÁé∞‰∫Ü SmartInitializingSingletonÔºå‰ºöÂú®bean ÂÆû‰æãÂåñÁªìÊùüÂêéË∞ÉÁî® afterSingletonsInstantiated ‰ªéSpring‰∏ä‰∏ãÊñá‰∏≠Ëé∑ÂèñÊâÄÊúâÊ†áËÆ∞@ServerEndpointÁöÑBeanÁöÑname ÂÖ∂ÂÆû Êàë‰ª¨Â£∞ÊòéÁöÑ MsgWebsocketController ‰∏≠Âπ∂‰∏çÊòØÂè™ËÉΩÊ†áËÆ∞@ControllerÔºåÂè™ÊòØ‰∏∫‰∫ÜÂ∞ÜÂÖ∂Ê≥®ÂÜåÂà∞SpringÂÆπÂô®‰∏≠ÔºåÊñπ‰æøServerEndpointÁöÑÊ≥®ÂÜåËÄåÂ∑≤ÔºåÊ†áËÆ∞ @Controller Êõ¥Á¨¶ÂêàSpringÁöÑÂºÄÂèëËßÑËåÉ 3~4. ÈÄöËøáServerContainer Â∞ÜÊâÄÊúâÊ†áËÆ∞@ServerEndpointÁöÑBean Ê≥®ÂÜå ServerContainer ÈªòËÆ§ÁöÑÂÆûÁé∞Á±ª‰∏∫ WsServerContainerÔºå‰ºöÂØπÊàë‰ª¨ÁöÑServerEndpointÂÅö‰∏Ä‰∏™Êò†Â∞ÑÔºåURL =&gt; ÂØπÂ∫îÁöÑclassÔºåÁÑ∂ÂêéÈíàÂØπ‰∏çÂêåÁöÑ‰∫ã‰ª∂Ë∞ÉÁî®ÊåáÂÆöÁöÑÊñπÊ≥ïÔºà‰æãÂ¶ÇÂª∫Á´ãËøûÊé•Êó∂Ë∞ÉÁî®Ê†áËÆ∞@OnopenÁöÑÊñπÊ≥ïÔºâÔºåËøôÊúâÁÇπSpring DispatcherServlet ÈÇ£Âë≥ÔºåÊÑüÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•Ëá™Â∑±Áúã‰∏ã Âú®‰∫ÜËß£‰∫Ü Spring ‰∏∫Êàë‰ª¨ÂÅö‰∫Ü‰ªÄ‰πàÂêéÔºåÊàë‰ª¨Êù•ÂÆåÂñÑ‰∏Ä‰∏ãÊàë‰ª¨ÁöÑDemo Âª∫Á´ã‰∏Ä‰∏™SessionManagerÂΩìÊàë‰ª¨ÊÉ≥ÂêëÂÆ¢Êà∑Á´ØÊé®ÈÄÅÊ∂àÊÅØÁöÑÊó∂ÂÄôÔºåÈ¶ñÂÖàÊàë‰ª¨ÈúÄË¶ÅÊâæÂà∞ÂÆ¢Êà∑Á´Ø‰∏éÊúçÂä°Á´ØÂª∫Á´ãÁöÑËøûÊé•Ôºå‰πüÂ∞±ÊòØWebscoketSession WsServerContainer ‰∏≠ËôΩÁÑ∂Â∑≤ÁªèÂ≠òÂÇ®‰∫Ü WebscoketSessionÔºå‰ΩÜÊòØÂπ∂Ê≤°ÊúâÂäûÊ≥ïÁõ¥Êé•ÈÄöËøáSessionIdÔºåÊàñËÄÖÊàë‰ª¨ÁöÑ‰∏öÂä°Id Áõ¥Êé•ÂÆö‰ΩçÂà∞ÊåáÂÆöÁöÑSessionÔºåÊâÄ‰ª•Êàë‰ª¨ÈúÄË¶ÅÂÆûÁé∞‰∏Ä‰∏™Ëá™Â∑±ÁöÑSessionManager 1final ConcurrentHashMap&lt;Object, Session&gt; sessionPool = new ConcurrentHashMap&lt;&gt;(); ‰ΩøÁî® ConcurrentHashMap ÁÆ°ÁêÜÂç≥ÂèØ ÂàÜÂ∏ÉÂºèÊé®ÈÄÅËß£ÂÜ≥ Â¶ÇÂõæÔºåÁî®Êà∑1‰∏éÊúçÂä°Âô®AÂª∫Á´ãWebscoketÔºåÁî®Êà∑2‰∏éÊúçÂä°Âô®BÂª∫Á´ãWebscoketÔºåÈÇ£‰πàÁî®Êà∑1Â¶ÇÊûúÊÉ≥ÂêëÁî®Êà∑2Êé®ÈÄÅ‰∏ÄÊù°Ê∂àÊÅØÔºåËØ•Â¶Ç‰ΩïÂÆûÁé∞Ôºü WebscoketSession ÂÆûÈôÖ‰∏äÊòØÁΩëÁªúËøûÊé•ÔºåÂπ∂‰∏çÂÉèÊàë‰ª¨‰º†ÁªüÂ∫îÁî®ÁöÑSessionÂèØ‰ª•Â∫èÂàóÂåñÂà∞RedisÔºåÂè™ËÉΩÊØè‰∏™ÊúçÂä°Âô®ÁÆ°ÁêÜËá™Â∑±ÁöÑWebscoketSessionÔºåÊâÄ‰ª•Ê≠§Êó∂ÊúçÂä°Âô®AÈÄöÁü•ÊúçÂä°Âô®BÔºå‰Ω†Ë¶ÅÁªôÁî®Êà∑2Êé®ÈÄÅ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ ‰∏Ä‰∏™ÊØîËæÉÁÆÄÂçïÊúâÊïàÁöÑÂÆûÁé∞ÊñπÊ≥ïÔºåÂà©Áî®Ê∂àÊÅØÈòüÂàóÔºåÂ¶Ç‰∏ãÂõæ Ëøô‰∏™ÊñπÊ°à‰ºòÁÇπÊòØÂÆûÁé∞ÁÆÄÂçïÔºåÁº∫ÁÇπÊòØÊØèÂè∞ÊúçÂä°Âô®ÈÉΩÈúÄË¶ÅÂà§Êñ≠‰∏ÄÈÅçÂΩìÂâçÊòØÂê¶Â≠òÂú®ÊåáÂÆöÁöÑWebscoketSession ÔºåÊñπÊ°àÁªÜÂåñÁöÑËØùÂàôÈúÄË¶ÅÁª¥Êä§Áî®Êà∑Session‰∏éÊØèÂè∞ÊúçÂä°Âô®ÁöÑÂÖ≥Á≥ªÔºåËøôÊ†∑Áõ¥Êé•Â∞ÜÊ∂àÊÅØÊé®ÈÄÅÁªôÊåáÂÆöÊúçÂä°Âô®Âç≥ÂèØ ÂÖ∂‰ªñÈóÆÈ¢òÊµãËØïÊó∂ÂèëÁé∞ÔºåÂΩìÂÆ¢Êà∑Á´ØÊñ≠ÁΩëÂêéÔºåÊúçÂä°Á´ØÊ£ÄÊµã‰∏çÂà∞ÂÆ¢Êà∑Á´ØÂ§±ÂéªËøûÊé•ÁöÑÊÉÖÂÜµÔºå‰æùÁÑ∂ÂèØ‰ª•Ë∞ÉÁî®SessionÁöÑÊé®ÈÄÅÊñπÊ≥ïÔºåÊúçÂä°Á´Ø‰ºö‰∏ÄÁõ¥ÊåÅÊúâËøô‰∏™Êó†ÊïàÁöÑSession ÁõÆÂâçÊÉ≥Âà∞ÁöÑËß£ÂÜ≥ÊñπÊ°àÔºöËÆæÁΩÆWebsocketSessionÁöÑÊúÄÂ§ßÁ©∫Èó≤Êó∂Èó¥Ôºàsession.setMaxIdleTimeout(milliseconds);ÔºâÔºåÂΩìË∂ÖËøáËøô‰∏™Êó∂Èó¥Êó∂ÔºåÊúçÂä°Á´Ø‰ºöÂÖ≥Èó≠Session„ÄÇÂâçÁ´ØÂÆöÊúüÂèëÈÄÅ‰∏ÄÊù°ÂøÉË∑≥ÂåÖÔºåÁî®‰∫éÁª¥ÊåÅSessionÔºåÂΩìÂá∫Áé∞‰∏äËø∞ÊÉÖÂÜµÊó∂ÔºåÊúçÂä°Á´Ø‰πü‰∏ç‰ºö‰∏ÄÁõ¥ÊåÅÊúâSession‰∫Ü ÂÆåÊï¥demoÂú∞ÂùÄÂÖ≥‰∫édemoÁöÑÁªÜËäÇÂèÇËÄÉÈ°πÁõÆÂú∞ÂùÄ‰∏≠Readme Github üëâ https://github.com/TavenYin/taven-springboot-learning/tree/master/sp-websocket Gitee üëâ https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/sp-websocket ÂèÇËÄÉhttp://www.ruanyifeng.com/blog/2017/05/websocket.html ÈÉ®ÂàÜ‰ª£Á†ÅÂèÇËÄÉ‰∫Ü‰∏Ä‰ΩçÂÖÑÂºüÁöÑÂçöÂÆ¢Ôºå‰ΩÜÊòØÁî±‰∫éÊó∂Èó¥ÊúâÁÇπÈïøÔºåÊâæ‰∏çÂà∞‰∫ÜÔºåÂú®Ê≠§ËØ¥‰∏ÄÂ£∞Êä±Ê≠â Â¶ÇÊûúËßâÂæóÊúâÊî∂Ëé∑ÔºåÂèØ‰ª•ÂÖ≥Ê≥®ÊàëÁöÑÂÖ¨‰ºóÂè∑„ÄêÊÆ∑Â§©Êñá„ÄëÔºåÁ¨¨‰∏ÄÊó∂Èó¥Êé•Êî∂Âà∞ÊàëÁöÑÊõ¥Êñ∞]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Websocket</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RedisËÉΩÂê¶‰øùËØÅÊï∞ÊçÆÈ´òÂèØÈù†ÊÄß]]></title>
    <url>%2Fpost%2Ff4cc44a4.html</url>
    <content type="text"><![CDATA[ËÆ∞ÂΩï‰∏ãÂ∑•‰Ωú‰∏≠ÂÖ≥‰∫éRedisÁöÑ‰∏Ä‰∫õÊÄùËÄÉÔºå‰∏ªË¶ÅÂÖ≥‰∫éRedisÁöÑ‰∫ãÂä°ÔºåËÑöÊú¨ÔºåÊåÅ‰πÖÂåñ Êú¨ÊñáËÆ®ËÆ∫ÁöÑÈóÆÈ¢òÔºö RedisÁöÑ‰∫ãÂä°ÊàñËÄÖÊâßË°åluaËÑöÊú¨ÂèØ‰ª•ÂÉèÂÖ≥Á≥ªÂûãÊï∞ÊçÆÂ∫ì‰∫ãÂä°ÈÇ£Ê†∑ÔºåË¶Å‰πàÂÖ®ÈÉ®Êèê‰∫§ÔºåË¶Å‰πàÂÖ®ÈÉ®ÂõûÊªöÂêóÔºü ÂΩìËÑöÊú¨ÊàñËÄÖ‰∫ãÂä°ÊâßË°åËøáÁ®ã‰∏≠ÂèëÁîüÂÆïÊú∫Redis‰∏≠ÁöÑÊï∞ÊçÆ‰ºö‰∏¢Â§±ÂêóÔºü ÂéüÂ≠êÊÄßÂú®RedisÁöÑÂºÄÂèëÊñáÊ°£‰∏≠ÂèØ‰ª•‰∫ÜËß£Âà∞ÔºåRedisÁöÑ‰∫ãÂä°‰ª•ÂèäRedisÊâßË°åluaËÑöÊú¨ÈÉΩÂèØ‰ª•‰øùËØÅÂéüÂ≠êÊÄßÔºàRedisÁöÑÊØèÊù°ÂëΩ‰ª§‰πüÊòØÂéüÂ≠êÁöÑÔºâÔºåÈÇ£‰πàÂéüÂ≠êÊÄßÂèØ‰ª•‰øùËØÅ‰ªÄ‰πàÔºüËÉΩÂê¶Ëß£ÂÜ≥Êàë‰ª¨ÁöÑÈóÆÈ¢òÔºüÂÖàÊù•Áúã‰∏ãÂéüÂ≠êÊÄßÁöÑÂÆö‰πâ Êù•Ëá™Áª¥Âü∫ÁôæÁßëÂØπÂÖ≥Á≥ªÂûãÊï∞ÊçÆÂ∫ì‰∫ãÂä°ÂéüÂ≠êÊÄßÁöÑÂÆö‰πâ ‰∫ãÂä°‰Ωú‰∏∫‰∏Ä‰∏™Êï¥‰ΩìË¢´ÊâßË°åÔºåÂåÖÂê´Âú®ÂÖ∂‰∏≠ÁöÑÂØπÊï∞ÊçÆÂ∫ìÁöÑÊìç‰ΩúË¶Å‰πàÂÖ®ÈÉ®Ë¢´ÊâßË°åÔºåË¶Å‰πàÈÉΩ‰∏çÊâßË°å Êù•Ëá™ÁôæÂ∫¶ÁôæÁßëÂéüÂ≠êÊìç‰ΩúÁöÑÂÆö‰πâ ÂéüÂ≠êÊìç‰ΩúÊòØ‰∏çÂèØÂàÜÂâ≤ÁöÑÔºåÂú®ÊâßË°åÂÆåÊØï‰πãÂâç‰∏ç‰ºöË¢´‰ªª‰ΩïÂÖ∂ÂÆÉ‰ªªÂä°Êàñ‰∫ã‰ª∂‰∏≠Êñ≠ Redis ÊâÄ‰øùËØÅÁöÑÂéüÂ≠êÊÄßÊ≠£ÊòØÂ¶ÇÊ≠§ ‰∏çÂèØÂàÜÂâ≤Ôºå‰øùËØÅ‰∫ãÂä°ÂíåËÑöÊú¨ÊâßË°åËøáÁ®ã‰∏≠Ôºå‰∏ç‰ºöË¢´ÂÖ∂‰ªñÂÆ¢Êà∑Á´ØÁöÑÂëΩ‰ª§ÊâìÊñ≠ ‰∫ãÂä°ÂíåËÑöÊú¨‰∏≠ÁöÑÂëΩ‰ª§ÔºåË¶Å‰πàÈÉΩÊâßË°åÔºåË¶Å‰πàÈÉΩ‰∏çÊâßË°å Redis TransactionsÂ¶Ç‰Ωï‰ΩøÁî®Redis ‰∫ãÂä°12345&gt; MULTI // ÂºÄÂêØ‰∫ãÂä°OK&gt; SET KEY VALUE // ÊâßË°åÂëΩ‰ª§ÔºåÊ≠§Êó∂ÁöÑÂëΩ‰ª§Âè™ÊòØÂÖ•ÈòüÔºå‰ºöÂú® EXEC ‰πãÂêéÂéüÂ≠êÊÄßÁöÑÊâßË°å‰∫ãÂä°‰∏≠ÊâÄÊúâÂëΩ‰ª§QUEUED&gt; EXEC / DISCARD // ÊâßË°åÊàñËÄÖÂèñÊ∂à‰∫ãÂä° RedisÁöÑ‰∫ãÂä°‰øùËØÅ Âú®Redis‰∫ãÂä°ÁöÑÊâßË°åËøáÁ®ã‰∏≠ÔºåÊ∞∏Ëøú‰∏ç‰ºöÊâßË°åÂè¶‰∏Ä‰∏™ÂÆ¢Êà∑Á´ØÂèëÂá∫ÁöÑËØ∑Ê±Ç ÊâÄÊúâÂëΩ‰ª§ÈÉΩ‰ºöÊâßË°åÔºåÊàñËÄÖ‰∏çÊâßË°å„ÄÇÂ¶ÇÊûúÂú®ÊâßË°å EXEC ‰πãÂâçÔºåÂÆ¢Êà∑Á´Ø‰∏éÊúçÂä°Á´ØÂ§±ÂéªÂìçÂ∫îÔºåÈÇ£‰πà‰∫ãÂä°‰∏≠ÊâÄÊúâÁöÑÂëΩ‰ª§ÈÉΩ‰∏ç‰ºöÊâßË°åÔºåÁõ∏ÂèçÂ¶ÇÊûúÊâßË°å EXEC ‰øùËØÅÊâÄÊúâÁöÑÂëΩ‰ª§ÈÉΩÊâßË°å„ÄÇ ‰∫ãÂä°‰∏≠ÂèØËÉΩÂèëÁîüÁöÑÈîôËØØ EXEC ‰πãÂâçÔºöÂëΩ‰ª§Êó†Ê≥ïQueuedÔºå‰æãÂ¶ÇËØ≠Ê≥ïÈîôËØØÔºàÈîôËØØÁöÑÂèÇÊï∞Êï∞ÈáèÔºåÈîôËØØÁöÑÂëΩ‰ª§ÔºâÔºåÊàñËÄÖ‰∏Ä‰∫õÂÖ∂‰ªñÈîôËØØÔºå‰æãÂ¶ÇÂÜÖÂ≠ò‰∏çË∂≥ÔºàRedis‰ΩøÁî®‰∫Ümaxmemory ÈôêÂà∂ÊúÄÂ§ßÂÜÖÂ≠òÔºâ EXEC ‰πãÂêéÔºöÂëΩ‰ª§‰πüÂèØËÉΩ‰ºöÂ§±Ë¥•Ôºå‰æãÂ¶ÇÈíàÂØπstringÁ±ªÂûã‰ΩøÁî®listÁöÑÂëΩ‰ª§ EXEC ‰πãÂâçÁöÑÈîôËØØÔºåÂÆ¢Êà∑Á´ØÂèØ‰ª•ÈÄöËøáÊ£ÄÊü•ÊúçÂä°Á´ØÁöÑÂìçÂ∫îÊù•Ëß£ÂÜ≥ÔºåÂΩìÂèëÁîüÂÖ•ÈòüÂ§±Ë¥•Êó∂ÔºàRedisÂìçÂ∫îÂÄºÈùûQUEUEDÔºâÔºåÂÆ¢Êà∑Á´ØDISCARDÂΩìÂâç‰∫ãÂä° ‰ªéRedis 2.6.5ÂºÄÂßãÔºåRedis ‰ºöËÆ∞ÂΩï‰∫ãÂä°ÊúüÈó¥ÂèëÁîüÁöÑÈîôËØØÔºåÂπ∂ÊãíÁªùÊâßË°å‰∫ãÂä°ÔºåÂú®ÊâßË°åEXECÊó∂ËøîÂõûÈîôËØØ‰ø°ÊÅØÂπ∂Ëá™Âä®‰∏¢ÂºÉËØ•‰∫ãÂä° ‰ΩÜÊòØEXEC ‰πãÂêéÁöÑÈîôËØØÔºåÂç≥‰ΩøÂØºËá¥ÈÉ®ÂàÜÂëΩ‰ª§ÊâßË°åÂ§±Ë¥•ÔºåRedisËøòÊòØ‰ºöÊâßË°åÂÖ∂‰ªñÁöÑÂâ©‰ΩôÂëΩ‰ª§ Redis ‰∫ãÂä°ÁöÑ‰∏çÂõûÊªöÊú∫Âà∂ËôΩÁÑ∂Redis‰øùËØÅ‰∫ÜÂéüÂ≠êÊÄßÔºå‰ΩÜÊòØ‰ªñÁöÑ‰∫ãÂä°Âπ∂‰∏ç‰ºöÂÉèÂÖ≥Á≥ªÂûãÊï∞ÊçÆÂ∫ìÈÇ£Ê†∑ÔºåÂú®Redis‰∫ãÂä°‰∏≠Â¶ÇÊûúÊüêÊù°ÂëΩ‰ª§ÂèëÁîü‰∫ÜÈîôËØØÔºåÂÖ∂‰ªñÁöÑÂëΩ‰ª§‰ºö‰æùÊóßÊâßË°åÔºåËøôÁÇπÁõ∏ÊØîËæÉÂÖ≥Á≥ªÂûãÊï∞ÊçÆÂ∫ìÊù•ËØ¥‰∏çÂÖçÊúâ‰∫õ‚ÄùÂ•áÊÄ™‚Äù‰∫Ü RedisÂºÄÂèëÊñáÊ°£‰∏≠ÁªôÂá∫ÁöÑËß£ÈáäÂ¶Ç‰∏ã Âè™ÊúâËØ≠Ê≥ïÈîôËØØÊâçÂèØËÉΩÂØºËá¥ÂëΩ‰ª§ÊâßË°åÂ§±Ë¥•ÔºåÂ§ßÂ§öÊï∞ÊÉÖÂÜµÈÉΩÊòØÁºñÁ®ãÈîôËØØÂØºËá¥ÁöÑ Âõ†‰∏∫‰∏çÈúÄË¶ÅÂõûÊªöÔºå‰ΩøÂæó Redis Êõ¥ÁÆÄÂçï Êõ¥È´òÊïà ÂÖ≥‰∫é‰∫ãÂä°ÁöÑÊõ¥Â§öÂÜÖÂÆπüëâ https://redis.io/topics/transactions Redis lua2.6.0 ÁâàÊú¨ÂêéÔºåRedis Â¢ûÂä†‰∫ÜÂØπluaËÑöÊú¨ÁöÑÊîØÊåÅÔºåËÑöÊú¨ÂíåRedis‰∫ãÂä°‰∏ÄÊ†∑‰øùËØÅ‰∫ÜÂéüÂ≠êÊÄßÔºåÊâßË°åËÑöÊú¨Êó∂‰∏ç‰ºöÊâßË°åÂÖ∂‰ªñËÑöÊú¨ÊàñRedisÂëΩ‰ª§ÔºàÊâÄ‰ª•‰∏çË¶ÅËÆ©ËÑöÊú¨ËøêË°åÊó∂Èó¥ËøáÈïøÔºâÔºåÂêåÊ†∑ËÑöÊú¨‰πüÊ≤°ÊúâÂõûÊªöÊú∫Âà∂ÔºåÂΩìËÑöÊú¨‰∏≠Âá∫Áé∞luaÁöÑÂºÇÂ∏∏ÔºåÊàñËÄÖRedisÂëΩ‰ª§ÈîôËØØÔºå‰πüÊó†Ê≥ï‰øùËØÅÂÖ®ÈÉ®ÊâßË°åÊàêÂäü Redis lua Âíå‰∫ãÂä°ÊúâÁÇπÁ±ª‰ººÔºå‰ΩÜÊòØÊúâ‰∫õÂú∫ÊôØ‰ΩøÁî®‰∫ãÂä°ÊòØÊó†Ê≥ïÂÅöÂà∞ÁöÑÔºå‰æãÂ¶ÇÊàëÊÉ≥ÂØπRedis‰∏≠ÁöÑÊï∞ÊçÆÂÖàËØªÔºåÁÑ∂ÂêéÊ†πÊçÆÂéüÊúâÊï∞ÊçÆÂèòÊõ¥ÔºåÊï¥‰∏™ËøáÁ®ãÊÉ≥Ë¶Å‰øùËØÅÂéüÂ≠êÊÄßÔºåÁî±‰∫é‰∫ãÂä°Âú®EXEC‰πãÂâçÊó†Ê≥ïËé∑ÂèñËøîÂõûÂÄºÔºå‰ΩøÁî®lua Â∞±ÈùûÂ∏∏ÂêàÈÄÇ ÂÖ≥‰∫éRedis lua Êõ¥Â§öÂÜÖÂÆπ üëâ https://redis.io/commands/eval Redis ÊâßË°åÂëΩ‰ª§Êó∂ÂÆïÊú∫Êï∞ÊçÆ‰ºö‰∏¢Â§±ÂêóÁúãÂà∞‰∫ÜËøôÔºåÁ¨¨‰∏Ä‰∏™ÈóÆÈ¢òÊàë‰ª¨Â∑≤ÁªèÊ∏ÖÊ•ö‰∫ÜÔºåRedisÂπ∂Ê≤°ÊúâÂõûÊªöÁöÑËÉΩÂäõÔºå‰ΩÜÊòØÈÄöÂ∏∏ÊÉÖÂÜµ‰∏ãÔºåËøô‰∫õÈúÄË¶ÅÂõûÊªöÁöÑÂú∫ÊôØÈÉΩÊòØÁºñÁ†ÅÈîôËØØÔºåÊàë‰ª¨ÊòØÂèØ‰ª•ÈÅøÂÖçÁöÑ„ÄÇÊàë‰ª¨ÁªßÁª≠Êé¢ÂØªÁ¨¨‰∫å‰∏™ÈóÆÈ¢òÁöÑÁ≠îÊ°à RedisÊòØÂü∫‰∫éÂÜÖÂ≠òÁöÑÊï∞ÊçÆÂ∫ìÔºåÊâÄ‰ª•ÂΩìÂèëÁîüÂÆïÊú∫ÊàñËÄÖÂÅúÊ≠¢ÂêéÈáçÊñ∞ÂêØÂä®Êó∂ÔºåRedis‰ºö‰ΩøÁî®Á£ÅÁõò‰∏äÁöÑÊåÅ‰πÖÂåñÊñá‰ª∂Êù•ÊÅ¢Â§çÊï∞ÊçÆÔºåÊâÄ‰ª•ÊòØÂê¶ËÉΩÊÅ¢Â§çÊï∞ÊçÆÔºåËÉΩÊÅ¢Â§çÂ§öÂ∞ëÊï∞ÊçÆÔºåÂèñÂÜ≥‰∫é‰ΩøÁî®Âì™‰∏ÄÁßçÊåÅ‰πÖÂåñÁ≠ñÁï• ÁÆÄÂçïËØ¥‰∏ã‰∏§ÁßçÊåÅ‰πÖÂåñÁ≠ñÁï• RDBÊåâÊåáÂÆöÁöÑÊó∂Èó¥Èó¥ÈöîÂ∞ÜÂÜÖÂ≠ò‰∏≠Êï∞ÊçÆÈõÜÂÜôÂÖ•Âø´ÁÖß AOFAOF‰ºöËÆ∞ÂΩïÊúçÂä°Âô®Êé•Êî∂ÁöÑÊØè‰∏™ÂÜôÂÖ•Êìç‰Ωú„ÄÇÂΩìRedisÂëΩ‰ª§ÊâßË°åÊàêÂäüÂêéÔºåÂëΩ‰ª§‰ºöË¢´‰º†Êí≠Âà∞AOFÁ®ãÂ∫è‰∏≠„ÄÇAOF ÁöÑ‰∏âÁßçÂêåÊ≠•Á≠ñÁï• appendfsync always ÔºöÊØèÊ¨°ÊúâÊï∞ÊçÆ‰øÆÊîπÂèëÁîüÊó∂ÈÉΩ‰ºöÂêåÊ≠•Âà∞AOFÊñá‰ª∂ appendfsync everysec ÔºöÊØèÁßíÈíüÂêåÊ≠•‰∏ÄÊ¨°ÔºåAOFÁöÑÈªòËÆ§Á≠ñÁï• appendfsync no ÔºöÂ∞ÜÊï∞ÊçÆÂêåÊ≠•Â∞ÜÁªôÊìç‰ΩúÁ≥ªÁªüÁÆ°ÁêÜÔºåÈÄöÂ∏∏linuxÁ≥ªÁªü30s‰ºöÂêåÊ≠•‰∏ÄÊ¨°Êï∞ÊçÆÔºå‰ΩÜËøôÂèñÂÜ≥‰∫éÊìç‰ΩúÁ≥ªÁªü Âç≥‰Ωø‰ΩøÁî®always ‰πüÊó†Ê≥ï‰øùËØÅÂÜôÂÖ•ÁöÑÊØè‰∏ÄÊù°ÂëΩ‰ª§ÈÉΩË¢´ÊåÅ‰πÖÂåñÔºå‰ªéÂëΩ‰ª§ÊâßË°åÊàêÂäüÂà∞Êï∞ÊçÆ‰øùÂ≠òÂà∞Á°¨Áõò‰πãÈó¥ÔºåËøòÊòØÊúâ‰∏ÄÊÆµÈùûÂ∏∏Â∞èÁöÑÈó¥Èöî ÂõûÂà∞Êàë‰ª¨ÁöÑÈóÆÈ¢ò‰∏äÔºåÂ¶ÇÊûú‰ΩøÁî®RDBÔºåÊØ´Êó†ÁñëÈóÆÔºåÊï∞ÊçÆÂè™ËÉΩÊÅ¢Â§çÂà∞‰∏äÊ¨°ÁöÑÂ§á‰ªΩ Âç≥‰Ωø‰ΩøÁî®AOFÁöÑËØùÔºåÂ¶ÇÊûúÂú®Redis‰∫ãÂä°ÊâßË°åÊúüÈó¥ÂÆïÊú∫ÔºåÈÇ£‰πàËøôÊ¨°‰∫ãÂä°ËøòÊòØÁõ∏ÂΩì‰∫é‚ÄùÊ≤°ÊúâÊâßË°å‚ÄùÔºåÁî±‰∫éÂëΩ‰ª§ËøòÊ≤°Êù•ÂèäÂÜôÂÖ•AOFÔºåÂú®ÊúçÂä°ÊÅ¢Â§çÂêéÊõ¥‰∏çÂèØËÉΩÊÅ¢Â§çÊï∞ÊçÆ„ÄÇÂØπ‰∫éRedisÂÆ¢Êà∑Á´ØËÄåË®ÄÔºå‰ºöÊî∂Âà∞ÊúçÂä°Á´ØÁöÑÂºÇÂ∏∏ÂìçÂ∫î ÂÜôÂÖ•AOFÁöÑËøáÁ®ã‰πüÊòØ‰ºöË¢´ÊâìÊñ≠ÁöÑÔºåRedis ÊñáÊ°£‰∏≠ÊèêÂà∞ÔºåÂ¶ÇÊûúRedisÊúçÂä°Âô®Á™ÅÁÑ∂Â¥©Ê∫ÉÔºåÂØºËá¥Âá∫Áé∞‰∫Ü‚ÄùÂçäÂÜôÁä∂ÊÄÅ‚ÄùÁöÑAOFÊñá‰ª∂Êó∂ÔºåÊúçÂä°Âô®ÈáçÊñ∞ÂêØÂä®Êó∂Ôºå‰ºöÊ£ÄÊµãÂà∞ËøôÁßçÊÉÖÂÜµÔºåÂπ∂‰∏îÈÄÄÂá∫ÊèêÁ§∫Áî®Êà∑‰ΩøÁî® redis-check-aof ‰øÆÂ§ç AOF Êñá‰ª∂„ÄÇ‚ÄùÂçäÂÜôÁä∂ÊÄÅ‚ÄùÁöÑ‰∫ãÂä°ÊàñËÄÖÂëΩ‰ª§‰ºöË¢´Âà†Èô§ÔºåÊúçÂä°Âô®ÂèØ‰ª•ÈáçÊñ∞ÂêØÂä®„ÄÇ Â¶ÇÊûúÂÜôÂÖ•AOFËøáÁ®ãË¢´ÊâìÊñ≠ÔºåÂØπ‰∫éÂÆ¢Êà∑Á´ØËÄåË®ÄÂèØËÉΩÊòØÊØ´Êó†ÊÑüÁü•ÁöÑÔºàÁúã‰∫Ü‰∏ãRedisÂëΩ‰ª§ÊâßË°åÁõ∏ÂÖ≥ÔºåAOFÂ∫îËØ•ÊòØÂèëÁîüÂú®ÂìçÂ∫îÂÆ¢Êà∑Á´Ø‰πãÂêéÔºâ ÊâÄ‰ª•Á¨¨‰∫å‰∏™ÈóÆÈ¢òÔºåÊàë‰ª¨‰πüÊ∏ÖÊ•ö‰∫ÜÔºåRedis Âπ∂‰∏çËÉΩ‰øùËØÅÊàë‰ª¨ÂÜôÂÖ•ÁöÑÊï∞ÊçÆÈÉΩÂÆâÂÖ®ÁöÑÊåÅ‰πÖÂåñ ÂÖ≥‰∫éÊåÅ‰πÖÂåñÁöÑÊõ¥Â§öÂÜÖÂÆπüëâ https://redis.io/topics/persistence Êâ©Â±ïÔºöËÑöÊú¨Â¶Ç‰ΩïÊåÅ‰πÖÂåñËøôÈáåËØ¥ÁöÑÊòØAOFÁöÑÊÉÖÂÜµ Âú®Redis 5 ‰πãÂâçÔºåÈªòËÆ§ÊòØÂ∞ÜËÑöÊú¨Êú¨Ë∫´‰º†Êí≠Âà∞AOF‰∏≠„ÄÇËøôÁßç‰º†Êí≠ÊñπÂºèÁöÑÂ•ΩÂ§ÑÔºå‰∏çÈúÄË¶ÅÂ∞ÜËÑöÊú¨ËΩ¨ÊàêRedisÂëΩ‰ª§ÔºåÂú®ÂÜôÂÖ•AOFÊàñËÄÖÂÖ∂‰ªñRedisÂÆû‰æãÊó∂‰∏ç‰ºöÂç†Áî®ËøáÂ§öÁöÑÂ∏¶ÂÆΩÂíåCPU Â§çÂà∂ËÑöÊú¨‰∏çÂÖÅËÆ∏ËÑöÊú¨‰∏≠Âá∫Áé∞ÈöèÊú∫ÊÄßÁöÑÂÜôÂÖ•ÔºåÂõ†‰∏∫Ëøô‰ºöÂØºËá¥ÈÄöËøáAOFÊÅ¢Â§çÊï∞ÊçÆÊó∂ÔºåÊï∞ÊçÆ‰∏ç‰∏ÄËá¥ÔºåÂú®ËøôÁÇπ‰∏äRedisÂÅö‰∫Ü‰∏Ä‰∫õÈôêÂà∂ÔºåÁî±‰∫é‰∏çÊòØÊú¨ÊñáÈáçÁÇπÂ∞±‰∏çÂ§öËØ¥‰∫ÜÔºåÂèØ‰ª•ÂèÇËÄÉRedisÂºÄÂèëÊñáÊ°£ ‰ªéRedis 3.2 ÂºÄÂßãÊñ∞Â¢û‰∫Ü‰∏ÄÁßçËÑöÊú¨Â§çÂà∂ÊñπÂºè script effects replicationÔºàRedis 5 ÂºÄÂßãÈªòËÆ§‰ΩøÁî®ËøôÁßçÊñπÂºèÂ§ÑÁêÜËÑöÊú¨Ôºâ„ÄÇËøôÁßçÊ®°Âºè‰∏ãÔºåRedis ‰ºöÊî∂ÈõÜËÑöÊú¨‰∏≠ÊâÄÊúâ‰øÆÊîπÊï∞ÊçÆÁöÑÂëΩ‰ª§„ÄÇÂΩìËÑöÊú¨ÊâßË°åÂÆåÊàêÂêéÔºåËøô‰∫õÂëΩ‰ª§Ë¢´ÂåÖË£ÖÊàê‰∏Ä‰∏™‰∫ãÂä°Ôºå‰º†Êí≠Âà∞AOF ÂíåÂÖ∂‰ªñÂÆû‰æã„ÄÇ ËøôÁßçÊñπÂºèÁöÑÂ•ΩÂ§Ñ ÂΩìËÑöÊú¨ÊâßË°åÂæàÊÖ¢ÁöÑÊó∂ÂÄôÔºå‰ºöÂΩ±ÂìçÂä†ËΩΩAOFÈáçÂª∫Êï∞ÊçÆÁöÑÊó∂Èó¥ÔºåËøôÁßçÊÉÖÂÜµ‰ΩøÁî® script effects replication ÊïàÁéáÊõ¥È´ò ËøôÁßçÊñπÂºè‰ºöÂÖÅËÆ∏ËÑöÊú¨‰∏≠Â≠òÂú®ÈöèÊú∫ÊÄßÁöÑÂÜôÂÖ• ‰ΩøÁî®ÊñπÂºè12-- Âú®ÊâßË°åRedisÂëΩ‰ª§ÂâçË∞ÉÁî®ÔºåÊàêÂäüÂêØÁî® script effects replication ËøîÂõûtrueredis.replicate_commands() ÊÄªÁªìÊâÄ‰ª•ËØ¥RedisÊó†ËÆ∫ÊòØ‰∫ãÂä°ËøòÊòØËÑöÊú¨ÔºåÂπ∂‰∏çËÉΩÂÅöÂà∞ÂÉèÂÖ≥Á≥ªÂûãÊï∞ÊçÆ‰∫ãÂä°‰∏ÄÊ†∑ÔºåÊâÄ‰ª•ÈíàÂØπÊï∞ÊçÆ‰∏ÄËá¥ÊÄßË¶ÅÊ±ÇËæÉÈ´òÁöÑ‰∏öÂä°Âú∫ÊôØÔºåÂπ∂‰∏çÈÄÇÂêà‰ΩøÁî®Redis ËÄå‰∏î‰ªéÊåÅ‰πÖÂåñÊñπÈù¢Êù•ËÄÉËôëÔºåËøô‰πü‰∏çÊòØRedisÁöÑÂº∫È°πÔºåRedisÁöÑ‰ºòÂäøÊ≠£ÊòØÂü∫‰∫éÂÜÖÂ≠òÔºåÊâÄ‰ª•ËØªÂÜôÊÄßËÉΩÈ´ò„ÄÇËôΩÁÑ∂ÂÆïÊú∫ÁöÑÂèØËÉΩÊÄßÁúã‰ººÂæàÊûÅÁ´ØÔºåÈÄöÂ∏∏Êàë‰ª¨‰ΩøÁî®‰∫ÜÊüê‰∏™ÊúçÂä°ÂêéÔºåÊàë‰ª¨‰ºöÂ∞ΩÂèØËÉΩÁöÑ‰øùËØÅÂÆÉÁöÑÈ´òÂèØÁî®Ôºå‰ΩÜÊòØÊàë‰ª¨ÈúÄË¶ÅÁü•ÈÅìRedisÁöÑ‚ÄùÊåÅ‰πÖÂåñ‚ÄùÂπ∂‰∏çËÉΩ‰øùËØÅÊàë‰ª¨ÁöÑÊï∞ÊçÆÁªùÂØπÂÆâÂÖ®ÔºåÊâÄ‰ª•ÂΩìÊàë‰ª¨ÁöÑ‰∏öÂä°Âú∫ÊôØÂØπÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÔºåÊåÅ‰πÖÂåñË¶ÅÊ±ÇÂæàÈ´òÁöÑÊó∂ÂÄôÔºåÂÖ≥Á≥ªÂûãÊï∞ÊçÆÂ∫ì‰æùÊóßÊòØÂæàÂ•ΩÁöÑÈÄâÊã© ÂèÇËÄÉRedis ËÆæËÆ°‰∏éÂÆûÁé∞ AOFRedis ËÆæËÆ°‰∏éÂÆûÁé∞ ‰∫ãÂä°Redis ÂëΩ‰ª§ÊâßË°åËøáÁ®ã(‰∏ä)Redis ÂëΩ‰ª§ÊâßË°åËøáÁ®ã(‰∏ã)]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java ThreadLocal ÂÆûÁé∞ÂéüÁêÜ]]></title>
    <url>%2Fpost%2F764a84a5.html</url>
    <content type="text"><![CDATA[ThreadLocal Á∫øÁ®ãÊú¨Âú∞ÂèòÈáèÔºåÁÆóÊòØJavaÂºÄÂèë‰∏≠ÊØîËæÉÂ∏∏Áî®ÁöÑAPI‰∫ÜÔºå‰ªäÂ§©Êàë‰ª¨Êù•‰∏ÄÊé¢Á©∂Á´ü ‰ΩøÁî®Âú∫ÊôØThreadLocal ÈÄÇÁî®‰∫éÊØè‰∏™Á∫øÁ®ãÈúÄË¶ÅËá™Â∑±Áã¨Á´ãÁöÑÂÆû‰æã‰∏îËØ•ÂÆû‰æãÈúÄË¶ÅÂú®Â§ö‰∏™ÊñπÊ≥ï‰∏≠Ë¢´‰ΩøÁî®Ôºå‰πüÂ∞±ÊòØÂèòÈáèÂú®Á∫øÁ®ãÈó¥ÈöîÁ¶ªÔºåËÄåÂú®Âêå‰∏ÄÁ∫øÁ®ãÂÖ±‰∫´ÁöÑÂú∫ÊôØ„ÄÇ‰æãÂ¶ÇÁÆ°ÁêÜConnectionÔºåÊàë‰ª¨Â∏åÊúõÊØè‰∏™Á∫øÁ®ãÂè™‰ΩøÁî®‰∏Ä‰∏™ConnectionÂÆû‰æãÔºåËøô‰∏™Êó∂ÂÄôÁî®ThreadLocalÂ∞±ÂæàÂêàÈÄÇ„ÄÇ 12345678910111213141516public class ThreadLocalDemo &#123; private static final ThreadLocal&lt;Object&gt; threadLocal = new ThreadLocal&lt;&gt;(); public static void main(String[] args) &#123; threadLocal.set(new Object()); someMethod(); &#125; static void someMethod() &#123; // Ëé∑ÂèñÂú®threadLocal‰∏≠Â≠òÂÇ®ÁöÑÂØπË±° threadLocal.get(); // Ê∏ÖÈô§ThreadLocal‰∏≠Êï∞ÊçÆ threadLocal.remove(); &#125;&#125; ËøòÊúâ‰πãÂâçÂÜôËøáÁöÑ‰∏ÄÁØáÂä®ÊÄÅÂàáÊç¢Êï∞ÊçÆÊ∫ê https://www.jianshu.com/p/0a485c965b8bÔºåAOP ÈÄöËøá ThreadLocal ‰øùÂ≠òÂΩìÂâçÁ∫øÁ®ãÈúÄË¶ÅËÆøÈóÆÁöÑÊï∞ÊçÆÊ∫êÁöÑkeyÔºåAbstractRoutingDataSource ÂÜçÈÄöËøá ThreadLocal ‰∏≠ÁöÑÊï∞ÊçÆÂàáÊç¢Âà∞ÊåáÂÆöÁöÑÊï∞ÊçÆÊ∫êÔºåÂØπ‰∏öÂä°‰ª£Á†ÅÊØ´Êó†ÂÖ•‰æµ ÂéüÁêÜÂú®Êàë‰ª¨‰∫ÜËß£‰∫ÜÂ¶Ç‰Ωï‰ΩøÁî®‰πãÂêéÔºåÊù•Áúã‰∏ã ThreadLocal ÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑ ThreadLocal.get()Êàë‰ª¨‰ªégetÊñπÊ≥ïÊù•ÂàÜÊûêÔºåÂèØ‰ª•ÁúãÂà∞ÊñπÊ≥ï‰∏≠Ëé∑ÂèñÂΩìÂâçÁ∫øÁ®ãÔºåÂπ∂ÈÄöËøáÂΩìÂâçÁ∫øÁ®ãÂæóÂà∞‰∏Ä‰∏™ ThreadLocalMapÔºåÊàë‰ª¨ÂèØ‰ª•ÊöÇÊó∂ÊääËøô‰∏™ThreadLocalMap ÁêÜËß£‰∏∫Êàë‰ª¨ÁÜüÊÇâÁöÑHashMapÔºåÁÑ∂ÂêéÈÄöËøá thisÔºàÂΩìÂâçThreadLocalÂØπË±°Ôºâ‰Ωú‰∏∫keyÔºå‰ªéMap‰∏≠Ëé∑ÂèñEntry Êàë‰ª¨ÂÜçÊù•Áúã‰∏ãÔºåThreadLocalMap ‰ª•ÂèäThreadLocalMap.Entry ‰∏≠ÁöÑÊ†∏ÂøÉÊàêÂëòÂèòÈáèÔºåThreadLocalMap ‰∏≠ÂÆûÁé∞‰∫Ü‰∏Ä‰∏™ÁÆÄÂçïÁöÑhashË°® ÁúãÂà∞ËøôÈáå‰Ω†ÂèØËÉΩËøò‰∏çÊòØÂæàÊ∏ÖÊô∞ÔºåÁªìÂêà‰∏ãÈù¢ËøôÂº†ÂõæÁêÜËß£‰∏Ä‰∏ãÔºåÊØè‰∏™Á∫øÁ®ãÔºàThreadÂØπË±°Ôºâ‰∏≠Êúâ‰∏Ä‰∏™ThreadLocalMapÔºå‰ΩøÁ∫øÁ®ã‰πãÈó¥ÁöÑÊï∞ÊçÆÂ§©ÁÑ∂ÈöîÁ¶ªÔºåThreadLocalMap Êúâ‰∏ÄÂº†hashË°® Entry[]ÔºåÊØè‰∏™ Entry ‰∏≠ÂØπÂ∫îÂ≠òÂÇ®ÁùÄ‰∏Ä‰∏™ThreadLocalÂÆû‰æã - valueÔºåËøôÊ†∑‰ΩøÂæó‰∏çÂêåÁöÑThreadLocal ÂØπË±°‰πãÈó¥‰πüÂΩ¢Êàê‰∫ÜÈöîÁ¶ª ThreadLocalMap ‰∏≠ÁöÑhashË°®Êàë‰ª¨ÈÄöËøá ThreadLocalMap.set() Êù•‰∫ÜËß£‰∏ãÂÜÖÈÉ®ÁöÑhashË°®ÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑ Á∫øÊÄßÊé¢ÊµãÊòØÊåáÂΩìÂèëÁîühashÂÜ≤Á™ÅÊó∂ÔºåÂà©Áî®Âõ∫ÂÆöÁöÑÁÆóÊ≥ïÂØªÊâæ‰∏ÄÂÆöÊ≠•ÈïøÁöÑ‰∏ã‰∏™‰ΩçÁΩÆÔºàThreadLocal‰∏≠ÂèëÁîühashÂÜ≤Á™ÅÊó∂Ôºåindex+1ÔºâÔºå‰æùÊ¨°Âà§Êñ≠ÔºåÁõ¥Ëá≥ÊâæÂà∞ËÉΩÂ§üÂ≠òÊîæÁöÑ‰ΩçÁΩÆ Â¶ÇÊûúÁ∫øÁ®ã‰∏≠Êìç‰Ωú‰∫ÜÂ§ßÈáèÁöÑ ThreadLocal ÂØπË±°ÔºåÂäøÂøÖ‰ºöÈÄ†ÊàêhashÂÜ≤Á™ÅÔºåËøôÊòØÊ≤°ÊúâÂøÖË¶ÅÁöÑÊÄßËÉΩÂºÄÈîÄÔºåÂ¶ÇÊûúÂèØ‰ª•ÁöÑËØùÔºåÊàë‰ª¨ÂèØ‰ª•Âè™‰øùÁïô‰∏Ä‰∏™ThreadLocalÂØπË±° ÂÖ≥‰∫é ThreadLocal ÁöÑ‰∏Ä‰∫õÊÄùËÄÉ ‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®Âº±ÂºïÁî® Âõæ3‰∏≠ÔºåÊàë‰ª¨ÁúãÂà∞hashË°®‰∏≠‰ºöÂá∫Áé∞ key == nullÁöÑEntryÔºåËøôÊòØÂõ†‰∏∫ ThreadLocalMap.Entry ÁöÑkey ÔºàEntry ÂØπThreadLocalËÆæÁΩÆ‰∫ÜÂº±ÂºïÁî®ÔºåÂèØ‰ª•ÂõûÈ°æ‰∏Ä‰∏ãÂõæ2Ôºâ Âº±ÂºïÁî®ÁöÑÂØπË±°Êã•ÊúâÊõ¥Áü≠ÊöÇÁöÑÁîüÂëΩÂë®Êúü„ÄÇÂú®GCÊó∂Ôºå‰∏ÄÊó¶ÂèëÁé∞‰∫ÜÂØπË±°Âè™ÂÖ∑ÊúâÂº±ÂºïÁî®ÔºåËøô‰∏™ÂØπË±°‰∏ÄÂÆöË¢´ÂõûÊî∂ Ëøô‰πàÂÅöÁöÑÂéüÂõ†ÔºöÂ¶ÇÊûúThreadLocal ÂØπË±°ÈúÄË¶ÅË¢´ÂõûÊî∂Êó∂ÔºàÊ≠§Êó∂Âπ∂Ê≤°ÊúâË∞ÉÁî®ThreadLocal.removeÔºâÔºåÁ∫øÁ®ã‰∏≠ÁöÑThreadLocalMap ‰∏ÄÁõ¥Âº∫ÂºïÁî®ÁùÄ ThreadLocalÂØπË±°ÔºåËøô‰ºöËÆ© ThreadLocalÂØπË±° ‰ª•ÂèäÂØπÂ∫îÁöÑvalueÂØπË±°ÂÜÖÂ≠òÊó†Ê≥ïÈáäÊîæÔºåÂØºËá¥ÂÜÖÂ≠òÊ≥ÑÊºè„ÄÇËøôÁÆóÊòØThreadLocalÁöÑ‰∏ÄÁßçÂÆπÈîôÊú∫Âà∂ÔºåËøôÊ†∑ÂÅö‰ΩøÂæó‰∫ÜThreadLocalÂØπË±°ÂæóÂà∞‰∫ÜÂõûÊî∂Ôºå‰ΩÜÊòØvalueÁöÑÂÜÖÂ≠òÂπ∂Ê≤°ÊúâÈáäÊîæÔºåÊâÄ‰ª•ThreadLocalMap ÁöÑget„ÄÅsetÊñπÊ≥ï‰∏≠ÈÉΩ‰ºöÂéªÂ∞ùËØïÊ∏ÖÁêÜThreadLocalÂ∑≤ÁªèË¢´ÂõûÊî∂ÁöÑentry„ÄÇ ‰ΩøÁî®ËøáÂêé‰∏çÂèäÊó∂remove‰ºöÊÄé‰πàÊ†∑ ÂæàÂ§öÂçöÂÆ¢‰∏≠ÈÉΩÂº∫Ë∞É‰∫ÜÔºåThreadLocal.removeÁöÑÈáçË¶ÅÊÄß„ÄÇ‰∏æ‰∏™‰æãÂ≠êÔºåÊàë‰ª¨Êñ∞ÂêØ‰∫Ü‰∏Ä‰∏™Á∫øÁ®ãÂú®Ëøô‰∏™Á∫øÁ®ã‰∏≠‰ΩøÁî®‰∫ÜThreadLocalÔºåÊàë‰ª¨Âπ∂Ê≤°ÊúâË∞ÉÁî®removeÔºåËøô‰ºöÂØºËá¥Â≠òÂÇ®ÁöÑvalueÂØπË±°‰∏ÄÁõ¥Ê≤°ÊúâÂäûÊ≥ïË¢´ÂõûÊî∂ÔºåÁõ¥Âà∞Á∫øÁ®ãË¢´ÈîÄÊØÅ Á∫øÁ®ãÊ±†‰∏≠‰πüÈúÄË¶ÅremoveÂêó ‰ª•webÁ∫øÁ®ãÊ±†‰∏∫‰æãÔºåÂ¶ÇÊûúÊØèÊ¨°ÈÉΩÂú®ËøáÊª§Âô®‰∏≠Êìç‰ΩúÂêå‰∏Ä‰∏™ThreadLocal.setÔºåÁÑ∂Âêé‰∏öÂä°‰ª£Á†Å‰∏≠getÔºå‰ºº‰πéÊ≤°‰ªÄ‰πàÈóÆÈ¢ò„ÄÇËÆ°ÁÆóÂá∫ÁöÑhashÂÄºÈÉΩÊòØ‰∏ÄÊ†∑ÁöÑÔºåÊßΩ‰Ωç‰πüÊòØ‰∏ÄÊ†∑ÁöÑ‰ºöË¶ÜÁõñ‰∏ä‰∏ÄÊ¨°ÁöÑÂÄº„ÄÇÁ°ÆÂÆû‰∏öÂä°‰∏ç‰ºöÊúâÈóÆÈ¢òÔºå‰ΩÜÊòØËøòÊòØÊé®ËçêÂ§ßÂÆ∂Âú®‰ΩøÁî®ÂÆå‰πãÂêéremoveÔºåÂõ†‰∏∫ËøôÊ†∑‰ºöËÆ©Êó†Áî®ÁöÑvalueÂØπË±°Êó©ÁÇπË¢´ÂõûÊî∂ÔºåÂú®ÂæàÂ§öjavaÊ∫êÁ†Å‰∏≠ÈÉΩ‰ºöÁúãÂà∞ÔºåÂØπ‰∏Ä‰∫õ‰∏çÂÜç‰ΩøÁî®ÁöÑÂØπË±°ËøõË°åÂ¶Ç‰∏ãÁöÑhelp GCÊìç‰Ωú1object = null // help GC ÊâÄ‰ª•Êàë‰ª¨‰πüÈúÄË¶ÅËÆ©Êó†Áî®ÁöÑÂØπË±°Â§±ÂéªÂºïÁî®ÔºåÂ∏ÆÂä©GC Áªº‰∏äÊâÄËø∞ ThreadLocal ‰ΩøÁî®ËøáÂêéË¶ÅÂèäÊó∂removeÔºåÂ∏ÆÂä©JVMÈáäÊîæÂÜÖÂ≠ò ÂèÇËÄÉhttps://www.jianshu.com/p/98b68c97df9b]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Â§öÁ∫øÁ®ã</tag>
        <tag>Ê∫êÁ†Å</tag>
        <tag>Thread</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ÁîµÂïÜÊäÄÊúØ--Â∫ìÂ≠òËÆæËÆ°ÊåáÂåó]]></title>
    <url>%2Fpost%2Fc4f13c61.html</url>
    <content type="text"><![CDATA[ÂâçË®ÄÊúÄËøëÂú®Ëß£ÂÜ≥‰∏ÄÂ•óËÄÅÁîµÂïÜÁ≥ªÁªüÁöÑÂ∫ìÂ≠ò‚ÄùË∂ÖÂçñ‚ÄùÈóÆÈ¢ò„ÄÇ‰∏ÄÁõ¥‰ª•‰∏∫Ë∂ÖÂçñÈóÆÈ¢òÔºåÊúÄÈöæËß£ÂÜ≥ÁöÑÊòØÂ∫ìÂ≠òÊâ£ÂáèÔºåÂÆûÂàô‰∏çÁÑ∂ÔºåÊàë‰ª¨ÁöÑÁ≥ªÁªüÂú®Ëß£ÂÜ≥‰∫ÜÂ∫ìÂ≠òÊâ£ÂáèÈóÆÈ¢ò‰πãÂêéÔºåËøò‰ºö‰∏ÄÁõ¥Êúâ‚ÄúË∂ÖÂçñ‚ÄùÁé∞Ë±°ÔºüËøô‰∏ÄÂàáÁöÑËÉåÂêéÂà∞Â∫ïÊòØÈÅìÂæ∑ÁöÑÊ≤¶‰∏ßÔºåËøòÊòØ‰∫∫ÊÄßÁöÑÊâ≠Êõ≤ÔºåÊ¨¢ËøéÊî∂ÁúãÊú¨ÊúüËµ∞ËøëÁßëÂ≠¶ Êú¨ÊñáÂ∏¶‰Ω†Ëß£ÂÜ≥‰ª•‰∏ãÁîµÂïÜÂú∫ÊôØÈóÆÈ¢ò ‰øùËØÅÂ∫ìÂ≠òÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÊâ£Âáè Èò≤Ê≠¢Â∫ìÂ≠òÁöÑÂ§öÊ¨°Êâ£Âáè„ÄÅÂõûÊªö Ë∂ÖÊó∂Êú™ÊîØ‰ªòË¢´ÂèñÊ∂àÁöÑËÆ¢ÂçïÔºàÂèñÊ∂à‰ºöÂõûÊªöÂ∫ìÂ≠òÔºâÔºå Â¶ÇÊûúÊî∂Âà∞‰∫ÜÊîØ‰ªòÂõûË∞ÉÊÄé‰πàÂäû Â¶Ç‰ΩïÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÊâ£ÂáèÂ∫ìÂ≠òÂÖàÊù•ËØ¥ËØ¥Â∫ìÂ≠òÊâ£ÂáèÁöÑÈóÆÈ¢òÔºåËøôÊòØÊàë‰ª¨ÂéüÊù•ËÄÅÁ≥ªÁªüÁöÑÈÄªËæëÔºåÊ≥®ÊÑèÔºÅËøôÈáåÊòØÈîôËØØÁöÑÁ§∫‰æã 123456789// ‰ª•‰∏ãÊòØ‰º™‰ª£Á†ÅÔºåÈîôËØØÁöÑÁ§∫‰æã// Êü•ËØ¢Âá∫GoodsÂØπË±°$goods = selectGoodsById($id);if ($goods-&gt;num - $order_num &gt; 0) &#123; // ËÆ°ÁÆóÂá∫Êâ£ÂáèÂêéÁöÑÂ∫ìÂ≠ò $goods-&gt;num = $goods-&gt;num - $order_num; // ‰øùÂ≠ò save($goods);&#125; ‰∏äËø∞‰ª£Á†ÅÁäØ‰∫ÜÂ§ßÂøåÔºåÂπ∂ÂèëÊÉÖÂÜµ‰ºöÂØºËá¥Â§ö‰∏™Á∫øÁ®ãËØªÂà∞Áõ∏ÂêåÁöÑÂ∫ìÂ≠òÊï∞ÔºåÁÑ∂ÂêéÊâ£ÂáèÔºåÁÑ∂Âêé‰øùÂ≠òÂà∞DBÔºå‰∏ãÈù¢Êàë‰ª¨Êù•ËØ¥‰∏ãÊ≠£Á°ÆÁöÑÂßøÂäø Ê≠£Á°ÆÁöÑÂÅöÊ≥ïÂà©Áî®MySQL update ‰ºöÊåÅÊúâÂΩìÂâçËÆ∞ÂΩïÈîÅÁöÑÁâπÁÇπÔºå‰øùËØÅÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÊâ£Âáè SQL Á§∫‰æãÔºö1update kucun set num = num - ? where id = ? and num - ? &gt;= 0 Êàë‰ª¨ÁöÑËøôÊù°ËÆ∞ÂΩïÊ†πÊçÆ‰∏ªÈîÆÊõ¥Êñ∞ÔºåÂΩì‰∫ãÂä°A update ËøôÊù°ËÆ∞ÂΩïÊó∂Ôºå‰ºöÊåÅÊúâÂΩìÂâçËÆ∞ÂΩïÁöÑÈîÅÔºåÂΩì‰∫ãÂä°AÊú™Êèê‰∫§Êó∂ÔºåÂÖ∂‰ªñÊÉ≥Ë¶ÅÊõ¥Êñ∞ËøôÊù°ËÆ∞ÂΩïÁöÑ‰∫ãÂä°Âè™ËÉΩÁ≠âÂæÖÈîÅÈáäÊîæ ÂÖ≥‰∫éMySQL update ÈîÅÁöÑÁªÜËäÇÔºåÊú¨Êñá‰∏çËÆ®ËÆ∫ÔºåÂèØ‰ª•ÂèÇËÄÉMySQLÊñáÊ°£ https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.htmlhttps://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.htmlhttps://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html ËôΩÁÑ∂MySQLÂèØ‰ª•‰øùËØÅÊï∞ÊçÆÁöÑÂáÜÁ°ÆÊÄßÔºå‰ΩÜÊòØÂ§ßÂπ∂ÂèëÈáèÂú∫ÊôØ‰∏ãÔºåÂ§ßÈáèÁöÑÈîÅÁ´û‰∫âÔºåÂØºËá¥Â∫ìÂ≠òÁöÑÊâ£ÂáèÂèØËÉΩÊàê‰∏∫Á≥ªÁªüÊÄßËÉΩÁöÑÁì∂È¢à ‰ΩøÁî® Redis Â∫ìÂ≠òÊâ£Âáè‰ΩøÁî®RedisÁöÑ‰ºòÂäøÂæàÂ§öÔºåÂçïÁ∫øÁ®ãÁöÑÊñá‰ª∂‰∫ã‰ª∂Â§ÑÁêÜÂô®‰øùËØÅ‰∫ÜÂπ∂Âèë‰∏ãÂèØ‰ª•Á∫øÁ®ãÁöÑÂÆâÂÖ®Êâ£Âáè„ÄÅÂõûÊªöÂ∫ìÂ≠òÔºå ‰ª•ÂèäRedisÈ´òÊÄßËÉΩ„ÄÇ ËôΩÁÑ∂RedisËß£ÂÜ≥‰∫ÜÁ∫øÁ®ãÂÆâÂÖ®ÂíåÊÄßËÉΩÁöÑÈóÆÈ¢òÔºå‰ΩÜÊòØRedisÂπ∂‰∏çËÉΩÂÅöÂà∞ÂÉèMySQLÈÇ£Ê†∑‰∏ÄÊù°SQLÂëΩ‰ª§ÂÆåÊàêÂ∫ìÂ≠òÊâ£ÂáèÔºåÊàë‰ª¨ÈúÄË¶ÅÂÖàËØªÂá∫Â∑≤ÊúâÂ∫ìÂ≠òÔºåÂÜçÂíåÂΩìÂâç‰∏ãÂçïÂ∫ìÂ≠òÂÅö‰∏Ä‰∏™Âà§Êñ≠ÊòØÂê¶ÂèØ‰ª•Â∫ìÂ≠òÊâ£Âáè„ÄÇÊâÄ‰ª•ÊúÄ‰Ω≥ÁöÑÂÆûÁé∞ÊñπÊ°àÊòØÈÄöËøáRedis ÊâßË°åluaËÑöÊú¨Ôºå‰øùËØÅÊï¥‰∏™ÈÄªËæëÂ§ÑÁêÜÊúüÈó¥Ôºå‰∏ç‰ºöÊúâÂÖ∂‰ªñÂÆ¢Êà∑Á´ØÊèíËøõÊù• 12345678910111213141516171819202122232425262728293031/** * * Êâ£ÂáèÂ∫ìÂ≠òLuaËÑöÊú¨ * Â∫ìÂ≠òÔºàstockÔºâ-1ÔºöË°®Á§∫‰∏çÈôêÂ∫ìÂ≠ò * Â∫ìÂ≠òÔºàstockÔºâ0ÔºöË°®Á§∫Ê≤°ÊúâÂ∫ìÂ≠ò * Â∫ìÂ≠òÔºàstockÔºâÂ§ß‰∫é0ÔºöË°®Á§∫Ââ©‰ΩôÂ∫ìÂ≠ò * * @params Â∫ìÂ≠òkey * @return * -3:Â∫ìÂ≠òÊú™ÂàùÂßãÂåñ * -2:Â∫ìÂ≠ò‰∏çË∂≥ * -1:‰∏çÈôêÂ∫ìÂ≠ò * Â§ß‰∫éÁ≠â‰∫é0:Ââ©‰ΩôÂ∫ìÂ≠òÔºàÊâ£Âáè‰πãÂêéÂâ©‰ΩôÁöÑÂ∫ìÂ≠òÔºâ */const SUB_STOCK_LUA = &quot; if (redis.call(&apos;exists&apos;, KEYS[1]) == 1) then local stock = tonumber(redis.call(&apos;get&apos;, KEYS[1])); local num = tonumber(ARGV[1]); if (stock == -1) then return -1; end; if (stock &gt;= num) then return redis.call(&apos;incrby&apos;, KEYS[1], 0 - num); end; return -2; end; return -3;&quot;; Ê≥®ÊÑèÔºöÂΩìÂØπ‰∏Ä‰∏™ËÆ¢Âçï‰∏≠ÁöÑ good_list Êâ£ÂáèÂ∫ìÂ≠òÁöÑÊó∂ÂÄôÔºåÈúÄË¶ÅÊ≥®ÊÑèÔºåÂΩìÊüê‰∏Ä‰∏™ÂïÜÂìÅÂ∫ìÂ≠òÊâ£ÂáèÂ§±Ë¥•Êó∂Ôºå‰πãÂâçÁöÑÊâ£ÂáèÁöÑÂïÜÂìÅÂ∫ìÂ≠òÈúÄË¶ÅÂõûÊªö„ÄÇËøô‰ºöÊ∂âÂèäÂà∞ÂØπredisÁöÑÂ§öÊ¨°Êìç‰ΩúÔºå‰Ω†ÂèØ‰ª•ÊääÊï¥‰ΩìÈÄªËæëÂÜôÂà∞‰∏Ä‰∏™luaËÑöÊú¨‰∏≠ ‰ΩøÁî®Redis ÂÅöÂ∫ìÂ≠òÊâ£Âáè‰ºöÊúâ‰∏Ä‰∏™ÈóÆÈ¢òÔºà‰º™‰ª£Á†ÅÂ¶Ç‰∏ãÔºâÔºåRedisÊï∞ÊçÆÂíåMySQLÊï∞ÊçÆÂπ∂‰∏çËÉΩ‰øùËØÅÂº∫‰∏ÄËá¥ÊÄßÔºåÂõ†‰∏∫RedisÁöÑÊï∞ÊçÆÁõ∏ÂΩì‰∫éÁõ¥Êé•ÂÜôËøõÂéª‰∫ÜÔºåÂ¶ÇÊûúÂú®ÈúÄË¶ÅÂõûÊªöÁöÑÊó∂ÂÄôÔºåRedis‰∏çÂèØÁî®‰∫ÜÂØºËá¥Êï∞ÊçÆÊó†Ê≥ïÂõûÊªöÔºåÊúÄÁªà‰ºöÈÄ†ÊàêMySQLÊ≤°ÊúâÂÜôÂÖ•ËÆ¢ÂçïÊï∞ÊçÆÔºåRedisÂç¥Êâ£Âáè‰∫ÜÂ∫ìÂ≠ò 123456789101112try &#123; $db-&gt;beginTransaction(); $db-&gt;saveOrder(); $redis-&gt;reduceStock(); $db-&gt;commit(); &#125; catch (Exception $e) &#123; $db-&gt;rollback(); $redis-&gt;rollbackStock();&#125; ËøôÁßçÊÉÖÂÜµÂπ∂Ê≤°Êúâ‰ªÄ‰πàÂ•ΩÁöÑËß£ÂÜ≥ÂäûÊ≥ïÔºåËøôÊòØ‰∏Ä‰∏™Âá†ÁéáÈùûÂ∏∏Â∞èÁöÑÊïÖÈöúÔºåÈ¶ñÂÖàÊàë‰ª¨ËÇØÂÆöË¶ÅÂ∞ΩÂèØËÉΩÁöÑ‰øùËØÅRedisÁöÑÈ´òÂèØÁî®ÊÄßÔºåÂÖ∂Ê¨°Âú®ÂèëÁîüËøôÁßçÊÉÖÂÜµÂêéÔºåÊàë‰ª¨Ë¶ÅÊÉ≥ÂäûÊ≥ïÊÅ¢Â§çRedis‰∏≠ÁöÑÊï∞ÊçÆÔºå‰æãÂ¶ÇÊàë‰ª¨ÂèØ‰ª•Âú®Êï¥‰∏™ÈÄªËæë‰πãÂêéÔºåÈÄâÊã©ÂºÇÊ≠•ÁöÑÊñπÂºèÔºà‰æãÂ¶ÇMQÔºâÂêëMySQL‰∏≠ÂêåÊ≠•Â∫ìÂ≠òÔºåÂΩìÂèëÁîüÊïÖÈöúÂêéÔºå‰ª•MySQLÊï∞ÊçÆ‰∏∫ÂáÜÊÅ¢Â§çÊï∞ÊçÆ ÊâÄ‰ª•RedisÊòØ‰∏ÄÊääÂèåÂàÉÂâëÔºåÊèêÂçáÊÄßËÉΩÁöÑÂêåÊó∂Ôºå‰πüÂ∏¶Êù•‰∫ÜÈóÆÈ¢ò AliSQLËøôÊòØÂêéÊù•ÊàëÂú®ÁΩë‰∏äÁúãÂà∞ÁöÑÊñπÊ°àÔºåAliSQL ÊòØÈòøÈáåËá™Á†î MySQL ÂàÜÊîØÔºåAliSQL ÈíàÂØπÂπ∂Âèë‰øÆÊîπÂêå‰∏ÄËÆ∞ÂΩïÁöÑÊÉÖÂÜµÔºå‰ΩøÁî®Êï∞ÊçÆÂ∫ìÂ±ÇÈù¢ÁöÑÁºìÂÜ≤ÈòüÂàóÔºåÈÅøÂÖçÂ§ßÈáè‰∫âÈîÅÁöÑ‰ª£‰ª∑„ÄÇÊÑüÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•ËØï‰∏ãÔºàÈòøÈáå‰∫ëMySQL 8.0 ÈõÜÊàê‰∫ÜËøô‰∏ÄÂäüËÉΩÔºâÔºåÂ¶ÇÊûúAliSQLËß£ÂÜ≥‰∫ÜÊÄßËÉΩÈóÆÈ¢òÁöÑËØùÔºåÈÇ£‰πàËøô‰∏™ÊñπÊ°àÁõ∏ÊØîRedisË¶ÅÊõ¥Â•Ω ÂÖ≥‰∫éÂ∫ìÂ≠òÂ§öÊ¨°Êâ£ÂáèÁöÑÈóÆÈ¢òÂΩìËÆ¢ÂçïÁöÑÊèê‰∫§ÂíåÂ∫ìÂ≠òÁöÑÊâ£ÂáèÂêåÊ≠•ËøõË°åÁöÑÊó∂ÂÄôÔºå‰∏çÈúÄË¶ÅËÄÉËôëËøô‰∏™ÈóÆÈ¢ò„ÄÇ ‰∏æ‰æãÔºöËÆ¢ÂçïÁ≥ªÁªüÁîüÊàêËÆ¢Âçï‰πãÂêéÔºåÈÄöËøáMQÈÄöÁü•Â∫ìÂ≠òÁ≥ªÁªüÔºåÂ∫ìÂ≠òÁ≥ªÁªüÂºÇÊ≠•Êâ£ÂáèÂ∫ìÂ≠òÔºåËøô‰∏™Êó∂ÂÄôÂ∫ìÂ≠òÁ≥ªÁªüÂèØËÉΩ‰ºöÂ§öÊ¨°Ê∂àË¥πÔºåËøô‰∏™Êó∂ÂÄôÂ∞±ÈúÄË¶ÅËÄÉËôëËøô‰∏™ÈóÆÈ¢ò‰∫Ü„ÄÇ ÊàñËÄÖÊàë‰ª¨‰∏äÈù¢ËØ¥ÁöÑÈÄöËøáMQÂêåÊ≠•MySQLÂ∫ìÂ≠ò‰πüÈúÄË¶ÅËÄÉËôëÂèØËÉΩÂèëÁîüÂ§öÊ¨°Êâ£Âáè Ëß£ÂÜ≥ÊñπÊ°àÂ¶ÇÂõæÔºåÈÄöËøáËÆ¢ÂçïÂÅö‰∏∫ÂîØ‰∏ÄÁ¥¢Âºï‰øùËØÅÊµÅÊ∞¥ËÆ∞ÂΩïÁöÑÂîØ‰∏ÄÊÄßÔºå‰ªéËÄå‰øùËØÅÂè™ËÉΩÊúâ‰∏ÄÊ¨°ÊàêÂäüÁöÑÊâ£Âáè Â∫ìÂ≠òÂõûÊªöÈóÆÈ¢òÂ§öÊï∞ÂçöÂÆ¢ÂØπ‰∫éË∂ÖÂçñÁöÑËÆ≤Ëß£Âè™Âú®‰∫éÂ∫ìÂ≠òÁöÑÊâ£ÂáèÔºå‰ΩÜÊòØÂ∫ìÂ≠òÊâ£ÂáèÂÆâÂÖ®‰∫ÜÔºåÁúüÁöÑÂ∞±ÂèØ‰ª•‰øùËØÅ‰∏çË∂ÖÂçñÂêóÔºüÊàë‰ª¨ÁöÑÁ≥ªÁªüÂú®Ëß£ÂÜ≥‰∫ÜÂ∫ìÂ≠òÊâ£ÂáèÈóÆÈ¢òÂêéÔºåËøòÊòØÂá∫Áé∞Êàê‰∫§ËÆ¢Âçï &gt; Â∫ìÂ≠òÁöÑÈóÆÈ¢òÔºå‰∏∫Ê≠§Êàë‰πüÊòØÁªûÂ∞ΩËÑëÊ±ÅÔºåÊäìÁ†¥‰∫ÜÂ§¥ Âú®ÂØπ‰∏ãÂçïËøõË°åÂéãÂäõÊµãËØï‰πãÂêéÔºåÊàëÂùö‰ø°‰∏ãÂçï‰∏ç‰ºöÂá∫Áé∞Ë∂ÖÂçñÁöÑÈóÆÈ¢òÔºåÂêéÊù•ÊàëÊÄÄÁñëÈóÆÈ¢òÂá∫Âú®‰∫ÜÂ∫ìÂ≠òÂõûÊªöÔºåÂ¶ÇÊûú‰∏Ä‰∏™ËÆ¢ÂçïÂõûÊªö‰∫Ü‰∏§Ê¨°Â∫ìÂ≠òÔºàÂèñÊ∂àË∂ÖÊó∂Êú™ÊîØ‰ªòËÆ¢ÂçïÁöÑÁ∫øÁ®ãÂíåÁî®Êà∑Á∫øÁ®ãÂêåÊó∂ÂèñÊ∂à‰∏Ä‰∏™ËÆ¢ÂçïÔºâÔºåÂêåÊ†∑‰πü‰ºöÂá∫Áé∞Ë∂ÖÂçñÁöÑÁé∞Ë±°„ÄÇ Ëß£ÂÜ≥ÊñπÊ≥ïÔºöÂíåÈò≤Ê≠¢Â§öÊ¨°Êâ£Âáè‰∏ÄÊ†∑ÔºåÈááÁî®ÂÜôÂÖ•ËÆ¢ÂçïÂõûÊªöÊµÅÊ∞¥ÁöÑÊñπÂºèÔºå‰∏™‰∫∫ËÆ§‰∏∫ËøôÁßçÊñπÊ≥ïÊØîËæÉÂä†ÈîÅË¶ÅÂ•ΩÔºåÊï∞ÊçÆÊúâËøπÂèØÂæ™ Ë∂ÖÊó∂Êú™ÊîØ‰ªòË¢´ÂèñÊ∂àÁöÑËÆ¢ÂçïÊî∂Âà∞‰∫ÜÊîØ‰ªòÂõûË∞ÉÂú®Ëß£ÂÜ≥‰∫ÜÂ∫ìÂ≠òÂõûÊªöÈóÆÈ¢ò‰πãÂêéÔºåË∂ÖÂçñÈóÆÈ¢òËøòÊ≤°ÊúâËß£ÂÜ≥ÔºåÊúÄÂêéÈÄöËøáÊó•ÂøóÂÆö‰ΩçÂà∞‰∫ÜËøô‰∏™ÈóÆÈ¢ò„ÄÇ ÈóÆÈ¢òÊèèËø∞ÔºöÁî®Êà∑Âú®Á≥ªÁªüÂç≥Â∞ÜËá™Âä®ÂèñÊ∂àËÆ¢ÂçïÁöÑÂâç‰∏ÄÁû¨Èó¥ÂÆåÊàê‰∫ÜÊîØ‰ªòÔºåÁ≥ªÁªüÂèñÊ∂à‰∫ÜËØ•ËÆ¢ÂçïÂπ∂ÂõûÊªö‰∫ÜÂ∫ìÂ≠òÔºåÂêåÊó∂Á≥ªÁªüÊî∂Âà∞‰∫ÜËØ•ËÆ¢ÂçïÁöÑÊîØ‰ªòÂõûË∞ÉÔºåËØ•ËÆ¢ÂçïÁöÑÁä∂ÊÄÅÊõ¥Êîπ‰∏∫Â∑≤ÊîØ‰ªòÔºåÂõ†‰∏∫‰∏çËØ•Âá∫Áé∞ÁöÑÂ∫ìÂ≠òÂõûÊªöÂØºËá¥‰∫Ü‚ÄúË∂ÖÂçñ‚Äù ‰∏ãÈù¢ËØ¥‰∏ãÊàë‰ª¨ÁöÑËß£ÂÜ≥ÊñπÊ°àÔºå‰ª•ÂæÆ‰ø°ÊîØ‰ªò‰∏∫‰æã Êàë‰ª¨ÁöÑÁ≥ªÁªüÂú®Êèê‰∫§ËÆ¢Âçï‰πãÂêéÔºå‰ºöË∞ÉÁî®ÂæÆ‰ø°ÁöÑÁªü‰∏Ä‰∏ãÂçïÊé•Âè£ÔºåËøôÊó∂ÂÄôÂæÆ‰ø°Êî∂Âà∞‰∫ÜÊàë‰ª¨ÁöÑÂïÜÊà∑ËÆ¢ÂçïÂè∑ÔºàÂæÆ‰ø°Â∑≤ÁªèÁîüÊàêËÆ¢ÂçïÔºâÔºåÁî®Êà∑ÈÄâÊã©‰∏çÊîØ‰ªò„ÄÇË∂ÖÊó∂Ëá™Âä®ÂèñÊ∂àÈÄªËæëÂ§ÑÁêÜ‰πãÂâçÔºåÂÖàË∞ÉÁî®ÂæÆ‰ø°ÁöÑÂÖ≥Èó≠ËÆ¢ÂçïÊé•Âè£ÔºåÂ¶ÇÊûúÂÖ≥Èó≠ÊàêÂäüÔºåÂàôËøô‰∏™Êó∂ÂÄôÁî®Êà∑ÂêéÁª≠Êó†Ê≥ïÂØπËØ•ËÆ¢ÂçïÂèëËµ∑ÊîØ‰ªò„ÄÇÂ¶ÇÊûúËøîÂõûËÆ¢ÂçïÂ∑≤ÊîØ‰ªòÔºåÂàôÊó†ÈúÄÂ§ÑÁêÜËØ•ËÆ¢ÂçïÔºåËØ•ËÆ¢Âçï‰ºöÊî∂Âà∞ÂæÆ‰ø°ÊîØ‰ªòÁöÑÂõûË∞É ÂèÇËÄÉhttps://www.jianshu.com/p/76bc0e963172https://www.zhihu.com/question/268937734https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_3 Â¶ÇÊûúËßâÂæóÊñáÁ´†ÊúâÂ∏ÆÂä©ÔºåÊ¨¢ËøéÁÇπËµû„ÄÅËΩ¨Âèë„ÄÅÂÖ≥Ê≥®ÊàëÁöÑÂÖ¨‰ºóÂè∑Ôºå‰Ω†ÁöÑÊîØÊåÅÂ∞±ÊòØÊàëÊúÄÂ§ßÁöÑÂä®Âäõ]]></content>
      <categories>
        <category>ÁîµÂïÜÊäÄÊúØ</category>
      </categories>
      <tags>
        <tag>ÁîµÂïÜ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Êïô‰Ω†Â¶Ç‰Ωï‰ΩøÁî®MySQL8ÈÄíÂΩí.]]></title>
    <url>%2Fpost%2F2e0c1b4e.html</url>
    <content type="text"><![CDATA[‰πãÂâçÂÜôËøá‰∏ÄÁØá MySQLÈÄöËøáËá™ÂÆö‰πâÂáΩÊï∞ÁöÑÊñπÂºèÔºåÈÄíÂΩíÊü•ËØ¢Ê†ëÁªìÊûÑÔºå‰ªéMySQL 8.0 ÂºÄÂßãÁªà‰∫éÊîØÊåÅ‰∫ÜÈÄíÂΩíÊü•ËØ¢ÁöÑËØ≠Ê≥ï CTEÈ¶ñÂÖà‰∫ÜËß£‰∏Ä‰∏ã‰ªÄ‰πàÊòØ CTEÔºåÂÖ®Âêç Common Table Expressions12345WITH cte1 AS (SELECT a, b FROM table1), cte2 AS (SELECT c, d FROM table2)SELECT b, d FROM cte1 JOIN cte2WHERE cte1.a = cte2.c; cte1, cte2 ‰∏∫Êàë‰ª¨ÂÆö‰πâÁöÑCTEÔºåÂèØ‰ª•Âú®ÂΩìÂâçÊü•ËØ¢‰∏≠ÂºïÁî® ÂèØ‰ª•ÁúãÂá∫ CTE Â∞±ÊòØ‰∏Ä‰∏™‰∏¥Êó∂ÁªìÊûúÈõÜÔºåÂíåÊ¥æÁîüË°®Á±ª‰ººÔºå‰∫åËÄÖÁöÑÂå∫Âà´ËøôÈáå‰∏çÁªÜËØ¥ÔºåÂèØ‰ª•ÂèÇËÄÉ‰∏ãMySQLÂºÄÂèëÊñáÊ°£Ôºöhttps://dev.mysql.com/doc/refman/8.0/en/with.html#common-table-expressions-recursive-examples ÈÄíÂΩíÊü•ËØ¢ÂÖàÊù•Áúã‰∏ãÈÄíÂΩíÊü•ËØ¢ÁöÑËØ≠Ê≥ï1234567WITH RECURSIVE cte_name AS( SELECT ... -- return initial row set UNION ALL / UNION DISTINCT SELECT ... -- return additional row sets)SELECT * FROM cte; ÂÆö‰πâ‰∏Ä‰∏™CTEÔºåËøô‰∏™CTE ÊúÄÁªàÁöÑÁªìÊûúÈõÜÂ∞±ÊòØÊàë‰ª¨ÊÉ≥Ë¶ÅÁöÑ ‚ÄùÈÄíÂΩíÂæóÂà∞ÁöÑÊ†ëÁªìÊûÑ‚ÄùÔºåRECURSIVE‰ª£Ë°®ÂΩìÂâç CTE ÊòØÈÄíÂΩíÁöÑ Á¨¨‰∏Ä‰∏™SELECT ‰∏∫ ‚ÄúÂàùÂßãÁªìÊûúÈõÜ‚Äù Á¨¨‰∫å‰∏™SELECT ‰∏∫ÈÄíÂΩíÈÉ®ÂàÜÔºåÂà©Áî® ‚ÄúÂàùÂßãÁªìÊûúÈõÜ/‰∏ä‰∏ÄÊ¨°ÈÄíÂΩíËøîÂõûÁöÑÁªìÊûúÈõÜ‚Äù ËøõË°åÊü•ËØ¢ÂæóÂà∞ ‚ÄúÊñ∞ÁöÑÁªìÊûúÈõÜ‚Äù Áõ¥Âà∞ÈÄíÂΩíÈÉ®ÂàÜÁªìÊûúÈõÜËøîÂõû‰∏∫nullÔºåÊü•ËØ¢ÁªìÊùü ÊúÄÁªàUNION ALL ‰ºöÂ∞Ü‰∏äËø∞Ê≠•È™§‰∏≠ÁöÑÊâÄÊúâÁªìÊûúÈõÜÂêàÂπ∂ÔºàUNION DISTINCT ‰ºöËøõË°åÂéªÈáçÔºâÔºåÂÜçÈÄöËøá SELECT * FROM cte; ÊãøÂà∞ÊâÄÊúâÁöÑÁªìÊûúÈõÜ ÈÄíÂΩíÈÉ®ÂàÜ‰∏çËÉΩÂåÖÊã¨Ôºö ËÅöÂêàÂáΩÊï∞‰æãÂ¶Ç SUM() GROUP BY ORDER BY LIMIT DISTINCT ‰∏äÈù¢ÁöÑËÆ≤Ëß£ÂèØËÉΩÊúâÁÇπÊäΩË±°ÔºåÈÄöËøá‰æãÂ≠êÊÖ¢ÊÖ¢Êù•ÁêÜËß£12345678910111213141516171819WITH RECURSIVE cte (n) AS -- ËøôÈáåÂÆö‰πâÁöÑnÁõ∏ÂΩì‰∫éÁªìÊûúÈõÜÁöÑÂàóÂêçÔºå‰πüÂèØÂú®‰∏ãÈù¢Êü•ËØ¢‰∏≠ÂÆö‰πâ( SELECT 1 UNION ALL SELECT n + 1 FROM cte WHERE n &lt; 5)SELECT * FROM cte;-- result+------+| n |+------+| 1 || 2 || 3 || 4 || 5 |+------+ ÂàùÂßãÁªìÊûúÈõÜ‰∏∫ n =1 ËøôÊó∂ÂÄôÁúãÈÄíÂΩíÈÉ®ÂàÜÔºåÁ¨¨‰∏ÄÊ¨°ÊâßË°å CTEÁªìÊûúÈõÜÂç≥ÊòØ n =1ÔºåÊù°‰ª∂ÂèëÁé∞Âπ∂‰∏çÊª°Ë∂≥ n &lt; 5ÔºåËøîÂõû n + 1 Á¨¨‰∫åÊ¨°ÊâßË°åÈÄíÂΩíÈÉ®ÂàÜÔºåCTEÁªìÊûúÈõÜ‰∏∫ n = 2ÔºåÈÄíÂΩí‚Ä¶ Áõ¥Ëá≥Êù°‰ª∂‰∏çÊª°Ë∂≥ ÊúÄÂêéÂêàÂπ∂ÁªìÊûúÈõÜ EXAMPLEÊúÄÂêéÊù•Áúã‰∏Ä‰∏™Ê†ëÁªìÊûÑÁöÑ‰æãÂ≠ê123456CREATE TABLE `c_tree` ( `id` int(11) NOT NULL AUTO_INCREMENT, `cname` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL, `parent_id` int(11) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci; 1234567891011121314151617mysql&gt; select * from c_tree;+----+---------+-----------+| id | cname | parent_id |+----+---------+-----------+| 1 | 1 | 0 || 2 | 2 | 0 || 3 | 3 | 0 || 4 | 1-1 | 1 || 5 | 1-2 | 1 || 6 | 2-1 | 2 || 7 | 2-2 | 2 || 8 | 3-1 | 3 || 9 | 3-1-1 | 8 || 10 | 3-1-2 | 8 || 11 | 3-1-1-1 | 9 || 12 | 3-2 | 3 |+----+---------+-----------+ 1234567891011121314151617mysql&gt; WITH RECURSIVE tree_cte as( select * from c_tree where parent_id = 3 UNION ALL select t.* from c_tree t inner join tree_cte tcte on t.parent_id = tcte.id)SELECT * FROM tree_cte;+----+---------+-----------+| id | cname | parent_id |+----+---------+-----------+| 8 | 3-1 | 3 || 12 | 3-2 | 3 || 9 | 3-1-1 | 8 || 10 | 3-1-2 | 8 || 11 | 3-1-1-1 | 9 |+----+---------+-----------+ ÂàùÂßãÁªìÊûúÈõÜR0 = select * from c_tree where parent_id = 3 ÈÄíÂΩíÈÉ®ÂàÜÔºåÁ¨¨‰∏ÄÊ¨° R0 ‰∏é c_tree inner join ÂæóÂà∞ R1 R1 ÂÜç‰∏é c_tree inner join ÂæóÂà∞ R2 ‚Ä¶ ÂêàÂπ∂ÊâÄÊúâÁªìÊûúÈõÜ R0 + ‚Ä¶ + Ri Êõ¥Â§ö‰ø°ÊÅØhttps://dev.mysql.com/doc/refman/8.0/en/with.html]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RedissonÊ∫êÁ†ÅËß£ÊûêÔºåÂ¶Ç‰ΩïÂà©Áî®RedisÂÆûÁé∞ÂàÜÂ∏ÉÂºèÂèØÈáçÂÖ•ÈîÅ]]></title>
    <url>%2Fpost%2Fd5899455.html</url>
    <content type="text"><![CDATA[ÊúÄÂºÄÂßã‰ΩøÁî®Redisson ÁöÑapiÁöÑÊó∂ÂÄôÔºåÊàëËßâÂæóÂìáÔºåËøô‰∏™api Â§™ÁâõÈÄº‰∫ÜÂ±ÖÁÑ∂ÊúâÂàÜÂ∏ÉÂºèÁöÑÂèØÈáçÂÖ•ÈîÅÔºåÊ≠£Â•ΩÊúÄËøëÁ†îÁ©∂‰∫Ü‰∏ãRedissonÁöÑÊ∫êÁ†ÅÔºåÂíåÂ§ßÂÆ∂ÂàÜ‰∫´‰∏Ä‰∏ã ÂâçË®ÄÈ¶ñÂÖàÊàë‰ª¨ÂÖàÂõûÈ°æ‰∏Ä‰∏ã Java ‰∏≠ÁöÑ ReentrantLock ÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑÔºü ËøôÈáåÊàëÂÖàÁÆÄÂçï‰ªãÁªç‰∏Ä‰∏ãReentrantLock ÂÆûÁé∞ÁöÑÊÄùË∑Ø ÈîÅÊ†áËØÜÔºöÈÄöËøáAQSÁöÑstateÂèòÈáè‰Ωú‰∏∫ÈîÅÊ†áËØÜÔºåÂà©Áî®JavaÁöÑCAS‰øùËØÅÂ§öÁ∫øÁ®ãÁ´û‰∫âÈîÅÊó∂ÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò ÈòüÂàóÔºöÊú™Á´û‰∫âÂà∞ÈîÅÁöÑÁ∫øÁ®ãËøõÂÖ•AQSÁöÑÈòüÂàóÂπ∂ÊåÇËµ∑ÔºåÁ≠âÂæÖËß£ÈîÅÊó∂Ë¢´Âî§ÈÜíÔºàÊàñËÄÖË∂ÖÊó∂Ôºâ Â¶Ç‰ΩïËÆæËÆ°ÂàÜÂ∏ÉÂºèÂèØÈáçÂÖ•ÈîÅÈ¶ñÂÖàÈîÅÊ†áËØÜÔºåËøô‰∏™Âú®Redis‰∏≠ÂæàÂÆπÊòìÂÆûÁé∞ÔºåÂèØ‰ª•Áî®lock name ‰Ωú‰∏∫keyÔºåÂΩìÂâçÁ∫øÁ®ãÁîüÊàê‰∏Ä‰∏™uuidÔºå‰Ωú‰∏∫valueÔºåÂä†‰∏äRedis ÂçïÁ∫øÁ®ãÊ®°ÂûãÔºåÂÆûÁé∞Á∫øÁ®ãÂÆâÂÖ®ÁöÑÈîÅÁ´û‰∫â ËøôÁßçÊñπÂºèÂú®‰πãÂâçÁöÑÂçöÂÆ¢Èáå‰πüÊèêÂà∞ËøáÔºåÂèØ‰ª•ÂèÇËÄÉ‰∏ã RedisÂàÜÂ∏ÉÂºèÈîÅÁöÑÊ≠£Á°ÆÂÆûÁé∞ÊñπÂºè ‰ΩÜÊòØÂ¶Ç‰ΩïÂü∫‰∫éRedis ÂÅö‰∏Ä‰∏™ÈòüÂàóÔºåÂÉèJavaÈÇ£Ê†∑ÂèØ‰ª•ÊåÇËµ∑Âî§ÈÜíÁ∫øÁ®ãÂë¢ÔºüËøôÁÇπÊàëÂú®ÁúãÊ∫êÁ†Å‰πãÂâç‰∏ÄÁõ¥Ê≤°ÊúâÊÉ≥Âà∞‚Ä¶ ÈÇ£‰πàRedisson ÊòØÂ¶Ç‰ΩïÂÅöÁöÑÂë¢Ôºü Á≠îÊ°àÔºöÂà©Áî®RedisÁöÑÂèëÂ∏ÉËÆ¢ÈòÖÔºåÂä†‰∏äJavaÁöÑSemaphoreÔºà‰ø°Âè∑ÈáèÔºå‰∏ç‰∫ÜËß£SemaphoreÁöÑÂ∞è‰ºô‰º¥ÂèØ‰ª•Google‰∏Ä‰∏ãÔºâ Redisson ÂàÜÂ∏ÉÂºèÈîÅÂÆûÁé∞ÊÄùË∑ØÈîÅÊ†áËØÜÔºöHash Êï∞ÊçÆÁªìÊûÑÔºåkey ‰∏∫ÈîÅÁöÑÂêçÂ≠óÔºåfiled ÂΩìÂâçÁ´û‰∫âÈîÅÊàêÂäüÁ∫øÁ®ãÁöÑ‚ÄúÂîØ‰∏ÄÊ†áËØÜ‚ÄùÔºåvalue ÈáçÂÖ•Ê¨°Êï∞ ÈòüÂàóÔºöÊâÄÊúâÁ´û‰∫âÈîÅÂ§±Ë¥•ÁöÑÁ∫øÁ®ãÔºå‰ºöËÆ¢ÈòÖÂΩìÂâçÈîÅÁöÑËß£ÈîÅ‰∫ã‰ª∂ÔºåÂà©Áî® Semaphore ÂÆûÁé∞Á∫øÁ®ãÁöÑÊåÇËµ∑ÂíåÂî§ÈÜí Ê∫êÁ†ÅÂàÜÊûêÊàë‰ª¨Êù•Áúã‰∏Ä‰∏ãtryLockÊñπÊ≥ïÁöÑÊ∫êÁ†Å 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879 public boolean tryLock(long waitTime, long leaseTime, TimeUnit unit) throws InterruptedException &#123; long time = unit.toMillis(waitTime); long current = System.currentTimeMillis(); long threadId = Thread.currentThread().getId(); // Â∞ùËØïËé∑ÂèñÈîÅÔºåËøîÂõûnull ‰ª£Ë°®Ëé∑ÂèñÈîÅÊàêÂäüÔºåÂΩìËé∑ÂèñÈîÅÂ§±Ë¥•Êó∂ËøîÂõûÂΩìÂâçÈîÅÁöÑÈáäÊîæÊó∂Èó¥ Long ttl = tryAcquire(leaseTime, unit, threadId); // lock acquired if (ttl == null) &#123; return true; &#125; // Â¶ÇÊûúÊ≠§Êó∂Â∑≤ÁªèË∂ÖËøáÁ≠âÂæÖÊó∂Èó¥ÂàôËé∑ÂèñÈîÅÂ§±Ë¥• time -= System.currentTimeMillis() - current; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; current = System.currentTimeMillis(); // ËÆ¢ÈòÖËß£ÈîÅ‰∫ã‰ª∂ RFuture&lt;RedissonLockEntry&gt; subscribeFuture = subscribe(threadId); // Á≠âÂæÖËÆ¢ÈòÖÊàêÂäüÔºåÊàêÂäüÂêéÂî§ÈÜíÂΩìÂâçÁ∫øÁ®ã if (!await(subscribeFuture, time, TimeUnit.MILLISECONDS)) &#123; if (!subscribeFuture.cancel(false)) &#123; subscribeFuture.onComplete((res, e) -&gt; &#123; if (e == null) &#123; unsubscribe(subscribeFuture, threadId); &#125; &#125;); &#125; acquireFailed(threadId); return false; &#125; try &#123; // ÂÜçÊ¨°Âà§Êñ≠‰∏Ä‰∏ãÊòØÂê¶Ë∂ÖÊó∂ time -= System.currentTimeMillis() - current; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; while (true) &#123; long currentTime = System.currentTimeMillis(); // Â∞ùËØïËé∑ÂèñÈîÅ ttl = tryAcquire(leaseTime, unit, threadId); // lock acquired if (ttl == null) &#123; return true; &#125; time -= System.currentTimeMillis() - currentTime; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; // waiting for message currentTime = System.currentTimeMillis(); if (ttl &gt;= 0 &amp;&amp; ttl &lt; time) &#123; // Á≠âÂæÖËß£ÈîÅÊ∂àÊÅØÔºåÊ≠§Â§ÑÂà©Áî®SemaphoreÔºåÈîÅÊú™ÈáäÊîæÊó∂Ôºåpermits=0ÔºåÁ∫øÁ®ãÂ§Ñ‰∫éÊåÇËµ∑Áä∂ÊÄÅ // ÂΩìÂèëÂ∏ÉËß£ÈîÅÊ∂àÊÅØÊó∂ÔºåÂΩìÂâçÁöÑSemaphoreÂØπË±°ÁöÑrelease() permits=1 // ÊâÄÊúâÁöÑÂÆ¢Êà∑Á´ØÈÉΩ‰ºöÊúâ‰∏Ä‰∏™Á∫øÁ®ãË¢´Âî§ÈÜíÔºåÂéªÂ∞ùËØïÁ´û‰∫âÈîÅ getEntry(threadId).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS); &#125; else &#123; getEntry(threadId).getLatch().tryAcquire(time, TimeUnit.MILLISECONDS); &#125; time -= System.currentTimeMillis() - currentTime; if (time &lt;= 0) &#123; acquireFailed(threadId); return false; &#125; &#125; &#125; finally &#123; unsubscribe(subscribeFuture, threadId); &#125;// return get(tryLockAsync(waitTime, leaseTime, unit)); &#125; tryAcquire(leaseTime, unit, threadId); Ëøô‰∏™ÊñπÊ≥ïÊàë‰ª¨‰∏ãÈù¢‰ºöÂàÜÊûêÔºåÁé∞Âú®Êàë‰ª¨Âè™ÈúÄË¶ÅÁü•ÈÅìËøô‰∏™ÊñπÊ≥ïÊòØÁî®Êù•Ëé∑ÂèñÈîÅÂ∞±ÂèØ‰ª•‰∫Ü Ëøô‰∏™Êó∂ÂÄôÊàë‰ª¨Â∑≤ÁªèÂèØ‰ª•ÁêÜÊ∏ÖRedissonÂèØÈáçÂÖ•ÈîÅÁöÑÊÄùË∑Ø‰∫Ü Ëé∑ÂèñÈîÅ Â¶ÇÊûúËé∑ÂèñÈîÅÂ§±Ë¥•ÔºåËÆ¢ÈòÖËß£ÈîÅ‰∫ã‰ª∂ ‰πãÂêéÊòØ‰∏Ä‰∏™Êó†ÈôêÂæ™ÁéØ12345678910while(true) &#123; // Â∞ùËØïËé∑ÂèñÈîÅ // Âà§Êñ≠ÊòØÂê¶Ë∂ÖÊó∂ // Á≠âÂæÖËß£ÈîÅÊ∂àÊÅØÈáäÊîæ‰ø°Âè∑Èáè //ÔºàÊ≠§Êó∂ÊØè‰∏™JavaÂÆ¢Êà∑Á´ØÈÉΩÂèØËÉΩ‰ºöÊúâÂ§ö‰∏™Á∫øÁ®ãË¢´ÊåÇËµ∑Ôºå‰ΩÜÊòØÂè™Êúâ‰∏Ä‰∏™Á∫øÁ®ã‰ºöË¢´Âî§ÈÜíÔºâ // Âà§Êñ≠ÊòØÂê¶Ë∂ÖÊó∂&#125; Âà©Áî®‰ø°Âè∑ÈáèÔºåÂêàÁêÜÊéßÂà∂Á∫øÁ®ãÂØπÈîÅÁöÑÁ´û‰∫âÔºåÂêàÁêÜÂà©Áî®Á≥ªÁªüËµÑÊ∫êÔºåÂèØ‰ª•ËØ¥ÂÅöÁöÑÁÅ∞Â∏∏ÁöÑÂ•àÊñØ‰∫Ü ÈúÄË¶ÅÊ≥®ÊÑèÔºö!await(subscribeFuture, time, TimeUnit.MILLISECONDS) ÔºåËøôÈáåÂæàÂ§öÂçöÂÆ¢ÈÉΩËß£ÈáäÈîô‰∫ÜÔºåËøôÈáåÂπ∂‰∏çÊòØÁ≠âÂæÖÂèëÂ∏ÉËß£ÈîÅÊ∂àÊÅØÔºåÂè™Ë¶ÅËÆ¢ÈòÖ‰∫ã‰ª∂ÊàêÂäüÂêéÔºåÂ∞±‰ºöÂæÄ‰∏ãÊâßË°åÔºåÁúüÊ≠£Á≠âÂæÖËß£ÈîÅÊ∂àÊÅØÁöÑÊòØ getEntry(threadId).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS); ËøôÈáå‰Ω†ÂèØËÉΩ‰∏ç‰ø°Ôºå‰∏∫‰ªÄ‰πàÊàëËØ¥ÁöÑÂ∞±ÂØπÂïäÔºådebug‰∏Ä‰∏ã‰Ω†Â∞±Áü•ÈÅì tryLockInnerAsynctryAcquire ÂÜÖÈÉ®‰æùÈù† tryLockInnerAsync Êù•ÂÆûÁé∞Ëé∑ÂèñÈîÅÁöÑÈÄªËæëÔºåÊàë‰ª¨Êù•Áúã‰∏ãÊ∫êÁ†Å123456789101112131415161718192021222324252627&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) &#123; internalLockLeaseTime = unit.toMillis(leaseTime); return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, command, // ÊòØÂê¶Â≠òÂú®ÈîÅ "if (redis.call('exists', KEYS[1]) == 0) then " + // ‰∏çÂ≠òÂú®ÂàôÂàõÂª∫ "redis.call('hset', KEYS[1], ARGV[2], 1); " + // ËÆæÁΩÆËøáÊúüÊó∂Èó¥ "redis.call('pexpire', KEYS[1], ARGV[1]); " + // Á´û‰∫âÈîÅÊàêÂäü ËøîÂõûnull "return nil; " + "end; " + // Â¶ÇÊûúÈîÅÂ∑≤ÁªèË¢´ÂΩìÂâçÁ∫øÁ®ãËé∑Âèñ "if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then " + // ÈáçÂÖ•Ê¨°Êï∞Âä†1 "redis.call('hincrby', KEYS[1], ARGV[2], 1); " + "redis.call('pexpire', KEYS[1], ARGV[1]); " + "return nil; " + "end; " + // ÈîÅË¢´ÂÖ∂‰ªñÁ∫øÁ®ãËé∑ÂèñÔºåËøîÂõûÈîÅÁöÑËøáÊúüÊó∂Èó¥ "return redis.call('pttl', KEYS[1]);", // ‰∏ãÈù¢‰∏â‰∏™ÂèÇÊï∞ÂàÜÂà´‰∏∫ KEYS[1], ARGV[1], ARGV[2] // Âç≥ÈîÅÁöÑnameÔºåÈîÅÈáäÊîæÊó∂Èó¥ÔºåÂΩìÂâçÁ∫øÁ®ãÂîØ‰∏ÄÊ†áËØÜ Collections.&lt;Object&gt;singletonList(getName()), internalLockLeaseTime, getLockName(threadId));&#125; tryLockInnerAsync ‰∏≠Âà©Áî®luaËÑöÊú¨ Âíå Redis ÂçïÁ∫øÁ®ãÁöÑÁâπÁÇπÊù•ÂÆûÁé∞ÈîÅÁöÑÁ´û‰∫â ËøôÈáåÂèØ‰ª•ÁúãÂà∞ÈîÅÁöÑÁªìÊûÑÔºåÂíåÊàë‰ª¨‰∏äÊñáÊâÄËØ¥ÁöÑ‰∏ÄÊ†∑ÔºåHash Êï∞ÊçÆÁªìÊûÑÔºåkey ‰∏∫ÈîÅÁöÑnameÔºåfiled ÂΩìÂâçÁ´û‰∫âÈîÅÊàêÂäüÁ∫øÁ®ãÁöÑ‚ÄùÂîØ‰∏ÄÊ†áËØÜ‚ÄùÔºåvalue ÈáçÂÖ•Ê¨°Êï∞ unlockInnerAsyncÊé•‰∏ãÊù•Êàë‰ª¨ÂÜçÊù•ÁúãËß£ÈîÅÁöÑÊ†∏ÂøÉ‰ª£Á†Å123456789101112131415161718192021222324252627282930protected RFuture&lt;Boolean&gt; unlockInnerAsync(long threadId) &#123; return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN, // Áî®ÈîÅÁöÑnameÂíåÁ∫øÁ®ãÂîØ‰∏ÄÊ†áËØÜÂéªÂà§Êñ≠ÊòØÂê¶Â≠òÂú®ËøôÊ†∑ÁöÑÈîÆÂÄºÂØπ // Ëß£ÈìÉËøòÈ°ªÁ≥ªÈìÉ‰∫∫Ôºå‰∏çÂ≠òÂú®ÂàôÊó†ÊùÉËß£ÈîÅÔºåËøîÂõûnull "if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then " + "return nil;" + "end; " + // Ëß£ÈîÅÈÄªËæë // ÂÜ≤ÂÖ•Ê¨°Êï∞-1 "local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); " + // Â¶ÇÊûúÂ§ß‰∫é0 ‰ª£Ë°®ÂΩìÂâçÁ∫øÁ®ãÈáçÂÖ•ÈîÅÂ§öÊ¨°Êó†Ê≥ïËß£ÈîÅÔºåÊõ¥Êñ∞ÈîÅÁöÑÊúâÊïàÊó∂Èó¥ "if (counter &gt; 0) then " + "redis.call('pexpire', KEYS[1], ARGV[2]); " + "return 0; " + "else " + // Ëß£ÈîÅÔºåÂà†Èô§key "redis.call('del', KEYS[1]); " + // ÂèëÂ∏ÉËß£ÈîÅÊ∂àÊÅØ "redis.call('publish', KEYS[2], ARGV[1]); " + "return 1; "+ "end; " + "return nil;", // KEYS[1]ÔºåKEYS[2] // ÈîÅÁöÑnameÔºåÂèëÂ∏ÉËÆ¢ÈòÖÁöÑChannel Arrays.&lt;Object&gt;asList(getName(), getChannelName()), // ARGV[1] ~ ARGV[3] // Ëß£ÈîÅÊ∂àÊÅØÔºåÈáäÊîæÊó∂Èó¥ÔºåÂΩìÂâçÁ∫øÁ®ãÂîØ‰∏ÄÊ†áËØÜ LockPubSub.UNLOCK_MESSAGE, internalLockLeaseTime, getLockName(threadId));&#125; ÂèëÂ∏ÉËß£ÈîÅÊ∂àÊÅØÂêéÔºå‰ºöË∞ÉÁî®Âà∞LockPubSub ÁöÑ onMessageÔºåÈáäÊîæ‰ø°Âè∑ÈáèÔºåÂî§ÈÜíÁ≠âÂæÖÈîÅÁöÑÁ∫øÁ®ã1234567891011121314151617181920212223242526272829303132333435363738public class LockPubSub extends PublishSubscribe&lt;RedissonLockEntry&gt; &#123; public static final Long UNLOCK_MESSAGE = 0L; public static final Long READ_UNLOCK_MESSAGE = 1L; public LockPubSub(PublishSubscribeService service) &#123; super(service); &#125; @Override protected RedissonLockEntry createEntry(RPromise&lt;RedissonLockEntry&gt; newPromise) &#123; return new RedissonLockEntry(newPromise); &#125; @Override protected void onMessage(RedissonLockEntry value, Long message) &#123; if (message.equals(UNLOCK_MESSAGE)) &#123; Runnable runnableToExecute = value.getListeners().poll(); if (runnableToExecute != null) &#123; runnableToExecute.run(); &#125; // ÈáäÊîæ‰ø°Âè∑Èáè value.getLatch().release(); &#125; else if (message.equals(READ_UNLOCK_MESSAGE)) &#123; while (true) &#123; Runnable runnableToExecute = value.getListeners().poll(); if (runnableToExecute == null) &#123; break; &#125; runnableToExecute.run(); &#125; value.getLatch().release(value.getLatch().getQueueLength()); &#125; &#125;&#125; ÂèÇËÄÉ ÊÖ¢Ë∞à Redis ÂÆûÁé∞ÂàÜÂ∏ÉÂºèÈîÅ ‰ª•Âèä Redisson Ê∫êÁ†ÅËß£Êûê https://www.programcreek.com/java-api-examples/?code=rollenholt-SourceReading/redisson/redisson-master/src/main/java/org/redisson/RedissonLock.java Ê¨¢ËøéÁÇπËµû„ÄÅËΩ¨Âèë„ÄÇ‰Ω†ÁöÑÊîØÊåÅÂ∞±ÊòØÂØπÊàëÊúÄÂ§ßÁöÑÂ∏ÆÂä©]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>ÈîÅ</tag>
        <tag>Java</tag>
        <tag>Â§öÁ∫øÁ®ã</tag>
        <tag>Ê∫êÁ†Å</tag>
        <tag>Redisson</tag>
        <tag>ReentrantLock</tag>
        <tag>ÂàÜÂ∏ÉÂºè</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL‰ºòÂåñÂÆûÊàò--Á¥¢ÂºïÁØá]]></title>
    <url>%2Fpost%2F1e0091db.html</url>
    <content type="text"><![CDATA[ÂÖ≥‰∫éSQL‰ºòÂåñÔºåËøô‰∏™ÈóÆÈ¢òÔºåÁõ∏‰ø°Â§ßÂÆ∂ËøáÂ§öËøáÂ∞ëÈÉΩÊúâËøá‰∏Ä‰∫õ‰∫ÜËß£„ÄÇÊúÄËøëÊàë‰πüÂú®Á†îÁ©∂SQL‰ºòÂåñÊñπÈù¢ÁöÑ‰∏úË•øÔºåÂàÜ‰∫´‰∏Ä‰∫õÁªèÈ™å„ÄÇ È¶ñÂÖàÁÆÄÂçï‰ªãÁªç‰∏ãÁ¥¢ÂºïÔºå‚ÄúÁ¥¢Âºï‚Äù ÊòØSQL‰ºòÂåñ‰∏≠ÂæàÈáçË¶ÅÁöÑ‰∏ÄÈÉ®ÂàÜÔºà‰ΩÜÊòØÁ¥¢ÂºïÂπ∂‰∏çÊòØ‰ºòÂåñÁöÑÂîØ‰∏ÄÈÄâÈ°πÔºâ Á¥¢ÂºïÂéüÁêÜÁÆÄËø∞Â¶Ç‰ΩïÁêÜËß£Á¥¢ÂºïÔºüÁ¥¢ÂºïÂÖ∂ÂÆûÂ∞±ÊòØ‰∏ÄÁßçÊï∞ÊçÆÁªìÊûÑÔºåÁî®‰∫éÂø´ÈÄüÂÆö‰ΩçÂíåËÆøÈóÆÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊï∞ÊçÆ„ÄÇ ÈÄöÂ∏∏Êù•ËØ¥Á¥¢Âºï‰ΩøÁî®ÁöÑÊï∞ÊçÆÁªìÊûÑÊòØ B-Tree / B+Tree„ÄÇ‰ª•B-Tree‰∏∫‰æãÔºåÂÅáËÆæÊØè‰∏™ËäÇÁÇπÂ≠òÂÇ®100‰∏™KeyÔºå‰∏âÂ±ÇÁöÑB-Tree ÂèØÂ≠òÂÇ®‰∏ÄÁôæ‰∏áÊï∞ÊçÆÔºåÂ¶ÇÊûúÂ∞ÜÊ†πËäÇÁÇπÂ≠òÂÖ•ÂÜÖÂ≠ò‰∏≠ÁöÑËØùÔºåÂè™ÈúÄË¶ÅËØªÂèñ‰∏§Ê¨°Á£ÅÁõòÂ∞±ÂèØ‰ª•‰ªé100‰∏áÊï∞ÊçÆ‰∏≠ÊâæÂà∞ÊåáÂÆöÊï∞ÊçÆ ÂÖ≥‰∫éB-Tree Êé®ËçêÈòÖËØªËøôÁØá https://www.geeksforgeeks.org/introduction-of-b-tree-2/ ÂåÖÂê´B-TreeÁöÑÊü•ËØ¢ÔºåÊñ∞Â¢ûÔºåÂà†Èô§Êìç‰ΩúÂ¶Ç‰ΩïÂÆûÁé∞ MySQL ÊâßË°åËÆ°ÂàíSQL‰ºòÂåñ‰∏≠Êü•ÁúãÊâßË°åËÆ°ÂàíÊòØÂøÖ‰∏çÂèØÂ∞ëÁöÑ‰∏ÄÈ°πÔºåÈÄöËøá explain ÂÖ≥ÈîÆÂ≠óÂèØ‰ª•Êü•ÁúãMySQL‰∏≠ÁöÑÊâßË°åËÆ°Âàí Ê≥®Ôºö\G Âê´‰πâÊòØÁ∫µÂêëÊòæÁ§∫ÁªìÊûú Â¶ÇÊûú‰πãÂâçÊ≤°Êúâ‰∫ÜËß£ÁöÑ EXPLAIN ÁöÑÂêåÂ≠¶ÔºåÁúãÂà∞Ëøô‰∏™ÂàóË°®ËÇØÂÆöÊòØ‰∏ÄËÑ∏ÊáµÈÄº„ÄÇÊ≤°ÂÖ≥Á≥ªÊàë‰ª¨ÂÖàÊù•ÊåëÂá†‰∏™ÈáçË¶ÅÁöÑÂ±ûÊÄßËÆ§ËØÜ‰∏Ä‰∏ã„ÄÇ typeÔºöALL ‰ª£Ë°®ÂÖ®Ë°®Êâ´Êèè keyÔºö‰ª£Ë°®‰ΩøÁî®ÁöÑÁ¥¢ÂºïÔºåNULL ‰ª£Ë°®Ê≤°Êúâ‰ΩøÁî®Á¥¢Âºï rowsÔºöÊâ´ÊèèË°åÊï∞ ÂÖ≥‰∫éexplain ÂÜçÊâ©Â±ï‰∏Ä‰∏ãÔºåÂÖàÊâßË°å explain extended ...; ÔºåÂÜçÊâßË°å SHOW WARNINGS ÂèØ‰ª•ÁúãÂà∞MySQL‰ºòÂåñÂô®ÂØπÊàë‰ª¨ÁöÑSQLÂÅö‰∫Ü‰ªÄ‰πà‰ºòÂåñ„ÄÇÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ Âà©Áî®Á¥¢ÂºïÊù•‰ºòÂåñSQL ‰ΩøÁî®Á¥¢ÂºïÁöÑ‰ºòÁÇπÔºöÂáèÂ∞ëÊúçÂä°Âô®Êâ´ÊèèÁöÑÊï∞ÊçÆÈáè„ÄÅÈÅøÂÖçÊéíÂ∫èÂíå‰∏¥Êó∂Ë°®„ÄÅÂ∞ÜÈöèÊú∫I/OÂèò‰∏∫È°∫Â∫èI/O ÈÄöËøá‰∏ãÂõæÔºåÊàë‰ª¨ÂèØ‰ª•ÁúãÂà∞ÔºåÊ∑ªÂä†‰∫ÜÁ¥¢Âºï‰πãÂêéÊâ´ÊèèË°åÊï∞‰ªé‰∏âÂçÅ‰∏áË°åÈôçÂà∞‰∫Ü1ÔºåÊÄßËÉΩÊèêÂçáÂèØÊÉ≥ËÄåÁü• Áîü‰∫ßÁéØÂ¢ÉË¶ÅÊ≥®ÊÑèÔºåÂàõÂª∫Á¥¢ÂºïÊòØ‰∏Ä‰∏™ÈùûÂ∏∏ËÄóÊó∂ÁöÑÊìç‰ΩúÔºåÂπ∂‰∏î‰ºöÈòªÂ°ûÂÖ∂‰ªñÊìç‰Ωú„ÄÇ Áîü‰∫ßÁéØÂ¢ÉÊ∑ªÂä†Á¥¢ÂºïÊúâÊ≤°Êúâ‰ªÄ‰πàÂÆåÁæéÊñπÊ°àÔºüÊúâÁöÑÔºåÂ¶ÇÊûú‰Ω†ÁöÑMySQL‰ΩøÁî®‰∏ª‰ªéÁ≠ñÁï•ÁöÑÊó∂ÂÄôÔºåÂèØ‰ª•ÂÉèNginx‰∏çÂÅúÊú∫ÂçáÁ∫ßwebÊúçÂä°ÈÇ£Ê†∑ÔºåÂÖàÁßªÈô§‰∏Ä‰∏™ËäÇÁÇπ‰∏∫ËØ•ËäÇÁÇπÊâßË°å ALTER TABLE Êìç‰ΩúÔºåÁÑ∂ÂêéÂ∑¥ÊãâÂ∑¥ÊãâÔºåÂõ†‰∏∫ÂÖ∑‰ΩìÊàë‰πüÊ≤°Êìç‰ΩúËøáÂ∞±‰∏çÁªÜËØ¥‰∫ÜÔºåÊÑüÂÖ¥Ë∂£Â§ßÂÆ∂ÂèØ‰ª•Google‰∏Ä‰∏ãÔºåÂä®ÊâãÂ∞ùËØï‰∏Ä‰∏ã„ÄÇÂ¶ÇÊûúÊòØÂçïÊú∫ÈÉ®ÁΩ≤ÁöÑËØùÔºåÂè™ËÉΩÁî®Êà∑Â∞ëÁöÑÊó∂ÂÄôÂú®ÊâßË°åËøôÁßçÊìç‰Ωú‰∫Ü ‰ΩøÁî®Á¥¢ÂºïËøûÊé•Ë°®Á¥¢Âºï‰πüÂèØ‰ª•ÊèêÈ´òË°®ËøûÊé•ÁöÑÊÄßËÉΩÔºå‰∏ãÈù¢ÊòØ‰∏™‰æãÂ≠êÔºåÁî®Êà∑Ë°®Â∑¶ËøûËÆ¢ÂçïË°®ÔºåÂØπuser_id Ê∑ªÂä†Á¥¢ÂºïÁöÑÂâçÂêéÂØπÊØî like‰ºòÂåñ ÈÄöËøá‰∏äËø∞‰æãÂ≠êÔºåÊàë‰ª¨ÂèØ‰ª•ÁúãÂá∫ÔºåÂ¶ÇÊûúÊ®°Á≥äÊü•ËØ¢Êó∂‰ª•%ÂºÄÂ§¥ÁöÑËØùÔºåMySQLÊó†Ê≥ï‰ΩøÁî®Á¥¢ÂºïÔºå‰ΩÜÊòØÈÄöÂ∏∏Êù•ËØ¥Ê®°Á≥äÊü•ËØ¢Êó∂Êàë‰ª¨ÁöÑÂåπÈÖçÊñπÂºèÈÉΩ‰ºöÊòØ %xxx%ÔºåÈÇ£‰πàÂ¶Ç‰Ωï‰ºòÂåñÂë¢Ôºü ËøôÈáåÂèØ‰ª•ÈÄöËøáÂ≠ò‚ÄúÂèçÂÄº‚ÄùÁöÑÊñπÂºèÂ∑ßÂ¶ôÁöÑËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºå‰æãÂ¶ÇÊàëÁé∞Âú®Âú®Êï∞ÊçÆÂ∫ìÂä†‰∏ÄÂàó reverse_order_no Â≠òÂÇ®ËÆ¢ÂçïÂè∑ÁöÑÂèçÂÄºÔºàÂπ∂Ê∑ªÂä†Á¥¢ÂºïÔºâÔºåÂåπÈÖçÁöÑÊó∂ÂÄôÂÜçÈÄöËøá REVERSE(‚Äò%910‚Äô) ÂáΩÊï∞Â∞ÜÂèÇÊï∞ÂèñÂèç„ÄÇ ËøôÈáå‰πüÂèØ‰ª•‰ΩøÁî® orÔºåÂ¶Ç‰∏ãÂõæÔºåÊü•ÁúãÊâßË°åËÆ°Âàí‰ºöÂèëÁé∞Extra Â±ûÊÄßËøîÂõû &quot;Using sort_union(order_no,reverse_order_no); Using where&quot; ËøôÈáå‰ª£Ë°®MySQLÂèëÁîü‰∫ÜÁ¥¢ÂºïÂêàÂπ∂ÔºåÂêéÊñáÊàë‰ª¨‰ºöËÆ≤Âà∞ ÊéíÂ∫è‰ª•ÂèäÂ§öÂàóÁ¥¢ÂºïÊéíÂ∫èÈúÄË¶ÅÂä†Á¥¢ÂºïÔºÅÁõ∏‰ø°Â§ßÂÆ∂ÂèØËÉΩÁü•ÈÅìËøô‰∏™ÈÅìÁêÜÔºå‰ΩÜÊòØÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºåuser_id Âíå addtime ‰∏§ÂàóÈÉΩÂª∫Á´ã‰∫ÜÁ¥¢ÂºïÔºåÈÇ£‰πà‰∏ãÈù¢ËøôÊù°Êü•ËØ¢ÊéíÂ∫è‰ΩøÁî®Á¥¢Âºï‰∫ÜÂêóÔºü Á≠îÊ°àÊòØÔºöÂπ∂Ê≤°ÊúâÔºÅ‰∏∫‰ªÄ‰πàÔºüÊ≥®ÊÑè Extra ‰∏≠ÁöÑ using filesortÔºå‰ª£Ë°®MySQL ‰ΩøÁî®‰∫ÜÂÜÖÈÉ®Êñá‰ª∂ÊéíÂ∫èÁÆóÊ≥ïÂØπÁªìÊûúÈõÜËøõË°å‰∫ÜÊéíÂ∫è„ÄÇMySQL ÈÄöÂ∏∏Âú®‰∏Ä‰∏™Ë°®‰∏äÂè™ÈÄâÊã©‰∏Ä‰∏™Á¥¢ÂºïÔºàÊúâ‰æãÂ§ñÁöÑÊÉÖÂÜµÔºâÔºåËøôÁßçÊÉÖÂÜµÂ¶ÇÊûúÊàë‰ª¨Â∏åÊúõÊéíÂ∫è‰ΩøÁî®Á¥¢ÂºïÁöÑËØùÔºåÂèØ‰ª•Âª∫Á´ã‰∏Ä‰∏™Â§öÂàóÁ¥¢ÂºïÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ ËÄå‰∏îÂ§öÂàóÁ¥¢ÂºïÊúÄÂ∑¶ËæπÁöÑÂàóÔºåÂèØ‰ª•ÂΩì‰ΩúÂçïÂàóÁ¥¢ÂºïÊù•‰ΩøÁî® MySQL ‰ºòÂåñÂô®ÁâπÊÄßÊàë‰ª¨ÂàöÂàöËØ¥Ëøá MySQL ÈÄöÂ∏∏Âú®‰∏Ä‰∏™Ë°®‰∏äÂè™ÈÄâÊã©‰∏Ä‰∏™Á¥¢ÂºïÔºåÂ¶Ç‰ΩïÁêÜËß£Ôºü‰æãÂ¶ÇÁ¥¢ÂºïAÂíåÁ¥¢ÂºïB ‰∏Ä‰∏™ÈúÄË¶ÅÊâ´ÊèèÂçÅ‰∏áË°åÔºå‰∏Ä‰∏™ÈúÄË¶ÅÊâ´Êèè‰∫î‰∏áË°åÔºåÈÇ£‰πàMySQL‰∏ÄÂÆöÈÄâÊã©ÂºÄÈîÄÊúÄÂ∞èÁöÑÁ¥¢ÂºïÊñπÂºè„ÄÇ Âú®‰∏Ä‰∫õÁâπÊÆäÊÉÖÂÜµ‰∏ãÔºåMySQL ‰ºöÈÄâÊã© Index MergeÔºàÁ¥¢ÂºïÂêàÂπ∂ÔºâÔºåÂç≥Âú®‰∏Ä‰∏™Ë°®‰∏ä‰ΩøÁî®Â§ö‰∏™Á¥¢Âºï UnionÔºö‰∏§‰∏™Âü∫Êï∞ÂæàÈ´òÁöÑÁ¥¢ÂºïÊâßË°åORÊìç‰ΩúÊó∂ Sort-UnionÔºö‰∏é‰∏äËø∞Á±ª‰ººÔºå‰∏ÄÊó¶orÁöÑÂ∑¶Âè≥‰∏§ËæπÂá∫Áé∞ËåÉÂõ¥Êü•ËØ¢Ôºå‰ºö‰ΩøÁî®ËØ•ÁÆóÊ≥ïÔºåÂå∫Âà´ÊòØSort-Union‰ºöËøõË°åÊéíÂ∫è intersectÔºöÈíàÂØπÂîØ‰∏ÄÂÄº‰∏çÂ§öÁöÑÁ¥¢ÂºïÂàóÔºå‰æãÂ¶ÇÂú® is_payÔºà0-Êú™ÊîØ‰ªòÔºå1-ÊîØ‰ªòÔºâÔºåis_sendÔºà0-Êú™ÂèëË¥ßÔºå1-ÂèëË¥ßÔºâ ‰∏§ÂàóÂª∫Á´ãÁ¥¢ÂºïÔºåÊü•ËØ¢Â∑≤ÊîØ‰ªòÂπ∂‰∏îÊú™ÂèëË¥ßÁöÑËÆ¢ÂçïÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ Ê†πÊçÆMySQL 5.7ÂºÄÂèëÊñáÊ°£ÊâÄÁ§∫ÔºåËøòÊúâ‰∏ÄÁßç‰ºö‰ΩøÁî®intersectÔºåInnoDB ‰∏ªÈîÆ‰∏äÁöÑ‰ªª‰ΩïËåÉÂõ¥ÊêúÁ¥¢ ÂÖ≥‰∫éIndex MergeÁöÑÊõ¥Â§ö‰ø°ÊÅØÔºåÂèÇËÄÉMySQLÂºÄÂèëÊñáÊ°£https://dev.mysql.com/doc/refman/5.7/en/index-merge-optimization.html Á¥¢ÂºïÁöÑÂΩ±ÂìçÊ∑ªÂä†Á¥¢ÂºïËôΩÁÑ∂ÂèØ‰ª•ÊèêÂçáÊàë‰ª¨ÁöÑSQLÊÄßËÉΩÔºå‰ΩÜÊòØÈöè‰πãËÄåÊù•‰πü‰ºöÂ∏¶Êù•‰∏ÄÂÆöÁöÑÂºÄÈîÄ Êï∞ÊçÆÊèíÂÖ•ÂíåÊõ¥Êñ∞ÁöÑÊÄßËÉΩÔºåÂõ†‰∏∫ÈúÄË¶ÅÊûÑÂª∫Á¥¢ÂºïÁöÑÂéüÂõ†ÔºåÂú®Êï∞ÊçÆÈáèÂ§ßÁöÑÊó∂ÂÄô‰ºöÊØîËæÉÊòéÊòæÔºå‰∏ãÂõæÊòØ „ÄäEffective MySQL‰πãSQLËØ≠Âè•ÊúÄ‰ºòÂåñ„Äã‰∏≠ÂØπÊ∑ªÂä†Á¥¢ÂºïÂâçÂêéÁöÑÊèíÂÖ•ÊÄßËÉΩÂØπÊØî Á£ÅÁõòÁ©∫Èó¥ÁöÑÂΩ±ÂìçÔºåÂêåÊ†∑‰πüÊòØÊù•Ëá™‰∫é‰π¶‰∏≠ÁöÑÊµãËØï ÂèØ‰ª•ÁúãÂà∞Âú®Ê∑ªÂä†‰∫ÜÁ¥¢Âºï‰πãÂêéÔºåÁ©∫Èó¥Âç†Áî®ÊòØÂéüÊù•ÁöÑ7ÂÄçÔºåÂú®Êï∞ÊçÆÈáèÂ∫ûÂ§ßÊó∂ÔºåËøôÊòØ‰∏Ä‰∏™ÈúÄË¶ÅÂÖ≥Ê≥®ÁöÑÁÇπ„ÄÇ ËøòÊúâÈúÄË¶ÅÊ≥®ÊÑèÁöÑ‰∏ÄÁÇπÊòØÔºåÂú®MySQL Innodb ‰∏≠ÊúâËÅöÁ∞áÁ¥¢ÂºïÂíå‰∫åÁ∫ßÁ¥¢ÂºïÔºå‰∏ÄËà¨Êù•ËØ¥‰∏ªÈîÆÂ∞±ÊòØËÅöÁ∞áÁ¥¢ÂºïÔºåËÄåÂÖ∂‰ªñÁöÑÁ¥¢ÂºïÈÉΩÊòØ‰∫åÁ∫ßÁ¥¢Âºï„ÄÇ ‰∫åÁ∫ßÁ¥¢ÂºïÊâÄÂ≠òÂÇ®ÁöÑÂÄºÊòØËÅöÁ∞áÁ¥¢Âºï„ÄÇÊâÄ‰ª•ÂΩì‰ΩøÁî®‰∫åÁ∫ßÁ¥¢ÂºïÊù•ËøõË°åÊ£ÄÁ¥¢Êó∂ÔºåMySQL ‰ºöÂÖàÈÄöËøáËØ•Á¥¢ÂºïÊâæÂà∞ÂØπÂ∫îÁöÑËÅöÁ∞áÁ¥¢ÂºïÔºåÂÜçÈÄöËøáËØ•ËÅöÁ∞áÁ¥¢ÂºïÊâæÂà∞ÂØπÂ∫îÁöÑÊï∞ÊçÆ„ÄÇËøôÊó∂‰ΩøÁî®Âç†Áî®Â≠óËäÇÊõ¥Â∞èÁöÑÁ±ªÂûãÊù•ÂÅö‰∏ªÈîÆ‰ºöÊõ¥Â•ΩÔºå‰ºöËäÇÁúÅÁ¥¢ÂºïÂç†Áî®Á©∫Èó¥ ÂèÇËÄÉ Effective MySQL‰πãSQLËØ≠Âè•ÊúÄ‰ºòÂåñ]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>Á¥¢Âºï</tag>
        <tag>sql‰ºòÂåñ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ÁêÜËß£AQS]]></title>
    <url>%2Fpost%2F28204e82.html</url>
    <content type="text"><![CDATA[AQS ÂÖ®Áß∞ AbstractQueuedSynchronizerÔºåJ.U.C Âπ∂ÂèëÂåÖ‰∏≠ÁöÑÊ†∏ÂøÉÂü∫Á°ÄÁªÑ‰ª∂‰πã‰∏ÄÔºåÂèØÁî®Êù•ÊûÑÂª∫ÈîÅÂíåÂêåÊ≠•Âô®„ÄÇÂÆÉÂ∫ïÂ±ÇÁî®‰∫Ü CAS ÊäÄÊúØÊù•‰øùËØÅÊìç‰ΩúÁöÑÂéüÂ≠êÊÄßÔºåÂêåÊó∂Âà©Áî® FIFO ÈòüÂàóÁÆ°ÁêÜÁ´û‰∫âÈîÅÁöÑÁ∫øÁ®ãÔºåReentrantLock„ÄÅCountDownLatch Á≠âÂêåÊ≠•API ÈÉΩÊòØÂü∫‰∫éAQSÂÆûÁé∞ÁöÑ Êú¨ÊñáÁõÆÊ†áÈÄöËøá ReentrantLock ‰∏∫ÂÖ•Âè£ÔºåÊ∑±ÂÖ•ÁêÜËß£ AQS AQS Êï∞ÊçÆÁªìÊûÑ1234567891011121314151617181920212223242526// FIFO ÈòüÂàóÁöÑÈ¶ñËäÇÁÇπprivate transient volatile Node head;// FIFO ÈòüÂàóÁöÑÂ∞æËäÇÁÇπprivate transient volatile Node tail;// ÂΩìÂâçÁöÑÂêåÊ≠•Áä∂ÊÄÅprivate volatile int state;static final class Node &#123; // ÂΩìÂâçËäÇÁÇπÁä∂ÊÄÅ volatile int waitStatus; // ‰∏ä‰∏ÄËäÇÁÇπ volatile Node prev; // ‰∏ã‰∏ÄËäÇÁÇπ volatile Node next; // ÊØè‰∏™NodeÂØπÂ∫î‰∏Ä‰∏™Á∫øÁ®ã volatile Thread thread; // ÂΩìÂâçÊ®°ÂºèÔºöÁã¨Âç†/ÂÖ±‰∫´ Node nextWaiter;&#125; Node ÁªÑÊàê‰∫ÜÊàë‰ª¨ÂàöÂàöËØ¥ÁöÑ FIFO ËøôÈáåÂè™ÊòØÁÆÄÂçïÁªôÂ§ßÂÆ∂‰ªãÁªç‰∏Ä‰∏ãÔºåAQSÁöÑÊï∞ÊçÆÁªìÊûÑÔºåÂà´ÊÖå„ÄÇÂèØËÉΩÊúâ‰∫õÂèÇÊï∞‰Ω†Âπ∂‰∏çÁêÜËß£ÔºåÂêéÊñáÊàë‰ª¨‰ºöËØ¶ÁªÜËß£Èáä„ÄÇÊàëÁ¨¨‰∏ÄÊ¨°ÁúãAQSÁöÑÊ∫êÁ†ÅÁöÑÊó∂ÂÄôÔºåÊàë‰πüÂæàÊáµÈÄº„ÄÇÂà´ÁùÄÊÄ•ÔºåÊÖ¢ÊÖ¢ÁúãÔºå‰∏á‰∏ÄÁúãÊáÇ‰∫ÜÂë¢ Áõ¥Êé•ÁúãAQSÁöÑÊ∫êÁ†ÅÊúâÁÇπÁîüÁ°¨ÔºåÊàë‰ª¨Êù•ÈÄöËøá ReentrantLock Êù•ÁêÜËß£AQS ReentrantLock Â¶Ç‰ΩïÂ∫îÁî®AQSÊù•Áúã‰∏Ä‰∏ãÁ±ªÊú∫ÊûÑ ReentrantLock ÁöÑÂÜÖÈÉ®Á±ª Sync ÁªßÊâø‰∫Ü AQSÔºåReentrantLockÂÆåÂÖ®‰æùËµñSync Êù•ÂÆûÁé∞ÈîÅ„ÄÇÂú®Sync Âü∫Á°Ä‰∏äÂèàË°çÁîü‰∫ÜÔºåFairSyncÔºåNonFairSync Âç≥ÂÖ¨Âπ≥ÈîÅÂíåÈùûÂÖ¨Âπ≥ÈîÅ ÈªòËÆ§ÁöÑÊó∂ÂÄôÔºåÊûÑÂª∫ÁöÑÊòØÈùûÂÖ¨Âπ≥ÈîÅÔºåÊàë‰ª¨‰πüÂèØ‰ª•ÊåáÂÆö fair Êù•ÂÜ≥ÂÆöÊûÑÂª∫ Fair ËøòÊòØ Nonfair ÂõûÂøÜ ReentrantLock ‰ΩøÁî®ÊñπÊ≥ï12345678910111213class X &#123; private final ReentrantLock lock = new ReentrantLock(); // ... public void m() &#123; lock.lock(); // block until condition holds try &#123; // ... method body &#125; finally &#123; lock.unlock() &#125; &#125;&#125; ËøôÊòØJDKÊ≥®Èáä‰∏≠ÁöÑ‰∏Ä‰∏™Â∞èÊ†óÂ≠êÔºåÈÄöÂ∏∏Êù•ËØ¥Êàë‰ª¨Áî®ÁöÑÊØîËæÉÂ§öÁöÑÊñπÊ≥ïÔºåÂ∞±ÊòØlock(), trylock(), unlock() ËøôÂá†‰∏™„ÄÇ OK. ÈÇ£Êàë‰ª¨Â∞±ÂÖà‰ªé lock() ÊñπÊ≥ïÊêûËµ∑ ReentrantLock.lock()ËøôÈáåÊàëÊäΩÂá∫‰∏ªË¶ÅÁöÑ‰ª£Á†ÅÁî®‰∫éÊºîÁ§∫ÔºåËøôÈáå‰ª•ÈùûÂÖ¨Âπ≥ÈîÅ‰∏∫‰æã Á¨¨‰∏ÄÊ≠•Â∞±‰∏çËØ¥‰∫Ü Á¨¨‰∫åÊ≠•ÔºåÈÄöËøácompareAndSetState Â∞ùËØïÂ∞Ü state Áä∂ÊÄÅ‰ªé0Êõ¥Êñ∞Âà∞1ÔºåËøôÈáåÁî®Âà∞Â∞±ÊòØjavaÁöÑ CASÔºà‰∏ç‰∫ÜËß£CASÁöÑÂêåÂ≠¶ÂèØ‰ª•Google‰∏Ä‰∏ãÔºâ„ÄÇËøôÈáåReentrantLock Âà©Áî® AQS ‰∏≠ÁöÑ state ÂèòÈáèÂÅö‰∏∫ÈîÅÁöÑÁä∂ÊÄÅÔºå0‰ª£Ë°®Êó†ÈîÅÔºå1‰ª£Ë°®ÂΩìÂâçÊúâÈîÅÔºåÂ¶ÇÊûúCAS Êõ¥Êñ∞state ÊàêÂäüÔºåÂàôËØ¥ÊòéÂΩìÂâçÁ∫øÁ®ãËé∑ÂèñÈîÅÊàêÂäüÔºåÂ∞ÜÁã¨Âç†Á∫øÁ®ãËÆæÁΩÆ‰∏∫ÂΩìÂâçÁ∫øÁ®ã„ÄÇ Á¨¨‰∏âÊ≠•ÔºåË∞ÉÁî® acquire(1); ËØ•ÊñπÊ≥ïÊòØAQS Êèê‰æõÁöÑÔºåacquire ‰ºöÂ∞ùËØïËé∑ÂèñÈîÅÔºåÂÜçËé∑ÂèñÂ§±Ë¥•ÂêéÔºåÂΩìÂâçÁ∫øÁ®ãËøõÂÖ•ÈòüÂàóÁ≠âÂæÖ ËøôÈáå‰πüÂèØ‰ª•ÁúãÂá∫ÔºåNonfairSync ÈùûÂ∏∏ÁöÑÈú∏ÈÅìÔºå‰ªñÂú®Ë∞ÉÁî®lockÊñπÊ≥ïÂêéÔºåÂ∞±ÊÉ≥Â∞ùËØïËé∑ÂèñÈîÅ AQS.acquire()Âú®Á¨¨‰∏ÄÊ¨°CASÂ∞ùËØïËé∑ÂèñÈîÅÂ§±Ë¥•ÂêéÔºå‰ºöÊâßË°åÂà∞ acquire() ‰∏ãÈù¢Êù•ÂàÜÊûê‰∏Ä‰∏ãËØ•ÊñπÊ≥ïÁöÑÈÄªËæë Á¨¨‰∏ÄÊ≠• tryAcquireÔºåËØ•ÊñπÊ≥ïAQS Âπ∂Ê≤°ÊúâÊèê‰æõÂÖ∑‰ΩìÂÆûÁé∞Ôºå‰ªéÂõæ1ÂèØ‰ª•ÁúãÂà∞ÔºåÈùûÂÖ¨Âπ≥ÈîÅÁöÑ tryAcquire() Ë∞ÉÁî®ÁöÑÊòØ nonfairTryAcquire() ÔºåÂÖ∑‰Ωì‰ª£Á†ÅÂú®Âõæ3‰∏≠ Âíå lock() ‰∏≠ÁöÑ‰ª£Á†ÅÊúâÁÇπÁõ∏‰ººÔºåÈ¶ñÂÖàÊòØÂà§Êñ≠Áä∂ÊÄÅÔºåÂ¶ÇÊûúÊó†ÈîÅÂàôÂ∞ùËØï CASÊõ¥Êñ∞stateÔºåÂ¶ÇÊûúÊõ¥Êñ∞ÊàêÂäüÂàô‰ª£Ë°®Ëé∑ÂèñÈîÅÊàêÂäü„ÄÇÁÑ∂Âêé else if ËøôÊÆµÁöÑÈÄªËæëÂ∞±ÊòØÂ¶ÇÊûú ‚ÄúÂΩìÂâçÁ∫øÁ®ãÂ∑≤ÁªèËé∑ÂèñÈîÅ‚ÄùÔºåËøòÂèØ‰ª•ÁªßÁª≠Êõ¥Êñ∞state„ÄÇËøôÊòØÂï•ÊÑèÊÄùÔºüËøôÂ∞±ÊòØ‰∏∫‰ªÄ‰πàÂè´ÂèØÈáçÂÖ•ÈîÅÔºå‰ª£Ë°®ÂΩìÂâçÁ∫øÁ®ãÂç≥‰ΩøÊâßË°å lock()ÔºåËøòÂèØ‰ª•ÁªßÁª≠ÊâßË°ålock() Á¨¨‰∫åÊ≠•ÔºåÂú®tryAcquire Ëé∑ÂèñÈîÅÂ§±Ë¥•ÂêéÔºåAQS ‰ºöÂ∞ùËØïËÆ©ÂΩìÂâçÁ∫øÁ®ã‰Ωú‰∏∫‰∏Ä‰∏™NodeÂÖ•ÈòüÔºàÂä†ÂÖ•Âà∞ÈòüÂàóÁöÑÊú´Â∞æÔºâÔºåÂ∞ÜÂΩìÂâçÁ∫øÁ®ãÊûÑÂª∫‰∏∫NodeÂØπË±°ÔºåÊ®°Âºè‰∏∫‚ÄúÁã¨Âç†‚Äù„ÄÇÂ¶ÇÊûúCASÂÖ•ÈòüÂ§±Ë¥•ÔºåÊàñËÄÖÈòüÂàó‰∏∫Á©∫ÔºåË∞ÉÁî®enqÔºåËá™ÊóãÂÖ•ÈòüÔºà‰∏çÊñ≠ÁöÑÂ∞ùËØïCASÂÖ•ÈòüÔºå‰øùËØÅÁ∫øÁ®ãÂÆâÂÖ®Ôºâ„ÄÇËøô‰∏ÄÊ≠•ÂÖ∑‰Ωì‰ª£Á†ÅÂèÇËÄÉÂõæ2 AQS.acquireQueued()Ââç‰∏§Ê¨°Êä¢Âç†ÈîÅÂ§±Ë¥•ÁöÑÁ∫øÁ®ã‰ºöËøõÂÖ•Âà∞AQSÁöÑ FIFO ÈòüÂàó‰∏≠ÔºåÈòüÂàó‰∏≠ÁöÑËäÇÁÇπÊåâÁÖß‚ÄúÂÖàËøõÂÖàÂá∫‚ÄùÁöÑËßÑÂàôÂá∫ÈòüÔºåÈÄöËøáËá™ÊóãÂ∞ùËØïËé∑ÂèñÈîÅ Á¨¨‰∏ÄÊ≠•ÔºåÂ¶ÇÊûúÂΩìÂâçNode ÁöÑ‰∏ä‰∏Ä‰∏™ËäÇÁÇπ‰∏∫headÔºåÂàôË∞ÉÁî®tryAcquire Â∞ùËØïËé∑ÂæóÈîÅ ËøôÈáåËß£Èáä‰∏Ä‰∏ãÔºå‰∏∫‰ªÄ‰πàÊª°Ë∂≥ ‚Äúp == head‚Äù ÁöÑNode ÊúâËµÑÊ†ºËé∑ÂæóÈîÅÔºåÂõ†‰∏∫Âú®AQSÁöÑÈòüÂàó‰∏≠Ôºåhead ËäÇÁÇπÊòØÊó†ÊÑè‰πâÁöÑ„ÄÇ‰∏∫‰ªÄ‰πàËøô‰πàËØ¥ÔºåÂèØ‰ª•Áúã‰∏ãÂõæ2‰∏≠ÁöÑ enq()ÔºåÂàùÂßãÂåñÈòüÂàóÁöÑÊó∂ÂÄôÔºå‰ºönew ‰∏Ä‰∏™Node ‰Ωú‰∏∫ head„ÄÇÂÜçÁúãÂõæ4‰∏≠ÔºåÂ¶ÇÊûúÁ¨¨‰∫å‰∏™ËäÇÁÇπÊàêÂäüËé∑ÂèñÈîÅÔºåËØ•ËäÇÁÇπ‰ºöÂçáÁ∫ß‰∏∫head„ÄÇ Á¨¨‰∫åÊ≠•ÔºåshouldParkAfterFailedAcquire ‰ªéÊñπÊ≥ïÂêçÊàë‰ª¨ÂèØ‰ª•ÂàÜÊûêÂá∫ÔºåËØ•ÊñπÊ≥ïÊòØÂà§Êñ≠ÂΩìÂâçÁ∫øÁ®ãÂÜçËé∑ÂèñÈîÅÂ§±Ë¥•ÂêéÔºåÊòØÂê¶ÂèØ‰ª•ËøõÂÖ•ÊåÇËµ∑Áä∂ÊÄÅ„ÄÇ Âú®ÁúãshouldParkAfterFailedAcquire() ‰πãÂâçÔºåÂÖàÊù•‰∫ÜËß£‰∏Ä‰∏ã Node‰∏≠waitStatus ÁöÑ‰∏§‰∏™Áä∂ÊÄÅ1234/** waitStatus value to indicate thread has cancelled */static final int CANCELLED = 1; // Ë°®Á§∫ÂΩìÂâçÁ∫øÁ®ãË¢´ÂèñÊ∂à/** waitStatus value to indicate successor&apos;s thread needs unparking */static final int SIGNAL = -1; // Ë°®Á§∫ÂêéÁª≠Á∫øÁ®ãÈúÄË¶ÅÊåÇËµ∑ ÂÖ∑‰Ωì‰ª£Á†ÅÂú®‰∏ãÈù¢Âõæ5‰∏≠ Â¶ÇÊûú‰∏ä‰∏ÄËäÇÁÇπÁä∂ÊÄÅ‰∏∫ SIGNALÔºåËøîÂõûtrueÔºåÂΩìÂâçÁ∫øÁ®ã‰ºöËøõÂÖ•ÊåÇËµ∑ Â¶ÇÊûú‰∏ä‰∏ÄËäÇÁÇπÁä∂ÊÄÅ‰∏∫ CANCELLEDÔºåÂàôÂ∞ÜËøô‰∏™ËäÇÁÇπ‰ªéÈòüÂàó‰∏≠ÁßªÈô§ waitStatus ‰∏∫ÂÖ∂‰ªñÁä∂ÊÄÅÊó∂ÔºåCAS Â∞ùËØïÂ∞ÜwaitStatus Êõ¥Êñ∞‰∏∫ SIGNAL Á¨¨‰∏âÊ≠•ÔºåÂ¶ÇÊûúshouldParkAfterFailedAcquire ËøîÂõûtrueÔºåÂàô parkAndCheckInterrupt ÊåÇËµ∑ÂΩìÂâçÁ∫øÁ®ã Â¶ÇÊûú acquireQueued() ÊñπÊ≥ïÊâßË°åËøáÁ®ã‰∏≠ÔºåÂ¶ÇÊûúÊäõÂá∫ÂºÇÂ∏∏ÔºåÂÖ•ÈòüÂ§±Ë¥•ÔºåÂàôË∞ÉÁî®cancelAcquire() ÂèñÊ∂àÂΩìÂâçËäÇÁÇπ ÊÄªÁªì‰∏äÈù¢Êàë‰ª¨ÂàÜÊûê‰∫Ü ReentrantLock ÁöÑÈÉ®ÂàÜÊ∫êÁ†ÅÔºåReentrantLock ÈÄöËøáAQSÊèê‰æõÁöÑstate ‰ª•Âèä FIFOÔºåÂ∑ßÂ¶ôÁöÑÂÆûÁé∞‰∫ÜÈîÅ„ÄÇÂÖ∂ÂÆûAQSÁöÑÊ∫êÁ†ÅËøú‰∏çÊ≠¢Ëøô‰∫õÔºåËøòÊúâÂæàÂ§öÂÄºÂæóÊÄùËÄÉÁöÑ‰∏úË•øÔºåÂêéÁª≠Ëøò‰ºö‰∏∫Â§ßÂÆ∂ÂàÜ‰∫´Áõ∏ÂÖ≥ÁöÑÁü•ËØÜ„ÄÇ ÊúÄÂêéÊàë‰ª¨ÈÄöËøá‰∏ÄÂº†ÂõæÔºåÂÜçÊù•Âä†Ê∑±‰∏Ä‰∏ãÊú¨ËäÇÁöÑÁêÜËß£ Â¶ÇÊûúËßâÂæóËøò‰∏çÈîôÊ¨¢ËøéÁÇπËµû„ÄÅËΩ¨Âèë„ÄÇ‰Ω†ÁöÑÊîØÊåÅÂ∞±ÊòØÂØπÊàëÊúÄÂ§ßÁöÑÂ∏ÆÂä©]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>ÈîÅ</tag>
        <tag>Java</tag>
        <tag>Â§öÁ∫øÁ®ã</tag>
        <tag>Ê∫êÁ†Å</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring SecurityÂÆûÊàò(‰∫å) Âä®ÊÄÅÊùÉÈôê]]></title>
    <url>%2Fpost%2Fb718a659.html</url>
    <content type="text"><![CDATA[Â•ΩÊ∂àÊÅØÂ•ΩÊ∂àÊÅØÔºÅSecurityÁ≥ªÂàóÁªà‰∫éÊúâ‰∫ÜÁ¨¨‰∫åÊúüÔºåÊúÄËøëÂú®ÁúãÈ°πÁõÆÊ∫êÁ†ÅÂøç‰∏ç‰ΩèÂèàÊêûËµ∑Êù•Spring SecurityÔºåÊù•ÁªôÂ§ßÂÆ∂ÂàÜ‰∫´‰∏Ä‰∏ãÔºåËôΩÁÑ∂Âíå‰∏ä‰∏ÄËäÇËØ¥Â•ΩÁöÑÂÜÖÂÆπ‰∏çÂêåü§≠ ÂõûÈ°æ‰∏äËäÇÊàë‰ª¨‰ªãÁªç‰∫ÜÂ¶Ç‰ΩïËøõË°åÁÆÄÂçïÁöÑÊùÉÈôêÈÖçÁΩÆÔºåÂåÖÊã¨urlÊùÉÈôêÂíåÊñπÊ≥ïÊùÉÈôêÔºåËøòÊúâÂ¶Ç‰ΩïÊéà‰∫àÁî®Êà∑ÊùÉÈôê„ÄÇ12345678910111213141516171819protected void configure(HttpSecurity http) throws Exception &#123; http .authorizeRequests() .antMatchers("/", "/home").permitAll() // ÊµãËØïÈÖçÁΩÆURLÊùÉÈôê .antMatchers("/match/**").hasAuthority("sys:match") // ÂØπÊüêURLÊ∑ªÂä†Â§ö‰∏™ÊùÉÈôêÔºåÂèØ‰ª•Â§öÊ¨°ÈÖçÁΩÆ .antMatchers("/match/**").hasAuthority("sys:mm") .anyRequest().authenticated() .and() .formLogin() .loginPage("/login") .permitAll() .and() .logout() .permitAll() .and() ;&#125; ‰ΩÜÊòØÂ¶ÇÊûúÁé∞Âú®‰Ω†ÁöÑ‰∏öÂä°Á≥ªÁªüË¶ÅÊ±ÇÂä®ÊÄÅÊùÉÈôêÂë¢Ôºü ÊØîÂ¶ÇÁî®Êà∑ÊùÉÈôêÂèòÊõ¥‰∫ÜÔºåÊàë‰ª¨ÂèØ‰ª•ÈáçÊñ∞ÊûÑÂª∫Security‰∏ä‰∏ãÊñá‰∏≠Authentication ÂØπË±°ÔºåËøôËøòÂ•ΩËØ¥„ÄÇÂ¶ÇÊûúËØ¥Êüê‰∏™Êé•Âè£ÁöÑÊùÉÈôê‰øÆÊîπ‰∫ÜÔºåÂ¶ÇÊûúÊåâÁÖß‰∏äËø∞ÁöÑÊñπÊ≥ïÊù•ÂÅöÁöÑËØùÔºåÊòØ‰∏çÂèØËÉΩÂÆûÁé∞Âä®ÊÄÅ‰øÆÊîπÁöÑ„ÄÇ Êú¨ËäÇÊàë‰ª¨Êù•‰ªãÁªç‰∏Ä‰∏ãSpring Security Â¶Ç‰ΩïÂÆûÁé∞Âä®ÊÄÅÊùÉÈôê ÂÆûÁé∞ÂéüÁêÜFilterSecurityInterceptor Ë¥üË¥£ Security‰∏≠ÁöÑÊùÉÈôêÊéßÂà∂ÔºåÂÖ∂Ê†∏ÂøÉ‰ª£Á†ÅÂú®Áà∂Á±ªAbstractSecurityInterceptor‰∏≠ÔºåÊàë‰ª¨Êù•Áúã‰∏Ä‰∏ã ËøôÈáåÊàëÂà†‰∫Ü‰∏Ä‰∫õ‰∏éÊ†∏ÂøÉÈÄªËæëÊó†ÂÖ≥ÁöÑ‰ª£Á†ÅÔºåÊàë‰ª¨Âè™ÈúÄË¶ÅÂÖ≥Ê≥®Á∫¢Ê°ÜÈáåÁöÑÂÜÖÂÆπ ËøôÊó∂ÂÄôËÅ™ÊòéÁöÑ‰Ω†Â∫îËØ•Â∑≤ÁªèÊòéÁôΩ‰∫ÜFilterSecurityInterceptorÊòØÂ¶Ç‰ΩïÁÆ°ÁêÜÊùÉÈôêÁöÑÔºåÊàë‰ª¨ÂÆåÂÖ®ÂèØ‰ª•Ëá™Â∑±ÂÆûÁé∞‰∏äÈù¢ÁöÑAccessDecisionManagerÂíåSecurityMetadataSourceÊù•ÂÆûÁé∞Êàë‰ª¨ÁöÑÂä®ÊÄÅÊùÉÈôê ‰ΩÜÊòØÂÖàÂà´ÊÄ•ÔºåÂÖàÁúãÁúãAccessDecisionManagerÁöÑÈªòËÆ§ÂÆûÁé∞AffirmativeBased Ëøô‰ª£Á†ÅÂÜôÁöÑÊúâÊÑèÊÄù‰∫ÜÔºåÈÄöËøáÈÅçÂéÜÊâÄÊúâÁöÑVoterÔºåÊØè‰∏™VoterÂÆûÁé∞ÂÖ∑‰ΩìÁöÑÂà§Êñ≠ÈÄªËæëÔºåËøîÂõû 1Ôºå0Ôºå-1ÔºàÂàÜÂà´‰ª£Ë°®ÂêåÊÑè„ÄÅÂºÉÊùÉ„ÄÅÊãíÁªùÔºâÔºåÂΩìÂ≠òÂú®ÊãíÁªùÊó∂Áõ¥Êé•ÊäõÂá∫AccessDeniedException ÈùûÂ∏∏ÁöÑÊ∞ë‰∏ªÔºåÊàë‰ª¨Âè™ÈúÄË¶ÅÂÆûÁé∞‰∏Ä‰∏™VoterÂç≥ÂèØ Ê≥®ÔºöAccessDecisionManager ËøòÊúâÂÖ∂‰ªñÁöÑÈªòËÆ§ÂÆûÁé∞ÔºåÊÑüÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•Ëá™Ë°åÊü•ÁúãÊ∫êÁ†Å CodingOKÔºåÈ¶ñÂÖàÊàë‰ª¨ÂÖàÊçã‰∏Ä‰∏ãÊÄùË∑Ø ÂÆûÁé∞SecurityMetadataSourceÔºåÊèê‰æõÂΩìÂâçËµÑÊ∫êË¶ÅÊ±ÇÁöÑÊùÉÈôê ÂÆûÁé∞AccessDecisionVoterÔºåÁî®‰∫éÂà§Êñ≠ÂΩìÂâçÁî®Êà∑ÊòØÂê¶ÊúâÊùÉÈôêËÆøÈóÆ Â∞ÜÊàë‰ª¨Ëá™Â∑±ÁöÑÂÆûÁé∞Ê≥®ÂÜåÂà∞FilterSecurityInterceptor‰∏≠ OKÔºåÂèØ‰ª•ÂºÄÊêû‰∫Ü SecurityServiceÂÆûÁé∞‰∏Ä‰∏™ServiceÔºåÁî®‰∫é‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÊï∞ÊçÆ1234567891011121314151617181920212223242526@Servicepublic class SecurityService &#123; @Autowired private JdbcTemplate jdbcTemplate; /** * Âä†ËΩΩËµÑÊ∫êË¶ÅÊ±ÇÁöÑÊùÉÈôê * * @param resource * @return */ public List&lt;String&gt; getPermByResource(String resource) &#123; return jdbcTemplate.queryForList(Sql.getPermByResource, String.class, resource); &#125; /** * ÂΩìÂâçÁî®Êà∑ÁöÑÊùÉÈôê * * @param username * @return */ public List&lt;String&gt; getPermByUsername(String username) &#123; return jdbcTemplate.queryForList(Sql.getPermByUsername, String.class, username); &#125;&#125; Ê≥®ÔºöËøôÈáå‰∏§‰∏™ÊñπÊ≥ïÈÉΩÂèØ‰ª•Âä†‰∏äÁºìÂ≠òÔºåÁî±‰∫édemoÊºîÁ§∫ÔºåÊàëÂ∞±Ê≤°ÊúâËøô‰πàÂÅö ÂÆûÁé∞SecurityMetadataSourceMySecurityMetadataSource ÂæàÁÆÄÂçïÔºåÂ∞±ÊòØÈÄöËøáSecurityServiceÂä†ËΩΩ‰∏Ä‰∏ãÊï∞ÊçÆ12345678910111213141516171819202122232425262728public class MySecurityMetadataSource implements FilterInvocationSecurityMetadataSource &#123; private SecurityService securityService; public MySecurityMetadataSource(SecurityService securityService) &#123; this.securityService = securityService; &#125; @Override public Collection&lt;ConfigAttribute&gt; getAttributes(Object object) throws IllegalArgumentException &#123; String uri = ((FilterInvocation) object).getHttpRequest().getRequestURI(); List&lt;String&gt; list = securityService.getPermByResource(uri); if (list != null &amp;&amp; list.size() != 0) &#123; return SecurityConfig.createList(list.toArray(new String[0])); &#125; return null; &#125; @Override public Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() &#123; return null; &#125; @Override public boolean supports(Class&lt;?&gt; clazz) &#123; return FilterInvocation.class.isAssignableFrom(clazz); &#125;&#125; ÂÆûÁé∞AccessDecisionVoterËøôÈáåÂä†ËΩΩ‰∏Ä‰∏ãÂΩìÂâçÁî®Êà∑ÁöÑÊùÉÈôêÔºåÂà§Êñ≠Áî®Êà∑ÊòØÂê¶Êª°Ë∂≥ÂΩìÂâçËµÑÊ∫êÊâÄË¶ÅÊ±ÇÁöÑÊùÉÈôê12345678910111213141516171819202122232425262728293031323334public class MyAccessDecisionVoter implements AccessDecisionVoter&lt;Object&gt; &#123; private SecurityService securityService; public MyAccessDecisionVoter(SecurityService securityService) &#123; this.securityService = securityService; &#125; @Override public boolean supports(ConfigAttribute attribute) &#123; return true; &#125; @Override public boolean supports(Class&lt;?&gt; clazz) &#123; return true; &#125; @Override public int vote(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; attributes) &#123; Object principal = authentication.getPrincipal(); if ("anonymousUser".equals(principal)) &#123; // ÂΩìÂâçÁî®Êà∑Êú™ÁôªÂΩïÔºåÂ¶ÇÊûú‰∏çË¶ÅÊ±ÇÊùÉÈôê-&gt;ÂÖÅËÆ∏ËÆøÈóÆÔºåÂê¶ÂàôÊãíÁªùËÆøÈóÆ return CollectionUtils.isEmpty(attributes) ? ACCESS_GRANTED : ACCESS_DENIED; &#125; else &#123; // ËøôÈáåÊàëÁöÑÈÄªËæëÊòØÔºåÂΩìÂâçËµÑÊ∫êÁöÑË¶ÅÊ±ÇÊùÉÈôêÔºåÁî®Êà∑ÂøÖÈ°ªÂÖ®ÈÉ®Êª°Ë∂≥Êó∂ÊâçÂèØ‰ª•ËÆøÈóÆ User user = (User) principal; List&lt;String&gt; permitList = securityService.getPermByUsername(user.getUsername()); List&lt;String&gt; stringAttributes = attributes.stream().map(ConfigAttribute::getAttribute).collect(Collectors.toList()); return permitList.containsAll(stringAttributes) ? ACCESS_GRANTED : ACCESS_DENIED; &#125; &#125;&#125; Ê≥®ÂÜåÂà∞FilterSecurityInterceptorÊàë‰ª¨Ê†∏ÂøÉÁöÑ‰∏öÂä°Â∑≤ÁªèÂÆûÁé∞ÂÆå‰∫ÜÔºåÁé∞Âú®ÈúÄË¶ÅÊääMySecurityMetadataSourceÂíåMyAccessDecisionVoterÊ≥®ÂÜåÂà∞FilterSecurityInterceptor‰∏≠ ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåFilterSecurityInterceptorÂπ∂‰∏çÂèØ‰ª•ÈÄöËøá@BeanÁöÑÊñπÂºèÊù•Â£∞ÊòéÔºåËØ•ÂØπË±°ÊòØÂú®WebSecurityConfigurerAdapterÁöÑÂàùÂßãÂåñÊñπÊ≥ï‰∏≠ÈªòËÆ§ÂàõÂª∫ÁöÑ ‰ΩÜÊòØSpring Security‰∏∫Êàë‰ª¨Êèê‰æõ‰∫ÜObjectPostProcessorÔºåÁî®‰∫éËß£ÂÜ≥‰∏äËø∞ÈóÆÈ¢òÔºåÂÖ∑‰ΩìÁî®Ê≥ïÂ¶Ç‰∏ã12345678910111213http .authorizeRequests() .antMatchers("/", "/home", "/403").permitAll() .anyRequest().authenticated() .withObjectPostProcessor(new ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() &#123; @Override public &lt;O extends FilterSecurityInterceptor&gt; O postProcess( O fsi) &#123; fsi.setSecurityMetadataSource(new MySecurityMetadataSource(securityService)); fsi.setAccessDecisionManager(new AffirmativeBased(getDecisionVoters())); return fsi; &#125; &#125;) ÂÆåÊï¥DemoGithub üëâ https://github.com/TavenYin/security-example/tree/master/dynamic-permissions]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Spring Security</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[‰ΩøÁî® Spring Cloud ÂàÜÂ∏ÉÂºèÈÖçÁΩÆ‰∏≠ÂøÉ]]></title>
    <url>%2Fpost%2Fbca00fad.html</url>
    <content type="text"><![CDATA[Spring Cloud Config ËÉΩÂÅö‰ªÄ‰πàÔºüÊàë‰ª¨ÂèØ‰ª•Â∞ÜÂàÜÂ∏ÉÂºèÁ≥ªÁªüÁöÑÈÖçÁΩÆÊñá‰ª∂ÊâòÁÆ°Âú®Git‰ªìÂ∫ìÊàñËÄÖÊï∞ÊçÆÂ∫ì‰∏≠ÔºåConfig Server Ë¥üË¥£ÁÆ°ÁêÜÈÖçÁΩÆÊñá‰ª∂Ôºå‰ª•RestfulÁöÑÂΩ¢ÂºèÊèê‰æõÁªôÂÖ∂‰ªñÊúçÂä°ÔºåÂèØ‰ª•Âú®‰ªª‰ΩïÂÖ∂‰ªñËØ≠Ë®ÄÁöÑÂ∫îÁî®Á®ãÂ∫è‰∏≠‰ΩøÁî®Ôºå‰∏ç‰æùËµñSpring CloudÂÖ®ÂÆ∂Ê°∂„ÄÇ Êú¨ËäÇÁõÆÊ†á‰ΩøÁî®Spring Cloud Âü∫‰∫éGit‰ªìÂ∫ìÊê≠Âª∫ÂàÜÂ∏ÉÂºèÈÖçÁΩÆ‰∏≠ÂøÉ ÁâàÊú¨Spring Cloud Greenwich.SR2Spring Boot 2.1.7.RELEASE Git‰ªìÂ∫ìÂú®‰Ω†ÂñúÊ¨¢ÁöÑGitÂπ≥Âè∞‰∏äÂª∫Á´ã‰∏Ä‰∏™‰ªìÂ∫ìÔºåÂàõÂª∫‰∏Ä‰∏™ÁõÆÂΩïÔºåÂπ∂Âª∫Á´ãÂá†‰∏™ÈÖçÁΩÆÊñá‰ª∂ÔºàÂª∫ËÆÆÁΩëÁªúËæÉÊÖ¢ÁöÑÂêåÂ≠¶ÈÄâÊã©GiteeÔºâ Êê≠Âª∫Config Serverpom.xml1234567891011121314151617181920212223&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; ...&lt;/dependencies&gt;&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;Greenwich.SR2&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt; application.properties12345678910server.port = 9001spring.application.name = config-server#Ë°®Á§∫ÈÖçÁΩÆ‰∏≠ÂøÉÊâÄÂú®‰ªìÂ∫ìÁöÑ‰ΩçÁΩÆspring.cloud.config.server.git.uri = https://gitee.com/yintianwen7/cloud-config.git#‰ªìÂ∫ìË∑ØÂæÑ‰∏ãÁöÑÁöÑÁõ∏ÂØπÊêúÁ¥¢‰ΩçÁΩÆÔºåÂèØ‰ª•ÈÖçÁΩÆÂ§ö‰∏™spring.cloud.config.server.git.search-paths = demo#gitÁöÑÁî®Êà∑Âêçspring.cloud.config.server.git.username = yourusername#gitÁöÑÂØÜÁ†Åspring.cloud.config.server.git.password = yourpassword ConfigServerApplication.java123456789@EnableConfigServer@SpringBootApplicationpublic class ConfigServerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfigServerApplication.class, args); &#125;&#125; Ëá≥Ê≠§ÔºåConfigServer Êê≠Âª∫ÂÆåÊàêÔºåÊàë‰ª¨ÂèØ‰ª•ËÆøÈóÆConfigServer Êü•Áúã cloud-config/demo ‰∏ãÁöÑÈÖçÁΩÆÊñá‰ª∂ ËÆøÈóÆÊñπÂºèÂ¶Ç‰∏ã: /{application}/{profile}[/{label}] /{application}-{profile}.yml /{label}/{application}-{profile}.yml /{application}-{profile}.properties /{label}/{application}-{profile}.properties ËøôÈáå label ‰∏∫git ÂàÜÊîØÔºåÈªòËÆ§master ‰æãÂ¶ÇËÆøÈóÆ application-dev.ymlÔºåÁõ¥Êé•ËØ∑Ê±Ç localhost:9001/application/devÂç≥ÂèØ ÂèØ‰ª•Â∞ùËØï‰øÆÊîπ‰∏Ä‰∏ãGit‰ªìÂ∫ì‰∏≠ÁöÑÈÖçÁΩÆÊñá‰ª∂ÔºåÂÜçËÆøÈóÆConfig ServerÔºåËøôÊó∂‰Ω†‰ºöÂèëÁé∞Config Server‰∏≠ÁöÑÊï∞ÊçÆÊòØÂÆûÊó∂ÁöÑ„ÄÇ Êê≠Âª∫ Client Â∫îÁî®ËÆøÈóÆConfig Serverpom.xml1234567891011121314151617181920212223&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; ...&lt;/dependencies&gt;&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;Greenwich.SR2&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt; bootstrap.propertiesÔºåÊ≥®ÊÑèËøôÈáåÊòØ bootstrap.propertiesÔºå‰∏çÁÑ∂‰Ω†‰ºöÂèëÁé∞‰Ω†ËØ∑Ê±ÇÁöÑURI‰∏ÄÁõ¥ÊòØlocalhost:888812345spring.profiles.active=simplespring.application.name=applicationspring.cloud.config.label=master# ÊãºÊé•ËßÑÂàô: uri/name/profile/labelspring.cloud.config.uri=http://localhost:9001 CloudConfig.java ÈÖçÁΩÆÊñá‰ª∂ÁöÑÊò†Â∞ÑÂÆû‰ΩìÔºåÂêåÁêÜ‰πüÂèØ‰ª•@Value ÊàñËÄÖ Environment ÂØπË±°ËØªÂèñÂ±ûÊÄß12345678@ConfigurationProperties("cloud.config")public class CloudConfig &#123; private String a; private String b; private String c; // ÁúÅÁï• get set&#125; ClientApplication.java123456789101112131415161718@RestController@SpringBootApplication@EnableConfigurationProperties(CloudConfig.class)public class ClientApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ClientApplication.class, args); &#125; @Autowired private CloudConfig cloudConfig; // Âà∑Êñ∞ÈÖçÁΩÆÊó∂ POST /actuator/refresh @GetMapping("config") public Object config() &#123; return cloudConfig; &#125;&#125; ÂêØÂä® ClientÔºåÊü•ÁúãÊó•ÂøóÔºåÂèØ‰ª•ÁúãÂà∞ËØ∑Ê±ÇÈÖçÁΩÆ‰∏≠ÂøÉÁöÑURL ËØ∑Ê±Ç localhost:8080/config ÔºåÈ™åËØÅÈÖçÁΩÆÊñá‰ª∂ÊòØÂê¶ËØªÂèñÊàêÂäü Âà∑Êñ∞ÂÆ¢Êà∑Á´ØÈÖçÁΩÆClient ‰∏≠ËØªÂèñÁöÑÈÖçÁΩÆÊñá‰ª∂ÔºåÂπ∂‰∏çÊòØÂÆûÊó∂ÁöÑÔºåÊàë‰ª¨ÂèØ‰ª•ÈÄöËøá‰øÆÊîπGit‰ªìÂ∫ì‰∏≠ÁöÑÊñá‰ª∂Êù•È™åËØÅËøôÁÇπ„ÄÇÈÇ£‰πàÂ¶Ç‰ΩïÂà∑Êñ∞ÈÖçÁΩÆÂë¢Ôºü pom.xml ÂºïÂÖ•1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt; bootstrap.properties ËøΩÂä†1management.endpoints.web.exposure.include=* ÂØπÈúÄË¶ÅÂà∑Êñ∞ÁöÑBeanÔºåÊ∑ªÂä†Ê≥®Ëß£@RefreshScope1234@RefreshScope@ConfigurationProperties("cloud.config")public class CloudConfig &#123;&#125; POST /actuator/refreshÔºåÂç≥ÂèØÂà∑Êñ∞ÈÖçÁΩÆ Config Server Âä†ÂØÜËß£ÂØÜÂÖÅËÆ∏Êï∞ÊçÆ‰ª•Âä†ÂØÜÂΩ¢ÂºèÂ≠òÂÇ®Âú®Git‰ªìÂ∫ìÔºåÈÖçÁΩÆ‰∏≠ÂøÉË¥üË¥£ÂØπÂä†ÂØÜÁöÑÊï∞ÊçÆËøõË°åËß£ÂØÜÔºåÁÑ∂ÂêéÊèê‰æõÁªôÂÆ¢Êà∑Á´ØÂ∫îÁî®„ÄÇÁî±‰∫éÁØáÂπÖÈóÆÈ¢òÔºåËøôÈáå‰∏çËÆ≤‰∫ÜÔºåÊÑüÂÖ¥Ë∂£ÁöÑÂ∞è‰ºô‰º¥ÂèÇËÄÉ Spring CloudÊûÑÂª∫ÂæÆÊúçÂä°Êû∂ÊûÑÔºöÂàÜÂ∏ÉÂºèÈÖçÁΩÆ‰∏≠ÂøÉÔºàÂä†ÂØÜËß£ÂØÜÔºâ ÈÖçÁΩÆ‰∏≠ÂøÉÈ´òÂèØÁî®ÊñπÊ°à1Ôºö‰ΩøÁî®‰º†ÁªüË¥üËΩΩÂùáË°°Âô® ÊñπÊ°à2ÔºöÂ∞Üclient„ÄÅconfig server Ê≥®ÂÜåÂà∞Spring CloudÊ≥®ÂÜå‰∏≠ÂøÉÔºåÈÄöËøáÊ≥®ÂÜå‰∏≠ÂøÉËÆøÈóÆÈÖçÁΩÆ‰∏≠ÂøÉÔºåÂÖ∑‰Ωì‰ª£Á†ÅÂèÇËÄÉüëá DemoÊú¨ÊñádemoüëâÔºöGithubÔºå Gitee ÂèÇËÄÉhttp://blog.didispace.com/spring-cloud-starter-dalston-3-2/https://segmentfault.com/a/1190000012908853]]></content>
      <categories>
        <category>ÂàÜÂ∏ÉÂºè</category>
      </categories>
      <tags>
        <tag>Spring Cloud</tag>
        <tag>ÂàÜÂ∏ÉÂºèÈÖçÁΩÆ‰∏≠ÂøÉ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RabbitMQ ÈõÜÁæ§Êê≠Âª∫]]></title>
    <url>%2Fpost%2F4c62e394.html</url>
    <content type="text"><![CDATA[Êú¨ÊñáËÆ∞ÂΩïRabbitMQÈõÜÁæ§Êê≠Âª∫ËøáÁ®ã‰∏≠ÈÅáÂà∞ÁöÑÈóÆÈ¢ò ÁéØÂ¢É vmware12 ËôöÊãüÊú∫ÔºåCentOS7Êú¨Êñá‰ª•‰∏§Âè∞CentOS ‰∏∫‰æãÔºåIP 192.168.32.128Ôºå192.168.32.129 Á£ÅÁõòËäÇÁÇπÂíåÂÜÖÂ≠òËäÇÁÇπÈõÜÁæ§‰∏≠ÔºåÊØè‰∏Ä‰∏™RabbitMQÂÆû‰æãÈÉΩÊòØ‰∏Ä‰∏™ËäÇÁÇπÔºåËÄåËäÇÁÇπÂàÜ‰∏∫Á£ÅÁõòËäÇÁÇπÂíåÂÜÖÂ≠òËäÇÁÇπ ÂÜÖÂ≠òËäÇÁÇπÔºöÂ∞ÜRabbit‰∏≠ÁöÑÂÖÉÊï∞ÊçÆÔºàQueue, Exchange, binding, vhostÁ≠âÔºâÂ≠òÂÇ®Âú®ÂÜÖÂ≠ò‰∏≠ÔºåÊåÅ‰πÖÂåñÁöÑ Message ‰æùÊóß‰øùÂ≠òÂú®Á£ÅÁõò‰∏≠ÔºåÂÜÖÂ≠òËäÇÁÇπÁöÑÊÄßËÉΩÂè™ËÉΩ‰ΩìÁé∞Âú®ËµÑÊ∫êÁÆ°ÁêÜ‰∏äÔºåÊ∂àÊÅØÁöÑÂèëÈÄÅÂíåÊé•Êî∂ÂíåÁ£ÅÁõòËäÇÁÇπÊ≤°ÊúâÂå∫Âà´ Á£ÅÁõòËäÇÁÇπÔºöÂÖÉÊï∞ÊçÆÂ≠òÂÇ®Âú®Á£ÅÁõò‰∏≠Ôºå‰∏Ä‰∏™RabbitÈõÜÁæ§Ë¶ÅÊ±ÇËá≥Â∞ëÊúâ‰∏Ä‰∏™Á£ÅÁõòËäÇÁÇπÔºåÂõ†‰∏∫ÂÜÖÂ≠òËäÇÁÇπ‰∏≠‰∏çÂ≠òÂÇ®ÂÖÉÊï∞ÊçÆÔºåÊâÄ‰ª•ÊØèÊ¨°ÂÜÖÂ≠òËäÇÁÇπÂêØÂä®ÔºåÈÉΩ‰ºö‰ªéÂÖ∂‰ªñËäÇÁÇπ‰∏≠ÂêåÊ≠•ÂÖÉÊï∞ÊçÆ Âè¶Â§ñÂ¶ÇÊûúÂîØ‰∏ÄÁ£ÅÁõòÁöÑÁ£ÅÁõòËäÇÁÇπÂ¥©Ê∫É‰∫ÜÔºå‰∏çËÉΩËøõË°åÂ¶Ç‰∏ãÊìç‰ΩúÔºö ‰∏çËÉΩÂàõÂª∫ÈòüÂàó ‰∏çËÉΩÂàõÂª∫‰∫§Êç¢Âô® ‰∏çËÉΩÂàõÂª∫ÁªëÂÆö ‰∏çËÉΩÊ∑ªÂä†Áî®Êà∑ ‰∏çËÉΩÊõ¥ÊîπÊùÉÈôê ‰∏çËÉΩÊ∑ªÂä†ÂíåÂà†Èô§ÈõÜÁæ§Âá†ÁÇπ RabbitMQÈõÜÁæ§ÁöÑÂá†ÁßçÁ±ªÂûã Âçï‰∏ÄÊ®°ÂºèÔºö‰ªÖÊúâ‰∏Ä‰∏™rabbitÂÆû‰æã ÊôÆÈÄöÊ®°ÂºèÔºöÈªòËÆ§ÈõÜÁæ§Ê®°ÂºèÔºåÊØè‰∏™ËäÇÁÇπÂêÑËá™Áª¥Êä§Ëá™Â∑±ÁöÑÊï∞ÊçÆÔºå‰∏§‰∏™ËäÇÁÇπ‰ªÖÂ≠òÊúâÁõ∏ÂêåÁöÑÂÖÉÊï∞ÊçÆ„ÄÇ‰æãÂ¶ÇRabbitA Âíå RabbitBÔºåA‰∏≠Â≠òÂú® QueueAÔºåÊ∂àË¥πËÄÖÂèØ‰ª•‰ªéRabbitBÂÆû‰æã‰∏≠ÔºåËØªÂèñQueueAÁöÑÊ∂àÊÅØÔºåËøôÊó∂RabbitB‰ºö‰ªéA‰∏≠ËØªÂèñÊ∂àÊÅØÔºåËøîÂõûÁªôÊ∂àË¥πËÄÖ„ÄÇ‰ΩÜÊòØÂ¶ÇÊûúRabbitA ÂÆïÊú∫ÔºåËøôÊó∂Â∞±Êó†Ê≥ïËé∑ÂèñQueueAÁöÑÊï∞ÊçÆ‰∫Ü ÈïúÂÉèÊ®°ÂºèÔºöRabbit ‰ºöÂ∞ÜÊï∞ÊçÆÂêåÊ≠•Âà∞ÂÖ∂‰ªñËäÇÁÇπ‰∏≠ÔºåËøôÂõ∫ÁÑ∂ÊèêÈ´ò‰∫ÜÂèØÁî®ÊÄßÔºå‰ΩÜÊòØÈöè‰πãËÄåÊù•ÁöÑÈóÆÈ¢òÊòØÔºåÁ≥ªÁªüÁöÑÊÄßËÉΩ‰ºöÈôç‰Ωé„ÄÇËäÇÁÇπ‰πãÈó¥Ê∂àÊÅØÁöÑ‰º†ÈÄí‰ºöÂç†Áî®Â∏¶ÂÆΩÔºåËÄåÊØè‰∏™ËäÇÁÇπÂ≠òÂÇ®ÁöÑÊï∞ÊçÆÈáè‰ºöÂèòÂ§ß ÊôÆÈÄöÊ®°ÂºèÊàë‰ª¨ÂÖàÊù•Êê≠Âª∫ÊôÆÈÄöÊ®°ÂºèÁöÑÈõÜÁæ§ÔºåÂú®RabbitMQ‰∏≠ÔºåÊØè‰∏™ËäÇÁÇπÁöÑÂêçÂøÖÈ°ªÊòØÂîØ‰∏ÄÁöÑÔºåÈªòËÆ§‰ª• rabbit@hostname‰∏∫ËäÇÁÇπname ËÄåÊØèÂè∞ËôöÊãüÊú∫‰∏≠ÈªòËÆ§ÁöÑhostÊòØlocalhostÔºåËøôÂ∞±ÂØºËá¥‰∫ÜÊØè‰∏™ËäÇÁÇπÁöÑnameÈÉΩÊòØ rabbit@localhost 1. ‰øÆÊîπhosts‰øÆÊîπ‰∏§Âè∞‰∏ªÊú∫ÁöÑhostsÊñá‰ª∂Ôºå‰ª•‰∏ãÊòØ129ÁöÑÈÖçÁΩÆÔºåÊàë‰ª¨Êää128ÂÆö‰πâ‰∏∫FÔºå129ÂÆö‰πâ‰∏∫G 123456cat /etc/hosts127.0.0.1 G::1 G192.168.32.129 G192.168.32.128 F ‰øùËØÅFÂíåGÂèØ‰ª•pingÈÄö 2. ÂÆâË£ÖRabbitMQÂèØ‰ª•ÂèÇËÄÉ https://www.linuxprobe.com/install-rabbitmq-on-centos-7.html ÂΩìÊó∂ÂÆâË£ÖÂÆå‰∏ÄÁõ¥ÂèëÁé∞Êó†Ê≥ïËÆøÈóÆ RabbitÁöÑwebÊéßÂà∂Âè∞ÔºåÈô§‰∫ÜÂºÄÂêØÊèí‰ª∂ÔºåÂíåÊ∑ªÂä†‰∏Ä‰∏™Áî®Êà∑‰πãÂ§ñÔºåËøòÈúÄË¶ÅÊîæÂºÄÈò≤ÁÅ´Â¢ôÁöÑÁ´ØÂè£12345678firewall-cmd --add-port=4369/tcp --permanentfirewall-cmd --add-port=25672/tcp --permanentfirewall-cmd --add-port=5671-5672/tcp --permanentfirewall-cmd --add-port=15672/tcp --permanentfirewall-cmd --add-port=61613-61614/tcp --permanentfirewall-cmd --add-port=1883/tcp --permanentfirewall-cmd --add-port=8883/tcp --permanentfirewall-cmd --reload # ÈáçËΩΩÈÖçÁΩÆ 3. ÂêåÊ≠•Erlang cookieErlang VMÂ∞ÜÂ∞ùËØïÂú®RabbitMQÊúçÂä°Âô®ÂêØÂä®Êó∂ÂàõÂª∫‰∏Ä‰∏™ÈöèÊú∫ÁîüÊàêÁöÑÂÄºÔºàErlang CookieÔºâ„ÄÇÈõÜÁæ§ÁéØÂ¢É‰∏≠ÔºåÊâÄÊúâËäÇÁÇπÁöÑErlang CookieÂøÖÈ°ª‰∏ÄËá¥„ÄÇ .erlang.cookie ÈÄöÂ∏∏Âú® $HOME‰∏ãÊàñËÄÖ/var/lib/rabbitmq‰∏ã1234567# ÊâæÂà∞ÂÖ∂‰∏≠‰∏ÄÂè∞‰∏ªÊú∫ÁöÑ .erlang.cookie# ‰øÆÊîπÊùÉÈôêchmod 777 /var/lib/rabbitmq/.erlang.cookie# Êã∑Ë¥ùÂà∞Âè¶‰∏ÄÂè∞‰∏ªÊú∫scp /var/lib/rabbitmq/.erlang.cookie G:/var/lib/rabbitmq/# ÂÜçÊääÊùÉÈôê‰øÆÊîπÂõûÊù•chmod 400 /var/lib/rabbitmq/.erlang.cookie 4. Ê£ÄÊü•ËäÇÁÇπÂêç Â¶ÇÊûú‰∏§‰∏™ËäÇÁÇπÈÉΩÊòØ rabbit@localhostÔºåËøôÊòØÊó†Ê≥ïÂª∫Á´ãÈõÜÁæ§ÁöÑ ÊàëÂΩìÊó∂Â∞±ÊòØÈÅáÂà∞‰∫ÜËøô‰∏™ÈóÆÈ¢òÔºåÈúÄË¶Å‰øÆÊîπËäÇÁÇπnameÔºåÂèÇËÄÉ https://ubuntuqa.com/article/6619.html ÊàëÈááÂèñÁöÑÊñπÊ≥ïÔºö1234567vi /etc/rabbitmq/rabbitmq-env.conf# Ê∑ªÂä†Â¶Ç‰∏ãÈÖçÁΩÆNODENAME=rabbit@G# ‰øùÂ≠òÂêéÔºåÈáçÂêØrabbitmq ÁîüÊïàservice rabbitmq-server restart 5. ÁªÑÊàêÈõÜÁæ§‰∏äËø∞Ê≠•È™§ÈÉΩÊàêÂäüÂêéÔºåÊàë‰ª¨ÂèØ‰ª•ÁªÑÊàêÈõÜÁæ§‰∫Ü Ëøô‰∏™Êó∂ÂÄôÊàë‰ª¨ÂÖàÂêØÂä®rabbitmq@FÔºåÁÑ∂Âêérabbit@GÊâßË°å‰ª•‰∏ãÊìç‰ΩúÔºåÂä†ÂÖ•FÔºåÁªÑÊàêÈõÜÁæ§1234rabbitmqctl stop_app # ÂÅúÊ≠¢rabbitmqÊúçÂä°rabbitmqctl reset # Ê∏ÖÁ©∫ËäÇÁÇπÁä∂ÊÄÅrabbitmqctl join_cluster rabbit@F # Âä†ÂÖ•FÔºåÁªÑÊàêÈõÜÁæ§rabbitmqctl start_app ÈõÜÁæ§‰∏≠Ôºå‰ªªÊÑèËäÇÁÇπÂÅúÊú∫ÂêéÔºåÊâßË°å rabbitmqctl start_app Âç≥ÂèØÂÜçÊ¨°Âä†ÂÖ•ÈõÜÁæ§ Êü•ÁúãÈõÜÁæ§Áä∂ÊÄÅ rabbitmqctl cluster_status ÈïúÂÉèÊ®°Âºè‰ªªÊÑèrabbitËäÇÁÇπËæìÂÖ•ÂëΩ‰ª§ÔºåÂ∞ÜÊâÄÊúâÈòüÂàóÔºåÂêåÊ≠•Âà∞ÊâÄÊúâËäÇÁÇπ‰∏≠1rabbitmqctl set_policy ha-all "^" '&#123;"ha-mode":"all"&#125;' 12345678910111213rabbitmqctl set_policy [-p Vhost] Name Pattern Definition [Priority]-p VhostÔºö ÂèØÈÄâÂèÇÊï∞ÔºåÈíàÂØπÊåáÂÆövhost‰∏ãÁöÑqueueËøõË°åËÆæÁΩÆName: policyÁöÑÂêçÁß∞Pattern: queueÁöÑÂåπÈÖçÊ®°Âºè(Ê≠£ÂàôË°®ËææÂºè)DefinitionÔºöÈïúÂÉèÂÆö‰πâÔºåÂåÖÊã¨‰∏â‰∏™ÈÉ®ÂàÜha-mode, ha-params, ha-sync-mode ha-mode:ÊåáÊòéÈïúÂÉèÈòüÂàóÁöÑÊ®°ÂºèÔºåÊúâÊïàÂÄº‰∏∫ all/exactly/nodes allÔºöË°®Á§∫Âú®ÈõÜÁæ§‰∏≠ÊâÄÊúâÁöÑËäÇÁÇπ‰∏äËøõË°åÈïúÂÉè exactlyÔºöË°®Á§∫Âú®ÊåáÂÆö‰∏™Êï∞ÁöÑËäÇÁÇπ‰∏äËøõË°åÈïúÂÉèÔºåËäÇÁÇπÁöÑ‰∏™Êï∞Áî±ha-paramsÊåáÂÆö nodesÔºöË°®Á§∫Âú®ÊåáÂÆöÁöÑËäÇÁÇπ‰∏äËøõË°åÈïúÂÉèÔºåËäÇÁÇπÂêçÁß∞ÈÄöËøáha-paramsÊåáÂÆö ha-paramsÔºöha-modeÊ®°ÂºèÈúÄË¶ÅÁî®Âà∞ÁöÑÂèÇÊï∞ ha-sync-modeÔºöËøõË°åÈòüÂàó‰∏≠Ê∂àÊÅØÁöÑÂêåÊ≠•ÊñπÂºèÔºåÊúâÊïàÂÄº‰∏∫automaticÂíåmanualpriorityÔºöÂèØÈÄâÂèÇÊï∞ÔºåpolicyÁöÑ‰ºòÂÖàÁ∫ß ÂÖ≥‰∫éÈïúÂÉèÊ®°ÂºèÁ≠ñÁï•ÁöÑÊõ¥Â§öËØ∑ÂèÇËÄÉÂÆòÊñπÊñáÊ°£Ôºöhttps://www.rabbitmq.com/ha.html ÈõÜÁæ§ÁöÑË¥üËΩΩÂùáË°°‰∏∫‰ªÄ‰πàÊúâ‰∫ÜÈõÜÁæ§ËøòÈúÄË¶ÅË¥üËΩΩÂùáË°°Ôºü ËøôÈáåÊàëÁ∫†Áªì‰∫ÜÂ•ΩÂá†Â§©ÔºåÂéüÂõ†ÊòØÔºåÂú®ÊàëÁöÑÁêÜËß£Èáå ÈõÜÁæ§ == Ë¥üËΩΩÂùáË°°ÔºåËøôÊ†∑ÁöÑÁêÜËß£ÊòØÊúâÈóÆÈ¢òÁöÑ„ÄÇÊ≠£Ëß£ÔºöÂàÜÂ∏ÉÂºèÈõÜÁæ§‰øùËØÅÁöÑÊòØÈ´òÂèØÁî®ÔºåËÄåÂπ∂‰∏çÊòØË¥üËΩΩÂùáË°°„ÄÇ rabbitmqÊñáÊ°£‰∏≠Ôºå‰πüÂª∫ËÆÆÊàë‰ª¨‰ΩøÁî®TCPË¥üËΩΩÂùáË°°Âô®ÔºåËøôÊ†∑‰πü‰∏çÈúÄË¶ÅÂú®Êàë‰ª¨Â∫îÁî®Á®ãÂ∫èÈáåÁÆ°ÁêÜÈõÜÁæ§ÁöÑÂú∞ÂùÄ Connecting to Clusters from ClientsA client can connect as normal to any node within a cluster. If that node should fail, and the rest of the cluster survives, then the client should notice the closed connection, and should be able to reconnect to some surviving member of the cluster. Generally, it‚Äôs not advisable to bake in node hostnames or IP addresses into client applications: this introduces inflexibility and will require client applications to be edited, recompiled and redeployed should the configuration of the cluster change or the number of nodes in the cluster change. Instead, we recommend a more abstracted approach: this could be a dynamic DNS service which has a very short TTL configuration, or a plain TCP load balancer, or some sort of mobile IP achieved with pacemaker or similar technologies. In general, this aspect of managing the connection to nodes within a cluster is beyond the scope of RabbitMQ itself, and we recommend the use of other technologies designed specifically to solve these problems. ÁΩë‰∏äÊØîËæÉÂ§öÁöÑÊñπÊ°àÊòØ‰ΩøÁî® HAProxy ‰Ωú‰∏∫Ë¥üËΩΩÂùáË°°Âô®ÔºåËøôÈáåÂ§ßÂÆ∂ÂèØ‰ª•ÂèÇËÄÉ‰∏Ä‰∏ãËøô‰∏ÄÁØá HAProxy‰ªéÈõ∂ÂºÄÂßãÂà∞ÊéåÊè° ÂÖ∑‰ΩìÂÆâË£ÖÈÖçÁΩÆÁöÑÁªÜËäÇÊú¨ÊñáÂ∞±‰∏çËØ¥‰∫Ü ËøôÈáåÊàëÂèàÊ∑ªÂä†‰∫Ü‰∏ÄÂè∞ 130 ÁöÑËôöÊãüÊú∫Êù•Ë∑ë HAProxy Ë¥¥‰∏Ä‰∏ãÊàëÁöÑ haproxy.cfgÔºå‰ªÖ‰æõÂèÇËÄÉ 1234567891011121314151617181920212223242526272829globaldaemonpidfile /home/ha/haproxy/conf/haproxy.pidlog 127.0.0.1 local2defaultsmode tcpmaxconn 10000timeout connect 5stimeout client 100stimeout server 100sfrontend http-in bind *:5670 maxconn 30000 default_backend default_serversbackend default_servers balance roundrobin server F 192.168.32.128:5672 check inter 2000 rise 2 fall 3 weight 1 server G 192.168.32.129:5672 check inter 2000 rise 2 fall 3 weight 1listen stats bind *:1936 mode http stats refresh 30s #ÊØè30ÁßíÊõ¥Êñ∞ÁõëÊéßÊï∞ÊçÆ stats uri /stats #ËÆøÈóÆÁõëÊéßÈ°µÈù¢ÁöÑuri stats realm HAProxy\ Stats #ÁõëÊéßÈ°µÈù¢ÁöÑËÆ§ËØÅÊèêÁ§∫ stats auth admin:admin ÂÅöÂÆåË¥üËΩΩÂùáË°°‰πãÂêéÔºåÂèØ‰ª•Ë∑ë‰∏Ä‰∏ãÁ®ãÂ∫èÔºåÊü•Áúã‰∏Ä‰∏ãË¥üËΩΩÂùáË°°ÁöÑÊïàÊûúÔºåËøôÈáåÊàëÁöÑ10‰∏™ Connection ÊåâÁÖßÊùÉÈáç 1:1 ÂàÜÈÖçÂú®‰∫Ü‰∏§Âè∞ Rabbit ‰∏ä ÂèÇËÄÉ https://www.cnblogs.com/knowledgesea/p/6535766.htmlhttps://www.rabbitmq.com/clustering.html]]></content>
      <categories>
        <category>ÂàÜÂ∏ÉÂºè</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
        <tag>ÈõÜÁæ§</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RabbitMQ ÁêÜËß£ Exchange]]></title>
    <url>%2Fpost%2Fea1358e6.html</url>
    <content type="text"><![CDATA[Êú¨ËäÇÁõÆÊ†á ‰∫ÜËß£ AMQP Ê®°Âûã ‰∫ÜËß£ Exchange Âª∫ËÆÆÂ§ßÂÆ∂Âú®Â≠¶‰π†MQ‰πãÂâçÔºåÂÖà‰∫ÜËß£‰∏Ä‰∏ã Áîü‰∫ßËÄÖÊ∂àË¥πËÄÖÊ®°ÂûãÔºåÂèØ‰ª•ÂèÇËÄÉÊàë‰πãÂâçÁöÑ‰∏ÄÁØá Java ÁêÜËß£Áîü‰∫ßËÄÖ-Ê∂àË¥πËÄÖËÆæËÆ°Ê®°Âºè AMQP ÁÆÄ‰ªãRabbitMQ ÊòØÂÆûÁé∞‰∫Ü AMQP ÂçèËÆÆÁöÑÊ∂àÊÅØ‰∏≠Èó¥‰ª∂ÔºåÊâÄ‰ª•ËØ¥‰∏ãÈù¢ËÆ≤Âà∞Ëøô‰∫õÊ¶ÇÂøµ‰∏ç‰ªÖÈôê‰∫éRabbitMQÔºåÊâÄÊúâÂÆûÁé∞AMQP ÂçèËÆÆÁöÑÊ∂àÊÅØ‰∏≠Èó¥‰ª∂ÈÉΩÂÖ∑Â§áËøô‰∫õ AMQP Ê®°ÂûãÂõæÂ¶Ç‰∏ã PublisherÔºàÂèëÂ∏ÉËÄÖÔºâÂíå ConsumerÔºàÊ∂àË¥πËÄÖÔºâÂèØ‰ª•ÁêÜËß£‰∏∫ÊòØÊàë‰ª¨ÁöÑÂ∫îÁî®Á®ãÂ∫è ExchangeÔºà‰∫§Êç¢Êú∫ÔºâÔºåÊàë‰ª¨ÁöÑPublisher ‰ºöÂ∞ÜÊ∂àÊÅØÂÖàÊé®ÈÄÅÂà∞Exchange ÔºåExchange Á±ª‰ººÈÇÆÂ±ÄÔºå‰ªñ‰ºöÂ∞ÜÊ∂àÊÅØÂÜçË∑ØÁî±Âà∞ QueueÔºàÈòüÂàóÔºâ‰∏≠ÔºåQueue‰ºöÂ∞ÜÊ∂àÊÅØÊé®ÈÄÅÁªôConsumer Exchange Âíå Queue ‰πãÈó¥ÈÄöËøá Binding ÔºàÁªëÂÆöÔºâÂ∞Ü‰∏§ËÄÖÂÖ≥ËÅîÂà∞‰∏ÄËµ∑Ôºå‰∏Ä‰∏™Exchange ÂèØ‰ª•ÁªëÂÆöÂ§ö‰∏™QueueÔºå‰∏Ä‰∏™Queue ÂèØ‰ª•ÁªëÂÆöÂ§ö‰∏™Exchange ExchangeÂàöÂàöÊàë‰ª¨ËØ¥ExchangeÁ±ª‰ººÈÇÆÂ±Ä„ÄÇÈÇÆÂ±ÄÁöÑËØùÔºåÂΩìÁÑ∂‰ºöÊúâÂæàÂ§öÁöÑÈÇÆÈÄíÊñπÂºèÔºåÊâÄ‰ª•Êàë‰ª¨ÁöÑExchangeÊúâÂ§öÁßçÁ±ªÂûãÔºåÊØèÁßçÁ±ªÂûãÈÉΩÊúâËá™Â∑±ÁöÑÁ≠ñÁï• AMQP Êèê‰æõÂõõÁßçExchangeÁ±ªÂûã name ÈªòËÆ§È¢ÑËÆæÂêç Direct exchange (Empty string) and amq.direct Fanout exchange amq.fanout Topic exchange amq.topic Headers exchange amq.match (and amq.headers in RabbitMQ) Direct ExchangeRabbit ÊñáÊ°£‰∏≠ÁªôÂá∫ÁöÑÂÆö‰πâÁøªËØëËøáÊù•ÊòØËøôÊ†∑ÁöÑ Direct ExchangeÂü∫‰∫éRoutingKey Â∞ÜÊ∂àÊÅØ‰º†ÈÄíÂà∞ÈòüÂàó ÈÄö‰øóÁÇπËÆ≤ÊòØÂï•ÊÑèÊÄùÂë¢ÔºåÁõ¥Êé•Áúã‰ª£Á†ÅÂêß 12// Á¨¨‰∏Ä‰∏™ÂèÇÊï∞‰∏∫ExchangeÔºåÁ¨¨‰∫å‰∏™ÂèÇÊï∞Â∞±ÊòØRoutingKey rabbitTemplate.convertAndSend("user_exchange", "user_routingKey", message); Êàë‰ª¨ÂÜçÊù•ÁúãÁªëÂÆöÁöÑÊó∂ÂÄôÔºå‰πü‰ºöÂÖ≥ËÅî‰∏Ä‰∏™RoutingKey12// ÁªëÂÆöÁöÑÊó∂ÂÄô ‰πü‰ºöÂÖ≥ËÅî‰∏Ä‰∏™RoutingKeyBindingBuilder.bind(queue()).to(userExchange()).with("user_routingKey") ÂçÉË®Ä‰∏áËØ≠ÈÉΩÂú®ÂõæÈáå Default ExchangeDefault Exchange ÂÖ∂ÂÆûÊòØAMQP‰∏≠È¢ÑÂÖàÂ£∞ÊòéÁöÑÔºåÂπ∂‰∏îÂÆÉÂ±û‰∫é Direct ExchangeÔºåÈÄöÂ∏∏Êù•ËØ¥ÊØè‰∏™ExchangeÈÉΩ‰ºöÊúâËá™Â∑±ÁöÑÂêçÔºåDefault Exchange ÁöÑÂêçÊòØ &quot;&quot;. ‰ªñÊúâ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂ±ûÊÄßÔºåÂΩì‰Ω†ÊâãÂä®ÂàõÂª∫‰∏Ä‰∏™ÈòüÂàóÊó∂ÔºåMQ‰ºöËá™Âä®Â∞ÜËøô‰∏™ÈòüÂàóÁªëÂÆöÂà∞Default Exchange ‰∏äÔºåÁªëÂÆöÊó∂ RoutingKey ‰∏éÈòüÂàóÂêçÁß∞Áõ∏Âêå ËØ¥ÁöÑÂ•ΩÂÉèÊå∫ÁªïÁöÑÔºåÊù•Áúã‰∏Ä‰∏ã‰ª£Á†ÅÂêß12345// Â£∞Êòé‰∏Ä‰∏™ QueueÔºåËøô‰∏™Êó∂ÂÄôÊàë‰ª¨‰∏ç‰∏ªÂä®BindingÁöÑËØùÔºåtest_queue ‰ºöÂíåDefault Exchange ÁªëÂÆöÔºåÊ≠§Êó∂ routingKey = test_queueQueue queue = new Queue("test_queue");// ÂêëÈªòËÆ§‰∫§Êç¢Êú∫ÂèëÂ∏ÉÊ∂àÊÅØrabbitTemplate.convertAndSend("", "test_queue", message); Fanout ExchangeFanout Exchange ÂæàÁÆÄÂçïÔºåÈÄÇÂêàÂèëÂ∏ÉËÆ¢ÈòÖÂú∫ÊôØ„ÄÇ‰ªñ‰∏ç‰ΩøÁî®RoutingKeyÔºå‰ªñÂ∞ÜÊ∂àÊÅØË∑ØÁî±Âà∞ÊâÄÊúâ‰∏éÂÖ∂ÁªëÂÆöÁöÑÈòüÂàó Topic ExchangeTopic Exchange ÂèàÊòØÂü∫‰∫éRoutingKeyÊù•Ë∑ØÁî±ËΩ¨ÂèëÁöÑÔºå‰ΩÜÊòØÊúâ‰∫õ‰∏çÂêåÔºå‰∏äÂõæ Âú®‰ΩøÁî® Topic ÁöÑÊó∂ÂÄôÔºåroutingKey ÂèØ‰ª•ÊòØ *.orange.*,lazy.# ËøôÁßçË°®ËææÂºè * (Êòü) ‰ª£Ë°®‰∏Ä‰∏™ËØç. # (hash) ‰ª£Ë°®0ÊàñÂ§ö‰∏™ËØç. ÂêåÁêÜÔºåÂΩìÂèëÂ∏ÉÊ∂àÊÅØÊó∂ÁöÑ routingKey ‰∏éÂÖ∂ÂåπÈÖçÊó∂Ôºå‰ºöË∑ØÁî±Âà∞Áõ∏Â∫îÁöÑÈòüÂàó Headers ExchangeÂü∫‰∫éHeader‰∏≠ÁöÑÂ±ûÊÄßÊù•ÂåπÈÖçË∑ØÁî±ÔºåÁî±‰∫é‰∏çÊòØÂæàÂ∏∏Áî®ÔºåËøôÈáåÂ∞±‰∏çËØ¥‰∫Ü ÂèÇËÄÉ https://www.rabbitmq.com/tutorials/amqp-concepts.html]]></content>
      <categories>
        <category>ÂàÜÂ∏ÉÂºè</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
        <tag>Exchange</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Ê∫êÁ†ÅËß£Êûê ÂêåÊ≠•‰∫ãÂä°ÁöÑÂÆûÁé∞ÂéüÁêÜ]]></title>
    <url>%2Fpost%2Fff158ca0.html</url>
    <content type="text"><![CDATA[Âú®ÊúÄÂºÄÂßãÂ≠¶‰π†Spring AOPÁöÑÊó∂ÂÄôÔºåÈÇ£Êó∂ÂÄôÂè™Áü•ÈÅì‰∫ãÂä°ÊòØÂà©Áî®AOPÁÆ°ÁêÜÁöÑÔºå‰ΩÜÊòØÂπ∂Ê≤°ÊúâÁøªÁúãËøáÊ∫êÁ†ÅÔºåÂêéÊù•ÂèëÁé∞Spring‰∏çÂÖâÂèØ‰ª•ÁÆ°ÁêÜÂÖ≥Á≥ªÂûãÊï∞ÊçÆÁöÑ‰∫ãÂä°„ÄÇÁîöËá≥ÂèØ‰ª•ÂêåÊ≠•ÁÆ°ÁêÜRedisÁ≠âÂÖ∂‰ªñÊï∞ÊçÆÂ∫ìÁöÑ‰∫ãÂä°ÔºåËøôÊòØÊÄé‰πàÂÅöÂà∞ÁöÑÂë¢ÔºüÊú¨ËäÇÊàë‰ª¨‰∏ÄËµ∑Êé¢Á¥¢‰∏Ä‰∏ãSpringÁöÑ‰∫ãÂä° ÁâàÊú¨SpringBoot 2.1.6.RELEASE ÂàÜÊûêÈ¶ñÂÖàÂ¶ÇÊûúÊàë‰ª¨Ëá™Â∑±ÂÜô‰∏Ä‰∏™AOPÊù•ÁÆ°ÁêÜ‰∫ãÂä°ÁöÑËØùÔºå‰ºöÊÄé‰πàÂÅöÔºü ÊâßË°å‰ª£ÁêÜÊñπÊ≥ïÂâçÂºÄÂêØ‰∫ãÂä° ÊâßË°å‰ª£ÁêÜÁöÑÊñπÊ≥ï ÊâßË°å‰ª£ÁêÜÊñπÊ≥ïÂêéÂõûÊªöÊàñËÄÖÊèê‰∫§‰∫ãÂä° Â¶Ç‰ΩïÂÆûÁé∞Redis‰∫ãÂä°ÁöÑÂêåÊ≠•Êèê‰∫§ÂíåÂõûÊªöÔºü Spring‰∏≠ÂÖ≥‰∫é‰∫ãÂä°ÁöÑÁÆ°ÁêÜË¶ÅÊØîÊàë‰ª¨ÊÉ≥Ë±°ÁöÑÂ§çÊùÇÁöÑÂ§öÔºåÊú¨ÊñáÂè™ÂÖ≥Ê≥®ÂêåÊ≠•‰∫ãÂä°ÁöÑÂÆûÁé∞Ôºå‰∏ãÈù¢Êàë‰ª¨Êù•ÁúãÊ∫êÁ†Å TransactionAspectSupportÂú®ÁøªÁúãÊ∫êÁ†ÅÂêéÊâæÂà∞Ëøô‰∏™Á±ªÔºå‰∫ãÂä°ÂàáÈù¢ÊîØÊåÅÔºåËøô‰∏™Á±ªÂÆûÁé∞‰∫Ü‰∫ãÂä°ÁÆ°ÁêÜÁöÑÊ†∏ÂøÉÈÄªËæëÔºåÊàë‰ª¨Êù•Áúã‰∏Ä‰∏ãÊ†∏ÂøÉ‰ª£Á†Å Êàë‰ª¨ÈÄöÂ∏∏Âú®È°πÁõÆ‰∏≠‰ºö‰ΩøÁî®ÈªòËÆ§ÁöÑDataSourceTransactionManager‰∫ãÂä°ÁÆ°ÁêÜÂô® + Ê≥®Ëß£Âºè‰∫ãÂä°Ôºà‰πüÂ∞±ÊòØÂ£∞ÊòéÂºè‰∫ãÂä°ÔºâCallbackPreferringPlatformTransactionManager ÊòØSpringÊèê‰æõÁöÑÂõûË∞ÉÂºè‰∫ãÂä°ÁÆ°ÁêÜÂô®ÔºàÁî®‰∫éÁºñÁ®ãÂºè‰∫ãÂä°ÔºâÔºåËøôÈáåÊàë‰ª¨‰∏çËÆ®ËÆ∫„ÄÇ ÂèØ‰ª•ÁúãÂà∞Â£∞ÊòéÂºè‰∫ãÂä°ÁöÑÂ§ÑÁêÜÈÄªËæëÔºåÂíåÊàë‰ª¨‰∏äËø∞ÂàÜÊûêÁöÑÂü∫Êú¨‰∏ÄËá¥ÔºåÈÇ£‰πà‰ªñÊòØÂú®‰ªÄ‰πàÊó∂ÂÄôÂêåÊ≠•Â§ÑÁêÜ‰∫ÜÂÖ∂‰ªñÊï∞ÊçÆÁöÑ‰∫ãÂä°Âë¢ÔºüÁªßÁª≠Ê∑±ÂÖ•Ê∫êÁ†Å Ê∫êÁ†ÅË∑üË∏™Êàë‰ª¨‰ª•completeTransactionAfterThrowing() Ëøô‰∏™ÊñπÊ≥ï‰∏∫‰æãÔºà‰∏äÂõæÁ∫¢Ê°ÜÊ°ÜÔºâÔºåË∑üË∏™‰∏ãÂéª ÂèØ‰ª•ÁúãÂà∞ÔºåÂΩìÊàë‰ª¨ÂºÇÂ∏∏ÈúÄË¶ÅÂõûÊªöÊó∂Ôºå‰ºöË∞ÉÁî® TransactionManager.rollback()ÔºåÊàë‰ª¨ÁªßÁª≠Êù•Ë∑üË∏™Ëøô‰∏™ÊñπÊ≥ï ËøôÈáå‰ª£Á†ÅÈÄªËæëËøòÊòØÊØîËæÉÂ§öÁöÑÔºåÊàë‰ª¨Âè™ÂÖ≥Ê≥®Á∫¢Ê°ÜÈáåÁöÑ‰ª£Á†ÅÂùóÔºådoRollback‰∏≠Âè™ÂÅö‰∫ÜÊï∞ÊçÆÊ∫êÁöÑÂõûÊªöÔºåÈÇ£‰πàÂÉèRedis‰∫ãÂä°ÁöÑÊèê‰∫§ÊòØÂú®Âì™ÈáåÂÆûÁé∞ÁöÑÔºü Êàë‰ª¨Êù•Áúã‰∏Ä‰∏ã triggerAfterCompletion() ÊñπÊ≥ïÔºåÁ≠îÊ°àÈ©¨‰∏äÂ∞±Áü•ÈÅì‰∫Ü ÂêåÊ≠•‰∫ãÂä° TransactionSynchronizationManager ‰∏≠‰ºö‰ªéThreadLocal ‰∏≠Ëé∑ÂèñÂá∫ÂΩìÂâçÁ∫øÁ®ã‰∏≠ ‚ÄúÂêåÊ≠•‰∫ãÂä°‚ÄùÊé•Âè£ÈõÜÂêà ListÔºåÁÑ∂ÂêéÊé•‰∏ãÊù•ÁöÑÊìç‰ΩúÂ∞±ÊòØÈÅçÂéÜÊâÄÊúâÁöÑTransactionSynchronizationÔºåÊâßË°åsynchronization.afterCompletion(completionStatus); Êàë‰ª¨ÂèØ‰ª•Âú®TransactionSynchronizationÊé•Âè£‰∏ãÊâæÂà∞‰∏Ä‰∏™RedisÁöÑÂÆûÁé∞ ‰ª£Á†ÅÈÄªËæëÂæàÁÆÄÂçïÔºå‰∫ãÂä°Êèê‰∫§ÂàôRedis‰∫ãÂä°ÊâßË°åÔºåÂê¶ÂàôÂèñÊ∂àRedis‰∫ãÂä° ÂêåÊ≠•‰∫ãÂä°ÁöÑÊ≥®ÂÜå Êàë‰ª¨RedisTemplateÂºÄÂêØ‰∫ãÂä°ÂêéÔºå‰ºöÊâßË°åÂà∞‰∏äÂõæÁöÑdebugÂ§ÑÔºåRedisConnection ÂºÄÂêØ‰∫ãÂä°ÔºåÂπ∂Â∞ÜÂΩìÂâçConnectionÊ≥®ÂÜåÂà∞TransactionSynchronizationManager ‰∏≠ÔºåËøôÊ†∑Âú®triggerAfterCompletion Â∞±ÂèØ‰ª•ÂêåÊ≠•ÁöÑÁÆ°ÁêÜÊàë‰ª¨RedisÁöÑ‰∫ãÂä°‰∫Ü]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Ê∫êÁ†Å</tag>
        <tag>Spring</tag>
        <tag>‰∫ãÂä°</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ÁêÜËß£Ê∂àÊÅØÈòüÂàó - ‰ΩøÁî®Âú∫ÊôØÁÆÄ‰ªã]]></title>
    <url>%2Fpost%2F81e2e5c7.html</url>
    <content type="text"><![CDATA[Âú®‰πãÂâçÁöÑ Java ÁêÜËß£Áîü‰∫ßËÄÖ-Ê∂àË¥πËÄÖËÆæËÆ°Ê®°Âºè ‰∏ÄÊñá‰∏≠ÔºåÊàë‰ª¨Â≠¶‰π†‰∫ÜÁîü‰∫ßËÄÖ-Ê∂àË¥πËÄÖÊ®°ÂºèÔºåÁîü‰∫ßËÄÖÂíåÊ∂àË¥πËÄÖ‰πãÈó¥ÈÄöËøá‰∏Ä‰∏™ÁºìÂÜ≤ÈòüÂàóËøõË°åÈÄöËÆØÔºåÂç≥ÂÅöÂà∞‰∫ÜÂºÇÊ≠•Ê∂àÊÅØÂêûÂêêÔºåÂèà‰ΩøÂæóÁ®ãÂ∫èËß£ËÄ¶ ÂèØ‰ª•ËØ¥Ôºå‰ΩøÁî® MQÔºàÊ∂àÊÅØÈòüÂàóÔºâ ÂèØ‰ª•Âú®ÂàÜÂ∏ÉÂºèÁéØÂ¢É‰∏≠ÂÆûÁé∞Áîü‰∫ßËÄÖ-Ê∂àË¥πËÄÖÊ®°Âºè ÈÄÇÂêàMQ‰ΩøÁî®ÁöÑÂú∫ÊôØ Ê∂àÊÅØÁöÑÂèëÈÄÅËÄÖÂíåÊ∂àË¥πËÄÖÈúÄË¶ÅËß£ËÄ¶ÁöÑÊÉÖÂÜµ ÂºÇÊ≠•Â§ÑÁêÜ Â§ö‰∏™Ê∂àË¥πËÄÖÔºàÊ∂àÊÅØÁöÑÂÖ≥Ê≥®ËÄÖ‰∏çÊ≠¢‰∏Ä‰∏™Ôºâ Ê∂àË¥πËÄÖÁöÑÂ§ÑÁêÜÁªìÊûú‰∏çËøîÂõûÁªôÂèëÈÄÅËÄÖ Ôºà‰ª•RabbitMQ‰∏∫‰æãÔºåËôΩÁÑ∂ÂèØ‰ª•ÂÅöÂà∞RPCË∞ÉÁî®Ôºå‰ΩÜÊòØËøôÁßçË∞ÉÁî®‰ºöÂ∏¶Êù•Êõ¥Â§öÁöÑÈ∫ªÁÉ¶Ôºâ ÂâäÂ≥∞Â°´Ë∞∑ ‰∏ãÈù¢ÊàëË∑üËØ¶ÁªÜÂàÜÊûê‰∏Ä‰∏ãÂêÑÁßç‰ΩøÁî®Âú∫ÊôØ Ëß£ËÄ¶ ÂÖ∂ÂÆûÂæàÂ•ΩÁêÜËß£ÔºåÂõ†‰∏∫Áîü‰∫ßËÄÖÂíåÊ∂àË¥πËÄÖÈÄöËøáMQËøõË°åÈÄöËÆØÔºåÂèØ‰ª•ËØ¥‰∏§ËÄÖÊ≤°Êúâ‰ªÄ‰πàÁõ¥Êé•ÁöÑÁìúËëõÔºåÂøÖÁÑ∂Ëß£ËÄ¶ ÂºÇÊ≠• &amp;&amp; Â§ö‰∏™Ê∂àË¥πËÄÖÁîü‰∫ßËÄÖÂè™Ë¥üË¥£ÊääÊ∂àÊÅØÂèëÂ∏ÉÔºåÂπ∂Âú®ÊÑèË∞ÅÂ§ÑÁêÜÊ∂àÊÅØÔºåÂèØËÉΩ‰ºöÊúâÂ§ö‰∏™Ê∂àË¥πËÄÖÂ§ÑÁêÜËØ•Ê∂àÊÅØ ‰æãÂ¶ÇÁî®Êà∑Ê≥®ÂÜåÔºåÊàë‰ª¨‰ºöÁªôÁî®Êà∑ÂèëÈÄÅÊ≥®ÂÜåÈÇÆ‰ª∂ÂíåÁü≠‰ø°ÔºàÂèØ‰ª•ÊääÈÇÆ‰ª∂ÂíåÁü≠‰ø°ÁêÜËß£‰∏∫Â§ö‰∏™Ê∂àË¥πËÄÖÊúçÂä°Ôºâ ÂèØ‰ª•ÁúãÂà∞Âú®‰ΩøÁî®‰∫ÜMQÔºåÂç≥ÂèØ‰ª•ÈÄöËøáÂºÇÊ≠•Â§ÑÁêÜÁöÑÊñπÂºèÔºåÈôç‰ΩéÂìçÂ∫îÊó∂Èó¥ÔºåÂèàÂèØ‰ª•Èôç‰Ωé‰∏öÂä°‰πãÈó¥ÁöÑËÄ¶ÂêàÂ∫¶ Ê∂àË¥πËÄÖÁöÑÂ§ÑÁêÜÁªìÊûú‰∏çËøîÂõûÁªôÂèëÈÄÅËÄÖÁ∫øÁ®ãÊ±†ÂíåMQÈÉΩÂèØ‰ª•ÁúãÊàê Áîü‰∫ßËÄÖ-Ê∂àË¥πËÄÖÊ®°ÂºèÁöÑÂÆûÁé∞ÔºåËÄåËøô‰∏§ËÄÖ‰πüÈÉΩÂèØ‰ª•Ëé∑ÂæóÊ∂àË¥πËÄÖÁöÑËøîÂõûÂÄº„ÄÇ‰ΩÜÊòØÂ¶ÇÊûú‰Ω†ËøôÊ†∑ÂÅöÁöÑËØùÔºå‰Ω†ÁöÑÁîü‰∫ßËÄÖÁ∫øÁ®ã‰ºöÈòªÂ°ûÔºàÁ≠âÂæÖÊ∂àË¥πËÄÖÁöÑËøîÂõûÔºâÔºåÊ≤°Ê≥ïÂÅöÂà∞ÂÆåÂÖ®ÂºÇÊ≠•ÁöÑÂ§ÑÁêÜÔºåÊúâ‰∫õËøùËÉå‰∫ÜÁîü‰∫ßËÄÖ-Ê∂àË¥πËÄÖÊ®°ÂºèÁöÑÂàùË°∑„ÄÇËÄå‰∏îËøòË¶ÅËÄÉËôëÁ≠âÂæÖË∂ÖÊó∂ÂêéÁöÑÂ§ÑÁêÜ„ÄÇ‰ΩÜÊòØ‰∏çËÉΩËØ¥ËøôÁßçÁî®Ê≥ïÊòØ‰∏çÂØπÁöÑÔºåÂÖ∑‰Ωì‰∏öÂä°ÂÖ∑‰ΩìÂàÜÊûê ÂâäÂ≥∞Â°´Ë∞∑‰Ωï‰∏∫ÂâäÂ≥∞Â°´Ë∞∑ÔºåÂèØ‰ª•ÁêÜËß£‰∏∫ÊµÅÈáèÊéßÂà∂„ÄÇ‰æãÂ¶ÇÂú®Êä¢Á•®ÔºåÁßíÊùÄÁ≠â‰∏öÂä°Âú∫ÊôØÊó∂ÔºåÂèØËÉΩ‰ºöÁ™ÅÁÑ∂ÊúâÂ§ßÈáèÁöÑËØ∑Ê±ÇÊ∂åÂÖ•„ÄÇ‰ΩÜÊòØÊàë‰ª¨ÁöÑÊúçÂä°Âô®ËµÑÊ∫êÊúâÈôêÔºåÂπ∂‰∏çËÉΩÂ§ÑÁêÜËøô‰πàÂ§öÁöÑËØ∑Ê±ÇÔºåÊ≠§Êó∂ÂèØ‰ª•‰ΩøÁî® MQËøõË°åÊµÅÈáèÊéßÂà∂ Âõ†‰∏∫ÔºåËØ∑Ê±ÇÈÉΩÁºìÂ≠òÂú®‰∫ÜMQ‰∏≠Ôºå‰∏ãÊ∏∏ÊúçÂä°ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÁöÑÈÄüÂ∫¶ËøõË°åÂ§ÑÁêÜ„ÄÇ ÂèÇËÄÉ https://www.kancloud.cn/cosmicyang/rabbitmq/824050]]></content>
      <categories>
        <category>ÂàÜÂ∏ÉÂºè</category>
      </categories>
      <tags>
        <tag>MQ</tag>
        <tag>Ê∂àÊÅØÈòüÂàó</tag>
        <tag>Áîü‰∫ßËÄÖÊ∂àË¥πËÄÖ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java ÁêÜËß£ ThreadPoolExecutor ÂÆûÁé∞ÂéüÁêÜ]]></title>
    <url>%2Fpost%2Fa5233273.html</url>
    <content type="text"><![CDATA[‰ΩøÁî®Á∫øÁ®ãÊ±†ÔºàThreadPoolExecutorÔºâÁöÑÂ•ΩÂ§ÑÊòØÂáèÂ∞ëÂú®ÂàõÂª∫ÂíåÈîÄÊØÅÁ∫øÁ®ã‰∏äÊâÄËä±ÁöÑÊó∂Èó¥‰ª•ÂèäÁ≥ªÁªüËµÑÊ∫êÁöÑÂºÄÈîÄÔºåËß£ÂÜ≥ËµÑÊ∫ê‰∏çË∂≥ÁöÑÈóÆÈ¢ò„ÄÇÂ¶ÇÊûú‰∏ç‰ΩøÁî®Á∫øÁ®ãÊ±†ÔºåÊúâÂèØËÉΩÈÄ†ÊàêÁ≥ªÁªüÂàõÂª∫Â§ßÈáèÂêåÁ±ªÁ∫øÁ®ãËÄåÂØºËá¥Ê∂àËÄóÂÆåÂÜÖÂ≠òÊàñËÄÖ‚ÄúËøáÂ∫¶ÂàáÊç¢‚ÄùÁöÑÈóÆÈ¢ò„ÄÇ ‚Äì ÈòøÈáåJavaÂºÄÂèëÊâãÂÜå ÁâàÊú¨JDK 1.8 Êú¨ËäÇÁõÆÊ†á ÁêÜËß£Á∫øÁ®ãÊ±†Ê†∏ÂøÉÂèÇÊï∞ ÁêÜËß£Á∫øÁ®ãÊ±†Â∑•‰ΩúÂéüÁêÜ ÁêÜËß£Á∫øÁ®ãÊ±†Ê†∏ÂøÉÊñπÊ≥ï Á∫øÁ®ãÊ±†ÁöÑÊ†∏ÂøÉÂèÇÊï∞ÂíåÊûÑÈÄ†ÊñπÊ≥ïctl12345678910111213141516171819202122232425262728293031323334353637// Á∫øÁ®ãÊ±†Ê†∏ÂøÉÂèòÈáèÔºåÂåÖÂê´Á∫øÁ®ãÊ±†ÁöÑËøêË°åÁä∂ÊÄÅÂíåÊúâÊïàÁ∫øÁ®ãÊï∞ÔºåÂà©Áî®‰∫åËøõÂà∂ÁöÑ‰ΩçÊé©Á†ÅÂÆûÁé∞private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));private static final int COUNT_BITS = Integer.SIZE - 3;private static final int CAPACITY = (1 &lt;&lt; COUNT_BITS) - 1;// runState is stored in the high-order bits// Á∫øÁ®ãÊ±†Áä∂ÊÄÅprivate static final int RUNNING = -1 &lt;&lt; COUNT_BITS;private static final int SHUTDOWN = 0 &lt;&lt; COUNT_BITS;private static final int STOP = 1 &lt;&lt; COUNT_BITS;private static final int TIDYING = 2 &lt;&lt; COUNT_BITS;private static final int TERMINATED = 3 &lt;&lt; COUNT_BITS;// Packing and unpacking ctl// Ëé∑ÂèñÂΩìÂâçÁ∫øÁ®ãÊ±†ËøêË°åÁä∂ÊÄÅprivate static int runStateOf(int c) &#123; return c &amp; ~CAPACITY; &#125;// Ëé∑ÂèñÂΩìÂâçÁ∫øÁ®ãÊ±†ÊúâÊïàÁ∫øÁ®ãÊï∞private static int workerCountOf(int c) &#123; return c &amp; CAPACITY; &#125;// ÊâìÂåÖctlÂèòÈáèprivate static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125;/* * Bit field accessors that don't require unpacking ctl. * These depend on the bit layout and on workerCount being never negative. */private static boolean runStateLessThan(int c, int s) &#123; return c &lt; s;&#125;private static boolean runStateAtLeast(int c, int s) &#123; return c &gt;= s;&#125;private static boolean isRunning(int c) &#123; return c &lt; SHUTDOWN;&#125; JDK7 ‰ª•ÂêéÔºåÁ∫øÁ®ãÊ±†ÁöÑÁä∂ÊÄÅÂíåÊúâÊïàÁ∫øÁ®ãÊï∞ÈÄöËøá ctl Ëøô‰∏™ÂèòÈáèË°®Á§∫Ôºà‰ΩøÁî®‰∫åËøõÂà∂ÁöÑ‰ΩçÊé©Á†ÅÊù•ÂÆûÁé∞ÔºåËøôÈáåÊàë‰ª¨‰∏çÊ∑±Á©∂ÔºâÔºåÁêÜËß£‰∏äËø∞Âá†‰∏™ÊñπÊ≥ï‰ΩúÁî®Âç≥ÂèØÔºå‰∏çÂΩ±Âìç‰∏ãÈù¢ÁöÑÊ∫êÁ†ÅÈòÖËØª ÂÖ≥‰∫éÁ∫øÁ®ãÊ±†ÁöÑ‰∫îÁßçÁä∂ÊÄÅ RUNNINGÔºöÊé•ÂèóÊñ∞‰ªªÂä°Âπ∂Â§ÑÁêÜÈòüÂàó‰∏≠ÁöÑ‰ªªÂä° SHUTDOWN Ôºö‰∏çÊé•ÂèóÊñ∞‰ªªÂä°Ôºå‰ΩÜÂ§ÑÁêÜÈòüÂàó‰∏≠ÁöÑ‰ªªÂä° STOP Ôºö‰∏çÊé•ÂèóÊñ∞‰ªªÂä°Ôºå‰∏çÂ§ÑÁêÜÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°ÔºåÂπ∂‰∏≠Êñ≠Ê≠£Âú®ËøõË°åÁöÑ‰ªªÂä°Ôºà‰∏≠Êñ≠Âπ∂‰∏çÊòØÂº∫Âà∂ÁöÑÔºåÂè™ÊòØ‰øÆÊîπ‰∫ÜThreadÁöÑÁä∂ÊÄÅÔºåÊòØÂê¶‰∏≠Êñ≠ÂèñÂÜ≥‰∫éRunnable ÁöÑÂÆûÁé∞ÈÄªËæëÔºâ TIDYING ÔºöÊâÄÊúâ‰ªªÂä°ÈÉΩÂ∑≤ÁªàÊ≠¢ÔºåworkerCount‰∏∫0Êó∂ÔºåÁ∫øÁ®ãÊ±†‰ºöËøáÂ∫¶Âà∞ËØ•Áä∂ÊÄÅÔºåÂπ∂Âç≥Â∞ÜË∞ÉÁî® terminate() TERMINATED Ôºöterminated() Ë∞ÉÁî®ÂÆåÊàêÔºõÁ∫øÁ®ãÊ±†‰∏≠Ê≠¢ Á∫øÁ®ãÊ±†Áä∂ÊÄÅÁöÑËΩ¨Êç¢ RUNNING =&gt; SHUTDOWN ÔºöË∞ÉÁî® shutdown() RUNNING / SHUTDOWN =&gt; STOP ÔºöË∞ÉÁî® shutdownNow() ÔºàËØ•ÊñπÊ≥ï‰ºöËøîÂõûÈòüÂàó‰∏≠Êú™ÊâßË°åÁöÑ‰ªªÂä°Ôºâ SHUTDOWN =&gt; TIDYINGÔºö ÂΩìÁ∫øÁ®ãÊ±†ÂíåÈòüÂàóÈÉΩ‰∏∫Á©∫Êó∂ STOP =&gt; TIDYINGÔºöÂΩìÁ∫øÁ®ãÊ±†‰∏∫Á©∫Êó∂ TIDYING =&gt; TERMINATEDÔºöÂΩì terminated() Ë∞ÉÁî®ÂÆåÊàêÊó∂ ÊûÑÈÄ†ÊñπÊ≥ïÁ∫øÁ®ãÊ±†ÊúÄÁªàÈÉΩÊòØË∞ÉÁî®Â¶Ç‰∏ãÊûÑÈÄ†ÊñπÊ≥ï123456789public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) &#123; // ÁúÅÁï•&#125; Ê†∏ÂøÉÂèÇÊï∞Êàë‰ª¨Êù•Áúã‰∏Ä‰∏ãÁ∫øÁ®ãÊ±†‰∏≠ÁöÑÊ†∏ÂøÉÂèÇÊï∞ÈÉΩÊòØ‰ªÄ‰πà‰ΩúÁî®123456789101112131415161718192021222324private final BlockingQueue&lt;Runnable&gt; workQueue; // ÈòªÂ°ûÈòüÂàóÔºåÁî®‰∫éÁºìÂ≠ò‰ªªÂä°private final ReentrantLock mainLock = new ReentrantLock(); // Á∫øÁ®ãÊ±†‰∏ªÈîÅprivate final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;(); // Â∑•‰ΩúÁ∫øÁ®ãÈõÜÂêàprivate final Condition termination = mainLock.newCondition(); // awaitTermination() ÊñπÊ≥ïÁöÑÁ≠âÂæÖÊù°‰ª∂private int largestPoolSize; // ËÆ∞ÂΩïÊúÄÂ§ßÁ∫øÁ®ãÊ±†Â§ßÂ∞èprivate long completedTaskCount; //Áî®Êù•ËÆ∞ÂΩïÁ∫øÁ®ãÊ±†‰∏≠ÊõæÁªèÂá∫Áé∞ËøáÁöÑÊúÄÂ§ßÁ∫øÁ®ãÊï∞private volatile ThreadFactory threadFactory; // Á∫øÁ®ãÂ∑•ÂéÇÔºåÁî®‰∫éÂàõÂª∫Á∫øÁ®ãprivate volatile RejectedExecutionHandler handler; // ‰ªªÂä°ÊãíÁªùÊó∂ÁöÑÁ≠ñÁï•private volatile long keepAliveTime; // Á∫øÁ®ãÂ≠òÊ¥ªÊó∂Èó¥ // ÂΩìÁ∫øÁ®ãÊï∞Ë∂ÖËøáÊ†∏ÂøÉÊ±†Êï∞Êó∂ÔºåÊàñÂÖÅËÆ∏Ê†∏ÂøÉÊ±†Á∫øÁ®ãË∂ÖÊó∂ÔºåËØ•ÂèÇÊï∞‰ºöËµ∑‰ΩúÁî®„ÄÇÂê¶Âàô‰∏ÄÁõ¥‰ºöÁ≠âÂæÖÊñ∞ÁöÑ‰ªªÂä°private volatile boolean allowCoreThreadTimeOut; // ÊòØÂê¶ÂÖÅËÆ∏Ê†∏ÂøÉÊ±†Á∫øÁ®ãË∂ÖÊó∂private volatile int corePoolSize; // Ê†∏ÂøÉÁ∫øÁ®ãÊ±†Êï∞Èáèprivate volatile int maximumPoolSize; // ÊúÄÂ§ßÁ∫øÁ®ãÊ±†Êï∞Èáè workQueueËøô‰∏™ÈòüÂàóÁöÑ‰ΩúÁî®ÔºåÂíå‰πãÂâçÁöÑ Java ÁêÜËß£Áîü‰∫ßËÄÖ-Ê∂àË¥πËÄÖËÆæËÆ°Ê®°Âºè ‰∏≠ËÆ≤Âà∞ÁöÑÁºìÂÜ≤ÈòüÂàóÔºå‰ΩúÁî®ÂæàÁõ∏‰ººÔºåÊàñËÄÖËØ¥Á∫øÁ®ãÊ±†Â∞±ÊòØÁîü‰∫ßËÄÖÊ∂àË¥πËÄÖÊ®°ÂºèÁöÑ‰∏ÄÁßçÂÆûÁé∞„ÄÇ ÂÖ≥‰∫é handler ThreadPoolExecutor.AbortPolicy:‰∏¢ÂºÉ‰ªªÂä°Âπ∂ÊäõÂá∫RejectedExecutionExceptionÂºÇÂ∏∏„ÄÇ ThreadPoolExecutor.DiscardPolicyÔºö‰πüÊòØ‰∏¢ÂºÉ‰ªªÂä°Ôºå‰ΩÜÊòØ‰∏çÊäõÂá∫ÂºÇÂ∏∏„ÄÇ ThreadPoolExecutor.DiscardOldestPolicyÔºö‰∏¢ÂºÉÈòüÂàóÊúÄÂâçÈù¢ÁöÑ‰ªªÂä°ÔºåÁÑ∂ÂêéÈáçÊñ∞Â∞ùËØïÊâßË°å‰ªªÂä°ÔºàÈáçÂ§çÊ≠§ËøáÁ®ãÔºâ ThreadPoolExecutor.CallerRunsPolicyÔºöÂΩìÂâç‰ªªÂä°Ëá™Â∑±ÂÜ≥ÂÆö corePoolSize Âíå maximumPoolSizeÂ¶ÇÊûú‰Ω†ÂØπËøô‰∏§‰∏™ÂèÇÊï∞ÊúâÁñëÈóÆÔºåÁúãÂÆå‰∏ãÈù¢ÁöÑÊ†óÂ≠ê‰Ω†‰ºöÊ∏ÖÊô∞ÂæàÂ§ö ‰∏ãÈù¢Êàë‰ª¨Êù•‰∏æ‰∏™Ê†óÂ≠êÊù•Êõ¥Â•ΩÁöÑÁêÜËß£‰∏Ä‰∏ãÁ∫øÁ®ãÊ±† ÁêÜËß£Á∫øÁ®ãÊ±†Â∑•‰ΩúÂéüÁêÜÂÅáÂ¶ÇÊúâ‰∏Ä‰∏™Â∑•ÂéÇÔºåÂ∑•ÂéÇÈáåÈù¢Êúâ10‰∏™Â∑•‰∫∫ÔºåÊØè‰∏™Â∑•‰∫∫ÂêåÊó∂Âè™ËÉΩÂÅö‰∏Ä‰ª∂‰ªªÂä°„ÄÇ Âõ†Ê≠§Âè™Ë¶ÅÂΩì10‰∏™Â∑•‰∫∫‰∏≠ÊúâÂ∑•‰∫∫ÊòØÁ©∫Èó≤ÁöÑÔºåÊù•‰∫Ü‰ªªÂä°Â∞±ÂàÜÈÖçÁªôÁ©∫Èó≤ÁöÑÂ∑•‰∫∫ÂÅöÔºõ ÂΩì10‰∏™Â∑•‰∫∫ÈÉΩÊúâ‰ªªÂä°Âú®ÂÅöÊó∂ÔºåÂ¶ÇÊûúËøòÊù•‰∫Ü‰ªªÂä°ÔºåÂ∞±Êää‰ªªÂä°ËøõË°åÊéíÈòüÁ≠âÂæÖÔºõ ÊØè‰∏™Â∑•‰∫∫ÂÅöÂÆåËá™Â∑±ÁöÑ‰ªªÂä°ÂêéÔºå‰ºöÂéª‰ªªÂä°ÈòüÂàó‰∏≠È¢ÜÂèñÊñ∞ÁöÑ‰ªªÂä°Ôºõ Â¶ÇÊûúËØ¥Êñ∞‰ªªÂä°Êï∞ÁõÆÂ¢ûÈïøÁöÑÈÄüÂ∫¶ËøúËøúÂ§ß‰∫éÂ∑•‰∫∫ÂÅö‰ªªÂä°ÁöÑÈÄüÂ∫¶Ôºà‰ªªÂä°Á¥ØÁßØËøáÂ§öÊó∂ÔºâÔºåÈÇ£‰πàÊ≠§Êó∂Â∑•ÂéÇ‰∏ªÁÆ°ÂèØËÉΩ‰ºöÊÉ≥Ë°•ÊïëÊé™ÊñΩÔºåÊØîÂ¶ÇÈáçÊñ∞Êãõ4‰∏™‰∏¥Êó∂Â∑•‰∫∫ËøõÊù•Ôºõ ÁÑ∂ÂêéÂ∞±Â∞Ü‰ªªÂä°‰πüÂàÜÈÖçÁªôËøô4‰∏™‰∏¥Êó∂Â∑•‰∫∫ÂÅöÔºõ Â¶ÇÊûúËØ¥ÁùÄ14‰∏™Â∑•‰∫∫ÂÅö‰ªªÂä°ÁöÑÈÄüÂ∫¶ËøòÊòØ‰∏çÂ§üÔºåÊ≠§Êó∂Â∑•ÂéÇ‰∏ªÁÆ°ÂèØËÉΩÂ∞±Ë¶ÅËÄÉËôë‰∏çÂÜçÊé•Êî∂Êñ∞ÁöÑ‰ªªÂä°ÊàñËÄÖÊäõÂºÉÂâçÈù¢ÁöÑ‰∏Ä‰∫õ‰ªªÂä°‰∫Ü„ÄÇ ÂΩìËøô14‰∏™Â∑•‰∫∫ÂΩì‰∏≠Êúâ‰∫∫Á©∫Èó≤Êó∂ÔºåËÄåÊñ∞‰ªªÂä°Â¢ûÈïøÁöÑÈÄüÂ∫¶ÂèàÊØîËæÉÁºìÊÖ¢ÔºåÂ∑•ÂéÇ‰∏ªÁÆ°ÂèØËÉΩÂ∞±ËÄÉËôëËæûÊéâ4‰∏™‰∏¥Êó∂Â∑•‰∫ÜÔºåÂè™‰øùÊåÅÂéüÊù•ÁöÑ10‰∏™Â∑•‰∫∫ÔºåÊØïÁ´üËØ∑È¢ùÂ§ñÁöÑÂ∑•‰∫∫ÊòØË¶ÅËä±Èí±ÁöÑ„ÄÇ ÂºÄÂßãÂ∑•ÂéÇÁöÑ10‰∏™Â∑•‰∫∫ÔºåÂ∞±ÊòØ corePoolSize (Ê†∏ÂøÉÊ±†Êï∞Èáè)Ôºõ ÂΩì10‰∏™‰∫∫ÈÉΩÂú®Â∑•‰ΩúÊó∂ (Ê†∏ÂøÉÊ±†ËææÂà∞ corePoolSize)Ôºå‰ªªÂä°ÊéíÈòüÁ≠âÂæÖÊó∂Ôºå‰ºöÁºìÂ≠òÂà∞ workQueue ‰∏≠Ôºõ ÂΩì‰ªªÂä°Á¥ØÁßØËøáÂ§öÊó∂(ËææÂà∞ workQueue ÊúÄÂ§ßÂÄºÊó∂)ÔºåÊâæ‰∏¥Êó∂Â∑•Ôºõ 14‰∏™‰∏¥Êó∂Â∑•ÔºåÂ∞±ÊòØ maximumPoolSize (Êï∞Èáè)Ôºõ Â¶ÇÊûúÊ≠§Êó∂Â∑•‰ΩúÈÄüÂ∫¶ËøòÊòØ‰∏çÂ§üÔºåÁ∫øÁ®ãÊ±†ËøôÊó∂‰ºöËÄÉËôëÊãíÁªù‰ªªÂä°ÔºåÂÖ∑‰ΩìÁî±ÊãíÁªùÁ≠ñÁï•ÂÜ≥ÂÆö ÁêÜËß£Á∫øÁ®ãÊ±†Ê†∏ÂøÉÊñπÊ≥ïexecute()Á∫øÁ®ãÊ±†‰∏≠ÊâÄÊúâÊâßË°å‰ªªÂä°ÁöÑÊñπÊ≥ïÊúâÂÖ≥ÁöÑÊñπÊ≥ïÔºåÈÉΩ‰ºöË∞ÉÁî® execute()„ÄÇÂ¶ÇÊûú‰Ω†ÁêÜËß£‰∫Ü‰∏äËø∞ÁöÑÂ∞è‰æãÂ≠êÔºåÂÜçÊù•ÁúãËøô‰∏™‰ºöÊ∏ÖÊô∞ÂæàÂ§ö123456789101112131415161718192021222324252627282930313233343536373839public void execute(Runnable command) &#123; if (command == null) throw new NullPointerException(); /* * Proceed in 3 steps: * * 1. If fewer than corePoolSize threads are running, try to * start a new thread with the given command as its first * task. The call to addWorker atomically checks runState and * workerCount, and so prevents false alarms that would add * threads when it shouldn't, by returning false. * * 2. If a task can be successfully queued, then we still need * to double-check whether we should have added a thread * (because existing ones died since last checking) or that * the pool shut down since entry into this method. So we * recheck state and if necessary roll back the enqueuing if * stopped, or start a new thread if there are none. * * 3. If we cannot queue task, then we try to add a new * thread. If it fails, we know we are shut down or saturated * and so reject the task. */ int c = ctl.get(); if (workerCountOf(c) &lt; corePoolSize) &#123; if (addWorker(command, true)) return; c = ctl.get(); &#125; if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; int recheck = ctl.get(); if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); else if (workerCountOf(recheck) == 0) addWorker(null, false); &#125; else if (!addWorker(command, false)) reject(command);&#125; ÂàÜÊûêexecute() step 1 1ÔºâÈ¶ñÂÖàÊ£ÄÊü•ÂΩìÂâçÊúâÊïàÁ∫øÁ®ãÊï∞ ÊòØÂê¶Â∞è‰∫é Ê†∏ÂøÉÊ±†Êï∞Èáèif (workerCountOf(c) &lt; corePoolSize) 2ÔºâÂ¶ÇÊûúÊª°Ë∂≥‰∏äËø∞Êù°‰ª∂ÔºåÂàôÂ∞ùËØïÂêëÊ†∏ÂøÉÊ±†Ê∑ªÂä†‰∏Ä‰∏™Â∑•‰ΩúÁ∫øÁ®ã ÔºàaddWorker() Á¨¨‰∫å‰∏™ÂèÇÊï∞ÂÜ≥ÂÆö‰∫ÜÊòØÊ∑ªÂä†Ê†∏ÂøÉÊ±†ÔºåËøòÊòØÊúÄÂ§ßÊ±†Ôºâif (addWorker(command, true)) 3ÔºâÂ¶ÇÊûúÊàêÂäüÂàôÈÄÄÂá∫ÊñπÊ≥ïÔºåÂê¶ÂàôÂ∞ÜÊâßË°å step2 step 2 1ÔºâÂ¶ÇÊûúÂΩìÂâçÁ∫øÁ®ãÊ±†Â§Ñ‰∫éËøêË°åÁä∂ÊÄÅ &amp;&amp; Â∞ùËØïÂêëÁºìÂÜ≤ÈòüÂàóÊ∑ªÂä†‰ªªÂä°if (isRunning(c) &amp;&amp; workQueue.offer(command)) 2ÔºâÂ¶ÇÊûúÁ∫øÁ®ãÊ±†Ê≠£Âú®ËøêË°åÂπ∂‰∏îÁºìÂÜ≤ÈòüÂàóÊ∑ªÂä†‰ªªÂä°ÊàêÂäüÔºåËøõË°å double checkÔºàÂÜçÊ¨°Ê£ÄÊü•Ôºâ 3ÔºâÂ¶ÇÊûúÊ≠§Êó∂Á∫øÁ®ãÊ±†ÈùûËøêË°åÁä∂ÊÄÅ =&gt; ÁßªÈô§ÈòüÂàó =&gt; ÊãíÁªùÂΩìÂâç‰ªªÂä°ÔºåÈÄÄÂá∫ÊñπÊ≥ïÔºàËøô‰πàÂÅöÊòØ‰∏∫‰∫ÜÔºåÂΩìÁ∫øÁ®ãÊ±†‰∏çÂèØÁî®Êó∂ÂèäÊó∂ÂõûÊªöÔºâ 12if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); 4ÔºâÂ¶ÇÊûúÂΩìÂâçÊúâÊïàÁ∫øÁ®ãÊï∞‰∏∫0ÔºåÂàôÂàõÂª∫‰∏Ä‰∏™Êó†‰ªªÂä°ÁöÑÂ∑•‰ΩúÁ∫øÁ®ãÔºàÊ≠§Êó∂Ëøô‰∏™Á∫øÁ®ã‰ºöÂéªÈòüÂàó‰∏≠Ëé∑Âèñ‰ªªÂä°Ôºâ step 3 1ÔºâÂΩìÊó†Ê≥ïÊó†Ê≥ïÂêëÊ†∏ÂøÉÊ±†ÂíåÈòüÂàó‰∏≠Ê∑ªÂä†‰ªªÂä°Êó∂ÔºåÁ∫øÁ®ãÊ±†‰ºöÂÜçÂ∞ùËØïÂêëÊúÄÂ§ßÊ±†‰∏≠Ê∑ªÂä†‰∏Ä‰∏™Â∑•‰ΩúÁ∫øÁ®ãÔºåÂ¶ÇÊûúÂ§±Ë¥•ÂàôÊãíÁªùËØ•‰ªªÂä° 12else if (!addWorker(command, false)) reject(command); ÂõæËß£execute()Ê†πÊçÆ‰∏äËø∞ÁöÑÊ≠•È™§Áîª‰∫ÜÂ¶Ç‰∏ãÁöÑËøô‰∏™ÂõæÔºåÂ∏åÊúõËÉΩÂ∏ÆÂä©Â§ßÂÆ∂Êõ¥Â•ΩÁöÑÁêÜËß£ addWorker()Âú®ÂàÜÊûêexecute() ÊñπÊ≥ïÊó∂ÔºåÊàë‰ª¨Â∑≤ÁªèÁü•ÈÅì‰∫Ü addWorker() ÁöÑ‰ΩúÁî®‰∫ÜÔºåÂèØ‰ª•ÂêëÊ†∏ÂøÉÊ±†ÊàñËÄÖÊúÄÂ§ßÊ±†Ê∑ªÂä†‰∏Ä‰∏™Â∑•‰ΩúÁ∫øÁ®ã„ÄÇÊàë‰ª¨Êù•Áúã‰∏Ä‰∏ãËøô‰∏™ÊñπÊ≥ïÈÉΩÂÅö‰∫Ü‰ªÄ‰πà 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566private boolean addWorker(Runnable firstTask, boolean core) &#123; retry: for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; for (;;) &#123; int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125; &#125; boolean workerStarted = false; boolean workerAdded = false; Worker w = null; try &#123; w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); workers.add(w); int s = workers.size(); if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; t.start(); workerStarted = true; &#125; &#125; &#125; finally &#123; if (! workerStarted) addWorkerFailed(w); &#125; return workerStarted;&#125; Ëøô‰∏™ÊñπÊ≥ï‰ª£Á†ÅÁúã‰ººÂæàÂ§çÊùÇÔºåÊ≤°ÂÖ≥Á≥ªÔºåÊàë‰ª¨‰∏ÄÊ≠•‰∏ÄÊ≠•Êù•ÂàÜÊûê step 1ÂÖàÁúãÁ¨¨‰∏ÄÈÉ®ÂàÜ 12345678910111213141516171819202122232425retry:for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; for (;;) &#123; int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125;&#125; Ëøô‰∏ÄÈÉ®ÂàÜ‰ª£Á†ÅÔºå‰∏ªË¶ÅÊòØÂà§Êñ≠ÔºåÊòØÂê¶ÂèØ‰ª•Ê∑ªÂä†‰∏Ä‰∏™Â∑•‰ΩúÁ∫øÁ®ã„ÄÇ Âú®execute()‰∏≠Â∑≤ÁªèÂà§Êñ≠Ëøáif (workerCountOf(c) &lt; corePoolSize)‰∫ÜÔºå‰∏∫‰ªÄ‰πàËøòË¶ÅÂÜçÂà§Êñ≠Ôºü Âõ†‰∏∫Âú®Â§öÁ∫øÁ®ãÁéØÂ¢É‰∏≠ÔºåÂΩì‰∏ä‰∏ãÊñáÂàáÊç¢Âà∞ËøôÈáåÁöÑÊó∂ÂÄôÔºåÂèØËÉΩÁ∫øÁ®ãÊ±†Â∑≤ÁªèÂÖ≥Èó≠‰∫ÜÔºåÊàñËÄÖÂÖ∂‰ªñÁ∫øÁ®ãÊèê‰∫§‰∫Ü‰ªªÂä°ÔºåÂØºËá¥workerCountOf(c) &gt; corePoolSize 1ÔºâÈ¶ñÂÖàËøõÂÖ•Á¨¨‰∏Ä‰∏™Êó†ÈôêforÂæ™ÁéØÔºåËé∑ÂèñctlÂØπË±°ÔºåËé∑ÂèñÂΩìÂâçÁ∫øÁ®ãÁöÑËøêË°åÁä∂ÊÄÅÔºåÁÑ∂ÂêéÂà§Êñ≠12345if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; Ëøô‰∏™Âà§Êñ≠ÁöÑÊÑè‰πâ‰∏∫ÔºåÂΩìÁ∫øÁ®ãÊ±†ËøêË°åÁä∂ÊÄÅ &gt;= SHUTDOWN Êó∂ÔºåÂêëÊ∑ªÂä†‰∏Ä‰∏™Â∑•‰ΩúÁ∫øÁ®ãÂøÖÈ°ªÂêåÊó∂Êª°Ë∂≥ rs == SHUTDOWN firstTask == null ! workQueue.isEmpty()‰∏â‰∏™Êù°‰ª∂ÔºåÂê¶ÂàôÊ∑ªÂä†Á∫øÁ®ãÂ§±Ë¥• ÊâÄ‰ª•ÂΩìÁ∫øÁ®ãÁä∂ÊÄÅ‰∏∫SHUTDOWNÊó∂ÔºåÁ∫øÁ®ãÊ±†ÂÖÅËÆ∏Ê∑ªÂä†‰∏Ä‰∏™Êó†‰ªªÂä°ÁöÑÂ∑•‰ΩúÁ∫øÁ®ãÂéªÊâßË°åÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°„ÄÇ 2ÔºâËøõÂÖ•Á¨¨‰∫å‰∏™Êó†ÈôêforÂæ™ÁéØ 123456789101112for (;;) &#123; int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop&#125; Ëé∑ÂèñÂΩìÂâçÊúâÊïàÁ∫øÁ®ãÊï∞Ôºåif ÊúâÊïàÁ∫øÁ®ãÊï∞ &gt;= ÂÆπÈáè || ÊúâÊïàÁ∫øÁ®ãÊï∞ &gt;= Ê†∏ÂøÉÊ±†Êï∞Èáè/ÊúÄÂ§ßÊ±†Êï∞ÈáèÔºåÂàôreturn false; Ê∑ªÂä†Á∫øÁ®ãÂ§±Ë¥• Â¶ÇÊûúÊúâÊïàÁ∫øÁ®ãÊï∞Âú®ÂêàÁêÜËåÉÂõ¥‰πãÂÜÖÔºåÂ∞ùËØï‰ΩøÁî® CAS Ëá™Â¢ûÊúâÊïàÁ∫øÁ®ãÊï∞ ÔºàCAS ÊòØJava‰∏≠ÁöÑ‰πêËßÇÈîÅÔºå‰∏ç‰∫ÜËß£ÁöÑÂ∞è‰ºô‰º¥ÂèØ‰ª•Google‰∏Ä‰∏ãÔºâÔºå‰πêËßÇÈîÅËá™Â¢ûÊàêÂäüÔºå‰ª£Ë°®ÂΩìÂâçÊó†ÂÖ∂‰ªñÁ∫øÁ®ãÁ´û‰∫âÔºåÁõ∏ÂΩì‰∫éËé∑ÂèñÂà∞ÈîÅ‰∫Ü Â¶ÇÊûúËá™Â¢ûÊàêÂäüÔºåbreak retry; Ë∑≥Âá∫Ëøô‰∏§‰∏™Âæ™ÁéØÔºåÊâßË°å‰∏ãÈù¢ÁöÑ‰ª£Á†Å Ëá™Â¢ûÂ§±Ë¥•ÔºåÊ£ÄÊü•Á∫øÁ®ãÊ±†Áä∂ÊÄÅÔºåÂ¶ÇÊûúÁ∫øÁ®ãÊ±†Áä∂ÊÄÅÂèëÁîüÂèòÂåñÔºåÂõûÂà∞Á¨¨‰∏Ä‰∏™for ÁªßÁª≠ÊâßË°åÔºõÂê¶ÂàôÁªßÁª≠Âú®Á¨¨‰∫å‰∏™for ‰∏≠Ôºõ step 2‰∏ãÈù¢ËøôÈÉ®ÂàÜÂ∞±ÊØîËæÉÁÆÄÂçï‰∫Ü 1234567891011121314151617181920212223242526272829303132333435363738boolean workerStarted = false;boolean workerAdded = false;Worker w = null;try &#123; w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); workers.add(w); int s = workers.size(); if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; t.start(); workerStarted = true; &#125; &#125;&#125; finally &#123; if (! workerStarted) addWorkerFailed(w);&#125;return workerStarted; 1ÔºâÂàõÂª∫Â∑•‰ΩúÁ∫øÁ®ãÂØπË±°WorkerÔºõ 2ÔºâÂä†ÈîÅÔºåÂà§Êñ≠ÂΩìÂâçÁ∫øÁ®ãÊ±†Áä∂ÊÄÅÊòØÂê¶ÂÖÅËÆ∏ÂêØÂä®Á∫øÁ®ãÔºõÂ¶ÇÊûúÂèØ‰ª•ÔºåÂ∞ÜÁ∫øÁ®ãÂä†ÂÖ•workersÔºàËøô‰∏™ÂèòÈáèÂú®ÈúÄË¶ÅÈÅçÂéÜÊâÄÊúâÂ∑•‰ΩúÁ∫øÁ®ãÊó∂‰ºöÁî®Âà∞ÔºâÔºåËÆ∞ÂΩïÊúÄÂ§ßÂÄºÔºåÂêØÂä®Á∫øÁ®ãÔºõ 3ÔºâÂ¶ÇÊûúÁ∫øÁ®ãÂêØÂä®Â§±Ë¥•ÔºåÊâßË°åaddWorkerFailedÔºà‰ªéworkers‰∏≠ÁßªÈô§ËØ•ÂØπË±°ÔºåÊúâÊïàÁ∫øÁ®ãÊï∞Âáè‰∏ÄÔºåÂ∞ùËØï‰∏≠Ê≠¢Á∫øÁ®ãÊ±†Ôºâ WorkerWorkerÂØπË±°ÊòØÁ∫øÁ®ãÊ±†‰∏≠ÁöÑÂÜÖÈÉ®Á±ªÔºåÁ∫øÁ®ãÁöÑÂ§çÁî®„ÄÅÁ∫øÁ®ãË∂ÖÊó∂ÈÉΩÊòØÂú®ËøôÂÆûÁé∞ÁöÑ 123456789private final class Worker extends AbstractQueuedSynchronizer implements Runnable&#123; // ËøôÈáåÊàë‰ª¨Âè™ÂÖ≥ÂøÉRun()ÔºåÁúÅÁï•‰∫ÜÂÖ∂‰ªñÊ∫êÁ†ÅÔºåÊÑüÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•Ëá™Â∑±Áúã‰∏Ä‰∏ãÊ∫êÁ†Å public void run() &#123; runWorker(this); &#125;&#125; Worker ÂÆûÁé∞‰∫Ü RunnableÔºåÊàë‰ª¨ËøôÈáåÂè™ÂÖ≥ÂøÉ Worker ÁöÑrunÊñπÊ≥ï‰∏≠ÂÅö‰∫Ü‰ªÄ‰πàÔºåÂÖ≥‰∫é AbstractQueuedSynchronizer ÊúâÂÖ≥ÁöÑ‰∏çÂú®Êú¨ÊñáËÆ®ËÆ∫ ‰∏ãÈù¢Êàë‰ª¨ÂàÜÊûê‰∏Ä‰∏ãrunWorker()1234567891011121314151617181920212223242526272829303132333435363738394041424344final void runWorker(Worker w) &#123; Thread wt = Thread.currentThread(); Runnable task = w.firstTask; w.firstTask = null; w.unlock(); // allow interrupts boolean completedAbruptly = true; try &#123; while (task != null || (task = getTask()) != null) &#123; w.lock(); // If pool is stopping, ensure thread is interrupted; // if not, ensure thread is not interrupted. This // requires a recheck in second case to deal with // shutdownNow race while clearing interrupt if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); try &#123; beforeExecute(wt, task); Throwable thrown = null; try &#123; task.run(); &#125; catch (RuntimeException x) &#123; thrown = x; throw x; &#125; catch (Error x) &#123; thrown = x; throw x; &#125; catch (Throwable x) &#123; thrown = x; throw new Error(x); &#125; finally &#123; afterExecute(task, thrown); &#125; &#125; finally &#123; task = null; w.completedTasks++; w.unlock(); &#125; &#125; // ÈÄöËøáËØ•ÂèòÈáèÂà§Êñ≠ÊòØÁî®Êà∑‰ªªÂä°ÊäõÂá∫ÂºÇÂ∏∏ÁªìÊùüÔºåËøòÊòØÁ∫øÁ®ãÊ±†Ëá™ÁÑ∂ÁªìÊùü completedAbruptly = false; &#125; finally &#123; processWorkerExit(w, completedAbruptly); &#125;&#125; 1Ôºâ123 while (task != null || (task = getTask()) != null) &#123;// ...&#125; ‰∏çÂØπÂú∞ÈÄöËøágetTask() ‰ªéÈòüÂàó‰∏≠Ëé∑Âèñ‰ªªÂä°ÔºåÂèØ‰ª•Èó¥Êé•ÈÄöËøágetTask()ÁöÑËøîÂõûÂÄºÊéßÂà∂Á∫øÁ®ãÁöÑÁªìÊùü 2Ôºâ123456789// If pool is stopping, ensure thread is interrupted;// if not, ensure thread is not interrupted. This// requires a recheck in second case to deal with// shutdownNow race while clearing interruptif ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); Êé•‰∏ãÊù•Ëøô‰∏™Âà§Êñ≠ÔºåÂÖ∂ÂÆûÊàëÊòØÊ≤°ÊúâÂ§™ÁêÜËß£ÁöÑÔºåÊöÇ‰∏îËÆ§‰∏∫ÊòØ‰øùËØÅÂΩìÁ∫øÁ®ãÊ±†STOPÊó∂ÔºåÁ∫øÁ®ã‰∏ÄÂÆö‰ºöË¢´ÊâìÊñ≠ 3ÔºâÊâßË°åRunnable12345678910111213141516171819try &#123; beforeExecute(wt, task); Throwable thrown = null; try &#123; task.run(); &#125; catch (RuntimeException x) &#123; thrown = x; throw x; &#125; catch (Error x) &#123; thrown = x; throw x; &#125; catch (Throwable x) &#123; thrown = x; throw new Error(x); &#125; finally &#123; afterExecute(task, thrown); &#125;&#125; finally &#123; task = null; w.completedTasks++; w.unlock();&#125; beforeExecute(wt, task); Âíå afterExecute(task, thrown); ÈªòËÆ§ÊòØÊ≤°ÊúâÂÆûÁé∞ÁöÑÔºåÊàë‰ª¨ÂèØ‰ª•Ëá™Â∑±Êâ©Â±ï 4ÔºâÊúÄÂêéÊòØÂΩìË∑≥Âá∫whileÂæ™ÁéØÂêéÔºàgetTask() == nullÊàñËÄÖÁî®Êà∑‰ªªÂä°ÊäõÂá∫ÂºÇÂ∏∏ÔºâÔºå‰ºöÂéªÊâßË°åprocessWorkerExit(w, completedAbruptly);Á∫øÁ®ãÈÄÄÂá∫Â∑•‰ΩúÔºàËØ•ÊñπÊ≥ï‰ºöÊ†πÊçÆÁ∫øÁ®ãÊ±†Áä∂ÊÄÅÔºåÂ∞ùËØï‰∏≠Ê≠¢Á∫øÁ®ãÊ±†„ÄÇÁÑ∂Âêé‰ºöËÄÉËôëÊòØÁªìÊùüÂΩìÂâçÁ∫øÁ®ãÔºåËøòÊòØÂÜçÊñ∞Âª∫‰∏Ä‰∏™Â∑•‰ΩúÁ∫øÁ®ãÔºåËøôÈáåÂ∞±‰∏çÁªÜËØ¥‰∫ÜÔºâ Êàë‰ª¨ÂÜçÊù•Áúã‰∏Ä‰∏ã getTask() ÊñπÊ≥ï12345678910111213141516171819202122232425262728293031323334353637private Runnable getTask() &#123; boolean timedOut = false; // Did the last poll() time out? for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123; decrementWorkerCount(); return null; &#125; int wc = workerCountOf(c); // Are workers subject to culling? boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize; if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123; if (compareAndDecrementWorkerCount(c)) return null; continue; &#125; try &#123; Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take(); if (r != null) return r; timedOut = true; &#125; catch (InterruptedException retry) &#123; timedOut = false; &#125; &#125;&#125; 1Ôºâ Á¨¨‰∏ÄÊÆµ‰∏çÂÅöËß£ÈáäÔºåÊª°Ë∂≥ËØ•Êù°‰ª∂Êó∂Ôºåreturn null; ÈÄÄÂá∫Á∫øÁ®ã12345// Check if queue empty only if necessary.if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123; decrementWorkerCount(); return null;&#125; 2Ôºâ ‰∏ãÈù¢ËøôÊÆµÂæàÊúâÊÑèÊÄù12345678910111213141516int wc = workerCountOf(c);// Are workers subject to culling?// ÊòØÂê¶ÂÖÅËÆ∏Á∫øÁ®ãË∂ÖÊó∂// ÂΩìÊàë‰ª¨ËÆæÁΩÆ‰∫ÜÂÖÅËÆ∏Ê†∏ÂøÉÊ±†Ë∂ÖÊó∂ ÊàñËÄÖ ÊúâÊïàÁ∫øÁ®ãÊï∞ &gt; Ê†∏ÂøÉÊ±†Êï∞ÈáèÁöÑÊó∂ÂÄô// Á∫øÁ®ãÊ±†‰ºöËÄÉËôë‰∏∫Êàë‰ª¨Ê∏ÖÈô§Êéâ‰∏Ä‰∫õÁ∫øÁ®ãboolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;// (ÊúâÊïàÁ∫øÁ®ãÊï∞ &gt; ÊúÄÂ§ßÁ∫øÁ®ãÊ±†Êï∞Èáè || (ÂÖÅËÆ∏Ë∂ÖÊó∂ &amp;&amp; Ë∂ÖÊó∂) ) // &amp;&amp; (ÊúâÊïàÁ∫øÁ®ãÊï∞ &gt; 1 || ÊàñËÄÖÈòüÂàó‰∏∫Á©∫Êó∂)if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) // timedOut Ë°®Á§∫ÂΩìÂâçÁ∫øÁ®ãË∂ÖÊó∂Ôºå‰∏ãÊñá‰ºöËØ¥Âà∞ &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123; if (compareAndDecrementWorkerCount(c)) return null; continue;&#125; ÊàëÂú®Á¨¨‰∏ÄÊ¨°ÁúãËøôÊÆµ‰ª£Á†ÅÁöÑÊó∂ÂÄôÔºåÂÇªÂÇªÁöÑ‰ª•‰∏∫ timedOut ‰∏çÊòØÊ∞∏Ëøú‰∏∫falseÂêóÔºåÊàë‰ª•‰∏∫JDKÊ∫êÁ†ÅÊÄé‰πàÂÜôÂá∫Ëøô‰πà‰∏™Bug„ÄÇÂà´Âøò‰∫ÜÂΩìÂâçÁöÑgetTask()ÊñπÊ≥ï‰πüÊòØÂú®‰∏Ä‰∏™Êó†ÈôêÂæ™ÁéØÈáå 3Ôºâ12345678910try &#123; Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take(); if (r != null) return r; timedOut = true;&#125; catch (InterruptedException retry) &#123; timedOut = false;&#125; Ê†πÊçÆ timedÔºåÂÜ≥ÂÆöË∞ÉÁî®‰ΩøÁî®poll() ÊàñËÄÖ take()„ÄÇ poll Âú®ÈòüÂàó‰∏∫Á©∫Êó∂‰ºöÁ≠âÂæÖÊåáÂÆöÊó∂Èó¥ÔºåÂ¶ÇÊûúËøôÊúüÈó¥Ê≤°ÊúâËé∑ÂèñÂà∞ÂÖÉÁ¥†ÔºåÂàôreturn null take ÂàôÂú®ÈòüÂàó‰∏∫Á©∫Êó∂‰ºö‰∏ÄÁõ¥Á≠âÂæÖÔºåÁõ¥Ëá≥ÈòüÂàó‰∏≠Ë¢´Ê∑ªÂä†Êñ∞ÁöÑ‰ªªÂä°ÔºåÊàñËÄÖË¢´ÊâìÊñ≠ÔºõËøô‰∏§‰∏™ÊñπÊ≥ïÈÉΩ‰ºöË¢´shutdown() ÊàñËÄÖ shutdownNowÁöÑ thread.interrupt()ÊâìÊñ≠ÔºõÂ¶ÇÊûúË¢´ÊâìÊñ≠ÂàôÂõûÂà∞Á¨¨‰∏ÄÊ≠• Ëá≥Ê≠§ execute() ÊñπÊ≥ïÊâÄÊ∂âÂèäÁöÑÈÄªËæëÊàë‰ª¨Â∑Æ‰∏çÂ§öÂàÜÊûêÂÆå‰∫Ü Â§áÊ≥®Á∫øÁ®ãÊ±†‰ΩøÁî®1234567891011121314public class Test &#123; public static void main(String[] args) &#123; ThreadPoolExecutor executor = new ThreadPoolExecutor(5, 10, 60, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(5)); executor.execute(() -&gt; &#123; // ‰∏öÂä°ÈÄªËæë &#125;); executor.shutdown(); &#125;&#125; ÂêàÁêÜÈÖçÁΩÆÁ∫øÁ®ãÊ±†ÁöÑÂ§ßÂ∞è‰∏ÄËà¨ÈúÄË¶ÅÊ†πÊçÆ‰ªªÂä°ÁöÑÁ±ªÂûãÊù•ÈÖçÁΩÆÁ∫øÁ®ãÊ±†Â§ßÂ∞èÔºö Â¶ÇÊûúÊòØCPUÂØÜÈõÜÂûã‰ªªÂä°ÔºåÂèÇËÄÉÂÄºÂèØ‰ª•ËÆæ‰∏∫ N+1 ÔºàN ‰∏∫CPUÊ†∏ÂøÉÊï∞Ôºâ Â¶ÇÊûúÊòØIOÂØÜÈõÜÂûã‰ªªÂä°ÔºåÂèÇËÄÉÂÄºÂèØ‰ª•ËÆæÁΩÆ‰∏∫2*N ÂΩìÁÑ∂ÔºåËøôÂè™ÊòØ‰∏Ä‰∏™ÂèÇËÄÉÂÄºÔºåÂÖ∑‰ΩìÁöÑËÆæÁΩÆËøòÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÊÉÖÂÜµËøõË°åË∞ÉÊï¥ÔºåÊØîÂ¶ÇÂèØ‰ª•ÂÖàÂ∞ÜÁ∫øÁ®ãÊ±†Â§ßÂ∞èËÆæÁΩÆ‰∏∫ÂèÇËÄÉÂÄºÔºåÂÜçËßÇÂØü‰ªªÂä°ËøêË°åÊÉÖÂÜµÂíåÁ≥ªÁªüË¥üËΩΩ„ÄÅËµÑÊ∫êÂà©Áî®ÁéáÊù•ËøõË°åÈÄÇÂΩìË∞ÉÊï¥„ÄÇ ÂèÇËÄÉ JDK1.8 https://www.cnblogs.com/dolphin0520/p/3932921.html]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Â§öÁ∫øÁ®ã</tag>
        <tag>ThreadPoolExecutor</tag>
        <tag>Á∫øÁ®ãÊ±†</tag>
        <tag>Ê∫êÁ†Å</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Ê∫êÁ†ÅËß£Êûê @RequestBody @ResponseBody ÁöÑÊù•ÈæôÂéªËÑâ]]></title>
    <url>%2Fpost%2Fb75109d6.html</url>
    <content type="text"><![CDATA[@RequestBody Âíå @ResponseBody ÊòØÂÆûÈôÖÂºÄÂèë‰∏≠ÂæàÂ∏∏Áî®ÁöÑ‰∏§‰∏™Ê≥®Ëß£ÔºåÈÄöÂ∏∏Áî®Êù•Ëß£ÊûêÂíåÂìçÂ∫îJSONÔºåÁî®Ëµ∑Êù•ÂçÅÂàÜÁöÑÊñπ‰æøÔºåËøô‰∏§‰∏™Ê≥®Ëß£ÁöÑËÉåÂêéÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑÔºü Ê∫êÁ†ÅÁâàÊú¨SpringBoot 2.1.3.RELEASE RequestResponseBodyMethodProcessor Resolves method arguments annotated with @RequestBody and handles return values from methods annotated with @ResponseBody by reading and writing to the body of the request or response with an HttpMessageConverter.An @RequestBody method argument is also validated if it is annotated with @javax.validation.Valid. In case of validation failure, MethodArgumentNotValidException is raised and results in an HTTP 400 response status code if DefaultHandlerExceptionResolver is configured. ÁÆÄÂçïÊù•ËØ¥ÔºåËøô‰∏™Á±ªÁî®Êù•Ëß£Êûê@RequestBodyÁöÑÂèÇÊï∞ÂíåÂ§ÑÁêÜ @ResponseBodyËøîÂõûÂÄºÔºåÈÄöËøá HttpMessageConverter Ëøô‰∏™Êé•Âè£Êù•ÂÆûÁé∞„ÄÇ Â¶ÇÊûú@RequestBodyÊ†áËÆ∞ÁöÑÂèÇÊï∞ÂåÖÂê´@ValidÔºåËøò‰ºöÂØπËøô‰∏™ÂèÇÊï∞ËøõË°åÊ†°È™å„ÄÇ ÁªßÊâøÂÖ≥Á≥ª HandlerMethodArgumentResolver Âíå HandlerMethodReturnValueHandler ÂàÜÂà´ÊòØSpringÁöÑÂèÇÊï∞Â§ÑÁêÜÂô®ÂíåËøîÂõûÂÄºÂ§ÑÁêÜÂô® HandlerMethodArgumentResolver 12345678public interface HandlerMethodArgumentResolver &#123; boolean supportsParameter(MethodParameter parameter); Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer, NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception;&#125; SpringÁöÑÂèÇÊï∞Ëß£ÊûêÂô®Êé•Âè£ÔºåsupportsParameter() ÊñπÊ≥ïÁî®‰∫éÂà§Êñ≠Ëß£ÊûêÂô®ÊòØÂê¶ÊîØÊåÅÂΩìÂâçControllerÊñπÊ≥ïÁöÑÂèÇÊï∞ÔºåresolveArgument() ÂàôÊòØÂ∞ÜRequestËß£Êûê‰∏∫ControllerÊñπÊ≥ïÂØπÂ∫îÁöÑÂèÇÊï∞Bean HandlerMethodReturnValueHandler 12345678public interface HandlerMethodReturnValueHandler &#123; boolean supportsReturnType(MethodParameter returnType); void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception;&#125; ÂêåÁêÜËøô‰∏™Êé•Âè£Â∞ÜControllerÊñπÊ≥ïËøîÂõûÁöÑÂØπË±°ÔºåÂ∞ÅË£Ö‰∏∫Response Êàë‰ª¨Âú®ÂÆûÈôÖÂºÄÂèëÊó∂Ôºå‰πüÂèØ‰ª•ÂÆûÁé∞Ëøô‰∏§‰∏™Êé•Âè£Ëá™ÂÆö‰πâËá™Â∑±ÁöÑÂèÇÊï∞Ëß£ÊûêÂíåÂìçÂ∫îÂ§ÑÁêÜÔºåRequestResponseBodyMethodProcessor ÂÆûÁé∞‰∫ÜËøô‰∏§‰∏™Êé•Âè£ÔºåÊó¢ÂÅö‰∫ÜÂèÇÊï∞Ëß£ÊûêÂô®‰πüÂÅö‰∫ÜÂìçÂ∫îÂ§ÑÁêÜÂô®„ÄÇ RequestResponseBodyMethodProcessor Ê∫êÁ†ÅÂàÜÊûêÊàë‰ª¨Êù•Áúã‰∏Ä‰∏ã RequestResponseBodyMethodProcessor ÊòØÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑÔºå‰ª•Ëß£ÊûêÂèÇÊï∞‰∏∫‰æã resolveArgument 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647@Overridepublic boolean supportsParameter(MethodParameter parameter) &#123; // ÊîØÊåÅÊ†áËÆ∞@RequestBodyÁöÑÂèÇÊï∞ return parameter.hasParameterAnnotation(RequestBody.class);&#125;@Overridepublic Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer, NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception &#123; parameter = parameter.nestedIfOptional(); // ÈÄöËøáHttpMessageConverters Â∞ÜËØ∑Ê±Ç‰Ωì, Â∞ÅË£Ö‰∏∫@RequestBodyÊâÄÊ†áËÆ∞ÁöÑXXBean Object arg = readWithMessageConverters(webRequest, parameter, parameter.getNestedGenericParameterType()); String name = Conventions.getVariableNameForParameter(parameter); if (binderFactory != null) &#123; WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name); if (arg != null) &#123; // Â¶ÇÊûúÂ≠òÂú®@Valid ÂØπÂèÇÊï∞ËøõË°åÊ†°È™å validateIfApplicable(binder, parameter); if (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123; throw new MethodArgumentNotValidException(parameter, binder.getBindingResult()); &#125; &#125; if (mavContainer != null) &#123; mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult()); &#125; &#125; return adaptArgumentIfNecessary(arg, parameter);&#125;@Overrideprotected &lt;T&gt; Object readWithMessageConverters(NativeWebRequest webRequest, MethodParameter parameter, Type paramType) throws IOException, HttpMediaTypeNotSupportedException, HttpMessageNotReadableException &#123; HttpServletRequest servletRequest = webRequest.getNativeRequest(HttpServletRequest.class); Assert.state(servletRequest != null, "No HttpServletRequest"); ServletServerHttpRequest inputMessage = new ServletServerHttpRequest(servletRequest); Object arg = readWithMessageConverters(inputMessage, parameter, paramType); if (arg == null &amp;&amp; checkRequired(parameter)) &#123; throw new HttpMessageNotReadableException("Required request body is missing: " + parameter.getExecutable().toGenericString(), inputMessage); &#125; return arg;&#125; ‰Ωú‰∏∫ÂèÇÊï∞Ëß£ÊûêÂô®ÔºåRequestResponseBodyMethodProcessor ÊîØÊåÅÊâÄÊúâÊ†áËÆ∞@RequestBodyÁöÑÂèÇÊï∞„ÄÇÂú®resolveArgument()ÊñπÊ≥ï‰∏≠ÔºåÈÄöËøáË∞ÉÁî®readWithMessageConverters() Â∞Ü Request ËΩ¨‰∏∫ÂØπÂ∫î arg„ÄÇÊàë‰ª¨Êù•Áúã‰∏Ä‰∏ã readWithMessageConverters() Âà∞Â∫ïÂÅö‰∫Ü‰ªÄ‰πà readWithMessageConverters 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980protected &lt;T&gt; Object readWithMessageConverters(HttpInputMessage inputMessage, MethodParameter parameter, Type targetType) throws IOException, HttpMediaTypeNotSupportedException, HttpMessageNotReadableException &#123; // ÂΩìÂâçËØ∑Ê±ÇÁöÑcontentType MediaType contentType; boolean noContentType = false; try &#123; contentType = inputMessage.getHeaders().getContentType(); &#125; catch (InvalidMediaTypeException ex) &#123; throw new HttpMediaTypeNotSupportedException(ex.getMessage()); &#125; if (contentType == null) &#123; noContentType = true; contentType = MediaType.APPLICATION_OCTET_STREAM; &#125; // ControllerÂèÇÊï∞ÁöÑClass Class&lt;?&gt; contextClass = parameter.getContainingClass(); Class&lt;T&gt; targetClass = (targetType instanceof Class ? (Class&lt;T&gt;) targetType : null); if (targetClass == null) &#123; ResolvableType resolvableType = ResolvableType.forMethodParameter(parameter); targetClass = (Class&lt;T&gt;) resolvableType.resolve(); &#125; // ÂΩìÂâçËØ∑Ê±ÇÊñπÂºè HttpMethod httpMethod = (inputMessage instanceof HttpRequest ? ((HttpRequest) inputMessage).getMethod() : null); Object body = NO_VALUE; EmptyBodyCheckingHttpInputMessage message; try &#123; message = new EmptyBodyCheckingHttpInputMessage(inputMessage); // ÈÅçÂéÜÊâÄÊúâÁöÑHttpMessageConverterÔºå for (HttpMessageConverter&lt;?&gt; converter : this.messageConverters) &#123; Class&lt;HttpMessageConverter&lt;?&gt;&gt; converterType = (Class&lt;HttpMessageConverter&lt;?&gt;&gt;) converter.getClass(); GenericHttpMessageConverter&lt;?&gt; genericConverter = (converter instanceof GenericHttpMessageConverter ? (GenericHttpMessageConverter&lt;?&gt;) converter : null); // Â¶ÇÊûúÂΩìÂâçÁöÑHttpMessageConverterÂèØ‰ª•Ëß£ÊûêÂØπÂ∫îÁöÑ classÂíåcontentType if (genericConverter != null ? genericConverter.canRead(targetType, contextClass, contentType) : (targetClass != null &amp;&amp; converter.canRead(targetClass, contentType))) &#123; if (message.hasBody()) &#123; HttpInputMessage msgToUse = getAdvice().beforeBodyRead(message, parameter, targetType, converterType); // Â∞ÜHttpÊä•ÊñáËΩ¨Êç¢‰∏∫ÂØπÂ∫îÁöÑclass body = (genericConverter != null ? genericConverter.read(targetType, contextClass, msgToUse) : ((HttpMessageConverter&lt;T&gt;) converter).read(targetClass, msgToUse)); body = getAdvice().afterBodyRead(body, msgToUse, parameter, targetType, converterType); &#125; else &#123; body = getAdvice().handleEmptyBody(null, message, parameter, targetType, converterType); &#125; break; &#125; &#125; &#125; catch (IOException ex) &#123; throw new HttpMessageNotReadableException("I/O error while reading input message", ex, inputMessage); &#125; if (body == NO_VALUE) &#123; if (httpMethod == null || !SUPPORTED_METHODS.contains(httpMethod) || (noContentType &amp;&amp; !message.hasBody())) &#123; return null; &#125; throw new HttpMediaTypeNotSupportedException(contentType, this.allSupportedMediaTypes); &#125; MediaType selectedContentType = contentType; Object theBody = body; LogFormatUtils.traceDebug(logger, traceOn -&gt; &#123; String formatted = LogFormatUtils.formatValue(theBody, !traceOn); return "Read \"" + selectedContentType + "\" to [" + formatted + "]"; &#125;); return body;&#125; ‰∏äËø∞‰ª£Á†ÅÊ†∏ÂøÉÈÄªËæëÂ∞±ÊòØÈÅçÂéÜÂΩìÂâçËß£Êûê‰∏≠ÈÖçÁΩÆÁöÑÊâÄÊúâ HttpMessageConverterÔºåÂ¶ÇÊûúÊüê‰∏™ConverterÂèØ‰ª•Ëß£ÊûêÂΩìÂâçÁöÑ contentTypeÔºåÂ∞±ÊääËΩ¨Êç¢Â∑•‰Ωú‰∫§Áªô‰ªñÂéªËøõË°å„ÄÇ ‰πãÂâçÂÅöËøáÂ∞ÜÈªòËÆ§Ëß£ÊûêÊõøÊç¢‰∏∫fastjsonÔºåÂΩìÊó∂Â∞±ÊòØÊ∑ªÂä†‰∏Ä‰∏™FastJsonÂÆûÁé∞ÁöÑHttpMessageConverterÔºå‰ΩÜÊòØÈÇ£Êó∂ÂÄôÂπ∂‰∏çÁêÜËß£Ëøô‰πàÂÅöÊòØ‰∏∫‰∫Ü‰ªÄ‰πàÔºåÁé∞Âú®ÊâçÊÅçÁÑ∂Â§ßÊÇü‚Ä¶ handleReturnValue RequestResponseBodyMethodProcessor ÁöÑResponseÂ§ÑÁêÜÈÄªËæëÂíåËß£ÊûêÈÄªËæëÁ±ª‰ººÔºåÊâæÂà∞‰∏Ä‰∏™ÊîØÊåÅÁöÑHttpMessageConverterÔºåÊääÂìçÂ∫îÂ∑•‰Ωú‰∫§Áªô‰ªñÔºåÊÑüÂÖ¥Ë∂£ÁöÑÁ´•ÈûãÂèØ‰ª•Ëá™Â∑±Êâæ‰∏ãÊ∫êÁ†Å„ÄÇ RequestResponseBodyMethodProcessor ÊòØÊÄé‰πàË¢´Ë∞ÉÁî®ÁöÑ‰∏äÈù¢ËÆ≤‰∫Ü RequestResponseBodyMethodProcessor ÂÅö‰∫ÜÂèÇÊï∞Ëß£ÊûêÂíåÂìçÂ∫îÂ§ÑÁêÜÁöÑÂ∑•‰ΩúÔºåÈÇ£‰πà‰ªñÂú®SpringÊ°ÜÊû∂‰∏≠ÊòØÊÄé‰πàË¢´Ë∞ÉÁî®ÁöÑÔºåÊàë‰ª¨Êù•Áúã‰∏Ä‰∏ã Â¶ÇÂõæÔºåRequestMappingHandlerAdapter ÁöÑresolversÔºàRequestËß£ÊûêÂô®Ôºâ„ÄÅhandlersÔºàResponseÂ§ÑÁêÜÂô®ÔºâËøòÊúâ ExceptionHandlerExceptionResolver ÁöÑhandlers Ë∞ÉÁî®‰∫Ü RequestResponseBodyMethodProcessor RequestMappingHandlerAdapterÊàë‰ª¨Âè™ÂàÜÊûê‰∏Ä‰∏ã RequestMappingHandlerAdapter ÔºåËØ•Á±ªÂØπÊâÄÊúâÊ†áËÆ∞ @RequestMappingÁöÑÊ≥®Ëß£ËøõË°åËß£ÊûêÂíåÂìçÂ∫î Âú®WebMvcConfigurationSupport‰∏≠ÔºåÈÖçÁΩÆ‰∫ÜËØ•BeanÔºåÂ∞ÜÂÖ∂Âä†ÂÖ•Âà∞SpringÂÆπÂô®‰∏≠ÔºåÊàë‰ª¨Ëá™ÂÆö‰πâÁöÑÂèÇÊï∞Ëß£Êûê„ÄÅÂìçÂ∫îËß£Êûê„ÄÅÂíåHttpMessageConvert ÈÄöËøá‰∏äÂõæÁöÑÊñπÊ≥ïsetÂà∞ RequestMappingHandlerAdapter ‰∏≠„ÄÇ 123456789101112131415161718192021222324252627282930@Beanpublic RequestMappingHandlerAdapter requestMappingHandlerAdapter() &#123; RequestMappingHandlerAdapter adapter = createRequestMappingHandlerAdapter(); adapter.setContentNegotiationManager(mvcContentNegotiationManager()); // Ëé∑ÂèñÊâÄÊúâHttpMessageConverterÔºåÂåÖÊã¨Êàë‰ª¨Ëá™ÂÆö‰πâÁöÑÈÖçÁΩÆ adapter.setMessageConverters(getMessageConverters()); adapter.setWebBindingInitializer(getConfigurableWebBindingInitializer()); // Ëá™ÂÆö‰πâÁöÑÂèÇÊï∞Ëß£ÊûêÂô® adapter.setCustomArgumentResolvers(getArgumentResolvers()); // Ëá™ÂÆö‰πâÁöÑÂìçÂ∫îÂ§ÑÁêÜÂô® adapter.setCustomReturnValueHandlers(getReturnValueHandlers()); if (jackson2Present) &#123; adapter.setRequestBodyAdvice(Collections.singletonList(new JsonViewRequestBodyAdvice())); adapter.setResponseBodyAdvice(Collections.singletonList(new JsonViewResponseBodyAdvice())); &#125; AsyncSupportConfigurer configurer = new AsyncSupportConfigurer(); configureAsyncSupport(configurer); if (configurer.getTaskExecutor() != null) &#123; adapter.setTaskExecutor(configurer.getTaskExecutor()); &#125; if (configurer.getTimeout() != null) &#123; adapter.setAsyncRequestTimeout(configurer.getTimeout()); &#125; adapter.setCallableInterceptors(configurer.getCallableInterceptors()); adapter.setDeferredResultInterceptors(configurer.getDeferredResultInterceptors()); return adapter;&#125; ÁªßÁª≠ËØ¥ RequestMappingHandlerAdapter ÔºågetDefaultArgumentResolvers() Â∞ÅË£Ö‰∫ÜSpringBoot‰∏≠ÁöÑÈªòËÆ§ÂèÇÊï∞Ëß£ÊûêÂô®ÔºåÂÖ∂‰∏≠Â∞±ÊúâÊàë‰ª¨ÁöÑÊú¨ËäÇÊâÄËÆ≤ÁöÑ RequestResponseBodyMethodProcessor ÔºåÂú®afterPropertiesSet() ÊñπÊ≥ï‰∏≠Ë∞ÉÁî®‰∫ÜËØ•ÊñπÊ≥ï 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667@Overridepublic void afterPropertiesSet() &#123; // Do this first, it may add ResponseBody advice beans initControllerAdviceCache(); if (this.argumentResolvers == null) &#123; List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers(); this.argumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers); &#125; if (this.initBinderArgumentResolvers == null) &#123; List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultInitBinderArgumentResolvers(); this.initBinderArgumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers); &#125; if (this.returnValueHandlers == null) &#123; List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers(); this.returnValueHandlers = new HandlerMethodReturnValueHandlerComposite().addHandlers(handlers); &#125;&#125;private List&lt;HandlerMethodArgumentResolver&gt; getDefaultArgumentResolvers() &#123; List&lt;HandlerMethodArgumentResolver&gt; resolvers = new ArrayList&lt;&gt;(); // Annotation-based argument resolution resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), false)); resolvers.add(new RequestParamMapMethodArgumentResolver()); resolvers.add(new PathVariableMethodArgumentResolver()); resolvers.add(new PathVariableMapMethodArgumentResolver()); resolvers.add(new MatrixVariableMethodArgumentResolver()); resolvers.add(new MatrixVariableMapMethodArgumentResolver()); resolvers.add(new ServletModelAttributeMethodProcessor(false)); // Ê∑ªÂä†RequestResponseBodyMethodProcessor resolvers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice)); // ÁúÅÁï•ÔºåËØ¶ËßÅÊ∫êÁ†Å... return resolvers;&#125;private List&lt;HandlerMethodReturnValueHandler&gt; getDefaultReturnValueHandlers() &#123; List&lt;HandlerMethodReturnValueHandler&gt; handlers = new ArrayList&lt;&gt;(); // Single-purpose return value types handlers.add(new ModelAndViewMethodReturnValueHandler()); handlers.add(new ModelMethodProcessor()); handlers.add(new ViewMethodReturnValueHandler()); handlers.add(new ResponseBodyEmitterReturnValueHandler(getMessageConverters(), this.reactiveAdapterRegistry, this.taskExecutor, this.contentNegotiationManager)); handlers.add(new StreamingResponseBodyReturnValueHandler()); handlers.add(new HttpEntityMethodProcessor(getMessageConverters(), this.contentNegotiationManager, this.requestResponseBodyAdvice)); handlers.add(new HttpHeadersReturnValueHandler()); handlers.add(new CallableMethodReturnValueHandler()); handlers.add(new DeferredResultMethodReturnValueHandler()); handlers.add(new AsyncTaskMethodReturnValueHandler(this.beanFactory)); // Annotation-based return value types handlers.add(new ModelAttributeMethodProcessor(false)); // Ê∑ªÂä†RequestResponseBodyMethodProcessor handlers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(), this.contentNegotiationManager, this.requestResponseBodyAdvice)); // ÁúÅÁï•ÔºåËØ¶ËßÅÊ∫êÁ†Å... return handlers;&#125; RequestResponseBodyMethodProcessor ‰ΩïÊó∂Ë¢´Ë∞ÉÁî®‰∏äÈù¢Èì∫Âû´‰∫ÜËøô‰πàÂ§öÔºåÁªà‰∫éÊù•‰∫Ü RequestMappingHandlerAdapter ÁöÑ invokeHandlerMethod ‰∏≠ ÊûÑÂª∫‰∫Ü invocableMethod ÂØπË±°Âπ∂Â∞ÜÊâÄÊúâÁöÑËß£ÊûêÂô®ÂíåÂ§ÑÁêÜÂô®Â∞ÅË£ÖÂà∞ËØ•ÂØπË±°ÔºåÈÄöËøáinvocableMethod.invokeAndHandle() ËøõË°åÂØπËØ∑Ê±ÇÁöÑËß£ÊûêÔºåÂØπcontrollerÁöÑË∞ÉÁî®Ôºå‰ª•ÂèäÂìçÂ∫îÁöÑÂ§ÑÁêÜ invocableMethod.invokeAndHandle() ‰∏≠ÊòØÊÄé‰πàÊ†∑ÂÆûÁé∞ÁöÑ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687public void invokeAndHandle(ServletWebRequest webRequest, ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123; // ÂèÇÊï∞Ëß£ÊûêÔºåÂπ∂ÂèçÂ∞ÑË∞ÉÁî®controllerÊñπÊ≥ïÔºåËé∑ÂèñÊñπÊ≥ïËøîÂõûÂÄº Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs); // ‰∏ãÈù¢Â∞±ÊòØÂØπResponseÁöÑÂ§ÑÁêÜ setResponseStatus(webRequest); if (returnValue == null) &#123; if (isRequestNotModified(webRequest) || getResponseStatus() != null || mavContainer.isRequestHandled()) &#123; mavContainer.setRequestHandled(true); return; &#125; &#125; else if (StringUtils.hasText(getResponseStatusReason())) &#123; mavContainer.setRequestHandled(true); return; &#125; mavContainer.setRequestHandled(false); Assert.state(this.returnValueHandlers != null, "No return value handlers"); try &#123; this.returnValueHandlers.handleReturnValue( returnValue, getReturnValueType(returnValue), mavContainer, webRequest); &#125; catch (Exception ex) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(formatErrorForReturnValue(returnValue), ex); &#125; throw ex; &#125;&#125;public Object invokeForRequest(NativeWebRequest request, @Nullable ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123; // Ë∞ÉÁî®ÂèÇÊï∞Ëß£ÊûêÂô®Ëé∑ÂèñË∞ÉÁî®controller ÊâÄÈúÄÁöÑÂèÇÊï∞ Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs); if (logger.isTraceEnabled()) &#123; logger.trace("Arguments: " + Arrays.toString(args)); &#125; // ÂèçÂ∞ÑË∞ÉÁî® controller return doInvoke(args);&#125;protected Object[] getMethodArgumentValues(NativeWebRequest request, @Nullable ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123; if (ObjectUtils.isEmpty(getMethodParameters())) &#123; return EMPTY_ARGS; &#125; MethodParameter[] parameters = getMethodParameters(); Object[] args = new Object[parameters.length]; // ÈÅçÂéÜËß£ÊûêÂèÇÊï∞ for (int i = 0; i &lt; parameters.length; i++) &#123; MethodParameter parameter = parameters[i]; parameter.initParameterNameDiscovery(this.parameterNameDiscoverer); args[i] = findProvidedArgument(parameter, providedArgs); if (args[i] != null) &#123; continue; &#125; // ËøôÈáåÁöÑ resolvers ÊòØ‰∏Ä‰∏™Â∞ÅË£Ö‰∫ÜÊâÄÊúâÂèÇÊï∞Ëß£ÊûêÂô®ÁöÑÂåÖË£ÖÁ±ªÔºåÈÅçÂéÜÊâÄÊúâËß£ÊûêÂô®ÔºåÂ¶ÇÊûú‰∏çËÉΩÊâæÂà∞ÊîØÊåÅÂΩìÂâçÂèÇÊï∞ÁöÑÔºåÊäõÂá∫ÂºÇÂ∏∏ // Â¶ÇÊûúÊâæÂà∞ÂΩìÂâçÂèÇÊï∞ÂØπÂ∫îÁöÑËß£ÊûêÂô®ÔºåÂàôÁºìÂ≠òËµ∑Êù•ÔºåÂú®‰∏ãÈù¢ÁöÑ resolvers.resolveArgument Êó∂ÔºåÁõ¥Êé•‰ΩøÁî® if (!this.resolvers.supportsParameter(parameter)) &#123; throw new IllegalStateException(formatArgumentError(parameter, "No suitable resolver")); &#125; try &#123; // Ë∞ÉÁî®ÂèÇÊï∞Ëß£ÊûêÂô® args[i] = this.resolvers.resolveArgument(parameter, mavContainer, request, this.dataBinderFactory); &#125; catch (Exception ex) &#123; // Leave stack trace for later, exception may actually be resolved and handled.. if (logger.isDebugEnabled()) &#123; String error = ex.getMessage(); if (error != null &amp;&amp; !error.contains(parameter.getExecutable().toGenericString())) &#123; logger.debug(formatArgumentError(parameter, error)); &#125; &#125; throw ex; &#125; &#125; return args;&#125; invokeAndHandle() ÈáåÂÅö‰∫Ü‰∏â‰ª∂‰∫ã Â∞ÜËØ∑Ê±Ç‰∏≠Ëß£Êûê‰∏∫Controller‰∏≠ÊåáÂÆöÁöÑÂèÇÊï∞ Áî®Ëß£ÊûêÂ•ΩÁöÑÂèÇÊï∞ÂèçÂ∞ÑË∞ÉÁî® Controller ÊñπÊ≥ï Â§ÑÁêÜÂìçÂ∫î ‰∏ÄÊ¨°HttpËØ∑Ê±ÇÁªèÂéÜ‰∫Ü‰ªÄ‰πàÂõûËøáÂ§¥Êù•ÂÜçÁúãÔºåËøôÊó∂ÂÄôÊàë‰ª¨Âèë‰∏Ä‰∏™ËØ∑Ê±ÇÔºåÂú® RequestMappingHandlerAdapter ÁöÑ invokeHandlerMethod()‰∏≠ debug‰∏Ä‰∏ãÔºåÁúã‰∏Ä‰∏ãÁ∫øÁ®ãÊ†àÊòØ‰ªÄ‰πàÊ†∑ÁöÑ ÁÆÄÂçïÁîª‰∏ÄÂº†ÂõæÊù•Ë°®Á§∫‰∏Ä‰∏ã END Ê¨¢ËøéÂêÑ‰ΩçÁªôÂá∫ÊÑèËßÅÂíåÊåáÊ≠£]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Ê∫êÁ†Å</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JavaÂπ∂ÂèëÁºñÁ®ã-volatile]]></title>
    <url>%2Fpost%2Feb0b8344.html</url>
    <content type="text"><![CDATA[ÂéüÊñáÔºöJavaÂπ∂ÂèëÁºñÁ®ãÔºövolatileÂÖ≥ÈîÆÂ≠óËß£Êûê ÂéüÊñáËÆ≤Ëß£‰∫ÜÂæàÂ§ö‰∏úË•ø‰Ωú‰∏∫Èì∫Âû´ÔºåÂú®ÂéüÊñáÂÜÖÂÆπÊúâ‰∫õÂà†ÂáèÂíåÊõ¥Êîπ„ÄÇÂ¶ÇËØªËÄÖËßâÂæó‰∏çÂ¶•ÔºåÊàñËÄÖÁêÜËß£‰∏çÂà∞‰ΩçÔºåÂª∫ËÆÆÈòÖËØªÂéüÊñá„ÄÇ ÂÜÖÂ≠òÊ®°ÂûãÁõ∏ÂÖ≥Ê¶ÇÂøµÂ§ßÂÆ∂ÈÉΩÁü•ÈÅìÔºåËÆ°ÁÆóÊú∫Âú®ÊâßË°åÁ®ãÂ∫èÊó∂ÔºåÊØèÊù°Êåá‰ª§ÈÉΩÊòØÂú®CPU‰∏≠ÊâßË°åÁöÑÔºåËÄåÊâßË°åÊåá‰ª§ËøáÁ®ã‰∏≠ÔºåÂäøÂøÖÊ∂âÂèäÂà∞Êï∞ÊçÆÁöÑËØªÂèñÂíåÂÜôÂÖ•„ÄÇÁî±‰∫éÁ®ãÂ∫èËøêË°åËøáÁ®ã‰∏≠ÁöÑ‰∏¥Êó∂Êï∞ÊçÆÊòØÂ≠òÊîæÂú®‰∏ªÂ≠òÔºàÁâ©ÁêÜÂÜÖÂ≠òÔºâÂΩì‰∏≠ÁöÑÔºåËøôÊó∂Â∞±Â≠òÂú®‰∏Ä‰∏™ÈóÆÈ¢òÔºåÁî±‰∫éCPUÊâßË°åÈÄüÂ∫¶ÂæàÂø´ÔºåËÄå‰ªéÂÜÖÂ≠òËØªÂèñÊï∞ÊçÆÂíåÂêëÂÜÖÂ≠òÂÜôÂÖ•Êï∞ÊçÆÁöÑËøáÁ®ãË∑üCPUÊâßË°åÊåá‰ª§ÁöÑÈÄüÂ∫¶ÊØîËµ∑Êù•Ë¶ÅÊÖ¢ÁöÑÂ§öÔºåÂõ†Ê≠§Â¶ÇÊûú‰ªª‰ΩïÊó∂ÂÄôÂØπÊï∞ÊçÆÁöÑÊìç‰ΩúÈÉΩË¶ÅÈÄöËøáÂíåÂÜÖÂ≠òÁöÑ‰∫§‰∫íÊù•ËøõË°åÔºå‰ºöÂ§ßÂ§ßÈôç‰ΩéÊåá‰ª§ÊâßË°åÁöÑÈÄüÂ∫¶„ÄÇÂõ†Ê≠§Âú®CPUÈáåÈù¢Â∞±Êúâ‰∫ÜÈ´òÈÄüÁºìÂ≠ò„ÄÇ ‰πüÂ∞±ÊòØÔºåÂΩìÁ®ãÂ∫èÂú®ËøêË°åËøáÁ®ã‰∏≠Ôºå‰ºöÂ∞ÜËøêÁÆóÈúÄË¶ÅÁöÑÊï∞ÊçÆ‰ªé‰∏ªÂ≠òÂ§çÂà∂‰∏Ä‰ªΩÂà∞CPUÁöÑÈ´òÈÄüÁºìÂ≠òÂΩì‰∏≠ÔºåÈÇ£‰πàCPUËøõË°åËÆ°ÁÆóÊó∂Â∞±ÂèØ‰ª•Áõ¥Êé•‰ªéÂÆÉÁöÑÈ´òÈÄüÁºìÂ≠òËØªÂèñÊï∞ÊçÆÂíåÂêëÂÖ∂‰∏≠ÂÜôÂÖ•Êï∞ÊçÆÔºåÂΩìËøêÁÆóÁªìÊùü‰πãÂêéÔºåÂÜçÂ∞ÜÈ´òÈÄüÁºìÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆÂà∑Êñ∞Âà∞‰∏ªÂ≠òÂΩì‰∏≠„ÄÇ‰∏æ‰∏™ÁÆÄÂçïÁöÑ‰æãÂ≠êÔºåÊØîÂ¶Ç‰∏ãÈù¢ÁöÑËøôÊÆµ‰ª£Á†ÅÔºö 1i = i + 1; ÂΩìÁ∫øÁ®ãÊâßË°åËøô‰∏™ËØ≠Âè•Êó∂Ôºå‰ºöÂÖà‰ªé‰∏ªÂ≠òÂΩì‰∏≠ËØªÂèñiÁöÑÂÄºÔºåÁÑ∂ÂêéÂ§çÂà∂‰∏Ä‰ªΩÂà∞È´òÈÄüÁºìÂ≠òÂΩì‰∏≠ÔºåÁÑ∂ÂêéCPUÊâßË°åÊåá‰ª§ÂØπiËøõË°åÂä†1Êìç‰ΩúÔºåÁÑ∂ÂêéÂ∞ÜÊï∞ÊçÆÂÜôÂÖ•È´òÈÄüÁºìÂ≠òÔºåÊúÄÂêéÂ∞ÜÈ´òÈÄüÁºìÂ≠ò‰∏≠iÊúÄÊñ∞ÁöÑÂÄºÂà∑Êñ∞Âà∞‰∏ªÂ≠òÂΩì‰∏≠„ÄÇ Ëøô‰∏™‰ª£Á†ÅÂú®ÂçïÁ∫øÁ®ã‰∏≠ËøêË°åÊòØÊ≤°Êúâ‰ªª‰ΩïÈóÆÈ¢òÁöÑÔºå‰ΩÜÊòØÂú®Â§öÁ∫øÁ®ã‰∏≠ËøêË°åÂ∞±‰ºöÊúâÈóÆÈ¢ò‰∫Ü„ÄÇÂú®Â§öÊ†∏CPU‰∏≠ÔºåÊØèÊù°Á∫øÁ®ãÂèØËÉΩËøêË°å‰∫é‰∏çÂêåÁöÑCPU‰∏≠ÔºåÂõ†Ê≠§ÊØè‰∏™Á∫øÁ®ãËøêË°åÊó∂ÊúâËá™Â∑±ÁöÑÈ´òÈÄüÁºìÂ≠òÔºàÂØπÂçïÊ†∏CPUÊù•ËØ¥ÔºåÂÖ∂ÂÆû‰πü‰ºöÂá∫Áé∞ËøôÁßçÈóÆÈ¢òÔºåÂè™‰∏çËøáÊòØ‰ª•Á∫øÁ®ãË∞ÉÂ∫¶ÁöÑÂΩ¢ÂºèÊù•ÂàÜÂà´ÊâßË°åÁöÑÔºâ„ÄÇÊú¨ÊñáÊàë‰ª¨‰ª•Â§öÊ†∏CPU‰∏∫‰æã„ÄÇ ÊØîÂ¶ÇÂêåÊó∂Êúâ2‰∏™Á∫øÁ®ãÊâßË°åËøôÊÆµ‰ª£Á†ÅÔºåÂÅáÂ¶ÇÂàùÂßãÊó∂iÁöÑÂÄº‰∏∫0ÔºåÈÇ£‰πàÊàë‰ª¨Â∏åÊúõ‰∏§‰∏™Á∫øÁ®ãÊâßË°åÂÆå‰πãÂêéiÁöÑÂÄºÂèò‰∏∫2„ÄÇ‰ΩÜÊòØ‰∫ãÂÆû‰ºöÊòØËøôÊ†∑ÂêóÔºü ÂèØËÉΩÂ≠òÂú®‰∏ãÈù¢‰∏ÄÁßçÊÉÖÂÜµÔºöÂàùÂßãÊó∂Ôºå‰∏§‰∏™Á∫øÁ®ãÂàÜÂà´ËØªÂèñiÁöÑÂÄºÂ≠òÂÖ•ÂêÑËá™ÊâÄÂú®ÁöÑCPUÁöÑÈ´òÈÄüÁºìÂ≠òÂΩì‰∏≠ÔºåÁÑ∂ÂêéÁ∫øÁ®ã1ËøõË°åÂä†1Êìç‰ΩúÔºåÁÑ∂ÂêéÊääiÁöÑÊúÄÊñ∞ÂÄº1ÂÜôÂÖ•Âà∞ÂÜÖÂ≠ò„ÄÇÊ≠§Êó∂Á∫øÁ®ã2ÁöÑÈ´òÈÄüÁºìÂ≠òÂΩì‰∏≠iÁöÑÂÄºËøòÊòØ0ÔºåËøõË°åÂä†1Êìç‰Ωú‰πãÂêéÔºåiÁöÑÂÄº‰∏∫1ÔºåÁÑ∂ÂêéÁ∫øÁ®ã2ÊääiÁöÑÂÄºÂÜôÂÖ•ÂÜÖÂ≠ò„ÄÇ ÊúÄÁªàÁªìÊûúiÁöÑÂÄºÊòØ1ÔºåËÄå‰∏çÊòØ2„ÄÇËøôÂ∞±ÊòØËëóÂêçÁöÑÁºìÂ≠ò‰∏ÄËá¥ÊÄßÈóÆÈ¢ò„ÄÇÈÄöÂ∏∏Áß∞ËøôÁßçË¢´Â§ö‰∏™Á∫øÁ®ãËÆøÈóÆÁöÑÂèòÈáè‰∏∫ÂÖ±‰∫´ÂèòÈáè„ÄÇ ‰πüÂ∞±ÊòØËØ¥ÔºåÂ¶ÇÊûú‰∏Ä‰∏™ÂèòÈáèÂú®Â§ö‰∏™CPU‰∏≠ÈÉΩÂ≠òÂú®ÁºìÂ≠òÔºà‰∏ÄËà¨Âú®Â§öÁ∫øÁ®ãÁºñÁ®ãÊó∂Êâç‰ºöÂá∫Áé∞ÔºâÔºåÈÇ£‰πàÂ∞±ÂèØËÉΩÂ≠òÂú®ÁºìÂ≠ò‰∏ç‰∏ÄËá¥ÁöÑÈóÆÈ¢ò„ÄÇ ‰∏∫‰∫ÜËß£ÂÜ≥ÁºìÂ≠ò‰∏ç‰∏ÄËá¥ÊÄßÈóÆÈ¢òÔºåÈÄöÂ∏∏Êù•ËØ¥Êúâ‰ª•‰∏ã2ÁßçËß£ÂÜ≥ÊñπÊ≥ïÔºö 1ÔºâÈÄöËøáÂú®ÊÄªÁ∫øÂä†LOCK#ÈîÅÁöÑÊñπÂºè 2ÔºâÈÄöËøáÁºìÂ≠ò‰∏ÄËá¥ÊÄßÂçèËÆÆ Ëøô2ÁßçÊñπÂºèÈÉΩÊòØÁ°¨‰ª∂Â±ÇÈù¢‰∏äÊèê‰æõÁöÑÊñπÂºè„ÄÇ Âú®Êó©ÊúüÁöÑCPUÂΩì‰∏≠ÔºåÊòØÈÄöËøáÂú®ÊÄªÁ∫ø‰∏äÂä†LOCK#ÈîÅÁöÑÂΩ¢ÂºèÊù•Ëß£ÂÜ≥ÁºìÂ≠ò‰∏ç‰∏ÄËá¥ÁöÑÈóÆÈ¢ò„ÄÇÂõ†‰∏∫CPUÂíåÂÖ∂‰ªñÈÉ®‰ª∂ËøõË°åÈÄö‰ø°ÈÉΩÊòØÈÄöËøáÊÄªÁ∫øÊù•ËøõË°åÁöÑÔºåÂ¶ÇÊûúÂØπÊÄªÁ∫øÂä†LOCK#ÈîÅÁöÑËØùÔºå‰πüÂ∞±ÊòØËØ¥ÈòªÂ°û‰∫ÜÂÖ∂‰ªñCPUÂØπÂÖ∂‰ªñÈÉ®‰ª∂ËÆøÈóÆÔºàÂ¶ÇÂÜÖÂ≠òÔºâÔºå‰ªéËÄå‰ΩøÂæóÂè™ËÉΩÊúâ‰∏Ä‰∏™CPUËÉΩ‰ΩøÁî®Ëøô‰∏™ÂèòÈáèÁöÑÂÜÖÂ≠ò„ÄÇÊØîÂ¶Ç‰∏äÈù¢‰æãÂ≠ê‰∏≠ Â¶ÇÊûú‰∏Ä‰∏™Á∫øÁ®ãÂú®ÊâßË°å i = i +1ÔºåÂ¶ÇÊûúÂú®ÊâßË°åËøôÊÆµ‰ª£Á†ÅÁöÑËøáÁ®ã‰∏≠ÔºåÂú®ÊÄªÁ∫ø‰∏äÂèëÂá∫‰∫ÜLCOK#ÈîÅÁöÑ‰ø°Âè∑ÔºåÈÇ£‰πàÂè™ÊúâÁ≠âÂæÖËøôÊÆµ‰ª£Á†ÅÂÆåÂÖ®ÊâßË°åÂÆåÊØï‰πãÂêéÔºåÂÖ∂‰ªñCPUÊâçËÉΩ‰ªéÂèòÈáèiÊâÄÂú®ÁöÑÂÜÖÂ≠òËØªÂèñÂèòÈáèÔºåÁÑ∂ÂêéËøõË°åÁõ∏Â∫îÁöÑÊìç‰Ωú„ÄÇËøôÊ†∑Â∞±Ëß£ÂÜ≥‰∫ÜÁºìÂ≠ò‰∏ç‰∏ÄËá¥ÁöÑÈóÆÈ¢ò„ÄÇ ‰ΩÜÊòØ‰∏äÈù¢ÁöÑÊñπÂºè‰ºöÊúâ‰∏Ä‰∏™ÈóÆÈ¢òÔºåÁî±‰∫éÂú®ÈîÅ‰ΩèÊÄªÁ∫øÊúüÈó¥ÔºåÂÖ∂‰ªñCPUÊó†Ê≥ïËÆøÈóÆÂÜÖÂ≠òÔºåÂØºËá¥ÊïàÁéá‰Ωé‰∏ã„ÄÇ ÊâÄ‰ª•Â∞±Âá∫Áé∞‰∫ÜÁºìÂ≠ò‰∏ÄËá¥ÊÄßÂçèËÆÆ„ÄÇÊúÄÂá∫ÂêçÁöÑÂ∞±ÊòØIntel ÁöÑMESIÂçèËÆÆÔºåMESIÂçèËÆÆ‰øùËØÅ‰∫ÜÊØè‰∏™ÁºìÂ≠ò‰∏≠‰ΩøÁî®ÁöÑÂÖ±‰∫´ÂèòÈáèÁöÑÂâØÊú¨ÊòØ‰∏ÄËá¥ÁöÑ„ÄÇÂÆÉÊ†∏ÂøÉÁöÑÊÄùÊÉ≥ÊòØÔºöÂΩìCPUÂÜôÊï∞ÊçÆÊó∂ÔºåÂ¶ÇÊûúÂèëÁé∞Êìç‰ΩúÁöÑÂèòÈáèÊòØÂÖ±‰∫´ÂèòÈáèÔºåÂç≥Âú®ÂÖ∂‰ªñCPU‰∏≠‰πüÂ≠òÂú®ËØ•ÂèòÈáèÁöÑÂâØÊú¨Ôºå‰ºöÂèëÂá∫‰ø°Âè∑ÈÄöÁü•ÂÖ∂‰ªñCPUÂ∞ÜËØ•ÂèòÈáèÁöÑÁºìÂ≠òË°åÁΩÆ‰∏∫Êó†ÊïàÁä∂ÊÄÅÔºåÂõ†Ê≠§ÂΩìÂÖ∂‰ªñCPUÈúÄË¶ÅËØªÂèñËøô‰∏™ÂèòÈáèÊó∂ÔºåÂèëÁé∞Ëá™Â∑±ÁºìÂ≠ò‰∏≠ÁºìÂ≠òËØ•ÂèòÈáèÁöÑÁºìÂ≠òË°åÊòØÊó†ÊïàÁöÑÔºåÈÇ£‰πàÂÆÉÂ∞±‰ºö‰ªéÂÜÖÂ≠òÈáçÊñ∞ËØªÂèñ„ÄÇ ‰ªÄ‰πàÊòØJava ÂÜÖÂ≠òÊ®°ÂûãÂú®JavaËôöÊãüÊú∫ËßÑËåÉ‰∏≠ËØïÂõæÂÆö‰πâ‰∏ÄÁßçJavaÂÜÖÂ≠òÊ®°ÂûãÔºàJava Memory ModelÔºåJMMÔºâÊù•Â±èËîΩÂêÑ‰∏™Á°¨‰ª∂Âπ≥Âè∞ÂíåÊìç‰ΩúÁ≥ªÁªüÁöÑÂÜÖÂ≠òËÆøÈóÆÂ∑ÆÂºÇÔºå‰ª•ÂÆûÁé∞ËÆ©JavaÁ®ãÂ∫èÂú®ÂêÑÁßçÂπ≥Âè∞‰∏ãÈÉΩËÉΩËææÂà∞‰∏ÄËá¥ÁöÑÂÜÖÂ≠òËÆøÈóÆÊïàÊûú„ÄÇÈÇ£‰πàJavaÂÜÖÂ≠òÊ®°ÂûãËßÑÂÆö‰∫ÜÂì™‰∫õ‰∏úË•øÂë¢ÔºåÂÆÉÂÆö‰πâ‰∫ÜÁ®ãÂ∫è‰∏≠ÂèòÈáèÁöÑËÆøÈóÆËßÑÂàôÔºåÂæÄÂ§ß‰∏ÄÁÇπËØ¥ÊòØÂÆö‰πâ‰∫ÜÁ®ãÂ∫èÊâßË°åÁöÑÊ¨°Â∫è„ÄÇÊ≥®ÊÑèÔºå‰∏∫‰∫ÜËé∑ÂæóËæÉÂ•ΩÁöÑÊâßË°åÊÄßËÉΩÔºåJavaÂÜÖÂ≠òÊ®°ÂûãÂπ∂Ê≤°ÊúâÈôêÂà∂ÊâßË°åÂºïÊìé‰ΩøÁî®Â§ÑÁêÜÂô®ÁöÑÂØÑÂ≠òÂô®ÊàñËÄÖÈ´òÈÄüÁºìÂ≠òÊù•ÊèêÂçáÊåá‰ª§ÊâßË°åÈÄüÂ∫¶Ôºå‰πüÊ≤°ÊúâÈôêÂà∂ÁºñËØëÂô®ÂØπÊåá‰ª§ËøõË°åÈáçÊéíÂ∫è„ÄÇ‰πüÂ∞±ÊòØËØ¥ÔºåÂú®javaÂÜÖÂ≠òÊ®°Âûã‰∏≠Ôºå‰πü‰ºöÂ≠òÂú®ÁºìÂ≠ò‰∏ÄËá¥ÊÄßÈóÆÈ¢òÂíåÊåá‰ª§ÈáçÊéíÂ∫èÁöÑÈóÆÈ¢ò„ÄÇ JavaÂÜÖÂ≠òÊ®°ÂûãËßÑÂÆöÊâÄÊúâÁöÑÂèòÈáèÈÉΩÊòØÂ≠òÂú®‰∏ªÂ≠òÂΩì‰∏≠ÔºàÁ±ª‰ºº‰∫éÂâçÈù¢ËØ¥ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºâÔºåÊØè‰∏™Á∫øÁ®ãÈÉΩÊúâËá™Â∑±ÁöÑÂ∑•‰ΩúÂÜÖÂ≠òÔºàÁ±ª‰ºº‰∫éÂâçÈù¢ÁöÑÈ´òÈÄüÁºìÂ≠òÔºâ„ÄÇÁ∫øÁ®ãÂØπÂèòÈáèÁöÑÊâÄÊúâÊìç‰ΩúÈÉΩÂøÖÈ°ªÂú®Â∑•‰ΩúÂÜÖÂ≠ò‰∏≠ËøõË°åÔºåËÄå‰∏çËÉΩÁõ¥Êé•ÂØπ‰∏ªÂ≠òËøõË°åÊìç‰Ωú„ÄÇÂπ∂‰∏îÊØè‰∏™Á∫øÁ®ã‰∏çËÉΩËÆøÈóÆÂÖ∂‰ªñÁ∫øÁ®ãÁöÑÂ∑•‰ΩúÂÜÖÂ≠ò„ÄÇ Â§öÁ∫øÁ®ã‰∏≠ÂèØËÉΩÂèëÁîüÁöÑÈóÆÈ¢òÂÜÖÂ≠ò‰∏çÂèØËßÅ12345678//Á∫øÁ®ã1boolean stop = false;while(!stop)&#123; doSomething();&#125; //Á∫øÁ®ã2stop = true; Á∫øÁ®ã2ÈÄöËøástop = true Â∞ùËØïÂÅúÊ≠¢Á∫øÁ®ã1ÔºåÁ∫øÁ®ã1‰∏ÄÂÆö‰ºö‰∏≠Êñ≠ÂêóÔºü‰∏ç‰∏ÄÂÆö Âõ†‰∏∫‰∏äÊñáËØ¥Ëøá‰∫ÜÔºåÊØè‰∏™Á∫øÁ®ãÈÉΩ‰ºöÊúâËá™Â∑±ÁöÑÂ∑•‰ΩúÂÜÖÂ≠òÔºåÁ∫øÁ®ã1ËøêË°åÊó∂ÔºåÂú®Â∞ÜstopÂèòÈáèÊã∑Ë¥ùÂà∞Ëá™Â∑±ÁöÑÂ∑•‰ΩúÂÜÖÂ≠ò‰∏≠„ÄÇÁ∫øÁ®ã2ËøôÊó∂ÂÄô‰øÆÊîπ‰∫ÜstopÔºåÁÑ∂ÂêéÊ≤°Êù•ÂæóÂèäÂêåÊ≠•Âà∞‰∏ªÂ≠òÔºåËøôÊó∂ÂÄôÁ∫øÁ®ã2ÂéªÂÅöÂà´ÁöÑÂ∑•‰Ωú‰∫ÜÔºåÁ∫øÁ®ã1‰∏çÁü•ÈÅìÁ∫øÁ®ã2‰øÆÊîπ‰∫ÜÂèòÈáèÔºå‰∏ÄÁõ¥Âæ™ÁéØ‰∏ãÂéª„ÄÇ ÈáçÊéíÂ∫è ‰ªÄ‰πàÊòØÊåá‰ª§ÈáçÊéíÂ∫èÔºü ‰∏ÄËà¨Êù•ËØ¥ÔºåÂ§ÑÁêÜÂô®‰∏∫‰∫ÜÊèêÈ´òÁ®ãÂ∫èËøêË°åÊïàÁéáÔºåÂèØËÉΩ‰ºöÂØπËæìÂÖ•‰ª£Á†ÅËøõË°å‰ºòÂåñÔºåÂÆÉ‰∏ç‰øùËØÅÁ®ãÂ∫è‰∏≠ÂêÑ‰∏™ËØ≠Âè•ÁöÑÊâßË°åÂÖàÂêéÈ°∫Â∫èÂêå‰ª£Á†Å‰∏≠ÁöÑÈ°∫Â∫è‰∏ÄËá¥Ôºå‰ΩÜÊòØÂÆÉ‰ºö‰øùËØÅÁ®ãÂ∫èÊúÄÁªàÊâßË°åÁªìÊûúÂíå‰ª£Á†ÅÈ°∫Â∫èÊâßË°åÁöÑÁªìÊûúÊòØ‰∏ÄËá¥ÁöÑ„ÄÇ ‰æãÂ¶Ç‰∏ãÈù¢‰ª£Á†Å1234int a = 10; //ËØ≠Âè•1int r = 2; //ËØ≠Âè•2a = a + 3; //ËØ≠Âè•3r = a*a; //ËØ≠Âè•4 ÂèØËÉΩÁöÑÈ°∫Â∫è ‰ΩÜÊòØÁªù‰∏çÂèØËÉΩÂá∫Áé∞ ËØ≠Âè•2 -&gt; ËØ≠Âè•1 -&gt; ËØ≠Âè•4 -&gt; ËØ≠Âè•3 ‰∏äËø∞È°∫Â∫èÊîπÂèòÊï∞ÊçÆ‰πãÈó¥ÁöÑ‰æùËµñÂÖ≥Á≥ªÔºåÂ§ÑÁêÜÂô®‰ºöËÄÉËôëËØ≠Âè•‰πãÈó¥ÁöÑ‰æùËµñÂÖ≥Á≥ª ÈáçÊéíÂ∫èÈÄ†ÊàêÁöÑÂΩ±Âìç 123456789//Á∫øÁ®ã1:context = loadContext(); //ËØ≠Âè•1inited = true; //ËØ≠Âè•2 //Á∫øÁ®ã2:while(!inited )&#123; sleep()&#125;doSomethingwithconfig(context); Á∫øÁ®ã1ÁöÑ‰ª£Á†ÅÊ≤°Êúâ‰æùËµñÂÖ≥Á≥ªÔºåÂ¶ÇÊûúÈ°∫Â∫èÂèò‰∏∫‰∫Ü ËØ≠Âè•2 -&gt; ËØ≠Âè•1ÔºåÁ∫øÁ®ã2ÂèØËÉΩÂ∞±‰ºöÊãøÂà∞‰∏Ä‰∏™Ê≤°ÊúâÂàùÂßãÂåñÁöÑ contextÂØπË±°‰ªéËÄåÂØºËá¥Á®ãÂ∫èÂºÇÂ∏∏ÔºåËÄåËøôÁßçÂºÇÂ∏∏ÊòØÂæàÈöæÊéíÊü•ÁöÑ volatile‰ΩúÁî®volatileÂèòÈáèËßÑÂàôÔºöÂØπ‰∏Ä‰∏™ÂèòÈáèÁöÑÂÜôÊìç‰ΩúÂÖàË°åÂèëÁîü‰∫éÂêéÈù¢ÂØπËøô‰∏™ÂèòÈáèÁöÑËØªÊìç‰Ωú ‰∏ÄÊó¶‰∏Ä‰∏™ÂÖ±‰∫´ÂèòÈáèÔºàÁ±ªÁöÑÊàêÂëòÂèòÈáè„ÄÅÁ±ªÁöÑÈùôÊÄÅÊàêÂëòÂèòÈáèÔºâË¢´volatile‰øÆÈ•∞‰πãÂêéÔºåÈÇ£‰πàÂ∞±ÂÖ∑Â§á‰∫Ü‰∏§Â±ÇËØ≠‰πâÔºö 1Ôºâ‰øùËØÅ‰∫Ü‰∏çÂêåÁ∫øÁ®ãÂØπËøô‰∏™ÂèòÈáèËøõË°åÊìç‰ΩúÊó∂ÁöÑÂèØËßÅÊÄßÔºåÂç≥‰∏Ä‰∏™Á∫øÁ®ã‰øÆÊîπ‰∫ÜÊüê‰∏™ÂèòÈáèÁöÑÂÄºÔºåËøôÊñ∞ÂÄºÂØπÂÖ∂‰ªñÁ∫øÁ®ãÊù•ËØ¥ÊòØÁ´ãÂç≥ÂèØËßÅÁöÑ„ÄÇ 2ÔºâÁ¶ÅÊ≠¢ËøõË°åÊåá‰ª§ÈáçÊéíÂ∫è„ÄÇ 1. ÂÜÖÂ≠òÂèØËßÅÊÄßÂèòÈáè‰ΩøÁî®‰∫Üvolatile‰πãÂêéÔºåÊâÄÊúâËØªÂèñÊìç‰ΩúÂÖ®ÈÉ®ÂèëÁîüÂú®‰∏ªÂ≠ò‰∏≠Ôºå‰πüÂ∞±ÈÅøÂÖç‰∫Ü‰∏äËø∞ÁöÑÂÜÖÂ≠ò‰∏çÂèØËßÅÁöÑÈóÆÈ¢ò‰∫Ü 2. Èò≤Ê≠¢ÈáçÊéíÂ∫èvolatileÂÖ≥ÈîÆÂ≠óÁ¶ÅÊ≠¢Êåá‰ª§ÈáçÊéíÂ∫èÊúâ‰∏§Â±ÇÊÑèÊÄùÔºö 1ÔºâÂΩìÁ®ãÂ∫èÊâßË°åÂà∞volatileÂèòÈáèÁöÑËØªÊìç‰ΩúÊàñËÄÖÂÜôÊìç‰ΩúÊó∂ÔºåÂú®ÂÖ∂ÂâçÈù¢ÁöÑÊìç‰ΩúÁöÑÊõ¥ÊîπËÇØÂÆöÂÖ®ÈÉ®Â∑≤ÁªèËøõË°åÔºå‰∏îÁªìÊûúÂ∑≤ÁªèÂØπÂêéÈù¢ÁöÑÊìç‰ΩúÂèØËßÅÔºõÂú®ÂÖ∂ÂêéÈù¢ÁöÑÊìç‰ΩúËÇØÂÆöËøòÊ≤°ÊúâËøõË°åÔºõ 2ÔºâÂú®ËøõË°åÊåá‰ª§‰ºòÂåñÊó∂Ôºå‰∏çËÉΩÂ∞ÜÂú®ÂØπvolatileÂèòÈáèËÆøÈóÆÁöÑËØ≠Âè•ÊîæÂú®ÂÖ∂ÂêéÈù¢ÊâßË°åÔºå‰πü‰∏çËÉΩÊäävolatileÂèòÈáèÂêéÈù¢ÁöÑËØ≠Âè•ÊîæÂà∞ÂÖ∂ÂâçÈù¢ÊâßË°å„ÄÇ volidate Â∫îÁî®Âú∫ÊôØ1.Áä∂ÊÄÅÊ†áËÆ∞123456789volatile boolean flag = false; while(!flag)&#123; doSomething();&#125; public void setFlag() &#123; flag = true;&#125; 12345678910volatile boolean inited = false;//Á∫øÁ®ã1:context = loadContext(); inited = true; //Á∫øÁ®ã2:while(!inited )&#123;sleep()&#125;doSomethingwithconfig(context); 2.ÂèåÈáçÊ£ÄÊü•ÈîÅ Ôºàdouble checkÔºâ1234567891011121314151617class Singleton &#123; private volatile static Singleton instance = null; private Singleton() &#123; &#125; public static Singleton getInstance() &#123; if(instance==null) &#123; synchronized (Singleton.class) &#123; if(instance==null) instance = new Singleton(); &#125; &#125; return instance; &#125;&#125; ÂÖ≥‰∫éÂèåÈáçÊ£ÄÊü•ÈîÅvolatile ÁöÑ‰∏§‰∏™‰ΩúÁî® ÂèØËßÅÊÄß Èò≤Ê≠¢new Singleton()Êó∂ÈáçÊéíÂ∫è ÂàõÂª∫ÂØπË±°ÂèØ‰ª•ÁÆÄÂçïÂàÜËß£‰∏∫‰∏âÊ≠• 1.ÂàÜÈÖçÂÜÖÂ≠òÁ©∫Èó¥ 2.ÂàùÂßãÂåñÂØπË±° 3.Â∞ÜÂØπË±°ÊåáÂêëÂàöÂàÜÈÖçÁöÑÂÜÖÂ≠òÁ©∫Èó¥ Â§ÑÁêÜÂô®Âú®‰ºòÂåñÊÄßËÉΩÊó∂ÔºåÂèØËÉΩ‰ºöÂ∞ÜÁ¨¨‰∫åÊ≠•ÂíåÁ¨¨‰∏âÊ≠•ËøõË°åÈáçÊéíÂ∫èÔºåËøôÊ†∑‰ºöÂØºËá¥Á¨¨‰∫å‰∏™Á∫øÁ®ãËé∑ÂèñÂà∞Êú™ÂàùÂßãÂåñÂÆåÊàêÁöÑÂØπË±°ÔºåÂØºËá¥Á®ãÂ∫èÂºÇÂ∏∏„ÄÇ]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Âπ∂Âèë</tag>
        <tag>Java</tag>
        <tag>Â§öÁ∫øÁ®ã</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot Âπ∂ÂèëÁôªÂΩï‰∫∫Êï∞ÊéßÂà∂]]></title>
    <url>%2Fpost%2F5f58dc01.html</url>
    <content type="text"><![CDATA[ÈÄöÂ∏∏Á≥ªÁªüÈÉΩ‰ºöÈôêÂà∂Âêå‰∏Ä‰∏™Ë¥¶Âè∑ÁöÑÁôªÂΩï‰∫∫Êï∞ÔºåÂ§ö‰∫∫ÁôªÂΩïË¶Å‰πàÈôêÂà∂ÂêéËÄÖÁôªÂΩïÔºåË¶Å‰πàË∏¢Âá∫ÂâçËÄÖÔºåSpring Security Êèê‰æõ‰∫ÜËøôÊ†∑ÁöÑÂäüËÉΩÔºåÊú¨ÊñáËÆ≤Ëß£‰∏Ä‰∏ãÂú®Ê≤°Êúâ‰ΩøÁî®SecurityÁöÑÊó∂ÂÄôÂ¶Ç‰ΩïÊâãÂä®ÂÆûÁé∞Ëøô‰∏™ÂäüËÉΩ Êú¨ÊñáÂÄüÈâ¥‰∫Ü https://jinnianshilongnian.iteye.com/blog/2039760, Â¶ÇÊûú‰Ω†ÊòØ‰ΩøÁî® Shiro + Session ÁöÑÊ®°ÂºèÔºåÊé®ËçêÈòÖËØªÊ≠§Êñá demo ÊäÄÊúØÈÄâÂûã SpringBoot JWT Filter Redis + Redisson JWTÔºàtokenÔºâÂ≠òÂÇ®Âú®Redis‰∏≠ÔºåÁ±ª‰ºº JSessionId-SessionÁöÑÂÖ≥Á≥ªÔºåÁî®Êà∑ÁôªÂΩïÂêéÊØèÊ¨°ËØ∑Ê±ÇÂú®Header‰∏≠Êê∫Â∏¶jwt Â¶ÇÊûú‰Ω†ÊòØ‰ΩøÁî®sessionÁöÑËØùÔºå‰πüÂÆåÂÖ®ÂèØ‰ª•ÂÄüÈâ¥Êú¨ÊñáÁöÑÊÄùË∑ØÔºåÂè™ÊòØ‰ª£Á†Å‰∏äÈúÄË¶ÅÂä†‰∫õÊîπÂä® ‰∏§ÁßçÂÆûÁé∞ÊÄùË∑ØÊØîËæÉÊó∂Èó¥Êà≥Áª¥Êä§‰∏Ä‰∏™ username: jwtToken ËøôÊ†∑ÁöÑ‰∏Ä‰∏™ key-value Âú®Reids‰∏≠, FilterÈÄªËæëÂ¶Ç‰∏ã 123456789101112131415161718192021222324252627282930313233343536373839404142public class CompareKickOutFilter extends KickOutFilter &#123; @Autowired private UserService userService; @Override public boolean isAccessAllowed(HttpServletRequest request, HttpServletResponse response) &#123; String token = request.getHeader("Authorization"); String username = JWTUtil.getUsername(token); String userKey = PREFIX + username; RBucket&lt;String&gt; bucket = redissonClient.getBucket(userKey); String redisToken = bucket.get(); if (token.equals(redisToken)) &#123; return true; &#125; else if (StringUtils.isBlank(redisToken)) &#123; bucket.set(token); &#125; else &#123; Long redisTokenUnixTime = JWTUtil.getClaim(redisToken, "createTime").asLong(); Long tokenUnixTime = JWTUtil.getClaim(token, "createTime").asLong(); // token &gt; redisToken ÂàôË¶ÜÁõñ if (tokenUnixTime.compareTo(redisTokenUnixTime) &gt; 0) &#123; bucket.set(token); &#125; else &#123; // Ê≥®ÈîÄÂΩìÂâçtoken userService.logout(token); sendJsonResponse(response, 4001, "ÊÇ®ÁöÑË¥¶Âè∑Â∑≤Âú®ÂÖ∂‰ªñËÆæÂ§áÁôªÂΩï"); return false; &#125; &#125; return true; &#125;&#125; ÈòüÂàóË∏¢Âá∫ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192public class QueueKickOutFilter extends KickOutFilter &#123; /** * Ë∏¢Âá∫‰πãÂâçÁôªÂΩïÁöÑ/‰πãÂêéÁôªÂΩïÁöÑÁî®Êà∑ ÈªòËÆ§Ë∏¢Âá∫‰πãÂâçÁôªÂΩïÁöÑÁî®Êà∑ */ private boolean kickoutAfter = false; /** * Âêå‰∏Ä‰∏™Â∏êÂè∑ÊúÄÂ§ß‰ºöËØùÊï∞ ÈªòËÆ§1 */ private int maxSession = 1; public void setKickoutAfter(boolean kickoutAfter) &#123; this.kickoutAfter = kickoutAfter; &#125; public void setMaxSession(int maxSession) &#123; this.maxSession = maxSession; &#125; @Override public boolean isAccessAllowed(HttpServletRequest request, HttpServletResponse response) throws Exception &#123; String token = request.getHeader("Authorization"); UserBO currentSession = CurrentUser.get(); Assert.notNull(currentSession, "currentSession cannot null"); String username = currentSession.getUsername(); String userKey = PREFIX + "deque_" + username; String lockKey = PREFIX_LOCK + username; RLock lock = redissonClient.getLock(lockKey); lock.lock(2, TimeUnit.SECONDS); try &#123; RDeque&lt;String&gt; deque = redissonClient.getDeque(userKey); // Â¶ÇÊûúÈòüÂàóÈáåÊ≤°ÊúâÊ≠§tokenÔºå‰∏îÁî®Êà∑Ê≤°ÊúâË¢´Ë∏¢Âá∫ÔºõÊîæÂÖ•ÈòüÂàó if (!deque.contains(token) &amp;&amp; currentSession.isKickout() == false) &#123; deque.push(token); &#125; // Â¶ÇÊûúÈòüÂàóÈáåÁöÑsessionIdÊï∞Ë∂ÖÂá∫ÊúÄÂ§ß‰ºöËØùÊï∞ÔºåÂºÄÂßãË∏¢‰∫∫ while (deque.size() &gt; maxSession) &#123; String kickoutSessionId; if (kickoutAfter) &#123; // Â¶ÇÊûúË∏¢Âá∫ÂêéËÄÖ kickoutSessionId = deque.removeFirst(); &#125; else &#123; // Âê¶ÂàôË∏¢Âá∫ÂâçËÄÖ kickoutSessionId = deque.removeLast(); &#125; try &#123; RBucket&lt;UserBO&gt; bucket = redissonClient.getBucket(kickoutSessionId); UserBO kickoutSession = bucket.get(); if (kickoutSession != null) &#123; // ËÆæÁΩÆ‰ºöËØùÁöÑkickoutÂ±ûÊÄßË°®Á§∫Ë∏¢Âá∫‰∫Ü kickoutSession.setKickout(true); bucket.set(kickoutSession); &#125; &#125; catch (Exception e) &#123; &#125; &#125; // Â¶ÇÊûúË¢´Ë∏¢Âá∫‰∫ÜÔºåÁõ¥Êé•ÈÄÄÂá∫ÔºåÈáçÂÆöÂêëÂà∞Ë∏¢Âá∫ÂêéÁöÑÂú∞ÂùÄ if (currentSession.isKickout()) &#123; // ‰ºöËØùË¢´Ë∏¢Âá∫‰∫Ü try &#123; // Ê≥®ÈîÄ userService.logout(token); sendJsonResponse(response, 4001, "ÊÇ®ÁöÑË¥¶Âè∑Â∑≤Âú®ÂÖ∂‰ªñËÆæÂ§áÁôªÂΩï"); &#125; catch (Exception e) &#123; &#125; return false; &#125; &#125; finally &#123; if (lock.isHeldByCurrentThread()) &#123; lock.unlock(); LOGGER.info(Thread.currentThread().getName() + " unlock"); &#125; else &#123; LOGGER.info(Thread.currentThread().getName() + " already automatically release lock"); &#125; &#125; return true; &#125;&#125; ÊØîËæÉ‰∏§ÁßçÊñπÊ≥ï Á¨¨‰∏ÄÁßçÊñπÊ≥ïÈÄªËæëÁÆÄÂçïÁ≤óÊö¥, Âè™Áª¥Êä§‰∏Ä‰∏™key-value ‰∏çÈúÄË¶Å‰ΩøÁî®ÈîÅÔºåÈùûË¶ÅËØ¥Áº∫ÁÇπÁöÑËØùÊ≤°ÊúâÁ¨¨‰∫åÁßçÊñπÊ≥ïÁÅµÊ¥ª„ÄÇ Á¨¨‰∫åÁßçÊñπÊ≥ïÊàëÂæàÂñúÊ¨¢Ôºå‰ª£Á†ÅÂæà‰ºòÈõÖÁÅµÊ¥ªÔºå‰ΩÜÊòØÈÄªËæëÁõ∏ÂØπÈ∫ªÁÉ¶‰∏Ä‰∫õÔºåËÄå‰∏î‰∏∫‰∫Ü‰øùËØÅÁ∫øÁ®ãÂÆâÂÖ®Âú∞Êìç‰ΩúÈòüÂàóÔºåË¶Å‰ΩøÁî®ÂàÜÂ∏ÉÂºèÈîÅ„ÄÇÁõÆÂâçÊàë‰ª¨È°πÁõÆ‰∏≠‰ΩøÁî®ÁöÑÊòØÁ¨¨‰∏ÄÁßçÊñπÊ≥ï ÊºîÁ§∫‰∏ãËΩΩÂú∞ÂùÄ: https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/login-control ËøêË°åÈ°πÁõÆÔºåËÆøÈóÆlocalhost:8887 demo‰∏≠Ê≤°ÊúâÂ≠òÂÇ®Áî®Êà∑‰ø°ÊÅØÔºåÈöèÊÑèËæìÂÖ•Áî®Êà∑ÂêçÂØÜÁ†ÅÔºåÁî®Êà∑ÂêçÁõ∏ÂêåÂàôË¢´Ë∏¢Âá∫ ËÆøÈóÆ localhost:8887/index.html ÂºπÂá∫Áî®Êà∑‰ø°ÊÅØ, ‰ª£Ë°®ÂΩìÂâçÁî®Êà∑ÊúâÊïà Âè¶‰∏Ä‰∏™ÊµèËßàÂô®ÁôªÂΩïÁõ∏ÂêåÁî®Êà∑ÂêçÔºåÂõûÂà∞Á¨¨‰∏Ä‰∏™ÊµèËßàÂô®Âà∑Êñ∞È°µÈù¢ÔºåÊèêÁ§∫Ë¢´Ë∏¢Âá∫ application.properties‰∏≠ÈÄâÊã©ÂºÄÂêØÂì™ÁßçËøáÊª§Âô®Ê®°ÂºèÔºåÈªòËÆ§ÊòØÊØîËæÉÊó∂Èó¥Êà≥Ë∏¢Âá∫ÔºåÂºÄÂêØÈòüÂàóË∏¢Âá∫ queue-filter.enabled=true]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Âπ∂Âèë</tag>
        <tag>Redis</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JavaÁêÜËß£Áîü‰∫ßËÄÖ-Ê∂àË¥πËÄÖËÆæËÆ°Ê®°Âºè]]></title>
    <url>%2Fpost%2F5b860a98.html</url>
    <content type="text"><![CDATA[Âú®ÂÆûÈôÖÁöÑËΩØ‰ª∂ÂºÄÂèëËøáÁ®ã‰∏≠ÔºåÁªèÂ∏∏‰ºöÁ¢∞Âà∞Â¶Ç‰∏ãÂú∫ÊôØÔºöÊüê‰∏™Ê®°ÂùóË¥üË¥£‰∫ßÁîüÊï∞ÊçÆÔºåËøô‰∫õÊï∞ÊçÆÁî±Âè¶‰∏Ä‰∏™Ê®°ÂùóÊù•Ë¥üË¥£Â§ÑÁêÜÔºàÊ≠§Â§ÑÁöÑÊ®°ÂùóÊòØÂπø‰πâÁöÑÔºåÂèØ‰ª•ÊòØÁ±ª„ÄÅÂáΩÊï∞„ÄÅÁ∫øÁ®ã„ÄÅËøõÁ®ãÁ≠âÔºâ„ÄÇ‰∫ßÁîüÊï∞ÊçÆÁöÑÊ®°ÂùóÔºåÂ∞±ÂΩ¢Ë±°Âú∞Áß∞‰∏∫Áîü‰∫ßËÄÖÔºõËÄåÂ§ÑÁêÜÊï∞ÊçÆÁöÑÊ®°ÂùóÔºåÂ∞±Áß∞‰∏∫Ê∂àË¥πËÄÖÔºõ Áîü‰∫ßËÄÖÂíåÊ∂àË¥πËÄÖ‰πãÈó¥ÈÄöËøáÁºìÂÜ≤Âå∫(ÈÄöÂ∏∏ÊòØ‰∏Ä‰∏™ÈòªÂ°ûÈòüÂàó)ÂÆûÁé∞ÈÄöËÆØ, Áîü‰∫ßËÄÖÂ∞Ü‰∫ßÁîüÁöÑÊï∞ÊçÆÊîæÂÖ•ÁºìÂÜ≤Âå∫ÔºåÊ∂àË¥πËÄÖ‰ªéÁºìÂÜ≤Âå∫‰∏≠Ëé∑ÂèñÊï∞ÊçÆ„ÄÇ ‰∏æ‰∏™Ê†óÂ≠êÂéªÈ£üÂ†ÇÂêÉÈ•≠ÔºåÈ£üÂ†ÇÁöÑÂèîÂèîÈòøÂß®‰ºöÂÖàÂ∞ÜÈ•≠ÂÅöÂ•ΩÔºåÊîæÂà∞È£üÂ†ÇÁ™óÂè£ÔºåÂêåÂ≠¶‰ª¨‰ºöÂéªÈ£üÂ†ÇÊâìÈ•≠„ÄÇ Áîü‰∫ßËÄÖ(È£üÂ†ÇÁöÑÂèîÂèîÈòøÂß®) -&gt; Áîü‰∫ßÊï∞ÊçÆ(ÂÅöÈ•≠) -&gt; ÁºìÂÜ≤Âå∫(È£üÂ†ÇÁ™óÂè£) -&gt; Ê∂àË¥πÊï∞ÊçÆ(ÊâìÈ•≠) -&gt; Ê∂àË¥πËÄÖ(ÂêåÂ≠¶) Áîü‰∫ßËÄÖÊ∂àË¥πËÄÖÂÆûÁé∞ÊÄùË∑Ø Áîü‰∫ßËÄÖÂíåÊ∂àË¥πËÄÖÁöÑ‰ªªÂä°ÂæàÊòéÁ°ÆÔºåÁîü‰∫ßËÄÖÂè™ÁÆ°Áîü‰∫ßÊï∞ÊçÆÔºåÁÑ∂ÂêéÊ∑ªÂä†Âà∞ÁºìÂÜ≤ÈòüÂàó„ÄÇËÄåÊ∂àË¥πËÄÖÂè™ÁÆ°‰ªéÁºìÂÜ≤ÈòüÂàó‰∏≠Ëé∑ÂèñÊï∞ÊçÆ ÂèØ‰ª•ËØ¥Áîü‰∫ßËÄÖÊ∂àË¥πËÄÖÈÉΩÂæàÊó†ËÑëÔºåËÄåÁºìÂÜ≤ÈòüÂàóÂàôË¶ÅÂøô‰∏Ä‰∫õÔºå‰ªñËµ∑Âà∞‰∫Ü‰∏Ä‰∏™Âπ≥Ë°°Áîü‰∫ßËÄÖÂíåÊ∂àË¥πËÄÖÁöÑ‰ΩúÁî®„ÄÇ Â¶ÇÊûúÁîü‰∫ßËÄÖÁîü‰∫ßÈÄüÂ∫¶ËøáÂø´ÔºåÊ∂àË¥πËÄÖÊ∂àË¥πÁöÑÂæàÊÖ¢ÔºåÂπ∂‰∏îÁºìÂÜ≤ÈòüÂàóËææÂà∞‰∫ÜÊúÄÂ§ßÈïøÂ∫¶Êó∂„ÄÇÁºìÂÜ≤ÈòüÂàó‰ºöÈòªÂ°ûÁîü‰∫ßËÄÖÔºåËÆ©Áîü‰∫ßËÄÖÂÅúÊ≠¢Áîü‰∫ßÔºåÁ≠âÂæÖÊ∂àË¥πËÄÖÊ∂àË¥π‰∫ÜÊï∞ÊçÆÂêéÔºåÂÜçÂî§ÈÜíÁîü‰∫ßËÄÖ ÂêåÁêÜÔºåÂΩìÊ∂àË¥πËÄÖÊ∂àË¥πÈÄüÂ∫¶ËøáÂø´Êó∂ÔºåÈòüÂàó‰∏∫Á©∫Êó∂„ÄÇÁºìÂÜ≤ÈòüÂàóÂàô‰ºöÈòªÂ°ûÊ∂àË¥πËÄÖÔºåÂæÖÁîü‰∫ßËÄÖÂêëÈòüÂàóÊ∑ªÂä†Êï∞ÊçÆÂêéÔºåÂÜçÂî§ÈÜíÊ∂àË¥πËÄÖ ÂÆûÁé∞ÈÄöËøá‰∏äËø∞ÁöÑÂàÜÊûêÂêéÔºåÊàë‰ª¨Êù•Áî®ÊúÄÂü∫Êú¨ÁöÑJava‰ª£Á†ÅÂÆûÁé∞‰∏Ä‰∏ã Êàë‰ª¨ÂÖàÊù•ÂÆö‰πâ‰∏Ä‰∏ãConsumer ÂíåProducer Ôºå‰ªñ‰ª¨ÁöÑÈÄªËæëÊØîËæÉÁÆÄÂçïÔºåËøôÈáåÊàë‰ª¨Âè™Âæ™ÁéØÂçÅÊ¨°Ê®°Êãü‰∏Ä‰∏ãÁîü‰∫ßÊ∂àË¥πÁöÑÂú∫ÊôØ„ÄÇBuffer ‰∏∫ÁºìÂÜ≤Âå∫ÔºåÊàë‰ª¨ÂæÖ‰ºöÂÜçÁúã1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/** * Ê∂àË¥πËÄÖ */class Consumer extends Thread &#123; private Buffer buffer; private int number; public Consumer(Buffer b, int number) &#123; buffer = b; this.number = number; &#125; public void run() &#123; int value; for (int i = 0; i &lt; 10; i++) &#123; // ‰ªéÁºìÂÜ≤Âå∫‰∏≠Ëé∑ÂèñÊï∞ÊçÆ value = buffer.get(); try &#123; // Ê®°ÊãüÊ∂àË¥πÊï∞ÊçÆ sleep(1000); &#125; catch (InterruptedException e) &#123; &#125; System.out.println("Ê∂àË¥πËÄÖ #" + this.number + " got: " + value); &#125; &#125;&#125;/** * Áîü‰∫ßËÄÖ */class Producer extends Thread &#123; private Buffer buffer; private int number; public Producer(Buffer b, int number) &#123; buffer = b; this.number = number; &#125; public void run() &#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; // Ê®°ÊãüÁîü‰∫ßÊï∞ÊçÆ sleep(500); &#125; catch (InterruptedException e) &#123; &#125; // Â∞ÜÊï∞ÊçÆÊîæÂÖ•ÁºìÂÜ≤Âå∫ buffer.put(i); System.out.println("Áîü‰∫ßËÄÖ #" + this.number + " put: " + i); &#125; &#125;&#125; ÂèØ‰ª•ÁúãÂà∞ Consumer ÂíåProducer Ê≤°Êúâ‰ªÄ‰πàÈÄªËæëÔºåÂè™ÊòØÂØπÁºìÂÜ≤Âå∫ÁöÑËØªÂÜôÊìç‰ΩúÔºå‰∏ãÈù¢Êàë‰ª¨Êù•ÈáçÁÇπÁúã‰∏Ä‰∏ã BufferÁöÑÂÆûÁé∞ 12345678910111213141516171819202122232425262728293031/** * ÁºìÂÜ≤Âå∫ */class Buffer &#123; private List&lt;Integer&gt; data = new ArrayList&lt;&gt;(); private static final int MAX = 10; private static final int MIN = 0; public synchronized int get() &#123; while (MIN == data.size()) &#123; try &#123; wait(); &#125; catch (InterruptedException e) &#123; &#125; &#125; Integer i = data.remove(0); notifyAll(); return i; &#125; public synchronized void put(int value) &#123; while (MAX == data.size()) &#123; try &#123; wait(); &#125; catch (InterruptedException e) &#123; &#125; &#125; data.add(value); notifyAll(); &#125;&#125; ÂàÜÊûêput(): Áîü‰∫ßËÄÖÂêëÁºìÂÜ≤Âå∫ÂÜôÂÖ•Êï∞ÊçÆÁöÑÊìç‰ΩúÔºåÂΩìMAX == data.size()Êó∂ÔºåÂ∞±ÊòØÊàë‰ª¨ÂàöÂàöÊâÄËØ¥ÁöÑÁîü‰∫ßËÄÖÈÄüÂ∫¶ËøáÂø´ÔºåÊ∂àË¥πËÄÖÈÄüÂ∫¶ËøáÊÖ¢ÁöÑÊÉÖÂÜµÔºåËøô‰∏™Êó∂ÂÄôË∫´‰∏∫ ‚ÄúÁºìÂÜ≤Âå∫‚Äù Ë¶ÅÂπ≥Ë°°‰∏Ä‰∏ãÔºåË∞ÉÁî® Object.wait()ÔºåËÆ©ÂΩìÂâçÁîü‰∫ßËÄÖÁ∫øÁ®ãËøõÂÖ•ÊåÇËµ∑Áä∂ÊÄÅÔºåÁ≠âÂæÖÊ∂àË¥πËÄÖÊ∂àË¥πÊï∞ÊçÆÂêéÂ∞ÜÂÖ∂Âî§ÈÜí ÂΩìMAX &gt; data.size()Êó∂ÔºåÂêëArrayList‰∏≠Ê∑ªÂä†Êï∞ÊçÆÔºåÂπ∂Â∞ùËØïÂî§ÈÜíÊ≠£Âú®Á≠âÂæÖÁöÑÊ∂àË¥πËÄÖÔºàËøô‰∏ÄÊ≠•ÊòØÂøÖÈ°ªÁöÑÔºâ get(): Ê∂àË¥πËÄÖÂêëÁºìÂÜ≤Âå∫ËØªÊï∞ÊçÆÁöÑÊìç‰ΩúÔºåÂíå‰∏äËø∞ÈÄªËæëÁõ∏ÂèçÔºåÂΩìMIN == data.size()Êó∂ÔºåËøôÊó∂Ê∂àË¥πËÄÖÈÄüÂ∫¶Â§™Âø´ÔºåÁîü‰∫ßËÄÖÂ§™ÊÖ¢ÔºåÈòüÂàó‰∏≠Â∑≤ÁªèÊ≤°ÊúâÊï∞ÊçÆ‰∫Ü„ÄÇ‚ÄùÁºìÂÜ≤Âå∫‚Äù ÂÜç‰∏ÄÊ¨°Á´ô‰∫ÜÂá∫Êù•ÔºåÈÄöËøáwait()ÔºåËÆ©ÂΩìÂâçÊ∂àË¥πËÄÖÁ∫øÁ®ãËøõÂÖ•ÊåÇËµ∑Áä∂ÊÄÅÔºåÁ≠âÂæÖÁîü‰∫ßËÄÖÁîü‰∫ßÊï∞ÊçÆÂêéÂ∞ÜÂÖ∂Âî§ÈÜí ÂΩìMIN &lt; data.size()Êó∂ÔºåÂèñÂá∫ArrayList‰∏≠Á¨¨‰∏ÄÊù°Êï∞ÊçÆÔºåÂπ∂Â∞ùËØïÂî§ÈÜíÊ≠£Âú®Á≠âÂæÖÁöÑÁîü‰∫ßËÄÖ ‰∏äËø∞Ê°à‰æãÂÆåÊï¥‰ª£Á†Å ProducerConsumer.java ‰∏äËø∞‰ΩøÁî®ÊúÄÂü∫Êú¨ÁöÑJava‰ª£Á†ÅÂÆûÁé∞Áîü‰∫ßËÄÖÊ∂àË¥πËÄÖÊ®°ÂºèÔºåÂÆûÈôÖÂºÄÂèë‰∏≠Êàë‰ª¨ÂèØËÉΩ‰ºö‰ΩøÁî®BlockingQueue„ÄÅReentrantLock„ÄÅThreadPoolExecutorËøô‰∫õÊõ¥ÊàêÁÜüÁöÑËΩÆÂ≠êÔºå‰ΩÜÊòØ‰∏ÄÈÄöÁôæÈÄö ÂÖ≥‰∫é‰∏äËø∞Ê°à‰æãÁöÑÊÄùËÄÉ ‰∏∫‰ªÄ‰πàÁºìÂÜ≤Âå∫ÁöÑÂà§Êñ≠Êù°‰ª∂ÊòØ while(condition) ËÄå‰∏çÊòØ if(condition)ÔºüÁ≠îÔºöÈò≤Ê≠¢Á∫øÁ®ãË¢´ÈîôËØØÁöÑÂî§ÈÜí‰∏æ‰æãÔºöÂΩìÊúâ‰∏§‰∏™Ê∂àË¥πËÄÖÁ∫øÁ®ãwait() Êó∂ÔºåÊ≠§Êó∂Áîü‰∫ßËÄÖÂú®ÈòüÂàóÈáåÊîæÂÖ•‰∫Ü‰∏ÄÊù°Êï∞ÊçÆÔºåÂπ∂Ë∞ÉÁî®notifyAll(), ‰∏§‰∏™Ê∂àË¥πËÄÖÁ∫øÁ®ãË¢´Âî§ÈÜíÔºåÁ¨¨‰∏Ä‰∏™Ê∂àË¥πËÄÖÊàêÂäüÂèñÂá∫ÈòüÂàó‰∏≠Êï∞ÊçÆÔºåËÄåÁ¨¨‰∫å‰∏™Ê∂àË¥πËÄÖÊ≠§Êó∂Â∞±ÊòØË¢´ÈîôËØØÁöÑÂî§ÈÜí‰∫ÜÔºåÁ®ãÂ∫èÊäõÂá∫ÂºÇÂ∏∏ÔºåÊâÄ‰ª•Ê≠§Â§Ñ‰ΩøÁî® while(condition)Âæ™ÁéØÊ£ÄÊü• Java‰∏≠Ë¶ÅÊ±Çwait()ÊñπÊ≥ï‰∏∫‰ªÄ‰πàË¶ÅÊîæÂú®ÂêåÊ≠•Âùó‰∏≠ÔºüÁ≠îÔºöÈò≤Ê≠¢Âá∫Áé∞Lost Wake-Up‰∏æ‰æãÔºöÂ¶ÇÊûúÈòüÂàóÊ≤°ÊúâÂêåÊ≠•ÈôêÂà∂ÔºåÊ∂àË¥πËÄÖÂíåÁîü‰∫ßËÄÖÂπ∂ÂèëÊâßË°åÔºåÂæàÂèØËÉΩÂá∫Áé∞ËøôÁßçÊÉÖÂÜµÔºåÊ∂àË¥πËÄÖËøôÊó∂ÂÄôÊ£ÄÊü•‰∫ÜÊù°‰ª∂Ê≠£ÂáÜÂ§áwait(),ËøôÊó∂ÂÄô‰∏ä‰∏ãÊñáÂàáÊç¢Âà∞‰∫ÜÁîü‰∫ßËÄÖÔºåÁîü‰∫ßËÄÖÂíîÂíî‰∏ÄÈ°øÊìç‰ΩúÂêëÈòüÂàó‰∏≠Ê∑ªÂä†‰∫ÜÊï∞ÊçÆÔºåÂπ∂Âî§ÈÜí‰∫ÜÊ∂àË¥πËÄÖÔºåËÄåÊ≠§Êó∂Ê∂àË¥πËÄÖÂπ∂Ê≤°Êúâwait()ÔºåËøô‰∏™ÈÄöÁü•Â∞±‰∏¢Êéâ‰∫ÜÔºåÁÑ∂ÂêéÊ∂àË¥πËÄÖwait() Â∞±ËøôÊ†∑Áù°Âéª‰∫Ü‚Ä¶ ‰∏∫‰ªÄ‰πàÁºìÂÜ≤Âå∫‰∏ÄÂÆöË¶Å‰ΩøÁî®ÈòªÂ°ûÈòüÂàóÂÆûÁé∞ÔºüÂêåÁêÜÂ∞±ÊòØ‰∏∫‰∫ÜÈò≤Ê≠¢Âá∫Áé∞Lost Wake-Up ‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®Áîü‰∫ßËÄÖÊ∂àË¥πËÄÖÊ®°ÂºèÈ°∫Â∫èÊâßË°å‰∏çÂ∞±ÂèØ‰ª•‰∫ÜÂêóÔºüÁîü‰∫ßËÄÖÊ∂àË¥πËÄÖÂà∞Â∫ïÊúâ‰ªÄ‰πàÊÑè‰πâÔºü Âπ∂Âèë ÔºàÂºÇÊ≠•ÔºâÁîü‰∫ßËÄÖÁõ¥Êé•Ë∞ÉÁî®Ê∂àË¥πËÄÖÔºå‰∏§ËÄÖÊòØÂêåÊ≠•ÔºàÈòªÂ°ûÔºâÁöÑÔºåÂ¶ÇÊûúÊ∂àË¥πËÄÖÂêûÂêêÊï∞ÊçÆÂæàÊÖ¢ÔºåËøôÊó∂ÂÄôÁîü‰∫ßËÄÖÁôΩÁôΩÊµ™Ë¥πÂ§ßÂ•ΩÊó∂ÂÖâ„ÄÇËÄå‰ΩøÁî®ËøôÁßçÊ®°Âºè‰πãÂêéÔºåÁîü‰∫ßËÄÖÂ∞ÜÊï∞ÊçÆ‰∏¢Âà∞ÁºìÂÜ≤Âå∫ÔºåÁªßÁª≠Áîü‰∫ßÔºåÂÆåÂÖ®‰∏ç‰æùËµñÊ∂àË¥πËÄÖÔºåÁ®ãÂ∫èÊâßË°åÊïàÁéá‰ºöÂ§ßÂ§ßÊèêÈ´ò„ÄÇ Ëß£ËÄ¶Áîü‰∫ßËÄÖÂíåÊ∂àË¥πËÄÖ‰πãÈó¥‰∏çÁõ¥Êé•‰æùËµñÔºåÈÄöËøáÁºìÂÜ≤Âå∫ÈÄöËÆØÔºåÂ∞Ü‰∏§‰∏™Á±ª‰πãÈó¥ÁöÑËÄ¶ÂêàÂ∫¶ÈôçÂà∞ÊúÄ‰Ωé„ÄÇ ÂèÇËÄÉhttps://blog.csdn.net/u011109589/article/details/80519863]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Âπ∂Âèë</tag>
        <tag>Java</tag>
        <tag>Â§öÁ∫øÁ®ã</tag>
        <tag>ËÆæËÆ°Ê®°Âºè</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Boot ‰ΩøÁî® AOP Èò≤Ê≠¢ÈáçÂ§çÊèê‰∫§]]></title>
    <url>%2Fpost%2F8398a16a.html</url>
    <content type="text"><![CDATA[Âú®‰º†ÁªüÁöÑwebÈ°πÁõÆ‰∏≠ÔºåÈò≤Ê≠¢ÈáçÂ§çÊèê‰∫§ÔºåÈÄöÂ∏∏ÂÅöÊ≥ïÊòØÔºöÂêéÁ´ØÁîüÊàê‰∏Ä‰∏™ÂîØ‰∏ÄÁöÑÊèê‰∫§‰ª§ÁâåÔºàuuidÔºâÔºåÂπ∂Â≠òÂÇ®Âú®ÊúçÂä°Á´Ø„ÄÇÈ°µÈù¢Êèê‰∫§ËØ∑Ê±ÇÊê∫Â∏¶Ëøô‰∏™Êèê‰∫§‰ª§ÁâåÔºåÂêéÁ´ØÈ™åËØÅÂπ∂Âú®Á¨¨‰∏ÄÊ¨°È™åËØÅÂêéÂà†Èô§ËØ•‰ª§ÁâåÔºå‰øùËØÅÊèê‰∫§ËØ∑Ê±ÇÁöÑÂîØ‰∏ÄÊÄß„ÄÇ ‰∏äËø∞ÁöÑÊÄùË∑ØÂÖ∂ÂÆûÊ≤°ÊúâÈóÆÈ¢òÁöÑÔºå‰ΩÜÊòØÈúÄË¶ÅÂâçÂêéÁ´ØÈÉΩÁ®çÂä†ÊîπÂä®ÔºåÂ¶ÇÊûúÂú®‰∏öÂä°ÂºÄÂèëÂÆåÂú®Âä†Ëøô‰∏™ÁöÑËØùÔºåÊîπÂä®ÈáèÊú™ÂÖçÊúâ‰∫õÂ§ß‰∫ÜÔºåÊú¨ËäÇÁöÑÂÆûÁé∞ÊñπÊ°àÊó†ÈúÄÂâçÁ´ØÈÖçÂêàÔºåÁ∫ØÂêéÁ´ØÂ§ÑÁêÜ„ÄÇ ÊÄùË∑Ø Ëá™ÂÆö‰πâÊ≥®Ëß£ @NoRepeatSubmit Ê†áËÆ∞ÊâÄÊúâController‰∏≠ÁöÑÊèê‰∫§ËØ∑Ê±Ç ÈÄöËøáAOP ÂØπÊâÄÊúâÊ†áËÆ∞‰∫Ü @NoRepeatSubmit ÁöÑÊñπÊ≥ïÊã¶Êà™ Âú®‰∏öÂä°ÊñπÊ≥ïÊâßË°åÂâçÔºåËé∑ÂèñÂΩìÂâçÁî®Êà∑ÁöÑ tokenÔºàÊàñËÄÖJSessionIdÔºâ+ ÂΩìÂâçËØ∑Ê±ÇÂú∞ÂùÄÔºå‰Ωú‰∏∫‰∏Ä‰∏™ÂîØ‰∏Ä KEYÔºåÂéªËé∑Âèñ Redis ÂàÜÂ∏ÉÂºèÈîÅÔºàÂ¶ÇÊûúÊ≠§Êó∂Âπ∂ÂèëËé∑ÂèñÔºåÂè™Êúâ‰∏Ä‰∏™Á∫øÁ®ã‰ºöÊàêÂäüËé∑ÂèñÈîÅÔºâ ‰∏öÂä°ÊñπÊ≥ïÊâßË°åÂêéÔºåÈáäÊîæÈîÅ ÂÖ≥‰∫éRedis ÂàÜÂ∏ÉÂºèÈîÅ ‰∏ç‰∫ÜËß£ÁöÑÂêåÂ≠¶Êà≥ËøôÈáå ==&gt; RedisÂàÜÂ∏ÉÂºèÈîÅÁöÑÊ≠£Á°ÆÂÆûÁé∞ÊñπÂºè ‰ΩøÁî®Redis ÊòØ‰∏∫‰∫ÜÂú®Ë¥üËΩΩÂùáË°°ÈÉ®ÁΩ≤ÔºåÂ¶ÇÊûúÊòØÂçïÊú∫ÁöÑÈÉ®ÁΩ≤ÁöÑÈ°πÁõÆÂèØ‰ª•‰ΩøÁî®‰∏Ä‰∏™Á∫øÁ®ãÂÆâÂÖ®ÁöÑÊú¨Âú∞Cache Êõø‰ª£ Redis CodeËøôÈáåÂè™Ë¥¥Âá∫ AOP Á±ªÂíåÊµãËØïÁ±ªÔºåÂÆåÊï¥‰ª£Á†ÅËßÅ ==&gt; Gitee12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061@Aspect@Componentpublic class RepeatSubmitAspect &#123; private final static Logger LOGGER = LoggerFactory.getLogger(RepeatSubmitAspect.class); @Autowired private RedisLock redisLock; @Pointcut("@annotation(noRepeatSubmit)") public void pointCut(NoRepeatSubmit noRepeatSubmit) &#123; &#125; @Around("pointCut(noRepeatSubmit)") public Object around(ProceedingJoinPoint pjp, NoRepeatSubmit noRepeatSubmit) throws Throwable &#123; int lockSeconds = noRepeatSubmit.lockTime(); HttpServletRequest request = RequestUtils.getRequest(); Assert.notNull(request, "request can not null"); // Ê≠§Â§ÑÂèØ‰ª•Áî®tokenÊàñËÄÖJSessionId String token = request.getHeader("Authorization"); String path = request.getServletPath(); String key = getKey(token, path); String clientId = getClientId(); boolean isSuccess = redisLock.tryLock(key, clientId, lockSeconds); if (isSuccess) &#123; LOGGER.info("tryLock success, key = [&#123;&#125;], clientId = [&#123;&#125;]", key, clientId); // Ëé∑ÂèñÈîÅÊàêÂäü, ÊâßË°åËøõÁ®ã Object result; try &#123; result = pjp.proceed(); &#125; finally &#123; // Ëß£ÈîÅ redisLock.releaseLock(key, clientId); LOGGER.info("releaseLock success, key = [&#123;&#125;], clientId = [&#123;&#125;]", key, clientId); &#125; return result; &#125; else &#123; // Ëé∑ÂèñÈîÅÂ§±Ë¥•ÔºåËÆ§‰∏∫ÊòØÈáçÂ§çÊèê‰∫§ÁöÑËØ∑Ê±Ç LOGGER.info("tryLock fail, key = [&#123;&#125;]", key); return new ResultBean(ResultBean.FAIL, "ÈáçÂ§çËØ∑Ê±ÇÔºåËØ∑Á®çÂêéÂÜçËØï", null); &#125; &#125; private String getKey(String token, String path) &#123; return token + path; &#125; private String getClientId() &#123; return UUID.randomUUID().toString(); &#125;&#125; Â§öÁ∫øÁ®ãÊµãËØïÊµãËØï‰ª£Á†ÅÂ¶Ç‰∏ãÔºåÊ®°ÊãüÂçÅ‰∏™ËØ∑Ê±ÇÂπ∂ÂèëÂêåÊó∂Êèê‰∫§1234567891011121314151617181920212223242526272829303132333435363738394041424344@Componentpublic class RunTest implements ApplicationRunner &#123; private static final Logger LOGGER = LoggerFactory.getLogger(RunTest.class); @Autowired private RestTemplate restTemplate; @Override public void run(ApplicationArguments args) throws Exception &#123; System.out.println("ÊâßË°åÂ§öÁ∫øÁ®ãÊµãËØï"); String url="http://localhost:8000/submit"; CountDownLatch countDownLatch = new CountDownLatch(1); ExecutorService executorService = Executors.newFixedThreadPool(10); for(int i=0; i&lt;10; i++)&#123; String userId = "userId" + i; HttpEntity request = buildRequest(userId); executorService.submit(() -&gt; &#123; try &#123; countDownLatch.await(); System.out.println("Thread:"+Thread.currentThread().getName()+", time:"+System.currentTimeMillis()); ResponseEntity&lt;String&gt; response = restTemplate.postForEntity(url, request, String.class); System.out.println("Thread:"+Thread.currentThread().getName() + "," + response.getBody()); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;); &#125; countDownLatch.countDown(); &#125; private HttpEntity buildRequest(String userId) &#123; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); headers.set("Authorization", "yourToken"); Map&lt;String, Object&gt; body = new HashMap&lt;&gt;(); body.put("userId", userId); return new HttpEntity&lt;&gt;(body, headers); &#125;&#125; ÊàêÂäüÈò≤Ê≠¢ÈáçÂ§çÊèê‰∫§ÔºåÊéßÂà∂Âè∞Êó•ÂøóÂ¶Ç‰∏ãÔºåÂèØ‰ª•ÁúãÂà∞ÂçÅ‰∏™Á∫øÁ®ãÁöÑÂêØÂä®Êó∂Èó¥Âá†‰πéÂêåÊó∂ÂèëËµ∑ÔºåÂè™Êúâ‰∏Ä‰∏™ËØ∑Ê±ÇÊèê‰∫§ÊàêÂäü‰∫Ü Êú¨ËäÇdemoÊà≥ËøôÈáå ==&gt; GiteebuildÈ°πÁõÆ‰πãÂêéÔºåÂêØÂä®Êú¨Âú∞redisÔºåËøêË°åÈ°πÁõÆËá™Âä®ÊâßË°åÊµãËØïÊñπÊ≥ï ÂèÇËÄÉhttps://www.jianshu.com/p/09c6b05b670a]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>SpringBoot</tag>
        <tag>AOP</tag>
        <tag>ÂàÜÂ∏ÉÂºèÈîÅ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-Âπ∂ÂèëÊéßÂà∂----ËØªÈîÅ„ÄÅÂÜôÈîÅ„ÄÅ‰πêËßÇÈîÅ]]></title>
    <url>%2Fpost%2Fe708def4.html</url>
    <content type="text"><![CDATA[Âπ∂ÂèëÊòØ‰∏Ä‰∏™ËÆ©‰∫∫ÂæàÂ§¥ÁñºÁöÑÈóÆÈ¢òÔºåÈÄöÂ∏∏Êàë‰ª¨‰ºöÂú®ÊúçÂä°Á´ØÊàñËÄÖÊï∞ÊçÆÂ∫ìÁ´ØÂÅöÂ§ÑÁêÜÔºå‰øùËØÅÂú®Âπ∂Âèë‰∏ãÊï∞ÊçÆÁöÑÂáÜÁ°ÆÊÄßÔºå‰ªäÂ§©Êàë‰ª¨ÁÆÄË¶ÅÁöÑËÆ®ËÆ∫‰∏Ä‰∏ãMySQL‰∏≠Â¶Ç‰ΩïÈÄöËøáÈîÅËß£ÂÜ≥Âπ∂ÂèëÈóÆÈ¢ò ËØªÈîÅ ‰πüÂè´ÂÖ±‰∫´ÈîÅ Ôºàshared lockÔºâ Â¶Ç‰Ωï‰ΩøÁî®SELECT * FROM table_name WHERE ... LOCK IN SHARE MODE ËØ¶Ëß£Âç≥‰∫ãÂä°A ‰ΩøÁî®ÂÖ±‰∫´ÈîÅ Ëé∑Âèñ‰∫ÜÊüêÊù°ÔºàÊàñËÄÖÊüê‰∫õÔºâËÆ∞ÂΩïÊó∂Ôºå‰∫ãÂä°B ÂèØ‰ª•ËØªÂèñËøô‰∫õËÆ∞ÂΩïÔºåÂèØ‰ª•ÁªßÁª≠Ê∑ªÂä†ÂÖ±‰∫´ÈîÅÔºå‰ΩÜÊòØ‰∏çËÉΩ‰øÆÊîπÊàñÂà†Èô§Ëøô‰∫õËÆ∞ÂΩïÔºàÂΩì‰∫ãÂä°B ÂØπËøô‰∫õÊï∞ÊçÆ‰øÆÊîπÊàñÂà†Èô§Êó∂‰ºöËøõÂÖ•ÈòªÂ°ûÁä∂ÊÄÅÔºåÁõ¥Ëá≥ÈîÅÁ≠âÂæÖË∂ÖÊó∂ÊàñËÄÖ‰∫ãÂä°AÊèê‰∫§Ôºâ ‰ΩøÁî®Âú∫ÊôØËØªÂèñÁªìÊûúÈõÜÁöÑÊúÄÊñ∞ÁâàÊú¨ÔºåÂêåÊó∂Èò≤Ê≠¢ÂÖ∂‰ªñ‰∫ãÂä°‰∫ßÁîüÊõ¥Êñ∞ËØ•ÁªìÊûúÈõÜ‰∏ªË¶ÅÁî®Âú®ÈúÄË¶ÅÊï∞ÊçÆ‰æùÂ≠òÂÖ≥Á≥ªÊó∂Á°ÆËÆ§ÊüêË°åËÆ∞ÂΩïÊòØÂê¶Â≠òÂú®ÔºåÂπ∂Á°Æ‰øùÊ≤°Êúâ‰∫∫ÂØπËøô‰∏™ËÆ∞ÂΩïËøõË°åUPDATEÊàñËÄÖDELETEÊìç‰Ωú Ê≥®ÊÑè‰∫ãÈ°πÂΩì‰ΩøÁî®ËØªÈîÅÊó∂ÔºåÈÅøÂÖç‰∫ßÁîüÂ¶Ç‰∏ãÊìç‰Ωú 123456‰∫ãÂä°1BEGIN;select * from sys_user where id = 1 LOCK IN SHARE MODE; (Ê≠•È™§1)update sys_user set username = &quot;taven&quot; where id = 1; (Ê≠•È™§3ÔºåÂèëÁîüÈòªÂ°û)COMMIT; 123456‰∫ãÂä°2BEGIN;select * from sys_user where id = 1 LOCK IN SHARE MODE; (Ê≠•È™§2)update sys_user set username = &quot;taven&quot; where id = 1; (Ê≠•È™§4ÔºåÊ≠ªÈîÅ)COMMIT; ÂàÜÊûêÊ†πÊçÆÊàë‰ª¨‰πãÂâçÂØπËØªÈîÅÂÆö‰πâÂèØÁü•ÔºåÂΩìÊúâ‰∫ãÂä°ÊãøÂà∞‰∏Ä‰∏™ÁªìÊûúÈõÜÁöÑËØªÈîÅÊó∂ÔºåÂÖ∂‰ªñ‰∫ãÂä°ÊÉ≥Ë¶ÅÊõ¥Êñ∞ËØ•ÁªìÊûúÈõÜÔºåÈúÄË¶ÅÊãøÂà∞ËØªÈîÅÁöÑ‰∫ãÂä°Êèê‰∫§ÔºàÈáäÊîæÈîÅÔºâ„ÄÇËÄå‰∏äËø∞ÊÉÖÂÜµ‰∏§‰∏™‰∫ãÂä°ÂàÜÂà´ÊãøÂà∞‰∫ÜËØªÈîÅÔºåËÄå‰∏îÈÉΩÊúâupdate Êìç‰ΩúÔºå‰∏§‰∏™‰∫ãÂä°‰∫íÁõ∏Á≠âÂæÖÈÄ†ÊàêÊ≠ªÈîÅÔºàÈÉΩÂú®Á≠âÂæÖÂØπÊñπÈáäÊîæËØªÈîÅÔºâ ÂÜôÈîÅ ‰πüÂè´ÊéíÂÆÉÈîÅÔºàexclusive lockÔºâ Â¶Ç‰Ωï‰ΩøÁî®SELECT * FROM table_name WHERE ... FOR UPDATE ËØ¶Ëß£‰∏Ä‰∏™ÂÜôÈîÅ‰ºöÈòªÂ°ûÂÖ∂‰ªñÁöÑËØªÈîÅÂíåÂÜôÈîÅÂç≥‰∫ãÂä°A ÂØπÊüê‰∫õËÆ∞ÂΩïÊ∑ªÂä†ÂÜôÈîÅÊó∂Ôºå‰∫ãÂä°B Êó†Ê≥ïÂêëËøô‰∫õËÆ∞ÂΩïÊ∑ªÂä†ÂÜôÈîÅÊàñËÄÖËØªÈîÅÔºà‰∏çÊ∑ªÂä†ÈîÅÁöÑËØªÂèñÊòØÂèØ‰ª•ÁöÑÔºâÔºå‰∫ãÂä°B ‰πüÊó†Ê≥ïÊâßË°åÂØπ ÈîÅ‰ΩèÁöÑÊï∞ÊçÆ update delete ‰ΩøÁî®Âú∫ÊôØËØªÂèñÁªìÊûúÈõÜÁöÑÊúÄÊñ∞ÁâàÊú¨ÔºåÂêåÊó∂Èò≤Ê≠¢ÂÖ∂‰ªñ‰∫ãÂä°‰∫ßÁîüËØªÂèñÊàñËÄÖÊõ¥Êñ∞ËØ•ÁªìÊûúÈõÜ„ÄÇ‰æãÂ¶ÇÔºöÂπ∂Âèë‰∏ãÂØπÂïÜÂìÅÂ∫ìÂ≠òÁöÑÊìç‰Ωú Ê≥®ÊÑè‰∫ãÈ°πÂú®‰ΩøÁî®ËØªÈîÅ„ÄÅÂÜôÈîÅÊó∂ÈÉΩÈúÄË¶ÅÊ≥®ÊÑèÔºåËØªÈîÅ„ÄÅÂÜôÈîÅÂ±û‰∫éË°åÁ∫ßÈîÅ„ÄÇÂç≥‰∫ãÂä°1 ÂØπÂïÜÂìÅA Ëé∑ÂèñÂÜôÈîÅÔºåÂíå‰∫ãÂä°2 ÂØπÂïÜÂìÅB Ëé∑ÂèñÂÜôÈîÅ‰∫íÁõ∏‰∏ç‰ºöÈòªÂ°ûÁöÑ„ÄÇÈúÄË¶ÅÊàë‰ª¨Ê≥®ÊÑèÁöÑÊòØÊàë‰ª¨ÁöÑSQLË¶ÅÂêàÁêÜ‰ΩøÁî®Á¥¢ÂºïÔºåÂΩìÊàë‰ª¨ÁöÑSQL ÂÖ®Ë°®Êâ´ÊèèÁöÑÊó∂ÂÄôÔºåË°åÁ∫ßÈîÅ‰ºöÂèòÊàêË°®ÈîÅ„ÄÇ‰ΩøÁî®EXPLAINÊü•Áúã SQLÊòØÂê¶‰ΩøÁî®‰∫ÜÁ¥¢ÂºïÔºåÊâ´Êèè‰∫ÜÂ§öÂ∞ëË°å ‰πêËßÇÈîÅ ‰∏äËø∞‰ªãÁªçÁöÑÊòØË°åÁ∫ßÈîÅÔºåÂèØ‰ª•ÊúÄÂ§ßÁ®ãÂ∫¶Âú∞ÊîØÊåÅÂπ∂ÂèëÂ§ÑÁêÜÔºàÂêåÊó∂‰πüÂ∏¶Êù•‰∫ÜÊúÄÂ§ßÁöÑÈîÅÂºÄÈîÄÔºâ‰πêËßÇÈîÅÊòØ‰∏ÄÁßçÈÄªËæëÈîÅÔºåÈÄöËøáÊï∞ÊçÆÁöÑÁâàÊú¨Âè∑ÔºàvesionÔºâÁöÑÊú∫Âà∂Êù•ÂÆûÁé∞ÔºåÊûÅÂ§ßÈôç‰Ωé‰∫ÜÊï∞ÊçÆÂ∫ìÁöÑÊÄßËÉΩÂºÄÈîÄ„ÄÇ Êàë‰ª¨‰∏∫Ë°®Ê∑ªÂä†‰∏Ä‰∏™Â≠óÊÆµ versionÔºåËØªÂèñÊï∞ÊçÆÊó∂Â∞ÜÊ≠§ÁâàÊú¨Âè∑‰∏ÄÂêåËØªÂá∫Ôºå‰πãÂêéÊõ¥Êñ∞Êó∂ÔºåÂØπÊ≠§ÁâàÊú¨Âè∑+1ÔºåÂêåÊó∂Â∞ÜÊèê‰∫§Êï∞ÊçÆÁöÑversion ‰∏éÊï∞ÊçÆÂ∫ì‰∏≠ÂØπÂ∫îËÆ∞ÂΩïÁöÑÂΩìÂâçversion ËøõË°åÊØîÂØπÔºåÂ¶ÇÊûúÊèê‰∫§ÁöÑÊï∞ÊçÆÁâàÊú¨Âè∑Â§ß‰∫éÊï∞ÊçÆÂ∫ìË°®ÂΩìÂâçÁâàÊú¨Âè∑ÔºåÂàô‰∫à‰ª•Êõ¥Êñ∞ÔºåÂê¶ÂàôËÆ§‰∏∫ÊòØËøáÊúüÊï∞ÊçÆ 123update t_goods set status=2,version=version+1where id=#&#123;id&#125; and version &lt; #&#123;version&#125;; // Êõ¥Êñ∞ÂâçÂ∞ÜversionËá™Â¢û ÊàñËÄÖ123update t_goods set status=2,version=version+1where id=#&#123;id&#125; and version = #&#123;version&#125;; // Êõ¥Êñ∞Ââçversion ‰∏çËá™Â¢û]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>Âπ∂Âèë</tag>
        <tag>ÈîÅ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-ÁêÜËß£‰∫ãÂä°ÈöîÁ¶ªÁ∫ßÂà´]]></title>
    <url>%2Fpost%2Feca98c0.html</url>
    <content type="text"><![CDATA[Âú®SQLÊ†áÂáÜ‰∏≠ÂÆö‰πâ‰∫ÜÂõõÁßçÈöîÁ¶ªÁ∫ßÂà´ÔºåÊØè‰∏ÄÁßçÁ∫ßÂà´ÈÉΩËßÑÂÆö‰∫Ü‰∏Ä‰∏™‰∫ãÂä°‰∏≠ÊâÄÂÅöÁöÑ‰øÆÊîπÔºåÂì™‰∫õÂú®‰∫ãÂä°ÂÜÖÂíå‰∫ãÂä°Èó¥ÊòØÂèØËßÅÁöÑÔºåÂì™‰∫õÊòØ‰∏çÂèØËßÅÔºåËæÉ‰ΩéÁöÑÈöîÁ¶ªÁ∫ßÂà´ÈÄöÂ∏∏ÂèØ‰ª•ÊâßË°åÊõ¥È´òÁöÑÂπ∂ÂèëÔºåÁ≥ªÁªüÁöÑÂºÄÈîÄ‰πüÊõ¥‰Ωé ‰∫ãÂä°ÁöÑACID ÂéüÂ≠êÊÄßÔºàatomicityÔºâ‰∏Ä‰∏™‰∫ãÂä°ÂøÖÈ°ªËßÜ‰∏∫‰∏Ä‰∏™‰∏çÂèØÂàÜÂâ≤ÁöÑÊúÄÂ∞èÂ∑•‰ΩúÂçïÂÖÉÔºåÊï¥‰∏™‰∫ãÂä°ÁöÑÊâÄÊúâÊìç‰ΩúË¶Å‰πàÂÖ®ÈÉ®Êèê‰∫§ÊàêÂäüÔºåË¶Å‰πàÂÖ®ÈÉ®ÂõûÊªö ‰∏ÄËá¥ÊÄßÔºàconsistencyÔºâÊï∞ÊçÆÂ∫ìÊÄªÊòØ‰ªé‰∏Ä‰∏™‰∏ÄËá¥ÊÄßÁä∂ÊÄÅËΩ¨Êç¢Âà∞Âè¶‰∏Ä‰∏™‰∏ÄËá¥ÊÄßÁä∂ÊÄÅ„ÄÇ ÈöîÁ¶ªÊÄßÔºàisolationÔºâÈÄöÂ∏∏Êù•ËØ¥Ôºå‰∏Ä‰∏™‰∫ãÂä°ÊâÄ‰ΩúÁöÑ‰øÆÊîπÂú®ÊúÄÁªàÊèê‰∫§‰ª•ÂâçÔºåÂØπÂÖ∂‰ªñ‰∫ãÂä°ÊòØ‰∏çÂèØËßÅÁöÑÔºåÂú®ËÆ®ËÆ∫ÈöîÁ¶ªÁ∫ßÂà´ÁöÑÊó∂ÂÄôÔºå‰ºöÁêÜËß£‰∏∫‰ªÄ‰πàËØ¥ÊòØ ‚ÄúÈÄöÂ∏∏Êù•ËØ¥‚Äù ÊòØ‰∏çÂèØËßÅÁöÑ ÊåÅ‰πÖÊÄßÔºàdurabilityÔºâ‰∏ÄÊó¶‰∫ãÂä°Êèê‰∫§ÔºåÂàôÊâÄÂÅöÁöÑ‰øÆÊîπÂ∞±‰ºöÊ∞∏‰πÖÁöÑ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì‰∏≠ ÈöîÁ¶ªÁ∫ßÂà´1.READ UNCOMMITTED ÔºàÊú™Êèê‰∫§ËØªÔºâ Âç≥Âú®ËØ•Á∫ßÂà´Ôºå‰∫ãÂä°‰∏≠ÁöÑÂØπÊï∞ÊçÆÁöÑ‰øÆÊîπÔºåÂç≥‰ΩøÊ≤°ÊúâÊèê‰∫§ÔºåÂØπÂÖ∂‰ªñ‰∫ãÂä°‰πüÊòØÂèØËßÅÁöÑ„ÄÇËøôÁßçÊÉÖÂÜµË¢´Áß∞‰∏∫ËÑèËØªÔºàDirty ReadÔºâÔºåËøô‰∏™Á∫ßÂà´‰ºöÂØºËá¥ÂæàÂ§öÈóÆÈ¢òÔºåËÄå‰∏îÊÄßËÉΩÁõ∏ÊØîÂÖ∂‰ªñÁ∫ßÂà´‰∏ç‰ºöÂ•ΩÂ§™Â§öÔºåÂÆûÈôÖÂæàÂ∞ë‰ΩøÁî®„ÄÇ 2.READ COMMITTED ÔºàÊèê‰∫§ËØªÔºâ Â§ßÂ§öÊï∞ÊçÆÂ∫ìÁöÑÈªòËÆ§ÈöîÁ¶ªÁ∫ßÂà´Ôºà‰ΩÜMySQL‰∏çÊòØÔºâÔºåËØ•Á∫ßÂà´Ëß£ÂÜ≥‰∫ÜËÑèËØªÁöÑÈóÆÈ¢ò„ÄÇ‰ΩÜÊòØ‰∫ãÂä°‰∏≠‰ºöËØªÂà∞ÂÖ∂‰ªñ‰∫ãÂä°Â∑≤Êèê‰∫§ÁöÑÊï∞ÊçÆÔºåÊó†Ê≥ï‰øùËØÅËØª‰∏ÄËá¥ÊÄßÔºå‰ºöÈÄ†Êàê‰∏çÂèØÈáçÂ§çËØªÁöÑÈóÆÈ¢ò„ÄÇÂ¶Ç‰∏ã‰∫ãÂä°ÁöÑ‰∏§Ê¨°ËØªÂèñÊòØ‰∏ç‰∏ÄËá¥ÁöÑ 3.REPEATABLE READ ÔºàÂèØÈáçÂ§çËØªÔºâ ËØ•ÈöîÁ¶ªÁ∫ßÂà´ÔºåËß£ÂÜ≥‰∫ÜËÑèËØªÔºå‰∏çÂèØÈáçÂ§çËØª„ÄÇInnoDB ‰ΩøÁî® MVCCÔºàÂ§öÁâàÊú¨Âπ∂ÂèëÊéßÂà∂‰∏ãÊñá‰ºöËÆ≤Âà∞Ôºâ ‰øùËØÅ‰∫Ü‰∫ãÂä°‰∏≠ÁöÑËØª‰∏ÄËá¥ÊÄß„ÄÇ‰ΩÜËøòÊòØ‰ºöÂá∫Áé∞‰∏Ä‰∏™ÂπªËØªÁöÑÊÉÖÂÜµ Â¶Ç‰∏ãÂõæÔºàÂ∑¶‰∏∫‰∫ãÂä°AÔºåÂè≥‰∏∫‰∫ãÂä°BÔºâ‰∫ãÂä°ÊâßË°åËøôÊ†∑ÁöÑÈÄªËæëÔºöÊü•ÊâæÊòØÂê¶ÊúâÊüêÊù°ËÆ∞ÂΩïÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôÊñ∞Â¢û„ÄÇ ‰∫ãÂä°A Êü•ËØ¢ÊòØÂê¶Â≠òÂú® id=&quot;1&quot;ËøôÊù°Êï∞ÊçÆÔºåÂèëÁé∞‰∏çÂ≠òÂú®ÔºåÂáÜÂ§áÊâßË°åinsert Ê≠§Êó∂‰∫ãÂä°B insert‰∫ÜËøôÊù°Êï∞ÊçÆÔºåÂπ∂Êèê‰∫§‰∫Ü‰∫ãÂä°„ÄÇ ‰∫ãÂä°A ÊâßË°åinsert ÂèëÁîü‰∏ªÈîÆÂÜ≤Á™ÅÔºåÂÜçÊ¨°ÊâßË°å‰∫Ü select * from where id = &quot;1&quot;ÔºåÂèëÁé∞‰æùÊóß‰∏çÂ≠òÂú®ÂΩìÂâçÁªìÊûúÈõÜ RR Á∫ßÂà´‰∏ãÂ¶Ç‰ΩïÈò≤Ê≠¢ÂπªËØª12# Áî® XÈîÅSELECT i` FROM `users` WHERE `id` = &quot;1&quot; FOR UPDATE; Â¶ÇÊûú id = 1 ÁöÑËÆ∞ÂΩïÂ≠òÂú®Âàô‰ºöË¢´Âä†Ë°åÔºàXÔºâÈîÅÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÔºåÂàô‰ºöÂä† next-lock key / gap ÈîÅÔºàËåÉÂõ¥Ë°åÈîÅÔºâÔºåÂç≥ËÆ∞ÂΩïÂ≠òÂú®‰∏éÂê¶Ôºåmysql ÈÉΩ‰ºöÂØπËÆ∞ÂΩïÂ∫îËØ•ÂØπÂ∫îÁöÑÁ¥¢ÂºïÂä†ÈîÅÔºåÂÖ∂‰ªñ‰∫ãÂä°ÊòØÊó†Ê≥ïÂÜçËé∑ÂæóÂÅöÊìç‰ΩúÁöÑ„ÄÇ 4.SERIALIZABLE Ôºà‰∏≤Ë°åÂåñÔºâÂú®ËØ•ÈöîÁ¶ªÁ∫ßÂà´‰∏ãÔºåËØªÂèñÁöÑÊØè‰∏ÄË°åÈÉΩ‰ºöË¢´Ê∑ªÂä†ÈîÅÔºà‰∏™‰∫∫ÁêÜËß£ÊòØËØªÈîÅÂíågapÈîÅÔºâÔºåÂØºËá¥Â§ßÈáèÁöÑË∂ÖÊó∂ÂíåÈîÅ‰∫âÁî®ÈóÆÈ¢òÔºåÂÆûÈôÖÂ∫îÁî®‰∏≠ÂæàÂ∞ë‰ΩøÁî®ÔºåÂè™ÊúâÂú®ÈùûÂ∏∏ÈúÄË¶ÅÁ°Æ‰øùÊï∞ÊçÆ‰∏ÄËá¥ÊÄß‰∏îÂèØ‰ª•Êé•ÂèóÊ≤°ÊúâÂπ∂ÂèëÁöÑÊÉÖÂÜµ‰∏ãÔºåÊâçËÄÉËôëËØ•Á∫ßÂà´„ÄÇ Âú® SERIALIZABLE Á∫ßÂà´‰∏ãÂÜçËøêË°å‰∏Ä‰∏ã ‰∏äËø∞ÁöÑdemo ÂèØ‰ª•ÁúãÂà∞Ê≠•È™§2ÁöÑ insert Ë¢´ÈòªÂ°û‰∫ÜÔºå‰∏äËø∞‚ÄúÂπªËØª‚ÄùÁöÑÊÉÖÂÜµ MVCCMVCC ÊòØ‰ªÄ‰πà MVVC (Multi-Version Concurrency Control, Â§öÁâàÊú¨Âπ∂ÂèëÊéßÂà∂)ÔºåÂú®InnoDBÂºïÊìé‰∏ãÔºåMVCCÊòØ‰∏∫‰∫ÜÂÆûÁé∞‰∫ãÂä°ÁöÑÈöîÁ¶ªÊÄßÔºåÈÄöËøáÁâàÊú¨Âè∑ÔºåÈÅøÂÖçÂêå‰∏ÄÊï∞ÊçÆÂú®‰∏çÂêå‰∫ãÂä°Èó¥ÁöÑÁ´û‰∫âÔºå‰Ω†ÂèØ‰ª•ÊääÂÆÉÂΩìÊàêÂü∫‰∫éÂ§öÁâàÊú¨Âè∑ÁöÑ‰∏ÄÁßç‰πêËßÇÈîÅÔºåËØª‰∏çÂä†ÈîÅÔºåËØªÂÜô‰∏çÂÜ≤Á™ÅMVCC ÂÆûÁé∞Êú∫Âà∂ InnoDBÂú®ÊØèË°åÊï∞ÊçÆÈÉΩÂ¢ûÂä†‰∏§‰∏™ÈöêËóèÂ≠óÊÆµÔºå‰∏Ä‰∏™ËÆ∞ÂΩïÂàõÂª∫ÁöÑÁâàÊú¨Âè∑Ôºå‰∏Ä‰∏™ËÆ∞ÂΩïÂà†Èô§ÁöÑÁâàÊú¨Âè∑„ÄÇ Âú®MVVC ‰∏≠Ôºå‰∏∫‰∫Ü‰øùËØÅÊï∞ÊçÆÊìç‰ΩúÂú®Â§öÁ∫øÁ®ãËøáÁ®ã‰∏≠Ôºå‰øùËØÅ‰∫ãÂä°ÈöîÁ¶ªÁöÑÊú∫Âà∂ÔºåÈôç‰ΩéÈîÅÁ´û‰∫âÁöÑÂéãÂäõÔºå‰øùËØÅËæÉÈ´òÁöÑÂπ∂ÂèëÈáè„ÄÇÂú®ÊØèÂºÄÂêØ‰∏Ä‰∏™‰∫ãÂä°Êó∂Ôºå‰ºöÁîüÊàê‰∏Ä‰∏™‰∫ãÂä°ÁöÑÁâàÊú¨Âè∑ÔºåË¢´Êìç‰ΩúÁöÑÊï∞ÊçÆ‰ºöÁîüÊàê‰∏ÄÊù°Êñ∞ÁöÑÊï∞ÊçÆË°åÔºà‰∏¥Êó∂ÔºâÔºå‰ΩÜÊòØÂú®Êèê‰∫§ÂâçÂØπÂÖ∂‰ªñ‰∫ãÂä°ÊòØ‰∏çÂèØËßÅÁöÑÔºåÂØπ‰∫éÊï∞ÊçÆÁöÑÊõ¥Êñ∞ÔºàÂåÖÊã¨Â¢ûÂà†ÊîπÔºâÊìç‰ΩúÊàêÂäüÔºå‰ºöÂ∞ÜËøô‰∏™ÁâàÊú¨Âè∑Êõ¥Êñ∞Âà∞Êï∞ÊçÆÁöÑË°å‰∏≠Ôºå‰∫ãÂä°Êèê‰∫§ÊàêÂäüÔºåÂ∞ÜÊñ∞ÁöÑÁâàÊú¨Âè∑Êõ¥Êñ∞Âà∞Ê≠§Êï∞ÊçÆË°å‰∏≠ÔºåËøôÊ†∑‰øùËØÅ‰∫ÜÊØè‰∏™‰∫ãÂä°Êìç‰ΩúÁöÑÊï∞ÊçÆÔºåÈÉΩÊòØ‰∫í‰∏çÂΩ±ÂìçÁöÑÔºå‰πü‰∏çÂ≠òÂú®ÈîÅÁöÑÈóÆÈ¢ò„ÄÇ MVVC‰∏ãÁöÑCRUD ÔºàREPEATABLE READ‰∏ãÔºâ SELECTÔºö InnoDB Êü•ËØ¢ÁöÑÊØèË°åÊï∞ÊçÆÂøÖÈ°ªÊª°Ë∂≥‰ª•‰∏ã‰∏§ÁÇπ 1„ÄÅInnoDBÂøÖÈ°ªÊâæÂà∞‰∏Ä‰∏™Ë°åÁöÑÁâàÊú¨ÔºåÂÆÉËá≥Â∞ëË¶ÅÂíå‰∫ãÂä°ÁöÑÁâàÊú¨‰∏ÄÊ†∑ËÄÅ(Âç≥ÂÆÉÁöÑÁâàÊú¨Âè∑‰∏çÂ§ß‰∫é‰∫ãÂä°ÁöÑÁâàÊú¨Âè∑)„ÄÇËøô‰øùËØÅ‰∫Ü‰∏çÁÆ°ÊòØ‰∫ãÂä°ÂºÄÂßã‰πãÂâçÔºåÊàñËÄÖ‰∫ãÂä°ÂàõÂª∫Êó∂ÔºåÊàñËÄÖ‰øÆÊîπ‰∫ÜËøôË°åÊï∞ÊçÆÁöÑÊó∂ÂÄôÔºåËøôË°åÊï∞ÊçÆÊòØÂ≠òÂú®ÁöÑ„ÄÇ 2„ÄÅËøôË°åÊï∞ÊçÆÁöÑÂà†Èô§ÁâàÊú¨ÂøÖÈ°ªÊòØÊú™ÂÆö‰πâÁöÑÊàñËÄÖÊØî‰∫ãÂä°ÁâàÊú¨Ë¶ÅÂ§ß„ÄÇËøôÂèØ‰ª•‰øùËØÅÂú®‰∫ãÂä°ÂºÄÂßã‰πãÂâçËøôË°åÊï∞ÊçÆÊ≤°ÊúâË¢´Âà†Èô§„ÄÇÁ¨¶ÂêàËøô‰∏§‰∏™Êù°‰ª∂ÁöÑË°åÂèØËÉΩ‰ºöË¢´ÂΩì‰ΩúÊü•ËØ¢ÁªìÊûúËÄåËøîÂõû„ÄÇ INSERTÔºö InnoDB‰∏∫Ëøô‰∏™Êñ∞Ë°åËÆ∞ÂΩïÂΩìÂâçÁöÑÁ≥ªÁªüÁâàÊú¨Âè∑„ÄÇ DELETEÔºö InnoDBÂ∞ÜÂΩìÂâçÁöÑÁ≥ªÁªüÁâàÊú¨Âè∑ËÆæÁΩÆ‰∏∫Ëøô‰∏ÄË°åÁöÑÂà†Èô§ID„ÄÇ UPDATEÔºö InnoDB‰ºöÂÜô‰∏Ä‰∏™ËøôË°åÊï∞ÊçÆÁöÑÊñ∞Êã∑Ë¥ùÔºåËøô‰∏™Êã∑Ë¥ùÁöÑÁâàÊú¨‰∏∫ÂΩìÂâçÁöÑÁ≥ªÁªüÁâàÊú¨Âè∑„ÄÇÂÆÉÂêåÊó∂‰πü‰ºöÂ∞ÜËøô‰∏™ÁâàÊú¨Âè∑ÂÜôÂà∞ÊóßË°åÁöÑÂà†Èô§ÁâàÊú¨Èáå„ÄÇ ÂèÇËÄÉ MySQL‰πãMVVCÁÆÄ‰ªã mysql ÂπªËØªÁöÑËØ¶Ëß£„ÄÅÂÆû‰æãÂèäËß£ÂÜ≥ÂäûÊ≥ï „ÄäÈ´òÊÄßËÉΩMySQL Á¨¨‰∏âÁâà„Äã]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-10w+Êï∞ÊçÆ-insert-‰ºòÂåñ]]></title>
    <url>%2Fpost%2F5c987bd6.html</url>
    <content type="text"><![CDATA[Áî±‰∫é‰∏öÂä°ÂéüÂõ†ÔºåÈÅáÂà∞‰∫ÜÂ¶ÇÈ¢òÊâÄËø∞ÁöÑ‰∏öÂä°ÈóÆÈ¢òÔºå‰∫ãÂä°ÊâßË°åÊó∂Èó¥Âú®30s~50s ‰∏çÁ≠âÔºåÊïàÊûúÈùûÂ∏∏‰∏çÁêÜÊÉ≥ ÊñπÊ°à1. jdbcÊâπÂ§ÑÁêÜ5w+ Êï∞ÊçÆÊµãËØïÔºåÂàÜÂà´‰ΩøÁî®‰∫Ümybatis insert()()ÔºàÊãºÊé•xmlÔºâ, mybatisÁöÑÊâπÂ§ÑÁêÜÂíå jdbcÁöÑÊâπÂ§ÑÁêÜ„ÄÇÂèØ‰ª•ÁúãÂà∞Âú®jdbcÊâßË°åÊó∂Èó¥ÊñπÈù¢ÊòØÂ∑Æ‰∏çÂ§öÁöÑÔºå‰ΩÜÊòØÂú®ÊñπÊ≥ïÊâßË°åÊó∂Èó¥‰∏äÔºåÊâπÂ§ÑÁêÜË¶ÅÁ®çÂæÆÂø´‰∫Ü‰∏Ä‰∫õÔºå‰ΩÜÊòØËøòÊòØ‰∏çÁêÜÊÉ≥ ÊñπÊ°à2. ‰ºòÂåñMySQL ÂèÇÊï∞‰øÆÊîπ my.ini innodb_buffer_pool_size : InnoDB, unlike MyISAM, uses a buffer pool to cache both indexes androw data. The bigger you set this the less disk I/O is needed toaccess data in tables. On a dedicated database server you may set thisparameter up to 80% of the machine physical memory size. Do not set ittoo large, though, because competition of the physical memory maycause paging in the operating system. Note that on 32bit systems youmight be limited to 2-3.5G of user level memory per process, so do notset it too high. InnodbÁöÑÁºìÂÜ≤Ê±†‰ºöÁºìÂ≠òÊï∞ÊçÆÂíåÁ¥¢ÂºïÔºåËÆæÁΩÆÁöÑË∂äÂ§ßËÆøÈóÆË°®‰∏≠ÁöÑÊï∞ÊçÆÊâÄÈúÄÁöÑÁ£ÅÁõòI/OÂ∞±Ë∂äÂ∞ë„ÄÇ ‰øÆÊîπinnodb_buffer_pool_size = 512MÊµãËØï‰∏Ä‰∏ãÊïàÁéáÔºåËøôÈÄüÂ∫¶ÁÆÄÁõ¥ÊÑü‰∫∫ÔºÅ innodb_log_buffer_size : The size of the buffer InnoDB uses for buffering log data. As soon asit is full, InnoDB will have to flush it to disk. As it is flushed once per second anyway, it does not make sense to have it very large(even with long transactions). Ë°®Á§∫InnoDBÂÜôÂÖ•Âà∞Á£ÅÁõò‰∏äÁöÑÊó•ÂøóÊñá‰ª∂Êó∂‰ΩøÁî®ÁöÑÁºìÂÜ≤Âå∫ÁöÑÂ≠óËäÇÊï∞ÔºåÈªòËÆ§ÂÄº‰∏∫8M„ÄÇÂΩìÁºìÂÜ≤Âå∫ÂÖÖÊª°Êó∂ÔºåInnoDBÂ∞ÜÂà∑Êñ∞Êï∞ÊçÆÂà∞Á£ÅÁõò„ÄÇÁî±‰∫éÂÆÉÊØèÁßíÂà∑Êñ∞‰∏ÄÊ¨°ÔºåÊâÄ‰ª•Â∞ÜÂÆÉËÆæÁΩÆÂæóÈùûÂ∏∏Â§ßÊòØÊ≤°ÊúâÊÑè‰πâÁöÑ (Âç≥‰ΩøÊòØÈïø‰∫ãÂä°)„ÄÇ innodb_log_file_size : Size of each log file in a log group. You should set the combined sizeof log files to about 25%-100% of your buffer pool size to avoidunneeded buffer pool flush activity on log file overwrite. However,note that a larger logfile size will increase the time needed for therecovery process. ËØ•ÂÄºË∂äÂ§ßÔºåÁºìÂÜ≤Ê±†‰∏≠ÂøÖË¶ÅÁöÑÊ£ÄÊü•ÁÇπÂà∑Êñ∞Ê¥ªÂä®Â∞±‰ºöË∂äÂ∞ëÔºåËäÇÁúÅÁ£ÅÁõòI/ O„ÄÇ‰ΩÜÊòØË∂äÂ§ßÁöÑÊó•ÂøóÊñá‰ª∂ÔºåmysqlÁöÑÂ¥©Ê∫ÉÊÅ¢Â§çÂ∞±Ë∂äÊÖ¢ ËÆæÁΩÆ‰∏äËø∞‰∏§‰∏™ÂèÇÊï∞innodb_log_file_size=64M innodb_log_buffer_size=16MÔºåÊïàÁéáÊèêÂçáÁöÑÂπ∂‰∏çÊòéÊòæ„ÄÇ ÊÄªÁªì Êï∞ÊçÆÈáèÂ§ßÊó∂ÔºåÊâπÂ§ÑÁêÜÂú®ÊñπÊ≥ïÊâßË°åÊó∂Èó¥‰∏äË¶ÅÊØî mybatis xmlÊãºÊé•Âø´‰∏ÄÁÇπ ÔºàÊâπÂ§ÑÁêÜÂè™ÁºñËØë‰∏ÄÊù°SQLÔºåËÄåÊãºÊé•ÁöÑÊñπÂºèSQL‰ºöÂæàÈïøÔºâ ÊÄßËÉΩÁì∂È¢à‰ºòÂåñËøòÊòØË¶Å‰ªéÊï∞ÊçÆÂ∫ì‰∏ãÊâãÔºåÁõÆÂâçÊù•ÁúãMySQL Â§ßÊï∞ÊçÆÈáèÊó∂Âæà‰æùËµñ innodb_buffer_pool_size ÔºàÁºìÂÜ≤Ê±†ÔºâÂèÇËÄÉ https://my.oschina.net/realfighter/blog/368225]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>‰ºòÂåñ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JavaÊâìÂåÖÊàêexe Âú®Ê≤°ÊúâJREÁéØÂ¢ÉÁöÑÁîµËÑë‰∏äËøêË°å]]></title>
    <url>%2Fpost%2F33eaa3e0.html</url>
    <content type="text"><![CDATA[ÂÖ¨Âè∏‰∏öÂä°ÈúÄÊ±ÇÂéüÂõ†ÔºåÈúÄË¶ÅÁªôÁî®Êà∑Êèê‰æõ‰∏Ä‰∏™Ê°åÈù¢Â∫îÁî®Á®ãÂ∫è„ÄÇÁî±‰∫éÊó∂Èó¥ÂÖ≥Á≥ªÔºåÊ≤°ÊúâËÄÉËôë.netÔºå‰ΩøÁî®‰∫ÜÊ±üÊπñ‰∏äÂ§±‰º†Â∑≤‰πÖÁöÑJava Swing ÂáÜÂ§áÂ∑•‰Ωú Â∞Ü‰Ω†ÁöÑJavaÈ°πÁõÆÊâìÂåÖ‰∏∫ ÂèØÊâßË°åJar ‰ΩøÁî® exe4j ÁîüÊàê.exe Êñ∞Âª∫‰∏Ä‰∏™Êñá‰ª∂Â§πÔºåÂ∞Ü‰Ω†ÁöÑ JREÔºà‰∏éJDKÂêåÁ∫ßÂà´ÁöÑÈÇ£‰∏™JREÔºâÔºåÂèØÊâßË°åjar ÈÉΩÂ§çÂà∂ËøáÊù•Ôºå‰∏ãÂõæÈô§Á∫¢Âúà‰ª•Â§ñÁöÑJar ‰∏∫È°πÁõÆÁöÑ‰æùËµñJar ÂåÖ ÊâìÂºÄ exe4j ÔºåNext ÈÄâÊã© JAR IN EXE ÈÄâÊã©ÂàöÂàöÊàë‰ª¨Êñ∞Âª∫ÁöÑÊñá‰ª∂Â§π ÔºàÂåÖÂê´JREÔºåÂíåÈ°πÁõÆÂèØÊâßË°åJARÔºâ ËøôÈáåÊòØËÆæÁΩÆÊñá‰ª∂ÂêçÔºåÂõæÊ†áÔºåÊòØÂê¶‰ªÖÂÖÅËÆ∏‰∏Ä‰∏™Â∫îÁî®ÂÆû‰æãÁ≠âÁ≠âÔºåÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºå64‰ΩçÁöÑ jdkÊòØÈúÄË¶ÅËÆæÁΩÆ‰∏Ä‰∏ãÁöÑÔºåÂ¶ÇÂõæ ËøôÈáåÊòØÂ∞ÜÈ°πÁõÆÁöÑÔºåÂèØÊâßË°åJARÔºåËøòÊúâ‰æùËµñJAR ÂÖ®ÈÉ®Ê∑ªÂä†ËøõÊù•ÔºåÊ≥®ÊÑè‰∏ÄÂÆöË¶Å‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑÔºåMain class from ÈÄâÊã©‰∏Ä‰∏™È°πÁõÆÁöÑÂêØÂä®Á±ª„ÄÇ ËÆæÁΩÆ Search sequence Ê∏ÖÈô§ÈªòËÆ§ÈÖçÁΩÆÔºåËÆæÁΩÆJREÔºå‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑ ÂêéÂá†Ê≠•ÈªòËÆ§ÈÖçÁΩÆÔºå‰∏ã‰∏ÄÊ≠•Âç≥ÂèØ„ÄÇ Â§áÊ≥® ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåJARÂíåJRE ‰∏ÄÂÆöË¶Å‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑÔºàÁªùÂØπË∑ØÂæÑÊó†Ê≥ï‰øùËØÅ‰Ω†ÁöÑË∑ØÂæÑÂíåÁî®Êà∑ÁîµËÑë‰∏ÄËá¥Ôºâ exe4jÔºåÊ≤°ÊúâÊøÄÊ¥ª‰πãÂâçÁîüÊàêÁöÑexeÔºåÂêØÂä®‰πãÂâç‰ºöË∑≥‰∏™ÂØπËØùÊ°ÜÔºåÊøÄÊ¥ªÂç≥ÂèØ ÁîüÊàêÁöÑexe ‰∏ç‰æùËµñ‰πãÂâçÁöÑJARÔºåÂè™‰æùËµñJRE ÂèÇËÄÉÔºöhttps://www.cnblogs.com/lsy-blogs/p/7668425.html]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>swing</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[‰ΩøÁî®Spring Cache + Redis ‰Ωú‰∏∫ÁºìÂ≠ò]]></title>
    <url>%2Fpost%2Fef257646.html</url>
    <content type="text"><![CDATA[Êú¨Êñá‰ªãÁªçÂ¶Ç‰Ωï‰ΩøÁî® spring-cacheÔºå‰ª•ÂèäÈõÜÊàê Redis ‰Ωú‰∏∫ÁºìÂ≠òÂÆûÁé∞„ÄÇË°®Ê†ºËøáÈïøÔºåÊé®ËçêËØªËÄÖ‰ΩøÁî®ÁîµËÑëÈòÖËØª ÂáÜÂ§áÂ∑•‰ΩúRedis windows ÂÆâË£Ö Â¶Ç‰ΩïÈÖçÁΩÆmavenÂÆåÊï¥‰æùËµñËØ¶ËßÅ ==&gt; Gitee123456789101112131415161718&lt;!-- ‰ΩøÁî®spring cache --&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;&lt;/dependency&gt;&lt;!-- redis --&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;&lt;/dependency&gt;&lt;!-- ‰∏∫‰∫ÜËß£ÂÜ≥ ClassNotFoundException: org.apache.commons.poolimpl.GenericObjectPoolConfig --&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.commons&lt;/groupId&gt; &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt; &lt;version&gt;0&lt;/version&gt;&lt;/dependency&gt; application.properties1234567891011121314151617181920212223# RedisÊï∞ÊçÆÂ∫ìÁ¥¢ÂºïÔºàÈªòËÆ§‰∏∫0Ôºâspring.redis.database=0 # RedisÊúçÂä°Âô®Âú∞ÂùÄspring.redis.host=localhost# RedisÊúçÂä°Âô®ËøûÊé•Á´ØÂè£spring.redis.port=6379 # RedisÊúçÂä°Âô®ËøûÊé•ÂØÜÁ†ÅÔºàÈªòËÆ§‰∏∫Á©∫Ôºâ#spring.redis.password=yourpwd# ËøûÊé•Ê±†ÊúÄÂ§ßËøûÊé•Êï∞Ôºà‰ΩøÁî®Ë¥üÂÄºË°®Á§∫Ê≤°ÊúâÈôêÂà∂Ôºâspring.redis.lettuce.pool.max-active=8 # ËøûÊé•Ê±†ÊúÄÂ§ßÈòªÂ°ûÁ≠âÂæÖÊó∂Èó¥ spring.redis.lettuce.pool.max-wait=-1ms# ËøûÊé•Ê±†‰∏≠ÁöÑÊúÄÂ§ßÁ©∫Èó≤ËøûÊé•spring.redis.lettuce.pool.max-idle=8 # ËøûÊé•Ê±†‰∏≠ÁöÑÊúÄÂ∞èÁ©∫Èó≤ËøûÊé•spring.redis.lettuce.pool.min-idle=0 # ËøûÊé•Ë∂ÖÊó∂Êó∂Èó¥ÔºàÊØ´ÁßíÔºâspring.redis.timeout=5000ms#ÈÖçÁΩÆÁºìÂ≠òÁõ∏ÂÖ≥cache.default.expire-time=200cache.user.expire-time=180cache.user.name=test @EnableCachingÊ†áËÆ∞Ê≥®Ëß£ @EnableCachingÔºåÂºÄÂêØÁºìÂ≠òÔºåÂπ∂ÈÖçÁΩÆRedisÁºìÂ≠òÁÆ°ÁêÜÂô®ÔºåÈúÄË¶ÅÂàùÂßãÂåñ‰∏Ä‰∏™ÁºìÂ≠òÁ©∫Èó¥„ÄÇÂú®ÁºìÂ≠òÁöÑÊó∂ÂÄôÔºå‰πüÈúÄË¶ÅÊ†áËÆ∞‰ΩøÁî®Âì™‰∏Ä‰∏™ÁºìÂ≠òÁ©∫Èó¥123456789101112131415161718192021222324252627282930313233343536373839404142434445@Configuration@EnableCachingpublic class RedisConfig &#123; @Value("$&#123;cache.default.expire-time&#125;") private int defaultExpireTime; @Value("$&#123;cache.user.expire-time&#125;") private int userCacheExpireTime; @Value("$&#123;cache.user.name&#125;") private String userCacheName; /** * ÁºìÂ≠òÁÆ°ÁêÜÂô® * * @param lettuceConnectionFactory * @return */ @Bean public CacheManager cacheManager(RedisConnectionFactory lettuceConnectionFactory) &#123; RedisCacheConfiguration defaultCacheConfig = RedisCacheConfiguration.defaultCacheConfig(); // ËÆæÁΩÆÁºìÂ≠òÁÆ°ÁêÜÂô®ÁÆ°ÁêÜÁöÑÁºìÂ≠òÁöÑÈªòËÆ§ËøáÊúüÊó∂Èó¥ defaultCacheConfig = defaultCacheConfig.entryTtl(Duration.ofSeconds(defaultExpireTime)) // ËÆæÁΩÆ key‰∏∫stringÂ∫èÂàóÂåñ .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer())) // ËÆæÁΩÆvalue‰∏∫jsonÂ∫èÂàóÂåñ .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer())) // ‰∏çÁºìÂ≠òÁ©∫ÂÄº .disableCachingNullValues(); Set&lt;String&gt; cacheNames = new HashSet&lt;&gt;(); cacheNames.add(userCacheName); // ÂØπÊØè‰∏™ÁºìÂ≠òÁ©∫Èó¥Â∫îÁî®‰∏çÂêåÁöÑÈÖçÁΩÆ Map&lt;String, RedisCacheConfiguration&gt; configMap = new HashMap&lt;&gt;(); configMap.put(userCacheName, defaultCacheConfig.entryTtl(Duration.ofSeconds(userCacheExpireTime))); RedisCacheManager cacheManager = RedisCacheManager.builder(lettuceConnectionFactory) .cacheDefaults(defaultCacheConfig) .initialCacheNames(cacheNames) .withInitialCacheConfigurations(configMap) .build(); return cacheManager; &#125;&#125; Âà∞Ê≠§ÈÖçÁΩÆÂ∑•‰ΩúÂ∑≤ÁªèÁªìÊùü‰∫Ü Spring Cache ‰ΩøÁî®123456789101112131415161718192021222324252627282930313233343536373839404142434445464748@Service@CacheConfig(cacheNames="user")// cacheName ÊòØ‰∏ÄÂÆöË¶ÅÊåáÂÆöÁöÑÂ±ûÊÄßÔºåÂèØ‰ª•ÈÄöËøá @CacheConfig Â£∞ÊòéËØ•Á±ªÁöÑÈÄöÁî®ÈÖçÁΩÆpublic class UserService &#123; /** * Â∞ÜÁªìÊûúÁºìÂ≠òÔºåÂΩìÂèÇÊï∞Áõ∏ÂêåÊó∂Ôºå‰∏ç‰ºöÊâßË°åÊñπÊ≥ïÔºå‰ªéÁºìÂ≠ò‰∏≠Âèñ * * @param id * @return */ @Cacheable(key = "#id") public User findUserById(Integer id) &#123; System.out.println("===&gt; findUserById(id), id = " + id); return new User(id, "taven"); &#125; /** * Â∞ÜÁªìÊûúÁºìÂ≠òÔºåÂπ∂‰∏îËØ•ÊñπÊ≥ï‰∏çÁÆ°ÁºìÂ≠òÊòØÂê¶Â≠òÂú®ÔºåÊØèÊ¨°ÈÉΩ‰ºöÊâßË°å * * @param user * @return */ @CachePut(key = "#user.id") public User update(User user) &#123; System.out.println("===&gt; update(user), user = " + user); return user; &#125; /** * ÁßªÈô§ÁºìÂ≠òÔºåÊ†πÊçÆÊåáÂÆökey * * @param user */ @CacheEvict(key = "#user.id") public void deleteById(User user) &#123; System.out.println("===&gt; deleteById(), user = " + user); &#125; /** * ÁßªÈô§ÂΩìÂâç cacheName‰∏ãÊâÄÊúâÁºìÂ≠ò * */ @CacheEvict(allEntries = true) public void deleteAll() &#123; System.out.println("===&gt; deleteAll()"); &#125;&#125; Ê≥®Ëß£ ‰ΩúÁî® @Cacheable | Â∞ÜÊñπÊ≥ïÁöÑÁªìÊûúÁºìÂ≠òËµ∑Êù•Ôºå‰∏ã‰∏ÄÊ¨°ÊñπÊ≥ïÊâßË°åÂèÇÊï∞Áõ∏ÂêåÊó∂ÔºåÂ∞Ü‰∏çÊâßË°åÊñπÊ≥ïÔºåËøîÂõûÁºìÂ≠ò‰∏≠ÁöÑÁªìÊûú@CacheEvict | ÁßªÈô§ÊåáÂÆöÁºìÂ≠ò@CachePut | Ê†áËÆ∞ËØ•Ê≥®Ëß£ÁöÑÊñπÊ≥ïÊÄª‰ºöÊâßË°åÔºåÊ†πÊçÆÊ≥®Ëß£ÁöÑÈÖçÁΩÆÂ∞ÜÁªìÊûúÁºìÂ≠ò@Caching | ÂèØ‰ª•ÊåáÂÆöÁõ∏ÂêåÁ±ªÂûãÁöÑÂ§ö‰∏™ÁºìÂ≠òÊ≥®Ëß£Ôºå‰æãÂ¶ÇÊ†πÊçÆ‰∏çÂêåÁöÑÊù°‰ª∂@CacheConfig | Á±ªÁ∫ßÂà´Ê≥®Ëß£ÔºåÂèØ‰ª•ËÆæÁΩÆ‰∏Ä‰∫õÂÖ±ÈÄöÁöÑÈÖçÁΩÆÔºå@CacheConfig(cacheNames=&quot;user&quot;), ‰ª£Ë°®ËØ•Á±ª‰∏ãÁöÑÊñπÊ≥ïÂùá‰ΩøÁî®Ëøô‰∏™cacheNames ‰∏ãÈù¢ËØ¶ÁªÜËÆ≤‰∏Ä‰∏ãÊØè‰∏™Ê≥®Ëß£ÁöÑ‰ΩúÁî®ÂíåÂèØÈÄâÈ°π„ÄÇ Spring Cache Ê≥®Ëß£@EnableCaching ÂÅö‰∫Ü‰ªÄ‰πà @EnableCaching Ê≥®ÈáäËß¶ÂèëÂêéÁΩÆÂ§ÑÁêÜÂô®, Ê£ÄÊü•ÊØè‰∏Ä‰∏™Spring bean ÁöÑ public ÊñπÊ≥ïÊòØÂê¶Â≠òÂú®ÁºìÂ≠òÊ≥®Ëß£„ÄÇÂ¶ÇÊûúÊâæÂà∞ËøôÊ†∑ÁöÑ‰∏Ä‰∏™Ê≥®Èáä, Ëá™Âä®ÂàõÂª∫‰∏Ä‰∏™‰ª£ÁêÜÊã¶Êà™ÊñπÊ≥ïË∞ÉÁî®ÂíåÂ§ÑÁêÜÁõ∏Â∫îÁöÑÁºìÂ≠òË°å‰∏∫„ÄÇ Â∏∏Áî®ÁºìÂ≠òÊ≥®Ëß£ÁÆÄËø∞@CacheableÂ∞ÜÊñπÊ≥ïÁöÑÁªìÊûúÁºìÂ≠òÔºåÂøÖÈ°ªË¶ÅÊåáÂÆö‰∏Ä‰∏™ cacheNameÔºàÁºìÂ≠òÁ©∫Èó¥Ôºâ12@Cacheable(&quot;books&quot;)public Book findBook(ISBN isbn) &#123;...&#125; ÈªòËÆ§ cache keyÁºìÂ≠òÁöÑÊú¨Ë¥®ËøòÊòØ‰ª• key-value ÁöÑÂΩ¢ÂºèÂ≠òÂÇ®ÁöÑÔºåÈªòËÆ§ÊÉÖÂÜµ‰∏ãÊàë‰ª¨‰∏çÊåáÂÆökeyÁöÑÊó∂ÂÄô Ôºå‰ΩøÁî® SimpleKeyGenerator ‰Ωú‰∏∫keyÁöÑÁîüÊàêÁ≠ñÁï• Â¶ÇÊûúÊ≤°ÊúâÁªôÂá∫ÂèÇÊï∞ÔºåÂàôËøîÂõûSimpleKey.EMPTY„ÄÇ Â¶ÇÊûúÂè™ÁªôÂá∫‰∏Ä‰∏™ParamÔºåÂàôËøîÂõûËØ•ÂÆû‰æã„ÄÇ Â¶ÇÊûúÁªôÂá∫‰∫ÜÊõ¥Â§öÁöÑParamÔºåÂàôËøîÂõûÂåÖÂê´ÊâÄÊúâÂèÇÊï∞ÁöÑSimpleKey„ÄÇ Ê≥®ÊÑèÔºöÂΩì‰ΩøÁî®ÈªòËÆ§Á≠ñÁï•Êó∂ÔºåÊàë‰ª¨ÁöÑÂèÇÊï∞ÈúÄË¶ÅÊúâ ÊúâÊïàÁöÑhashCode()Âíåequals()ÊñπÊ≥ï Ëá™ÂÆö‰πâ cache key12345678@Cacheable(cacheNames=&quot;books&quot;, key=&quot;#isbn&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed)@Cacheable(cacheNames=&quot;books&quot;, key=&quot;#isbn.rawNumber&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed)@Cacheable(cacheNames=&quot;books&quot;, key=&quot;T(someType).hash(#isbn)&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed) Â¶Ç‰∏äÔºåÈÖçÂêàSpring EL ‰ΩøÁî®Ôºå‰∏ãÊñá‰ºöËØ¶ÁªÜ‰ªãÁªç Spring EL ÂØπ Cache ÁöÑÊîØÊåÅ ÊåáÂÆöÂØπË±° ÊåáÂÆöÂØπË±°‰∏≠ÁöÑÂ±ûÊÄß Êüê‰∏™Á±ªÁöÑÊüê‰∏™ÈùôÊÄÅÊñπÊ≥ï Ëá™ÂÆö‰πâ keyGenerator12@Cacheable(cacheNames=&quot;books&quot;, keyGenerator=&quot;myKeyGenerator&quot;)public Book findBook(ISBN isbn, boolean checkWarehouse, boolean includeUsed) ÂÆûÁé∞ KeyGeneratorÊé•Âè£ÂèØ‰ª•Ëá™ÂÆö‰πâ cache key ÁöÑÁîüÊàêÁ≠ñÁï• Ëá™ÂÆö‰πâ cacheManager12@Cacheable(cacheNames=&quot;books&quot;, cacheManager=&quot;anotherCacheManager&quot;) public Book findBook(ISBN isbn) &#123;...&#125; ÂΩìÊàë‰ª¨ÁöÑÈ°πÁõÆÂåÖÂê´Â§ö‰∏™ÁºìÂ≠òÁÆ°ÁêÜÂô®Êó∂ÔºåÂèØ‰ª•ÊåáÂÆöÂÖ∑‰ΩìÁöÑÁºìÂ≠òÁÆ°ÁêÜÂô®Ôºå‰Ωú‰∏∫ÁºìÂ≠òËß£Êûê ÂêåÊ≠•ÁºìÂ≠òÂú®Â§öÁ∫øÁ®ãÁéØÂ¢É‰∏≠ÔºåÂèØËÉΩ‰ºöÂá∫Áé∞Áõ∏ÂêåÁöÑÂèÇÊï∞ÁöÑËØ∑Ê±ÇÂπ∂ÂèëË∞ÉÁî®ÊñπÊ≥ïÁöÑÊìç‰ΩúÔºåÈªòËÆ§ÊÉÖÂÜµ‰∏ãÔºåspring cache ‰∏ç‰ºöÈîÅÂÆö‰ªª‰Ωï‰∏úË•øÔºåÁõ∏ÂêåÁöÑÂÄºÂèØËÉΩ‰ºöË¢´ËÆ°ÁÆóÂá†Ê¨°ÔºåËøôÂ∞±ËøùËÉå‰∫ÜÁºìÂ≠òÁöÑÁõÆÁöÑ ÂØπ‰∫éËøô‰∫õÁâπÊÆäÊÉÖÂÜµÔºåÂèØ‰ª•‰ΩøÁî®syncÂ±ûÊÄß„ÄÇÊ≠§Êó∂Âè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãÂú®Â§Ñ‰∫éËÆ°ÁÆóÔºåËÄåÂÖ∂‰ªñÁ∫øÁ®ãÂàôË¢´ÈòªÂ°ûÔºåÁõ¥Âà∞Âú®ÁºìÂ≠ò‰∏≠Êõ¥Êñ∞Êù°ÁõÆ‰∏∫Ê≠¢„ÄÇ12@Cacheable(cacheNames=&quot;foos&quot;, sync=true) public Foo executeExpensiveOperation(String id) &#123;...&#125; Êù°‰ª∂ÁºìÂ≠ò condition: ‰ªÄ‰πàÊÉÖÂÜµÁºìÂ≠òÔºåcondition = true Êó∂ÁºìÂ≠òÔºåÂèç‰πã‰∏çÁºìÂ≠ò unless: ‰ªÄ‰πàÊÉÖÂÜµ‰∏çÁºìÂ≠òÔºåunless = true Êó∂‰∏çÁºìÂ≠òÔºåÂèç‰πãÁºìÂ≠ò12345@Cacheable(cacheNames=&quot;book&quot;, condition=&quot;#name.length() &lt; 32&quot;) public Book findBook(String name)@Cacheable(cacheNames=&quot;book&quot;, condition=&quot;#name.length() &lt; 32&quot;, unless=&quot;#result?.hardback&quot;)public Optional&lt;Book&gt; findBook(String name) Spring EL ÂØπ Cache ÁöÑÊîØÊåÅ Name Location Description Example methodName Root object Ë¢´Ë∞ÉÁî®ÁöÑÊñπÊ≥ïÁöÑÂêçÁß∞ #root.methodName method Root object Ë¢´Ë∞ÉÁî®ÁöÑÊñπÊ≥ï #root.method.name target Root object ÂΩìÂâçË∞ÉÁî®ÊñπÊ≥ïÁöÑÂØπË±° #root.target targetClass Root object ÂΩìÂâçË∞ÉÁî®ÊñπÊ≥ïÁöÑÁ±ª #root.targetClass args Root object ÂΩìÂâçÊñπÊ≥ïÁöÑÂèÇÊï∞ #root.args[0] caches Root object ÂΩìÂâçÊñπÊ≥ïÁöÑÁºìÂ≠òÈõÜÂêà #root.caches[0].name Argument name Evaluation context ÂΩìÂâçÊñπÊ≥ïÁöÑÂèÇÊï∞ÂêçÁß∞ #iban or #a0 (you can also use #p0 or #p&lt;#arg&gt; notation as an alias). result Evaluation context ÊñπÊ≥ïËøîÂõûÁöÑÁªìÊûú(Ë¶ÅÁºìÂ≠òÁöÑÂÄº)„ÄÇÂè™ÊúâÂú® unless „ÄÅ@CachePut(Áî®‰∫éËÆ°ÁÆóÈîÆ)Êàñ@CacheEvict(beforeInvocation=false)‰∏≠ÊâçÂèØÁî®.ÂØπ‰∫éÊîØÊåÅÁöÑÂåÖË£ÖÂô®(‰æãÂ¶ÇOptional)Ôºå#resultÂºïÁî®ÁöÑÊòØÂÆûÈôÖÂØπË±°ÔºåËÄå‰∏çÊòØÂåÖË£ÖÂô® #result @CachePutËøô‰∏™Ê≥®Ëß£Âíå @Cacheable ÊúâÁÇπÁ±ª‰ººÔºåÈÉΩ‰ºöÂ∞ÜÁªìÊûúÁºìÂ≠òÔºå‰ΩÜÊòØÊ†áËÆ∞ @CachePut ÁöÑÊñπÊ≥ïÊØèÊ¨°ÈÉΩ‰ºöÊâßË°åÔºåÁõÆÁöÑÂú®‰∫éÊõ¥Êñ∞ÁºìÂ≠òÔºåÊâÄ‰ª•‰∏§‰∏™Ê≥®Ëß£ÁöÑ‰ΩøÁî®Âú∫ÊôØÂÆåÂÖ®‰∏çÂêå„ÄÇ@Cacheable ÊîØÊåÅÁöÑÊâÄÊúâÈÖçÁΩÆÈÄâÈ°πÔºåÂêåÊ†∑ÈÄÇÁî®‰∫é@CachePut 12@CachePut(cacheNames=&quot;book&quot;, key=&quot;#isbn&quot;)public Book updateBook(ISBN isbn, BookDescriptor descriptor) ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºå‰∏çË¶ÅÂú®‰∏Ä‰∏™ÊñπÊ≥ï‰∏äÂêåÊó∂‰ΩøÁî®@Cacheable Âíå @CachePut @CacheEvictÁî®‰∫éÁßªÈô§ÁºìÂ≠ò ÂèØ‰ª•ÁßªÈô§ÊåáÂÆökey Â£∞Êòé allEntries=trueÁßªÈô§ËØ•CacheName‰∏ãÊâÄÊúâÁºìÂ≠ò Â£∞ÊòébeforeInvocation=true Âú®ÊñπÊ≥ïÊâßË°å‰πãÂâçÊ∏ÖÈô§ÁºìÂ≠òÔºåÊó†ËÆ∫ÊñπÊ≥ïÊâßË°åÊòØÂê¶ÊàêÂäü12345@CacheEvict(cacheNames=&quot;book&quot;, key=&quot;#isbn&quot;)public Book updateBook(ISBN isbn, BookDescriptor descriptor)@CacheEvict(cacheNames=&quot;books&quot;, allEntries=true) public void loadBooks(InputStream batch) @CachingÂèØ‰ª•ËÆ©‰Ω†Âú®‰∏Ä‰∏™ÊñπÊ≥ï‰∏äÂµåÂ•óÂ§ö‰∏™Áõ∏ÂêåÁöÑCache Ê≥®Ëß£Ôºà@Cacheable, @CachePut, @CacheEvictÔºâÔºåÂàÜÂà´ÊåáÂÆö‰∏çÂêåÁöÑÊù°‰ª∂12@Caching(evict = &#123; @CacheEvict(&quot;primary&quot;), @CacheEvict(cacheNames=&quot;secondary&quot;, key=&quot;#p0&quot;) &#125;)public Book importBooks(String deposit, Date date) @CacheConfigÁ±ªÁ∫ßÂà´Ê≥®Ëß£ÔºåÁî®‰∫éÈÖçÁΩÆ‰∏Ä‰∫õÂÖ±ÂêåÁöÑÈÄâÈ°πÔºàÂΩìÊñπÊ≥ïÊ≥®Ëß£Â£∞ÊòéÁöÑÊó∂ÂÄô‰ºöË¢´Ë¶ÜÁõñÔºâÔºå‰æãÂ¶Ç CacheName„ÄÇ ÊîØÊåÅÁöÑÈÄâÈ°πÂ¶Ç‰∏ãÔºö123456789101112@Target(&#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface CacheConfig &#123; String[] cacheNames() default &#123;&#125;; String keyGenerator() default &quot;&quot;; String cacheManager() default &quot;&quot;; String cacheResolver() default &quot;&quot;;&#125; ÂèÇËÄÉÔºö https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#cache-annotations-cacheable https://spring.io/guides/gs/caching/ Êú¨ÊñádemoÔºö https://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-redis]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>SpringBoot</tag>
        <tag>Cache</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[„ÄäShiro ‰∏Ä„ÄãSpringBoot+Shiro ÊûÑÂª∫WebÂ∑•Á®ã]]></title>
    <url>%2Fpost%2F9d0d6a3a.html</url>
    <content type="text"><![CDATA[Shiro ‰∏ÄÊ¨æÁÆÄÂçïÊòìÁî®ÔºåÂäüËÉΩÂº∫Â§ßÁöÑÂÆâÂÖ®Ê°ÜÊû∂ÔºåÂ∏ÆÂä©Êàë‰ª¨ÂÆâÂÖ®È´òÊïàÁöÑÊûÑÂª∫‰ºÅ‰∏öÁ∫ßÂ∫îÁî®„ÄÇ‰πãÂâçÂá†‰∏™È°πÁõÆÈÉΩÁî®Âà∞Ëøá ShiroÔºåÊúÄËøëÊäΩÁ©∫Ê¢≥ÁêÜ‰∫Ü‰∏Ä‰∏ãÔºåÂàÜ‰∫´‰∏Ä‰∫õÁªèÈ™å„ÄÇ Êú¨ÊñádemoÔºöÊà≥ËøôÈáåÊú¨ÊñádemoÈÄâÂûãÔºöthymeleaf, springboot 2, shiro, ehcachePS:Â¶ÇÊûúÊàë‰∏çÊãñÂª∂ÁöÑËØùÔºå‰º∞ËÆ°ËøòÊòØ‰ºöÊúâÂêéÁª≠ÁöÑ :Ôºâ Shiro ËÉΩÂÅö‰ªÄ‰πà ËÆ§ËØÅÔºöÁôªÂΩïÁî®Êà∑ÁöÑËÆ§ËØÅ ÊùÉÈôêÔºöÂü∫‰∫éËßíËâ≤ÂíåÊùÉÈôêÁöÑËÆøÈóÆÊùÉÈôêÔºàurlÊùÉÈôêÔºâÔºå‰ª•ÂèäÈ¢óÁ≤íÂåñÊùÉÈôêÊéßÂà∂ÔºàÊåâÈíÆÊùÉÈôêÔºâ Âä†ÂØÜÊäÄÊúØÔºöShiroÁöÑcryptoÂåÖ‰∏≠ÂåÖÂê´‰∫Ü‰∏ÄÁ≥ªÂàóÁöÑÊòì‰∫éÁêÜËß£Âíå‰ΩøÁî®ÁöÑÂä†ÂØÜ„ÄÅÂìàÂ∏åÔºàakaÊëòË¶ÅÔºâËæÖÂä©Á±ª sessionÁÆ°ÁêÜÔºöÂèØÂú®webÂÆπÂô®‰ª•Âèä EJBÂÆπÂô®‰∏≠‰ΩøÁî® sessionÔºåÂèØÊâ©Â±ï Ôºà‰æãÂ¶ÇÊàë‰ª¨ÂèØ‰ª•ÈÄöËøáÈáçÂÜô sessionDao Â∞Ü session Â≠òÂÇ®Âà∞Êï∞ÊçÆÂ∫ì‰∏≠Ôºâ RememberMeÔºöÂü∫‰∫écookieÁöÑËÆ∞‰ΩèÊàëÊúçÂä° Shiro Â∏∏Áî®ÁªÑ‰ª∂‰ªãÁªç SubjectÔºöSubjectÂÖ∂ÂÆû‰ª£Ë°®ÁöÑÂ∞±ÊòØÂΩìÂâçÊ≠£Âú®ÊâßË°åÊìç‰ΩúÁöÑÁî®Êà∑ÔºåÂè™‰∏çËøáÂõ†‰∏∫‚ÄúUser‚Äù‰∏ÄËà¨Êåá‰ª£‰∫∫Ôºå‰ΩÜÊòØ‰∏Ä‰∏™‚ÄúSubject‚ÄùÂèØ‰ª•ÊòØ‰∫∫Ôºå‰πüÂèØ‰ª•ÊòØ‰ªª‰ΩïÁöÑÁ¨¨‰∏âÊñπÁ≥ªÁªüÔºåÊúçÂä°Ë¥¶Âè∑Á≠â‰ªª‰ΩïÂÖ∂‰ªñÊ≠£Âú®ÂíåÂΩìÂâçÁ≥ªÁªü‰∫§‰∫íÁöÑÁ¨¨‰∏âÊñπËΩØ‰ª∂Á≥ªÁªü„ÄÇ ÊâÄÊúâÁöÑSubjectÂÆû‰æãÈÉΩË¢´ÁªëÂÆöÂà∞‰∏Ä‰∏™SecurityManagerÔºåÂ¶ÇÊûú‰Ω†Âíå‰∏Ä‰∏™Subject‰∫§‰∫íÔºåÊâÄÊúâÁöÑ‰∫§‰∫íÂä®‰ΩúÈÉΩ‰ºöË¢´ËΩ¨Êç¢ÊàêSubject‰∏éSecurityManagerÁöÑ‰∫§‰∫í SecurityManagerÔºöShiroÁöÑÊ†∏ÂøÉÔºå‰ªñ‰∏ªË¶ÅÁî®‰∫éÂçèË∞ÉShiroÂÜÖÈÉ®ÂêÑÁßçÂÆâÂÖ®ÁªÑ‰ª∂Ôºå‰∏çËøáÊàë‰ª¨‰∏ÄËà¨‰∏çÁî®Â§™ÂÖ≥ÂøÉSecurityManagerÔºåÂØπ‰∫éÂ∫îÁî®Á®ãÂ∫èÂºÄÂèëËÄÖÊù•ËØ¥Ôºå‰∏ªË¶ÅËøòÊòØ‰ΩøÁî®SubjectÁöÑAPIÊù•Â§ÑÁêÜÂêÑÁßçÂÆâÂÖ®È™åËØÅÈÄªËæë RealmÔºöËøôÊòØÁî®‰∫éËøûÊé•ShiroÂíåÂÆ¢Êà∑Á≥ªÁªüÁöÑÁî®Êà∑Êï∞ÊçÆÁöÑÊ°•Ê¢Å„ÄÇ‰∏ÄÊó¶ShiroÁúüÊ≠£ÈúÄË¶ÅËÆøÈóÆÂêÑÁßçÂÆâÂÖ®Áõ∏ÂÖ≥ÁöÑÊï∞ÊçÆÔºàÊØîÂ¶Ç‰ΩøÁî®Áî®Êà∑Ë¥¶Êà∑Êù•ÂÅöÁî®Êà∑Ë∫´‰ªΩÈ™åËØÅ‰ª•ÂèäÊùÉÈôêÈ™åËØÅÔºâÊó∂Ôºå‰ªñÊÄªÊòØÈÄöËøáË∞ÉÁî®Á≥ªÁªüÈÖçÁΩÆÁöÑÂêÑÁßçRealmÊù•ËØªÂèñÊï∞ÊçÆ ÂÖ≥‰∫éShiro ÁöÑÂÖ∂‰ΩôÊ†∏ÂøÉÁªÑ‰ª∂ÂèÇËÄÉ Shiro ÂÆòÁΩë ÊàñËÄÖ ShiroÁöÑÊû∂ÊûÑ Êú¨Êñá‰∏çÂÅöËøáÂ§öÁöÑÈòêËø∞ Shiro ÊòØÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑÁÆÄÂçïÊù•ËÆ≤ÁöÑËØùÔºåÂú®SpringÈ°πÁõÆ‰∏≠ Shiro ‰ºöÂ∞Ü‰ªñÁöÑÊâÄÊúâÁªÑ‰ª∂Ê≥®ÂÜåÂà∞ SecurityManager‰∏≠ ÂÜçÈÄöËøáÂ∞Ü SecurityManager Ê≥®ÂÜåÂà∞ ShiroFilterFactoryBeanÔºàËøô‰∏™Á±ªÂÆûÁé∞‰∫ÜSpring ÁöÑBeanPostProcessor‰ºöÈ¢ÑÂÖàÂä†ËΩΩÔºâ ‰∏≠Ôºå ÊúÄÂêé‰ª• filter ÁöÑÂΩ¢ÂºèÊ≥®ÂÜåÂà∞SpringÂÆπÂô®ÔºàÂÆûÁé∞‰∫ÜSpringÁöÑFactoryBeanÔºåÊûÑÈÄ†‰∏Ä‰∏™ filter Ê≥®ÂÜåÂà∞ Spring ÂÆπÂô®‰∏≠ÔºâÔºåÂÆûÁé∞Áî®Êà∑ÊùÉÈôêÁöÑÁÆ°ÁêÜ„ÄÇ Shiro Â¶Ç‰ΩïÈõÜÊàê shiro ÊâÄÈúÄ‰æùËµñÔºåÂÆåÊï¥ËßÅdemoÊ∫êÁ†Å 12345678910111213141516171819202122&lt;!--shiro--&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt; &lt;artifactId&gt;shiro-core&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt; &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt; &lt;artifactId&gt;shiro-ehcache&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt;&lt;/dependency&gt;&lt;!-- Âü∫‰∫éthymeleafÁöÑshiroÊâ©Â±ï --&gt;&lt;dependency&gt; &lt;groupId&gt;com.github.theborakompanioni&lt;/groupId&gt; &lt;artifactId&gt;thymeleaf-extras-shiro&lt;/artifactId&gt; &lt;version&gt;2.0.0&lt;/version&gt;&lt;/dependency&gt; ShiroConfig 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117@Configurationpublic class ShiroConfig &#123; private static final Logger log = LoggerFactory.getLogger(ShiroConfig.class); @Bean public ShiroFilterFactoryBean shiroFilterFactoryBean(DefaultWebSecurityManager securityManager) &#123; ShiroFilterFactoryBean shiroFilter = new ShiroFilterFactoryBean(); shiroFilter.setSecurityManager(securityManager); Map&lt;String, String&gt; chainDefinition = new LinkedHashMap&lt;&gt;(); // ÈùôÊÄÅËµÑÊ∫ê‰∏éÁôªÂΩïËØ∑Ê±Ç‰∏çÊã¶Êà™ chainDefinition.put("/js/**", "anon"); chainDefinition.put("/css/**", "anon"); chainDefinition.put("/img/**", "anon"); chainDefinition.put("/layui/**", "anon"); chainDefinition.put("/login", "anon"); chainDefinition.put("/login.html", "anon"); // Áî®Êà∑‰∏∫ÊéàÊùÉÈÄöËøáËÆ§ËØÅ &amp;&amp; ÂåÖÂê´'admin'ËßíËâ≤ chainDefinition.put("/admin/**", "authc, roles[super_admin]"); // Áî®Êà∑‰∏∫ÊéàÊùÉÈÄöËøáËÆ§ËØÅÊàñËÄÖRememberMe &amp;&amp; ÂåÖÂê´'document:read'ÊùÉÈôê chainDefinition.put("/docs/**", "user, perms[document:read]"); // Áî®Êà∑ËÆøÈóÆÊâÄÊúâËØ∑Ê±Ç ÊéàÊùÉÈÄöËøá || RememberMe chainDefinition.put("/**", "user"); shiroFilter.setFilterChainDefinitionMap(chainDefinition); // ÂΩì Áî®Êà∑Ë∫´‰ªΩÂ§±ÊïàÊó∂ÈáçÂÆöÂêëÂà∞ loginUrl shiroFilter.setLoginUrl("/login.html"); // Áî®Êà∑ÁôªÂΩïÂêéÈªòËÆ§ÈáçÂÆöÂêëËØ∑Ê±Ç shiroFilter.setSuccessUrl("/index.html"); return shiroFilter; &#125; @Bean public Realm realm() &#123; ShiroRealm realm = new ShiroRealm(); realm.setCredentialsMatcher(credentialsMatcher()); realm.setCacheManager(ehCacheManager()); return realm; &#125; @Bean public CacheManager ehCacheManager() &#123; EhCacheManager cacheManager = new EhCacheManager(); cacheManager.setCacheManagerConfigFile("classpath:ehcache.xml"); return cacheManager; &#125; @Bean public CredentialsMatcher credentialsMatcher() &#123; AuthCredentialsMatcher credentialsMatcher = new AuthCredentialsMatcher(ehCacheManager()); credentialsMatcher.setHashAlgorithmName(AuthCredentialsMatcher.HASH_ALGORITHM_NAME); credentialsMatcher.setHashIterations(AuthCredentialsMatcher.HASH_ITERATIONS); credentialsMatcher.setStoredCredentialsHexEncoded(true); return credentialsMatcher; &#125; @Bean public DefaultWebSecurityManager securityManager() &#123; log.debug("--------------shiroÂ∑≤ÁªèÂä†ËΩΩ----------------"); DefaultWebSecurityManager manager = new DefaultWebSecurityManager(); manager.setCacheManager(ehCacheManager()); manager.setRealm(realm()); manager.setRememberMeManager(rememberMeManager()); return manager; &#125; @Bean public RememberMeManager rememberMeManager() &#123; CookieRememberMeManager cookieRememberMeManager = new CookieRememberMeManager(); //rememberMe cookieÂä†ÂØÜÁöÑÂØÜÈí• Âª∫ËÆÆÊØè‰∏™È°πÁõÆÈÉΩ‰∏ç‰∏ÄÊ†∑ ÈªòËÆ§AESÁÆóÊ≥ï ÂØÜÈí•ÈïøÂ∫¶(128 256 512 ‰Ωç) cookieRememberMeManager.setCipherKey(Base64.decode("2AvVhdsgUs0FSA3SDFAdag==")); cookieRememberMeManager.setCookie(rememberMeCookie()); return cookieRememberMeManager; &#125; @Bean public SimpleCookie rememberMeCookie()&#123; //Ëøô‰∏™ÂèÇÊï∞ÊòØcookieÁöÑÂêçÁß∞ÔºåÂØπÂ∫îÂâçÁ´ØÁöÑcheckboxÁöÑname = rememberMe SimpleCookie simpleCookie = new SimpleCookie("rememberMe"); //&lt;!-- ËÆ∞‰ΩèÊàëcookieÁîüÊïàÊó∂Èó¥30Â§© ,Âçï‰ΩçÁßí;--&gt; simpleCookie.setMaxAge(259200); return simpleCookie; &#125; /** * ShiroÁîüÂëΩÂë®ÊúüÂ§ÑÁêÜÂô®: * Áî®‰∫éÂú®ÂÆûÁé∞‰∫ÜInitializableÊé•Âè£ÁöÑShiro beanÂàùÂßãÂåñÊó∂Ë∞ÉÁî®InitializableÊé•Âè£ÂõûË∞É(‰æãÂ¶Ç:UserRealm) * Âú®ÂÆûÁé∞‰∫ÜDestroyableÊé•Âè£ÁöÑShiro beanÈîÄÊØÅÊó∂Ë∞ÉÁî® DestroyableÊé•Âè£ÂõûË∞É(‰æãÂ¶Ç:DefaultSecurityManager) */ @Bean public LifecycleBeanPostProcessor lifecycleBeanPostProcessor() &#123; return new LifecycleBeanPostProcessor(); &#125; /** * ÂêØÁî®shrioÊéàÊùÉÊ≥®Ëß£Êã¶Êà™ÊñπÂºèÔºåAOPÂºèÊñπÊ≥ïÁ∫ßÊùÉÈôêÊ£ÄÊü• */ @Bean public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(DefaultWebSecurityManager securityManager) &#123; AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = new AuthorizationAttributeSourceAdvisor(); authorizationAttributeSourceAdvisor.setSecurityManager(securityManager); return authorizationAttributeSourceAdvisor; &#125; /** * thymeleafÁöÑshiroÊâ©Â±ï * * @return */ @Bean public ShiroDialect shiroDialect() &#123; return new ShiroDialect(); &#125;&#125; ‰ª•‰∏äÂü∫Êú¨ÊòØSpringÈ°πÁõÆÈõÜÊàê Shiro ÁöÑÈÄöÁî®ÈÖçÁΩÆÔºå‰∏ãÈù¢ÈíàÂØπ‰∏äËø∞ÁöÑÂá†‰∏™Bean ËÅä‰∏ÄËÅä1. ShiroFilterFactoryBeanÔºöÁî®‰∫éÂÆö‰πâ ËØ∑Ê±ÇÁöÑÊã¶Êà™ËßÑÂàô, Shiro‰∏∫Êàë‰ª¨ÈªòËÆ§Êèê‰æõ‰∫Ü‰∏Ä‰∫õÈÄâÈ°πÔºåÂ∏∏Áî®Â¶Ç‰∏ã anon: ËØ∑Ê±Ç‰∏çÊã¶Êà™ authc: Ë¶ÅÊ±ÇÁî®Êà∑ÂøÖÈ°ªËÆ§ËØÅÈÄöËøá user: Ë¶ÅÊ±ÇÁî®Êà∑‰∏∫ËÆ∞‰ΩèÊàëÁä∂ÊÄÅ roles[xxx]: Ë¶ÅÊ±ÇÁî®Êà∑ÂøÖÈ°ªÊª°Ë∂≥ xxx ËßíËâ≤ perms[xxx]: Ë¶ÅÊ±ÇÁî®Êà∑ÂøÖÈ°ªÊª°Ë∂≥ xxx ÊùÉÈôêÂÖ∂ÂÆû‰∏äËø∞ÊØè‰∏Ä‰∏™ÈÉΩÂØπÂ∫î‰∫Ü‰∏Ä‰∏™ Shiro ËøáÊª§Âô® Filter Name Class anon org.apache.shiro.web.filter.authc.AnonymousFilter authc org.apache.shiro.web.filter.authc.FormAuthenticationFilter authcBasic org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter logout org.apache.shiro.web.filter.authc.LogoutFilter noSessionCreation org.apache.shiro.web.filter.session.NoSessionCreationFilter perms | org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilterport| org.apache.shiro.web.filter.authz.PortFilterrest| org.apache.shiro.web.filter.authz.HttpMethodPermissionFilterroles| org.apache.shiro.web.filter.authz.RolesAuthorizationFilterssl| org.apache.shiro.web.filter.authz.SslFilteruser| org.apache.shiro.web.filter.authc.UserFilter Êàë‰ª¨‰πüÂèØ‰ª•Ëá™ÂÆö‰πâ ËøáÊª§Âô®Êù•ÂÆûÁé∞Êã¶Êà™ 2. RealmÔºö‰∏äÈù¢ÊèêÂà∞ËøáRealmÊòØÁî®‰∫éËøûÊé•ShiroÂíåÂÆ¢Êà∑Á≥ªÁªüÁöÑÁî®Êà∑Êï∞ÊçÆÁöÑÊ°•Ê¢Å, Êàë‰ª¨ÈÄöËøáÂÆûÁé∞AuthorizingRealm Êù•Êèê‰æõÁî®Êà∑ËÆ§ËØÅÂíåÊéàÊùÉ‰∏§‰∏™API 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778public class ShiroRealm extends AuthorizingRealm &#123; private static final Logger log = LoggerFactory.getLogger(AuthorizingRealm.class); @Autowired @Lazy // ËøôÈáålazy ÊòØÊúâÂøÖË¶ÅÁöÑ, shiroÁªÑ‰ª∂‰ºöÈ¢ÑÂÖàÂä†ËΩΩÔºåÂØºËá¥‰æùËµñÁöÑbean Ê≤°ÊúâÁîüÊàê‰ª£ÁêÜÂØπË±°ÔºàAOPÂ§±ÊïàÔºâ private UserService userService; /** * ËÆ§ËØÅ * * @param authenticationToken * @return * @throws AuthenticationException */ @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException &#123; String username = (String) authenticationToken.getPrincipal(); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executing doGetAuthenticationInfo", username)); &#125; User user = userService.getUserByUsername(username); if (user == null) &#123; throw new UnknownAccountException(); &#125; if (Constant.IS_LOCK.equals(user.getIsLock())) &#123; throw new LockedAccountException(); &#125; // ShiroUser ‰Ωú‰∏∫ÂÆûÈôÖÁöÑ principal ShiroUser shiroUser = new ShiroUser(); BeanUtils.copyProperties(user, shiroUser); // SimpleAuthenticationInfo(Object principal, Object credentials, String realmName) // principal ‰ºöË¢´Â∞ÅË£ÖÂà∞ subject ‰∏≠ // shiro ÈªòËÆ§‰ºöÊääÊàë‰ª¨ÁöÑ credentials (‰πüÂ∞±ÊòØpassword) Âíå token ‰∏≠ÁöÑ‰ΩúÂØπÊØîÔºåÊâÄ‰ª•Êàë‰ª¨ÂèØ‰ª•‰∏çÁî®ÂÅöÂØÜÁ†ÅÊ†°È™å ByteSource salt = ByteSource.Util.bytes(user.getUsername()); SimpleAuthenticationInfo info = new SimpleAuthenticationInfo(shiroUser, user.getPassword(), salt, getName()); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executed doGetAuthenticationInfo", username)); &#125; return info; &#125; /** * ÊéàÊùÉ * * @param principalCollection * @return */ @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) &#123; ShiroUser shiroUser = (ShiroUser) principalCollection.getPrimaryPrincipal(); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executing doGetAuthorizationInfo", shiroUser.getUsername())); &#125; AuthorizationDTO authorizationDTO = userService.getRolesAndPermissions(shiroUser.getId()); SimpleAuthorizationInfo info = new SimpleAuthorizationInfo(); info.addRoles(authorizationDTO.getRoleCodeSet()); info.addStringPermissions(authorizationDTO.getPermissionCodeSet()); if (log.isDebugEnabled()) &#123; log.debug(String.format("user:%s executed doGetAuthorizationInfo", shiroUser.getUsername())); &#125; return info; &#125;&#125; doGetAuthenticationInfo : ËÆ§ËØÅÊñπÊ≥ïÔºåÂú®ÊâßË°å subject.login(token);ÂêéÔºåShiroËÆ§ËØÅÂô®‰ºöËØªÂèñ Realm ‰∏≠ÁöÑËØ•ÊñπÊ≥ïËé∑Âèñ AuthenticationInfoÂØπË±°ÔºàËÆ§ËØÅ‰ø°ÊÅØÔºâÔºåÂåÖÂê´principalÔºàÊàë‰ª¨Â≠òÂÇ®Âú®shiro subject‰∏≠ÁöÑÂØπË±°ÔºâÔºåcredentials ÔºàÂØÜÁ†ÅÔºâ„ÄÇ doGetAuthorizationInfo: ÊéàÊùÉÊñπÊ≥ïÔºåÂú®ÈúÄË¶ÅÊ†°È™åÁî®Êà∑ËÆøÈóÆÊùÉÈôêÁöÑÊó∂ÂÄôÔºåShiroÊéàÊùÉÂô®‰ºöËØªÂèñ Realm ‰∏≠ÁöÑËØ•ÊñπÊ≥ïËé∑Âèñ AuthorizationInfoÂØπË±°ÔºàÊéàÊùÉ‰ø°ÊÅØÔºâËØªÂèñDBÂêéÔºåÂèØ‰ª•ÈÄöËøá addRoles(roleCollection) Âíå addStringPermissions(permCollection) ËÆæÁΩÆÂΩìÂâçÁî®Êà∑ÁöÑËßíËâ≤ÂíåÊùÉÈôê„ÄÇShiro Âú®ÊãøÂà∞Ëøô‰∏™ÊùÉÈôê‰ø°ÊÅØÂêéÔºå‰ºöÂéªÊâæÁºìÂ≠òÁÆ°ÁêÜÂô®Ôºå‰ª•ÂΩìÂâç subject ÁöÑ principal ‰Ωú‰∏∫key ÁºìÂ≠òËµ∑Êù•„ÄÇ 3. CredentialsMatcher: ÂØÜÁ†ÅÂåπÈÖçÂô®ÔºåÁî®‰∫éÂåπÈÖç doGetAuthenticationInfo ÊñπÊ≥ïËøîÂõûÁöÑ credentials Âíå subject.login(token);Êó∂ÁöÑ token ‰∏≠ÁöÑ passwordÊòØÂê¶‰∏ÄËá¥„ÄÇÂ∏∏Áî®ÁöÑÂÆûÁé∞Êúâ SimpleCredentialsMatcherÔºàÈªòËÆ§ÊòØËØ•ÂÆûÁé∞Ôºâ„ÄÅHashedCredentialsMatcher ÔºàËØ•ÂÆûÁé∞ÂèØ‰ª•ËøõË°åÂä†ÂØÜÂåπÈÖçÔºâ 4. DefaultWebSecurityManagerÔºöÂ¶Ç‰∏äËø∞ÔºåÁî®‰∫éÂçèË∞ÉShiroÂÜÖÈÉ®ÂêÑÁßçÂÆâÂÖ®ÁªÑ‰ª∂ÔºåÊàë‰ª¨ÈúÄË¶ÅÂ∞ÜÊàë‰ª¨Êâ©Â±ïÁöÑbean Ê≥®ÂÜåÂà∞ SecurityManager ‰∏≠ 5. RememberMeManagerÔºöÂºÄÂêØËØ•ÁªÑ‰ª∂Âêé‰ΩøÁî®ËÆ∞‰ΩèÊàëÊúçÂä°Ôºå token ‰∏≠ rememberMe ‰∏∫ true Êó∂ÔºåÁôªÂΩïÊàêÂäü‰πãÂêé‰ºöÂàõÂª∫RememberMe cookie„ÄÇ ÂÖ∂‰ΩôÂèÇËÄÉ‰∏äÊñá‰ª£Á†ÅÊ≥®Èáä ÂÖ≥‰∫é thymeleaf-extras-shiroShiro ÈªòËÆ§ÊîØÊåÅÂú® jsp ‰∏≠‰ΩøÁî® shiroÊ†áÁ≠æ„ÄÇ‰ΩÜÊòØÊÉ≥Âú® thymeleaf ‰∏≠‰ΩøÁî® Shiro Ê†áÁ≠æÂë¢Ôºü ‰ΩøÁî® thymeleaf-extras-shiro ÂÆåÁæéËß£ÂÜ≥ thymeleaf È¢óÁ≤íÂåñÊùÉÈôêÊéßÂà∂1234567891011‰Ω†Â•Ω, &lt;span th:text=&quot;$&#123;principal&#125;&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;p shiro:hasRole=&quot;super_admin&quot;&gt;ÂΩìÂâçËßíËâ≤Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò&lt;/p&gt;&lt;button shiro:hasPermission=&quot;&apos;sys:user:add&apos;&quot;&gt;Ê∑ªÂä†&lt;/button&gt;&lt;button shiro:hasPermission=&quot;&apos;sys:user:update&apos;&quot;&gt;ÁºñËæë&lt;/button&gt;&lt;button shiro:hasPermission=&quot;&apos;sys:user:lock&apos;&quot;&gt;ÂÜªÁªì&lt;/button&gt;&lt;div shiro:hasAllPermissions=&quot;&apos;sys:user:add, sys:user:update, sys:user:lock&apos;&quot;&gt; &lt;span&gt;Êª°Ë∂≥ÊâÄÊúâÊùÉÈôêÊó∂ÊòæÁ§∫&lt;/span&gt;&lt;/div&gt;&lt;div shiro:hasAnyPermissions=&quot;&apos;sys:user:add, sys:user:update, sys:user:lock&apos;&quot;&gt; &lt;span&gt;Êª°Ë∂≥‰∏Ä‰∏™ÊùÉÈôêÂç≥ÂèØÊòæÁ§∫&lt;/span&gt;&lt;/div&gt; Êõ¥Â§öÁî®Ê≥ïÂèÇËÄÉGithub ÊñáÊ°£Ôºöhttps://github.com/theborakompanioni/thymeleaf-extras-shiro Êú¨Êñádemohttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-shiroÂ¶ÇÊûú‰Ω†ÂèëÁé∞ÊàëÁöÑÊñáÁ´†ÊàñËÄÖdemo‰∏≠Â≠òÂú®ÈóÆÈ¢òÔºåËØ∑ËÅîÁ≥ªÊàë]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Shiro</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring-Âèà‰∏ÄÊ¨°‰∫ãÂä°‰∏çÁîüÊïàÁöÑÊéíÊü•]]></title>
    <url>%2Fpost%2F836297d7.html</url>
    <content type="text"><![CDATA[‰∏ä‰∏ÄÁØáÂÖ≥‰∫é‰∫ãÂä°ÁöÑ Ëß£ÂÜ≥ spring service Ë∞ÉÁî®ÂΩìÂâçÁ±ªÊñπÊ≥ï‰∫ãÂä°‰∏çÁîüÊïà Ê≠£Êñá‰ªäÂ§©Âú®Â∑•‰Ωú‰∏≠Á™ÅÁÑ∂ÂèëÁé∞Ê†áËÆ∞‰∫Ü @Transactional ÁöÑÊñπÊ≥ïÔºå‰∫ãÂä°Âπ∂Ê≤°ÊúâÁîüÊïà„ÄÇÂú®Ê£ÄÊü•‰∫Ü‰∏öÂä°Â±ÇÊòØÂê¶ try catchÂºÇÂ∏∏ÔºåMySQLÂ≠òÂÇ®ÂºïÊìé‰πãÂêé„ÄÇÂøÉÊÄÅÂ∑≤ËøëÂ¥©Ê∫ÉÁöÑËæπÁºòÔºö)Ëøô‰∏™Êó∂ÂÄôÁ™ÅÁÑ∂ÂèëÁé∞‰∫Ü‰∏Ä‰∏™Á•ûÂ•áÁöÑÁé∞Ë±°ÔºÅ‰∏§‰∏™@Service ÈÉΩÊ†áËÆ∞‰∫Ü @TransactionalÔºåuserService Âπ∂Ê≤°ÊúâÁîüÊàê‰ª£ÁêÜÂØπË±°Ôºå‰πüÂ∞±ÂØºËá¥‰∫Ü‰∫ãÂä°‰∏çÁîüÊïà„ÄÇ ÁªßÁª≠ÊéíÊü•ÔºåÊúÄÂêéÈîÅÂÆö‰∫ÜÂá∂Êâã ‚Äî BeanPostProcessor ÂÖàÁúã‰∏Ä‰∏ãÂÆòÊñπÊèèËø∞1234567891011121314/** * Factory hook that allows for custom modification of new bean instances, * e.g. checking for marker interfaces or wrapping them with proxies. * * &lt;p&gt;ApplicationContexts can autodetect BeanPostProcessor beans in their * bean definitions and apply them to any beans subsequently created. * Plain bean factories allow for programmatic registration of post-processors, * applying to all beans created through this factory. * * &lt;p&gt;Typically, post-processors that populate beans via marker interfaces * or the like will implement &#123;@link #postProcessBeforeInitialization&#125;, * while post-processors that wrap beans with proxies will normally * implement &#123;@link #postProcessAfterInitialization&#125;. * ÁÆÄÂçïÁöÑÊù•ËØ¥ÔºåBeanPostProcessorÊòØSpring ÁªôÊàë‰ª¨Êèê‰æõÁöÑ‰∏Ä‰∏™Êâ©Â±ïÊé•Âè£1234567public interface BeanPostProcessor &#123; // beanÂÆû‰æãÂåñÊñπÊ≥ïË∞ÉÁî®ÂâçË¢´Ë∞ÉÁî® Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException; // beanÂÆû‰æãÂåñÊñπÊ≥ïË∞ÉÁî®ÂêéË¢´Ë∞ÉÁî® Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException;&#125; ÂàÜÊûê ApplicationContexts Ê£ÄÊµãÂà∞ BeanPostProcessor ‰πãÂêé‰ºöÂ∞Ü‰ªñÂ∫îÁî®‰∫éÈöèÂêéÂàõÂª∫ÁöÑÊâÄÊúâ beanÔºåÊâÄ‰ª• BeanPostProcessor ‰ºöÂú®ÂÖ∂‰ªñBeanÁöÑ‰πãÂâçÂä†ËΩΩÔºå‰ΩÜÊòØÈöè‰πãÂºïÂèëÁöÑÈóÆÈ¢òÁöÑÂ∞±ÊòØ BeanPostProcessor ÂÆûÁé∞Á±ªÊâÄÂºïÁî®ÁöÑBean Ê≤°ÊúâË¢´‰ª£ÁêÜÔºåÂè™ÊòØË¢´ÊâòÁÆ°Âà∞ IOC ÂÆπÂô®‰∏≠„ÄÇ ÊàëÁöÑÈ°πÁõÆÈáåÂºïÁî®‰∫Ü ShiroÔºåËÄå Shiro ÁöÑÊâÄÊúâÁªÑ‰ª∂ÊúÄÁªà‰ºöË¢´Â∞ÅË£ÖÂà∞ ShiroFilterFactoryBean ÔºàËØ•Á±ªÂÆûÁé∞‰∫Ü BeanPostProcessorÔºâ‰∏≠ÔºåËÄå Shiro ÁöÑ Realm ‰∏≠Âèà‰æùËµñ‰∫ÜÊàë‰ª¨ÁöÑ ServiceÔºåËØ• Service È¢ÑÂÖàÂä†ËΩΩÔºåÂØºËá¥Ê≤°ÊúâË¢´‰ª£ÁêÜ Ëß£ÂÜ≥ÊñπÊ°à1234567public class AuthRealm extends AuthorizingRealm &#123; @Autowired @Lazy // Âª∂ËøüÂä†ËΩΩ private UserService userService;&#125; ÊÄªÁªìËøôÈáåÁªôÂ§ßÂÆ∂ÁÆÄÂçï‰ªãÁªçÂºïËµ∑‰∫ãÂä°‰∏çÁîüÊïàÁöÑÂá†‰∏™ÂéüÂõ† try catch ÊçïËé∑ Service ËøêË°åÊó∂ÂºÇÂ∏∏ÔºåÂõ†‰∏∫ Spring ÈªòËÆ§Âú®ÊçïËé∑Âà∞ RuntimeException Êó∂ÂõûÊªö MySQLÂ≠òÂÇ®ÂºïÊìé InnoDB ÊòØÊîØÊåÅ‰∫ãÂä°ÁöÑÔºåËÄå MyISAM ‰∏çÊîØÊåÅ Áî±‰∫éÂêÑÁßçÂéüÂõ†Ê≤°Êúâ‰ΩøÁî®ÊàñËÄÖ Spring Ê≤°ÊúâÁîüÊàê‰ª£ÁêÜÂØπË±°]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>AOP</tag>
        <tag>Shiro</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-insert-or-update]]></title>
    <url>%2Fpost%2F73b0b9b2.html</url>
    <content type="text"><![CDATA[Êàë‰ª¨ÁªèÂ∏∏‰ºöÈÅáÂà∞Á±ª‰ººÁöÑ‰∏öÂä°Âú∫ÊôØÔºåÊèíÂÖ•‰∏ÄÊù°Êï∞ÊçÆÂ¶ÇÊûú‰ªñ‰∏çÂ≠òÂú®ÂàôÊâßË°å insert ÔºåÂΩìËøôÊù°ËÆ∞ÂΩïÂ≠òÂú®ÁöÑÊó∂ÂÄôÔºåÊàë‰ª¨Âéª update ‰ªñÁöÑ‰∏Ä‰∫õÂ±ûÊÄßÔºàÊàñËÄÖ‰ªÄ‰πàÈÉΩ‰∏çÂÅöÔºâ„ÄÇ Ëß£ÂÜ≥ÊñπÊ°àÔºö ‰ΩøÁî® ON DUPLICATE KEY UPDATEÂú® ‰∏ªÈîÆ ÊàñËÄÖ ÂîØ‰∏ÄÁ∫¶Êùü ÈáçÂ§çÊó∂ÔºåÊâßË°åÊõ¥Êñ∞Êìç‰Ωú„ÄÇ ‰ΩøÁî® REPLACE INTOÂú® ‰∏ªÈîÆ ÊàñËÄÖ ÂîØ‰∏ÄÁ∫¶Êùü ÈáçÂ§çÊó∂ÔºåÂÖà delete ÂÜç insert„ÄÇ ON DUPLICATE KEY UPDATE ÂàõÂª∫Ë°®ÔºåÂª∫Á´ãÂîØ‰∏ÄÁ∫¶ÊùüÔºåÂáÜÂ§á‰∏ÄÊù°Êï∞ÊçÆ123456789101112CREATE TABLE `stu_class_ref` ( `id` varchar(30) NOT NULL, `stu_id` varchar(30) DEFAULT NULL, `class_id` varchar(30) DEFAULT NULL, `note` varchar(100) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `stu_id` (`stu_id`,`class_id`) USING BTREE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;INSERT INTO `test`.`stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (&apos;001&apos;, &apos;zhangsan&apos;, &apos;yuwen&apos;, NULL); ‰ΩøÁî® ON DUPLICATE KEY UPDATE 123456INSERT INTO `test`.`stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (UUID_SHORT(), &apos;zhangsan&apos;, &apos;yuwen&apos;, &apos;ÊàëÂñúÊ¨¢ËØ≠Êñá:)&apos;)ON DUPLICATE KEY UPDATE note = &apos;ÊàëÂñúÊ¨¢ËØ≠Êñá:)&apos;&gt; Affected rows: 2&gt; Êó∂Èó¥: 0.042s Affected rows: 2ÔºåMySQL Ê£ÄÊü•ÊèíÂÖ•ÁöÑË°åÊòØÂê¶‰ºö‰∫ßÁîüÈáçÂ§çÈîÆÈîôËØØÔºåÂ¶ÇÊûú‰ºöÂàôÊâßË°åupdate Â¶ÇÊûúÊÉ≥Ë¶ÅÂºïÁî® VALUES ‰∏≠ÁöÑÂÄºÔºåÂèÇËÄÉÂ¶Ç‰∏ã123456INSERT INTO `test`.`stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (UUID_SHORT(), &apos;zhangsan&apos;, &apos;yuwen&apos;, NULL)ON DUPLICATE KEY UPDATE note = VALUES(class_id)&gt; Affected rows: 2&gt; Êó∂Èó¥: 0.006s REPLACE INTO MySQL ‰∏≠ ËøòÊúâ‰∏Ä‰∏™ÈªëÁßëÊäÄËØ≠Ê≥ï REPLACE INTO1234REPLACE INTO `stu_class_ref`(`id`, `stu_id`, `class_id`, `note`) VALUES (UUID_SHORT(), &apos;zhangsan&apos;, &apos;yuwen&apos;, NULL)&gt; Affected rows: 2&gt; Êó∂Èó¥: 0.004s REPLACE INTO Â∞±ÊØîËæÉÁÆÄÂçïÁ≤óÊö¥‰∫ÜÔºå‰ªñ‰ºöÂÖàÊâßË°ådelete Êìç‰ΩúÔºåÁÑ∂Âêéinsert ON DUPLICATE KEY UPDATE ‰∏é REPLACE INTO ÂÜçÊù•ÂàõÂª∫‰∏ÄÂº†Ë°®, ÂàõÂª∫‰∏â‰∏™ÂîØ‰∏ÄÁ∫¶Êùü, ÊèíÂÖ•‰∏âÊù°Êï∞ÊçÆ123456789101112131415161718CREATE TABLE `interesting` ( `id` varchar(30) NOT NULL, `uni_a` varchar(30) DEFAULT NULL, `uni_b` varchar(30) DEFAULT NULL, `uni_c` varchar(30) DEFAULT NULL, `version` int(11) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `uni_a` (`uni_a`) USING BTREE, UNIQUE KEY `uni_b` (`uni_b`) USING BTREE, UNIQUE KEY `uni_c` (`uni_c`) USING BTREE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;INSERT INTO `test`.`interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (&apos;1&apos;, &apos;a&apos;, &apos;a&apos;, &apos;a&apos;, NULL);INSERT INTO `test`.`interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (&apos;2&apos;, &apos;b&apos;, &apos;b&apos;, &apos;b&apos;, NULL);INSERT INTO `test`.`interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (&apos;3&apos;, &apos;c&apos;, &apos;c&apos;, &apos;c&apos;, NULL); ÊâßË°å ON DUPLICATE KEY UPDATE12345INSERT INTO `interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (UUID_SHORT(), &apos;a&apos;, &apos;b&apos;, &apos;c&apos;, NULL)ON DUPLICATE KEY UPDATE version = 666&gt; Affected rows: 2&gt; Êó∂Èó¥: 0.049s Affected rows: 2 ‰ΩÜÊòØÂÖ∂ÂÆû‰∏âÊù°‰∏ªÈîÆÈÉΩÊúâÂÜ≤Á™Å‰∫Ü ÂÜçÁúã‰∏Ä‰∏ã REPLACE INTO1234REPLACE INTO `interesting`(`id`, `uni_a`, `uni_b`, `uni_c`, `version`) VALUES (UUID_SHORT(), &apos;a&apos;, &apos;b&apos;, &apos;c&apos;, NULL)&gt; Affected rows: 4&gt; Êó∂Èó¥: 0.026s Affected rows: 4 REPLACE INTO Â∞Ü‰∏âÊù°ÊúâÂÜ≤Á™ÅÁöÑÂÖ®ÈÉ®delete ÁÑ∂Âêé insert ####ÊÄªÁªìÔºö ON DUPLICATE KEY UPDATE Âè™‰ºöÂØπÊâÄÂåπÈÖçÁöÑÁ¨¨‰∏ÄË°åËøõË°åupdate, REPLACE INTO ‰ºöÂØπÊâÄÊúâÂåπÈÖçË°åËøõË°ådelete, insert ÊâÄ‰ª•Â∫îÈÅøÂÖçÂØπÊúâÂ§ö‰∏™ÂîØ‰∏ÄÁ¥¢ÂºïÁöÑË°®‰ΩøÁî®]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot ‰ΩøÁî® hibernate validator]]></title>
    <url>%2Fpost%2F81ef5d67.html</url>
    <content type="text"><![CDATA[Êú¨ÊñáÂ∞ÜÂÖ®Èù¢ÁöÑ‰ªãÁªçÂ¶Ç‰Ωï‰ΩøÁî® validator ËøõË°åÊï∞ÊçÆÊ†°È™å Êú¨ÊñáÊ∫êÁ†ÅÔºöhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-validate ÂáÜÂ§áÂ∑•‰ΩúÊàë‰ª¨Âè™ÈúÄË¶ÅÂºïÂÖ• spring-boot-starter-webÂåÖÂç≥ÂèØ‰ΩøÁî® Â∏∏Áî®Ê≥®Ëß£ Ê≥®Ëß£ Èáä‰πâ @Valid Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÊòØ‰∏Ä‰∏™ÂØπË±°ÔºåÈúÄË¶ÅÊ£ÄÊü•Ê≠§ÂØπË±°ÁöÑÊâÄÊúâÂ≠óÊÆµÂÄº @Null Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ª‰∏∫ null @NotNull Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ª‰∏ç‰∏∫ null @NotEmpty Ë¢´Ê≥®ÈáäÁöÑÂ≠óÁ¨¶‰∏≤ÁöÑÂøÖÈ°ªÈùûÁ©∫, Âç≥‰∏ç‰∏∫null, ‚Äú‚Äù @NotBlank Ë¢´Ê≥®ÈáäÁöÑÂ≠óÁ¨¶‰∏≤ÁöÑÂøÖÈ°ªÈùûÁ©∫, Âç≥‰∏ç‰∏∫null, ‚Äú‚Äù, ‚Äú ‚Äú @AssertTrue Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ª‰∏∫ true @AssertFalse Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ª‰∏∫ false @Min(value) Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ªÊòØ‰∏Ä‰∏™Êï∞Â≠óÔºåÂÖ∂ÂÄºÂøÖÈ°ªÂ§ß‰∫éÁ≠â‰∫éÊåáÂÆöÁöÑÊúÄÂ∞èÂÄº @Max(value) Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ªÊòØ‰∏Ä‰∏™Êï∞Â≠óÔºåÂÖ∂ÂÄºÂøÖÈ°ªÂ∞è‰∫éÁ≠â‰∫éÊåáÂÆöÁöÑÊúÄÂ§ßÂÄº @DecimalMin(value) Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ªÊòØ‰∏Ä‰∏™Êï∞Â≠óÔºåÂÖ∂ÂÄºÂøÖÈ°ªÂ§ß‰∫éÁ≠â‰∫éÊåáÂÆöÁöÑÊúÄÂ∞èÂÄº @DecimalMax(value) Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ªÊòØ‰∏Ä‰∏™Êï∞Â≠óÔºåÂÖ∂ÂÄºÂøÖÈ°ªÂ∞è‰∫éÁ≠â‰∫éÊåáÂÆöÁöÑÊúÄÂ§ßÂÄº @Size(max, min) Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÁöÑÂ§ßÂ∞èÂøÖÈ°ªÂú®ÊåáÂÆöÁöÑËåÉÂõ¥ÂÜÖ @Digits (integer, fraction) Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ªÊòØ‰∏Ä‰∏™Êï∞Â≠óÔºåÂÖ∂ÂÄºÂøÖÈ°ªÂú®ÂèØÊé•ÂèóÁöÑËåÉÂõ¥ÂÜÖ @Past Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ªÊòØ‰∏Ä‰∏™ËøáÂéªÁöÑÊó•Êúü @Future Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ªÊòØ‰∏Ä‰∏™Â∞ÜÊù•ÁöÑÊó•Êúü @Pattern(value) Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ªÁ¨¶ÂêàÊåáÂÆöÁöÑÊ≠£ÂàôË°®ËææÂºè @Email Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ªÊòØÁîµÂ≠êÈÇÆÁÆ±Âú∞ÂùÄ @Length(min=, max=) Ë¢´Ê≥®ÈáäÁöÑÂ≠óÁ¨¶‰∏≤ÁöÑÂ§ßÂ∞èÂøÖÈ°ªÂú®ÊåáÂÆöÁöÑËåÉÂõ¥ÂÜÖ @Range(min=, max=) Ë¢´Ê≥®ÈáäÁöÑÂÖÉÁ¥†ÂøÖÈ°ªÂú®ÂêàÈÄÇÁöÑËåÉÂõ¥ ÁÆÄÂçïÁöÑÂÆû‰ΩìÊ†°È™å123456789101112131415161718public class CardDTO &#123; @NotBlank private String cardId; @Size(min = 10, max = 10) @NotNull private String cardNum; // Âç°Âè∑ @Past @NotNull private Date createDate; @Range(max = 3) private String cardType; // ÁúÅÁï•get set&#125; 123456789@RestControllerpublic class UserController &#123; @PostMapping(&quot;simple&quot;) public Object simple(@RequestBody @Valid CardDTO cardDTO) &#123; return cardDTO; &#125;&#125; ÂÆû‰ΩìÂ±ûÊÄß‰∏äÊ∑ªÂä†Ê†°È™åÊ≥®Ëß£ controller ÊñπÊ≥ï ÂèÇÊï∞Ââç ‰ΩøÁî®@Valid Âç≥ÂèØ Â§çÊùÇÁöÑÂÆû‰ΩìÊ†°È™åÂµåÂ•óÂÆû‰ΩìÊ†°È™å123456789101112131415public class UserDTO &#123; @NotBlank private String userId; @NotBlank private String username; private String password; @Valid private List&lt;CardDTO&gt; cardList; //ÁúÅÁï• get set&#125; controller ÂÜôÊ≥ï Âêå‰∏äÔºåÂè™ÊòØÂú® UserDTO cardList Â±ûÊÄß‰∏äÊ†áËÆ∞@Valid Ê≥®Ëß£ Âç≥ÂèØ„ÄÇ List Ê†°È™å Êàë‰ª¨ÈúÄË¶ÅÂÉè ÂµåÂ•óÊ†°È™å Êó∂‰∏ÄÊ†∑ÔºåÂØπList&lt;CardDTO&gt; ÂÅö‰∏ÄÂ±ÇÂ∞ÅË£Ö 123456789101112131415public class ValidList&lt;E&gt; implements List&lt;E&gt; &#123; @Valid private List&lt;E&gt; list = new ArrayList&lt;&gt;(); public List&lt;E&gt; getList() &#123; return list; &#125; public void setList(List&lt;E&gt; list) &#123; this.list = list; &#125; // ÁúÅÁï•‰∫Ü ÂÆûÁé∞ÊñπÊ≥ï&#125; ÈáçÂÜôÂÆûÁé∞ÊñπÊ≥ïÂÆåÂÖ®‰ΩøÁî® this.list.xxx()Gitee:spring ‰ºöÂ∞ÜÊï∞ÊçÆÂ∞ÅË£ÖÂà∞Êàë‰ª¨ÂÆö‰πâÁöÑ list Â±ûÊÄß‰∏≠ÔºåÂèàÂ∞ÜÂ±ûÊÄßÂ£∞Êòé‰∫Ü @Valid ‰ΩøÂæó hibernate validator ÂèØ‰ª•‰∏∫Êàë‰ª¨ÂÅöÊ†°È™åÔºÅ ‰ΩøÁî® @Validated ÂàÜÁªÑÊ†°È™å12345public interface Insert &#123;&#125;public interface Update &#123;&#125; ÂÆö‰πâ‰∏§‰∏™Êé•Âè£ 12345678910111213public class GroupCardDTO &#123; @NotBlank(groups = &#123;Update.class&#125;) private String id; @NotBlank(groups = &#123;Insert.class&#125;) private String cardNum; @NotNull(groups = &#123;Insert.class, Update.class&#125;) private Integer cardType; //ÁúÅÁï• get set&#125; ÂÆû‰ΩìÊ†áËÆ∞ÁöÑÊ≥®Ëß£‰∏≠Ê∑ªÂä† group Â±ûÊÄß 1234@PostMapping(&quot;insert_card&quot;)public Object insert_card(@RequestBody @Validated(Insert.class) GroupCardDTO card)&#123; return card;&#125; ‰ΩøÁî® @Validated(xxx.class) Ê†áËÆ∞ÂèÇÊï∞ÔºåÂÆåÊàêÂàÜÁªÑÊ†°È™åÔºÅ Ëá™ÂÆö‰πâÊ≥®Ëß£Ê†°È™åÂΩì validator Êèê‰æõÁöÑÊ≥®Ëß£Êó†Ê≥ïÊª°Ë∂≥Êàë‰ª¨ÁöÑ‰∏öÂä°ÈúÄÊ±ÇÔºåÂèØ‰ª•ÈÄöËøáËá™ÂÆö‰πâÁöÑÊñπÂºèÊù•ÂÆûÁé∞Ê†°È™å„ÄÇ ÈúÄÊ±ÇÔºöÊ†°È™åÊüêÂ≠óÁ¨¶‰∏≤ÂøÖÈ°ª‰∏∫Â§ßÂÜôÊàñËÄÖÂ∞èÂÜô1234public enum CaseMode &#123; UPPER, LOWER&#125; ÂÆö‰πâ‰∏Ä‰∏™Êûö‰∏æÁ±ª 12345678910111213141516171819import javax.validation.Constraint;import javax.validation.Payload;import java.lang.annotation.*;@Target( &#123; ElementType.FIELD &#125;)@Retention(RetentionPolicy.RUNTIME)@Constraint(validatedBy = CheckCaseValidator.class)@Documentedpublic @interface CheckCase &#123; String message() default ""; Class&lt;?&gt;[] groups() default &#123;&#125;; Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;; CaseMode value() default CaseMode.LOWER;&#125; ÂÆö‰πâÊ≥®Ëß£ @Constraint ÊåáÂÆöÊàë‰ª¨ÁöÑÊ†°È™åÈÄªËæëÂÆûÁé∞Á±ª 12345678910111213141516171819202122232425262728293031import javax.validation.ConstraintValidator;import javax.validation.ConstraintValidatorContext;public class CheckCaseValidator implements ConstraintValidator&lt;CheckCase, String&gt; &#123; private CaseMode caseMode; @Override public void initialize(CheckCase constraintAnnotation) &#123; this.caseMode = constraintAnnotation.value(); &#125; @Override public boolean isValid(String value, ConstraintValidatorContext context) &#123; if (value == null || "".equals(value.trim())) &#123; return false; &#125; switch (this.caseMode) &#123; case LOWER: return value.equals(value.toLowerCase()); case UPPER: return value.equals(value.toUpperCase()); default: return false; &#125; &#125;&#125; initialize() ÂàùÂßãÂåñÊó∂ÊâßË°åÔºåÂèØ‰ª•Áî®Êù•Ëé∑ÂèñÊ≥®Ëß£‰∏≠ÁöÑÂ±ûÊÄß isValid() ÂÆûÁé∞Êàë‰ª¨ÁöÑÊ†°È™åÈÄªËæë Â§áÊ≥® Êàë‰ª¨Ëá™ÂÆö‰πâÁöÑÊ≥®Ëß£‰æùÁÑ∂ÊîØÊåÅ @Validated group ÂàÜÁªÑ ÊâãÂä®‰ΩøÁî® validator Ê†°È™å123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869import org.hibernate.validator.internal.engine.path.PathImpl;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;import java.util.Set;import javax.validation.ConstraintViolation;import javax.validation.Validation;import javax.validation.Validator;import javax.validation.ValidatorFactory;public class ValidateUtil &#123; /** * Ê†°È™åÂÆû‰ΩìÁ±ª * * @param t * @return */ public static &lt;T&gt; List&lt;Map&gt; validate(T t) &#123; //ÂÆö‰πâËøîÂõûÈîôËØØList List&lt;Map&gt; errList = new ArrayList&lt;&gt;(); Map&lt;String, String&gt; errorMap; ValidatorFactory factory = Validation.buildDefaultValidatorFactory(); Validator validator = factory.getValidator(); Set&lt;ConstraintViolation&lt;T&gt;&gt; errorSet = validator.validate(t); for (ConstraintViolation&lt;T&gt; c : errorSet) &#123; errorMap = new HashMap&lt;&gt;(); errorMap.put("field", c.getPropertyPath().toString()); //Ëé∑ÂèñÂèëÁîüÈîôËØØÁöÑÂ≠óÊÆµ errorMap.put("msg", c.getMessage()); //Ëé∑ÂèñÊ†°È™å‰ø°ÊÅØ errList.add(errorMap); &#125; return errList; &#125; /** * ‰ΩøÁî® ValidList Ê†°È™åList, ËøîÂõûÂØπÂ∫îÁ¥¢ÂºïÂíåÈîôËØØÊ∂àÊÅØ * * @param t * @param &lt;T&gt; * @return */ public static &lt;T&gt; List&lt;Map&gt; validateList(T t) &#123; //ÂÆö‰πâËøîÂõûÈîôËØØList List&lt;Map&gt; errList = new ArrayList&lt;&gt;(); Map&lt;String, Object&gt; errorMap; ValidatorFactory factory = Validation.buildDefaultValidatorFactory(); Validator validator = factory.getValidator(); Set&lt;ConstraintViolation&lt;T&gt;&gt; errorSet = validator.validate(t); for (ConstraintViolation&lt;T&gt; c : errorSet) &#123; errorMap = new HashMap&lt;&gt;(); int index = ((PathImpl) c.getPropertyPath()).getLeafNode().getIndex(); errorMap.put("index", index); // ÂΩìÂâçÁ¥¢Âºï errorMap.put("field", c.getPropertyPath().toString()); //Ëé∑ÂèñÂèëÁîüÈîôËØØÁöÑÂ≠óÊÆµ errorMap.put("msg", c.getMessage()); //Ëé∑ÂèñÊ†°È™å‰ø°ÊÅØ errList.add(errorMap); &#125; return errList; &#125;&#125; Êú¨ËäÇÊ∫êÁ†Åhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/springboot-validate]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JWT Èâ¥ÊùÉ]]></title>
    <url>%2Fpost%2F606cdcbb.html</url>
    <content type="text"><![CDATA[JWT ÊòØ‰ªÄ‰πà JSON Web TokenÔºàJWTÔºâÊòØ‰∏Ä‰∏™ÂºÄÊîæÂºèÊ†áÂáÜÔºàRFC 7519ÔºâÔºåÂÆÉÂÆö‰πâ‰∫Ü‰∏ÄÁßçÁ¥ßÂáë‰∏îËá™ÂåÖÂê´ÁöÑÊñπÂºèÔºåÁî®‰∫éÂú®ÂêÑÊñπ‰πãÈó¥‰ª•JSONÂØπË±°ÂÆâÂÖ®‰º†Ëæì‰ø°ÊÅØ„ÄÇËøô‰∫õ‰ø°ÊÅØÂèØ‰ª•ÈÄöËøáÊï∞Â≠óÁ≠æÂêçËøõË°åÈ™åËØÅÂíå‰ø°‰ªª„ÄÇ JWT ÁöÑÁªÑÊàêJWT ÁöÑÊ†ºÂºè‰∏∫ xxx.yyy.zzz„ÄÇÂåÖÂê´ HeaderÔºàÂ§¥ÈÉ®ÔºâÔºåPayloadÔºàË¥üËΩΩÔºâÔºåSignatureÔºàÁ≠æÂêçÔºâ‰∏âÈÉ®ÂàÜ„ÄÇ HeaderÈÄöÂ∏∏‰ºöÂ£∞Êòé‰ΩøÁî®ÁöÑÂä†ÂØÜÁÆóÊ≥ïÂíåtokenÁ±ªÂûã 1234&#123; &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot;&#125; PayloadPayload ÂåÖÂê´ ClaimsÔºåClaimÊòØ‰∏Ä‰∫õÂÆû‰ΩìÔºà‰∏ÄËà¨ÈÉΩÊòØÁî®Êà∑ÔºâÁöÑÁä∂ÊÄÅÂíåÈ¢ùÂ§ñÁöÑÊï∞ÊçÆÁªÑÊàê„ÄÇJWT ‰∏∫Êàë‰ª¨È¢ÑÂÆö‰πâ‰∫Ü‰∏Ä‰∫õ ClaimsÔºå‰æãÂ¶ÇÔºöiss (issuer), exp (expiration time), sub (subject), aud (audience), and others.‰ΩÜÊòØÂπ∂‰∏çË¶ÅÊ±ÇÊàë‰ª¨Âº∫Âà∂‰ΩøÁî®ÔºåÊàë‰ª¨‰πüÂèØ‰ª•Ê†πÊçÆÈúÄÊ±ÇËá™ÂÆö‰πâ Claim 12345&#123; &quot;sub&quot;: &quot;1234567890&quot;, &quot;name&quot;: &quot;Taven&quot;, &quot;admin&quot;: true&#125; Signature 1234HMACSHA256( base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), secret) ËøôÊÆµ‰º™‰ª£Á†ÅÂ∑≤ÁªèÂæàÂ•ΩÁöÑËÆ≤Ëß£‰∫ÜÔºåÁ≠æÂêçÊòØÂ¶Ç‰ΩïËÆ°ÁÆóÁöÑ„ÄÇÊúçÂä°Á´ØÊèê‰æõ‰∏Ä‰∏™secretÔºåÂ∞Üheader„ÄÅpayload ËøõË°åbase64ÁºñÁ†ÅÔºåÁÑ∂Âêé‰ΩøÁî®header‰∏≠Â£∞ÊòéÁöÑÁÆóÊ≥ïËÆ°ÁÆóÁ≠æÂêç„ÄÇ JWT ‰∏é session ÂØπÊØî ÊÄßËÉΩÔºöJWT ËΩªÈáèÁ∫ßÔºåËÄåsession ‰ºöÂç†Áî®Â§ßÈáèÊúçÂä°Á´ØÂÜÖÂ≠òÔºõ ÈÉ®ÁΩ≤Ôºö‰ΩøÁî®sessionÁöÑÁ≥ªÁªü Ë¥üËΩΩÂùáË°°ÈúÄË¶ÅËÄÉËôë session ÂÖ±‰∫´ÔºåËÄåJWT ‰∏çÈúÄË¶ÅÔºõ ÂÆâÂÖ®ÔºöÂÆâÂÖ®ÊÄßÁöÑËØùÔºåÂ∞èÂºü‰∏çÊï¢Â§öËØ¥ÔºåÊàëËßâÂæó‰∫î‰∫îÂºÄÂêßÔºåÊúâ‰∫∫ËØ¥ JWT Ê≥ÑÈú≤ÁöÑËØùÔºåÁõ¥Êé•Â∞±ÂèØ‰ª•ÁôªÂΩï‰∫Ü„ÄÇ‰ΩÜÊòØ‰ΩøÁî® session Â¶ÇÊûúËØ∑Ê±ÇË¢´Êã¶Êà™‰∫ÜÈÉΩÊòØ‰∏ÄÊ†∑ÁöÑÔºõ Âú∫ÊôØÔºöAPP ‰∏≠Áî±‰∫éÊ≤°ÊúâcookieÂêßÔºåÂ§öÊòØ‰ΩøÁî®token„ÄÇËÄå web Â∫îÁî®ÁöÑËØùÔºå‰ΩøÁî® token Âíå session ÈÉΩÊòØÂèØ‰ª•ÁöÑ„ÄÇ ÂÆûÁé∞ÊÄùË∑ØÁÆÄÂçï‰∏ÄÂè•ËØùÂ∞±ÊòØÔºåÁôªÂΩï‰πãÂêéÊúçÂä°Á´ØÁªôÂÆ¢Êà∑Á´ØÈ¢ÅÂèëJWTÔºåÂÆ¢Êà∑Á´ØÂ∞Ü JWT ÊîæÂú®ËØ∑Ê±ÇÂ§¥‰∏≠ÔºåÊúçÂä°Á´Ø filter Ê†°È™åhttp header‰∏≠ÁöÑJWT„ÄÇ Êü•ÈòÖ‰∫Ü‰∏Ä‰∫õËµÑÊñôÂêéÂèëÁé∞‰∏Ä‰∫õÂàÜÊ≠ß ÊñπÊ°à1Ôºö ÊúâÁöÑÊúãÂèãËÆ§‰∏∫ÊúçÂä°Á´Ø‰∏çÈúÄË¶ÅÂ≠òÂÇ® JWTÔºåÂè™Âú® filter Ê†°È™åÁöÑÊó∂ÂÄôËß£ÊûêÊó†ËØØÔºåÂç≥ËÆ§‰∏∫ JWT ÊòØÂèØÁî®ÁöÑ„ÄÇÂú®ÈúÄË¶ÅÈáçÁΩÆ JWT ÁöÑÊó∂ÂÄôÔºà‰æãÂ¶ÇÊ≥®ÈîÄÔºâÔºåÂÆ¢Êà∑Á´Ø‰∏ªÂä®Âà†Èô§JWT„ÄÇËøôÁßçÂÅöÊ≥ïÂºïÂèëÁöÑÈóÆÈ¢òÔºå‰æãÂ¶ÇÂú®Ê≥®ÈîÄ‰∫Ü‰πãÂêéÔºåtoken ‰æùÁÑ∂ÂèØÁî®ÔºåÁî±‰∫éÊúçÂä°Á´ØÊ≤°ÊúâÂ≠òÂÇ® tokenÔºåÊó†Ê≥ïÂéªÊ†°È™å„ÄÇ‰∫éÊòØ‰πéÊúâ‰∫ÜÊñπÊ°à2 ÊñπÊ°à2ÔºöÊúçÂä°Á´ØÊï∞ÊçÆÂ∫ì‰∏≠Â≠òÂÇ® JWTÔºåfilter ÊØèÊ¨°Ê†°È™å token ‰∏éÊï∞ÊçÆÂ∫ì‰∏≠ÊòØÂê¶‰∏ÄËá¥ÔºåËøôÁßçÂÅöÊ≥ïËôΩÁÑ∂Á®≥Â¶•Ôºå‰ΩÜÊòØÂú®ÊÄßËÉΩ‰∏ä‰∏ÄÂÆöÊòØ‰∏çÂ¶ÇÊñπÊ°à1ÁöÑ„ÄÇ demohttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-boot-jwt]]></content>
      <categories>
        <category>ÊäÄÊúØ</category>
      </categories>
      <tags>
        <tag>JWT</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot Atomikos Â§öÊï∞ÊçÆÊ∫êÂàÜÂ∏ÉÂºè‰∫ãÂä°]]></title>
    <url>%2Fpost%2F2727b3ac.html</url>
    <content type="text"><![CDATA[‰πãÂâçÁöÑ „Ääspring Âä®ÊÄÅÂàáÊç¢„ÄÅÊ∑ªÂä†Êï∞ÊçÆÊ∫êÂÆûÁé∞‰ª•ÂèäÊ∫êÁ†ÅÊµÖÊûê„Äã ‰∏≠‰ªãÁªç‰∫ÜÂ¶Ç‰Ωï‰ΩøÁî® spring Êèê‰æõÁöÑ AbstractRoutingDataSource ÈÖçÁΩÆÂ§öÊï∞ÊçÆÊ∫êÔºåÊúâ‰∫ÜÂ§öÊï∞ÊçÆÊ∫êËá™ÁÑ∂Ë¶ÅÁÆ°ÁêÜ‰∫ãÂä°ÁöÑ‰∏ÄËá¥ÊÄß„ÄÇ‰∏äÁØáÊñáÁ´†‰∏≠ÊèêÂà∞ËøáÈÖçÁΩÆÂ§öÊï∞ÊçÆÊ∫êÁöÑ‰∏§ÁßçÊñπÂºè ‰ΩøÁî®AbstractRoutingDataSource ÈÖçÁΩÆÂ§ö‰∏™ SqlSessionFactory ÂâçË®ÄÁ≤óÁï•ÈòÖËØª‰∫Ü‰∏Ä‰∏ãspringÁöÑÊ∫êÁ†ÅÔºåÁî±‰∫é spring ‰∫ãÂä°ÁöÑÊú∫Âà∂ÔºåÂú®ÂºÄÂêØ‰∫ãÂä°‰πãÂâçspring ‰ºöÂéªÂàõÂª∫ÂΩìÂâçÊï∞ÊçÆÊ∫êÁöÑ ‰∫ãÂä°objectÔºåÁõ¥Âà∞‰∫ãÂä°Êèê‰∫§Ôºåspring ÈÉΩ‰∏ç‰ºöÂú®‰πé‰Ω†ÊòØÂê¶ÂàáÊç¢‰∫ÜÊï∞ÊçÆÊ∫ê„ÄÇËøôÂ∞±ÂØºËá¥‰∫ÜÔºå‰ΩøÁî® AbstractRouting DataSource ÊñπÂºèÂºÄÂêØ‰∫ãÂä°Êó∂ÔºåÂàáÊç¢Êï∞ÊçÆÊ∫ê‰∏çÁîüÊïà„ÄÇÂÖ≥‰∫éÂ¶Ç‰ΩïËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºåÊÑüÂÖ¥Ë∂£ÁöÑÊúãÂèãÂèØ‰ª•ÂéªÈòÖËØª‰∏Ä‰∏ãÔºöhttps://www.jianshu.com/p/61e8961c6154 Êú¨ÊñáÂè™ËÆ®ËÆ∫‰∏äËø∞Á¨¨‰∫åÁßçÊñπÂºèÁªìÂêà atomikos ÁÆ°ÁêÜÂ§öÊï∞ÊçÆÊ∫ê‰∫ãÂä°„ÄÇ AtomikosÊù•Ëá™Ôºöhttp://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-jta.html Atomikos is a popular open source transaction manager which can be embedded into your Spring Boot application. You can use thespring-boot-starter-jta-atomikos Starter to pull in the appropriate Atomikos libraries. Spring Boot auto-configures Atomikos and ensures that appropriate depends-on settings are applied to your Spring beans for correct startup and shutdown ordering. By default, Atomikos transaction logs are written to a transaction-logs directory in your application‚Äôs home directory (the directory in which your application jar file resides). You can customize the location of this directory by setting a spring.jta.log-dir property in your application.properties file. Properties starting with spring.jta.atomikos.properties can also be used to customize the Atomikos UserTransactionServiceImp. See the AtomikosProperties Javadoc for complete details. ÂºïÂÖ•spring-boot-starter-jta-atomikosÔºåspring boot ‰∏∫Êàë‰ª¨Ëá™Âä®ÈÖçÁΩÆAtomikosÔºåÊàë‰ª¨ÂèØ‰ª•ÈÄöËøá spring.jta.xxx ‰øÆÊîπÈªòËÆ§ÈÖçÁΩÆ„ÄÇ Talk is cheap. Show me the code demoÊ∫êÁ†ÅÔºöhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-atomikos Ê∑ªÂä† maven ‰æùËµñ 12345678910&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jta-atomikos&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;1.1.1&lt;/version&gt;&lt;/dependency&gt; application.properties 1234567891011121314151617181920212223242526272829303132333435363738394041424344#spring.jta.log-dir=classpath:tx-logsspring.jta.transaction-manager-id=txManagerspring.datasource.druid.system-db.name=system-dbspring.datasource.druid.system-db.url=jdbc:mysql://localhost:3306/test1?useSSL=falsespring.datasource.druid.system-db.username=rootspring.datasource.druid.system-db.password=taven753spring.datasource.druid.system-db.initialSize=5spring.datasource.druid.system-db.minIdle=5spring.datasource.druid.system-db.maxActive=20spring.datasource.druid.system-db.maxWait=60000spring.datasource.druid.system-db.timeBetweenEvictionRunsMillis=60000spring.datasource.druid.system-db.minEvictableIdleTimeMillis=30000spring.datasource.druid.system-db.validationQuery=SELECT 1spring.datasource.druid.system-db.validationQueryTimeout=10000spring.datasource.druid.system-db.testWhileIdle=truespring.datasource.druid.system-db.testOnBorrow=falsespring.datasource.druid.system-db.testOnReturn=falsespring.datasource.druid.system-db.poolPreparedStatements=truespring.datasource.druid.system-db.maxPoolPreparedStatementPerConnectionSize=20spring.datasource.druid.system-db.filters=stat,wallspring.datasource.druid.system-db.connectionProperties=druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000spring.datasource.druid.system-db.useGlobalDataSourceStat=truespring.datasource.druid.business-db.name=business-dbspring.datasource.druid.business-db.url=jdbc:mysql://localhost:3306/test2?useSSL=falsespring.datasource.druid.business-db.username=rootspring.datasource.druid.business-db.password=taven753spring.datasource.druid.business-db.initialSize=5spring.datasource.druid.business-db.minIdle=5spring.datasource.druid.business-db.maxActive=20spring.datasource.druid.business-db.maxWait=60000spring.datasource.druid.business-db.timeBetweenEvictionRunsMillis=60000spring.datasource.druid.business-db.minEvictableIdleTimeMillis=30000spring.datasource.druid.business-db.validationQuery=SELECT 1spring.datasource.druid.business-db.validationQueryTimeout=10000spring.datasource.druid.business-db.testWhileIdle=truespring.datasource.druid.business-db.testOnBorrow=falsespring.datasource.druid.business-db.testOnReturn=falsespring.datasource.druid.business-db.poolPreparedStatements=truespring.datasource.druid.business-db.maxPoolPreparedStatementPerConnectionSize=20spring.datasource.druid.business-db.filters=stat,wallspring.datasource.druid.business-db.connectionProperties=druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000spring.datasource.druid.business-db.useGlobalDataSourceStat=true system Êï∞ÊçÆÊ∫êÁöÑÈÖçÁΩÆÁ±ª 12345678910111213141516171819202122232425262728293031323334353637383940414243import javax.sql.DataSource;import org.apache.ibatis.session.SqlSessionFactory;import org.mybatis.spring.SqlSessionFactoryBean;import org.mybatis.spring.annotation.MapperScan;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.jta.atomikos.AtomikosDataSourceBean;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.context.annotation.Primary;import com.gitee.taven.config.prop.SystemProperties;import com.gitee.taven.utils.PojoUtil;@Configuration@MapperScan(basePackages = SystemDataSourceConfig.PACKAGE, sqlSessionFactoryRef = "systemSqlSessionFactory")public class SystemDataSourceConfig &#123; static final String PACKAGE = "com.gitee.taven.mapper.system"; @Autowired private SystemProperties systemProperties; @Bean(name = "systemDataSource") @Primary public DataSource systemDataSource() &#123; AtomikosDataSourceBean ds = new AtomikosDataSourceBean(); ds.setXaProperties(PojoUtil.obj2Properties(systemProperties)); ds.setXaDataSourceClassName("com.alibaba.druid.pool.xa.DruidXADataSource"); ds.setUniqueResourceName("systemDataSource"); ds.setPoolSize(5); return ds; &#125; @Bean @Primary public SqlSessionFactory systemSqlSessionFactory() throws Exception &#123; SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean(); sqlSessionFactoryBean.setDataSource(systemDataSource()); return sqlSessionFactoryBean.getObject(); &#125; &#125; business Êï∞ÊçÆÊ∫êÁöÑÈÖçÁΩÆÁ±ªÂêå‰∏ä ÁúÅÁï•‰∫Ü mybatis ‰ª£Á†ÅÔºåÈÄöËøáservice ÊµãËØï‰∫ãÂä°ÔºåÊäõÂá∫ÂºÇÂ∏∏ÂêéÔºå‰∫ãÂä°‰ºöÂõûÊªö 1234567891011121314151617181920212223@Servicepublic class UserService &#123; @Autowired private UsersMapper usersMapper; @Autowired private UserInformationsMapper userInformationsMapper; @Transactional public void testJTA() &#123; Users u = new Users(); u.setUsername("hmj"); u.setPassword("hmjbest"); usersMapper.insertSelective(u); UserInformations ui = new UserInformations(); ui.setUserid(666l); ui.setEmail("dsb"); userInformationsMapper.insertSelective(ui); // int i = 10/0; &#125; &#125; demoÊ∫êÁ†ÅÔºöhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-atomikos]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Â§öÊï∞ÊçÆÊ∫ê</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot Â§öÁ∫øÁ®ãÂºÇÊ≠•Ë∞ÉÁî®---ÊèêÈ´òÁ®ãÂ∫èÊâßË°åÊïàÁéá]]></title>
    <url>%2Fpost%2F574b9274.html</url>
    <content type="text"><![CDATA[ÂéüÊñáÔºöhttps://spring.io/guides/gs/async-method/ ‰∏∫‰ªÄ‰πàË¶ÅÁî®ÂºÇÊ≠•ÔºüÂΩìÈúÄË¶ÅË∞ÉÁî®Â§ö‰∏™ÊúçÂä°Êó∂Ôºå‰ΩøÁî®‰º†ÁªüÁöÑÂêåÊ≠•Ë∞ÉÁî®Êù•ÊâßË°åÊó∂ÔºåÊòØËøôÊ†∑ÁöÑ Ë∞ÉÁî®ÊúçÂä°A Á≠âÂæÖÊúçÂä°AÁöÑÂìçÂ∫î Ë∞ÉÁî®ÊúçÂä°B Á≠âÂæÖÊúçÂä°BÁöÑÂìçÂ∫î Ë∞ÉÁî®ÊúçÂä°C Á≠âÂæÖÊúçÂä°CÁöÑÂìçÂ∫î Ê†πÊçÆ‰ªéÊúçÂä°A„ÄÅÊúçÂä°BÂíåÊúçÂä°CËøîÂõûÁöÑÊï∞ÊçÆÂÆåÊàê‰∏öÂä°ÈÄªËæëÔºåÁÑ∂ÂêéÁªìÊùü Â¶ÇÊûúÊØè‰∏™ÊúçÂä°ÈúÄË¶Å3ÁßíÁöÑÂìçÂ∫îÊó∂Èó¥ÔºåËøôÊ†∑È°∫Â∫èÊâßË°å‰∏ãÊù•ÔºåÂèØËÉΩÈúÄË¶Å9Áßí‰ª•‰∏äÊâçËÉΩÂÆåÊàê‰∏öÂä°ÈÄªËæëÔºå‰ΩÜÊòØÂ¶ÇÊûúÊàë‰ª¨‰ΩøÁî®ÂºÇÊ≠•Ë∞ÉÁî® Ë∞ÉÁî®ÊúçÂä°A Ë∞ÉÁî®ÊúçÂä°B Ë∞ÉÁî®ÊúçÂä°C ÁÑ∂ÂêéÁ≠âÂæÖ‰ªéÊúçÂä°A„ÄÅBÂíåCÁöÑÂìçÂ∫î Ê†πÊçÆ‰ªéÊúçÂä°A„ÄÅÊúçÂä°BÂíåÊúçÂä°CËøîÂõûÁöÑÊï∞ÊçÆÂÆåÊàê‰∏öÂä°ÈÄªËæëÔºåÁÑ∂ÂêéÁªìÊùü ÁêÜËÆ∫‰∏ä 3ÁßíÂ∑¶Âè≥Âç≥ÂèØÂÆåÊàêÂêåÊ†∑ÁöÑ‰∏öÂä°ÈÄªËæë Talk is cheap. Show me the code123456789101112131415161718192021222324252627public class User &#123; private String name; private String blog; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125; public String getBlog() &#123; return blog; &#125; public void setBlog(String blog) &#123; this.blog = blog; &#125; @Override public String toString() &#123; return "User [name=" + name + ", blog=" + blog + "]"; &#125;&#125; 12345678910111213141516171819202122232425262728293031import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.boot.web.client.RestTemplateBuilder;import org.springframework.scheduling.annotation.Async;import org.springframework.stereotype.Service;import org.springframework.web.client.RestTemplate;import java.util.concurrent.CompletableFuture;@Servicepublic class GitHubLookupService &#123; private static final Logger logger = LoggerFactory.getLogger(GitHubLookupService.class); private final RestTemplate restTemplate; public GitHubLookupService(RestTemplateBuilder restTemplateBuilder) &#123; this.restTemplate = restTemplateBuilder.build(); &#125; @Async public CompletableFuture&lt;User&gt; findUser(String user) throws InterruptedException &#123; logger.info("Looking up " + user); String url = String.format("https://api.github.com/users/%s", user); User results = restTemplate.getForObject(url, User.class); // Artificial delay of 3s for demonstration purposes Thread.sleep(3000L); return CompletableFuture.completedFuture(results); &#125;&#125; The findUser method is flagged with Spring‚Äôs @Async annotation, indicating it will run on a separate thread. The method‚Äôs return type is CompletableFuture&lt;User&gt; instead of User, a requirement for any asynchronous service. findUser ÊñπÊ≥ïË¢´Ê†áËÆ∞‰∏∫SpringÁöÑ @Async Ê≥®Ëß£ÔºåË°®Á§∫ÂÆÉÂ∞ÜÂú®‰∏Ä‰∏™ÂçïÁã¨ÁöÑÁ∫øÁ®ã‰∏äËøêË°å„ÄÇËØ•ÊñπÊ≥ïÁöÑËøîÂõûÁ±ªÂûãÊòØ CompleetableFuture&lt;user&gt; ËÄå‰∏çÊòØ UserÔºåËøôÊòØ‰ªª‰ΩïÂºÇÊ≠•ÊúçÂä°ÁöÑË¶ÅÊ±Ç„ÄÇ 1234567891011121314151617181920212223242526272829import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.context.annotation.Bean;import org.springframework.scheduling.annotation.EnableAsync;import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;import java.util.concurrent.Executor;@SpringBootApplication@EnableAsyncpublic class App &#123; public static void main(String[] args) &#123; // close the application context to shut down the custom ExecutorService SpringApplication.run(App.class, args).close(); &#125; @Bean public Executor asyncExecutor() &#123; ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(2); executor.setMaxPoolSize(2); executor.setQueueCapacity(500); executor.setThreadNamePrefix("GithubLookup-"); executor.initialize(); return executor; &#125;&#125; The @EnableAsync annotation switches on Spring‚Äôs ability to run @Async methods in a background thread pool. This class also customizes the used Executor. In our case, we want to limit the number of concurrent threads to 2 and limit the size of the queue to 500. There are many more things you can tune. By default, a SimpleAsyncTaskExecutor is used. @EnableAsync Ê≥®Ëß£ÂºÄÂêØSpringÂú®ÂêéÂè∞Á∫øÁ®ãÊ±†‰∏≠ËøêË°å @Async ÊñπÊ≥ïÁöÑËÉΩÂäõ„ÄÇËØ•Á±ª‰πüÂèØ‰ª•Ëá™ÂÆö‰πâ‰ΩøÁî®ÁöÑ Executor„ÄÇÂú®Êàë‰ª¨ÁöÑÁ§∫‰æã‰∏≠ÔºåÊàë‰ª¨Â∏åÊúõÂ∞ÜÂπ∂ÂèëÁ∫øÁ®ãÁöÑÊï∞ÈáèÈôêÂà∂‰∏∫2ÔºåÂπ∂Â∞ÜÈòüÂàóÁöÑÂ§ßÂ∞èÈôêÂà∂‰∏∫500„ÄÇÊúâÂæàÂ§ö‰Ω†ÂèØ‰ª•ÈÖçÁΩÆÁöÑ‰∏úË•ø)„ÄÇÈªòËÆ§ÊÉÖÂÜµ‰∏ãÔºå‰ΩøÁî®SimpleAsyncTaskExecutor„ÄÇ 12345678910111213141516171819202122232425262728293031323334353637383940414243import java.util.concurrent.CompletableFuture;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.boot.CommandLineRunner;import org.springframework.stereotype.Component;import com.gitee.taven.entity.User;import com.gitee.taven.service.GitHubLookupService;@Componentpublic class AppRunner implements CommandLineRunner &#123; private static final Logger logger = LoggerFactory.getLogger(AppRunner.class); private final GitHubLookupService gitHubLookupService; public AppRunner(GitHubLookupService gitHubLookupService) &#123; this.gitHubLookupService = gitHubLookupService; &#125; @Override public void run(String... args) throws Exception &#123; // Start the clock long start = System.currentTimeMillis(); // Kick of multiple, asynchronous lookups CompletableFuture&lt;User&gt; page1 = gitHubLookupService.findUser("PivotalSoftware"); CompletableFuture&lt;User&gt; page2 = gitHubLookupService.findUser("CloudFoundry"); CompletableFuture&lt;User&gt; page3 = gitHubLookupService.findUser("Spring-Projects"); // Wait until they are all done CompletableFuture.allOf(page1,page2,page3).join(); // Print results, including elapsed time float exc = (float)(System.currentTimeMillis() - start)/1000; logger.info("Elapsed time: " + exc + " seconds"); logger.info("--&gt; " + page1.get()); logger.info("--&gt; " + page2.get()); logger.info("--&gt; " + page3.get()); &#125; &#125; ÈÄöËøáÂÆûÁé∞ CommandLineRunner Ë∞ÉÁî® service ÊúçÂä°ÔºåÊàë‰ª¨ËÆæÁΩÆ‰∫Ü Thread.sleep(3000L); ËøêË°ådemoÔºå4.73s ÁªìÊùüÊàòÊñóÔºÅ Êú¨Êñádemohttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/spring-async-demo]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Â§öÁ∫øÁ®ã</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Âä®ÊÄÅÂàáÊç¢„ÄÅÊ∑ªÂä†Êï∞ÊçÆÊ∫êÂÆûÁé∞‰ª•ÂèäÊ∫êÁ†ÅÊµÖÊûê]]></title>
    <url>%2Fpost%2F9ffabefe.html</url>
    <content type="text"><![CDATA[ÂÖ¨Âè∏È°πÁõÆÈúÄÊ±ÇÔºåÁî±‰∫éË¶ÅÂÖºÂÆπËÄÅÁ≥ªÁªüÁöÑÊï∞ÊçÆÂ∫ìÁªìÊûÑÔºåÈúÄË¶ÅÊê≠Âª∫‰∏Ä‰∏™ ÂèØ‰ª•Âä®ÊÄÅÂàáÊç¢„ÄÅÊ∑ªÂä†Êï∞ÊçÆÊ∫êÁöÑÂêéÁ´ØÊúçÂä°„ÄÇ ÂàÜÊûêÂèÇËÄÉ‰∫ÜËøáÂéªÁöÑÈ°πÁõÆÔºåÈÄöËøáÈÖçÁΩÆÂ§ö‰∏™SqlSessionFactory Êù•ÂÆûÁé∞Â§öÊï∞ÊçÆÊ∫êÔºåËøô‰πàÂÅöÁöÑËØùÔºåÊú™ÂÖçËøá‰∫éÁ¨®ÈáçÔºåËÄå‰∏îÊó†Ê≥ïÂÆûÁé∞Âä®ÊÄÅÊ∑ªÂä†Êï∞ÊçÆÊ∫êËøô‰∏™ÈúÄÊ±ÇÈÄöËøá spring AbstractRoutingDataSource ‰∏∫Êàë‰ª¨ÊäΩË±°‰∫Ü‰∏Ä‰∏™ DynamicDataSource Ëß£ÂÜ≥Ëøô‰∏ÄÈóÆÈ¢ò Ê∫êÁ†ÅÁÆÄÂçïÂàÜÊûê‰∏ã AbstractRoutingDataSource ÁöÑÊ∫êÁ†Å targetDataSources Â∞±ÊòØÊàë‰ª¨ÁöÑÂ§ö‰∏™Êï∞ÊçÆÊ∫êÔºåÂú®ÂàùÂßãÂåñÁöÑÊó∂ÂÄô‰ºöË∞ÉÁî®afterPropertiesSet()ÔºåÂéªËß£ÊûêÊàë‰ª¨ÁöÑÊï∞ÊçÆÊ∫ê ÁÑ∂Âêé put Âà∞ resolvedDataSources ÂÆûÁé∞‰∫Ü DataSource ÁöÑ getConnection(); Êàë‰ª¨ÁúãÁúã determineTargetDataSource(); ÂÅö‰∫Ü‰ªÄ‰πà ÈÄöËøá‰∏ãÈù¢ÁöÑ determineCurrentLookupKey();ÔºàËøô‰∏™ÊñπÊ≥ïÈúÄË¶ÅÊàë‰ª¨ÂÆûÁé∞Ôºâ ËøîÂõû‰∏Ä‰∏™keyÔºåÁÑ∂Âêé‰ªé resolvedDataSources ÔºàÂÖ∂ÂÆû‰πüÂ∞±ÊòØ targetDataSourcesÔºâ ‰∏≠ get ‰∏Ä‰∏™Êï∞ÊçÆÊ∫êÔºåÂÆûÁé∞‰∫ÜÊØèÊ¨°Ë∞ÉÁî® getConnection(); ÊâìÂºÄËøûÊé• ÂàáÊç¢Êï∞ÊçÆÊ∫êÔºåÂ¶ÇÊûúÊÉ≥Âä®ÊÄÅÊ∑ªÂä†ÁöÑËØù Âè™ÈúÄË¶ÅÈáçÊñ∞ set targetDataSources ÂÜçË∞ÉÁî® afterPropertiesSet() Âç≥ÂèØ Talk is cheap. Show me the codeÊàë‰ΩøÁî®ÁöÑspringbootÁâàÊú¨‰∏∫ 1.5.xÔºå‰∏ãÈù¢ÊòØÊ†∏ÂøÉ‰ª£Á†ÅÂÆåÊï¥‰ª£Á†ÅÔºöhttps://gitee.com/yintianwen7/spring-dynamic-datasource123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778/** * Â§öÊï∞ÊçÆÊ∫êÈÖçÁΩÆ * * @author Taven * */@Configuration@MapperScan("com.gitee.taven.mapper")public class DataSourceConfigurer &#123; /** * DataSource Ëá™Âä®ÈÖçÁΩÆÂπ∂Ê≥®ÂÜå * * @return data source */ @Bean("db0") @Primary @ConfigurationProperties(prefix = "datasource.db0") public DataSource dataSource0() &#123; return DruidDataSourceBuilder.create().build(); &#125; /** * DataSource Ëá™Âä®ÈÖçÁΩÆÂπ∂Ê≥®ÂÜå * * @return data source */ @Bean("db1") @ConfigurationProperties(prefix = "datasource.db1") public DataSource dataSource1() &#123; return DruidDataSourceBuilder.create().build(); &#125; /** * Ê≥®ÂÜåÂä®ÊÄÅÊï∞ÊçÆÊ∫ê * * @return */ @Bean("dynamicDataSource") public DataSource dynamicDataSource() &#123; DynamicRoutingDataSource dynamicRoutingDataSource = new DynamicRoutingDataSource(); Map&lt;Object, Object&gt; dataSourceMap = new HashMap&lt;&gt;(); dataSourceMap.put("dynamic_db0", dataSource0()); dataSourceMap.put("dynamic_db1", dataSource1()); dynamicRoutingDataSource.setDefaultTargetDataSource(dataSource0());// ËÆæÁΩÆÈªòËÆ§Êï∞ÊçÆÊ∫ê dynamicRoutingDataSource.setTargetDataSources(dataSourceMap); return dynamicRoutingDataSource; &#125; /** * Sql session factory bean. * Here to config datasource for SqlSessionFactory * &lt;p&gt; * You need to add @&#123;@code @ConfigurationProperties(prefix = "mybatis")&#125;, if you are using *.xml file, * the &#123;@code 'mybatis.type-aliases-package'&#125; and &#123;@code 'mybatis.mapper-locations'&#125; should be set in * &#123;@code 'application.properties'&#125; file, or there will appear invalid bond statement exception * * @return the sql session factory bean */ @Bean @ConfigurationProperties(prefix = "mybatis") public SqlSessionFactoryBean sqlSessionFactoryBean() &#123; SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean(); // ÂøÖÈ°ªÂ∞ÜÂä®ÊÄÅÊï∞ÊçÆÊ∫êÊ∑ªÂä†Âà∞ sqlSessionFactoryBean sqlSessionFactoryBean.setDataSource(dynamicDataSource()); return sqlSessionFactoryBean; &#125; /** * ‰∫ãÂä°ÁÆ°ÁêÜÂô® * * @return the platform transaction manager */ @Bean public PlatformTransactionManager transactionManager() &#123; return new DataSourceTransactionManager(dynamicDataSource()); &#125;&#125; ÈÄöËøá ThreadLocal Ëé∑ÂèñÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÊï∞ÊçÆÊ∫ê key12345678910111213141516171819202122232425262728293031323334353637package com.gitee.taven.config;public class DynamicDataSourceContextHolder &#123; private static final ThreadLocal&lt;String&gt; contextHolder = new ThreadLocal&lt;String&gt;() &#123; @Override protected String initialValue() &#123; return "dynamic_db0"; &#125; &#125;; /** * To switch DataSource * * @param key the key */ public static void setDataSourceKey(String key) &#123; contextHolder.set(key); &#125; /** * Get current DataSource * * @return data source key */ public static String getDataSourceKey() &#123; return contextHolder.get(); &#125; /** * To set DataSource as default */ public static void clearDataSourceKey() &#123; contextHolder.remove(); &#125;&#125; Âä®ÊÄÅ Ê∑ªÂä†„ÄÅÂàáÊç¢Êï∞ÊçÆÊ∫ê123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081/** * Âä®ÊÄÅÊï∞ÊçÆÊ∫ê * * @author Taven * */public class DynamicRoutingDataSource extends AbstractRoutingDataSource &#123; private final Logger logger = LoggerFactory.getLogger(getClass()); private static Map&lt;Object, Object&gt; targetDataSources = new HashMap&lt;&gt;(); /** * ËÆæÁΩÆÂΩìÂâçÊï∞ÊçÆÊ∫ê * * @return */ @Override protected Object determineCurrentLookupKey() &#123; logger.info("Current DataSource is [&#123;&#125;]", DynamicDataSourceContextHolder.getDataSourceKey()); return DynamicDataSourceContextHolder.getDataSourceKey(); &#125; @Override public void setTargetDataSources(Map&lt;Object, Object&gt; targetDataSources) &#123; super.setTargetDataSources(targetDataSources); DynamicRoutingDataSource.targetDataSources = targetDataSources; &#125; /** * ÊòØÂê¶Â≠òÂú®ÂΩìÂâçkeyÁöÑ DataSource * * @param key * @return Â≠òÂú®ËøîÂõû true, ‰∏çÂ≠òÂú®ËøîÂõû false */ public static boolean isExistDataSource(String key) &#123; return targetDataSources.containsKey(key); &#125; /** * Âä®ÊÄÅÂ¢ûÂä†Êï∞ÊçÆÊ∫ê * * @param map Êï∞ÊçÆÊ∫êÂ±ûÊÄß * @return */ public synchronized boolean addDataSource(Map&lt;String, String&gt; map) &#123; try &#123; Connection connection = null; // ÊéíÈô§ËøûÊé•‰∏ç‰∏äÁöÑÈîôËØØ try &#123; Class.forName(map.get(DruidDataSourceFactory.PROP_DRIVERCLASSNAME)); connection = DriverManager.getConnection( map.get(DruidDataSourceFactory.PROP_URL), map.get(DruidDataSourceFactory.PROP_USERNAME), map.get(DruidDataSourceFactory.PROP_PASSWORD)); System.out.println(connection.isClosed()); &#125; catch (Exception e) &#123; return false; &#125; finally &#123; if (connection != null &amp;&amp; !connection.isClosed()) connection.close(); &#125; String database = map.get("database");//Ëé∑ÂèñË¶ÅÊ∑ªÂä†ÁöÑÊï∞ÊçÆÂ∫ìÂêç if (StringUtils.isBlank(database)) return false; if (DynamicRoutingDataSource.isExistDataSource(database)) return true; DruidDataSource druidDataSource = (DruidDataSource) DruidDataSourceFactory.createDataSource(map); druidDataSource.init(); Map&lt;Object, Object&gt; targetMap = DynamicRoutingDataSource.targetDataSources; targetMap.put(database, druidDataSource); // ÂΩìÂâç targetDataSources ‰∏é Áà∂Á±ª targetDataSources ‰∏∫Âêå‰∏ÄÂØπË±° ÊâÄ‰ª•‰∏çÈúÄË¶Åset// this.setTargetDataSources(targetMap); this.afterPropertiesSet(); logger.info("dataSource &#123;&#125; has been added", database); &#125; catch (Exception e) &#123; logger.error(e.getMessage()); return false; &#125; return true; &#125; &#125; ÂèØ‰ª•ÈÄöËøá AOP ÊàñËÄÖ ÊâãÂä® DynamicDataSourceContextHolder.setDataSourceKey(String key) ÂàáÊç¢Êï∞ÊçÆÊ∫ê ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÔºöÂΩìÊàë‰ª¨ÂºÄÂêØ‰∫Ü‰∫ãÂä°‰πãÂêéÔºåÊòØÊó†Ê≥ïÂú®ÂéªÂàáÊç¢Êï∞ÊçÆÊ∫êÁöÑ Êú¨ÊñáÈ°πÁõÆÊ∫êÁ†ÅÔºöhttps://gitee.com/yintianwen7/spring-dynamic-datasourceÂèÇËÄÉÊñáÁåÆÔºöhttps://github.com/helloworlde/SpringBoot-DynamicDataSource]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>Â§öÊï∞ÊçÆÊ∫ê</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Service Ë∞ÉÁî®ÂΩìÂâçÁ±ªÊñπÊ≥ï‰∫ãÂä°‰∏çÁîüÊïà]]></title>
    <url>%2Fpost%2Ff2e584e4.html</url>
    <content type="text"><![CDATA[‰ªäÂ§©Âú®ÊµãËØïÊ°ÜÊû∂ÁöÑÊó∂ÂÄôÔºåÊàëÊÉ≥Âú®‰∏Ä‰∏™serviceÁ±ªÁöÑÊñπÊ≥ï‰∏≠Ë∞ÉÁî® ÂΩìÂâçÁ±ªÁöÑÂè¶‰∏Ä‰∏™ÊñπÊ≥ïÔºàËØ•ÊñπÊ≥ïÈÄöËøá@TransactionalÂºÄÂêØ‰∫ãÂä°ÔºâÔºåËøôÊó∂ÂÄôÂèëÁé∞Ë¢´Ë∞ÉÁî®Á±ªÁöÑ‰∫ãÂä°Âπ∂Ê≤°ÊúâÁîüÊïà„ÄÇ 1234567891011public boolean test1() &#123; // xxx ‰∏öÂä°ÈÄªËæë return test2();&#125;@Transactionalpublic boolean test2() &#123; testMapper.insertSalary(&quot;test&quot;, UUID.randomUUID().toString()); int a = 10/0; return true;&#125; WHY? ÊêúÁ¥¢ÂºïÊìé‰∏ÄÁï™Êü•ËØ¢‰πãÂêéÔºå‰∫ÜËß£Âà∞ÈóÆÈ¢òÁöÑÂÖ≥ÈîÆÔºö@Transactional ÊòØÂü∫‰∫éaopÁîüÁöÑ‰ª£ÁêÜÂØπË±°ÂºÄÂêØ‰∫ãÂä°ÁöÑPS:‰∏ç‰∫ÜËß£‰ª£ÁêÜÊ®°ÂºèÁöÑÂ∞è‰ºô‰º¥ÔºåÁªìÂ∞æÊúâ‰º†ÈÄÅÈó® ÊÄùË∑Ø spring ÁöÑ‰∫ãÂä°ÊòØÈÄöËøá aop ÁÆ°ÁêÜÁöÑ aop ‰ºöÈÄöËøáÂä®ÊÄÅ‰ª£ÁêÜ ‰∏∫Êàë‰ª¨ÁîüÊàê‰ª£ÁêÜÂØπË±°Ôºåaop ÁöÑÂäüËÉΩÔºà‰æãÂ¶Ç‰∫ãÂä°ÔºâÈÉΩÊòØÂú®‰ª£ÁêÜÂØπË±°‰∏≠ÂÆûÁé∞ÁöÑ aop ÁîüÊàêÁöÑ‰ª£ÁêÜÁ±ªÂèàÂú® spring ÂÆπÂô®‰∏≠ÔºåÊâÄ‰ª•Êàë‰ª¨Âè™Ë¶ÅÂú® spring ÂÆπÂô®‰∏≠ÊãøÂà∞ÂΩìÂâçËøô‰∏™bean ÂÜçÂéªË∞ÉÁî® test2() Â∞±ÂèØ‰ª•ÂºÄÂêØ‰∫ãÂä°‰∫Ü„ÄÇ Ëß£ÂÜ≥123456789101112131415161718192021222324252627282930313233343536373839404142import org.springframework.beans.BeansException;import org.springframework.context.ApplicationContext;import org.springframework.context.ApplicationContextAware;import org.springframework.stereotype.Component;/** * SpringÁöÑApplicationContextÁöÑÊåÅÊúâËÄÖ,ÂèØ‰ª•Áî®ÈùôÊÄÅÊñπÊ≥ïÁöÑÊñπÂºèËé∑ÂèñspringÂÆπÂô®‰∏≠ÁöÑbean * */@Componentpublic class SpringContextHolder implements ApplicationContextAware &#123; private static ApplicationContext applicationContext; @Override public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123; SpringContextHolder.applicationContext = applicationContext; &#125; public static ApplicationContext getApplicationContext() &#123; assertApplicationContext(); return applicationContext; &#125; @SuppressWarnings("unchecked") public static &lt;T&gt; T getBean(String beanName) &#123; assertApplicationContext(); return (T) applicationContext.getBean(beanName); &#125; public static &lt;T&gt; T getBean(Class&lt;T&gt; requiredType) &#123; assertApplicationContext(); return applicationContext.getBean(requiredType); &#125; private static void assertApplicationContext() &#123; if (SpringContextHolder.applicationContext == null) &#123; throw new RuntimeException("applicaitonContextÂ±ûÊÄß‰∏∫null,ËØ∑Ê£ÄÊü•ÊòØÂê¶Ê≥®ÂÖ•‰∫ÜSpringContextHolder!"); &#125; &#125;&#125; 123456789101112public boolean test1() &#123; // xxx ‰∏öÂä°ÈÄªËæë // Âú®springÂÆπÂô®‰∏≠ Ëé∑ÂèñÂΩìÂâçÁ±ªÁöÑ‰ª£ÁêÜÁ±ª return SpringContextHolder.getBean(TestS.class).test2();&#125;@Transactionalpublic boolean test2() &#123; testMapper.insertSalary(&quot;test&quot;, UUID.randomUUID().toString()); int a = 10/0; return true;&#125; okÔºÅÊêûÂÆöÔºÅ ‰º†ÈÄÅÈó®Spring AOPÁöÑÂÆûÁé∞ÂéüÁêÜJava ‰ª£ÁêÜÊ®°Âºè]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>AOP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[(ËΩ¨)Java ‰ª£ÁêÜÊ®°Âºè]]></title>
    <url>%2Fpost%2F4dd31fbe.html</url>
    <content type="text"><![CDATA[ÂéüÊñáÔºöhttps://www.cnblogs.com/cenyu/p/6289209.html ‰ª£ÁêÜ(Proxy)ÊòØ‰∏ÄÁßçËÆæËÆ°Ê®°ÂºèÔºåÈÄöËøá‰ª£ÁêÜÂØπË±°ËÆøÈóÆÁõÆÊ†áÂØπË±°.ËøôÊ†∑ÂÅöÁöÑÂ•ΩÂ§ÑÊòØ:ÂèØ‰ª•Âú®ÁõÆÊ†áÂØπË±°ÂÆûÁé∞ÁöÑÂü∫Á°Ä‰∏äÔºåÊâ©Â±ïÁõÆÊ†áÂØπË±°ÁöÑÂäüËÉΩ„ÄÇ ‰∏æ‰∏™‰æãÂ≠êÊù•ËØ¥ÊòéÔºöÂÅáÂ¶ÇËØ¥ÊàëÁé∞Âú®ÊÉ≥‰π∞‰∏ÄËæÜ‰∫åÊâãËΩ¶ÔºåÊúÄ‰æøÊç∑ÁöÑÊñπÊ≥ï‰∏ÄÂÆöÊòØÊàëÂéªÊâæ‰∏≠‰ªãÔºå‰ªñ‰ª¨Êù•ÁªôÊàëÂÅöÁêêÁ¢éÁöÑ‰∫ãÊÉÖÔºåÊàëÂè™ÊòØË¥üË¥£ÈÄâÊã©Ëá™Â∑±ÂñúÊ¨¢ÁöÑËΩ¶ÔºåÁÑ∂Âêé‰ªòÈí±Â∞±ÂèØ‰ª•‰∫Ü„ÄÇ ‰ª£ÁêÜÂØπË±°ÊòØÂØπÁõÆÊ†áÂØπË±°ÁöÑÊâ©Â±ï,Âπ∂‰ºöË∞ÉÁî®ÁõÆÊ†áÂØπË±° ÈùôÊÄÅ‰ª£ÁêÜ12345public interface IUserDao &#123; void save(); &#125; 12345678public class UserDao implements IUserDao &#123; @Override public void save() &#123; System.out.println(&quot;----Â∑≤Áªè‰øùÂ≠òÊï∞ÊçÆ!----&quot;); &#125;&#125; 12345678910111213141516public class UserDaoProxy implements IUserDao &#123; //ÁõÆÊ†áÂØπË±° private IUserDao target; public UserDaoProxy(IUserDao target)&#123; this.target=target; &#125; @Override public void save() &#123; System.out.println(&quot;ÂºÄÂßã‰∫ãÂä°...&quot;); target.save();//ÊâßË°åÁõÆÊ†áÂØπË±°ÁöÑÊñπÊ≥ï System.out.println(&quot;Êèê‰∫§‰∫ãÂä°...&quot;); &#125;&#125; 12345678@Testpublic void staticProxy() &#123; //ÁõÆÊ†áÂØπË±° UserDao target = new UserDao(); //‰ª£ÁêÜÂØπË±°ÔºåÂª∫Á´ã‰ª£ÁêÜÂÖ≥Á≥ª UserDaoProxy proxy = new UserDaoProxy(target); proxy.save();//ÊâßË°åÁöÑÊòØ‰ª£ÁêÜÁöÑÊñπÊ≥ï&#125; ÈùôÊÄÅ‰ª£ÁêÜÁöÑÁº∫ÁÇπÔºöÊé•Âè£Êñ∞Â¢ûÊñπÊ≥ïÊó∂ÔºåÁ±ªËøáÂ§öÊó∂ÔºåÈúÄË¶ÅÊâãÂä®Áª¥Êä§ÔºåËøá‰∫éÁπÅÁêêÔºå‰ΩÜÊòØÈÄöËøáÂä®ÊÄÅ‰ª£ÁêÜÊú∫Âà∂ÂèØ‰ª•Ëß£ÂÜ≥Ëøô‰∏ÄÈóÆÈ¢ò„ÄÇ Âä®ÊÄÅ‰ª£ÁêÜspring ‰∏≠ AOP ÈÄöËøá Âä®ÊÄÅ‰ª£ÁêÜ Âú®ËøêË°åÊó∂‰∏∫Êàë‰ª¨ÁöÑ‰ª£Á†ÅÂ¢ûÂº∫Ôºå‰æãÂ¶ÇÊàë‰ª¨Âú®ÂºÄÂèëÁöÑÊó∂ÂÄôÂè™ÈúÄË¶ÅÂÅö‰∏öÂä°ÈÄªËæëÔºåAOP ÈÄöËøáÂä®ÊÄÅ‰ª£ÁêÜÂèØ‰ª•‰∏∫Êàë‰ª¨ÂÅö‰∫ãÂä°ÔºåÊó•ÂøóÁÆ°ÁêÜÔºåÊùÉÈôêÊ†°È™åÁ≠âÁ≠â„ÄÇ jdk Âä®ÊÄÅ‰ª£ÁêÜÊàë‰ª¨‰∏çÈúÄË¶ÅÂÜçÂéªÊâãÂä®ÂàõÂª∫‰ª£ÁêÜÁ±ªÔºà‰ΩÜÊòØË¶ÅÊ±ÇË¢´‰ª£ÁêÜÁ±ªÂøÖÈ°ªÂÆûÁé∞‰∏Ä‰∏™Êé•Âè£ÔºâÔºåÂè™ÈúÄË¶ÅÂÅö‰∏Ä‰∏™Âä®ÊÄÅ‰ª£ÁêÜÂ∑•ÂéÇÂç≥ÂèØÔºåjdkÈÄöËøáÂèçÂ∞Ñ‰∏∫Êàë‰ª¨Âú®ÂÜÖÂ≠ò‰∏≠Âä®ÊÄÅÂàõÂª∫‰ª£ÁêÜÂØπË±°Ôºå‰ª•ÂèäÂú®ÊñπÊ≥ïÊâßË°åÁöÑÂâçÂêéÊ∑ªÂä†ÈÄöÁü•„ÄÇ1234567891011121314151617181920212223242526272829303132333435import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;/** * ÂàõÂª∫Âä®ÊÄÅ‰ª£ÁêÜÂØπË±° * */public class JdkProxyFactory&#123; //Áª¥Êä§‰∏Ä‰∏™ÁõÆÊ†áÂØπË±° private Object target; public JdkProxyFactory(Object target)&#123; this.target=target; &#125; //ÁªôÁõÆÊ†áÂØπË±°ÁîüÊàê‰ª£ÁêÜÂØπË±° public Object getProxyInstance()&#123; return Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), new InvocationHandler() &#123; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; System.out.println("ÂºÄÂßã‰∫ãÂä°2"); //ÊâßË°åÁõÆÊ†áÂØπË±°ÊñπÊ≥ï Object returnValue = method.invoke(target, args); System.out.println("Êèê‰∫§‰∫ãÂä°2"); return returnValue; &#125; &#125; ); &#125;&#125; 123456789101112131415@Testpublic void jdkProxy() &#123; // ÁõÆÊ†áÂØπË±° IUserDao target = new UserDao(); // ÂéüÂßãÁ±ªÂûã System.out.println(&quot;ÂéüÂßãÁ±ªÂûã&quot; + target.getClass()); // ÁªôÁõÆÊ†áÂØπË±°ÔºåÂàõÂª∫‰ª£ÁêÜÂØπË±° IUserDao proxy = (IUserDao) new JdkProxyFactory(target).getProxyInstance(); // class $Proxy0 ÂÜÖÂ≠ò‰∏≠Âä®ÊÄÅÁîüÊàêÁöÑ‰ª£ÁêÜÂØπË±° System.out.println(&quot;Âä®ÊÄÅ‰ª£ÁêÜÂêéÂØπË±°Á±ªÂûã:&quot; + proxy.getClass()); // ‰ª£ÁêÜÂØπË±° ÊâßË°åÊñπÊ≥ï proxy.save();&#125; ÊâßË°åÊµãËØïÊñπÊ≥ï12345ÂéüÂßãÁ±ªÂûãclass com.example.demo.original_code.UserDaoÂä®ÊÄÅ‰ª£ÁêÜÂêéÂØπË±°Á±ªÂûã:class com.sun.proxy.$Proxy4ÂºÄÂßã‰∫ãÂä°2----Â∑≤Áªè‰øùÂ≠òÊï∞ÊçÆ!----Êèê‰∫§‰∫ãÂä°2 cglib Âä®ÊÄÅ‰ª£ÁêÜÈùôÊÄÅ‰ª£ÁêÜ Âíå jdk‰ª£ÁêÜ Ë¶ÅÊ±ÇÁõÆÊ†áÂØπË±°ÂøÖÈ°ªÂÆûÁé∞Êé•Âè£ÔºåËÄå cglib Âä®ÊÄÅ‰ª£ÁêÜÊó†ÈúÄÂÆûÁé∞Êé•Âè£„ÄÇcglib ‰ºöÂä®ÊÄÅ‰∏∫ÁõÆÊ†áÂØπË±° ÂàõÂª∫‰∏Ä‰∏™Â≠êÁ±ªÂØπË±°„ÄÇ‰ΩøÁî®È°ªÁü•Ôºö1.Ë¢´‰ª£ÁêÜÁöÑÁ±ª‰∏çËÉΩ‰∏∫ final2.Ë¢´‰ª£ÁêÜÁ±ªÁöÑÊñπÊ≥ï ‰∏çËÉΩ‰∏∫ final/staticÔºåÂê¶ÂàôÊó†Ê≥ïË¢´Êã¶Êà™12345678910111213141516171819202122232425262728293031323334353637383940414243import java.lang.reflect.Method;import org.springframework.cglib.proxy.Enhancer;import org.springframework.cglib.proxy.MethodInterceptor;import org.springframework.cglib.proxy.MethodProxy;/** * CglibÂ≠êÁ±ª‰ª£ÁêÜÂ∑•ÂéÇ * ÂØπUserDaoÂú®ÂÜÖÂ≠ò‰∏≠Âä®ÊÄÅÊûÑÂª∫‰∏Ä‰∏™Â≠êÁ±ªÂØπË±° */public class CglibProxyFactory implements MethodInterceptor &#123; //Áª¥Êä§ÁõÆÊ†áÂØπË±° private Object target; public CglibProxyFactory(Object target) &#123; this.target = target; &#125; //ÁªôÁõÆÊ†áÂØπË±°ÂàõÂª∫‰∏Ä‰∏™‰ª£ÁêÜÂØπË±° public Object getProxyInstance()&#123; //1.Â∑•ÂÖ∑Á±ª Enhancer en = new Enhancer(); //2.ËÆæÁΩÆÁà∂Á±ª en.setSuperclass(target.getClass()); //3.ËÆæÁΩÆÂõûË∞ÉÂáΩÊï∞ en.setCallback(this); //4.ÂàõÂª∫Â≠êÁ±ª(‰ª£ÁêÜÂØπË±°) return en.create(); &#125; @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable &#123; System.out.println("ÂºÄÂßã‰∫ãÂä°..."); //ÊâßË°åÁõÆÊ†áÂØπË±°ÁöÑÊñπÊ≥ï Object returnValue = method.invoke(target, args); System.out.println("Êèê‰∫§‰∫ãÂä°..."); return returnValue; &#125;&#125; 1234567891011@Testpublic void cglibProxy() &#123; //ÁõÆÊ†áÂØπË±° UserDao target = new UserDao(); //‰ª£ÁêÜÂØπË±° UserDao proxy = (UserDao) new CglibProxyFactory(target).getProxyInstance(); //ÊâßË°å‰ª£ÁêÜÂØπË±°ÁöÑÊñπÊ≥ï proxy.save();&#125;]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>ËÆæËÆ°Ê®°Âºè</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-Êü•ËØ¢Ê†ëÁªìÊûÑ]]></title>
    <url>%2Fpost%2Fa998078e.html</url>
    <content type="text"><![CDATA[Âú® oracle Êï∞ÊçÆÂ∫ì‰∏≠ÔºåÈÄöËøá start with connect by prior ÈÄíÂΩíÂèØ‰ª•Áõ¥Êé•Êü•Âá∫Ê†ëÁªìÊûÑÔºå‰ΩÜÊòØÂú® mysql ÂΩì‰∏≠Â¶Ç‰ΩïËß£ÂÜ≥Ê†ëÊü•ËØ¢ÈóÆÈ¢òÂë¢Ôºü #####ÊÄùË∑ØÔºöÊàë‰ª¨ÂèØ‰ª•ÈÄöËøáËá™ÂÆö‰πâÂáΩÊï∞ÔºåÈÅçÂéÜÊâæÂá∫Êüê‰∏ÄËäÇÁÇπÁöÑÊâÄÊúâÂ≠êËäÇÁÇπ ÔºàÊàñËÄÖÊüê‰∏ÄËäÇÁÇπÁöÑÊâÄÊúâÁà∂ËäÇÁÇπÔºâÁöÑÂ≠óÁ¨¶‰∏≤ÈõÜÂêà„ÄÇÁÑ∂ÂêéÈÄöËøá FIND_IN_SET ÂáΩÊï∞ÔºåËøôÂ∞±Êü•Âá∫‰∫ÜÊàë‰ª¨ÊÉ≥Ë¶ÅÁöÑÊ†ë #####ÂÆûË∑µÔºö1ÔºâÂª∫Ë°® ‰ª•Âèä ÊµãËØïÊï∞ÊçÆÂáÜÂ§á123456CREATE TABLE `tree` ( `id` int(11) NOT NULL, `pid` int(11) DEFAULT NULL, `name` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8; 12345678INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;1&apos;, NULL, &apos;‰∏ÄÁ∫ß&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;2&apos;, &apos;1&apos;, &apos;‰∫åÁ∫ß1&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;3&apos;, &apos;2&apos;, &apos;‰∏âÁ∫ß1&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;4&apos;, &apos;3&apos;, &apos;ÂõõÁ∫ß1&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;5&apos;, &apos;4&apos;, &apos;‰∫îÁ∫ß&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;6&apos;, &apos;1&apos;, &apos;‰∏âÁ∫ß2&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;7&apos;, &apos;1&apos;, &apos;‰∫åÁ∫ß2&apos;);INSERT INTO `wabc`.`tree` (`id`, `pid`, `name`) VALUES (&apos;8&apos;, &apos;6&apos;, &apos;ÂõõÁ∫ß2&apos;); 2ÔºâÊü•ËØ¢ ÊüêËäÇÁÇπ‰∏ãÊâÄÊúâÂ≠êËäÇÁÇπ12345678910111213CREATE FUNCTION `GET_CHILD_NODE`(rootId varchar(100)) RETURNS varchar(2000) BEGIN DECLARE str varchar(2000); DECLARE cid varchar(100); SET str = &apos;$&apos;; SET cid = rootId; WHILE cid is not null DO SET str = concat(str, &apos;,&apos;, cid); SELECT group_concat(id) INTO cid FROM tree where FIND_IN_SET(pid, cid); END WHILE; RETURN str; END Á¨¨‰∏ÄÊ¨°ËøõÂÖ•ÂáΩÊï∞ cid ‰∏∫Ê†πËäÇÁÇπÔºåÂºÄÂßãÂæ™ÁéØÂêéÔºåcid ‰∏∫ÊØèÊ¨°Êü•ËØ¢ÁªìÊûúÈõÜ Ôºà‰πüÂ∞±ÊòØÂ≠êËäÇÁÇπÔºâÔºå‰∏ã‰∏ÄÊ¨°‰ºöÊü•ËØ¢Âá∫ÊâÄÊúâÂ≠êËäÇÁÇπÁöÑÂ≠êËäÇÁÇπ ‚Ä¶ ‰ª•Ê≠§Á±ªÊé®ÔºåÂΩìÊ≤°ÊúâÂ≠êËäÇÁÇπÊó∂ÈÄÄÂá∫Âæ™ÁéØÔºå‰πüÂ∞±ÂæóÂà∞‰∫ÜÊâÄÊúâÁöÑËäÇÁÇπ„ÄÇ12345678910mysql&gt; SELECT * from tree where FIND_IN_SET(id, GET_CHILD_NODE(2));+----+-----+-------+| id | pid | name |+----+-----+-------+| 2 | 1 | ‰∫åÁ∫ß1 || 3 | 2 | ‰∏âÁ∫ß1 || 4 | 3 | ÂõõÁ∫ß1 || 5 | 4 | ‰∫îÁ∫ß |+----+-----+-------+4 rows in set ÂÜçÈÄöËøáËøô‰∫õËäÇÁÇπ Á≠õÈÄâÔºåok ! 3ÔºâÊü•ËØ¢ ÊüêËäÇÁÇπÁöÑÊâÄÊúâÁà∂ËäÇÁÇπ1234567891011121314151617CREATE FUNCTION `GET_PARENT_NODE`(rootId varchar(100)) RETURNS varchar(1000) BEGIN DECLARE fid varchar(100) default &apos;&apos;; DECLARE str varchar(1000) default rootId; WHILE rootId is not null do SET fid =(SELECT pid FROM tree WHERE id = rootId); IF fid is not null THEN SET str = concat(str, &apos;,&apos;, fid); SET rootId = fid; ELSE SET rootId = fid; END IF; END WHILE; return str; END Âíå‰∏ä‰∏Ä‰∏™ÂáΩÊï∞Á±ª‰ººÔºå‰∏çÊñ≠ÁöÑÈÅçÂéÜÂéªÊâæ Áà∂idÔºåÁÑ∂ÂêéÊãºÊé•Âà∞Â≠óÁ¨¶‰∏≤‰∏≠Ôºå‰∏∫Á©∫ÈÄÄÂá∫Âæ™ÁéØ„ÄÇ1234567891011mysql&gt; select * from tree where FIND_IN_SET(id, GET_PARENT_NODE(5));+----+------+-------+| id | pid | name |+----+------+-------+| 1 | NULL | ‰∏ÄÁ∫ß || 2 | 1 | ‰∫åÁ∫ß1 || 3 | 2 | ‰∏âÁ∫ß1 || 4 | 3 | ÂõõÁ∫ß1 || 5 | 4 | ‰∫îÁ∫ß |+----+------+-------+5 rows in set]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Ê∑±ÂÖ•ÁêÜËß£ Dijkstra ÁÆóÊ≥ïÂÆûÁé∞ÂéüÁêÜ]]></title>
    <url>%2Fpost%2F9186820e.html</url>
    <content type="text"><![CDATA[Ëø™Êù∞ÊñØÁâπÊãâ(Dijkstra)ÁÆóÊ≥ïÊòØÂÖ∏ÂûãÊúÄÁü≠Ë∑ØÂæÑÁÆóÊ≥ïÔºåÁî®‰∫éËÆ°ÁÆó‰∏Ä‰∏™ËäÇÁÇπÂà∞ÂÖ∂‰ªñËäÇÁÇπÁöÑÊúÄÁü≠Ë∑ØÂæÑ„ÄÇÂÆÉÁöÑ‰∏ªË¶ÅÁâπÁÇπÊòØ‰ª•Ëµ∑ÂßãÁÇπ‰∏∫‰∏≠ÂøÉÂêëÂ§ñÂ±ÇÂ±ÇÊâ©Â±ï(ÂπøÂ∫¶‰ºòÂÖàÊêúÁ¥¢ÊÄùÊÉ≥)ÔºåÁõ¥Âà∞Êâ©Â±ïÂà∞ÁªàÁÇπ‰∏∫Ê≠¢„ÄÇ ÔºàÂóØÔºåÁ¨¨‰∏ÄÊÆµÊòØÊäÑÁöÑÔºåÁî±‰∫éÊú¨‰∫∫ÁÆóÊ≥ïÁöÑÂü∫Á°ÄÊØîËæÉËñÑÂº±ÔºåÊàë‰ºöÂ∞ΩÈáèÁî®ÈÄö‰øóÊòìÊáÇÁöÑËØ≠Ë®ÄÊù•ËÆ©Â§ßÂÆ∂ÁêÜËß£Êú¨ÊñáÔºâ ÂèÇËÄÉÂçöÂÆ¢:Êï∞ÊçÆÁªìÊûÑ‚ÄìDijkstraÁÆóÊ≥ïÊúÄÊ∏ÖÊ•öÁöÑËÆ≤Ëß£ Â§ßÊ¶ÇÂ∞±ÊòØËøôÊ†∑‰∏Ä‰∏™ÊúâÊùÉÂõæÔºåDijkstraÁÆóÊ≥ïÂèØ‰ª•ËÆ°ÁÆó‰ªªÊÑèËäÇÁÇπÂà∞ÂÖ∂‰ªñËäÇÁÇπÁöÑÊúÄÁü≠Ë∑ØÂæÑ ÁÆóÊ≥ïÊÄùË∑Ø ÊåáÂÆö‰∏Ä‰∏™ËäÇÁÇπÔºå‰æãÂ¶ÇÊàë‰ª¨Ë¶ÅËÆ°ÁÆó ‚ÄòA‚Äô Âà∞ÂÖ∂‰ªñËäÇÁÇπÁöÑÊúÄÁü≠Ë∑ØÂæÑ ÂºïÂÖ•‰∏§‰∏™ÈõÜÂêàÔºàS„ÄÅUÔºâÔºåSÈõÜÂêàÂåÖÂê´Â∑≤Ê±ÇÂá∫ÁöÑÊúÄÁü≠Ë∑ØÂæÑÁöÑÁÇπÔºà‰ª•ÂèäÁõ∏Â∫îÁöÑÊúÄÁü≠ÈïøÂ∫¶ÔºâÔºåUÈõÜÂêàÂåÖÂê´Êú™Ê±ÇÂá∫ÊúÄÁü≠Ë∑ØÂæÑÁöÑÁÇπÔºà‰ª•ÂèäAÂà∞ËØ•ÁÇπÁöÑË∑ØÂæÑÔºåÊ≥®ÊÑè Â¶Ç‰∏äÂõæÊâÄÁ§∫ÔºåA-&gt;CÁî±‰∫éÊ≤°ÊúâÁõ¥Êé•Áõ∏Ëøû ÂàùÂßãÊó∂‰∏∫‚àûÔºâ ÂàùÂßãÂåñ‰∏§‰∏™ÈõÜÂêàÔºåSÈõÜÂêàÂàùÂßãÊó∂ Âè™ÊúâÂΩìÂâçË¶ÅËÆ°ÁÆóÁöÑËäÇÁÇπÔºåA-&gt;A = 0ÔºåUÈõÜÂêàÂàùÂßãÊó∂‰∏∫ A-&gt;B = 4, A-&gt;C = ‚àû, A-&gt;D = 2, A-&gt;E = ‚àûÔºåÊï≤ÈªëÊùøÔºÅÔºÅÔºÅÊé•‰∏ãÊù•Ë¶ÅËøõË°åÊ†∏ÂøÉ‰∏§Ê≠•È™§‰∫Ü ‰ªéUÈõÜÂêà‰∏≠ÊâæÂá∫Ë∑ØÂæÑÊúÄÁü≠ÁöÑÁÇπÔºåÂä†ÂÖ•SÈõÜÂêàÔºå‰æãÂ¶Ç A-&gt;D = 2 Êõ¥Êñ∞UÈõÜÂêàË∑ØÂæÑÔºåif ( &#39;D Âà∞ B,C,E ÁöÑË∑ùÁ¶ª&#39; + &#39;AD Ë∑ùÁ¶ª&#39; &lt; &#39;A Âà∞ B,C,E ÁöÑË∑ùÁ¶ª&#39; ) ÂàôÊõ¥Êñ∞U Âæ™ÁéØÊâßË°å 4„ÄÅ5 ‰∏§Ê≠•È™§ÔºåÁõ¥Ëá≥ÈÅçÂéÜÁªìÊùüÔºåÂæóÂà∞A Âà∞ÂÖ∂‰ªñËäÇÁÇπÁöÑÊúÄÁü≠Ë∑ØÂæÑÁÆóÊ≥ïÂõæËß£1.ÈÄâÂÆöAËäÇÁÇπÂπ∂ÂàùÂßãÂåñÔºåÂ¶Ç‰∏äËø∞Ê≠•È™§3ÊâÄÁ§∫ 2.ÊâßË°å‰∏äËø∞ 4„ÄÅ5‰∏§Ê≠•È™§ÔºåÊâæÂá∫UÈõÜÂêà‰∏≠Ë∑ØÂæÑÊúÄÁü≠ÁöÑËäÇÁÇπD Âä†ÂÖ•SÈõÜÂêàÔºåÂπ∂Ê†πÊçÆÊù°‰ª∂ if ( &#39;D Âà∞ B,C,E ÁöÑË∑ùÁ¶ª&#39; + &#39;AD Ë∑ùÁ¶ª&#39; &lt; &#39;A Âà∞ B,C,E ÁöÑË∑ùÁ¶ª&#39; ) Êù•Êõ¥Êñ∞UÈõÜÂêà 3.ËøôÊó∂ÂÄô A-&gt;B, A-&gt;C ÈÉΩ‰∏∫3ÔºåÊ≤°ÂÖ≥Á≥ª„ÄÇÂÖ∂ÂÆûËøôÊó∂ÂÄô‰ªñ‰ø©ÈÉΩÊòØÊúÄÁü≠Ë∑ùÁ¶ªÔºåÂ¶ÇÊûú‰ªéÁÆóÊ≥ïÈÄªËæëÊù•ËÆ≤ÁöÑËØùÔºå‰ºöÂÖàÂèñÂà∞BÁÇπ„ÄÇËÄåËøô‰∏™Êó∂ÂÄô if Êù°‰ª∂ÂèòÊàê‰∫Ü if ( &#39;B Âà∞ C,E ÁöÑË∑ùÁ¶ª&#39; + &#39;AB Ë∑ùÁ¶ª&#39; &lt; &#39;A Âà∞ C,E ÁöÑË∑ùÁ¶ª&#39; ) ÔºåÂ¶ÇÂõæÊâÄÁ§∫ËøôÊó∂ÂÄôA-&gt;BË∑ùÁ¶ª ÂÖ∂ÂÆû‰∏∫ A-&gt;D-&gt;B ÊÄùË∑ØÂ∞±ÊòØËøôÊ†∑ÔºåÂæÄÂêéÂ∞±ÊòØÂ§ßÂêåÂ∞èÂºÇ‰∫Ü ÁÆóÊ≥ïÁªìÊùü ‰ª£Á†ÅÂÆûÁé∞1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public class Dijkstra &#123; public static final int M = 10000; // ‰ª£Ë°®Ê≠£Êó†Á©∑ public static void main(String[] args) &#123; // ‰∫åÁª¥Êï∞ÁªÑÊØè‰∏ÄË°åÂàÜÂà´ÊòØ A„ÄÅB„ÄÅC„ÄÅD„ÄÅE ÂêÑÁÇπÂà∞ÂÖ∂‰ΩôÁÇπÁöÑË∑ùÁ¶ª, // A -&gt; A Ë∑ùÁ¶ª‰∏∫0, Â∏∏ÈáèM ‰∏∫Ê≠£Êó†Á©∑ int[][] weight1 = &#123; &#123;0,4,M,2,M&#125;, &#123;4,0,4,1,M&#125;, &#123;M,4,0,1,3&#125;, &#123;2,1,1,0,7&#125;, &#123;M,M,3,7,0&#125; &#125;; int start = 0; int[] shortPath = dijkstra(weight1, start); for (int i = 0; i &lt; shortPath.length; i++) System.out.println(&quot;‰ªé&quot; + start + &quot;Âá∫ÂèëÂà∞&quot; + i + &quot;ÁöÑÊúÄÁü≠Ë∑ùÁ¶ª‰∏∫Ôºö&quot; + shortPath[i]); &#125; public static int[] dijkstra(int[][] weight, int start) &#123; // Êé•Âèó‰∏Ä‰∏™ÊúâÂêëÂõæÁöÑÊùÉÈáçÁü©ÈòµÔºåÂíå‰∏Ä‰∏™Ëµ∑ÁÇπÁºñÂè∑startÔºà‰ªé0ÁºñÂè∑ÔºåÈ°∂ÁÇπÂ≠òÂú®Êï∞ÁªÑ‰∏≠Ôºâ // ËøîÂõû‰∏Ä‰∏™int[] Êï∞ÁªÑÔºåË°®Á§∫‰ªéstartÂà∞ÂÆÉÁöÑÊúÄÁü≠Ë∑ØÂæÑÈïøÂ∫¶ int n = weight.length; // È°∂ÁÇπ‰∏™Êï∞ int[] shortPath = new int[n]; // ‰øùÂ≠òstartÂà∞ÂÖ∂‰ªñÂêÑÁÇπÁöÑÊúÄÁü≠Ë∑ØÂæÑ String[] path = new String[n]; // ‰øùÂ≠òstartÂà∞ÂÖ∂‰ªñÂêÑÁÇπÊúÄÁü≠Ë∑ØÂæÑÁöÑÂ≠óÁ¨¶‰∏≤Ë°®Á§∫ for (int i = 0; i &lt; n; i++) path[i] = new String(start + &quot;--&gt;&quot; + i); int[] visited = new int[n]; // Ê†áËÆ∞ÂΩìÂâçËØ•È°∂ÁÇπÁöÑÊúÄÁü≠Ë∑ØÂæÑÊòØÂê¶Â∑≤ÁªèÊ±ÇÂá∫,1Ë°®Á§∫Â∑≤Ê±ÇÂá∫ // ÂàùÂßãÂåñÔºåÁ¨¨‰∏Ä‰∏™È°∂ÁÇπÂ∑≤ÁªèÊ±ÇÂá∫ shortPath[start] = 0; visited[start] = 1; for (int count = 1; count &lt; n; count++) &#123; // Ë¶ÅÂä†ÂÖ•n-1‰∏™È°∂ÁÇπ int k = -1; // ÈÄâÂá∫‰∏Ä‰∏™Ë∑ùÁ¶ªÂàùÂßãÈ°∂ÁÇπstartÊúÄËøëÁöÑÊú™Ê†áËÆ∞È°∂ÁÇπ int dmin = Integer.MAX_VALUE; for (int i = 0; i &lt; n; i++) &#123; if (visited[i] == 0 &amp;&amp; weight[start][i] &lt; dmin) &#123; dmin = weight[start][i]; k = i; &#125; &#125; // Â∞ÜÊñ∞ÈÄâÂá∫ÁöÑÈ°∂ÁÇπÊ†áËÆ∞‰∏∫Â∑≤Ê±ÇÂá∫ÊúÄÁü≠Ë∑ØÂæÑÔºå‰∏îÂà∞startÁöÑÊúÄÁü≠Ë∑ØÂæÑÂ∞±ÊòØdmin shortPath[k] = dmin; visited[k] = 1; // ‰ª•k‰∏∫‰∏≠Èó¥ÁÇπÔºå‰øÆÊ≠£‰ªéstartÂà∞Êú™ËÆøÈóÆÂêÑÁÇπÁöÑË∑ùÁ¶ª for (int i = 0; i &lt; n; i++) &#123; //Â¶ÇÊûú &apos;Ëµ∑ÂßãÁÇπÂà∞ÂΩìÂâçÁÇπË∑ùÁ¶ª&apos; + &apos;ÂΩìÂâçÁÇπÂà∞ÊüêÁÇπË∑ùÁ¶ª&apos; &lt; &apos;Ëµ∑ÂßãÁÇπÂà∞ÊüêÁÇπË∑ùÁ¶ª&apos;, ÂàôÊõ¥Êñ∞ if (visited[i] == 0 &amp;&amp; weight[start][k] + weight[k][i] &lt; weight[start][i]) &#123; weight[start][i] = weight[start][k] + weight[k][i]; path[i] = path[k] + &quot;--&gt;&quot; + i; &#125; &#125; &#125; for (int i = 0; i &lt; n; i++) &#123; System.out.println(&quot;‰ªé&quot; + start + &quot;Âá∫ÂèëÂà∞&quot; + i + &quot;ÁöÑÊúÄÁü≠Ë∑ØÂæÑ‰∏∫Ôºö&quot; + path[i]); &#125; System.out.println(&quot;=====================================&quot;); return shortPath; &#125; &#125;]]></content>
      <categories>
        <category>ÊäÄÊúØ</category>
      </categories>
      <tags>
        <tag>ÁÆóÊ≥ï</tag>
        <tag>Dijkstra</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBoot jacksonÔºàDateÁ±ªÂûãÂÖ•ÂèÇ„ÄÅÊ†ºÂºèÂåñÔºå‰ª•ÂèäÂ¶Ç‰ΩïÂ§ÑÁêÜnullÔºâ]]></title>
    <url>%2Fpost%2F23d9d33.html</url>
    <content type="text"><![CDATA[È¶ñÂÖàÔºåÊàë‰ª¨Ë¶ÅÁü•ÈÅì springboot ÈªòËÆ§‰ΩøÁî® jackson Ëß£Êûê jsonÔºàÂΩìÁÑ∂ËøôÈáå‰πüÊòØÂèØ‰ª•ÈÖçÁΩÆ‰ΩøÁî®ÂÖ∂‰ªñ json Ëß£ÊûêÊ°ÜÊû∂Ôºâ„ÄÇÂú®‰∏çÈÖçÁΩÆÂÖ∂‰ªñ json Ëß£ÊûêÁöÑÊÉÖÂÜµ‰∏ãÔºåÊàë‰ª¨ÂèØ‰ª•ÈÄöËøá spring boot Êèê‰æõÁöÑÊ≥®Ëß£ÂíåÈÖçÁΩÆ Êù•ËÆ© jackson Â∏ÆÂä©Êàë‰ª¨ÊèêÈ´òÂºÄÂèëÊïàÁéá ‰ΩøÁî® @ResponseBody @RequestBodyÔºå Date Á±ªÂûãÂØπË±°ÂÖ•ÂèÇÔºåËøîÂõûjsonÊ†ºÂºèÂåñËß£ÂÜ≥ÊñπÊ≥ïÂ¶Ç‰∏ã: 1. application.properties‰∏≠Âä†ÂÖ•Â¶Ç‰∏ã‰ª£Á†Å12spring.jackson.date-format=yyyy-MM-dd HH:mm:ssspring.jackson.time-zone=GMT+8 2. Â¶ÇÊûú‰∏™Âà´ÂÆû‰ΩìÈúÄË¶Å‰ΩøÁî®ÂÖ∂‰ªñÊ†ºÂºèÁöÑ patternÔºåÂú®ÂÆû‰Ωì‰∏äÂä†ÂÖ•Ê≥®Ëß£Âç≥ÂèØ1234567import org.springframework.format.annotation.DateTimeFormat;import com.fasterxml.jackson.annotation.JsonFormat;public class MrType &#123; @JsonFormat(timezone = "GMT+8",pattern = "yyyy-MM-dd") @DateTimeFormat(pattern="yyyy-MM-dd") private Date createdDate;&#125; ÂÖ≥‰∫éspring boot Êó∂Èó¥Á±ªÂûãÊîØÊåÅÊàëÂÅö‰∫Ü‰ª•‰∏ãÊµãËØïÔºö1) application.properties ÈÖçÁΩÆÊ≥®ÈáäÔºå‰∏çÊ∑ªÂä†Ê≥®Ëß£Ôºöspring Êó†Ê≥ïÊé•Êî∂Êó∂Èó¥ÂèÇÊï∞Ôºà400ÔºâÔºåjson ËæìÂá∫ &quot;2018-03-29T09:45:31.513+0000&quot;2) application.properties ÈÖçÁΩÆÂºÄÂêØÔºå‰∏çÊ∑ªÂä†Ê≥®Ëß£Ôºö‰ªÖÊîØÊåÅ yyyy-MM-dd HH:mm:ss ÁöÑÊ†ºÂºèÂèÇÊï∞Âíå json ËæìÂá∫3) application.properties ÈÖçÁΩÆÂºÄÂêØÔºåÂÆû‰ΩìÊ∑ªÂä† @JsonFormat(pattern = &quot;yyyy-MM-dd&quot;)ÔºåÂÆû‰ΩìÂèØÊé•Âèó yyyy-MM-dd HH:mm:ss Âíå yyyy-MM-dd Ê†ºÂºèÁöÑÂèÇÊï∞ÔºåjsonËæìÂá∫Ê†ºÂºè‰∏∫ yyyy-MM-ddÔºåÁî±Ê≠§ÂèØËßÅ@JsonFormatÊòØÈôêÂà∂Date Á±ªÂûã json ËæìÂá∫ÁöÑÔºå‰ΩÜÊòØ‰∏∫‰ªÄ‰πàÂØπÊé•ÂèóÁöÑÁ±ªÂûã‰πüÈÄ†Êàê‰∫ÜÂΩ±ÂìçÔºüÊúâÂæÖËÄÉËØÅ4) application.properties ÈÖçÁΩÆÂºÄÂêØÔºåÂÆû‰ΩìÊ∑ªÂä† @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)ÔºåÁªìÊûú‰∏éÁ¨¨‰∫åÊù°ÊµãËØï‰∏ÄÊ†∑ÔºüË≤å‰ºº@DateTimeFormat Ê≥®Ëß£Âπ∂Ê≤°ÊúâÁîüÊïàÔºüÊúâÂæÖËÄÉËØÅ5) application.properties ÈÖçÁΩÆÂºÄÂêØÔºåÂÆû‰ΩìÊ∑ªÂä† @JsonFormat Âíå @DateTimeFormat ÁªìÊûú‰∏éÁ¨¨‰∏âÊù°‰∏ÄÊ†∑ ÁªìËÆ∫ÔºöÂÆûÈôÖÈ°πÁõÆ‰∏≠ application.propertiesËÆæÁΩÆÈÄöÁî®Êó∂Èó¥Ê†ºÂºèÔºå‰∏™Âà´Â±ûÊÄßÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜÊó∂ÔºåÊ∑ªÂä†@JsonFormatÔºà@JsonFormat Ëá™Â∑±Â•ΩÂÉèÂ∞±ÊääËøô‰ª∂‰∫ãÊêûÂÆö‰∫ÜÔºâ ‰ΩøÁî® @ResponseBody Êó∂ ÂøΩÁï• json ‰∏≠ÂÄº‰∏∫nullÁöÑÂ±ûÊÄß1. application.properties‰∏≠Âä†ÂÖ•Â¶Ç‰∏ã‰ª£Á†Å1spring.jackson.default-property-inclusion=non-null ÊàñËÄÖÂú®Á±ª‰∏äÂ£∞Êòé@JsonInclude(JsonInclude.Include.NON_NULL) 1234567import java.io.Serializable;import com.fasterxml.jackson.annotation.JsonInclude;@JsonInclude(JsonInclude.Include.NON_NULL)//ËØ•Ê≥®Ëß£ÈÖçÂêàjacksonÔºåÂ∫èÂàóÂåñÊó∂ÂøΩÁï• nullÂ±ûÊÄßpublic class AjaxResult implements Serializable &#123;&#125;]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>jackson</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL-Âπ∂Âèë‰∏ãÁîüÊàê‰∏çÈáçÂ§çÊµÅÊ∞¥Âè∑]]></title>
    <url>%2Fpost%2Fef3d0933.html</url>
    <content type="text"><![CDATA[Êõ¥Êñ∞‰∫é 2018-12-23 22:21:44ÂâçË®ÄÔºö‰∏ÄÂπ¥ÂâçÁöÑÂÜôÁöÑÔºåÂΩìÊó∂ÁöÑÂÅöÊ≥ïÂπ∂‰∏çËÉΩÂú®Âπ∂Âèë‰∏ã‰øùËØÅÊµÅÊ∞¥Âè∑ÁöÑÂîØ‰∏ÄÊÄßÔºåÂõ†‰∏∫ÂΩìÊó∂Âπ∂Ê≤°ÊúâÂÜôÂ§öÁ∫øÁ®ãÊµãËØïËøá‚Ä¶ ÊÄùË∑Ø sCode sName sQz sValue order ËÆ¢Âçï DD 18120100 È¶ñÂÖàÊØè‰∏™‰∏öÂä°ÁöÑÊµÅÊ∞¥Âè∑ÂØπÂ∫îË°®‰∏≠ÁöÑ‰∏ÄÊù°Êï∞ÊçÆ ÊØè‰∏™Ë¶ÅËé∑ÂèñÊµÅÊ∞¥Âè∑ÁöÑÁ∫øÁ®ãË∞ÉÁî® ‰∏Ä‰∏™Áî®Êù•ÁîüÊàêÊµÅÊ∞¥Âè∑ÁöÑ Â≠òÂÇ®ËøáÁ®ã Ê†πÊçÆsCode ÊâæÂà∞ sValue„ÄÇ1234if (sValue == null) ÂàùÂßãÂåñÂÄº else sValue ++ Êï≤ÈªëÊùøÔºÅÂàíÈáçÁÇπÔºÅ ÂàÜÊûêÔºö‰∏äËø∞ÁöÑÊÄùË∑ØÁúã‰ººÊ≤°‰ªÄ‰πàÈóÆÈ¢òÔºå‰ΩÜÊòØÂ¶ÇÊûú‰∏§‰∏™Á∫øÁ®ãÂπ∂ÂèëÁöÑÊâßË°å‰ºöÂá∫Áé∞‰∏§‰∏™‰∫ãÂä°ËØªÂèñÂà∞Áõ∏ÂêåÁöÑÊï∞ÊçÆÔºåÂêåÊó∂ÈÉΩÊâßË°åÂàùÂßãÂåñÊàñËÄÖËá™Â¢û„ÄÇ ÊñπÊ°àÔºö‰ΩøÁî® MySQL ÂÜôÈîÅÔºàselect‚Ä¶for updateÔºå‰πüÂè´XÈîÅÔºåÊéíÂÆÉÈîÅÔºâ Êù•Ëß£ÂÜ≥Ëøô‰∏ÄÈóÆÈ¢ò ‰æãÂ¶ÇÔºö‰∫ãÂä°AÂíå‰∫ãÂä°BÂêåÊó∂ËøõË°åÔºå‰∫ãÂä°A ÊãøÂà∞ ÂΩìÂâçËøôÊù°Êï∞ÊçÆÁöÑÂÜôÈîÅÔºåÊ≠§Êó∂Â¶ÇÊûú‰∫ãÂä°B ÊÉ≥ËÆøÈóÆËøôÊù°Êï∞ÊçÆÈúÄË¶ÅÁ≠âÂæÖ‰∫ãÂä°AÁªìÊùü„ÄÇÂπ∂ÂèëÊó∂ËÆ©‰∏§‰∏™‰∫ãÂä°ÂØπÂêå‰∏ÄÊù°Êï∞ÊçÆÁöÑÊìç‰ΩúÂèòÊàê‰∫Ü‰∏≤Ë°åÂåñ„ÄÇ 123456CREATE TABLE `sys_sno` ( `sCode` varchar(50) DEFAULT NULL COMMENT &apos;ÁºñÁ†Å&apos;, `sName` varchar(100) DEFAULT NULL COMMENT &apos;ÂêçÁß∞&apos;, `sQz` varchar(50) DEFAULT NULL COMMENT &apos;ÂâçÁºÄ&apos;, `sValue` varchar(80) DEFAULT NULL COMMENT &apos;ÂÄº&apos;) ENGINE=InnoDB DEFAULT CHARSET=utf8; 123456789101112131415161718192021222324252627282930313233343536373839CREATE DEFINER=`root`@`localhost` PROCEDURE `GetSerialNo`(IN tsCode VARCHAR(50),OUT result VARCHAR(200) )BEGIN DECLARE tsValue VARCHAR(50); DECLARE tdToday VARCHAR(20); DECLARE nowdate VARCHAR(20); DECLARE tsQZ VARCHAR(50); DECLARE t_error INTEGER DEFAULT 0; DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET t_error=1; START TRANSACTION; /* UPDATE sys_sno SET sValue=sValue WHERE sCode=tsCode; */ SELECT sValue INTO tsValue FROM sys_sno WHERE sCode=tsCode for UPDATE; SELECT sQz INTO tsQZ FROM sys_sno WHERE sCode=tsCode ; -- Âõ†Â≠êË°®‰∏≠Ê≤°ÊúâËÆ∞ÂΩïÔºåÊèíÂÖ•ÂàùÂßãÂÄº IF tsValue IS NULL THEN SELECT CONCAT(DATE_FORMAT(NOW(),&apos;%y%m&apos;),&apos;0001&apos;) INTO tsValue; UPDATE sys_sno SET sValue=tsValue WHERE sCode=tsCode ; SELECT CONCAT(tsQZ,tsValue) INTO result; ELSE SELECT SUBSTRING(tsValue,1,4) INTO tdToday; SELECT CONVERT(DATE_FORMAT(NOW(),&apos;%y%m&apos;),SIGNED) INTO nowdate; -- Âà§Êñ≠Âπ¥ÊúàÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ IF tdToday = nowdate THEN SET tsValue=CONVERT(tsValue,SIGNED) + 1; ELSE SELECT CONCAT(DATE_FORMAT(NOW(),&apos;%y%m&apos;) ,&apos;0001&apos;) INTO tsValue ; END IF; UPDATE sys_sno SET sValue =tsValue WHERE sCode=tsCode; SELECT CONCAT(tsQZ,tsValue) INTO result; END IF; IF t_error =1 THEN ROLLBACK; SET result = &apos;Error&apos;; ELSE COMMIT; END IF; SELECT result ; END; ÊµãËØï‰ª£Á†ÅÂÆåÊï¥ÊµãËØï‰ª£Á†ÅÔºöhttps://gitee.com/yintianwen7/taven-springboot-learning/tree/master/uni-number123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657import com.gitee.taven.uninumber.mapper.OrderMapper;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import java.util.HashMap;import java.util.Map;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;@Servicepublic class OrderService &#123; private static OrderMapper orderMapper; @Autowired public void setOrderMapper(OrderMapper orderMapper) &#123; this.orderMapper = orderMapper; &#125; private static final int TOTAL_THREADS = 100; public void multiThread() &#123; // ÂàõÂª∫Âõ∫ÂÆöÈïøÂ∫¶Á∫øÁ®ãÊ±† ExecutorService fixedThreadPool = Executors.newFixedThreadPool(50); for (int i = 0; i &lt; TOTAL_THREADS; i++) &#123; Thread thread = new OrderThread(); fixedThreadPool.execute(thread); &#125; &#125; public static class OrderThread extends Thread &#123; @Override public void run() &#123; try &#123; Map&lt;String, String&gt; parameterMap = initParameterMap(); orderMapper.createOrderNum(parameterMap); String number = parameterMap.get(&quot;result&quot;); System.out.println(Thread.currentThread().getName() + &quot; : &quot; +number); &#125; catch (Exception e) &#123; System.out.println(e); &#125; &#125; public Map&lt;String, String&gt; initParameterMap() &#123; Map&lt;String, String&gt; parameterMap = new HashMap&lt;&gt;(); parameterMap.put(&quot;tsCode&quot;, &quot;order&quot;); parameterMap.put(&quot;result&quot;, &quot;-1&quot;); return parameterMap; &#125; &#125;&#125; 12345678910111213141516// mapper Êé•Âè£public interface OrderMapper &#123; int createOrderNum(Map&lt;String, String&gt; parameterMap);&#125;// xml &lt;update id=&quot;createOrderNum&quot; parameterMap=&quot;initMap&quot; statementType=&quot;CALLABLE&quot;&gt; CALL GetSerialNo(?,?) &lt;/update&gt; &lt;parameterMap type=&quot;java.util.Map&quot; id=&quot;initMap&quot;&gt; &lt;parameter property=&quot;tsCode&quot; mode=&quot;IN&quot; jdbcType=&quot;VARCHAR&quot;/&gt; &lt;parameter property=&quot;result&quot; mode=&quot;OUT&quot; jdbcType=&quot;VARCHAR&quot;/&gt; &lt;/parameterMap&gt; Â§áÊ≥® ÊâßË°å‰∫Ü‰∏Ä‰∏™Áôæ‰∏™Á∫øÁ®ã‰πãÂêé ÂèØ‰ª•Áúã‰∏Ä‰∏ãÊï∞ÊçÆÔºåËá™Â¢ûÂà∞‰∫Ü100 ËØ¥ÊòéÊàêÂäü‰∫Ü Âà†Êéâ Â≠òÂÇ®ËøáÁ®ã‰∏≠ÁöÑ for updateÔºåÂÜçÊâßË°å ÂèØ‰ª•ÁúãÂá∫ÈîÅÁöÑ‰ΩúÁî®]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>Âπ∂Âèë</tag>
      </tags>
  </entry>
</search>
